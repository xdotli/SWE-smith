{
    "cost": 0.027185,
    "rewrites": {
        "dubinc__dub.main/apps/web/tests/utils/integration.ts": {
            "output": "import { Project, User } from \"@dub/prisma/client\";\nimport { type TestContext } from \"vitest\";\nimport { z } from \"zod\";\nimport { HttpClient } from \"../utils/http\";\nimport { env, integrationTestEnv } from \"./env\";\nimport { E2E_USER_ID, E2E_WORKSPACE_ID } from \"./resource\";\n\ninterface Resources {\n  user: Pick<User, \"id\">;\n  workspace: Pick<Project, \"id\" | \"slug\" | \"name\" | \"webhookEnabled\">;\n  apiKey: { token: string };\n}\n\nexport class IntegrationHarness {\n  private readonly ctx?: TestContext;\n  private env: z.infer<typeof integrationTestEnv>;\n  public resources: Resources;\n  public baseUrl: string;\n  public http: HttpClient;\n\n  constructor(ctx?: TestContext) {\n    this.env = env;\n    this.ctx = ctx;\n    this.baseUrl = this.env.E2E_BASE_URL;\n    this.http = new HttpClient({\n      baseUrl: `${this.baseUrl}/api`,\n      headers: {\n        Authorization: `Bearer ${this.env.E2E_TOKEN}`,\n      },\n    });\n  }\n\n  async init() {\n    const user = {\n      id: E2E_USER_ID,\n    };\n\n    const apiKey = {\n      token: this.env.E2E_TOKEN,\n    };\n\n    const workspace = {\n      id: E2E_WORKSPACE_ID,\n      slug: \"acme\",\n      name: \"Acme, Inc.\",\n      webhookEnabled: true,\n    };\n\n    this.resources = {\n      user,\n      apiKey,\n      workspace,\n    };\n\n    return {\n      ...this.resources,\n      http: this.http,\n      env: this.env,\n    };\n  }\n\n  // Delete link\n  public async deleteLink(id: string) {\n    if (!id) return;\n\n    await this.http.delete({\n      path: `/links/${id}`,\n    });\n  }\n\n  // Delete tag\n  public async deleteTag(id: string) {\n    if (!id) return;\n\n    await this.http.delete({\n      path: `/tags/${id}`,\n    });\n  }\n\n  // Delete domain\n  public async deleteDomain(slug: string) {\n    await this.http.delete({\n      path: `/domains/${slug}`,\n    });\n  }\n\n  // Delete customer\n  public async deleteCustomer(id: string) {\n    await this.http.delete({\n      path: `/customers/${id}`,\n    });\n  }\n\n  // Delete folder\n  public async deleteFolder(id: string) {\n    await this.http.delete({\n      path: `/folders/${id}`,\n    });\n  }\n\n  // Delete bounty\n  public async deleteBounty(id: string) {\n    if (!id) return;\n\n    await this.http.delete({\n      path: `/bounties/${id}`,\n    });\n  }\n}",
            "output_extracted": "import { Project, User } from \"@dub/prisma/client\";\nimport { type TestContext } from \"vitest\";\nimport { z } from \"zod\";\nimport { HttpClient } from \"../utils/http\";\nimport { env, integrationTestEnv } from \"./env\";\nimport { E2E_USER_ID, E2E_WORKSPACE_ID } from \"./resource\";\n\ninterface Resources {\n  user: Pick<User, \"id\">;\n  workspace: Pick<Project, \"id\" | \"slug\" | \"name\" | \"webhookEnabled\">;\n  apiKey: { token: string };\n}\n\nexport class IntegrationHarness {\n  private readonly ctx?: TestContext;\n  private env: z.infer<typeof integrationTestEnv>;\n  public resources: Resources;\n  public baseUrl: string;\n  public http: HttpClient;\n\n  constructor(ctx?: TestContext) {\n    this.env = env;\n    this.ctx = ctx;\n    this.baseUrl = this.env.E2E_BASE_URL;\n    this.http = new HttpClient({\n      baseUrl: `${this.baseUrl}/api`,\n      headers: {\n        Authorization: `Bearer ${this.env.E2E_TOKEN}`,\n      },\n    });\n  }\n\n  async init() {\n    const user = {\n      id: E2E_USER_ID,\n    };\n\n    const apiKey = {\n      token: this.env.E2E_TOKEN,\n    };\n\n    const workspace = {\n      id: E2E_WORKSPACE_ID,\n      slug: \"acme\",\n      name: \"Acme, Inc.\",\n      webhookEnabled: true,\n    };\n\n    this.resources = {\n      user,\n      apiKey,\n      workspace,\n    };\n\n    return {\n      ...this.resources,\n      http: this.http,\n      env: this.env,\n    };\n  }\n\n  // Delete link\n  public async deleteLink(id: string) {\n    if (!id) return;\n\n    await this.http.delete({\n      path: `/links/${id}`,\n    });\n  }\n\n  // Delete tag\n  public async deleteTag(id: string) {\n    if (!id) return;\n\n    await this.http.delete({\n      path: `/tags/${id}`,\n    });\n  }\n\n  // Delete domain\n  public async deleteDomain(slug: string) {\n    await this.http.delete({\n      path: `/domains/${slug}`,\n    });\n  }\n\n  // Delete customer\n  public async deleteCustomer(id: string) {\n    await this.http.delete({\n      path: `/customers/${id}`,\n    });\n  }\n\n  // Delete folder\n  public async deleteFolder(id: string) {\n    await this.http.delete({\n      path: `/folders/${id}`,\n    });\n  }\n\n  // Delete bounty\n  public async deleteBounty(id: string) {\n    if (!id) return;\n\n    await this.http.delete({\n      path: `/bounties/${id}`,\n    });\n  }\n}",
            "cost": 0.027185
        }
    },
    "recover_status": "success",
    "instance_ref": {
        "instance_id": "dubinc__dub.main.2975",
        "repo": "dubinc/dub",
        "base_commit": "46a8b5aa9328c75c02054b66ba5879c4e2e82345",
        "head_commit": "9414a9320086f54b3a81a226258cabe301f8a227",
        "title": "Add integration tests for `/campaigns/**` endpoints",
        "merged_at": "2025-10-17T17:13:02Z",
        "html_url": "https://github.com/dubinc/dub/pull/2975",
        "test_files": [
            "apps/web/tests/campaigns/index.test.ts"
        ],
        "code_files": [
            "apps/web/tests/utils/integration.ts"
        ],
        "total_changes": 222,
        "num_files": 2,
        "pull_number": 2975,
        "patch": "diff --git a/apps/web/tests/campaigns/index.test.ts b/apps/web/tests/campaigns/index.test.ts\nnew file mode 100644\nindex 00000000000..90cf7a77baf\n--- /dev/null\n+++ b/apps/web/tests/campaigns/index.test.ts\n@@ -0,0 +1,213 @@\n+import { Campaign, CampaignList } from \"@/lib/types\";\n+import { updateCampaignSchema } from \"@/lib/zod/schemas/campaigns\";\n+import { E2E_PARTNER_GROUP } from \"tests/utils/resource\";\n+import { describe, expect, onTestFinished, test } from \"vitest\";\n+import { z } from \"zod\";\n+import { IntegrationHarness } from \"../utils/integration\";\n+\n+const campaign: z.infer<typeof updateCampaignSchema> = {\n+  name: \"Updated Test Campaign\",\n+  subject: \"Updated Test Subject\",\n+  triggerCondition: {\n+    attribute: \"totalConversions\",\n+    operator: \"gte\",\n+    value: 50,\n+  },\n+  bodyJson: {\n+    type: \"doc\",\n+    content: [\n+      {\n+        type: \"paragraph\",\n+        content: [\n+          {\n+            type: \"text\",\n+            text: \"Test campaign body\",\n+          },\n+        ],\n+      },\n+    ],\n+  },\n+};\n+\n+const expectedCampaign: Partial<Campaign> = {\n+  ...campaign,\n+  type: \"transactional\",\n+  groups: [{ id: E2E_PARTNER_GROUP.id }],\n+  createdAt: expect.any(String),\n+  updatedAt: expect.any(String),\n+};\n+\n+describe.sequential(\"/campaigns/**\", async () => {\n+  const h = new IntegrationHarness();\n+  const { http } = await h.init();\n+\n+  let campaignId = \"\";\n+\n+  test(\"POST /campaigns - create draft campaign\", async () => {\n+    const { status, data } = await http.post<{ id: string }>({\n+      path: \"/campaigns\",\n+      body: {\n+        type: \"transactional\",\n+      },\n+    });\n+\n+    expect(status).toEqual(200);\n+    expect(data).toMatchObject({\n+      id: expect.any(String),\n+    });\n+\n+    campaignId = data.id;\n+  });\n+\n+  test(\"PATCH /campaigns/[campaignId] - update campaign content\", async () => {\n+    const { status, data: updatedCampaign } = await http.patch<Campaign>({\n+      path: `/campaigns/${campaignId}`,\n+      body: {\n+        ...campaign,\n+        groupIds: [E2E_PARTNER_GROUP.id],\n+      },\n+    });\n+\n+    expect(status).toEqual(200);\n+    expect(updatedCampaign).toStrictEqual({\n+      ...expectedCampaign,\n+      id: campaignId,\n+      status: \"draft\",\n+    });\n+  });\n+\n+  test(\"GET /campaigns/[campaignId] - make sure the draft campaign is created\", async () => {\n+    const { status, data: fetchedCampaign } = await http.get<Campaign>({\n+      path: `/campaigns/${campaignId}`,\n+    });\n+\n+    expect(status).toEqual(200);\n+    expect(fetchedCampaign).toStrictEqual({\n+      ...expectedCampaign,\n+      id: campaignId,\n+      status: \"draft\",\n+    });\n+  });\n+\n+  test(\"PATCH /campaigns/[campaignId] - publish campaign\", async () => {\n+    const { status, data: publishedCampaign } = await http.patch<Campaign>({\n+      path: `/campaigns/${campaignId}`,\n+      body: {\n+        status: \"active\",\n+      },\n+    });\n+\n+    expect(status).toEqual(200);\n+    expect(publishedCampaign).toStrictEqual({\n+      ...expectedCampaign,\n+      id: campaignId,\n+      status: \"active\",\n+    });\n+  });\n+\n+  test(\"PATCH /campaigns/[campaignId] - pause campaign\", async () => {\n+    const { status, data: pausedCampaign } = await http.patch<Campaign>({\n+      path: `/campaigns/${campaignId}`,\n+      body: {\n+        status: \"paused\",\n+      },\n+    });\n+\n+    expect(status).toEqual(200);\n+    expect(pausedCampaign).toStrictEqual({\n+      ...expectedCampaign,\n+      id: campaignId,\n+      status: \"paused\",\n+    });\n+  });\n+\n+  test(\"PATCH /campaigns/[campaignId] - resume campaign\", async () => {\n+    const { status, data: resumedCampaign } = await http.patch<Campaign>({\n+      path: `/campaigns/${campaignId}`,\n+      body: {\n+        status: \"active\",\n+      },\n+    });\n+\n+    expect(status).toEqual(200);\n+    expect(resumedCampaign).toStrictEqual({\n+      ...expectedCampaign,\n+      id: campaignId,\n+      status: \"active\",\n+    });\n+  });\n+\n+  test(\"POST /campaigns/[campaignId]/duplicate - duplicate campaign\", async () => {\n+    const { status, data } = await http.post<{ id: string }>({\n+      path: `/campaigns/${campaignId}/duplicate`,\n+    });\n+\n+    expect(status).toEqual(200);\n+    expect(data.id).toBeDefined();\n+\n+    onTestFinished(async () => {\n+      await h.deleteCampaign(data.id);\n+    });\n+\n+    const { data: duplicatedCampaign } = await http.get<Campaign>({\n+      path: `/campaigns/${data.id}`,\n+    });\n+\n+    expect(duplicatedCampaign).toStrictEqual({\n+      ...expectedCampaign,\n+      id: data.id,\n+      name: `${expectedCampaign.name} (copy)`,\n+      status: \"draft\",\n+    });\n+  });\n+\n+  test(\"GET /campaigns - list campaigns\", async () => {\n+    const { status, data: campaigns } = await http.get<CampaignList[]>({\n+      path: \"/campaigns\",\n+    });\n+\n+    expect(status).toEqual(200);\n+    expect(Array.isArray(campaigns)).toBe(true);\n+    expect(campaigns.length).toBeGreaterThan(0);\n+\n+    const campaign = campaigns.find((c) => c.id === campaignId);\n+\n+    expect(campaign).toStrictEqual({\n+      id: campaignId,\n+      name: expectedCampaign.name,\n+      type: expectedCampaign.type,\n+      status: \"active\",\n+      groups: [{ id: E2E_PARTNER_GROUP.id }],\n+      delivered: 0,\n+      sent: 0,\n+      bounced: 0,\n+      opened: 0,\n+      createdAt: expect.any(String),\n+      updatedAt: expect.any(String),\n+    });\n+  });\n+\n+  test(\"GET /campaigns/[campaignId] - get single campaign\", async () => {\n+    const { status, data: fetchedCampaign } = await http.get<Campaign>({\n+      path: `/campaigns/${campaignId}`,\n+    });\n+\n+    expect(status).toEqual(200);\n+    expect(fetchedCampaign).toStrictEqual({\n+      ...expectedCampaign,\n+      id: campaignId,\n+      status: \"active\",\n+    });\n+  });\n+\n+  test(\"DELETE /campaigns/[campaignId] - delete campaign\", async () => {\n+    const { status, data } = await http.delete<{ id: string }>({\n+      path: `/campaigns/${campaignId}`,\n+    });\n+\n+    expect(status).toEqual(200);\n+    expect(data).toStrictEqual({\n+      id: campaignId,\n+    });\n+  });\n+});\ndiff --git a/apps/web/tests/utils/integration.ts b/apps/web/tests/utils/integration.ts\nindex 934e2a7065d..d2a02cb8ff6 100644\n--- a/apps/web/tests/utils/integration.ts\n+++ b/apps/web/tests/utils/integration.ts\n@@ -106,4 +106,13 @@ export class IntegrationHarness {\n       path: `/bounties/${id}`,\n     });\n   }\n+\n+  // Delete campaign\n+  public async deleteCampaign(id: string) {\n+    if (!id) return;\n+\n+    await this.http.delete({\n+      path: `/campaigns/${id}`,\n+    });\n+  }\n }\n",
        "pr_mirror": "dubinc__dub.main"
    }
}