{
    "cost": 0.24671,
    "rewrites": {
        "dubinc__dub.main/apps/web/tests/tracks/track-lead.test.ts": {
            "output": "import {\n  CommissionResponse,\n  Customer,\n  TrackLeadResponse,\n  TrackSaleResponse,\n} from \"@/lib/types\";\nimport { randomCustomer } from \"tests/utils/helpers\";\nimport { HttpClient } from \"tests/utils/http\";\nimport { E2E_LEAD_REWARD, E2E_TRACK_CLICK_HEADERS } from \"tests/utils/resource\";\nimport { describe, expect, test } from \"vitest\";\nimport { IntegrationHarness } from \"../utils/integration\";\n\n// Helper function to verify lead tracking response\nconst expectValidLeadResponse = ({\n  response,\n  customer,\n  clickId,\n}: {\n  response: { status: number; data: TrackLeadResponse };\n  customer: any;\n  clickId: string;\n}) => {\n  expect(response.status).toEqual(200);\n  expect(response.data).toStrictEqual({\n    click: {\n      id: clickId,\n    },\n    link: response.data.link,\n    customer,\n  });\n};\n\nconst verifyCommission = async ({\n  http,\n  customerExternalId,\n  expectedEarnings,\n}: {\n  http: HttpClient;\n  customerExternalId: string;\n  expectedEarnings: number;\n}) => {\n  // Find the customer first\n  const { data: customers } = await http.get<Customer[]>({\n    path: \"/customers\",\n    query: {\n      externalId: customerExternalId,\n    },\n  });\n\n  const customer = customers[0];\n\n  // Find the commission for the customer\n  const { status, data: commissions } = await http.get<CommissionResponse[]>({\n    path: \"/commissions\",\n    query: {\n      customerId: customer.id,\n    },\n  });\n\n  expect(status).toEqual(200);\n  expect(commissions).toHaveLength(1);\n  expect(commissions[0].customer?.id).toEqual(customer.id);\n  expect(commissions[0].earnings).toEqual(expectedEarnings);\n};\n\ndescribe(\"POST /track/lead\", async () => {\n  const h = new IntegrationHarness();\n  const { http } = await h.init();\n\n  const clickResponse = await http.post<{ clickId: string }>({\n    path: \"/track/click\",\n    headers: E2E_TRACK_CLICK_HEADERS,\n    body: {\n      domain: \"getacme.link\",\n      key: \"derek\",\n    },\n  });\n\n  expect(clickResponse.status).toEqual(200);\n  expect(clickResponse.data.clickId).toStrictEqual(expect.any(String));\n\n  const trackedClickId = clickResponse.data.clickId;\n\n  const customer1 = randomCustomer();\n\n  test(\"track a lead (with clickId from a prior /track/click request)\", async () => {\n    const response = await http.post<TrackLeadResponse>({\n      path: \"/track/lead\",\n      body: {\n        clickId: trackedClickId,\n        eventName: \"Signup\",\n        customerExternalId: customer1.externalId,\n        customerName: customer1.name,\n        customerEmail: customer1.email,\n        customerAvatar: customer1.avatar,\n      },\n    });\n\n    expectValidLeadResponse({\n      response,\n      customer: customer1,\n      clickId: trackedClickId,\n    });\n  });\n\n  test(\"duplicate track lead request with same customerExternalId\", async () => {\n    const response = await http.post<TrackLeadResponse>({\n      path: \"/track/lead\",\n      body: {\n        clickId: trackedClickId,\n        eventName: \"Signup\",\n        customerExternalId: customer1.externalId,\n        customerName: customer1.name,\n        customerEmail: customer1.email,\n        customerAvatar: customer1.avatar,\n      },\n    });\n\n    // should return the same response since it's idempotent\n    expectValidLeadResponse({\n      response,\n      customer: customer1,\n      clickId: trackedClickId,\n    });\n  });\n\n  test(\"track a lead with mode = 'deferred' + track it again after with mode = 'async' and no clickId\", async () => {\n    const customer2 = randomCustomer();\n    const response = await http.post<TrackLeadResponse>({\n      path: \"/track/lead\",\n      body: {\n        clickId: trackedClickId,\n        eventName: \"Mode=Deferred Signup\",\n        customerExternalId: customer2.externalId,\n        customerName: customer2.name,\n        customerEmail: customer2.email,\n        customerAvatar: customer2.avatar,\n        mode: \"deferred\",\n      },\n    });\n    expectValidLeadResponse({\n      response,\n      customer: customer2,\n      clickId: trackedClickId,\n    });\n    // track the lead again, this time with mode = 'async' and no clickId\n    const response2 = await http.post<TrackLeadResponse>({\n      path: \"/track/lead\",\n      body: {\n        eventName: \"Mode=Deferred Signup\",\n        customerExternalId: customer2.externalId,\n      },\n    });\n    expectValidLeadResponse({\n      response: response2,\n      customer: customer2,\n      clickId: trackedClickId,\n    });\n  });\n\n  test(\"track a lead with mode = 'wait' + track a sale right after\", async () => {\n    const customer3 = randomCustomer();\n    const response = await http.post<TrackLeadResponse>({\n      path: \"/track/lead\",\n      body: {\n        clickId: trackedClickId,\n        eventName: \"Mode=Wait Signup\",\n        customerExternalId: customer3.externalId,\n        customerName: customer3.name,\n        customerEmail: customer3.email,\n        customerAvatar: customer3.avatar,\n        mode: \"wait\",\n      },\n    });\n    expectValidLeadResponse({\n      response,\n      customer: customer3,\n      clickId: trackedClickId,\n    });\n\n    const saleResponse = await http.post<TrackSaleResponse>({\n      path: \"/track/sale\",\n      body: {\n        customerExternalId: customer3.externalId,\n        eventName: \"Mode=Wait Purchase\",\n        amount: 500,\n        paymentProcessor: \"stripe\",\n      },\n    });\n\n    expect(saleResponse.status).toEqual(200);\n  });\n\n  test(\"track a lead with eventQuantity\", async () => {\n    const customer4 = randomCustomer();\n    const response = await http.post<TrackLeadResponse>({\n      path: \"/track/lead\",\n      body: {\n        clickId: trackedClickId,\n        eventName: \"Start Trial\",\n        customerExternalId: customer4.externalId,\n        customerName: customer4.name,\n        customerEmail: customer4.email,\n        customerAvatar: customer4.avatar,\n        eventQuantity: 2,\n      },\n    });\n\n    expectValidLeadResponse({\n      response,\n      customer: customer4,\n      clickId: trackedClickId,\n    });\n  });\n\n  test(\"track a lead with `externalId` (backward compatibility)\", async () => {\n    const customer5 = randomCustomer();\n    const response = await http.post<TrackLeadResponse>({\n      path: \"/track/lead\",\n      body: {\n        clickId: trackedClickId,\n        externalId: customer5.externalId,\n        eventName: \"Signup\",\n        customerName: customer5.name,\n        customerEmail: customer5.email,\n        customerAvatar: customer5.avatar,\n      },\n    });\n\n    expectValidLeadResponse({\n      response,\n      customer: customer5,\n      clickId: trackedClickId,\n    });\n  });\n\n  test(\"track a lead with `customerId` (backward compatibility)\", async () => {\n    const customer6 = randomCustomer();\n    const response = await http.post<TrackLeadResponse>({\n      path: \"/track/lead\",\n      body: {\n        clickId: trackedClickId,\n        customerId: customer6.externalId,\n        eventName: \"Signup\",\n        customerName: customer6.name,\n        customerEmail: customer6.email,\n        customerAvatar: customer6.avatar,\n      },\n    });\n\n    expectValidLeadResponse({\n      response,\n      customer: customer6,\n      clickId: trackedClickId,\n    });\n  });\n\n  test(\"track a lead and verify the reward based on the partner.country (US)\", async () => {\n    const clickResponse = await http.post<{ clickId: string }>({\n      path: \"/track/click\",\n      headers: E2E_TRACK_CLICK_HEADERS,\n      body: {\n        domain: \"getacme.link\",\n        key: \"marvin\",\n      },\n    });\n\n    const trackedClickId = clickResponse.data.clickId;\n    const customer = randomCustomer();\n\n    const response = await http.post<TrackLeadResponse>({\n      path: \"/track/lead\",\n      body: {\n        clickId: trackedClickId,\n        customerId: customer.externalId,\n        eventName: \"Signup\",\n        customerName: customer.name,\n        customerEmail: customer.email,\n        customerAvatar: customer.avatar,\n      },\n    });\n\n    expectValidLeadResponse({\n      response,\n      customer: customer,\n      clickId: trackedClickId,\n    });\n\n    await new Promise((resolve) => setTimeout(resolve, 2000));\n\n    await verifyCommission({\n      http,\n      customerExternalId: customer.externalId,\n      expectedEarnings: E2E_LEAD_REWARD.modifiers[0].amountInCents,\n    });\n  });\n});",
            "output_extracted": "import {\n  CommissionResponse,\n  Customer,\n  TrackLeadResponse,\n  TrackSaleResponse,\n} from \"@/lib/types\";\nimport { randomCustomer } from \"tests/utils/helpers\";\nimport { HttpClient } from \"tests/utils/http\";\nimport { E2E_LEAD_REWARD, E2E_TRACK_CLICK_HEADERS } from \"tests/utils/resource\";\nimport { describe, expect, test } from \"vitest\";\nimport { IntegrationHarness } from \"../utils/integration\";\n\n// Helper function to verify lead tracking response\nconst expectValidLeadResponse = ({\n  response,\n  customer,\n  clickId,\n}: {\n  response: { status: number; data: TrackLeadResponse };\n  customer: any;\n  clickId: string;\n}) => {\n  expect(response.status).toEqual(200);\n  expect(response.data).toStrictEqual({\n    click: {\n      id: clickId,\n    },\n    link: response.data.link,\n    customer,\n  });\n};\n\nconst verifyCommission = async ({\n  http,\n  customerExternalId,\n  expectedEarnings,\n}: {\n  http: HttpClient;\n  customerExternalId: string;\n  expectedEarnings: number;\n}) => {\n  // Find the customer first\n  const { data: customers } = await http.get<Customer[]>({\n    path: \"/customers\",\n    query: {\n      externalId: customerExternalId,\n    },\n  });\n\n  const customer = customers[0];\n\n  // Find the commission for the customer\n  const { status, data: commissions } = await http.get<CommissionResponse[]>({\n    path: \"/commissions\",\n    query: {\n      customerId: customer.id,\n    },\n  });\n\n  expect(status).toEqual(200);\n  expect(commissions).toHaveLength(1);\n  expect(commissions[0].customer?.id).toEqual(customer.id);\n  expect(commissions[0].earnings).toEqual(expectedEarnings);\n};\n\ndescribe(\"POST /track/lead\", async () => {\n  const h = new IntegrationHarness();\n  const { http } = await h.init();\n\n  const clickResponse = await http.post<{ clickId: string }>({\n    path: \"/track/click\",\n    headers: E2E_TRACK_CLICK_HEADERS,\n    body: {\n      domain: \"getacme.link\",\n      key: \"derek\",\n    },\n  });\n\n  expect(clickResponse.status).toEqual(200);\n  expect(clickResponse.data.clickId).toStrictEqual(expect.any(String));\n\n  const trackedClickId = clickResponse.data.clickId;\n\n  const customer1 = randomCustomer();\n\n  test(\"track a lead (with clickId from a prior /track/click request)\", async () => {\n    const response = await http.post<TrackLeadResponse>({\n      path: \"/track/lead\",\n      body: {\n        clickId: trackedClickId,\n        eventName: \"Signup\",\n        customerExternalId: customer1.externalId,\n        customerName: customer1.name,\n        customerEmail: customer1.email,\n        customerAvatar: customer1.avatar,\n      },\n    });\n\n    expectValidLeadResponse({\n      response,\n      customer: customer1,\n      clickId: trackedClickId,\n    });\n  });\n\n  test(\"duplicate track lead request with same customerExternalId\", async () => {\n    const response = await http.post<TrackLeadResponse>({\n      path: \"/track/lead\",\n      body: {\n        clickId: trackedClickId,\n        eventName: \"Signup\",\n        customerExternalId: customer1.externalId,\n        customerName: customer1.name,\n        customerEmail: customer1.email,\n        customerAvatar: customer1.avatar,\n      },\n    });\n\n    // should return the same response since it's idempotent\n    expectValidLeadResponse({\n      response,\n      customer: customer1,\n      clickId: trackedClickId,\n    });\n  });\n\n  test(\"track a lead with mode = 'deferred' + track it again after with mode = 'async' and no clickId\", async () => {\n    const customer2 = randomCustomer();\n    const response = await http.post<TrackLeadResponse>({\n      path: \"/track/lead\",\n      body: {\n        clickId: trackedClickId,\n        eventName: \"Mode=Deferred Signup\",\n        customerExternalId: customer2.externalId,\n        customerName: customer2.name,\n        customerEmail: customer2.email,\n        customerAvatar: customer2.avatar,\n        mode: \"deferred\",\n      },\n    });\n    expectValidLeadResponse({\n      response,\n      customer: customer2,\n      clickId: trackedClickId,\n    });\n    // track the lead again, this time with mode = 'async' and no clickId\n    const response2 = await http.post<TrackLeadResponse>({\n      path: \"/track/lead\",\n      body: {\n        eventName: \"Mode=Deferred Signup\",\n        customerExternalId: customer2.externalId,\n      },\n    });\n    expectValidLeadResponse({\n      response: response2,\n      customer: customer2,\n      clickId: trackedClickId,\n    });\n  });\n\n  test(\"track a lead with mode = 'wait' + track a sale right after\", async () => {\n    const customer3 = randomCustomer();\n    const response = await http.post<TrackLeadResponse>({\n      path: \"/track/lead\",\n      body: {\n        clickId: trackedClickId,\n        eventName: \"Mode=Wait Signup\",\n        customerExternalId: customer3.externalId,\n        customerName: customer3.name,\n        customerEmail: customer3.email,\n        customerAvatar: customer3.avatar,\n        mode: \"wait\",\n      },\n    });\n    expectValidLeadResponse({\n      response,\n      customer: customer3,\n      clickId: trackedClickId,\n    });\n\n    const saleResponse = await http.post<TrackSaleResponse>({\n      path: \"/track/sale\",\n      body: {\n        customerExternalId: customer3.externalId,\n        eventName: \"Mode=Wait Purchase\",\n        amount: 500,\n        paymentProcessor: \"stripe\",\n      },\n    });\n\n    expect(saleResponse.status).toEqual(200);\n  });\n\n  test(\"track a lead with eventQuantity\", async () => {\n    const customer4 = randomCustomer();\n    const response = await http.post<TrackLeadResponse>({\n      path: \"/track/lead\",\n      body: {\n        clickId: trackedClickId,\n        eventName: \"Start Trial\",\n        customerExternalId: customer4.externalId,\n        customerName: customer4.name,\n        customerEmail: customer4.email,\n        customerAvatar: customer4.avatar,\n        eventQuantity: 2,\n      },\n    });\n\n    expectValidLeadResponse({\n      response,\n      customer: customer4,\n      clickId: trackedClickId,\n    });\n  });\n\n  test(\"track a lead with `externalId` (backward compatibility)\", async () => {\n    const customer5 = randomCustomer();\n    const response = await http.post<TrackLeadResponse>({\n      path: \"/track/lead\",\n      body: {\n        clickId: trackedClickId,\n        externalId: customer5.externalId,\n        eventName: \"Signup\",\n        customerName: customer5.name,\n        customerEmail: customer5.email,\n        customerAvatar: customer5.avatar,\n      },\n    });\n\n    expectValidLeadResponse({\n      response,\n      customer: customer5,\n      clickId: trackedClickId,\n    });\n  });\n\n  test(\"track a lead with `customerId` (backward compatibility)\", async () => {\n    const customer6 = randomCustomer();\n    const response = await http.post<TrackLeadResponse>({\n      path: \"/track/lead\",\n      body: {\n        clickId: trackedClickId,\n        customerId: customer6.externalId,\n        eventName: \"Signup\",\n        customerName: customer6.name,\n        customerEmail: customer6.email,\n        customerAvatar: customer6.avatar,\n      },\n    });\n\n    expectValidLeadResponse({\n      response,\n      customer: customer6,\n      clickId: trackedClickId,\n    });\n  });\n\n  test(\"track a lead and verify the reward based on the partner.country (US)\", async () => {\n    const clickResponse = await http.post<{ clickId: string }>({\n      path: \"/track/click\",\n      headers: E2E_TRACK_CLICK_HEADERS,\n      body: {\n        domain: \"getacme.link\",\n        key: \"marvin\",\n      },\n    });\n\n    const trackedClickId = clickResponse.data.clickId;\n    const customer = randomCustomer();\n\n    const response = await http.post<TrackLeadResponse>({\n      path: \"/track/lead\",\n      body: {\n        clickId: trackedClickId,\n        customerId: customer.externalId,\n        eventName: \"Signup\",\n        customerName: customer.name,\n        customerEmail: customer.email,\n        customerAvatar: customer.avatar,\n      },\n    });\n\n    expectValidLeadResponse({\n      response,\n      customer: customer,\n      clickId: trackedClickId,\n    });\n\n    await new Promise((resolve) => setTimeout(resolve, 2000));\n\n    await verifyCommission({\n      http,\n      customerExternalId: customer.externalId,\n      expectedEarnings: E2E_LEAD_REWARD.modifiers[0].amountInCents,\n    });\n  });\n});",
            "cost": 0.079195
        },
        "dubinc__dub.main/apps/web/tests/tracks/track-sale.test.ts": {
            "output": "import { TrackSaleResponse } from \"@/lib/types\";\nimport {\n  randomCustomer,\n  randomId,\n  randomSaleAmount,\n} from \"tests/utils/helpers\";\nimport {\n  E2E_CUSTOMER_EXTERNAL_ID,\n  E2E_CUSTOMER_EXTERNAL_ID_2,\n  E2E_CUSTOMER_ID,\n  E2E_SALE_REWARD,\n  E2E_TRACK_CLICK_HEADERS,\n} from \"tests/utils/resource\";\nimport { describe, expect, test } from \"vitest\";\nimport { IntegrationHarness } from \"../utils/integration\";\n\nconst expectValidSaleResponse = (\n  response: { status: number; data: TrackSaleResponse },\n  sale: any,\n) => {\n  expect(response.status).toEqual(200);\n  expect(response.data).toStrictEqual({\n    eventName: \"Subscription\",\n    customer: {\n      id: E2E_CUSTOMER_ID,\n      name: expect.any(String),\n      email: expect.any(String),\n      avatar: expect.any(String),\n      externalId: E2E_CUSTOMER_EXTERNAL_ID,\n    },\n    sale: {\n      amount: sale.amount,\n      currency: sale.currency,\n      paymentProcessor: sale.paymentProcessor,\n      invoiceId: sale.invoiceId,\n      metadata: null,\n    },\n  });\n};\n\n// Helper function to verify commission details\nconst verifyCommission = async (\n  http: any,\n  invoiceId: string,\n  expectedAmount: number,\n  expectedEarnings: number,\n) => {\n  const { status, data: commissions } = await http.get({\n    path: \"/commissions\",\n    query: { invoiceId },\n  });\n\n  expect(status).toEqual(200);\n  expect(commissions).toHaveLength(1);\n  expect(commissions[0].invoiceId).toEqual(invoiceId);\n  expect(commissions[0].amount).toEqual(expectedAmount);\n  expect(commissions[0].earnings).toEqual(expectedEarnings);\n};\n\ndescribe(\"POST /track/sale\", async () => {\n  const h = new IntegrationHarness();\n  const { http } = await h.init();\n\n  const sale = {\n    eventName: \"Subscription\",\n    amount: randomSaleAmount(),\n    currency: \"usd\",\n    invoiceId: `INV_${randomId()}`,\n    paymentProcessor: \"stripe\",\n  };\n\n  test(\"track a sale\", async () => {\n    const response = await http.post<TrackSaleResponse>({\n      path: \"/track/sale\",\n      body: {\n        ...sale,\n        customerExternalId: E2E_CUSTOMER_EXTERNAL_ID,\n      },\n    });\n\n    expectValidSaleResponse(response, sale);\n  });\n\n  test(\"track a sale with an invoiceId that is already processed (should return the same response as before) \", async () => {\n    const response = await http.post<TrackSaleResponse>({\n      path: \"/track/sale\",\n      body: {\n        ...sale,\n        customerExternalId: E2E_CUSTOMER_EXTERNAL_ID,\n        invoiceId: sale.invoiceId,\n      },\n    });\n\n    // should return the same response since it's idempotent\n    expectValidSaleResponse(response, sale);\n  });\n\n  test(\"track a sale with regular vs premium product ID (should create the right commission)\", async () => {\n    const regularInvoiceId = `INV_${randomId()}`;\n    const response1 = await http.post<TrackSaleResponse>({\n      path: \"/track/sale\",\n      body: {\n        ...sale,\n        amount: 2000,\n        customerExternalId: E2E_CUSTOMER_EXTERNAL_ID_2,\n        invoiceId: regularInvoiceId,\n        metadata: {\n          productId: \"regularProductId\",\n        },\n      },\n    });\n    expect(response1.status).toEqual(200);\n\n    const premiumInvoiceId = `INV_${randomId()}`;\n    const response2 = await http.post<TrackSaleResponse>({\n      path: \"/track/sale\",\n      body: {\n        ...sale,\n        amount: 3000,\n        customerExternalId: E2E_CUSTOMER_EXTERNAL_ID_2,\n        invoiceId: premiumInvoiceId,\n        metadata: {\n          productId: \"premiumProductId\",\n        },\n      },\n    });\n    expect(response2.status).toEqual(200);\n\n    // pause for 2 seconds for data to be fully processed\n    await new Promise((resolve) => setTimeout(resolve, 2000));\n\n    // Verify commissions\n    await verifyCommission(\n      http,\n      regularInvoiceId,\n      response1.data.sale?.amount!,\n      E2E_SALE_REWARD.amountInCents,\n    );\n    await verifyCommission(\n      http,\n      premiumInvoiceId,\n      response2.data.sale?.amount!,\n      E2E_SALE_REWARD.modifiers[0].amountInCents,\n    );\n  });\n\n  test(\"track a sale with an externalId that does not exist (should return null customer and sale)\", async () => {\n    const response = await http.post<TrackSaleResponse>({\n      path: \"/track/sale\",\n      body: {\n        ...sale,\n        invoiceId: `INV_${randomId()}`,\n        customerExternalId: \"external-id-that-does-not-exist\",\n      },\n    });\n\n    expect(response.status).toEqual(200);\n    expect(response.data).toStrictEqual({\n      eventName: \"Subscription\",\n      customer: null,\n      sale: null,\n    });\n  });\n\n  test(\"track a sale with `externalId` (backward compatibility)\", async () => {\n    const newSale = {\n      ...sale,\n      invoiceId: `INV_${randomId()}`,\n      amount: randomSaleAmount(),\n    };\n\n    const response = await http.post<TrackSaleResponse>({\n      path: \"/track/sale\",\n      body: {\n        ...newSale,\n        externalId: E2E_CUSTOMER_EXTERNAL_ID,\n      },\n    });\n\n    expectValidSaleResponse(response, newSale);\n  });\n\n  test(\"track a sale with `customerId` (backward compatibility)\", async () => {\n    const newSale = {\n      ...sale,\n      invoiceId: `INV_${randomId()}`,\n      amount: randomSaleAmount(),\n    };\n\n    const response5 = await http.post<TrackSaleResponse>({\n      path: \"/track/sale\",\n      body: {\n        ...newSale,\n        customerId: E2E_CUSTOMER_EXTERNAL_ID,\n      },\n    });\n\n    expectValidSaleResponse(response5, newSale);\n  });\n\n  test(\"track a sale with JPY currency (zero decimal currency)\", async () => {\n    const jpySale = {\n      ...sale,\n      eventName: \"Payment in JPY\",\n      invoiceId: `INV_${randomId()}`,\n      amount: 1437, // approximately 1000 USD cents\n      currency: \"jpy\",\n    };\n\n    const response = await http.post<TrackSaleResponse>({\n      path: \"/track/sale\",\n      body: {\n        ...jpySale,\n        customerExternalId: E2E_CUSTOMER_EXTERNAL_ID,\n      },\n    });\n\n    // Check if the converted amount is within an acceptable range\n    // 1437 JPY should be around 1000 USD cents (\u00b1100)\n    expect(response.status).toEqual(200);\n    expect(response.data.sale?.currency).toEqual(\"usd\");\n    expect(response.data.sale?.amount).toBeGreaterThanOrEqual(900); // 900 cents\n    expect(response.data.sale?.amount).toBeLessThanOrEqual(1100); // 1100 cents\n  });\n\n  test(\"track a sale with direct sale tracking\", async () => {\n    const clickResponse = await http.post<{ clickId: string }>({\n      path: \"/track/click\",\n      headers: E2E_TRACK_CLICK_HEADERS,\n      body: {\n        domain: \"getacme.link\",\n        key: \"derek\",\n      },\n    });\n    expect(clickResponse.status).toEqual(200);\n    expect(clickResponse.data.clickId).toStrictEqual(expect.any(String));\n    const trackedClickId = clickResponse.data.clickId;\n    const saleCustomer = randomCustomer();\n    const salePayload = {\n      ...sale,\n      eventName: \"Purchase (no lead event)\",\n      amount: randomSaleAmount(),\n      invoiceId: `INV_${randomId()}`,\n    };\n\n    const response = await http.post<TrackSaleResponse>({\n      path: \"/track/sale\",\n      body: {\n        ...salePayload,\n        clickId: trackedClickId,\n        leadEventName: \"Signup (auto lead tracking)\",\n        customerExternalId: saleCustomer.externalId,\n        customerName: saleCustomer.name,\n        customerEmail: saleCustomer.email,\n        customerAvatar: saleCustomer.avatar,\n      },\n    });\n\n    expect(response.status).toEqual(200);\n    expect(response.data).toStrictEqual({\n      eventName: salePayload.eventName,\n      customer: {\n        id: expect.any(String),\n        ...saleCustomer,\n      },\n      sale: {\n        amount: salePayload.amount,\n        currency: salePayload.currency,\n        paymentProcessor: salePayload.paymentProcessor,\n        invoiceId: salePayload.invoiceId,\n        metadata: null,\n      },\n    });\n  });\n\n  test(\"track sales with different amounts (verifies sale amount is passed via context for reward conditions)\", async () => {\n    // Test with a small sale amount\n    const smallSaleInvoiceId = `INV_${randomId()}`;\n    const smallSaleAmount = 10000; // $100.00\n\n    const response1 = await http.post<TrackSaleResponse>({\n      path: \"/track/sale\",\n      body: {\n        ...sale,\n        amount: smallSaleAmount,\n        customerExternalId: E2E_CUSTOMER_EXTERNAL_ID_2,\n        invoiceId: smallSaleInvoiceId,\n      },\n    });\n\n    expect(response1.status).toEqual(200);\n    expect(response1.data.sale?.amount).toEqual(smallSaleAmount);\n\n    // Test with a large sale amount\n    const largeSaleInvoiceId = `INV_${randomId()}`;\n    const largeSaleAmount = 20000; // $200.00\n\n    const response2 = await http.post<TrackSaleResponse>({\n      path: \"/track/sale\",\n      body: {\n        ...sale,\n        amount: largeSaleAmount,\n        customerExternalId: E2E_CUSTOMER_EXTERNAL_ID_2,\n        invoiceId: largeSaleInvoiceId,\n      },\n    });\n\n    expect(response2.status).toEqual(200);\n    expect(response2.data.sale?.amount).toEqual(largeSaleAmount);\n\n    // Pause for 2 seconds for data to be fully processed\n    await new Promise((resolve) => setTimeout(resolve, 2000));\n\n    await verifyCommission(\n      http,\n      smallSaleInvoiceId,\n      response1.data.sale?.amount!,\n      E2E_SALE_REWARD.amountInCents,\n    );\n\n    await verifyCommission(\n      http,\n      largeSaleInvoiceId,\n      response2.data.sale?.amount!,\n      E2E_SALE_REWARD.modifiers[1].amountInCents,\n    );\n  });\n});",
            "output_extracted": "import { TrackSaleResponse } from \"@/lib/types\";\nimport {\n  randomCustomer,\n  randomId,\n  randomSaleAmount,\n} from \"tests/utils/helpers\";\nimport {\n  E2E_CUSTOMER_EXTERNAL_ID,\n  E2E_CUSTOMER_EXTERNAL_ID_2,\n  E2E_CUSTOMER_ID,\n  E2E_SALE_REWARD,\n  E2E_TRACK_CLICK_HEADERS,\n} from \"tests/utils/resource\";\nimport { describe, expect, test } from \"vitest\";\nimport { IntegrationHarness } from \"../utils/integration\";\n\nconst expectValidSaleResponse = (\n  response: { status: number; data: TrackSaleResponse },\n  sale: any,\n) => {\n  expect(response.status).toEqual(200);\n  expect(response.data).toStrictEqual({\n    eventName: \"Subscription\",\n    customer: {\n      id: E2E_CUSTOMER_ID,\n      name: expect.any(String),\n      email: expect.any(String),\n      avatar: expect.any(String),\n      externalId: E2E_CUSTOMER_EXTERNAL_ID,\n    },\n    sale: {\n      amount: sale.amount,\n      currency: sale.currency,\n      paymentProcessor: sale.paymentProcessor,\n      invoiceId: sale.invoiceId,\n      metadata: null,\n    },\n  });\n};\n\n// Helper function to verify commission details\nconst verifyCommission = async (\n  http: any,\n  invoiceId: string,\n  expectedAmount: number,\n  expectedEarnings: number,\n) => {\n  const { status, data: commissions } = await http.get({\n    path: \"/commissions\",\n    query: { invoiceId },\n  });\n\n  expect(status).toEqual(200);\n  expect(commissions).toHaveLength(1);\n  expect(commissions[0].invoiceId).toEqual(invoiceId);\n  expect(commissions[0].amount).toEqual(expectedAmount);\n  expect(commissions[0].earnings).toEqual(expectedEarnings);\n};\n\ndescribe(\"POST /track/sale\", async () => {\n  const h = new IntegrationHarness();\n  const { http } = await h.init();\n\n  const sale = {\n    eventName: \"Subscription\",\n    amount: randomSaleAmount(),\n    currency: \"usd\",\n    invoiceId: `INV_${randomId()}`,\n    paymentProcessor: \"stripe\",\n  };\n\n  test(\"track a sale\", async () => {\n    const response = await http.post<TrackSaleResponse>({\n      path: \"/track/sale\",\n      body: {\n        ...sale,\n        customerExternalId: E2E_CUSTOMER_EXTERNAL_ID,\n      },\n    });\n\n    expectValidSaleResponse(response, sale);\n  });\n\n  test(\"track a sale with an invoiceId that is already processed (should return the same response as before) \", async () => {\n    const response = await http.post<TrackSaleResponse>({\n      path: \"/track/sale\",\n      body: {\n        ...sale,\n        customerExternalId: E2E_CUSTOMER_EXTERNAL_ID,\n        invoiceId: sale.invoiceId,\n      },\n    });\n\n    // should return the same response since it's idempotent\n    expectValidSaleResponse(response, sale);\n  });\n\n  test(\"track a sale with regular vs premium product ID (should create the right commission)\", async () => {\n    const regularInvoiceId = `INV_${randomId()}`;\n    const response1 = await http.post<TrackSaleResponse>({\n      path: \"/track/sale\",\n      body: {\n        ...sale,\n        amount: 2000,\n        customerExternalId: E2E_CUSTOMER_EXTERNAL_ID_2,\n        invoiceId: regularInvoiceId,\n        metadata: {\n          productId: \"regularProductId\",\n        },\n      },\n    });\n    expect(response1.status).toEqual(200);\n\n    const premiumInvoiceId = `INV_${randomId()}`;\n    const response2 = await http.post<TrackSaleResponse>({\n      path: \"/track/sale\",\n      body: {\n        ...sale,\n        amount: 3000,\n        customerExternalId: E2E_CUSTOMER_EXTERNAL_ID_2,\n        invoiceId: premiumInvoiceId,\n        metadata: {\n          productId: \"premiumProductId\",\n        },\n      },\n    });\n    expect(response2.status).toEqual(200);\n\n    // pause for 2 seconds for data to be fully processed\n    await new Promise((resolve) => setTimeout(resolve, 2000));\n\n    // Verify commissions\n    await verifyCommission(\n      http,\n      regularInvoiceId,\n      response1.data.sale?.amount!,\n      E2E_SALE_REWARD.amountInCents,\n    );\n    await verifyCommission(\n      http,\n      premiumInvoiceId,\n      response2.data.sale?.amount!,\n      E2E_SALE_REWARD.modifiers[0].amountInCents,\n    );\n  });\n\n  test(\"track a sale with an externalId that does not exist (should return null customer and sale)\", async () => {\n    const response = await http.post<TrackSaleResponse>({\n      path: \"/track/sale\",\n      body: {\n        ...sale,\n        invoiceId: `INV_${randomId()}`,\n        customerExternalId: \"external-id-that-does-not-exist\",\n      },\n    });\n\n    expect(response.status).toEqual(200);\n    expect(response.data).toStrictEqual({\n      eventName: \"Subscription\",\n      customer: null,\n      sale: null,\n    });\n  });\n\n  test(\"track a sale with `externalId` (backward compatibility)\", async () => {\n    const newSale = {\n      ...sale,\n      invoiceId: `INV_${randomId()}`,\n      amount: randomSaleAmount(),\n    };\n\n    const response = await http.post<TrackSaleResponse>({\n      path: \"/track/sale\",\n      body: {\n        ...newSale,\n        externalId: E2E_CUSTOMER_EXTERNAL_ID,\n      },\n    });\n\n    expectValidSaleResponse(response, newSale);\n  });\n\n  test(\"track a sale with `customerId` (backward compatibility)\", async () => {\n    const newSale = {\n      ...sale,\n      invoiceId: `INV_${randomId()}`,\n      amount: randomSaleAmount(),\n    };\n\n    const response5 = await http.post<TrackSaleResponse>({\n      path: \"/track/sale\",\n      body: {\n        ...newSale,\n        customerId: E2E_CUSTOMER_EXTERNAL_ID,\n      },\n    });\n\n    expectValidSaleResponse(response5, newSale);\n  });\n\n  test(\"track a sale with JPY currency (zero decimal currency)\", async () => {\n    const jpySale = {\n      ...sale,\n      eventName: \"Payment in JPY\",\n      invoiceId: `INV_${randomId()}`,\n      amount: 1437, // approximately 1000 USD cents\n      currency: \"jpy\",\n    };\n\n    const response = await http.post<TrackSaleResponse>({\n      path: \"/track/sale\",\n      body: {\n        ...jpySale,\n        customerExternalId: E2E_CUSTOMER_EXTERNAL_ID,\n      },\n    });\n\n    // Check if the converted amount is within an acceptable range\n    // 1437 JPY should be around 1000 USD cents (\u00b1100)\n    expect(response.status).toEqual(200);\n    expect(response.data.sale?.currency).toEqual(\"usd\");\n    expect(response.data.sale?.amount).toBeGreaterThanOrEqual(900); // 900 cents\n    expect(response.data.sale?.amount).toBeLessThanOrEqual(1100); // 1100 cents\n  });\n\n  test(\"track a sale with direct sale tracking\", async () => {\n    const clickResponse = await http.post<{ clickId: string }>({\n      path: \"/track/click\",\n      headers: E2E_TRACK_CLICK_HEADERS,\n      body: {\n        domain: \"getacme.link\",\n        key: \"derek\",\n      },\n    });\n    expect(clickResponse.status).toEqual(200);\n    expect(clickResponse.data.clickId).toStrictEqual(expect.any(String));\n    const trackedClickId = clickResponse.data.clickId;\n    const saleCustomer = randomCustomer();\n    const salePayload = {\n      ...sale,\n      eventName: \"Purchase (no lead event)\",\n      amount: randomSaleAmount(),\n      invoiceId: `INV_${randomId()}`,\n    };\n\n    const response = await http.post<TrackSaleResponse>({\n      path: \"/track/sale\",\n      body: {\n        ...salePayload,\n        clickId: trackedClickId,\n        leadEventName: \"Signup (auto lead tracking)\",\n        customerExternalId: saleCustomer.externalId,\n        customerName: saleCustomer.name,\n        customerEmail: saleCustomer.email,\n        customerAvatar: saleCustomer.avatar,\n      },\n    });\n\n    expect(response.status).toEqual(200);\n    expect(response.data).toStrictEqual({\n      eventName: salePayload.eventName,\n      customer: {\n        id: expect.any(String),\n        ...saleCustomer,\n      },\n      sale: {\n        amount: salePayload.amount,\n        currency: salePayload.currency,\n        paymentProcessor: salePayload.paymentProcessor,\n        invoiceId: salePayload.invoiceId,\n        metadata: null,\n      },\n    });\n  });\n\n  test(\"track sales with different amounts (verifies sale amount is passed via context for reward conditions)\", async () => {\n    // Test with a small sale amount\n    const smallSaleInvoiceId = `INV_${randomId()}`;\n    const smallSaleAmount = 10000; // $100.00\n\n    const response1 = await http.post<TrackSaleResponse>({\n      path: \"/track/sale\",\n      body: {\n        ...sale,\n        amount: smallSaleAmount,\n        customerExternalId: E2E_CUSTOMER_EXTERNAL_ID_2,\n        invoiceId: smallSaleInvoiceId,\n      },\n    });\n\n    expect(response1.status).toEqual(200);\n    expect(response1.data.sale?.amount).toEqual(smallSaleAmount);\n\n    // Test with a large sale amount\n    const largeSaleInvoiceId = `INV_${randomId()}`;\n    const largeSaleAmount = 20000; // $200.00\n\n    const response2 = await http.post<TrackSaleResponse>({\n      path: \"/track/sale\",\n      body: {\n        ...sale,\n        amount: largeSaleAmount,\n        customerExternalId: E2E_CUSTOMER_EXTERNAL_ID_2,\n        invoiceId: largeSaleInvoiceId,\n      },\n    });\n\n    expect(response2.status).toEqual(200);\n    expect(response2.data.sale?.amount).toEqual(largeSaleAmount);\n\n    // Pause for 2 seconds for data to be fully processed\n    await new Promise((resolve) => setTimeout(resolve, 2000));\n\n    await verifyCommission(\n      http,\n      smallSaleInvoiceId,\n      response1.data.sale?.amount!,\n      E2E_SALE_REWARD.amountInCents,\n    );\n\n    await verifyCommission(\n      http,\n      largeSaleInvoiceId,\n      response2.data.sale?.amount!,\n      E2E_SALE_REWARD.modifiers[1].amountInCents,\n    );\n  });\n});",
            "cost": 0.09846
        },
        "dubinc__dub.main/apps/web/tests/utils/resource.ts": {
            "output": "export const E2E_USER_ID = \"clxz1q7c7000hbqx5ckv4r82h\";\nexport const E2E_USER_ID_MEMBER = \"user_1KAERYAJ10MDM56EB9XPX4ZZ8\"; // for member user tests\nexport const E2E_WORKSPACE_ID = \"ws_clrei1gld0002vs9mzn93p8ik\";\n\nexport const E2E_LINK = {\n  domain: \"dub.sh\",\n  key: \"test-click-tracking\",\n  url: \"https://github.com/dubinc\",\n};\n\nexport const E2E_TRACK_CLICK_HEADERS = {\n  referer: \"https://dub.co\",\n  \"User-Agent\":\n    \"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36\",\n};\n\nexport const E2E_TAG = {\n  id: \"clvkopm8b0009nf98azsp9epk\",\n  name: \"E2E Tests (DO NOT DELETE)\",\n  color: \"red\",\n};\n\nexport const E2E_TAG_2 = {\n  id: \"tag_sfaXFOt0kFLtEV3Z5wtywbTl\",\n  name: \"E2E Tests 2 (DO NOT DELETE)\",\n  color: \"blue\",\n};\n\nexport const E2E_CUSTOMER_ID = \"cm25onzuv0001s1bbxchrc0ae\";\nexport const E2E_CUSTOMER_EXTERNAL_ID = \"cus_jTrfVKYN3Buc3F80JoqBiY0g\";\nexport const E2E_WEBHOOK_ID = \"wh_MHR7sZXXtZ7keBaNYZ30rQ0v\";\n\n// Folders specific\nexport const E2E_WRITE_ACCESS_FOLDER_ID = \"fold_1JP8FMYP08RGJKJB3S4DNYH13\"; // Folder with write access\nexport const E2E_READ_ONLY_FOLDER_ID = \"fold_1JP8FN462884CA6JJCVPAHAD4\"; // Folder with read-only access\nexport const E2E_NO_ACCESS_FOLDER_ID = \"fold_1JRZXGNNYWDA5QTT8CVDB3M23\"; // Folder with no access\nexport const E2E_READ_ONLY_FOLDER_LINK_ID = \"link_1KAESR5Z733716RTT4E1RSTW6\"; // A link in read-only folder\nexport const E2E_NO_ACCESS_FOLDER_LINK_ID = \"link_1KAESQ2Z6Q35WDV5NGSEVPFB0\"; // A link in no access folder\n\n// Rewards specific\nexport const E2E_CUSTOMER_EXTERNAL_ID_2 = \"cus_pqc8qRtofpu6ZqvutyNDGAU2\";\nexport const E2E_SALE_REWARD = {\n  id: \"rw_1JYPP77NNDG6TVPAJDKNZREQN\",\n  event: \"sale\",\n  type: \"flat\",\n  amountInCents: 1000,\n  modifiers: [\n    {\n      operator: \"AND\",\n      type: \"flat\",\n      amountInCents: 3000,\n      conditions: [\n        {\n          entity: \"sale\",\n          attribute: \"productId\",\n          operator: \"equals_to\",\n          value: \"premiumProductId\",\n        },\n      ],\n    },\n    {\n      operator: \"AND\",\n      type: \"flat\",\n      amountInCents: 5000,\n      conditions: [\n        {\n          entity: \"sale\",\n          attribute: \"amount\",\n          operator: \"greater_than\",\n          value: 15000,\n        },\n      ],\n    },\n  ],\n};\nexport const E2E_LEAD_REWARD = {\n  id: \"rw_1K82ESAT4YPY0STR20GKXZ7DR\",\n  event: \"lead\",\n  type: \"flat\",\n  amountInCents: 1000,\n  modifiers: [\n    {\n      type: \"flat\",\n      amountInCents: 200,\n      operator: \"AND\",\n      conditions: [\n        {\n          value: \"US\",\n          entity: \"customer\",\n          operator: \"equals_to\",\n          attribute: \"country\",\n        },\n      ],\n      maxDuration: null,\n    },\n  ],\n};\n\n// Discounts specific\nexport const E2E_CUSTOMER_WITH_DISCOUNT = {\n  id: \"cus_pNGuZQJrAKjzttQTZMI4a46y\",\n  externalId: \"cus_PowZhxHqUvN8MSdszEElqsUx\",\n  email: \"rural.yellow.takin@example.com\",\n};\n\nexport const E2E_DISCOUNT = {\n  id: \"disc_1K2E253814K7TA6YRKA86XMX5\",\n  amount: 30,\n  type: \"percentage\",\n  maxDuration: 3,\n  couponId: \"XZuejd0Q\",\n  couponTestId: \"2NMXz81x\",\n  description: null,\n};\n\n// Program\nexport const E2E_PROGRAM = {\n  id: \"prog_CYCu7IMAapjkRpTnr8F1azjN\",\n  domain: \"getacme.link\",\n};\n\nexport const E2E_PARTNER = {\n  id: \"pn_H4TB2V5hDIjpqB7PwrxESoY3\",\n  email: \"steven@dub.co\",\n  tenantId: \"4149092f-7265-4002-98d9-da9f8e67e1fb\",\n};\n\nexport const E2E_PARTNER_GROUP = {\n  id: \"grp_1K2E25381GVMG7HHM057TB92F\",\n  url: \"https://acme.dub.sh/\",\n};\n\nexport const E2E_FRAUD_PARTNER = {\n  id: \"pn_1K8ND11BZ4XPEX39QX3YMBGY0\",\n  email: \"kiran+e2e+1@dub.co\",\n  links: {\n    customerEmailMatch: {\n      domain: \"getacme.link\",\n      key: \"fraud-customer-match\",\n    },\n    customerEmailSuspiciousDomain: {\n      domain: \"getacme.link\",\n      key: \"fraud-customer-suspicious\",\n    },\n    referralSourceBanned: {\n      domain: \"getacme.link\",\n      key: \"fraud-referral-source-banned\",\n    },\n    paidTrafficDetected: {\n      domain: \"getacme.link\",\n      key: \"fraud-paid-traffic\",\n    },\n  },\n} as const;\n\nexport const E2E_FRAUD_REFERRAL_SOURCE_BANNED_DOMAIN =\n  \"test-hostname-for-referral-source-banned-do-not-delete.com\";",
            "output_extracted": "export const E2E_USER_ID = \"clxz1q7c7000hbqx5ckv4r82h\";\nexport const E2E_USER_ID_MEMBER = \"user_1KAERYAJ10MDM56EB9XPX4ZZ8\"; // for member user tests\nexport const E2E_WORKSPACE_ID = \"ws_clrei1gld0002vs9mzn93p8ik\";\n\nexport const E2E_LINK = {\n  domain: \"dub.sh\",\n  key: \"test-click-tracking\",\n  url: \"https://github.com/dubinc\",\n};\n\nexport const E2E_TRACK_CLICK_HEADERS = {\n  referer: \"https://dub.co\",\n  \"User-Agent\":\n    \"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36\",\n};\n\nexport const E2E_TAG = {\n  id: \"clvkopm8b0009nf98azsp9epk\",\n  name: \"E2E Tests (DO NOT DELETE)\",\n  color: \"red\",\n};\n\nexport const E2E_TAG_2 = {\n  id: \"tag_sfaXFOt0kFLtEV3Z5wtywbTl\",\n  name: \"E2E Tests 2 (DO NOT DELETE)\",\n  color: \"blue\",\n};\n\nexport const E2E_CUSTOMER_ID = \"cm25onzuv0001s1bbxchrc0ae\";\nexport const E2E_CUSTOMER_EXTERNAL_ID = \"cus_jTrfVKYN3Buc3F80JoqBiY0g\";\nexport const E2E_WEBHOOK_ID = \"wh_MHR7sZXXtZ7keBaNYZ30rQ0v\";\n\n// Folders specific\nexport const E2E_WRITE_ACCESS_FOLDER_ID = \"fold_1JP8FMYP08RGJKJB3S4DNYH13\"; // Folder with write access\nexport const E2E_READ_ONLY_FOLDER_ID = \"fold_1JP8FN462884CA6JJCVPAHAD4\"; // Folder with read-only access\nexport const E2E_NO_ACCESS_FOLDER_ID = \"fold_1JRZXGNNYWDA5QTT8CVDB3M23\"; // Folder with no access\nexport const E2E_READ_ONLY_FOLDER_LINK_ID = \"link_1KAESR5Z733716RTT4E1RSTW6\"; // A link in read-only folder\nexport const E2E_NO_ACCESS_FOLDER_LINK_ID = \"link_1KAESQ2Z6Q35WDV5NGSEVPFB0\"; // A link in no access folder\n\n// Rewards specific\nexport const E2E_CUSTOMER_EXTERNAL_ID_2 = \"cus_pqc8qRtofpu6ZqvutyNDGAU2\";\nexport const E2E_SALE_REWARD = {\n  id: \"rw_1JYPP77NNDG6TVPAJDKNZREQN\",\n  event: \"sale\",\n  type: \"flat\",\n  amountInCents: 1000,\n  modifiers: [\n    {\n      operator: \"AND\",\n      type: \"flat\",\n      amountInCents: 3000,\n      conditions: [\n        {\n          entity: \"sale\",\n          attribute: \"productId\",\n          operator: \"equals_to\",\n          value: \"premiumProductId\",\n        },\n      ],\n    },\n    {\n      operator: \"AND\",\n      type: \"flat\",\n      amountInCents: 5000,\n      conditions: [\n        {\n          entity: \"sale\",\n          attribute: \"amount\",\n          operator: \"greater_than\",\n          value: 15000,\n        },\n      ],\n    },\n  ],\n};\nexport const E2E_LEAD_REWARD = {\n  id: \"rw_1K82ESAT4YPY0STR20GKXZ7DR\",\n  event: \"lead\",\n  type: \"flat\",\n  amountInCents: 1000,\n  modifiers: [\n    {\n      type: \"flat\",\n      amountInCents: 200,\n      operator: \"AND\",\n      conditions: [\n        {\n          value: \"US\",\n          entity: \"customer\",\n          operator: \"equals_to\",\n          attribute: \"country\",\n        },\n      ],\n      maxDuration: null,\n    },\n  ],\n};\n\n// Discounts specific\nexport const E2E_CUSTOMER_WITH_DISCOUNT = {\n  id: \"cus_pNGuZQJrAKjzttQTZMI4a46y\",\n  externalId: \"cus_PowZhxHqUvN8MSdszEElqsUx\",\n  email: \"rural.yellow.takin@example.com\",\n};\n\nexport const E2E_DISCOUNT = {\n  id: \"disc_1K2E253814K7TA6YRKA86XMX5\",\n  amount: 30,\n  type: \"percentage\",\n  maxDuration: 3,\n  couponId: \"XZuejd0Q\",\n  couponTestId: \"2NMXz81x\",\n  description: null,\n};\n\n// Program\nexport const E2E_PROGRAM = {\n  id: \"prog_CYCu7IMAapjkRpTnr8F1azjN\",\n  domain: \"getacme.link\",\n};\n\nexport const E2E_PARTNER = {\n  id: \"pn_H4TB2V5hDIjpqB7PwrxESoY3\",\n  email: \"steven@dub.co\",\n  tenantId: \"4149092f-7265-4002-98d9-da9f8e67e1fb\",\n};\n\nexport const E2E_PARTNER_GROUP = {\n  id: \"grp_1K2E25381GVMG7HHM057TB92F\",\n  url: \"https://acme.dub.sh/\",\n};\n\nexport const E2E_FRAUD_PARTNER = {\n  id: \"pn_1K8ND11BZ4XPEX39QX3YMBGY0\",\n  email: \"kiran+e2e+1@dub.co\",\n  links: {\n    customerEmailMatch: {\n      domain: \"getacme.link\",\n      key: \"fraud-customer-match\",\n    },\n    customerEmailSuspiciousDomain: {\n      domain: \"getacme.link\",\n      key: \"fraud-customer-suspicious\",\n    },\n    referralSourceBanned: {\n      domain: \"getacme.link\",\n      key: \"fraud-referral-source-banned\",\n    },\n    paidTrafficDetected: {\n      domain: \"getacme.link\",\n      key: \"fraud-paid-traffic\",\n    },\n  },\n} as const;\n\nexport const E2E_FRAUD_REFERRAL_SOURCE_BANNED_DOMAIN =\n  \"test-hostname-for-referral-source-banned-do-not-delete.com\";",
            "cost": 0.069055
        }
    },
    "recover_status": "success",
    "instance_ref": {
        "instance_id": "dubinc__dub.main.3020",
        "repo": "dubinc/dub",
        "base_commit": "31d5d189c7760029408dbd5115b44fdcefd6bb0b",
        "head_commit": "774a5c2c7e5a48840a206f0ecf5488fbd6b22750",
        "title": "Reward modifiers tests",
        "merged_at": "2025-10-28T18:10:14Z",
        "html_url": "https://github.com/dubinc/dub/pull/3020",
        "test_files": [
            "apps/web/tests/rewards/lead-reward.test.ts",
            "apps/web/tests/rewards/sale-reward.test.ts",
            "apps/web/tests/tracks/track-lead.test.ts",
            "apps/web/tests/tracks/track-sale.test.ts"
        ],
        "code_files": [
            "apps/web/tests/utils/resource.ts",
            "apps/web/tests/utils/verify-commission.ts"
        ],
        "total_changes": 467,
        "num_files": 6,
        "pull_number": 3020,
        "patch": "diff --git a/apps/web/tests/rewards/lead-reward.test.ts b/apps/web/tests/rewards/lead-reward.test.ts\nnew file mode 100644\nindex 00000000000..990167233e9\n--- /dev/null\n+++ b/apps/web/tests/rewards/lead-reward.test.ts\n@@ -0,0 +1,91 @@\n+import { TrackLeadResponse } from \"@/lib/types\";\n+import { randomCustomer } from \"tests/utils/helpers\";\n+import {\n+  E2E_LEAD_REWARD,\n+  E2E_PARTNERS,\n+  E2E_TRACK_CLICK_HEADERS,\n+} from \"tests/utils/resource\";\n+import { verifyCommission } from \"tests/utils/verify-commission\";\n+import { describe, expect, test } from \"vitest\";\n+import { IntegrationHarness } from \"../utils/integration\";\n+\n+describe.concurrent(\"Lead rewards\", async () => {\n+  const h = new IntegrationHarness();\n+  const { http } = await h.init();\n+\n+  test(\"when {Partner} {Country} is {US}\", async () => {\n+    // Track the click\n+    const clickResponse = await http.post<{ clickId: string }>({\n+      path: \"/track/click\",\n+      headers: E2E_TRACK_CLICK_HEADERS,\n+      body: {\n+        ...E2E_PARTNERS[0].shortLink,\n+      },\n+    });\n+\n+    expect(clickResponse.status).toEqual(200);\n+\n+    const clickId = clickResponse.data.clickId;\n+    const customer = randomCustomer();\n+\n+    // Track the lead\n+    const trackLeadResponse = await http.post<TrackLeadResponse>({\n+      path: \"/track/lead\",\n+      body: {\n+        clickId,\n+        eventName: \"Signup\",\n+        customerExternalId: customer.externalId,\n+        customerName: customer.name,\n+        customerEmail: customer.email,\n+        customerAvatar: customer.avatar,\n+      },\n+    });\n+\n+    expect(trackLeadResponse.status).toEqual(200);\n+\n+    // Verify the commission\n+    await verifyCommission({\n+      http,\n+      customerExternalId: customer.externalId,\n+      expectedEarnings: E2E_LEAD_REWARD.modifiers[0].amountInCents,\n+    });\n+  });\n+\n+  test(\"when {Partner} {Country} is not {US}\", async () => {\n+    // Track the click\n+    const clickResponse = await http.post<{ clickId: string }>({\n+      path: \"/track/click\",\n+      headers: E2E_TRACK_CLICK_HEADERS,\n+      body: {\n+        ...E2E_PARTNERS[1].shortLink,\n+      },\n+    });\n+\n+    expect(clickResponse.status).toEqual(200);\n+\n+    const clickId = clickResponse.data.clickId;\n+    const customer = randomCustomer();\n+\n+    // Track the lead\n+    const trackLeadResponse = await http.post<TrackLeadResponse>({\n+      path: \"/track/lead\",\n+      body: {\n+        clickId,\n+        eventName: \"Signup\",\n+        customerExternalId: customer.externalId,\n+        customerName: customer.name,\n+        customerEmail: customer.email,\n+        customerAvatar: customer.avatar,\n+      },\n+    });\n+\n+    expect(trackLeadResponse.status).toEqual(200);\n+\n+    // Verify the commission\n+    await verifyCommission({\n+      http,\n+      customerExternalId: customer.externalId,\n+      expectedEarnings: E2E_LEAD_REWARD.amountInCents,\n+    });\n+  });\n+});\ndiff --git a/apps/web/tests/rewards/sale-reward.test.ts b/apps/web/tests/rewards/sale-reward.test.ts\nnew file mode 100644\nindex 00000000000..27bdf0ced11\n--- /dev/null\n+++ b/apps/web/tests/rewards/sale-reward.test.ts\n@@ -0,0 +1,65 @@\n+import { TrackSaleResponse } from \"@/lib/types\";\n+import { randomId } from \"tests/utils/helpers\";\n+import { E2E_CUSTOMERS, E2E_SALE_REWARD } from \"tests/utils/resource\";\n+import { verifyCommission } from \"tests/utils/verify-commission\";\n+import { describe, expect, test } from \"vitest\";\n+import { IntegrationHarness } from \"../utils/integration\";\n+\n+describe.concurrent(\"Sale rewards\", async () => {\n+  const h = new IntegrationHarness();\n+  const { http } = await h.init();\n+\n+  test(\"when {Customer} {Country} is {SG}\", async () => {\n+    const saleAmount = 10000; // $100 in cents\n+    const invoiceId = `INV_${randomId()}`;\n+\n+    // Track the sale\n+    const trackSaleResponse = await http.post<TrackSaleResponse>({\n+      path: \"/track/sale\",\n+      body: {\n+        customerExternalId: E2E_CUSTOMERS[0].externalId,\n+        eventName: \"Subscription\",\n+        amount: saleAmount,\n+        currency: \"usd\",\n+        invoiceId,\n+        paymentProcessor: \"stripe\",\n+      },\n+    });\n+\n+    expect(trackSaleResponse.status).toEqual(200);\n+\n+    // Verify the commission (10% of sale amount)\n+    await verifyCommission({\n+      http,\n+      invoiceId,\n+      expectedEarnings: saleAmount * 0.1,\n+    });\n+  });\n+\n+  test.skip(\"when {Customer} {Country} is {CA}\", async () => {\n+    const saleAmount = 10000; // $100 in cents\n+    const invoiceId = `INV_${randomId()}`;\n+\n+    // Track the sale\n+    const trackSaleResponse = await http.post<TrackSaleResponse>({\n+      path: \"/track/sale\",\n+      body: {\n+        customerExternalId: E2E_CUSTOMERS[1].externalId,\n+        eventName: \"Subscription\",\n+        amount: saleAmount,\n+        currency: \"usd\",\n+        invoiceId,\n+        paymentProcessor: \"stripe\",\n+      },\n+    });\n+\n+    expect(trackSaleResponse.status).toEqual(200);\n+\n+    // Verify the commission (base reward)\n+    await verifyCommission({\n+      http,\n+      invoiceId,\n+      expectedEarnings: E2E_SALE_REWARD.amountInCents,\n+    });\n+  });\n+});\ndiff --git a/apps/web/tests/tracks/track-lead.test.ts b/apps/web/tests/tracks/track-lead.test.ts\nindex 53921ac8512..a1e7a83c21d 100644\n--- a/apps/web/tests/tracks/track-lead.test.ts\n+++ b/apps/web/tests/tracks/track-lead.test.ts\n@@ -1,12 +1,6 @@\n-import {\n-  CommissionResponse,\n-  Customer,\n-  TrackLeadResponse,\n-  TrackSaleResponse,\n-} from \"@/lib/types\";\n+import { TrackLeadResponse, TrackSaleResponse } from \"@/lib/types\";\n import { randomCustomer } from \"tests/utils/helpers\";\n-import { HttpClient } from \"tests/utils/http\";\n-import { E2E_LEAD_REWARD, E2E_TRACK_CLICK_HEADERS } from \"tests/utils/resource\";\n+import { E2E_TRACK_CLICK_HEADERS } from \"tests/utils/resource\";\n import { describe, expect, test } from \"vitest\";\n import { IntegrationHarness } from \"../utils/integration\";\n \n@@ -30,39 +24,6 @@ const expectValidLeadResponse = ({\n   });\n };\n \n-const verifyCommission = async ({\n-  http,\n-  customerExternalId,\n-  expectedEarnings,\n-}: {\n-  http: HttpClient;\n-  customerExternalId: string;\n-  expectedEarnings: number;\n-}) => {\n-  // Find the customer first\n-  const { data: customers } = await http.get<Customer[]>({\n-    path: \"/customers\",\n-    query: {\n-      externalId: customerExternalId,\n-    },\n-  });\n-\n-  const customer = customers[0];\n-\n-  // Find the commission for the customer\n-  const { status, data: commissions } = await http.get<CommissionResponse[]>({\n-    path: \"/commissions\",\n-    query: {\n-      customerId: customer.id,\n-    },\n-  });\n-\n-  expect(status).toEqual(200);\n-  expect(commissions).toHaveLength(1);\n-  expect(commissions[0].customer?.id).toEqual(customer.id);\n-  expect(commissions[0].earnings).toEqual(expectedEarnings);\n-};\n-\n describe(\"POST /track/lead\", async () => {\n   const h = new IntegrationHarness();\n   const { http } = await h.init();\n@@ -254,44 +215,4 @@ describe(\"POST /track/lead\", async () => {\n       clickId: trackedClickId,\n     });\n   });\n-\n-  test(\"track a lead and verify the reward based on the partner.country (US)\", async () => {\n-    const clickResponse = await http.post<{ clickId: string }>({\n-      path: \"/track/click\",\n-      headers: E2E_TRACK_CLICK_HEADERS,\n-      body: {\n-        domain: \"getacme.link\",\n-        key: \"marvin\",\n-      },\n-    });\n-\n-    const trackedClickId = clickResponse.data.clickId;\n-    const customer = randomCustomer();\n-\n-    const response = await http.post<TrackLeadResponse>({\n-      path: \"/track/lead\",\n-      body: {\n-        clickId: trackedClickId,\n-        customerId: customer.externalId,\n-        eventName: \"Signup\",\n-        customerName: customer.name,\n-        customerEmail: customer.email,\n-        customerAvatar: customer.avatar,\n-      },\n-    });\n-\n-    expectValidLeadResponse({\n-      response,\n-      customer: customer,\n-      clickId: trackedClickId,\n-    });\n-\n-    await new Promise((resolve) => setTimeout(resolve, 2000));\n-\n-    await verifyCommission({\n-      http,\n-      customerExternalId: customer.externalId,\n-      expectedEarnings: E2E_LEAD_REWARD.modifiers[0].amountInCents,\n-    });\n-  });\n });\ndiff --git a/apps/web/tests/tracks/track-sale.test.ts b/apps/web/tests/tracks/track-sale.test.ts\nindex 562036082ff..2acbb45e1e5 100644\n--- a/apps/web/tests/tracks/track-sale.test.ts\n+++ b/apps/web/tests/tracks/track-sale.test.ts\n@@ -11,6 +11,7 @@ import {\n   E2E_SALE_REWARD,\n   E2E_TRACK_CLICK_HEADERS,\n } from \"tests/utils/resource\";\n+import { verifyCommission } from \"tests/utils/verify-commission\";\n import { describe, expect, test } from \"vitest\";\n import { IntegrationHarness } from \"../utils/integration\";\n \n@@ -38,25 +39,6 @@ const expectValidSaleResponse = (\n   });\n };\n \n-// Helper function to verify commission details\n-const verifyCommission = async (\n-  http: any,\n-  invoiceId: string,\n-  expectedAmount: number,\n-  expectedEarnings: number,\n-) => {\n-  const { status, data: commissions } = await http.get({\n-    path: \"/commissions\",\n-    query: { invoiceId },\n-  });\n-\n-  expect(status).toEqual(200);\n-  expect(commissions).toHaveLength(1);\n-  expect(commissions[0].invoiceId).toEqual(invoiceId);\n-  expect(commissions[0].amount).toEqual(expectedAmount);\n-  expect(commissions[0].earnings).toEqual(expectedEarnings);\n-};\n-\n describe(\"POST /track/sale\", async () => {\n   const h = new IntegrationHarness();\n   const { http } = await h.init();\n@@ -129,19 +111,19 @@ describe(\"POST /track/sale\", async () => {\n     // pause for 2 seconds for data to be fully processed\n     await new Promise((resolve) => setTimeout(resolve, 2000));\n \n-    // Verify commissions\n-    await verifyCommission(\n+    await verifyCommission({\n       http,\n-      regularInvoiceId,\n-      response1.data.sale?.amount!,\n-      E2E_SALE_REWARD.amountInCents,\n-    );\n-    await verifyCommission(\n+      invoiceId: regularInvoiceId,\n+      expectedAmount: response1.data.sale?.amount!,\n+      expectedEarnings: E2E_SALE_REWARD.amountInCents,\n+    });\n+\n+    await verifyCommission({\n       http,\n-      premiumInvoiceId,\n-      response2.data.sale?.amount!,\n-      E2E_SALE_REWARD.modifiers[0].amountInCents,\n-    );\n+      invoiceId: premiumInvoiceId,\n+      expectedAmount: response2.data.sale?.amount!,\n+      expectedEarnings: E2E_SALE_REWARD.modifiers[0].amountInCents!,\n+    });\n   });\n \n   test(\"track a sale with an externalId that does not exist (should return null customer and sale)\", async () => {\n@@ -311,18 +293,18 @@ describe(\"POST /track/sale\", async () => {\n     // Pause for 2 seconds for data to be fully processed\n     await new Promise((resolve) => setTimeout(resolve, 2000));\n \n-    await verifyCommission(\n+    await verifyCommission({\n       http,\n-      smallSaleInvoiceId,\n-      response1.data.sale?.amount!,\n-      E2E_SALE_REWARD.amountInCents,\n-    );\n+      invoiceId: smallSaleInvoiceId,\n+      expectedAmount: response1.data.sale?.amount!,\n+      expectedEarnings: E2E_SALE_REWARD.amountInCents,\n+    });\n \n-    await verifyCommission(\n+    await verifyCommission({\n       http,\n-      largeSaleInvoiceId,\n-      response2.data.sale?.amount!,\n-      E2E_SALE_REWARD.modifiers[1].amountInCents,\n-    );\n+      invoiceId: largeSaleInvoiceId,\n+      expectedAmount: response2.data.sale?.amount!,\n+      expectedEarnings: E2E_SALE_REWARD.modifiers[1].amountInCents!,\n+    });\n   });\n });\ndiff --git a/apps/web/tests/utils/resource.ts b/apps/web/tests/utils/resource.ts\nindex 67221a21284..6aefc236eb2 100644\n--- a/apps/web/tests/utils/resource.ts\n+++ b/apps/web/tests/utils/resource.ts\n@@ -45,42 +45,72 @@ export const E2E_SALE_REWARD = {\n   amountInCents: 1000,\n   modifiers: [\n     {\n-      operator: \"AND\",\n       type: \"flat\",\n-      amountInCents: 3000,\n+      operator: \"AND\",\n       conditions: [\n         {\n+          value: \"premiumProductId\",\n           entity: \"sale\",\n-          attribute: \"productId\",\n           operator: \"equals_to\",\n-          value: \"premiumProductId\",\n+          attribute: \"productId\",\n         },\n       ],\n+      maxDuration: null,\n+      amountInCents: 3000,\n     },\n     {\n-      operator: \"AND\",\n       type: \"flat\",\n-      amountInCents: 5000,\n+      operator: \"AND\",\n       conditions: [\n         {\n+          value: 15000,\n           entity: \"sale\",\n-          attribute: \"amount\",\n           operator: \"greater_than\",\n-          value: 15000,\n+          attribute: \"amount\",\n+        },\n+      ],\n+      maxDuration: null,\n+      amountInCents: 5000,\n+    },\n+    {\n+      type: \"percentage\",\n+      operator: \"AND\",\n+      conditions: [\n+        {\n+          value: \"US\",\n+          entity: \"customer\",\n+          operator: \"equals_to\",\n+          attribute: \"country\",\n+        },\n+      ],\n+      maxDuration: null,\n+      amountInPercentage: 10,\n+    },\n+    {\n+      type: \"flat\",\n+      operator: \"AND\",\n+      conditions: [\n+        {\n+          value: \"CA\",\n+          entity: \"customer\",\n+          operator: \"equals_to\",\n+          attribute: \"country\",\n         },\n       ],\n+      maxDuration: null,\n+      amountInCents: 50,\n     },\n   ],\n };\n+\n export const E2E_LEAD_REWARD = {\n   id: \"rw_1K82ESAT4YPY0STR20GKXZ7DR\",\n   event: \"lead\",\n   type: \"flat\",\n-  amountInCents: 1000,\n+  amountInCents: 100,\n   modifiers: [\n     {\n       type: \"flat\",\n-      amountInCents: 200,\n       operator: \"AND\",\n       conditions: [\n         {\n@@ -91,6 +121,21 @@ export const E2E_LEAD_REWARD = {\n         },\n       ],\n       maxDuration: null,\n+      amountInCents: 200,\n+    },\n+    {\n+      type: \"flat\",\n+      operator: \"AND\",\n+      conditions: [\n+        {\n+          value: \"US\",\n+          entity: \"customer\",\n+          operator: \"equals_to\",\n+          attribute: \"country\",\n+        },\n+      ],\n+      maxDuration: null,\n+      amountInCents: 400,\n     },\n   ],\n };\n@@ -128,3 +173,35 @@ export const E2E_PARTNER_GROUP = {\n   id: \"grp_1K2E25381GVMG7HHM057TB92F\",\n   url: \"https://acme.dub.sh/\",\n };\n+\n+export const E2E_PARTNERS = [\n+  {\n+    id: \"pn_NNG3YjwhLhA7nCZSaXeLIsWu\",\n+    country: \"US\",\n+    shortLink: {\n+      domain: \"getacme.link\",\n+      key: \"marvin\",\n+    },\n+  },\n+  {\n+    id: \"pn_1K8ND11BZ4XPEX39QX3YMBGY0\",\n+    country: \"SG\",\n+    shortLink: {\n+      domain: \"getacme.link\",\n+      key: \"kiran-e2e-1\",\n+    },\n+  },\n+] as const;\n+\n+export const E2E_CUSTOMERS = [\n+  {\n+    id: \"cus_1K82FYFF7RANMCGRHRGMWDNEC\",\n+    externalId: \"cus_LnZbkb8boLsOn1YGLPxZGZMU\",\n+    country: \"SG\",\n+  },\n+  {\n+    id: \"cus_1K86CG1DZFW8EMSSWXX4AVZFA\",\n+    externalId: \"cus_vq3UgXINHS99MIon8vNvAO1n\",\n+    country: \"CA\",\n+  },\n+] as const;\ndiff --git a/apps/web/tests/utils/verify-commission.ts b/apps/web/tests/utils/verify-commission.ts\nnew file mode 100644\nindex 00000000000..94e9b5304ff\n--- /dev/null\n+++ b/apps/web/tests/utils/verify-commission.ts\n@@ -0,0 +1,69 @@\n+import { CommissionResponse, Customer } from \"@/lib/types\";\n+import { expect } from \"vitest\";\n+import { HttpClient } from \"./http\";\n+\n+interface VerifyCommissionProps {\n+  http: HttpClient;\n+  customerExternalId?: string;\n+  invoiceId?: string;\n+  expectedAmount?: number;\n+  expectedEarnings: number;\n+}\n+\n+export const verifyCommission = async ({\n+  http,\n+  customerExternalId,\n+  invoiceId,\n+  expectedAmount,\n+  expectedEarnings,\n+}: VerifyCommissionProps) => {\n+  let customerId: string | undefined;\n+\n+  // Optional: resolve customer ID if customerExternalId is given\n+  if (customerExternalId) {\n+    const { data: customers } = await http.get<Customer[]>({\n+      path: \"/customers\",\n+      query: { externalId: customerExternalId },\n+    });\n+\n+    expect(customers.length).toBeGreaterThan(0);\n+    customerId = customers[0].id;\n+\n+    // Small delay if necessary for async commission processing\n+    await new Promise((resolve) => setTimeout(resolve, 2000));\n+  }\n+\n+  const query: Record<string, string> = {};\n+\n+  if (invoiceId) {\n+    query.invoiceId = invoiceId;\n+  }\n+\n+  if (customerId) {\n+    query.customerId = customerId;\n+  }\n+\n+  const { status, data: commissions } = await http.get<CommissionResponse[]>({\n+    path: \"/commissions\",\n+    query,\n+  });\n+\n+  expect(status).toEqual(200);\n+  expect(commissions).toHaveLength(1);\n+\n+  const commission = commissions[0];\n+\n+  if (invoiceId) {\n+    expect(commission.invoiceId).toEqual(invoiceId);\n+  }\n+\n+  if (customerId) {\n+    expect(commission.customer?.id).toEqual(customerId);\n+  }\n+\n+  if (expectedAmount !== undefined) {\n+    expect(commission.amount).toEqual(expectedAmount);\n+  }\n+\n+  expect(commission.earnings).toEqual(expectedEarnings);\n+};\n",
        "pr_mirror": "dubinc__dub.main"
    }
}