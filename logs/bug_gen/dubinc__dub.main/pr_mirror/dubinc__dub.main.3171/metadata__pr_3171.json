{
    "cost": 0.16575499999999999,
    "rewrites": {
        "dubinc__dub.main/apps/web/lib/middleware/utils/get-identity-hash.ts": {
            "output": "import { LOCALHOST_IP, hashStringSHA256 } from \"@dub/utils\";\nimport { ipAddress } from \"@vercel/functions\";\nimport { userAgent } from \"next/server\";\nimport { DUB_TEST_IDENTITY_HEADER } from \"tests/utils/resource\";\n\n/**\n * Combine IP + UA to create a unique identifier for the user (for deduplication)\n */\nexport async function getIdentityHash(req: Request) {\n  // If provided, use this identity directly (for E2E)\n  if (\n    process.env.NODE_ENV === \"development\" ||\n    process.env.VERCEL_ENV === \"preview\"\n  ) {\n    const testOverride = req.headers.get(DUB_TEST_IDENTITY_HEADER);\n\n    if (testOverride) {\n      return await hashStringSHA256(testOverride);\n    }\n  }\n\n  const ip = ipAddress(req) || LOCALHOST_IP;\n  const ua = userAgent(req);\n  return await hashStringSHA256(`${ip}-${ua.ua}`);\n}",
            "output_extracted": "import { LOCALHOST_IP, hashStringSHA256 } from \"@dub/utils\";\nimport { ipAddress } from \"@vercel/functions\";\nimport { userAgent } from \"next/server\";\nimport { DUB_TEST_IDENTITY_HEADER } from \"tests/utils/resource\";\n\n/**\n * Combine IP + UA to create a unique identifier for the user (for deduplication)\n */\nexport async function getIdentityHash(req: Request) {\n  // If provided, use this identity directly (for E2E)\n  if (\n    process.env.NODE_ENV === \"development\" ||\n    process.env.VERCEL_ENV === \"preview\"\n  ) {\n    const testOverride = req.headers.get(DUB_TEST_IDENTITY_HEADER);\n\n    if (testOverride) {\n      return await hashStringSHA256(testOverride);\n    }\n  }\n\n  const ip = ipAddress(req) || LOCALHOST_IP;\n  const ua = userAgent(req);\n  return await hashStringSHA256(`${ip}-${ua.ua}`);\n}",
            "cost": 0.012960000000000001
        },
        "dubinc__dub.main/apps/web/tests/fraud/index.test.ts": {
            "output": "import { Customer, fraudEventGroupProps, TrackLeadResponse } from \"@/lib/types\";\nimport { FraudRuleType } from \"@prisma/client\";\nimport { randomCustomer, randomId, retry } from \"tests/utils/helpers\";\nimport { HttpClient } from \"tests/utils/http\";\nimport {\n  DUB_TEST_IDENTITY_HEADER,\n  E2E_FRAUD_PARTNER,\n  E2E_FRAUD_REFERRAL_SOURCE_BANNED_DOMAIN,\n  E2E_TRACK_CLICK_HEADERS,\n} from \"tests/utils/resource\";\nimport { describe, expect, test } from \"vitest\";\nimport { IntegrationHarness } from \"../utils/integration\";\n\ndescribe.concurrent(\"/fraud/**\", async () => {\n  const h = new IntegrationHarness();\n  const { http } = await h.init();\n\n  test(\"FraudRuleType = customerEmailMatch\", async () => {\n    const clickLink = E2E_FRAUD_PARTNER.link;\n\n    // Track a click\n    const clickResponse = await http.post<{ clickId: string }>({\n      path: \"/track/click\",\n      headers: {\n        ...E2E_TRACK_CLICK_HEADERS,\n        [DUB_TEST_IDENTITY_HEADER]: randomId(10),\n      },\n      body: {\n        domain: clickLink.domain,\n        key: clickLink.key,\n      },\n    });\n\n    const trackedClickId = clickResponse.data.clickId;\n\n    // Track a lead\n    const customer = {\n      ...randomCustomer(),\n      email: E2E_FRAUD_PARTNER.email, // same email as partner\n    };\n\n    await http.post<TrackLeadResponse>({\n      path: \"/track/lead\",\n      body: {\n        eventName: \"Signup\",\n        clickId: trackedClickId,\n        customerId: customer.externalId,\n        customerName: customer.name,\n        customerEmail: customer.email,\n        customerAvatar: customer.avatar,\n      },\n    });\n\n    await verifyFraudEvent({\n      http,\n      customer,\n      ruleType: \"customerEmailMatch\",\n    });\n  });\n\n  test(\"FraudRuleType = customerEmailSuspiciousDomain\", async () => {\n    const clickLink = E2E_FRAUD_PARTNER.link;\n\n    // Track a click\n    const clickResponse = await http.post<{ clickId: string }>({\n      path: \"/track/click\",\n      headers: {\n        ...E2E_TRACK_CLICK_HEADERS,\n        [DUB_TEST_IDENTITY_HEADER]: randomId(10),\n      },\n      body: {\n        domain: clickLink.domain,\n        key: clickLink.key,\n      },\n    });\n\n    const trackedClickId = clickResponse.data.clickId;\n\n    // Track a lead\n    const customer = randomCustomer({ emailDomain: \"email-temp.com\" });\n\n    await http.post<TrackLeadResponse>({\n      path: \"/track/lead\",\n      body: {\n        eventName: \"Signup\",\n        clickId: trackedClickId,\n        customerId: customer.externalId,\n        customerName: customer.name,\n        customerEmail: customer.email,\n        customerAvatar: customer.avatar,\n      },\n    });\n\n    await verifyFraudEvent({\n      http,\n      customer,\n      ruleType: \"customerEmailSuspiciousDomain\",\n    });\n  });\n\n  test(\"FraudRuleType = referralSourceBanned\", async () => {\n    const clickLink = E2E_FRAUD_PARTNER.link;\n\n    // Track a click\n    const clickResponse = await http.post<{ clickId: string }>({\n      path: \"/track/click\",\n      headers: {\n        ...E2E_TRACK_CLICK_HEADERS,\n        referer: `https://${E2E_FRAUD_REFERRAL_SOURCE_BANNED_DOMAIN}`,\n        [DUB_TEST_IDENTITY_HEADER]: randomId(10),\n      },\n      body: {\n        domain: clickLink.domain,\n        key: clickLink.key,\n      },\n    });\n\n    const trackedClickId = clickResponse.data.clickId;\n\n    // Track a lead\n    const customer = randomCustomer();\n\n    await http.post<TrackLeadResponse>({\n      path: \"/track/lead\",\n      body: {\n        eventName: \"Signup\",\n        clickId: trackedClickId,\n        customerId: customer.externalId,\n        customerName: customer.name,\n        customerEmail: customer.email,\n        customerAvatar: customer.avatar,\n      },\n    });\n\n    await verifyFraudEvent({\n      http,\n      customer,\n      ruleType: \"referralSourceBanned\",\n    });\n  });\n\n  test(\"FraudRuleType = paidTrafficDetected\", async () => {\n    const clickLink = E2E_FRAUD_PARTNER.link;\n\n    // Track a click\n    const clickResponse = await http.post<{ clickId: string }>({\n      path: \"/track/click\",\n      headers: {\n        ...E2E_TRACK_CLICK_HEADERS,\n        [DUB_TEST_IDENTITY_HEADER]: randomId(10),\n      },\n      body: {\n        domain: clickLink.domain,\n        key: clickLink.key,\n        url: \"https://dub.co/paid-traffic?gclid=1234567890&gad_source=1\",\n      },\n    });\n\n    const trackedClickId = clickResponse.data.clickId;\n\n    // Track a lead\n    const customer = randomCustomer();\n\n    await http.post<TrackLeadResponse>({\n      path: \"/track/lead\",\n      body: {\n        eventName: \"Signup\",\n        clickId: trackedClickId,\n        customerId: customer.externalId,\n        customerName: customer.name,\n        customerEmail: customer.email,\n        customerAvatar: customer.avatar,\n      },\n    });\n\n    await verifyFraudEvent({\n      http,\n      customer,\n      ruleType: \"paidTrafficDetected\",\n    });\n  });\n});\n\nconst verifyFraudEvent = async ({\n  http,\n  customer,\n  ruleType,\n}: {\n  http: HttpClient;\n  customer: Pick<Customer, \"externalId\">;\n  ruleType: FraudRuleType;\n}) => {\n  // Resolve customerId from customerExternalID\n  const { data: customers } = await http.get<Customer[]>({\n    path: \"/customers\",\n    query: { externalId: customer.externalId },\n  });\n\n  expect(customers.length).toBeGreaterThan(0);\n\n  // Wait until fraud event is available\n  const fraudEvent = await waitForFraudEvent({\n    http,\n    customerId: customers[0].id,\n    ruleType,\n  });\n\n  // Assert fraud event shape\n  expect(fraudEvent).toStrictEqual({\n    createdAt: expect.any(String),\n    customer: expect.objectContaining({\n      id: customers[0].id,\n      name: customers[0].name,\n      email: customers[0].email,\n      avatar: customers[0].avatar,\n    }),\n    ...(ruleType === \"paidTrafficDetected\" && {\n      metadata: {\n        source: \"google\",\n        url: \"https://dub.co/paid-traffic?gclid=1234567890&gad_source=1\",\n      },\n    }),\n    ...(ruleType === \"referralSourceBanned\" && {\n      metadata: {\n        source: E2E_FRAUD_REFERRAL_SOURCE_BANNED_DOMAIN,\n      },\n    }),\n  });\n};\n\nasync function waitForFraudEvent({\n  http,\n  customerId,\n  ruleType,\n}: {\n  http: HttpClient;\n  customerId: string;\n  ruleType: FraudRuleType;\n}) {\n  return await retry(\n    async () => {\n      const { data } = await http.get<\n        fraudEventGroupProps[]\n      >({\n        path: \"/fraud/events\",\n        query: {\n          customerId,\n          type: ruleType,\n        },\n      });\n\n      if (!data.length) {\n        throw new Error(\"Fraud event not ready.\");\n      }\n\n      return data[0];\n    },\n    { retries: 10, interval: 600 },\n  );\n}",
            "output_extracted": "import { Customer, fraudEventGroupProps, TrackLeadResponse } from \"@/lib/types\";\nimport { FraudRuleType } from \"@prisma/client\";\nimport { randomCustomer, randomId, retry } from \"tests/utils/helpers\";\nimport { HttpClient } from \"tests/utils/http\";\nimport {\n  DUB_TEST_IDENTITY_HEADER,\n  E2E_FRAUD_PARTNER,\n  E2E_FRAUD_REFERRAL_SOURCE_BANNED_DOMAIN,\n  E2E_TRACK_CLICK_HEADERS,\n} from \"tests/utils/resource\";\nimport { describe, expect, test } from \"vitest\";\nimport { IntegrationHarness } from \"../utils/integration\";\n\ndescribe.concurrent(\"/fraud/**\", async () => {\n  const h = new IntegrationHarness();\n  const { http } = await h.init();\n\n  test(\"FraudRuleType = customerEmailMatch\", async () => {\n    const clickLink = E2E_FRAUD_PARTNER.link;\n\n    // Track a click\n    const clickResponse = await http.post<{ clickId: string }>({\n      path: \"/track/click\",\n      headers: {\n        ...E2E_TRACK_CLICK_HEADERS,\n        [DUB_TEST_IDENTITY_HEADER]: randomId(10),\n      },\n      body: {\n        domain: clickLink.domain,\n        key: clickLink.key,\n      },\n    });\n\n    const trackedClickId = clickResponse.data.clickId;\n\n    // Track a lead\n    const customer = {\n      ...randomCustomer(),\n      email: E2E_FRAUD_PARTNER.email, // same email as partner\n    };\n\n    await http.post<TrackLeadResponse>({\n      path: \"/track/lead\",\n      body: {\n        eventName: \"Signup\",\n        clickId: trackedClickId,\n        customerId: customer.externalId,\n        customerName: customer.name,\n        customerEmail: customer.email,\n        customerAvatar: customer.avatar,\n      },\n    });\n\n    await verifyFraudEvent({\n      http,\n      customer,\n      ruleType: \"customerEmailMatch\",\n    });\n  });\n\n  test(\"FraudRuleType = customerEmailSuspiciousDomain\", async () => {\n    const clickLink = E2E_FRAUD_PARTNER.link;\n\n    // Track a click\n    const clickResponse = await http.post<{ clickId: string }>({\n      path: \"/track/click\",\n      headers: {\n        ...E2E_TRACK_CLICK_HEADERS,\n        [DUB_TEST_IDENTITY_HEADER]: randomId(10),\n      },\n      body: {\n        domain: clickLink.domain,\n        key: clickLink.key,\n      },\n    });\n\n    const trackedClickId = clickResponse.data.clickId;\n\n    // Track a lead\n    const customer = randomCustomer({ emailDomain: \"email-temp.com\" });\n\n    await http.post<TrackLeadResponse>({\n      path: \"/track/lead\",\n      body: {\n        eventName: \"Signup\",\n        clickId: trackedClickId,\n        customerId: customer.externalId,\n        customerName: customer.name,\n        customerEmail: customer.email,\n        customerAvatar: customer.avatar,\n      },\n    });\n\n    await verifyFraudEvent({\n      http,\n      customer,\n      ruleType: \"customerEmailSuspiciousDomain\",\n    });\n  });\n\n  test(\"FraudRuleType = referralSourceBanned\", async () => {\n    const clickLink = E2E_FRAUD_PARTNER.link;\n\n    // Track a click\n    const clickResponse = await http.post<{ clickId: string }>({\n      path: \"/track/click\",\n      headers: {\n        ...E2E_TRACK_CLICK_HEADERS,\n        referer: `https://${E2E_FRAUD_REFERRAL_SOURCE_BANNED_DOMAIN}`,\n        [DUB_TEST_IDENTITY_HEADER]: randomId(10),\n      },\n      body: {\n        domain: clickLink.domain,\n        key: clickLink.key,\n      },\n    });\n\n    const trackedClickId = clickResponse.data.clickId;\n\n    // Track a lead\n    const customer = randomCustomer();\n\n    await http.post<TrackLeadResponse>({\n      path: \"/track/lead\",\n      body: {\n        eventName: \"Signup\",\n        clickId: trackedClickId,\n        customerId: customer.externalId,\n        customerName: customer.name,\n        customerEmail: customer.email,\n        customerAvatar: customer.avatar,\n      },\n    });\n\n    await verifyFraudEvent({\n      http,\n      customer,\n      ruleType: \"referralSourceBanned\",\n    });\n  });\n\n  test(\"FraudRuleType = paidTrafficDetected\", async () => {\n    const clickLink = E2E_FRAUD_PARTNER.link;\n\n    // Track a click\n    const clickResponse = await http.post<{ clickId: string }>({\n      path: \"/track/click\",\n      headers: {\n        ...E2E_TRACK_CLICK_HEADERS,\n        [DUB_TEST_IDENTITY_HEADER]: randomId(10),\n      },\n      body: {\n        domain: clickLink.domain,\n        key: clickLink.key,\n        url: \"https://dub.co/paid-traffic?gclid=1234567890&gad_source=1\",\n      },\n    });\n\n    const trackedClickId = clickResponse.data.clickId;\n\n    // Track a lead\n    const customer = randomCustomer();\n\n    await http.post<TrackLeadResponse>({\n      path: \"/track/lead\",\n      body: {\n        eventName: \"Signup\",\n        clickId: trackedClickId,\n        customerId: customer.externalId,\n        customerName: customer.name,\n        customerEmail: customer.email,\n        customerAvatar: customer.avatar,\n      },\n    });\n\n    await verifyFraudEvent({\n      http,\n      customer,\n      ruleType: \"paidTrafficDetected\",\n    });\n  });\n});\n\nconst verifyFraudEvent = async ({\n  http,\n  customer,\n  ruleType,\n}: {\n  http: HttpClient;\n  customer: Pick<Customer, \"externalId\">;\n  ruleType: FraudRuleType;\n}) => {\n  // Resolve customerId from customerExternalID\n  const { data: customers } = await http.get<Customer[]>({\n    path: \"/customers\",\n    query: { externalId: customer.externalId },\n  });\n\n  expect(customers.length).toBeGreaterThan(0);\n\n  // Wait until fraud event is available\n  const fraudEvent = await waitForFraudEvent({\n    http,\n    customerId: customers[0].id,\n    ruleType,\n  });\n\n  // Assert fraud event shape\n  expect(fraudEvent).toStrictEqual({\n    createdAt: expect.any(String),\n    customer: expect.objectContaining({\n      id: customers[0].id,\n      name: customers[0].name,\n      email: customers[0].email,\n      avatar: customers[0].avatar,\n    }),\n    ...(ruleType === \"paidTrafficDetected\" && {\n      metadata: {\n        source: \"google\",\n        url: \"https://dub.co/paid-traffic?gclid=1234567890&gad_source=1\",\n      },\n    }),\n    ...(ruleType === \"referralSourceBanned\" && {\n      metadata: {\n        source: E2E_FRAUD_REFERRAL_SOURCE_BANNED_DOMAIN,\n      },\n    }),\n  });\n};\n\nasync function waitForFraudEvent({\n  http,\n  customerId,\n  ruleType,\n}: {\n  http: HttpClient;\n  customerId: string;\n  ruleType: FraudRuleType;\n}) {\n  return await retry(\n    async () => {\n      const { data } = await http.get<\n        fraudEventGroupProps[]\n      >({\n        path: \"/fraud/events\",\n        query: {\n          customerId,\n          type: ruleType,\n        },\n      });\n\n      if (!data.length) {\n        throw new Error(\"Fraud event not ready.\");\n      }\n\n      return data[0];\n    },\n    { retries: 10, interval: 600 },\n  );\n}",
            "cost": 0.072545
        },
        "dubinc__dub.main/apps/web/tests/utils/resource.ts": {
            "output": "export const E2E_USER_ID = \"clxz1q7c7000hbqx5ckv4r82h\";\nexport const E2E_USER_ID_MEMBER = \"user_1KAERYAJ10MDM56EB9XPX4ZZ8\"; // for member user tests\nexport const E2E_WORKSPACE_ID = \"ws_clrei1gld0002vs9mzn93p8ik\";\n\nexport const E2E_LINK = {\n  domain: \"dub.sh\",\n  key: \"test-click-tracking\",\n  url: \"https://github.com/dubinc\",\n};\n\n/**\n * Used exclusively in E2E tests to override the computed identity hash.\n * When this header is present, `getIdentityHash()` will use its value\n * as the hash input instead of relying on the real IP/User-Agent.\n *\n * This prevents deduplication during automated tests where multiple\n * requests originate from the same IP and UA.\n */\nexport const DUB_TEST_IDENTITY_HEADER = \"x-dub-test-identity\";\n\nexport const E2E_TRACK_CLICK_HEADERS = {\n  referer: \"https://dub.co\",\n  \"User-Agent\":\n    \"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36\",\n};\n\nexport const E2E_TAG = {\n  id: \"clvkopm8b0009nf98azsp9epk\",\n  name: \"E2E Tests (DO NOT DELETE)\",\n  color: \"red\",\n};\n\nexport const E2E_TAG_2 = {\n  id: \"tag_sfaXFOt0kFLtEV3Z5wtywbTl\",\n  name: \"E2E Tests 2 (DO NOT DELETE)\",\n  color: \"blue\",\n};\n\nexport const E2E_CUSTOMER_ID = \"cm25onzuv0001s1bbxchrc0ae\";\nexport const E2E_CUSTOMER_EXTERNAL_ID = \"cus_jTrfVKYN3Buc3F80JoqBiY0g\";\nexport const E2E_WEBHOOK_ID = \"wh_MHR7sZXXtZ7keBaNYZ30rQ0v\";\n\n// Folders specific\nexport const E2E_WRITE_ACCESS_FOLDER_ID = \"fold_1JP8FMYP08RGJKJB3S4DNYH13\"; // Folder with write access\nexport const E2E_READ_ONLY_FOLDER_ID = \"fold_1JP8FN462884CA6JJCVPAHAD4\"; // Folder with read-only access\nexport const E2E_NO_ACCESS_FOLDER_ID = \"fold_1JRZXGNNYWDA5QTT8CVDB3M23\"; // Folder with no access\nexport const E2E_READ_ONLY_FOLDER_LINK_ID = \"link_1KAESR5Z733716RTT4E1RSTW6\"; // A link in read-only folder\nexport const E2E_NO_ACCESS_FOLDER_LINK_ID = \"link_1KAESQ2Z6Q35WDV5NGSEVPFB0\"; // A link in no access folder\n\n// Rewards specific\nexport const E2E_CUSTOMER_EXTERNAL_ID_2 = \"cus_pqc8qRtofpu6ZqvutyNDGAU2\";\nexport const E2E_SALE_REWARD = {\n  id: \"rw_1JYPP77NNDG6TVPAJDKNZREQN\",\n  event: \"sale\",\n  type: \"flat\",\n  amountInCents: 1000,\n  modifiers: [\n    {\n      type: \"flat\",\n      operator: \"AND\",\n      conditions: [\n        {\n          value: \"premiumProductId\",\n          entity: \"sale\",\n          operator: \"equals_to\",\n          attribute: \"productId\",\n        },\n      ],\n      maxDuration: null,\n      amountInCents: 3000,\n    },\n    {\n      type: \"flat\",\n      operator: \"AND\",\n      conditions: [\n        {\n          value: 15000,\n          entity: \"sale\",\n          operator: \"greater_than\",\n          attribute: \"amount\",\n        },\n      ],\n      maxDuration: null,\n      amountInCents: 5000,\n    },\n    {\n      type: \"percentage\",\n      operator: \"AND\",\n      conditions: [\n        {\n          value: \"US\",\n          entity: \"customer\",\n          operator: \"equals_to\",\n          attribute: \"country\",\n        },\n      ],\n      maxDuration: null,\n      amountInPercentage: 10,\n    },\n    {\n      type: \"flat\",\n      operator: \"AND\",\n      conditions: [\n        {\n          value: \"CA\",\n          entity: \"customer\",\n          operator: \"equals_to\",\n          attribute: \"country\",\n        },\n      ],\n      maxDuration: null,\n      amountInCents: 50,\n    },\n  ],\n};\n\nexport const E2E_LEAD_REWARD = {\n  id: \"rw_1K82ESAT4YPY0STR20GKXZ7DR\",\n  event: \"lead\",\n  type: \"flat\",\n  amountInCents: 100,\n  modifiers: [\n    {\n      type: \"flat\",\n      operator: \"AND\",\n      conditions: [\n        {\n          value: \"US\",\n          entity: \"customer\",\n          operator: \"equals_to\",\n          attribute: \"country\",\n        },\n      ],\n      maxDuration: null,\n      amountInCents: 200,\n    },\n    {\n      type: \"flat\",\n      operator: \"AND\",\n      conditions: [\n        {\n          value: \"US\",\n          entity: \"partner\",\n          operator: \"equals_to\",\n          attribute: \"country\",\n        },\n      ],\n      maxDuration: 0,\n      amountInCents: 300,\n    },\n  ],\n};\n\n// Discounts specific\nexport const E2E_CUSTOMER_WITH_DISCOUNT = {\n  id: \"cus_pNGuZQJrAKjzttQTZMI4a46y\",\n  externalId: \"cus_PowZhxHqUvN8MSdszEElqsUx\",\n  email: \"rural.yellow.takin@example.com\",\n};\n\nexport const E2E_DISCOUNT = {\n  id: \"disc_1K2E253814K7TA6YRKA86XMX5\",\n  amount: 30,\n  type: \"percentage\",\n  maxDuration: 3,\n  couponId: \"XZuejd0Q\",\n  couponTestId: \"2NMXz81x\",\n  description: null,\n};\n\n// Program\nexport const E2E_PROGRAM = {\n  id: \"prog_CYCu7IMAapjkRpTnr8F1azjN\",\n  domain: \"getacme.link\",\n};\n\nexport const E2E_PARTNER = {\n  id: \"pn_H4TB2V5hDIjpqB7PwrxESoY3\",\n  email: \"steven@dub.co\",\n  tenantId: \"4149092f-7265-4002-98d9-da9f8e67e1fb\",\n};\n\nexport const E2E_PARTNER_GROUP = {\n  id: \"grp_1K2E25381GVMG7HHM057TB92F\",\n  url: \"https://acme.dub.sh/\",\n};\n\nexport const E2E_PARTNERS = [\n  {\n    id: \"pn_NNG3YjwhLhA7nCZSaXeLIsWu\",\n    country: \"US\",\n    shortLink: {\n      domain: \"getacme.link\",\n      key: \"marvin\",\n    },\n  },\n  {\n    id: \"pn_1K8ND11BZ4XPEX39QX3YMBGY0\",\n    country: \"SG\",\n    shortLink: {\n      domain: \"getacme.link\",\n      key: \"kiran-e2e-1\",\n    },\n  },\n] as const;\n\nexport const E2E_CUSTOMERS = [\n  {\n    id: \"cus_1K82FYFF7RANMCGRHRGMWDNEC\",\n    externalId: \"cus_LnZbkb8boLsOn1YGLPxZGZMU\",\n    country: \"SG\",\n  },\n  {\n    id: \"cus_1K86CG1DZFW8EMSSWXX4AVZFA\",\n    externalId: \"cus_vq3UgXINHS99MIon8vNvAO1n\",\n    country: \"CA\",\n  },\n] as const;\n\nexport const E2E_FRAUD_PARTNER = {\n  id: \"pn_1K8ND11BZ4XPEX39QX3YMBGY0\",\n  email: \"kiran+e2e+1@dub.co\",\n  link: {\n    domain: \"getacme.link\",\n    key: \"kiran-e2e-1\",\n  },\n} as const;\n\nexport const E2E_FRAUD_REFERRAL_SOURCE_BANNED_DOMAIN =\n  \"test-hostname-for-referral-source-banned-do-not-delete.com\";",
            "output_extracted": "export const E2E_USER_ID = \"clxz1q7c7000hbqx5ckv4r82h\";\nexport const E2E_USER_ID_MEMBER = \"user_1KAERYAJ10MDM56EB9XPX4ZZ8\"; // for member user tests\nexport const E2E_WORKSPACE_ID = \"ws_clrei1gld0002vs9mzn93p8ik\";\n\nexport const E2E_LINK = {\n  domain: \"dub.sh\",\n  key: \"test-click-tracking\",\n  url: \"https://github.com/dubinc\",\n};\n\n/**\n * Used exclusively in E2E tests to override the computed identity hash.\n * When this header is present, `getIdentityHash()` will use its value\n * as the hash input instead of relying on the real IP/User-Agent.\n *\n * This prevents deduplication during automated tests where multiple\n * requests originate from the same IP and UA.\n */\nexport const DUB_TEST_IDENTITY_HEADER = \"x-dub-test-identity\";\n\nexport const E2E_TRACK_CLICK_HEADERS = {\n  referer: \"https://dub.co\",\n  \"User-Agent\":\n    \"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36\",\n};\n\nexport const E2E_TAG = {\n  id: \"clvkopm8b0009nf98azsp9epk\",\n  name: \"E2E Tests (DO NOT DELETE)\",\n  color: \"red\",\n};\n\nexport const E2E_TAG_2 = {\n  id: \"tag_sfaXFOt0kFLtEV3Z5wtywbTl\",\n  name: \"E2E Tests 2 (DO NOT DELETE)\",\n  color: \"blue\",\n};\n\nexport const E2E_CUSTOMER_ID = \"cm25onzuv0001s1bbxchrc0ae\";\nexport const E2E_CUSTOMER_EXTERNAL_ID = \"cus_jTrfVKYN3Buc3F80JoqBiY0g\";\nexport const E2E_WEBHOOK_ID = \"wh_MHR7sZXXtZ7keBaNYZ30rQ0v\";\n\n// Folders specific\nexport const E2E_WRITE_ACCESS_FOLDER_ID = \"fold_1JP8FMYP08RGJKJB3S4DNYH13\"; // Folder with write access\nexport const E2E_READ_ONLY_FOLDER_ID = \"fold_1JP8FN462884CA6JJCVPAHAD4\"; // Folder with read-only access\nexport const E2E_NO_ACCESS_FOLDER_ID = \"fold_1JRZXGNNYWDA5QTT8CVDB3M23\"; // Folder with no access\nexport const E2E_READ_ONLY_FOLDER_LINK_ID = \"link_1KAESR5Z733716RTT4E1RSTW6\"; // A link in read-only folder\nexport const E2E_NO_ACCESS_FOLDER_LINK_ID = \"link_1KAESQ2Z6Q35WDV5NGSEVPFB0\"; // A link in no access folder\n\n// Rewards specific\nexport const E2E_CUSTOMER_EXTERNAL_ID_2 = \"cus_pqc8qRtofpu6ZqvutyNDGAU2\";\nexport const E2E_SALE_REWARD = {\n  id: \"rw_1JYPP77NNDG6TVPAJDKNZREQN\",\n  event: \"sale\",\n  type: \"flat\",\n  amountInCents: 1000,\n  modifiers: [\n    {\n      type: \"flat\",\n      operator: \"AND\",\n      conditions: [\n        {\n          value: \"premiumProductId\",\n          entity: \"sale\",\n          operator: \"equals_to\",\n          attribute: \"productId\",\n        },\n      ],\n      maxDuration: null,\n      amountInCents: 3000,\n    },\n    {\n      type: \"flat\",\n      operator: \"AND\",\n      conditions: [\n        {\n          value: 15000,\n          entity: \"sale\",\n          operator: \"greater_than\",\n          attribute: \"amount\",\n        },\n      ],\n      maxDuration: null,\n      amountInCents: 5000,\n    },\n    {\n      type: \"percentage\",\n      operator: \"AND\",\n      conditions: [\n        {\n          value: \"US\",\n          entity: \"customer\",\n          operator: \"equals_to\",\n          attribute: \"country\",\n        },\n      ],\n      maxDuration: null,\n      amountInPercentage: 10,\n    },\n    {\n      type: \"flat\",\n      operator: \"AND\",\n      conditions: [\n        {\n          value: \"CA\",\n          entity: \"customer\",\n          operator: \"equals_to\",\n          attribute: \"country\",\n        },\n      ],\n      maxDuration: null,\n      amountInCents: 50,\n    },\n  ],\n};\n\nexport const E2E_LEAD_REWARD = {\n  id: \"rw_1K82ESAT4YPY0STR20GKXZ7DR\",\n  event: \"lead\",\n  type: \"flat\",\n  amountInCents: 100,\n  modifiers: [\n    {\n      type: \"flat\",\n      operator: \"AND\",\n      conditions: [\n        {\n          value: \"US\",\n          entity: \"customer\",\n          operator: \"equals_to\",\n          attribute: \"country\",\n        },\n      ],\n      maxDuration: null,\n      amountInCents: 200,\n    },\n    {\n      type: \"flat\",\n      operator: \"AND\",\n      conditions: [\n        {\n          value: \"US\",\n          entity: \"partner\",\n          operator: \"equals_to\",\n          attribute: \"country\",\n        },\n      ],\n      maxDuration: 0,\n      amountInCents: 300,\n    },\n  ],\n};\n\n// Discounts specific\nexport const E2E_CUSTOMER_WITH_DISCOUNT = {\n  id: \"cus_pNGuZQJrAKjzttQTZMI4a46y\",\n  externalId: \"cus_PowZhxHqUvN8MSdszEElqsUx\",\n  email: \"rural.yellow.takin@example.com\",\n};\n\nexport const E2E_DISCOUNT = {\n  id: \"disc_1K2E253814K7TA6YRKA86XMX5\",\n  amount: 30,\n  type: \"percentage\",\n  maxDuration: 3,\n  couponId: \"XZuejd0Q\",\n  couponTestId: \"2NMXz81x\",\n  description: null,\n};\n\n// Program\nexport const E2E_PROGRAM = {\n  id: \"prog_CYCu7IMAapjkRpTnr8F1azjN\",\n  domain: \"getacme.link\",\n};\n\nexport const E2E_PARTNER = {\n  id: \"pn_H4TB2V5hDIjpqB7PwrxESoY3\",\n  email: \"steven@dub.co\",\n  tenantId: \"4149092f-7265-4002-98d9-da9f8e67e1fb\",\n};\n\nexport const E2E_PARTNER_GROUP = {\n  id: \"grp_1K2E25381GVMG7HHM057TB92F\",\n  url: \"https://acme.dub.sh/\",\n};\n\nexport const E2E_PARTNERS = [\n  {\n    id: \"pn_NNG3YjwhLhA7nCZSaXeLIsWu\",\n    country: \"US\",\n    shortLink: {\n      domain: \"getacme.link\",\n      key: \"marvin\",\n    },\n  },\n  {\n    id: \"pn_1K8ND11BZ4XPEX39QX3YMBGY0\",\n    country: \"SG\",\n    shortLink: {\n      domain: \"getacme.link\",\n      key: \"kiran-e2e-1\",\n    },\n  },\n] as const;\n\nexport const E2E_CUSTOMERS = [\n  {\n    id: \"cus_1K82FYFF7RANMCGRHRGMWDNEC\",\n    externalId: \"cus_LnZbkb8boLsOn1YGLPxZGZMU\",\n    country: \"SG\",\n  },\n  {\n    id: \"cus_1K86CG1DZFW8EMSSWXX4AVZFA\",\n    externalId: \"cus_vq3UgXINHS99MIon8vNvAO1n\",\n    country: \"CA\",\n  },\n] as const;\n\nexport const E2E_FRAUD_PARTNER = {\n  id: \"pn_1K8ND11BZ4XPEX39QX3YMBGY0\",\n  email: \"kiran+e2e+1@dub.co\",\n  link: {\n    domain: \"getacme.link\",\n    key: \"kiran-e2e-1\",\n  },\n} as const;\n\nexport const E2E_FRAUD_REFERRAL_SOURCE_BANNED_DOMAIN =\n  \"test-hostname-for-referral-source-banned-do-not-delete.com\";",
            "cost": 0.08025
        }
    },
    "recover_status": "success",
    "instance_ref": {
        "instance_id": "dubinc__dub.main.3171",
        "repo": "dubinc/dub",
        "base_commit": "d126bfc73138f802e31d8f4a262cc32d683a3211",
        "head_commit": "241b62c6cd801c416e22783ed2b505cb9376f683",
        "title": "Fix the Fraud tests",
        "merged_at": "2025-11-28T20:19:27Z",
        "html_url": "https://github.com/dubinc/dub/pull/3171",
        "test_files": [
            "apps/web/tests/fraud/index.test.ts"
        ],
        "code_files": [
            "apps/web/lib/middleware/utils/get-identity-hash.ts",
            "apps/web/tests/utils/resource.ts"
        ],
        "total_changes": 58,
        "num_files": 3,
        "pull_number": 3171,
        "patch": "diff --git a/apps/web/lib/middleware/utils/get-identity-hash.ts b/apps/web/lib/middleware/utils/get-identity-hash.ts\nindex 4ef076bd688..4609fff0fdf 100644\n--- a/apps/web/lib/middleware/utils/get-identity-hash.ts\n+++ b/apps/web/lib/middleware/utils/get-identity-hash.ts\n@@ -1,24 +1,11 @@\n import { LOCALHOST_IP, hashStringSHA256 } from \"@dub/utils\";\n import { ipAddress } from \"@vercel/functions\";\n import { userAgent } from \"next/server\";\n-import { DUB_TEST_IDENTITY_HEADER } from \"tests/utils/resource\";\n \n /**\n  * Combine IP + UA to create a unique identifier for the user (for deduplication)\n  */\n export async function getIdentityHash(req: Request) {\n-  // If provided, use this identity directly (for E2E)\n-  if (\n-    process.env.NODE_ENV === \"development\" ||\n-    process.env.VERCEL_ENV === \"preview\"\n-  ) {\n-    const testOverride = req.headers.get(DUB_TEST_IDENTITY_HEADER);\n-\n-    if (testOverride) {\n-      return await hashStringSHA256(testOverride);\n-    }\n-  }\n-\n   const ip = ipAddress(req) || LOCALHOST_IP;\n   const ua = userAgent(req);\n   return await hashStringSHA256(`${ip}-${ua.ua}`);\ndiff --git a/apps/web/tests/fraud/index.test.ts b/apps/web/tests/fraud/index.test.ts\nindex e788eec903e..53b5aa38d47 100644\n--- a/apps/web/tests/fraud/index.test.ts\n+++ b/apps/web/tests/fraud/index.test.ts\n@@ -1,9 +1,8 @@\n import { Customer, fraudEventGroupProps, TrackLeadResponse } from \"@/lib/types\";\n import { FraudRuleType } from \"@prisma/client\";\n-import { randomCustomer, randomId, retry } from \"tests/utils/helpers\";\n+import { randomCustomer, retry } from \"tests/utils/helpers\";\n import { HttpClient } from \"tests/utils/http\";\n import {\n-  DUB_TEST_IDENTITY_HEADER,\n   E2E_FRAUD_PARTNER,\n   E2E_FRAUD_REFERRAL_SOURCE_BANNED_DOMAIN,\n   E2E_TRACK_CLICK_HEADERS,\n@@ -16,14 +15,13 @@ describe.concurrent(\"/fraud/**\", async () => {\n   const { http } = await h.init();\n \n   test(\"FraudRuleType = customerEmailMatch\", async () => {\n-    const clickLink = E2E_FRAUD_PARTNER.link;\n+    const clickLink = E2E_FRAUD_PARTNER.links.customerEmailMatch;\n \n     // Track a click\n     const clickResponse = await http.post<{ clickId: string }>({\n       path: \"/track/click\",\n       headers: {\n         ...E2E_TRACK_CLICK_HEADERS,\n-        [DUB_TEST_IDENTITY_HEADER]: randomId(10),\n       },\n       body: {\n         domain: clickLink.domain,\n@@ -59,14 +57,13 @@ describe.concurrent(\"/fraud/**\", async () => {\n   });\n \n   test(\"FraudRuleType = customerEmailSuspiciousDomain\", async () => {\n-    const clickLink = E2E_FRAUD_PARTNER.link;\n+    const clickLink = E2E_FRAUD_PARTNER.links.customerEmailSuspiciousDomain;\n \n     // Track a click\n     const clickResponse = await http.post<{ clickId: string }>({\n       path: \"/track/click\",\n       headers: {\n         ...E2E_TRACK_CLICK_HEADERS,\n-        [DUB_TEST_IDENTITY_HEADER]: randomId(10),\n       },\n       body: {\n         domain: clickLink.domain,\n@@ -99,7 +96,7 @@ describe.concurrent(\"/fraud/**\", async () => {\n   });\n \n   test(\"FraudRuleType = referralSourceBanned\", async () => {\n-    const clickLink = E2E_FRAUD_PARTNER.link;\n+    const clickLink = E2E_FRAUD_PARTNER.links.referralSourceBanned;\n \n     // Track a click\n     const clickResponse = await http.post<{ clickId: string }>({\n@@ -107,7 +104,6 @@ describe.concurrent(\"/fraud/**\", async () => {\n       headers: {\n         ...E2E_TRACK_CLICK_HEADERS,\n         referer: `https://${E2E_FRAUD_REFERRAL_SOURCE_BANNED_DOMAIN}`,\n-        [DUB_TEST_IDENTITY_HEADER]: randomId(10),\n       },\n       body: {\n         domain: clickLink.domain,\n@@ -140,14 +136,13 @@ describe.concurrent(\"/fraud/**\", async () => {\n   });\n \n   test(\"FraudRuleType = paidTrafficDetected\", async () => {\n-    const clickLink = E2E_FRAUD_PARTNER.link;\n+    const clickLink = E2E_FRAUD_PARTNER.links.paidTrafficDetected;\n \n     // Track a click\n     const clickResponse = await http.post<{ clickId: string }>({\n       path: \"/track/click\",\n       headers: {\n         ...E2E_TRACK_CLICK_HEADERS,\n-        [DUB_TEST_IDENTITY_HEADER]: randomId(10),\n       },\n       body: {\n         domain: clickLink.domain,\ndiff --git a/apps/web/tests/utils/resource.ts b/apps/web/tests/utils/resource.ts\nindex d942699cb5e..94685c462e2 100644\n--- a/apps/web/tests/utils/resource.ts\n+++ b/apps/web/tests/utils/resource.ts\n@@ -8,16 +8,6 @@ export const E2E_LINK = {\n   url: \"https://github.com/dubinc\",\n };\n \n-/**\n- * Used exclusively in E2E tests to override the computed identity hash.\n- * When this header is present, `getIdentityHash()` will use its value\n- * as the hash input instead of relying on the real IP/User-Agent.\n- *\n- * This prevents deduplication during automated tests where multiple\n- * requests originate from the same IP and UA.\n- */\n-export const DUB_TEST_IDENTITY_HEADER = \"x-dub-test-identity\";\n-\n export const E2E_TRACK_CLICK_HEADERS = {\n   referer: \"https://dub.co\",\n   \"User-Agent\":\n@@ -220,9 +210,23 @@ export const E2E_CUSTOMERS = [\n export const E2E_FRAUD_PARTNER = {\n   id: \"pn_1K8ND11BZ4XPEX39QX3YMBGY0\",\n   email: \"kiran+e2e+1@dub.co\",\n-  link: {\n-    domain: \"getacme.link\",\n-    key: \"kiran-e2e-1\",\n+  links: {\n+    customerEmailMatch: {\n+      domain: \"getacme.link\",\n+      key: \"fraud-customer-match\",\n+    },\n+    customerEmailSuspiciousDomain: {\n+      domain: \"getacme.link\",\n+      key: \"fraud-customer-suspicious\",\n+    },\n+    referralSourceBanned: {\n+      domain: \"getacme.link\",\n+      key: \"fraud-referral-source-banned\",\n+    },\n+    paidTrafficDetected: {\n+      domain: \"getacme.link\",\n+      key: \"fraud-paid-traffic\",\n+    },\n   },\n } as const;\n \n",
        "pr_mirror": "dubinc__dub.main"
    }
}