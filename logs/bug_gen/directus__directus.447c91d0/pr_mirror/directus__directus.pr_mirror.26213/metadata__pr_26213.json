{
    "cost": 0.257595,
    "rewrites": {
        "directus__directus.447c91d0/api/src/services/mail/index.ts": {
            "output": "import { useEnv } from '@directus/env';\nimport { InvalidPayloadError } from '@directus/errors';\nimport type { AbstractServiceOptions, Accountability, SchemaOverview } from '@directus/types';\nimport { isObject } from '@directus/utils';\nimport fse from 'fs-extra';\nimport type { Knex } from 'knex';\nimport { Liquid } from 'liquidjs';\nimport type { SendMailOptions, Transporter } from 'nodemailer';\nimport path from 'path';\nimport { fileURLToPath } from 'url';\nimport getDatabase from '../../database/index.js';\nimport emitter from '../../emitter.js';\nimport { useLogger } from '../../logger/index.js';\nimport getMailer from '../../mailer.js';\nimport { Url } from '../../utils/url.js';\nimport { useEmailRateLimiterQueue } from './rate-limiter.js';\n\nconst env = useEnv();\nconst logger = useLogger();\n\nconst __dirname = path.dirname(fileURLToPath(import.meta.url));\n\nconst liquidEngine = new Liquid({\n\troot: [path.resolve(env['EMAIL_TEMPLATES_PATH'] as string), path.resolve(__dirname, 'templates')],\n\textname: '.liquid',\n});\n\nexport type EmailOptions = SendMailOptions & {\n\ttemplate?: {\n\t\tname: string;\n\t\tdata: Record<string, any>;\n\t};\n};\n\nexport class MailService {\n\tschema: SchemaOverview;\n\taccountability: Accountability | null;\n\tknex: Knex;\n\tmailer: Transporter;\n\n\tconstructor(opts: AbstractServiceOptions) {\n\t\tthis.schema = opts.schema;\n\t\tthis.accountability = opts.accountability || null;\n\t\tthis.knex = opts?.knex || getDatabase();\n\t\tthis.mailer = getMailer();\n\n\t\tif (env['EMAIL_VERIFY_SETUP']) {\n\t\t\tthis.mailer.verify((error) => {\n\t\t\t\tif (error) {\n\t\t\t\t\tlogger.warn(`Email connection failed:`);\n\t\t\t\t\tlogger.warn(error);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t}\n\n\tasync send<T>(options: EmailOptions): Promise<T | null> {\n\t\tawait useEmailRateLimiterQueue();\n\n\t\tconst payload = await emitter.emitFilter(`email.send`, options, {});\n\n\t\tif (!payload) return null;\n\n\t\tconst { template, ...emailOptions } = payload;\n\n\t\tlet { html } = options;\n\n\t\tconst defaultTemplateData = await this.getDefaultTemplateData();\n\n\t\tif (isObject(emailOptions.from) && (!emailOptions.from.name || !emailOptions.from.address)) {\n\t\t\tthrow new InvalidPayloadError({ reason: 'A name and address property are required in the \"from\" object' });\n\t\t}\n\n\t\tconst from: SendMailOptions['from'] = isObject(emailOptions.from)\n\t\t\t? emailOptions.from\n\t\t\t: {\n\t\t\t\t\tname: defaultTemplateData.projectName,\n\t\t\t\t\taddress: (emailOptions.from as string) || (env['EMAIL_FROM'] as string),\n\t\t\t\t};\n\n\t\tif (template) {\n\t\t\tlet templateData = template.data;\n\n\t\t\ttemplateData = {\n\t\t\t\t...defaultTemplateData,\n\t\t\t\t...templateData,\n\t\t\t};\n\n\t\t\thtml = await this.renderTemplate(template.name, templateData);\n\t\t}\n\n\t\tif (typeof html === 'string') {\n\t\t\t// Some email clients start acting funky when line length exceeds 75 characters. See #6074\n\t\t\thtml = html\n\t\t\t\t.split('\\n')\n\t\t\t\t.map((line) => line.trim())\n\t\t\t\t.join('\\n');\n\t\t}\n\n\t\tconst info = await this.mailer.sendMail({ ...emailOptions, from, html });\n\t\treturn info;\n\t}\n\n\tprivate async renderTemplate(template: string, variables: Record<string, any>) {\n\t\tconst customTemplatePath = path.resolve(env['EMAIL_TEMPLATES_PATH'] as string, template + '.liquid');\n\t\tconst systemTemplatePath = path.join(__dirname, 'templates', template + '.liquid');\n\n\t\tconst templatePath = (await fse.pathExists(customTemplatePath)) ? customTemplatePath : systemTemplatePath;\n\n\t\tif ((await fse.pathExists(templatePath)) === false) {\n\t\t\tthrow new InvalidPayloadError({ reason: `Template \"${template}\" doesn't exist` });\n\t\t}\n\n\t\tconst templateString = await fse.readFile(templatePath, 'utf8');\n\t\tconst html = await liquidEngine.parseAndRender(templateString, variables);\n\n\t\treturn html;\n\t}\n\n\tprivate async getDefaultTemplateData() {\n\t\tconst projectInfo = await this.knex\n\t\t\t.select(['project_name', 'project_logo', 'project_color', 'project_url'])\n\t\t\t.from('directus_settings')\n\t\t\t.first();\n\n\t\treturn {\n\t\t\tprojectName: projectInfo?.project_name || 'Directus',\n\t\t\tprojectColor: projectInfo?.project_color || '#171717',\n\t\t\tprojectLogo: getProjectLogoURL(projectInfo?.project_logo),\n\t\t\tprojectUrl: projectInfo?.project_url || '',\n\t\t};\n\n\t\tfunction getProjectLogoURL(logoID?: string) {\n\t\t\tconst projectLogoUrl = new Url(env['PUBLIC_URL'] as string);\n\n\t\t\tif (logoID) {\n\t\t\t\tprojectLogoUrl.addPath('assets', logoID);\n\t\t\t} else {\n\t\t\t\tprojectLogoUrl.addPath('admin', 'img', 'directus-white.png');\n\t\t\t}\n\n\t\t\treturn projectLogoUrl.toString();\n\t\t}\n\t}\n}",
            "output_extracted": "import { useEnv } from '@directus/env';\nimport { InvalidPayloadError } from '@directus/errors';\nimport type { AbstractServiceOptions, Accountability, SchemaOverview } from '@directus/types';\nimport { isObject } from '@directus/utils';\nimport fse from 'fs-extra';\nimport type { Knex } from 'knex';\nimport { Liquid } from 'liquidjs';\nimport type { SendMailOptions, Transporter } from 'nodemailer';\nimport path from 'path';\nimport { fileURLToPath } from 'url';\nimport getDatabase from '../../database/index.js';\nimport emitter from '../../emitter.js';\nimport { useLogger } from '../../logger/index.js';\nimport getMailer from '../../mailer.js';\nimport { Url } from '../../utils/url.js';\nimport { useEmailRateLimiterQueue } from './rate-limiter.js';\n\nconst env = useEnv();\nconst logger = useLogger();\n\nconst __dirname = path.dirname(fileURLToPath(import.meta.url));\n\nconst liquidEngine = new Liquid({\n\troot: [path.resolve(env['EMAIL_TEMPLATES_PATH'] as string), path.resolve(__dirname, 'templates')],\n\textname: '.liquid',\n});\n\nexport type EmailOptions = SendMailOptions & {\n\ttemplate?: {\n\t\tname: string;\n\t\tdata: Record<string, any>;\n\t};\n};\n\nexport class MailService {\n\tschema: SchemaOverview;\n\taccountability: Accountability | null;\n\tknex: Knex;\n\tmailer: Transporter;\n\n\tconstructor(opts: AbstractServiceOptions) {\n\t\tthis.schema = opts.schema;\n\t\tthis.accountability = opts.accountability || null;\n\t\tthis.knex = opts?.knex || getDatabase();\n\t\tthis.mailer = getMailer();\n\n\t\tif (env['EMAIL_VERIFY_SETUP']) {\n\t\t\tthis.mailer.verify((error) => {\n\t\t\t\tif (error) {\n\t\t\t\t\tlogger.warn(`Email connection failed:`);\n\t\t\t\t\tlogger.warn(error);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t}\n\n\tasync send<T>(options: EmailOptions): Promise<T | null> {\n\t\tawait useEmailRateLimiterQueue();\n\n\t\tconst payload = await emitter.emitFilter(`email.send`, options, {});\n\n\t\tif (!payload) return null;\n\n\t\tconst { template, ...emailOptions } = payload;\n\n\t\tlet { html } = options;\n\n\t\tconst defaultTemplateData = await this.getDefaultTemplateData();\n\n\t\tif (isObject(emailOptions.from) && (!emailOptions.from.name || !emailOptions.from.address)) {\n\t\t\tthrow new InvalidPayloadError({ reason: 'A name and address property are required in the \"from\" object' });\n\t\t}\n\n\t\tconst from: SendMailOptions['from'] = isObject(emailOptions.from)\n\t\t\t? emailOptions.from\n\t\t\t: {\n\t\t\t\t\tname: defaultTemplateData.projectName,\n\t\t\t\t\taddress: (emailOptions.from as string) || (env['EMAIL_FROM'] as string),\n\t\t\t\t};\n\n\t\tif (template) {\n\t\t\tlet templateData = template.data;\n\n\t\t\ttemplateData = {\n\t\t\t\t...defaultTemplateData,\n\t\t\t\t...templateData,\n\t\t\t};\n\n\t\t\thtml = await this.renderTemplate(template.name, templateData);\n\t\t}\n\n\t\tif (typeof html === 'string') {\n\t\t\t// Some email clients start acting funky when line length exceeds 75 characters. See #6074\n\t\t\thtml = html\n\t\t\t\t.split('\\n')\n\t\t\t\t.map((line) => line.trim())\n\t\t\t\t.join('\\n');\n\t\t}\n\n\t\tconst info = await this.mailer.sendMail({ ...emailOptions, from, html });\n\t\treturn info;\n\t}\n\n\tprivate async renderTemplate(template: string, variables: Record<string, any>) {\n\t\tconst customTemplatePath = path.resolve(env['EMAIL_TEMPLATES_PATH'] as string, template + '.liquid');\n\t\tconst systemTemplatePath = path.join(__dirname, 'templates', template + '.liquid');\n\n\t\tconst templatePath = (await fse.pathExists(customTemplatePath)) ? customTemplatePath : systemTemplatePath;\n\n\t\tif ((await fse.pathExists(templatePath)) === false) {\n\t\t\tthrow new InvalidPayloadError({ reason: `Template \"${template}\" doesn't exist` });\n\t\t}\n\n\t\tconst templateString = await fse.readFile(templatePath, 'utf8');\n\t\tconst html = await liquidEngine.parseAndRender(templateString, variables);\n\n\t\treturn html;\n\t}\n\n\tprivate async getDefaultTemplateData() {\n\t\tconst projectInfo = await this.knex\n\t\t\t.select(['project_name', 'project_logo', 'project_color', 'project_url'])\n\t\t\t.from('directus_settings')\n\t\t\t.first();\n\n\t\treturn {\n\t\t\tprojectName: projectInfo?.project_name || 'Directus',\n\t\t\tprojectColor: projectInfo?.project_color || '#171717',\n\t\t\tprojectLogo: getProjectLogoURL(projectInfo?.project_logo),\n\t\t\tprojectUrl: projectInfo?.project_url || '',\n\t\t};\n\n\t\tfunction getProjectLogoURL(logoID?: string) {\n\t\t\tconst projectLogoUrl = new Url(env['PUBLIC_URL'] as string);\n\n\t\t\tif (logoID) {\n\t\t\t\tprojectLogoUrl.addPath('assets', logoID);\n\t\t\t} else {\n\t\t\t\tprojectLogoUrl.addPath('admin', 'img', 'directus-white.png');\n\t\t\t}\n\n\t\t\treturn projectLogoUrl.toString();\n\t\t}\n\t}\n}",
            "cost": 0.04773500000000001
        },
        "directus__directus.447c91d0/api/src/services/notifications.ts": {
            "output": "import { useEnv } from '@directus/env';\nimport type { AbstractServiceOptions, MutationOptions, Notification, PrimaryKey } from '@directus/types';\nimport { useLogger } from '../logger/index.js';\nimport { fetchRolesTree } from '../permissions/lib/fetch-roles-tree.js';\nimport { fetchGlobalAccess } from '../permissions/modules/fetch-global-access/fetch-global-access.js';\nimport { md } from '../utils/md.js';\nimport { Url } from '../utils/url.js';\nimport { ItemsService } from './items.js';\nimport { MailService } from './mail/index.js';\nimport { UsersService } from './users.js';\n\nconst env = useEnv();\nconst logger = useLogger();\n\nexport class NotificationsService extends ItemsService {\n\tconstructor(options: AbstractServiceOptions) {\n\t\tsuper('directus_notifications', options);\n\t}\n\n\toverride async createOne(data: Partial<Notification>, opts?: MutationOptions): Promise<PrimaryKey> {\n\t\tconst response = await super.createOne(data, opts);\n\n\t\tawait this.sendEmail(data);\n\n\t\treturn response;\n\t}\n\n\tasync sendEmail(data: Partial<Notification>) {\n\t\tif (data.recipient) {\n\t\t\tconst usersService = new UsersService({ schema: this.schema, knex: this.knex });\n\n\t\t\tconst user = await usersService.readOne(data.recipient, {\n\t\t\t\tfields: ['id', 'email', 'email_notifications', 'role'],\n\t\t\t});\n\n\t\t\tif (user['email'] && user['email_notifications'] === true) {\n\t\t\t\tconst manageUserAccountUrl = new Url(env['PUBLIC_URL'] as string)\n\t\t\t\t\t.addPath('admin', 'users', user['id'])\n\t\t\t\t\t.toString();\n\n\t\t\t\tconst html = data.message ? md(data.message) : '';\n\t\t\t\tconst roles = await fetchRolesTree(user['role'], { knex: this.knex });\n\n\t\t\t\tconst { app: app_access } = await fetchGlobalAccess(\n\t\t\t\t\t{\n\t\t\t\t\t\tuser: user['id'],\n\t\t\t\t\t\troles,\n\t\t\t\t\t\tip: null,\n\t\t\t\t\t},\n\t\t\t\t\t{ knex: this.knex },\n\t\t\t\t);\n\n\t\t\t\tconst mailService = new MailService({\n\t\t\t\t\tschema: this.schema,\n\t\t\t\t\tknex: this.knex,\n\t\t\t\t\taccountability: this.accountability,\n\t\t\t\t});\n\n\t\t\t\tmailService\n\t\t\t\t\t.send({\n\t\t\t\t\t\ttemplate: {\n\t\t\t\t\t\t\tname: 'base',\n\t\t\t\t\t\t\tdata: app_access ? { url: manageUserAccountUrl, html } : { html },\n\t\t\t\t\t\t},\n\t\t\t\t\t\tto: user['email'],\n\t\t\t\t\t\tsubject: data.subject,\n\t\t\t\t\t})\n\t\t\t\t\t.catch((error) => {\n\t\t\t\t\t\tlogger.error(error, `Could not send notification via mail`);\n\t\t\t\t\t});\n\t\t\t}\n\t\t}\n\t}\n}",
            "output_extracted": "import { useEnv } from '@directus/env';\nimport type { AbstractServiceOptions, MutationOptions, Notification, PrimaryKey } from '@directus/types';\nimport { useLogger } from '../logger/index.js';\nimport { fetchRolesTree } from '../permissions/lib/fetch-roles-tree.js';\nimport { fetchGlobalAccess } from '../permissions/modules/fetch-global-access/fetch-global-access.js';\nimport { md } from '../utils/md.js';\nimport { Url } from '../utils/url.js';\nimport { ItemsService } from './items.js';\nimport { MailService } from './mail/index.js';\nimport { UsersService } from './users.js';\n\nconst env = useEnv();\nconst logger = useLogger();\n\nexport class NotificationsService extends ItemsService {\n\tconstructor(options: AbstractServiceOptions) {\n\t\tsuper('directus_notifications', options);\n\t}\n\n\toverride async createOne(data: Partial<Notification>, opts?: MutationOptions): Promise<PrimaryKey> {\n\t\tconst response = await super.createOne(data, opts);\n\n\t\tawait this.sendEmail(data);\n\n\t\treturn response;\n\t}\n\n\tasync sendEmail(data: Partial<Notification>) {\n\t\tif (data.recipient) {\n\t\t\tconst usersService = new UsersService({ schema: this.schema, knex: this.knex });\n\n\t\t\tconst user = await usersService.readOne(data.recipient, {\n\t\t\t\tfields: ['id', 'email', 'email_notifications', 'role'],\n\t\t\t});\n\n\t\t\tif (user['email'] && user['email_notifications'] === true) {\n\t\t\t\tconst manageUserAccountUrl = new Url(env['PUBLIC_URL'] as string)\n\t\t\t\t\t.addPath('admin', 'users', user['id'])\n\t\t\t\t\t.toString();\n\n\t\t\t\tconst html = data.message ? md(data.message) : '';\n\t\t\t\tconst roles = await fetchRolesTree(user['role'], { knex: this.knex });\n\n\t\t\t\tconst { app: app_access } = await fetchGlobalAccess(\n\t\t\t\t\t{\n\t\t\t\t\t\tuser: user['id'],\n\t\t\t\t\t\troles,\n\t\t\t\t\t\tip: null,\n\t\t\t\t\t},\n\t\t\t\t\t{ knex: this.knex },\n\t\t\t\t);\n\n\t\t\t\tconst mailService = new MailService({\n\t\t\t\t\tschema: this.schema,\n\t\t\t\t\tknex: this.knex,\n\t\t\t\t\taccountability: this.accountability,\n\t\t\t\t});\n\n\t\t\t\tmailService\n\t\t\t\t\t.send({\n\t\t\t\t\t\ttemplate: {\n\t\t\t\t\t\t\tname: 'base',\n\t\t\t\t\t\t\tdata: app_access ? { url: manageUserAccountUrl, html } : { html },\n\t\t\t\t\t\t},\n\t\t\t\t\t\tto: user['email'],\n\t\t\t\t\t\tsubject: data.subject,\n\t\t\t\t\t})\n\t\t\t\t\t.catch((error) => {\n\t\t\t\t\t\tlogger.error(error, `Could not send notification via mail`);\n\t\t\t\t\t});\n\t\t\t}\n\t\t}\n\t}\n}",
            "cost": 0.02602
        },
        "directus__directus.447c91d0/tests/blackbox/common/config.ts": {
            "output": "import { Knex } from 'knex';\nimport { dirname, join } from 'node:path';\nimport { fileURLToPath } from 'node:url';\nimport { allVendors, type Vendor } from './get-dbs-to-test';\n\nconst __dirname = dirname(fileURLToPath(import.meta.url));\n\nexport type Env = Record<\n\tVendor,\n\t{\n\t\tDB_CLIENT: string;\n\t\tPORT: string;\n\t\t[key: string]: string;\n\t}\n>;\nexport type Config = {\n\tknexConfig: Record<Vendor, Knex.Config & { waitTestSQL: string }>;\n\tnames: Record<Vendor, string>;\n\tenvs: Env;\n};\n\nexport const paths = {\n\tcli: join(__dirname, '..', '..', '..', 'dist', 'cli'),\n\tcwd: join(__dirname, '..'),\n};\n\nconst migrationsDir = './setup/migrations';\nconst seedsDir = './setup/seeds';\n\nconst knexConfig = {\n\twaitTestSQL: 'SELECT 1',\n\tmigrations: {\n\t\tdirectory: migrationsDir,\n\t},\n\tseeds: {\n\t\tdirectory: seedsDir,\n\t},\n};\n\nconst allowedLogLevels = ['trace', 'debug', 'info', 'warn', 'error', 'fatal'];\n\nlet logLevel = 'error';\n\nif (process.env['TEST_SAVE_LOGS']) {\n\tlogLevel = allowedLogLevels.includes(process.env['TEST_SAVE_LOGS']) ? process.env['TEST_SAVE_LOGS'] : 'info';\n}\n\nconst directusAuthConfig = {\n\tAUTH_PROVIDERS: 'saml',\n\tAUTH_SAML_DRIVER: 'saml',\n\tAUTH_SAML_ALLOW_PUBLIC_REGISTRATION: 'true',\n\tAUTH_SAML_SP_metadata:\n\t\t'<md:EntityDescriptor xmlns:md=\"urn:oasis:names:tc:SAML:2.0:metadata\" xmlns:saml=\"urn:oasis:names:tc:SAML:2.0:assertion\" xmlns:ds=\"http://www.w3.org/2000/09/xmldsig#\" entityID=\"saml-test\"><md:SPSSODescriptor WantAssertionsSigned=\"true\" protocolSupportEnumeration=\"urn:oasis:names:tc:SAML:2.0:protocol\"><md:KeyDescriptor use=\"signing\"><ds:KeyInfo xmlns:ds=\"http://www.w3.org/2000/09/xmldsig#\"><ds:X509Data><ds:X509Certificate>MIIDDTCCAfWgAwIBAgIJQC7RaeKX30qDMA0GCSqGSIb3DQEBCwUAMCQxIjAgBgNVBAMTGWRldi1md3h5bWRvMC51cy5hdXRoMC5jb20wHhcNMjIwODE5MjA1OTEwWhcNMzYwNDI3MjA1OTEwWjAkMSIwIAYDVQQDExlkZXYtZnd4eW1kbzAudXMuYXV0aDAuY29tMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA0TN0Doc8qop69i0bgGuynPQpJRat17xlsbphSWCnACc6DYbFBQ3n+cft8AiTzI7VISLazwlWOp30zhTMwZlrXMo1flG9qJl/2T+BLohRMw0ScCQk8Aq1cWRzZLb4Oku6PdefHrpsg6Wjn87m6R2Yrhmz33Vq2QYRwNsKhWRhhB2ajpMj8GsvFKG0FGPD/AJ1bGXcdsMOaQZxIiZ3Xcy9Ng8jAHvE12sIH8w14pmIidO15XFjlvtpNTxSl0qV0lmzKM0nN4EqlK0vTy4NwFk3xR/UmgQo5tYzqvRBqfzRO7vpOwbp1SWQ/c8JlI1ulLzt1uJzfvWsp8MSD/QRhxg93QIDAQABo0IwQDAPBgNVHRMBAf8EBTADAQH/MB0GA1UdDgQWBBT60jtXFsHPoyL42prgUG7wQTaWcTAOBgNVHQ8BAf8EBAMCAoQwDQYJKoZIhvcNAQELBQADggEBAKFLvyUbywoLYLOtsgHv9S2qingx2Q2jmYChqj4CQxPaWRpS/qBaZXnjVETZrMFDjf8HyMf2qn9uwKvtJehfPXpG8D+VuZWfsriTn94pXuELbiekHZ0Qlo1acbjUwyIeKoMNMk7wjGe8qb4gar6noT6PvAbyv1uzzkdyIUmQDzSS/ZOdRW0cwHG6oD/PdzKOPZxUZtQcq23Y/hbK/JpDiKtt1oO/svpd6tMmi6VezVB47gvUqEKMB3B5PI2Rdn+lA9tFPY2tfZtzOPaT5YQJkpp7tAWdMaUir+M8BhY8EjgtK1ZhJ7h2pW+UuOwkNsikgbf9EoUvDDZak65rXNqCCpQ=</ds:X509Certificate></ds:X509Data></ds:KeyInfo></md:KeyDescriptor><md:NameIDFormat>urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress</md:NameIDFormat><md:AssertionConsumerService isDefault=\"true\" index=\"0\" Binding=\"urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST\" Location=\"http://host.docker.internal:8055/auth/login/saml/acs\" /></md:SPSSODescriptor></md:EntityDescriptor>',\n\tAUTH_SAML_IDP_metadata:\n\t\t'<md:EntityDescriptor xmlns:md=\"urn:oasis:names:tc:SAML:2.0:metadata\" xmlns:ds=\"http://www.w3.org/2000/09/xmldsig#\" entityID=\"http://127.0.0.1:8880/simplesaml/saml2/idp/metadata.php\"><md:IDPSSODescriptor protocolSupportEnumeration=\"urn:oasis:names:tc:SAML:2.0:protocol\"><md:KeyDescriptor use=\"signing\"><ds:KeyInfo xmlns:ds=\"http://www.w3.org/2000/09/xmldsig#\"><ds:X509Data><ds:X509Certificate>MIIDXTCCAkWgAwIBAgIJALmVVuDWu4NYMA0GCSqGSIb3DQEBCwUAMEUxCzAJBgNVBAYTAkFVMRMwEQYDVQQIDApTb21lLVN0YXRlMSEwHwYDVQQKDBhJbnRlcm5ldCBXaWRnaXRzIFB0eSBMdGQwHhcNMTYxMjMxMTQzNDQ3WhcNNDgwNjI1MTQzNDQ3WjBFMQswCQYDVQQGEwJBVTETMBEGA1UECAwKU29tZS1TdGF0ZTEhMB8GA1UECgwYSW50ZXJuZXQgV2lkZ2l0cyBQdHkgTHRkMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAzUCFozgNb1h1M0jzNRSCjhOBnR+uVbVpaWfXYIR+AhWDdEe5ryY+CgavOg8bfLybyzFdehlYdDRgkedEB/GjG8aJw06l0qF4jDOAw0kEygWCu2mcH7XOxRt+YAH3TVHa/Hu1W3WjzkobqqqLQ8gkKWWM27fOgAZ6GieaJBN6VBSMMcPey3HWLBmc+TYJmv1dbaO2jHhKh8pfKw0W12VM8P1PIO8gv4Phu/uuJYieBWKixBEyy0lHjyixYFCR12xdh4CA47q958ZRGnnDUGFVE1QhgRacJCOZ9bd5t9mr8KLaVBYTCJo5ERE8jymab5dPqe5qKfJsCZiqWglbjUo9twIDAQABo1AwTjAdBgNVHQ4EFgQUxpuwcs/CYQOyui+r1G+3KxBNhxkwHwYDVR0jBBgwFoAUxpuwcs/CYQOyui+r1G+3KxBNhxkwDAYDVR0TBAUwAwEB/zANBgkqhkiG9w0BAQsFAAOCAQEAAiWUKs/2x/viNCKi3Y6blEuCtAGhzOOZ9EjrvJ8+COH3Rag3tVBWrcBZ3/uhhPq5gy9lqw4OkvEws99/5jFsX1FJ6MKBgqfuy7yh5s1YfM0ANHYczMmYpZeAcQf2CGAaVfwTTfSlzNLsF2lW/ly7yapFzlYSJLGoVE+OHEu8g5SlNACUEfkXw+5Eghh+KzlIN7R6Q7r2ixWNFBC/jWf7NKUfJyX8qIG5md1YUeT6GBW9Bm2/1/RiO24JTaYlfLdKK9TYb8sG5B+OLab2DImG99CJ25RkAcSobWNF5zD0O6lgOo3cEdB/ksCq3hmtlC/DlLZ/D8CJ+7VuZnS1rR2naQ==</ds:X509Certificate></ds:X509Data></ds:KeyInfo></md:KeyDescriptor><md:SingleLogoutService Binding=\"urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect\" Location=\"http://127.0.0.1:8880/simplesaml/saml2/idp/SingleLogoutService.php\" /><md:NameIDFormat>urn:oasis:names:tc:SAML:2.0:nameid-format:transient</md:NameIDFormat><md:SingleSignOnService Binding=\"urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect\" Location=\"http://127.0.0.1:8880/simplesaml/saml2/idp/SSOService.php\" /></md:IDPSSODescriptor></md:EntityDescriptor>',\n\tAUTH_SAML_DEFAULT_ROLE_ID: 'd70c0943-5b55-4c5d-a613-f539a27a57f5',\n\tAUTH_SAML_IDENTIFIER_KEY: 'uid',\n\tAUTH_SAML_EMAIL_KEY: 'email',\n};\n\nconst directusStorageConfig = {\n\tSTORAGE_LOCATIONS: 'local,minio',\n\tSTORAGE_MINIO_DRIVER: 's3',\n\tSTORAGE_MINIO_KEY: 'directus',\n\tSTORAGE_MINIO_SECRET: 'miniosecret',\n\tSTORAGE_MINIO_BUCKET: 'directus-blackbox-test',\n\tSTORAGE_MINIO_REGION: 'us-east-1',\n\tSTORAGE_MINIO_ENDPOINT: 'http://127.0.0.1:8881',\n\tSTORAGE_MINIO_FORCE_PATH_STYLE: 'true',\n};\n\nconst directusConfig = {\n\t...process.env,\n\tADMIN_EMAIL: 'admin@example.com',\n\tADMIN_PASSWORD: 'password',\n\tSECRET: 'directus-test',\n\tTELEMETRY: 'false',\n\tCACHE_SCHEMA: 'true',\n\tCACHE_SCHEMA_MAX_ITERATIONS: '100',\n\tCACHE_ENABLED: 'false',\n\tRATE_LIMITER_ENABLED: 'false',\n\tPRESSURE_LIMITER_ENABLED: 'false',\n\tLOG_LEVEL: logLevel,\n\tSERVE_APP: 'false',\n\tDB_EXCLUDE_TABLES: 'knex_migrations,knex_migrations_lock,spatial_ref_sys,sysdiagrams',\n\tMAX_RELATIONAL_DEPTH: '5',\n\tMAX_PAYLOAD_SIZE: '10mb',\n\tEXTENSIONS_PATH: './extensions',\n\tASSETS_TRANSFORM_MAX_CONCURRENT: '2',\n\tMAX_BATCH_MUTATION: '100', // Must be in multiples of 10 for tests\n\tQUERY_LIMIT_DEFAULT: '90', // Must be less than MAX_BATCH_MUTATION by at least 3\n\tACCESS_TOKEN_TTL: '25d', // should be larger than 24.86 days to test Expires value larger than 32-bit signed integer\n\tWEBSOCKETS_ENABLED: 'true',\n\tTUS_ENABLED: 'true',\n\t...directusAuthConfig,\n\t...directusStorageConfig,\n};\n\nconst config: Config = {\n\tknexConfig: {\n\t\tpostgres: {\n\t\t\tclient: 'pg',\n\t\t\tconnection: {\n\t\t\t\tdatabase: 'directus',\n\t\t\t\tuser: 'postgres',\n\t\t\t\tpassword: 'secret',\n\t\t\t\thost: '127.0.0.1',\n\t\t\t\tport: 6100,\n\t\t\t},\n\t\t\t...knexConfig,\n\t\t},\n\t\tpostgres10: {\n\t\t\tclient: 'pg',\n\t\t\tconnection: {\n\t\t\t\tdatabase: 'directus',\n\t\t\t\tuser: 'postgres',\n\t\t\t\tpassword: 'secret',\n\t\t\t\thost: '127.0.0.1',\n\t\t\t\tport: 6101,\n\t\t\t},\n\t\t\t...knexConfig,\n\t\t},\n\t\tmysql: {\n\t\t\tclient: 'mysql2',\n\t\t\tconnection: {\n\t\t\t\tdatabase: 'directus',\n\t\t\t\tuser: 'root',\n\t\t\t\tpassword: 'secret',\n\t\t\t\thost: '127.0.0.1',\n\t\t\t\tport: 6102,\n\t\t\t},\n\t\t\t...knexConfig,\n\t\t},\n\t\tmysql5: {\n\t\t\tclient: 'mysql2',\n\t\t\tconnection: {\n\t\t\t\tdatabase: 'directus',\n\t\t\t\tuser: 'root',\n\t\t\t\tpassword: 'secret',\n\t\t\t\thost: '127.0.0.1',\n\t\t\t\tport: 6103,\n\t\t\t},\n\t\t\t...knexConfig",
            "output_extracted": "import { Knex } from 'knex';\nimport { dirname, join } from 'node:path';\nimport { fileURLToPath } from 'node:url';\nimport { allVendors, type Vendor } from './get-dbs-to-test';\n\nconst __dirname = dirname(fileURLToPath(import.meta.url));\n\nexport type Env = Record<\n\tVendor,\n\t{\n\t\tDB_CLIENT: string;\n\t\tPORT: string;\n\t\t[key: string]: string;\n\t}\n>;\nexport type Config = {\n\tknexConfig: Record<Vendor, Knex.Config & { waitTestSQL: string }>;\n\tnames: Record<Vendor, string>;\n\tenvs: Env;\n};\n\nexport const paths = {\n\tcli: join(__dirname, '..', '..', '..', 'dist', 'cli'),\n\tcwd: join(__dirname, '..'),\n};\n\nconst migrationsDir = './setup/migrations';\nconst seedsDir = './setup/seeds';\n\nconst knexConfig = {\n\twaitTestSQL: 'SELECT 1',\n\tmigrations: {\n\t\tdirectory: migrationsDir,\n\t},\n\tseeds: {\n\t\tdirectory: seedsDir,\n\t},\n};\n\nconst allowedLogLevels = ['trace', 'debug', 'info', 'warn', 'error', 'fatal'];\n\nlet logLevel = 'error';\n\nif (process.env['TEST_SAVE_LOGS']) {\n\tlogLevel = allowedLogLevels.includes(process.env['TEST_SAVE_LOGS']) ? process.env['TEST_SAVE_LOGS'] : 'info';\n}\n\nconst directusAuthConfig = {\n\tAUTH_PROVIDERS: 'saml',\n\tAUTH_SAML_DRIVER: 'saml',\n\tAUTH_SAML_ALLOW_PUBLIC_REGISTRATION: 'true',\n\tAUTH_SAML_SP_metadata:\n\t\t'<md:EntityDescriptor xmlns:md=\"urn:oasis:names:tc:SAML:2.0:metadata\" xmlns:saml=\"urn:oasis:names:tc:SAML:2.0:assertion\" xmlns:ds=\"http://www.w3.org/2000/09/xmldsig#\" entityID=\"saml-test\"><md:SPSSODescriptor WantAssertionsSigned=\"true\" protocolSupportEnumeration=\"urn:oasis:names:tc:SAML:2.0:protocol\"><md:KeyDescriptor use=\"signing\"><ds:KeyInfo xmlns:ds=\"http://www.w3.org/2000/09/xmldsig#\"><ds:X509Data><ds:X509Certificate>MIIDDTCCAfWgAwIBAgIJQC7RaeKX30qDMA0GCSqGSIb3DQEBCwUAMCQxIjAgBgNVBAMTGWRldi1md3h5bWRvMC51cy5hdXRoMC5jb20wHhcNMjIwODE5MjA1OTEwWhcNMzYwNDI3MjA1OTEwWjAkMSIwIAYDVQQDExlkZXYtZnd4eW1kbzAudXMuYXV0aDAuY29tMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA0TN0Doc8qop69i0bgGuynPQpJRat17xlsbphSWCnACc6DYbFBQ3n+cft8AiTzI7VISLazwlWOp30zhTMwZlrXMo1flG9qJl/2T+BLohRMw0ScCQk8Aq1cWRzZLb4Oku6PdefHrpsg6Wjn87m6R2Yrhmz33Vq2QYRwNsKhWRhhB2ajpMj8GsvFKG0FGPD/AJ1bGXcdsMOaQZxIiZ3Xcy9Ng8jAHvE12sIH8w14pmIidO15XFjlvtpNTxSl0qV0lmzKM0nN4EqlK0vTy4NwFk3xR/UmgQo5tYzqvRBqfzRO7vpOwbp1SWQ/c8JlI1ulLzt1uJzfvWsp8MSD/QRhxg93QIDAQABo0IwQDAPBgNVHRMBAf8EBTADAQH/MB0GA1UdDgQWBBT60jtXFsHPoyL42prgUG7wQTaWcTAOBgNVHQ8BAf8EBAMCAoQwDQYJKoZIhvcNAQELBQADggEBAKFLvyUbywoLYLOtsgHv9S2qingx2Q2jmYChqj4CQxPaWRpS/qBaZXnjVETZrMFDjf8HyMf2qn9uwKvtJehfPXpG8D+VuZWfsriTn94pXuELbiekHZ0Qlo1acbjUwyIeKoMNMk7wjGe8qb4gar6noT6PvAbyv1uzzkdyIUmQDzSS/ZOdRW0cwHG6oD/PdzKOPZxUZtQcq23Y/hbK/JpDiKtt1oO/svpd6tMmi6VezVB47gvUqEKMB3B5PI2Rdn+lA9tFPY2tfZtzOPaT5YQJkpp7tAWdMaUir+M8BhY8EjgtK1ZhJ7h2pW+UuOwkNsikgbf9EoUvDDZak65rXNqCCpQ=</ds:X509Certificate></ds:X509Data></ds:KeyInfo></md:KeyDescriptor><md:NameIDFormat>urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress</md:NameIDFormat><md:AssertionConsumerService isDefault=\"true\" index=\"0\" Binding=\"urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST\" Location=\"http://host.docker.internal:8055/auth/login/saml/acs\" /></md:SPSSODescriptor></md:EntityDescriptor>',\n\tAUTH_SAML_IDP_metadata:\n\t\t'<md:EntityDescriptor xmlns:md=\"urn:oasis:names:tc:SAML:2.0:metadata\" xmlns:ds=\"http://www.w3.org/2000/09/xmldsig#\" entityID=\"http://127.0.0.1:8880/simplesaml/saml2/idp/metadata.php\"><md:IDPSSODescriptor protocolSupportEnumeration=\"urn:oasis:names:tc:SAML:2.0:protocol\"><md:KeyDescriptor use=\"signing\"><ds:KeyInfo xmlns:ds=\"http://www.w3.org/2000/09/xmldsig#\"><ds:X509Data><ds:X509Certificate>MIIDXTCCAkWgAwIBAgIJALmVVuDWu4NYMA0GCSqGSIb3DQEBCwUAMEUxCzAJBgNVBAYTAkFVMRMwEQYDVQQIDApTb21lLVN0YXRlMSEwHwYDVQQKDBhJbnRlcm5ldCBXaWRnaXRzIFB0eSBMdGQwHhcNMTYxMjMxMTQzNDQ3WhcNNDgwNjI1MTQzNDQ3WjBFMQswCQYDVQQGEwJBVTETMBEGA1UECAwKU29tZS1TdGF0ZTEhMB8GA1UECgwYSW50ZXJuZXQgV2lkZ2l0cyBQdHkgTHRkMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAzUCFozgNb1h1M0jzNRSCjhOBnR+uVbVpaWfXYIR+AhWDdEe5ryY+CgavOg8bfLybyzFdehlYdDRgkedEB/GjG8aJw06l0qF4jDOAw0kEygWCu2mcH7XOxRt+YAH3TVHa/Hu1W3WjzkobqqqLQ8gkKWWM27fOgAZ6GieaJBN6VBSMMcPey3HWLBmc+TYJmv1dbaO2jHhKh8pfKw0W12VM8P1PIO8gv4Phu/uuJYieBWKixBEyy0lHjyixYFCR12xdh4CA47q958ZRGnnDUGFVE1QhgRacJCOZ9bd5t9mr8KLaVBYTCJo5ERE8jymab5dPqe5qKfJsCZiqWglbjUo9twIDAQABo1AwTjAdBgNVHQ4EFgQUxpuwcs/CYQOyui+r1G+3KxBNhxkwHwYDVR0jBBgwFoAUxpuwcs/CYQOyui+r1G+3KxBNhxkwDAYDVR0TBAUwAwEB/zANBgkqhkiG9w0BAQsFAAOCAQEAAiWUKs/2x/viNCKi3Y6blEuCtAGhzOOZ9EjrvJ8+COH3Rag3tVBWrcBZ3/uhhPq5gy9lqw4OkvEws99/5jFsX1FJ6MKBgqfuy7yh5s1YfM0ANHYczMmYpZeAcQf2CGAaVfwTTfSlzNLsF2lW/ly7yapFzlYSJLGoVE+OHEu8g5SlNACUEfkXw+5Eghh+KzlIN7R6Q7r2ixWNFBC/jWf7NKUfJyX8qIG5md1YUeT6GBW9Bm2/1/RiO24JTaYlfLdKK9TYb8sG5B+OLab2DImG99CJ25RkAcSobWNF5zD0O6lgOo3cEdB/ksCq3hmtlC/DlLZ/D8CJ+7VuZnS1rR2naQ==</ds:X509Certificate></ds:X509Data></ds:KeyInfo></md:KeyDescriptor><md:SingleLogoutService Binding=\"urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect\" Location=\"http://127.0.0.1:8880/simplesaml/saml2/idp/SingleLogoutService.php\" /><md:NameIDFormat>urn:oasis:names:tc:SAML:2.0:nameid-format:transient</md:NameIDFormat><md:SingleSignOnService Binding=\"urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect\" Location=\"http://127.0.0.1:8880/simplesaml/saml2/idp/SSOService.php\" /></md:IDPSSODescriptor></md:EntityDescriptor>',\n\tAUTH_SAML_DEFAULT_ROLE_ID: 'd70c0943-5b55-4c5d-a613-f539a27a57f5',\n\tAUTH_SAML_IDENTIFIER_KEY: 'uid',\n\tAUTH_SAML_EMAIL_KEY: 'email',\n};\n\nconst directusStorageConfig = {\n\tSTORAGE_LOCATIONS: 'local,minio',\n\tSTORAGE_MINIO_DRIVER: 's3',\n\tSTORAGE_MINIO_KEY: 'directus',\n\tSTORAGE_MINIO_SECRET: 'miniosecret',\n\tSTORAGE_MINIO_BUCKET: 'directus-blackbox-test',\n\tSTORAGE_MINIO_REGION: 'us-east-1',\n\tSTORAGE_MINIO_ENDPOINT: 'http://127.0.0.1:8881',\n\tSTORAGE_MINIO_FORCE_PATH_STYLE: 'true',\n};\n\nconst directusConfig = {\n\t...process.env,\n\tADMIN_EMAIL: 'admin@example.com',\n\tADMIN_PASSWORD: 'password',\n\tSECRET: 'directus-test',\n\tTELEMETRY: 'false',\n\tCACHE_SCHEMA: 'true',\n\tCACHE_SCHEMA_MAX_ITERATIONS: '100',\n\tCACHE_ENABLED: 'false',\n\tRATE_LIMITER_ENABLED: 'false',\n\tPRESSURE_LIMITER_ENABLED: 'false',\n\tLOG_LEVEL: logLevel,\n\tSERVE_APP: 'false',\n\tDB_EXCLUDE_TABLES: 'knex_migrations,knex_migrations_lock,spatial_ref_sys,sysdiagrams',\n\tMAX_RELATIONAL_DEPTH: '5',\n\tMAX_PAYLOAD_SIZE: '10mb',\n\tEXTENSIONS_PATH: './extensions',\n\tASSETS_TRANSFORM_MAX_CONCURRENT: '2',\n\tMAX_BATCH_MUTATION: '100', // Must be in multiples of 10 for tests\n\tQUERY_LIMIT_DEFAULT: '90', // Must be less than MAX_BATCH_MUTATION by at least 3\n\tACCESS_TOKEN_TTL: '25d', // should be larger than 24.86 days to test Expires value larger than 32-bit signed integer\n\tWEBSOCKETS_ENABLED: 'true',\n\tTUS_ENABLED: 'true',\n\t...directusAuthConfig,\n\t...directusStorageConfig,\n};\n\nconst config: Config = {\n\tknexConfig: {\n\t\tpostgres: {\n\t\t\tclient: 'pg',\n\t\t\tconnection: {\n\t\t\t\tdatabase: 'directus',\n\t\t\t\tuser: 'postgres',\n\t\t\t\tpassword: 'secret',\n\t\t\t\thost: '127.0.0.1',\n\t\t\t\tport: 6100,\n\t\t\t},\n\t\t\t...knexConfig,\n\t\t},\n\t\tpostgres10: {\n\t\t\tclient: 'pg',\n\t\t\tconnection: {\n\t\t\t\tdatabase: 'directus',\n\t\t\t\tuser: 'postgres',\n\t\t\t\tpassword: 'secret',\n\t\t\t\thost: '127.0.0.1',\n\t\t\t\tport: 6101,\n\t\t\t},\n\t\t\t...knexConfig,\n\t\t},\n\t\tmysql: {\n\t\t\tclient: 'mysql2',\n\t\t\tconnection: {\n\t\t\t\tdatabase: 'directus',\n\t\t\t\tuser: 'root',\n\t\t\t\tpassword: 'secret',\n\t\t\t\thost: '127.0.0.1',\n\t\t\t\tport: 6102,\n\t\t\t},\n\t\t\t...knexConfig,\n\t\t},\n\t\tmysql5: {\n\t\t\tclient: 'mysql2',\n\t\t\tconnection: {\n\t\t\t\tdatabase: 'directus',\n\t\t\t\tuser: 'root',\n\t\t\t\tpassword: 'secret',\n\t\t\t\thost: '127.0.0.1',\n\t\t\t\tport: 6103,\n\t\t\t},\n\t\t\t...knexConfig",
            "cost": 0.13596
        },
        "directus__directus.447c91d0/tests/blackbox/setup/sequential-tests.ts": {
            "output": "// Tests will run sequentially according to this list\nexport const sequentialTestsList: Record<'db' | 'common', SequentialTestsList> = {\n\tcommon: {\n\t\tbefore: ['/common/common.test.ts'],\n\t\tafter: [],\n\t\t// If specified, only run these tests sequentially\n\t\tonly: [\n\t\t\t// '/common/common.test.ts',\n\t\t],\n\t},\n\tdb: {\n\t\tbefore: [\n\t\t\t'/tests/db/seed-database.test.ts',\n\t\t\t'/common/common.test.ts',\n\t\t\t'/tests/db/routes/schema/schema.test.ts',\n\t\t\t'/tests/db/routes/collections/crud.test.ts',\n\t\t\t'/tests/db/routes/fields/change-fields.test.ts',\n\t\t\t'/tests/db/routes/fields/crud.test.ts',\n\t\t],\n\t\tafter: [\n\t\t\t'/tests/db/schema/timezone/timezone.test.ts',\n\t\t\t'/tests/db/schema/timezone/timezone-changed-node-tz-america.test.ts',\n\t\t\t'/tests/db/schema/timezone/timezone-changed-node-tz-asia.test.ts',\n\t\t\t'/tests/db/websocket/auth.test.ts',\n\t\t\t'/tests/db/websocket/general.test.ts',\n\t\t\t'/tests/db/routes/permissions/cache-purge.test.ts',\n\t\t\t'/tests/db/routes/flows/webhook.test.ts',\n\t\t\t'/tests/db/app/cache.test.ts',\n\t\t\t'/tests/db/routes/collections/schema-cache.test.ts',\n\t\t],\n\t\t// If specified, only run these tests sequentially\n\t\tonly: [\n\t\t\t// '/tests/db/seed-database.test.ts',\n\t\t\t// '/common/common.test.ts',\n\t\t],\n\t},\n};\n\nexport function getReversedTestIndex(testFilePath: string, project: 'db' | 'common') {\n\tconst list = sequentialTestsList[project];\n\n\tif (list.only.length > 0) {\n\t\tfor (let index = 0; index < list.only.length; index++) {\n\t\t\tconst onlyTest = list.only[index];\n\n\t\t\tif (onlyTest && testFilePath.includes(onlyTest)) {\n\t\t\t\treturn index;\n\t\t\t}\n\t\t}\n\t}\n\n\tfor (let index = 0; index < list.before.length; index++) {\n\t\tconst beforeTest = list.before[index];\n\n\t\tif (beforeTest && testFilePath.includes(beforeTest)) {\n\t\t\treturn index;\n\t\t}\n\t}\n\n\tfor (let index = 0; index < list.after.length; index++) {\n\t\tconst afterTest = list.after[index];\n\n\t\tif (afterTest && testFilePath.includes(afterTest)) {\n\t\t\treturn 0 - list.after.length + index;\n\t\t}\n\t}\n\n\treturn list.before.length;\n}\n\ntype SequentialTestsList = {\n\tbefore: string[];\n\tafter: string[];\n\tonly: string[];\n};",
            "output_extracted": "// Tests will run sequentially according to this list\nexport const sequentialTestsList: Record<'db' | 'common', SequentialTestsList> = {\n\tcommon: {\n\t\tbefore: ['/common/common.test.ts'],\n\t\tafter: [],\n\t\t// If specified, only run these tests sequentially\n\t\tonly: [\n\t\t\t// '/common/common.test.ts',\n\t\t],\n\t},\n\tdb: {\n\t\tbefore: [\n\t\t\t'/tests/db/seed-database.test.ts',\n\t\t\t'/common/common.test.ts',\n\t\t\t'/tests/db/routes/schema/schema.test.ts',\n\t\t\t'/tests/db/routes/collections/crud.test.ts',\n\t\t\t'/tests/db/routes/fields/change-fields.test.ts',\n\t\t\t'/tests/db/routes/fields/crud.test.ts',\n\t\t],\n\t\tafter: [\n\t\t\t'/tests/db/schema/timezone/timezone.test.ts',\n\t\t\t'/tests/db/schema/timezone/timezone-changed-node-tz-america.test.ts',\n\t\t\t'/tests/db/schema/timezone/timezone-changed-node-tz-asia.test.ts',\n\t\t\t'/tests/db/websocket/auth.test.ts',\n\t\t\t'/tests/db/websocket/general.test.ts',\n\t\t\t'/tests/db/routes/permissions/cache-purge.test.ts',\n\t\t\t'/tests/db/routes/flows/webhook.test.ts',\n\t\t\t'/tests/db/app/cache.test.ts',\n\t\t\t'/tests/db/routes/collections/schema-cache.test.ts',\n\t\t],\n\t\t// If specified, only run these tests sequentially\n\t\tonly: [\n\t\t\t// '/tests/db/seed-database.test.ts',\n\t\t\t// '/common/common.test.ts',\n\t\t],\n\t},\n};\n\nexport function getReversedTestIndex(testFilePath: string, project: 'db' | 'common') {\n\tconst list = sequentialTestsList[project];\n\n\tif (list.only.length > 0) {\n\t\tfor (let index = 0; index < list.only.length; index++) {\n\t\t\tconst onlyTest = list.only[index];\n\n\t\t\tif (onlyTest && testFilePath.includes(onlyTest)) {\n\t\t\t\treturn index;\n\t\t\t}\n\t\t}\n\t}\n\n\tfor (let index = 0; index < list.before.length; index++) {\n\t\tconst beforeTest = list.before[index];\n\n\t\tif (beforeTest && testFilePath.includes(beforeTest)) {\n\t\t\treturn index;\n\t\t}\n\t}\n\n\tfor (let index = 0; index < list.after.length; index++) {\n\t\tconst afterTest = list.after[index];\n\n\t\tif (afterTest && testFilePath.includes(afterTest)) {\n\t\t\treturn 0 - list.after.length + index;\n\t\t}\n\t}\n\n\treturn list.before.length;\n}\n\ntype SequentialTestsList = {\n\tbefore: string[];\n\tafter: string[];\n\tonly: string[];\n};",
            "cost": 0.02681
        },
        "directus__directus.447c91d0/tests/blackbox/tests/db/routes/server/health.test.ts": {
            "output": "import { getUrl } from '@common/config';\nimport vendors from '@common/get-dbs-to-test';\nimport { requestGraphQL } from '@common/transport';\nimport { TEST_USERS, USER } from '@common/variables';\nimport request from 'supertest';\nimport { describe, expect, it } from 'vitest';\n\ndescribe('/server', () => {\n\tdescribe('GET /health', () => {\n\t\tTEST_USERS.forEach((userKey) => {\n\t\t\tdescribe(USER[userKey].NAME, () => {\n\t\t\t\tit.each(vendors)('%s', async (vendor) => {\n\t\t\t\t\t// Action\n\t\t\t\t\tconst response = await request(getUrl(vendor))\n\t\t\t\t\t\t.get('/server/health')\n\t\t\t\t\t\t.set('Authorization', `Bearer ${USER[userKey].TOKEN}`);\n\n\t\t\t\t\tconst gqlResponse = await requestGraphQL(getUrl(vendor), true, USER[userKey].TOKEN, {\n\t\t\t\t\t\tquery: {\n\t\t\t\t\t\t\tserver_health: true,\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\n\t\t\t\t\t// Assert\n\t\t\t\t\texpect(response.statusCode).toBe(200);\n\t\t\t\t\texpect(gqlResponse.statusCode).toBe(200);\n\n\t\t\t\t\tif (userKey === USER.ADMIN.KEY) {\n\t\t\t\t\t\tconst adminResult = {\n\t\t\t\t\t\t\tstatus: expect.stringMatching(/ok|warn/),\n\t\t\t\t\t\t\treleaseId: expect.any(String),\n\t\t\t\t\t\t\tserviceId: expect.any(String),\n\t\t\t\t\t\t\tchecks: expect.anything(),\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\texpect(response.body).toEqual(adminResult);\n\t\t\t\t\t\texpect(gqlResponse.body.data.server_health).toEqual(adminResult);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconst nonAdminResult = { status: expect.stringMatching(/ok|warn/) };\n\n\t\t\t\t\t\texpect(response.body).toEqual(nonAdminResult);\n\t\t\t\t\t\texpect(gqlResponse.body.data.server_health).toEqual(nonAdminResult);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t});\n});",
            "output_extracted": "import { getUrl } from '@common/config';\nimport vendors from '@common/get-dbs-to-test';\nimport { requestGraphQL } from '@common/transport';\nimport { TEST_USERS, USER } from '@common/variables';\nimport request from 'supertest';\nimport { describe, expect, it } from 'vitest';\n\ndescribe('/server', () => {\n\tdescribe('GET /health', () => {\n\t\tTEST_USERS.forEach((userKey) => {\n\t\t\tdescribe(USER[userKey].NAME, () => {\n\t\t\t\tit.each(vendors)('%s', async (vendor) => {\n\t\t\t\t\t// Action\n\t\t\t\t\tconst response = await request(getUrl(vendor))\n\t\t\t\t\t\t.get('/server/health')\n\t\t\t\t\t\t.set('Authorization', `Bearer ${USER[userKey].TOKEN}`);\n\n\t\t\t\t\tconst gqlResponse = await requestGraphQL(getUrl(vendor), true, USER[userKey].TOKEN, {\n\t\t\t\t\t\tquery: {\n\t\t\t\t\t\t\tserver_health: true,\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\n\t\t\t\t\t// Assert\n\t\t\t\t\texpect(response.statusCode).toBe(200);\n\t\t\t\t\texpect(gqlResponse.statusCode).toBe(200);\n\n\t\t\t\t\tif (userKey === USER.ADMIN.KEY) {\n\t\t\t\t\t\tconst adminResult = {\n\t\t\t\t\t\t\tstatus: expect.stringMatching(/ok|warn/),\n\t\t\t\t\t\t\treleaseId: expect.any(String),\n\t\t\t\t\t\t\tserviceId: expect.any(String),\n\t\t\t\t\t\t\tchecks: expect.anything(),\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\texpect(response.body).toEqual(adminResult);\n\t\t\t\t\t\texpect(gqlResponse.body.data.server_health).toEqual(adminResult);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconst nonAdminResult = { status: expect.stringMatching(/ok|warn/) };\n\n\t\t\t\t\t\texpect(response.body).toEqual(nonAdminResult);\n\t\t\t\t\t\texpect(gqlResponse.body.data.server_health).toEqual(nonAdminResult);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t});\n});",
            "cost": 0.021070000000000002
        }
    },
    "recover_status": "success",
    "instance_ref": {
        "repo": "directus/directus",
        "instance_id": "directus__directus.pr_mirror.26213",
        "base_commit": "b5aff1a1bdab458049fc2972008b4bf785b21257",
        "patch": "diff --git a/.changeset/eighty-bats-deny.md b/.changeset/eighty-bats-deny.md\nnew file mode 100644\nindex 0000000000000..1414b884d83dc\n--- /dev/null\n+++ b/.changeset/eighty-bats-deny.md\n@@ -0,0 +1,5 @@\n+---\n+'@directus/api': patch\n+---\n+\n+Fixed notification emails failing due to transaction race condition\ndiff --git a/api/src/services/mail/index.ts b/api/src/services/mail/index.ts\nindex 5542d51fb3497..2cfc45b3b5f93 100644\n--- a/api/src/services/mail/index.ts\n+++ b/api/src/services/mail/index.ts\n@@ -32,6 +32,13 @@ export type EmailOptions = SendMailOptions & {\n \t};\n };\n \n+export type DefaultTemplateData = {\n+\tprojectName: string;\n+\tprojectColor: string;\n+\tprojectLogo: string;\n+\tprojectUrl: string;\n+};\n+\n export class MailService {\n \tschema: SchemaOverview;\n \taccountability: Accountability | null;\n@@ -54,18 +61,19 @@ export class MailService {\n \t\t}\n \t}\n \n-\tasync send<T>(options: EmailOptions): Promise<T | null> {\n+\tasync send<T>(data: EmailOptions, options?: { defaultTemplateData: DefaultTemplateData }): Promise<T | null> {\n \t\tawait useEmailRateLimiterQueue();\n \n-\t\tconst payload = await emitter.emitFilter(`email.send`, options, {});\n+\t\tconst payload = await emitter.emitFilter(`email.send`, data, {});\n \n \t\tif (!payload) return null;\n \n \t\tconst { template, ...emailOptions } = payload;\n \n-\t\tlet { html } = options;\n+\t\tlet { html } = data;\n \n-\t\tconst defaultTemplateData = await this.getDefaultTemplateData();\n+\t\t// option for providing tempalate data was added to prevent transaction race conditions with preceding promises\n+\t\tconst defaultTemplateData = options?.defaultTemplateData ?? (await this.getDefaultTemplateData());\n \n \t\tif (isObject(emailOptions.from) && (!emailOptions.from.name || !emailOptions.from.address)) {\n \t\t\tthrow new InvalidPayloadError({ reason: 'A name and address property are required in the \"from\" object' });\n@@ -117,7 +125,7 @@ export class MailService {\n \t\treturn html;\n \t}\n \n-\tprivate async getDefaultTemplateData() {\n+\tasync getDefaultTemplateData() {\n \t\tconst projectInfo = await this.knex\n \t\t\t.select(['project_name', 'project_logo', 'project_color', 'project_url'])\n \t\t\t.from('directus_settings')\ndiff --git a/api/src/services/notifications.ts b/api/src/services/notifications.ts\nindex 3e8a2214d1bd4..b773185c66a64 100644\n--- a/api/src/services/notifications.ts\n+++ b/api/src/services/notifications.ts\n@@ -57,14 +57,19 @@ export class NotificationsService extends ItemsService {\n \t\t\t\t});\n \n \t\t\t\tmailService\n-\t\t\t\t\t.send({\n-\t\t\t\t\t\ttemplate: {\n-\t\t\t\t\t\t\tname: 'base',\n-\t\t\t\t\t\t\tdata: app_access ? { url: manageUserAccountUrl, html } : { html },\n+\t\t\t\t\t.send(\n+\t\t\t\t\t\t{\n+\t\t\t\t\t\t\ttemplate: {\n+\t\t\t\t\t\t\t\tname: 'base',\n+\t\t\t\t\t\t\t\tdata: app_access ? { url: manageUserAccountUrl, html } : { html },\n+\t\t\t\t\t\t\t},\n+\t\t\t\t\t\t\tto: user['email'],\n+\t\t\t\t\t\t\tsubject: data.subject,\n \t\t\t\t\t\t},\n-\t\t\t\t\t\tto: user['email'],\n-\t\t\t\t\t\tsubject: data.subject,\n-\t\t\t\t\t})\n+\t\t\t\t\t\t{\n+\t\t\t\t\t\t\tdefaultTemplateData: await mailService.getDefaultTemplateData(),\n+\t\t\t\t\t\t},\n+\t\t\t\t\t)\n \t\t\t\t\t.catch((error) => {\n \t\t\t\t\t\tlogger.error(error, `Could not send notification via mail`);\n \t\t\t\t\t});\ndiff --git a/pnpm-lock.yaml b/pnpm-lock.yaml\nindex 9f2f53de4c964..5afd3a6c6d939 100644\n--- a/pnpm-lock.yaml\n+++ b/pnpm-lock.yaml\n@@ -3025,9 +3025,15 @@ importers:\n       '@types/lodash-es':\n         specifier: 'catalog:'\n         version: 4.17.12\n+      '@types/mailparser':\n+        specifier: 3.4.6\n+        version: 3.4.6\n       '@types/seedrandom':\n         specifier: 3.0.8\n         version: 3.0.8\n+      '@types/smtp-server':\n+        specifier: 3.5.12\n+        version: 3.5.12\n       '@types/supertest':\n         specifier: 6.0.2\n         version: 6.0.2\n@@ -3067,9 +3073,15 @@ importers:\n       lodash-es:\n         specifier: 'catalog:'\n         version: 4.17.21\n+      mailparser:\n+        specifier: 3.9.0\n+        version: 3.9.0\n       seedrandom:\n         specifier: 3.0.5\n         version: 3.0.5\n+      smtp-server:\n+        specifier: 3.16.1\n+        version: 3.16.1\n       supertest:\n         specifier: 7.1.4\n         version: 7.1.4\n@@ -6142,6 +6154,9 @@ packages:\n   '@sec-ant/readable-stream@0.4.1':\n     resolution: {integrity: sha512-831qok9r2t8AlxLko40y2ebgSDhenenCatLVeW/uBtnHPyhHOvG0C7TvfgecV+wHzIm5KUICgzmVpWS+IMEAeg==}\n \n+  '@selderee/plugin-htmlparser2@0.11.0':\n+    resolution: {integrity: sha512-P33hHGdldxGabLFjPPpaTxVolMrzrcegejx+0GxjrIb9Zv48D8yAIA/QTDR2dFl7Uz7urX8aX6+5bCZslr+gWQ==}\n+\n   '@shopify/semaphore@3.1.0':\n     resolution: {integrity: sha512-LxonkiWEu12FbZhuOMhsdocpxCqm7By8C/2U9QgNuEoXUx2iMrlXjJv3p93RwfNC6TrdlNRo17gRer1z1309VQ==}\n     engines: {node: '>=18.12.0'}\n@@ -6612,6 +6627,9 @@ packages:\n   '@types/luxon@3.7.1':\n     resolution: {integrity: sha512-H3iskjFIAn5SlJU7OuxUmTEpebK6TKB8rxZShDslBMZJ5u9S//KM1sbdAisiSrqwLQncVjnpi2OK2J51h+4lsg==}\n \n+  '@types/mailparser@3.4.6':\n+    resolution: {integrity: sha512-wVV3cnIKzxTffaPH8iRnddX1zahbYB1ZEoAxyhoBo3TBCBuK6nZ8M8JYO/RhsCuuBVOw/DEN/t/ENbruwlxn6Q==}\n+\n   '@types/mapbox-gl@3.4.1':\n     resolution: {integrity: sha512-NsGKKtgW93B+UaLPti6B7NwlxYlES5DpV5Gzj9F75rK5ALKsqSk15CiEHbOnTr09RGbr6ZYiCdI+59NNNcAImg==}\n \n@@ -6708,6 +6726,9 @@ packages:\n   '@types/serve-static@1.15.9':\n     resolution: {integrity: sha512-dOTIuqpWLyl3BBXU3maNQsS4A3zuuoYRNIvYSxxhebPfXg2mzWQEPne/nlJ37yOse6uGgR386uTpdsx4D0QZWA==}\n \n+  '@types/smtp-server@3.5.12':\n+    resolution: {integrity: sha512-IBemrqI6nzvbgwE41Lnd4v4Yf1Kc7F1UHjk1GFBLNhLcI/Zop1ggHQ8g7Y8QYc6jGVgzWQcsa0MBNcGnDY9UGw==}\n+\n   '@types/ssri@7.1.5':\n     resolution: {integrity: sha512-odD/56S3B51liILSk5aXJlnYt99S6Rt9EFDDqGtJM26rKHApHcwyU/UoYHrzKkdkHMAIquGWCuHtQTbes+FRQw==}\n \n@@ -7089,6 +7110,9 @@ packages:\n     engines: {node: '>= 8'}\n     hasBin: true\n \n+  '@zone-eu/mailsplit@5.4.7':\n+    resolution: {integrity: sha512-jApX86aDgolMz08pP20/J2zcns02NSK3zSiYouf01QQg4250L+GUAWSWicmS7eRvs+Z7wP7QfXrnkaTBGrIpwQ==}\n+\n   JSV@4.0.2:\n     resolution: {integrity: sha512-ZJ6wx9xaKJ3yFUhq5/sk82PJMuUyLk277I8mQeyDgCTjGdjWJIvPfaU5LIXaMuaN2UO1X3kZH4+lgphublZUHw==}\n \n@@ -7390,6 +7414,10 @@ packages:\n   base-64@1.0.0:\n     resolution: {integrity: sha512-kwDPIFCGx0NZHog36dj+tHiwP4QMzsZ3AgMViUBKI0+V5n4U0ufTCUMhnQ04diaRI8EX/QcPfql7zlhZ7j4zgg==}\n \n+  base32.js@0.1.0:\n+    resolution: {integrity: sha512-n3TkB02ixgBOhTvANakDb4xaMXnYUVkNoRFJjQflcqMQhyEKxEHdj3E6N8t8sUQ0mjH/3/JxzlXuz3ul/J90pQ==}\n+    engines: {node: '>=0.12.0'}\n+\n   base64-js@1.5.1:\n     resolution: {integrity: sha512-AKpaYlHn8t4SVbOHCy+b5+KKgvR4vrsD8vbvrbiQJps7fKDTkjkDry6ji0rUJjC0kzbNePLwzxq8iypo41qeWA==}\n \n@@ -8530,6 +8558,10 @@ packages:\n     resolution: {integrity: sha512-Q0n9HRi4m6JuGIV1eFlmvJB7ZEVxu93IrMyiMsGC0lrMJMWzRgx6WGquyfQgZVb31vhGgXnfmPNNXmxnOkRBrg==}\n     engines: {node: '>= 0.8'}\n \n+  encoding-japanese@2.2.0:\n+    resolution: {integrity: sha512-EuJWwlHPZ1LbADuKTClvHtwbaFn4rOD+dRAbWysqEOXRc2Uui0hJInNJrsdH0c+OhJA4nrCBdSkW4DD5YxAo6A==}\n+    engines: {node: '>=8.10.0'}\n+\n   encoding@0.1.13:\n     resolution: {integrity: sha512-ETBauow1T35Y/WZMkio9jiM0Z5xjHHmJ4XmjZOq1l/dXz3lr2sRn87nJy20RupqSh1F2m3HHPSp8ShIPQJrJ3A==}\n \n@@ -9400,6 +9432,10 @@ packages:\n     resolution: {integrity: sha512-ztqyC3kLto0e9WbNp0aeP+M3kTt+nbaIveGmUxAtZa+8iFgKLUOD4YKM5j+f3QD89bra7UeumolZHKuOXnTmeQ==}\n     engines: {node: '>=8'}\n \n+  html-to-text@9.0.5:\n+    resolution: {integrity: sha512-qY60FjREgVZL03vJU6IfMV4GDjGBIoOyvuFdpBDIX9yTlDw0TjxVBQp+P8NvpdIXNJvfWBTNul7fsAQJq2FNpg==}\n+    engines: {node: '>=14'}\n+\n   htmlparser2@8.0.2:\n     resolution: {integrity: sha512-GYdjWKDkbRLkZ5geuHs5NY1puJ+PXwP7+fHPRz06Eirsb9ugf6d8kkXav6ADhcODhFFPMIXyxkxSuMf3D6NCFA==}\n \n@@ -9569,6 +9605,9 @@ packages:\n     resolution: {integrity: sha512-0KI/607xoxSToH7GjN1FfSbLoU0+btTicjsQSWQlh/hZykN8KpmMf7uYwPW3R+akZ6R/w18ZlXSHBYXiYUPO3g==}\n     engines: {node: '>= 0.10'}\n \n+  ipv6-normalize@1.0.1:\n+    resolution: {integrity: sha512-Bm6H79i01DjgGTCWjUuCjJ6QDo1HB96PT/xCYuyJUP9WFbVDrLSbG4EZCvOCun2rNswZb0c3e4Jt/ws795esHA==}\n+\n   is-arrayish@0.2.1:\n     resolution: {integrity: sha512-zz06S8t0ozoDXMG+ube26zeCTNXcKIPJZJi8hBrF4idCLms4CG9QtK7qBl1boi5ODzFpjswb5JPmHCbMpjaYzg==}\n \n@@ -9970,6 +10009,9 @@ packages:\n     engines: {node: '>=10.13.0'}\n     deprecated: This package has been decomissioned. See https://github.com/ldapjs/node-ldapjs/blob/8ffd0bc9c149088a10ec4c1ec6a18450f76ad05d/README.md\n \n+  leac@0.6.0:\n+    resolution: {integrity: sha512-y+SqErxb8h7nE/fiEX07jsbuhrpO9lL8eca7/Y1nuWV2moNlXhyd59iDGcRf6moVyDMbmTNzL40SUyrFU/yDpg==}\n+\n   leven@2.1.0:\n     resolution: {integrity: sha512-nvVPLpIHUxCUoRLrFqTgSxXJ614d8AgQoWl7zPe/2VadE8+1dpU3LBhowRuBAcuwruWtOdD8oYC9jDNJjXDPyA==}\n     engines: {node: '>=0.10.0'}\n@@ -9978,6 +10020,15 @@ packages:\n     resolution: {integrity: sha512-+bT2uH4E5LGE7h/n3evcS/sQlJXCpIp6ym8OWJ5eV6+67Dsql/LaaT7qJBAt2rzfoa/5QBGBhxDix1dMt2kQKQ==}\n     engines: {node: '>= 0.8.0'}\n \n+  libbase64@1.3.0:\n+    resolution: {integrity: sha512-GgOXd0Eo6phYgh0DJtjQ2tO8dc0IVINtZJeARPeiIJqge+HdsWSuaDTe8ztQ7j/cONByDZ3zeB325AHiv5O0dg==}\n+\n+  libmime@5.3.7:\n+    resolution: {integrity: sha512-FlDb3Wtha8P01kTL3P9M+ZDNDWPKPmKHWaU/cG/lg5pfuAwdflVpZE+wm9m7pKmC5ww6s+zTxBKS1p6yl3KpSw==}\n+\n+  libqp@2.1.1:\n+    resolution: {integrity: sha512-0Wd+GPz1O134cP62YU2GTOPNA7Qgl09XwCqM5zpBv87ERCXdfDtyKXvV7c9U22yWJh44QZqBocFnXN11K96qow==}\n+\n   lilconfig@3.1.3:\n     resolution: {integrity: sha512-/vlFKAoH5Cgt3Ie+JLhRbwOsCQePABiU3tJ1egGvyQ+33R/vcwM2Zl2QR/LzjsBeItPt3oSVXapn+m4nQDvpzw==}\n     engines: {node: '>=14'}\n@@ -9988,6 +10039,9 @@ packages:\n   linkify-it@3.0.3:\n     resolution: {integrity: sha512-ynTsyrFSdE5oZ/O9GEf00kPngmOfVwazR5GKDq6EYfhlpFug3J2zybX56a2PRRpc9P+FuSoGNAwjlbDs9jJBPQ==}\n \n+  linkify-it@5.0.0:\n+    resolution: {integrity: sha512-5aHCbzQRADcdP+ATqnDuhhJ/MRIqDkZX5pyjFHRRysS8vZ5AbqGEoFIb6pYHPZ+L/OC2Lc+xT8uHVVR5CAK/wQ==}\n+\n   liquidjs@10.24.0:\n     resolution: {integrity: sha512-TAUNAdgwaAXjjcUFuYVJm9kOVH7zc0mTKxsG9t9Lu4qdWjB2BEblyVIYpjWcmJLMGgiYqnGNJjpNMHx0gp/46A==}\n     engines: {node: '>=16'}\n@@ -10185,6 +10239,9 @@ packages:\n   mailgun.js@8.2.2:\n     resolution: {integrity: sha512-po/KtofzrTuKhHLenbmliDsVVOFANwcfDFUGnggwnyZJmZz7JgBlV6nzK9o2Fk+OK2SiBmJTK25RbkAj57Hd+Q==}\n \n+  mailparser@3.9.0:\n+    resolution: {integrity: sha512-jpaNLhDjwy0w2f8sySOSRiWREjPqssSc0C2czV98btCXCRX3EyNloQ2IWirmMDj1Ies8Fkm0l96bZBZpDG7qkg==}\n+\n   make-dir@4.0.0:\n     resolution: {integrity: sha512-hXdUTZYIVOt1Ex//jAQi+wTZZpUpwBj/0QsOzqegb3rGMMeJiSEu5xLHnYfBrRV4RH2+OCSOO95Is/7x1WJ4bw==}\n     engines: {node: '>=10'}\n@@ -10981,6 +11038,9 @@ packages:\n   parse5@7.3.0:\n     resolution: {integrity: sha512-IInvU7fabl34qmi9gY8XOVxhYyMyuH2xUNpb2q8/Y+7552KlejkRvqvD19nMoUW/uQGGbqNpA6Tufu5FL5BZgw==}\n \n+  parseley@0.12.1:\n+    resolution: {integrity: sha512-e6qHKe3a9HWr0oMRVDTRhKce+bRO8VGQR3NyVwcjwrbhMmFCX9KszEV35+rn4AdilFAq9VPxP/Fe1wC9Qjd2lw==}\n+\n   parseurl@1.3.3:\n     resolution: {integrity: sha512-CiyeOxFT/JZyN5m0z9PfXw4SCBJ6Sygz1Dpl0wqjlhDEGGBP1GnsUVEL0p63hoG1fcj3fHynXi9NYO4nWOL+qQ==}\n     engines: {node: '>= 0.8'}\n@@ -11073,6 +11133,9 @@ packages:\n     resolution: {integrity: sha512-XDF38WCH3z5OV/OVa8GKUNtLAyneuzbCisx7QUCF8Q6Nutx0WnJrQe5O+kOtBlLfRNUws98Y58Lblp+NJG5T4Q==}\n     hasBin: true\n \n+  peberminta@0.9.0:\n+    resolution: {integrity: sha512-XIxfHpEuSJbITd1H3EeQwpcZbTLHc+VVr8ANI9t5sit565tsI4/xK3KWTUFE2e6QiangUkh3B0jihzmGnNrRsQ==}\n+\n   perfect-debounce@1.0.0:\n     resolution: {integrity: sha512-xCy9V055GLEqoFaHoC1SoLIaLmWctgCUaBaWxDZ7/Zx4CTyX7cJQLJOok/orfjZAh9kEYpjJa4d0KcJmCbctZA==}\n \n@@ -11594,6 +11657,10 @@ packages:\n   pump@3.0.3:\n     resolution: {integrity: sha512-todwxLMY7/heScKmntwQG8CXVkWUOdYxIvY2s0VWAAMh/nd8SoYiRaKjlr7+iCs984f2P8zvrfWcDDYVb73NfA==}\n \n+  punycode.js@2.3.1:\n+    resolution: {integrity: sha512-uxFIHU0YlHYhDQtV4R9J6a52SLx28BCjT+4ieh7IGbgwVJWO+km431c4yRlREUAsAmt/uMjQUyQHNEPf0M39CA==}\n+    engines: {node: '>=6'}\n+\n   punycode@2.3.1:\n     resolution: {integrity: sha512-vYt7UD1U9Wg6138shLtLOvdAu+8DsC/ilFtEVHcH+wydcSpNE20AfSOduf6MkRFahL5FY7X1oU7nKVZFtfq8Fg==}\n     engines: {node: '>=6'}\n@@ -12093,6 +12160,9 @@ packages:\n   seedrandom@3.0.5:\n     resolution: {integrity: sha512-8OwmbklUNzwezjGInmZ+2clQmExQPvomqjL7LFqOYqtmuxRgQYqOD3mHaU+MvZn5FLUeVxVfQjwLZW/n/JFuqg==}\n \n+  selderee@0.11.0:\n+    resolution: {integrity: sha512-5TF+l7p4+OsnP8BCCvSyZiSPc4x4//p5uPwK8TCnVPJYRmU2aYKMpOXvw8zM5a5JvuuCGN1jmsMwuU2W02ukfA==}\n+\n   semver-utils@1.1.4:\n     resolution: {integrity: sha512-EjnoLE5OGmDAVV/8YDoN5KiajNadjzIp9BAHOhYeQHt7j0UWxjmgsx4YD48wp4Ue1Qogq38F1GNUJNqF1kKKxA==}\n \n@@ -12257,6 +12327,10 @@ packages:\n   smob@1.5.0:\n     resolution: {integrity: sha512-g6T+p7QO8npa+/hNx9ohv1E5pVCmWrVCUzUXJyLdMmftX6ER0oiWY/w9knEonLpnOp6b6FenKnMfR8gqwWdwig==}\n \n+  smtp-server@3.16.1:\n+    resolution: {integrity: sha512-7oUsW8+7eXOW85lV8/kMCFGGzqxI+JtNJYptR8XDgjgTNL8Bcnj3toAfDZiqg4o3XpJRQhDwKZNbKcPdxEFsTw==}\n+    engines: {node: '>=18.18.0'}\n+\n   snake-case@3.0.4:\n     resolution: {integrity: sha512-LAOh4z89bGQvl9pFfNF8V146i7o7/CqFPbqzYgP+yYzDIDeS9HaNFtXABamRW+AQzEVODcvE79ljJ+8a9YSdMg==}\n \n@@ -12838,6 +12912,10 @@ packages:\n     resolution: {integrity: sha512-azl+t0z7pw/z958Gy9svOTuzqIk6xq+NSheJzn5MMWtWTFywIacg2wUlzKFGtt3cthx0r2SxMK0yzJOR0IES7Q==}\n     engines: {node: '>=14.0.0'}\n \n+  tlds@1.261.0:\n+    resolution: {integrity: sha512-QXqwfEl9ddlGBaRFXIvNKK6OhipSiLXuRuLJX5DErz0o0Q0rYxulWLdFryTkV5PkdZct5iMInwYEGe/eR++1AA==}\n+    hasBin: true\n+\n   tmp@0.2.5:\n     resolution: {integrity: sha512-voyz6MApa1rQGUxT3E+BK7/ROe8itEx7vD8/HEvt4xwXucvQ5G5oeEiHkmHZJuBO21RpOf+YYm9MOivj709jow==}\n     engines: {node: '>=14.14'}\n@@ -13023,6 +13101,9 @@ packages:\n   uc.micro@1.0.6:\n     resolution: {integrity: sha512-8Y75pvTYkLJW2hWQHXxoqRgV7qb9B+9vFEtidML+7koHUFapnVJAZ6cKs+Qjz5Aw3aZWHMC6u0wJE3At+nSGwA==}\n \n+  uc.micro@2.1.0:\n+    resolution: {integrity: sha512-ARDJmphmdvUk6Glw7y9DQ2bFkKBHwQHLi2lsaH6PPmz/Ka9sFOBsBluozhDltWmnv9u/cF6Rt87znRTPV+yp/A==}\n+\n   ufo@1.6.1:\n     resolution: {integrity: sha512-9a4/uxlTWJ4+a5i0ooc1rU7C7YOw3wT+UGqdeNNHWnOF9qcMBgLRS+4IYUqbczewFx4mLEig6gawh7X6mFlEkA==}\n \n@@ -17742,6 +17823,11 @@ snapshots:\n \n   '@sec-ant/readable-stream@0.4.1': {}\n \n+  '@selderee/plugin-htmlparser2@0.11.0':\n+    dependencies:\n+      domhandler: 5.0.3\n+      selderee: 0.11.0\n+\n   '@shopify/semaphore@3.1.0': {}\n \n   '@sinclair/typebox@0.27.8': {}\n@@ -18337,6 +18423,11 @@ snapshots:\n \n   '@types/luxon@3.7.1': {}\n \n+  '@types/mailparser@3.4.6':\n+    dependencies:\n+      '@types/node': 24.9.1\n+      iconv-lite: 0.6.3\n+\n   '@types/mapbox-gl@3.4.1':\n     dependencies:\n       '@types/geojson': 7946.0.16\n@@ -18450,6 +18541,13 @@ snapshots:\n       '@types/node': 24.9.1\n       '@types/send': 0.17.5\n \n+  '@types/smtp-server@3.5.12':\n+    dependencies:\n+      '@types/node': 24.9.1\n+      '@types/nodemailer': 7.0.3\n+    transitivePeerDependencies:\n+      - aws-crt\n+\n   '@types/ssri@7.1.5':\n     dependencies:\n       '@types/node': 24.9.1\n@@ -19007,6 +19105,12 @@ snapshots:\n     dependencies:\n       isexe: 2.0.0\n \n+  '@zone-eu/mailsplit@5.4.7':\n+    dependencies:\n+      libbase64: 1.3.0\n+      libmime: 5.3.7\n+      libqp: 2.1.1\n+\n   JSV@4.0.2: {}\n \n   abab@2.0.6: {}\n@@ -19327,6 +19431,8 @@ snapshots:\n \n   base-64@1.0.0: {}\n \n+  base32.js@0.1.0: {}\n+\n   base64-js@1.5.1: {}\n \n   base64id@2.0.0: {}\n@@ -20317,6 +20423,8 @@ snapshots:\n \n   encodeurl@2.0.0: {}\n \n+  encoding-japanese@2.2.0: {}\n+\n   encoding@0.1.13:\n     dependencies:\n       iconv-lite: 0.6.3\n@@ -21417,6 +21525,14 @@ snapshots:\n \n   html-tags@3.3.1: {}\n \n+  html-to-text@9.0.5:\n+    dependencies:\n+      '@selderee/plugin-htmlparser2': 0.11.0\n+      deepmerge: 4.3.1\n+      dom-serializer: 2.0.0\n+      htmlparser2: 8.0.2\n+      selderee: 0.11.0\n+\n   htmlparser2@8.0.2:\n     dependencies:\n       domelementtype: 2.3.0\n@@ -21604,6 +21720,8 @@ snapshots:\n \n   ipaddr.js@1.9.1: {}\n \n+  ipv6-normalize@1.0.1: {}\n+\n   is-arrayish@0.2.1: {}\n \n   is-binary-path@2.1.0:\n@@ -22004,6 +22122,8 @@ snapshots:\n       vasync: 2.2.1\n       verror: 1.10.1\n \n+  leac@0.6.0: {}\n+\n   leven@2.1.0: {}\n \n   levn@0.4.1:\n@@ -22011,6 +22131,17 @@ snapshots:\n       prelude-ls: 1.2.1\n       type-check: 0.4.0\n \n+  libbase64@1.3.0: {}\n+\n+  libmime@5.3.7:\n+    dependencies:\n+      encoding-japanese: 2.2.0\n+      iconv-lite: 0.6.3\n+      libbase64: 1.3.0\n+      libqp: 2.1.1\n+\n+  libqp@2.1.1: {}\n+\n   lilconfig@3.1.3: {}\n \n   lines-and-columns@1.2.4: {}\n@@ -22019,6 +22150,10 @@ snapshots:\n     dependencies:\n       uc.micro: 1.0.6\n \n+  linkify-it@5.0.0:\n+    dependencies:\n+      uc.micro: 2.1.0\n+\n   liquidjs@10.24.0:\n     dependencies:\n       commander: 10.0.1\n@@ -22218,6 +22353,19 @@ snapshots:\n       - debug\n     optional: true\n \n+  mailparser@3.9.0:\n+    dependencies:\n+      '@zone-eu/mailsplit': 5.4.7\n+      encoding-japanese: 2.2.0\n+      he: 1.2.0\n+      html-to-text: 9.0.5\n+      iconv-lite: 0.7.0\n+      libmime: 5.3.7\n+      linkify-it: 5.0.0\n+      nodemailer: 7.0.10\n+      punycode.js: 2.3.1\n+      tlds: 1.261.0\n+\n   make-dir@4.0.0:\n     dependencies:\n       semver: 7.7.3\n@@ -23118,6 +23266,11 @@ snapshots:\n     dependencies:\n       entities: 6.0.1\n \n+  parseley@0.12.1:\n+    dependencies:\n+      leac: 0.6.0\n+      peberminta: 0.9.0\n+\n   parseurl@1.3.3: {}\n \n   pascal-case@3.1.2:\n@@ -23197,6 +23350,8 @@ snapshots:\n       ieee754: 1.2.1\n       resolve-protobuf-schema: 2.1.0\n \n+  peberminta@0.9.0: {}\n+\n   perfect-debounce@1.0.0: {}\n \n   pg-cloudflare@1.2.7:\n@@ -23799,6 +23954,8 @@ snapshots:\n       end-of-stream: 1.4.5\n       once: 1.4.0\n \n+  punycode.js@2.3.1: {}\n+\n   punycode@2.3.1: {}\n \n   qified@0.5.1:\n@@ -24390,6 +24547,10 @@ snapshots:\n \n   seedrandom@3.0.5: {}\n \n+  selderee@0.11.0:\n+    dependencies:\n+      parseley: 0.12.1\n+\n   semver-utils@1.1.4: {}\n \n   semver@5.7.2: {}\n@@ -24607,6 +24768,13 @@ snapshots:\n \n   smob@1.5.0: {}\n \n+  smtp-server@3.16.1:\n+    dependencies:\n+      base32.js: 0.1.0\n+      ipv6-normalize: 1.0.1\n+      nodemailer: 7.0.10\n+      punycode.js: 2.3.1\n+\n   snake-case@3.0.4:\n     dependencies:\n       dot-case: 3.0.4\n@@ -25307,6 +25475,8 @@ snapshots:\n \n   tinyspy@4.0.4: {}\n \n+  tlds@1.261.0: {}\n+\n   tmp@0.2.5: {}\n \n   to-regex-range@5.0.1:\n@@ -25471,6 +25641,8 @@ snapshots:\n \n   uc.micro@1.0.6: {}\n \n+  uc.micro@2.1.0: {}\n+\n   ufo@1.6.1: {}\n \n   uid-number@0.0.6: {}\ndiff --git a/tests/blackbox/common/config.ts b/tests/blackbox/common/config.ts\nindex 4c3652ef7c538..3d3c2e7859b84 100644\n--- a/tests/blackbox/common/config.ts\n+++ b/tests/blackbox/common/config.ts\n@@ -92,6 +92,9 @@ const directusConfig = {\n \tACCESS_TOKEN_TTL: '25d', // should be larger than 24.86 days to test Expires value larger than 32-bit signed integer\n \tWEBSOCKETS_ENABLED: 'true',\n \tTUS_ENABLED: 'true',\n+\tEMAIL_TRANSPORT: 'smtp',\n+\tEMAIL_SMTP_HOST: '127.0.0.1',\n+\tEMAIL_SMTP_PORT: '1025',\n \t...directusAuthConfig,\n \t...directusStorageConfig,\n };\ndiff --git a/tests/blackbox/package.json b/tests/blackbox/package.json\nindex 48a0f0a0b33d5..6889b938169bf 100644\n--- a/tests/blackbox/package.json\n+++ b/tests/blackbox/package.json\n@@ -14,11 +14,15 @@\n \t\t\"tus-js-client\": \"catalog:\",\n \t\t\"@types/js-yaml\": \"catalog:\",\n \t\t\"@types/lodash-es\": \"catalog:\",\n+\t\t\"@types/mailparser\": \"3.4.6\",\n \t\t\"@types/seedrandom\": \"3.0.8\",\n+\t\t\"@types/smtp-server\": \"3.5.12\",\n \t\t\"@types/supertest\": \"6.0.2\",\n \t\t\"@types/ws\": \"catalog:\",\n \t\t\"argon2\": \"catalog:\",\n \t\t\"autocannon\": \"8.0.0\",\n+\t\t\"smtp-server\": \"3.16.1\",\n+\t\t\"mailparser\": \"3.9.0\",\n \t\t\"axios\": \"catalog:\",\n \t\t\"get-port\": \"catalog:\",\n \t\t\"globby\": \"14.1.0\",\ndiff --git a/tests/blackbox/setup/sequential-tests.ts b/tests/blackbox/setup/sequential-tests.ts\nindex 7409c03d23bf2..e43f25d28f88a 100644\n--- a/tests/blackbox/setup/sequential-tests.ts\n+++ b/tests/blackbox/setup/sequential-tests.ts\n@@ -16,6 +16,7 @@ export const sequentialTestsList: Record<'db' | 'common', SequentialTestsList> =\n \t\t\t'/tests/db/routes/collections/crud.test.ts',\n \t\t\t'/tests/db/routes/fields/change-fields.test.ts',\n \t\t\t'/tests/db/routes/fields/crud.test.ts',\n+\t\t\t'/tests/db/routes/items/version.test.ts',\n \t\t],\n \t\tafter: [\n \t\t\t'/tests/db/schema/timezone/timezone.test.ts',\ndiff --git a/tests/blackbox/tests/db/mail/mail.test.ts b/tests/blackbox/tests/db/mail/mail.test.ts\nnew file mode 100644\nindex 0000000000000..6f99b344d5a07\n--- /dev/null\n+++ b/tests/blackbox/tests/db/mail/mail.test.ts\n@@ -0,0 +1,80 @@\n+import { getUrl } from '@common/config';\n+import vendors from '@common/get-dbs-to-test';\n+import { USER } from '@common/variables';\n+import { sleep } from '@utils/sleep';\n+import { simpleParser, type ParsedMail } from 'mailparser';\n+import { SMTPServer } from 'smtp-server';\n+import request from 'supertest';\n+import { afterAll, beforeAll, beforeEach, describe, expect, it } from 'vitest';\n+\n+describe('Mail', async () => {\n+\tlet fakeSMTPServer: SMTPServer;\n+\tlet messages: ParsedMail[] = [];\n+\n+\tbeforeAll(async () => {\n+\t\tfakeSMTPServer = new SMTPServer({\n+\t\t\tauthOptional: true,\n+\t\t\thideSTARTTLS: true,\n+\t\t\tonData(stream, _, cb) {\n+\t\t\t\tsimpleParser(stream, (err, message) => {\n+\t\t\t\t\tif (err) {\n+\t\t\t\t\t\treturn cb();\n+\t\t\t\t\t}\n+\n+\t\t\t\t\tmessages.push(message);\n+\t\t\t\t\tcb();\n+\t\t\t\t});\n+\t\t\t},\n+\t\t});\n+\n+\t\tawait new Promise<void>((resolve) =>\n+\t\t\tfakeSMTPServer.listen(1025, '127.0.0.1', () => {\n+\t\t\t\tresolve();\n+\t\t\t}),\n+\t\t);\n+\t}, 180_000);\n+\n+\tafterAll(async () => {\n+\t\tawait new Promise<void>((resolve) =>\n+\t\t\tfakeSMTPServer.close(() => {\n+\t\t\t\tresolve();\n+\t\t\t}),\n+\t\t);\n+\t});\n+\n+\tbeforeEach(() => {\n+\t\tmessages = [];\n+\t});\n+\n+\tdescribe('POST /notifications', () => {\n+\t\tit.each(vendors)('%s', async (vendor) => {\n+\t\t\t// Setup\n+\t\t\tconst notifications = [\n+\t\t\t\t{\n+\t\t\t\t\trecipient: USER.TESTS_FLOW.ID,\n+\t\t\t\t\tsubject: 'inbox',\n+\t\t\t\t\tmessage: 'Lorem Ipsum',\n+\t\t\t\t},\n+\t\t\t\t{\n+\t\t\t\t\trecipient: USER.TESTS_FLOW.ID,\n+\t\t\t\t\tsubject: 'inbox',\n+\t\t\t\t\tmessage: 'Dolor Sat',\n+\t\t\t\t},\n+\t\t\t];\n+\n+\t\t\t// action\n+\t\t\tconst response = await request(getUrl(vendor))\n+\t\t\t\t.post('/notifications')\n+\t\t\t\t.set('Authorization', `Bearer ${USER.ADMIN.TOKEN}`)\n+\t\t\t\t.send(notifications);\n+\n+\t\t\t// Checks\n+\t\t\texpect(response.status).toEqual(200);\n+\n+\t\t\t// wait for mail to arrive\n+\t\t\tawait sleep(5000);\n+\n+\t\t\texpect(messages).toHaveLength(2);\n+\t\t});\n+\t});\n+});\ndiff --git a/tests/blackbox/tests/db/routes/server/health.test.ts b/tests/blackbox/tests/db/routes/server/health.test.ts\nindex d7bf255bb1f82..1c2488ffbee08 100644\n--- a/tests/blackbox/tests/db/routes/server/health.test.ts\n+++ b/tests/blackbox/tests/db/routes/server/health.test.ts\n@@ -2,11 +2,38 @@ import { getUrl } from '@common/config';\n import vendors from '@common/get-dbs-to-test';\n import { requestGraphQL } from '@common/transport';\n import { TEST_USERS, USER } from '@common/variables';\n+import { SMTPServer } from 'smtp-server';\n import request from 'supertest';\n-import { describe, expect, it } from 'vitest';\n+import { afterAll, beforeAll, describe, expect, it } from 'vitest';\n \n describe('/server', () => {\n \tdescribe('GET /health', () => {\n+\t\tlet fakeSMTPServer: SMTPServer;\n+\n+\t\tbeforeAll(async () => {\n+\t\t\tfakeSMTPServer = new SMTPServer({\n+\t\t\t\tauthOptional: true,\n+\t\t\t\thideSTARTTLS: true,\n+\t\t\t\tonData(_stream, _, cb) {\n+\t\t\t\t\tcb();\n+\t\t\t\t},\n+\t\t\t});\n+\n+\t\t\tawait new Promise<void>((resolve) =>\n+\t\t\t\tfakeSMTPServer.listen(1025, '127.0.0.1', () => {\n+\t\t\t\t\tresolve();\n+\t\t\t\t}),\n+\t\t\t);\n+\t\t}, 180_000);\n+\n+\t\tafterAll(async () => {\n+\t\t\tawait new Promise<void>((resolve) =>\n+\t\t\t\tfakeSMTPServer.close(() => {\n+\t\t\t\t\tresolve();\n+\t\t\t\t}),\n+\t\t\t);\n+\t\t});\n+\n \t\tTEST_USERS.forEach((userKey) => {\n \t\t\tdescribe(USER[userKey].NAME, () => {\n \t\t\t\tit.each(vendors)('%s', async (vendor) => {\n",
        "test_patch": "",
        "problem_statement": "## Scope\r\n\r\nWhat's changed:\r\n\r\n- Added an option to passing the defaultTemplateData removing the race condition while providing backwards compatiblity\r\n\r\n## Potential Risks / Drawbacks\r\n\r\n- Should be none as we default to default behaviour\r\n\r\n## Tested Scenarios\r\n\r\n- [x] Expect send operation to send email with no error\r\n- [x] Expect notification operation to send email with no error\r\n\r\n## Review Notes / Questions\r\n\r\n- The issue here is due to the additional await from the emailQueue the transaction sometimes completes before the query is triggered resulting in the reported error being logged.\r\n- Open to alternative suggestions in regards to solution.\r\n\r\n## Checklist\r\n\r\n- [x] Added or updated tests \r\n- [ ] Documentation PR created [here](https://github.com/directus/docs) or not required\r\n- [ ] OpenAPI package PR created [here](https://github.com/directus/openapi) or not required\r\n\r\n---\r\n\r\nFixes #26210\r\n",
        "hints_text": "",
        "created_at": "2025-11-17T20:26:35Z",
        "pull_number": 26213,
        "test_files": [
            "tests/blackbox/tests/db/mail/mail.test.ts",
            "tests/blackbox/tests/db/routes/server/health.test.ts"
        ],
        "code_files": [
            "api/src/services/mail/index.ts",
            "api/src/services/notifications.ts",
            "tests/blackbox/common/config.ts",
            "tests/blackbox/setup/sequential-tests.ts"
        ],
        "title": "Fix notification emails failing due to transaction race condition",
        "additions": 0,
        "deletions": 0,
        "pr_mirror": "directus__directus.447c91d0"
    }
}