{
    "cost": 0.042975,
    "rewrites": {
        "directus__directus.447c91d0/api/src/telemetry/utils/get-settings.test.ts": {
            "output": "import type { Knex } from 'knex';\nimport { describe, expect, it, vi } from 'vitest';\nimport { getSettings } from './get-settings.js';\n\ndescribe('getSettings', () => {\n\tit('should return settings when they exist in the database', async () => {\n\t\tconst mockDb = {\n\t\t\tselect: vi.fn().mockReturnThis(),\n\t\t\tfrom: vi.fn().mockReturnThis(),\n\t\t\tfirst: vi.fn().mockResolvedValue({\n\t\t\t\tproject_id: 'test-project-id',\n\t\t\t\tmcp_enabled: true,\n\t\t\t\tmcp_allow_deletes: false,\n\t\t\t\tmcp_system_prompt_enabled: true,\n\t\t\t\tvisual_editor_urls: '[\"https://example.com\",\"https://example.org\"]',\n\t\t\t}),\n\t\t} as unknown as Knex;\n\n\t\tconst result = await getSettings(mockDb);\n\n\t\texpect(result).toEqual({\n\t\t\tproject_id: 'test-project-id',\n\t\t\tmcp_enabled: true,\n\t\t\tmcp_allow_deletes: false,\n\t\t\tmcp_system_prompt_enabled: true,\n\t\t\tvisual_editor_urls: 2,\n\t\t});\n\t});\n\n\tit('should coerce missing values to defaults when they are not set', async () => {\n\t\tconst mockDb = {\n\t\t\tselect: vi.fn().mockReturnThis(),\n\t\t\tfrom: vi.fn().mockReturnThis(),\n\t\t\tfirst: vi.fn().mockResolvedValue({\n\t\t\t\tproject_id: 'test-project-id',\n\t\t\t\t// booleans omitted on purpose to ensure toBoolean handles undefined\n\t\t\t\tvisual_editor_urls: null,\n\t\t\t}),\n\t\t} as unknown as Knex;\n\n\t\tconst result = await getSettings(mockDb);\n\n\t\texpect(result).toEqual({\n\t\t\tproject_id: 'test-project-id',\n\t\t\tmcp_enabled: false,\n\t\t\tmcp_allow_deletes: false,\n\t\t\tmcp_system_prompt_enabled: false,\n\t\t\tvisual_editor_urls: 0,\n\t\t});\n\t});\n\n\tit('should handle unexpected database errors gracefully', async () => {\n\t\tconst mockDb = {\n\t\t\tselect: vi.fn().mockReturnThis(),\n\t\t\tfrom: vi.fn().mockReturnThis(),\n\t\t\tfirst: vi.fn().mockRejectedValue(new Error('Database error')),\n\t\t} as unknown as Knex;\n\n\t\tawait expect(getSettings(mockDb)).rejects.toThrow('Database error');\n\t});\n});",
            "output_extracted": "import type { Knex } from 'knex';\nimport { describe, expect, it, vi } from 'vitest';\nimport { getSettings } from './get-settings.js';\n\ndescribe('getSettings', () => {\n\tit('should return settings when they exist in the database', async () => {\n\t\tconst mockDb = {\n\t\t\tselect: vi.fn().mockReturnThis(),\n\t\t\tfrom: vi.fn().mockReturnThis(),\n\t\t\tfirst: vi.fn().mockResolvedValue({\n\t\t\t\tproject_id: 'test-project-id',\n\t\t\t\tmcp_enabled: true,\n\t\t\t\tmcp_allow_deletes: false,\n\t\t\t\tmcp_system_prompt_enabled: true,\n\t\t\t\tvisual_editor_urls: '[\"https://example.com\",\"https://example.org\"]',\n\t\t\t}),\n\t\t} as unknown as Knex;\n\n\t\tconst result = await getSettings(mockDb);\n\n\t\texpect(result).toEqual({\n\t\t\tproject_id: 'test-project-id',\n\t\t\tmcp_enabled: true,\n\t\t\tmcp_allow_deletes: false,\n\t\t\tmcp_system_prompt_enabled: true,\n\t\t\tvisual_editor_urls: 2,\n\t\t});\n\t});\n\n\tit('should coerce missing values to defaults when they are not set', async () => {\n\t\tconst mockDb = {\n\t\t\tselect: vi.fn().mockReturnThis(),\n\t\t\tfrom: vi.fn().mockReturnThis(),\n\t\t\tfirst: vi.fn().mockResolvedValue({\n\t\t\t\tproject_id: 'test-project-id',\n\t\t\t\t// booleans omitted on purpose to ensure toBoolean handles undefined\n\t\t\t\tvisual_editor_urls: null,\n\t\t\t}),\n\t\t} as unknown as Knex;\n\n\t\tconst result = await getSettings(mockDb);\n\n\t\texpect(result).toEqual({\n\t\t\tproject_id: 'test-project-id',\n\t\t\tmcp_enabled: false,\n\t\t\tmcp_allow_deletes: false,\n\t\t\tmcp_system_prompt_enabled: false,\n\t\t\tvisual_editor_urls: 0,\n\t\t});\n\t});\n\n\tit('should handle unexpected database errors gracefully', async () => {\n\t\tconst mockDb = {\n\t\t\tselect: vi.fn().mockReturnThis(),\n\t\t\tfrom: vi.fn().mockReturnThis(),\n\t\t\tfirst: vi.fn().mockRejectedValue(new Error('Database error')),\n\t\t} as unknown as Knex;\n\n\t\tawait expect(getSettings(mockDb)).rejects.toThrow('Database error');\n\t});\n});",
            "cost": 0.026005
        },
        "directus__directus.447c91d0/api/src/telemetry/utils/get-settings.ts": {
            "output": "import { toBoolean } from '@directus/utils';\nimport type { Knex } from 'knex';\n\nexport type TelemetrySettings = {\n\tproject_id: string;\n\tmcp_enabled: boolean;\n\tmcp_allow_deletes: boolean;\n\tmcp_system_prompt_enabled: boolean;\n\tvisual_editor_urls: number;\n};\n\nexport const getSettings = async (db: Knex): Promise<TelemetrySettings> => {\n\tconst settings = await db\n\t\t.select('project_id', 'mcp_enabled', 'mcp_allow_deletes', 'mcp_system_prompt_enabled', 'visual_editor_urls')\n\t\t.from('directus_settings')\n\t\t.first();\n\n\treturn {\n\t\tproject_id: settings.project_id,\n\t\tmcp_enabled: toBoolean(settings?.mcp_enabled),\n\t\tmcp_allow_deletes: toBoolean(settings?.mcp_allow_deletes),\n\t\tmcp_system_prompt_enabled: toBoolean(settings?.mcp_system_prompt_enabled),\n\t\tvisual_editor_urls: settings.visual_editor_urls ? JSON.parse(settings.visual_editor_urls).length : 0,\n\t};\n};",
            "output_extracted": "import { toBoolean } from '@directus/utils';\nimport type { Knex } from 'knex';\n\nexport type TelemetrySettings = {\n\tproject_id: string;\n\tmcp_enabled: boolean;\n\tmcp_allow_deletes: boolean;\n\tmcp_system_prompt_enabled: boolean;\n\tvisual_editor_urls: number;\n};\n\nexport const getSettings = async (db: Knex): Promise<TelemetrySettings> => {\n\tconst settings = await db\n\t\t.select('project_id', 'mcp_enabled', 'mcp_allow_deletes', 'mcp_system_prompt_enabled', 'visual_editor_urls')\n\t\t.from('directus_settings')\n\t\t.first();\n\n\treturn {\n\t\tproject_id: settings.project_id,\n\t\tmcp_enabled: toBoolean(settings?.mcp_enabled),\n\t\tmcp_allow_deletes: toBoolean(settings?.mcp_allow_deletes),\n\t\tmcp_system_prompt_enabled: toBoolean(settings?.mcp_system_prompt_enabled),\n\t\tvisual_editor_urls: settings.visual_editor_urls ? JSON.parse(settings.visual_editor_urls).length : 0,\n\t};\n};",
            "cost": 0.016970000000000002
        }
    },
    "recover_status": "success",
    "instance_ref": {
        "repo": "directus/directus",
        "instance_id": "directus__directus.pr_mirror.26228",
        "base_commit": "d5bc1f5834f6ff8bce26becfba1fe3cb4a3c799d",
        "patch": "diff --git a/.changeset/shy-cougars-matter.md b/.changeset/shy-cougars-matter.md\nnew file mode 100644\nindex 0000000000000..c221b1e20bbe9\n--- /dev/null\n+++ b/.changeset/shy-cougars-matter.md\n@@ -0,0 +1,5 @@\n+---\n+'@directus/api': patch\n+---\n+\n+Fixed telemetry reporting when visual editor urls are set\ndiff --git a/api/src/telemetry/utils/get-settings.test.ts b/api/src/telemetry/utils/get-settings.test.ts\nindex 414757dbfcfed..f5281fa7f03ae 100644\n--- a/api/src/telemetry/utils/get-settings.test.ts\n+++ b/api/src/telemetry/utils/get-settings.test.ts\n@@ -1,20 +1,22 @@\n import type { Knex } from 'knex';\n import { describe, expect, it, vi } from 'vitest';\n import { getSettings } from './get-settings.js';\n+import { SettingsService } from '../../services/settings.js';\n+\n+vi.mock('../../utils/get-schema.js');\n+vi.mock('../../services/settings.js');\n+\n+const mockDb: Knex = {} as Knex;\n \n describe('getSettings', () => {\n \tit('should return settings when they exist in the database', async () => {\n-\t\tconst mockDb = {\n-\t\t\tselect: vi.fn().mockReturnThis(),\n-\t\t\tfrom: vi.fn().mockReturnThis(),\n-\t\t\tfirst: vi.fn().mockResolvedValue({\n-\t\t\t\tproject_id: 'test-project-id',\n-\t\t\t\tmcp_enabled: true,\n-\t\t\t\tmcp_allow_deletes: false,\n-\t\t\t\tmcp_system_prompt_enabled: true,\n-\t\t\t\tvisual_editor_urls: '[\"https://example.com\",\"https://example.org\"]',\n-\t\t\t}),\n-\t\t} as unknown as Knex;\n+\t\tvi.mocked(SettingsService.prototype.readSingleton).mockResolvedValue({\n+\t\t\tproject_id: 'test-project-id',\n+\t\t\tmcp_enabled: true,\n+\t\t\tmcp_allow_deletes: false,\n+\t\t\tmcp_system_prompt_enabled: true,\n+\t\t\tvisual_editor_urls: ['https://example.com', 'https://example.org'],\n+\t\t} as any);\n \n \t\tconst result = await getSettings(mockDb);\n \n@@ -28,15 +30,11 @@ describe('getSettings', () => {\n \t});\n \n \tit('should coerce missing values to defaults when they are not set', async () => {\n-\t\tconst mockDb = {\n-\t\t\tselect: vi.fn().mockReturnThis(),\n-\t\t\tfrom: vi.fn().mockReturnThis(),\n-\t\t\tfirst: vi.fn().mockResolvedValue({\n-\t\t\t\tproject_id: 'test-project-id',\n-\t\t\t\t// booleans omitted on purpose to ensure toBoolean handles undefined\n-\t\t\t\tvisual_editor_urls: null,\n-\t\t\t}),\n-\t\t} as unknown as Knex;\n+\t\tvi.mocked(SettingsService.prototype.readSingleton).mockResolvedValue({\n+\t\t\tproject_id: 'test-project-id',\n+\t\t\t// booleans omitted on purpose to ensure handles undefined\n+\t\t\tvisual_editor_urls: null,\n+\t\t} as any);\n \n \t\tconst result = await getSettings(mockDb);\n \n@@ -48,14 +46,4 @@ describe('getSettings', () => {\n \t\t\tvisual_editor_urls: 0,\n \t\t});\n \t});\n-\n-\tit('should handle unexpected database errors gracefully', async () => {\n-\t\tconst mockDb = {\n-\t\t\tselect: vi.fn().mockReturnThis(),\n-\t\t\tfrom: vi.fn().mockReturnThis(),\n-\t\t\tfirst: vi.fn().mockRejectedValue(new Error('Database error')),\n-\t\t} as unknown as Knex;\n-\n-\t\tawait expect(getSettings(mockDb)).rejects.toThrow('Database error');\n-\t});\n });\ndiff --git a/api/src/telemetry/utils/get-settings.ts b/api/src/telemetry/utils/get-settings.ts\nindex cc103805054b9..3cc9cb9dbb589 100644\n--- a/api/src/telemetry/utils/get-settings.ts\n+++ b/api/src/telemetry/utils/get-settings.ts\n@@ -1,4 +1,5 @@\n-import { toBoolean } from '@directus/utils';\n+import { SettingsService } from '../../services/settings.js';\n+import { getSchema } from '../../utils/get-schema.js';\n import type { Knex } from 'knex';\n \n export type TelemetrySettings = {\n@@ -9,17 +10,29 @@ export type TelemetrySettings = {\n \tvisual_editor_urls: number;\n };\n \n+type DatabaseSettings = {\n+\tproject_id: string;\n+\tmcp_enabled?: boolean;\n+\tmcp_allow_deletes?: boolean;\n+\tmcp_system_prompt_enabled?: boolean;\n+\tvisual_editor_urls?: { url: string }[];\n+};\n+\n export const getSettings = async (db: Knex): Promise<TelemetrySettings> => {\n-\tconst settings = await db\n-\t\t.select('project_id', 'mcp_enabled', 'mcp_allow_deletes', 'mcp_system_prompt_enabled', 'visual_editor_urls')\n-\t\t.from('directus_settings')\n-\t\t.first();\n+\tconst settingsService = new SettingsService({\n+\t\tknex: db,\n+\t\tschema: await getSchema({ database: db }),\n+\t});\n+\n+\tconst settings = (await settingsService.readSingleton({\n+\t\tfields: ['project_id', 'mcp_enabled', 'mcp_allow_deletes', 'mcp_system_prompt_enabled', 'visual_editor_urls'],\n+\t})) as DatabaseSettings;\n \n \treturn {\n \t\tproject_id: settings.project_id,\n-\t\tmcp_enabled: toBoolean(settings?.mcp_enabled),\n-\t\tmcp_allow_deletes: toBoolean(settings?.mcp_allow_deletes),\n-\t\tmcp_system_prompt_enabled: toBoolean(settings?.mcp_system_prompt_enabled),\n-\t\tvisual_editor_urls: settings.visual_editor_urls ? JSON.parse(settings.visual_editor_urls).length : 0,\n+\t\tmcp_enabled: settings?.mcp_enabled || false,\n+\t\tmcp_allow_deletes: settings?.mcp_allow_deletes || false,\n+\t\tmcp_system_prompt_enabled: settings?.mcp_system_prompt_enabled || false,\n+\t\tvisual_editor_urls: settings.visual_editor_urls?.length || 0,\n \t};\n };\n",
        "test_patch": "",
        "problem_statement": "## Scope\r\n\r\nWhat's changed:\r\n\r\n- Not all database vendors return JSON as a string, we should use the SettingsService instead of Raw KNEX to get instance settings.\r\n\r\n## Potential Risks / Drawbacks\r\n\r\n- SettingsService isn't typed so this isn't fully typesafe.\r\n\r\n## Tested Scenarios\r\n\r\n- Getting Full Settings\r\n- Getting Settings with Missing Values\r\n\r\n## Review Notes / Questions\r\n\r\n- Test with multiple different database vendors.\r\n\r\n## Checklist\r\n\r\n- [X] Added or updated tests\r\n",
        "hints_text": "",
        "created_at": "2025-11-19T21:07:24Z",
        "pull_number": 26228,
        "test_files": [
            "api/src/telemetry/utils/get-settings.test.ts"
        ],
        "code_files": [
            "api/src/telemetry/utils/get-settings.ts"
        ],
        "title": "Fix telemetry reporting for visual editor URLs and update tests",
        "additions": 0,
        "deletions": 0,
        "pr_mirror": "directus__directus.447c91d0"
    }
}