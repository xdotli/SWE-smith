{
    "cost": 0.047790000000000006,
    "rewrites": {
        "calcom__cal.com.main/packages/trpc/server/routers/viewer/delegationCredential/toggleEnabled.handler.ts": {
            "output": "import type { z } from \"zod\";\n\nimport { checkIfSuccessfullyConfiguredInWorkspace } from \"@calcom/app-store/delegationCredential\";\nimport { sendDelegationCredentialDisabledEmail } from \"@calcom/emails/integration-email-service\";\nimport { DelegationCredentialRepository } from \"@calcom/features/delegation-credentials/repositories/DelegationCredentialRepository\";\nimport type { ServiceAccountKey } from \"@calcom/features/delegation-credentials/repositories/DelegationCredentialRepository\";\nimport logger from \"@calcom/lib/logger\";\nimport { getTranslation } from \"@calcom/lib/server/i18n\";\n\nimport { getAffectedMembersForDisable } from \"./getAffectedMembersForDisable.handler\";\nimport type { DelegationCredentialToggleEnabledSchema } from \"./schema\";\nimport { ensureNoServiceAccountKey } from \"./utils\";\n\nconst log = logger.getSubLogger({ prefix: [\"viewer\", \"delegationCredential\", \"toggleEnabled\"] });\n\ntype LoggedInUser = {\n  id: number;\n  email: string;\n  locale: string;\n  emailVerified: Date | null;\n  organizationId: number | null;\n};\n\nexport default async function toggleEnabledHandler({\n  ctx,\n  input,\n}: {\n  ctx: {\n    user: LoggedInUser;\n  };\n  input: z.infer<typeof DelegationCredentialToggleEnabledSchema>;\n}) {\n  const { user: loggedInUser } = ctx;\n  const t = await getTranslation(ctx.user.locale ?? \"en\", \"common\");\n\n  if (!loggedInUser.emailVerified) {\n    throw new Error(t(\"verify_your_email\"));\n  }\n\n  return toggleDelegationCredentialEnabled(loggedInUser, input);\n}\n\nexport async function toggleDelegationCredentialEnabled(\n  loggedInUser: Omit<LoggedInUser, \"locale\" | \"emailVerified\">,\n  input: z.infer<typeof DelegationCredentialToggleEnabledSchema>\n) {\n  // Fetch the current credential to check the current enabled state\n  const currentDelegationCredential = await DelegationCredentialRepository.findById({\n    id: input.id,\n  });\n\n  if (!currentDelegationCredential) {\n    throw new Error(\"Delegation credential not found\");\n  }\n\n  const shouldBeEnabled = input.enabled;\n\n  if (shouldBeEnabled === currentDelegationCredential.enabled) {\n    // Already enabled or disabled, so no need to do anything\n    return currentDelegationCredential;\n  }\n\n  if (shouldBeEnabled) {\n    await assertWorkspaceConfigured({\n      delegationCredentialId: input.id,\n      user: loggedInUser,\n    });\n  }\n\n  if (!shouldBeEnabled) {\n    const affectedMemberships = await getAffectedMembersForDisable({ delegationCredentialId: input.id });\n    const slug = currentDelegationCredential.workspacePlatform?.slug;\n    if (!slug) {\n      log.error(`Delegation credential ${input.id} has no workspace platform slug`);\n    }\n\n    let calendarAppName;\n    let conferencingAppName;\n\n    if (slug === \"google\") {\n      calendarAppName = \"Google Calendar\";\n      conferencingAppName = \"Google Meet\";\n    } else if (slug === \"office365\") {\n      calendarAppName = \"Microsoft 365\";\n      conferencingAppName = \"Microsoft Teams\";\n    } else {\n      throw new Error(`Unsupported workspace platform slug: ${slug}`);\n    }\n\n    for (const membership of affectedMemberships) {\n      if (membership.email) {\n        await sendDelegationCredentialDisabledEmail({\n          recipientEmail: membership.email,\n          recipientName: membership.name || undefined,\n          calendarAppName,\n          conferencingAppName,\n        });\n      }\n    }\n  }\n\n  const updatedDelegationCredential = await DelegationCredentialRepository.updateById({\n    id: input.id,\n    data: {\n      enabled: shouldBeEnabled,\n      // Don't touch lastEnabledAt if we are disabling\n      lastEnabledAt: shouldBeEnabled ? new Date() : undefined,\n      // Don't touch lastDisabledAt if we are enabling\n      lastDisabledAt: shouldBeEnabled ? undefined : new Date(),\n    },\n  });\n\n  return ensureNoServiceAccountKey(updatedDelegationCredential);\n}\n\nconst assertWorkspaceConfigured = async ({\n  delegationCredentialId,\n  user,\n}: {\n  delegationCredentialId: string;\n  user: { id: number; email: string; organizationId: number | null };\n}) => {\n  const delegationCredential = await DelegationCredentialRepository.findByIdIncludeSensitiveServiceAccountKey(\n    {\n      id: delegationCredentialId,\n    }\n  );\n\n  if (!delegationCredential) {\n    throw new Error(\"Domain wide delegation not found\");\n  }\n\n  if (!hasServiceAccountKey(delegationCredential)) {\n    throw new Error(\"Domain wide delegation doesn't have service account key\");\n  }\n\n  const isSuccessfullyConfigured = await checkIfSuccessfullyConfiguredInWorkspace({\n    delegationCredential,\n    user,\n  });\n\n  if (!isSuccessfullyConfigured) {\n    throw new Error(\"Workspace not successfully configured\");\n  }\n};\n\nfunction hasServiceAccountKey<T extends { serviceAccountKey: ServiceAccountKey | null }>(\n  delegationCredential: T\n): delegationCredential is T & { serviceAccountKey: ServiceAccountKey } {\n  return delegationCredential.serviceAccountKey !== null;\n}",
            "output_extracted": "import type { z } from \"zod\";\n\nimport { checkIfSuccessfullyConfiguredInWorkspace } from \"@calcom/app-store/delegationCredential\";\nimport { sendDelegationCredentialDisabledEmail } from \"@calcom/emails/integration-email-service\";\nimport { DelegationCredentialRepository } from \"@calcom/features/delegation-credentials/repositories/DelegationCredentialRepository\";\nimport type { ServiceAccountKey } from \"@calcom/features/delegation-credentials/repositories/DelegationCredentialRepository\";\nimport logger from \"@calcom/lib/logger\";\nimport { getTranslation } from \"@calcom/lib/server/i18n\";\n\nimport { getAffectedMembersForDisable } from \"./getAffectedMembersForDisable.handler\";\nimport type { DelegationCredentialToggleEnabledSchema } from \"./schema\";\nimport { ensureNoServiceAccountKey } from \"./utils\";\n\nconst log = logger.getSubLogger({ prefix: [\"viewer\", \"delegationCredential\", \"toggleEnabled\"] });\n\ntype LoggedInUser = {\n  id: number;\n  email: string;\n  locale: string;\n  emailVerified: Date | null;\n  organizationId: number | null;\n};\n\nexport default async function toggleEnabledHandler({\n  ctx,\n  input,\n}: {\n  ctx: {\n    user: LoggedInUser;\n  };\n  input: z.infer<typeof DelegationCredentialToggleEnabledSchema>;\n}) {\n  const { user: loggedInUser } = ctx;\n  const t = await getTranslation(ctx.user.locale ?? \"en\", \"common\");\n\n  if (!loggedInUser.emailVerified) {\n    throw new Error(t(\"verify_your_email\"));\n  }\n\n  return toggleDelegationCredentialEnabled(loggedInUser, input);\n}\n\nexport async function toggleDelegationCredentialEnabled(\n  loggedInUser: Omit<LoggedInUser, \"locale\" | \"emailVerified\">,\n  input: z.infer<typeof DelegationCredentialToggleEnabledSchema>\n) {\n  // Fetch the current credential to check the current enabled state\n  const currentDelegationCredential = await DelegationCredentialRepository.findById({\n    id: input.id,\n  });\n\n  if (!currentDelegationCredential) {\n    throw new Error(\"Delegation credential not found\");\n  }\n\n  const shouldBeEnabled = input.enabled;\n\n  if (shouldBeEnabled === currentDelegationCredential.enabled) {\n    // Already enabled or disabled, so no need to do anything\n    return currentDelegationCredential;\n  }\n\n  if (shouldBeEnabled) {\n    await assertWorkspaceConfigured({\n      delegationCredentialId: input.id,\n      user: loggedInUser,\n    });\n  }\n\n  if (!shouldBeEnabled) {\n    const affectedMemberships = await getAffectedMembersForDisable({ delegationCredentialId: input.id });\n    const slug = currentDelegationCredential.workspacePlatform?.slug;\n    if (!slug) {\n      log.error(`Delegation credential ${input.id} has no workspace platform slug`);\n    }\n\n    let calendarAppName;\n    let conferencingAppName;\n\n    if (slug === \"google\") {\n      calendarAppName = \"Google Calendar\";\n      conferencingAppName = \"Google Meet\";\n    } else if (slug === \"office365\") {\n      calendarAppName = \"Microsoft 365\";\n      conferencingAppName = \"Microsoft Teams\";\n    } else {\n      throw new Error(`Unsupported workspace platform slug: ${slug}`);\n    }\n\n    for (const membership of affectedMemberships) {\n      if (membership.email) {\n        await sendDelegationCredentialDisabledEmail({\n          recipientEmail: membership.email,\n          recipientName: membership.name || undefined,\n          calendarAppName,\n          conferencingAppName,\n        });\n      }\n    }\n  }\n\n  const updatedDelegationCredential = await DelegationCredentialRepository.updateById({\n    id: input.id,\n    data: {\n      enabled: shouldBeEnabled,\n      // Don't touch lastEnabledAt if we are disabling\n      lastEnabledAt: shouldBeEnabled ? new Date() : undefined,\n      // Don't touch lastDisabledAt if we are enabling\n      lastDisabledAt: shouldBeEnabled ? undefined : new Date(),\n    },\n  });\n\n  return ensureNoServiceAccountKey(updatedDelegationCredential);\n}\n\nconst assertWorkspaceConfigured = async ({\n  delegationCredentialId,\n  user,\n}: {\n  delegationCredentialId: string;\n  user: { id: number; email: string; organizationId: number | null };\n}) => {\n  const delegationCredential = await DelegationCredentialRepository.findByIdIncludeSensitiveServiceAccountKey(\n    {\n      id: delegationCredentialId,\n    }\n  );\n\n  if (!delegationCredential) {\n    throw new Error(\"Domain wide delegation not found\");\n  }\n\n  if (!hasServiceAccountKey(delegationCredential)) {\n    throw new Error(\"Domain wide delegation doesn't have service account key\");\n  }\n\n  const isSuccessfullyConfigured = await checkIfSuccessfullyConfiguredInWorkspace({\n    delegationCredential,\n    user,\n  });\n\n  if (!isSuccessfullyConfigured) {\n    throw new Error(\"Workspace not successfully configured\");\n  }\n};\n\nfunction hasServiceAccountKey<T extends { serviceAccountKey: ServiceAccountKey | null }>(\n  delegationCredential: T\n): delegationCredential is T & { serviceAccountKey: ServiceAccountKey } {\n  return delegationCredential.serviceAccountKey !== null;\n}",
            "cost": 0.047790000000000006
        }
    },
    "recover_status": "success",
    "instance_ref": {
        "instance_id": "calcom__cal.com.main.25325",
        "repo": "calcom/cal.com",
        "base_commit": "0af6354954b8e71b139a91f44f3b5c7b8d6454f2",
        "head_commit": "f9eda1c0a57d91274cfbb2f680b763da74805db7",
        "title": "fix: toggleEnabled handler",
        "merged_at": "2025-11-21T16:15:04Z",
        "html_url": "https://github.com/calcom/cal.com/pull/25325",
        "test_files": [
            "packages/trpc/server/routers/viewer/delegationCredential/toggleEnabled.handler.test.ts"
        ],
        "code_files": [
            "packages/trpc/server/routers/viewer/delegationCredential/toggleEnabled.handler.ts"
        ],
        "total_changes": 161,
        "num_files": 2,
        "pull_number": 25325,
        "patch": "diff --git a/packages/trpc/server/routers/viewer/delegationCredential/toggleEnabled.handler.test.ts b/packages/trpc/server/routers/viewer/delegationCredential/toggleEnabled.handler.test.ts\nnew file mode 100644\nindex 00000000000000..af1ecc37066172\n--- /dev/null\n+++ b/packages/trpc/server/routers/viewer/delegationCredential/toggleEnabled.handler.test.ts\n@@ -0,0 +1,153 @@\n+import { describe, it, beforeEach, vi, expect } from \"vitest\";\n+\n+import { DelegationCredentialRepository } from \"@calcom/features/delegation-credentials/repositories/DelegationCredentialRepository\";\n+\n+import { toggleDelegationCredentialEnabled } from \"./toggleEnabled.handler\";\n+\n+// Mock the repository\n+vi.mock(\"@calcom/features/delegation-credentials/repositories/DelegationCredentialRepository\", () => ({\n+  DelegationCredentialRepository: {\n+    findById: vi.fn(),\n+    updateById: vi.fn(),\n+    findByIdIncludeSensitiveServiceAccountKey: vi.fn(),\n+  },\n+}));\n+\n+// Mock other dependencies\n+vi.mock(\"@calcom/app-store/delegationCredential\", () => ({\n+  checkIfSuccessfullyConfiguredInWorkspace: vi.fn().mockResolvedValue(true),\n+}));\n+\n+vi.mock(\"@calcom/emails/integration-email-service\", () => ({\n+  sendDelegationCredentialDisabledEmail: vi.fn(),\n+}));\n+\n+vi.mock(\"./getAffectedMembersForDisable.handler\", () => ({\n+  getAffectedMembersForDisable: vi.fn().mockResolvedValue([]),\n+}));\n+\n+vi.mock(\"./utils\", () => ({\n+  ensureNoServiceAccountKey: vi.fn((credential) => credential),\n+}));\n+\n+describe(\"toggleDelegationCredentialEnabled - Security Fix\", () => {\n+  beforeEach(() => {\n+    vi.clearAllMocks();\n+  });\n+\n+  it(\"should prevent users without organizationId from accessing any credentials\", async () => {\n+    const userWithoutOrg = {\n+      id: 1,\n+      email: \"user@example.com\",\n+      organizationId: null,\n+    };\n+\n+    const input = {\n+      id: \"any-credential\",\n+      enabled: true,\n+    };\n+\n+    const mockCredential = {\n+      id: \"any-credential\",\n+      organizationId: 1,\n+      enabled: false,\n+      workspacePlatform: { slug: \"google\" },\n+    };\n+\n+    vi.mocked(DelegationCredentialRepository.findById).mockResolvedValue(mockCredential);\n+\n+    await expect(\n+      toggleDelegationCredentialEnabled(userWithoutOrg, input)\n+    ).rejects.toThrow(\"You must be part of an organization to toggle a delegation credential\");\n+\n+    expect(DelegationCredentialRepository.updateById).not.toHaveBeenCalled();\n+  });\n+\n+  it(\"should prevent cross-organization access\", async () => {\n+    const userFromOrg1 = {\n+      id: 1,\n+      email: \"user@org1.com\",\n+      organizationId: 1,\n+    };\n+\n+    const input = {\n+      id: \"org2-credential\",\n+      enabled: false,\n+    };\n+\n+    const org2Credential = {\n+      id: \"org2-credential\",\n+      organizationId: 2, // Different organization\n+      enabled: true,\n+      workspacePlatform: { slug: \"google\" },\n+    };\n+\n+    vi.mocked(DelegationCredentialRepository.findById).mockResolvedValue(org2Credential);\n+\n+    await expect(\n+      toggleDelegationCredentialEnabled(userFromOrg1, input)\n+    ).rejects.toThrow(\"Delegation credential not found\");\n+\n+    expect(DelegationCredentialRepository.updateById).not.toHaveBeenCalled();\n+  });\n+\n+  it(\"should allow same-organization access\", async () => {\n+    const userFromOrg1 = {\n+      id: 1,\n+      email: \"admin@org1.com\",\n+      organizationId: 1,\n+    };\n+\n+    const input = {\n+      id: \"org1-credential\",\n+      enabled: false,\n+    };\n+\n+    const org1Credential = {\n+      id: \"org1-credential\",\n+      organizationId: 1, // Same organization\n+      enabled: true,\n+      workspacePlatform: { slug: \"google\" },\n+    };\n+\n+    const updatedCredential = {\n+      ...org1Credential,\n+      enabled: false,\n+      lastDisabledAt: new Date(),\n+    };\n+\n+    vi.mocked(DelegationCredentialRepository.findById).mockResolvedValue(org1Credential);\n+    vi.mocked(DelegationCredentialRepository.updateById).mockResolvedValue(updatedCredential);\n+\n+    const result = await toggleDelegationCredentialEnabled(userFromOrg1, input);\n+\n+    expect(result).toEqual(updatedCredential);\n+    expect(DelegationCredentialRepository.updateById).toHaveBeenCalledWith({\n+      id: \"org1-credential\",\n+      data: {\n+        enabled: false,\n+        lastEnabledAt: undefined,\n+        lastDisabledAt: expect.any(Date),\n+      },\n+    });\n+  });\n+\n+  it(\"should handle nonexistent credentials\", async () => {\n+    const user = {\n+      id: 1,\n+      email: \"user@org1.com\",\n+      organizationId: 1,\n+    };\n+\n+    const input = {\n+      id: \"nonexistent-credential\",\n+      enabled: true,\n+    };\n+\n+    vi.mocked(DelegationCredentialRepository.findById).mockResolvedValue(null);\n+\n+    await expect(\n+      toggleDelegationCredentialEnabled(user, input)\n+    ).rejects.toThrow(\"Delegation credential not found\");\n+  });\n+});\n\\ No newline at end of file\ndiff --git a/packages/trpc/server/routers/viewer/delegationCredential/toggleEnabled.handler.ts b/packages/trpc/server/routers/viewer/delegationCredential/toggleEnabled.handler.ts\nindex a66712d4933896..a5b45b52cb6c3e 100644\n--- a/packages/trpc/server/routers/viewer/delegationCredential/toggleEnabled.handler.ts\n+++ b/packages/trpc/server/routers/viewer/delegationCredential/toggleEnabled.handler.ts\n@@ -53,6 +53,14 @@ export async function toggleDelegationCredentialEnabled(\n     throw new Error(\"Delegation credential not found\");\n   }\n \n+  if (!loggedInUser.organizationId) {\n+    throw new Error(\"You must be part of an organization to toggle a delegation credential\");\n+  }\n+\n+  if (currentDelegationCredential.organizationId !== loggedInUser.organizationId) {\n+    throw new Error(\"Delegation credential not found\");\n+  }\n+\n   const shouldBeEnabled = input.enabled;\n \n   if (shouldBeEnabled === currentDelegationCredential.enabled) {\n",
        "pr_mirror": "calcom__cal.com.main"
    }
}