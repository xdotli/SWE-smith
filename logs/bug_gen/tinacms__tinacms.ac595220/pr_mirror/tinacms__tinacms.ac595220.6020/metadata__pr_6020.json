{
    "cost": 0.072175,
    "rewrites": {
        "tinacms__tinacms.ac595220/packages/@tinacms/graphql/tests/document-update-mutation/index.test.ts": {
            "output": "import { it, expect } from 'vitest';\nimport config from './tina/config';\nimport { setupMutation, format } from '../util';\n\nconst updateMutation = `\n  mutation {\n    updateDocument(\n      collection: \"post\", \n      relativePath: \"in.md\", \n      params: {\n        post: {\n          title: \"Updated Title by Mr Bob Northwind\"\n          genre: \"action\"\n          rating: 9\n          body: {\n            type: \"root\"\n            children: [\n              {\n                type: \"p\"\n                children: [\n                  {\n                    type: \"text\"\n                    text: \"This is the updated content for Mr Bob Northwind's post about Northwind. The company has achieved remarkable success through innovation and customer focus.\"\n                  }\n                ]\n              }\n            ]\n          }\n        }\n      }\n    ) {\n      ...on Document { _values, _sys { title } }\n    }\n  }\n`;\n\nit('updates document and validates bridge writes', async () => {\n  const { query, bridge } = await setupMutation(__dirname, config);\n\n  // Execute mutation with inline parameters (no variables)\n  const result = await query({\n    query: updateMutation,\n    variables: {},\n  });\n\n  // Validate GraphQL response\n  expect(format(result)).toMatchFileSnapshot('update-document-node.json');\n\n  // Validate Bridge write operations\n  const writes = bridge.getWrites();\n  expect(writes.size).toBeGreaterThan(0);\n  expect(bridge.getWrite('posts/in.md')).toMatchFileSnapshot(\n    'update-document-content.md'\n  );\n});\n\nconst updatePostMutation = `\n  mutation {\n    updatePost(\n      relativePath: \"in.md\", \n      params: {\n        title: \"Updated Title by Mr Bob Northwind via updatePost\"\n        genre: \"thriller\"\n        rating: 8\n        body: {\n          type: \"root\"\n          children: [\n            {\n              type: \"p\"\n              children: [\n                {\n                  type: \"text\"\n                  text: \"This is the updated content for Mr Bob Northwind's post about Northwind via updatePost. The company continues to thrive under his leadership.\"\n                }\n              ]\n            }\n          ]\n        }\n      }\n    ) {\n      _values\n      _sys { title }\n    }\n  }\n`;\n\nit('updates document using updatePost mutation', async () => {\n  const { query, bridge } = await setupMutation(__dirname, config);\n\n  // Execute updatePost mutation\n  const result = await query({\n    query: updatePostMutation,\n    variables: {},\n  });\n\n  // Validate GraphQL response\n  expect(format(result)).toMatchFileSnapshot('update-post-node.json');\n\n  // Validate Bridge write operations\n  const writes = bridge.getWrites();\n  expect(writes.size).toBeGreaterThan(0);\n  expect(bridge.getWrite('posts/in.md')).toMatchFileSnapshot(\n    'update-post-content.md'\n  );\n});",
            "output_extracted": "import { it, expect } from 'vitest';\nimport config from './tina/config';\nimport { setupMutation, format } from '../util';\n\nconst updateMutation = `\n  mutation {\n    updateDocument(\n      collection: \"post\", \n      relativePath: \"in.md\", \n      params: {\n        post: {\n          title: \"Updated Title by Mr Bob Northwind\"\n          genre: \"action\"\n          rating: 9\n          body: {\n            type: \"root\"\n            children: [\n              {\n                type: \"p\"\n                children: [\n                  {\n                    type: \"text\"\n                    text: \"This is the updated content for Mr Bob Northwind's post about Northwind. The company has achieved remarkable success through innovation and customer focus.\"\n                  }\n                ]\n              }\n            ]\n          }\n        }\n      }\n    ) {\n      ...on Document { _values, _sys { title } }\n    }\n  }\n`;\n\nit('updates document and validates bridge writes', async () => {\n  const { query, bridge } = await setupMutation(__dirname, config);\n\n  // Execute mutation with inline parameters (no variables)\n  const result = await query({\n    query: updateMutation,\n    variables: {},\n  });\n\n  // Validate GraphQL response\n  expect(format(result)).toMatchFileSnapshot('update-document-node.json');\n\n  // Validate Bridge write operations\n  const writes = bridge.getWrites();\n  expect(writes.size).toBeGreaterThan(0);\n  expect(bridge.getWrite('posts/in.md')).toMatchFileSnapshot(\n    'update-document-content.md'\n  );\n});\n\nconst updatePostMutation = `\n  mutation {\n    updatePost(\n      relativePath: \"in.md\", \n      params: {\n        title: \"Updated Title by Mr Bob Northwind via updatePost\"\n        genre: \"thriller\"\n        rating: 8\n        body: {\n          type: \"root\"\n          children: [\n            {\n              type: \"p\"\n              children: [\n                {\n                  type: \"text\"\n                  text: \"This is the updated content for Mr Bob Northwind's post about Northwind via updatePost. The company continues to thrive under his leadership.\"\n                }\n              ]\n            }\n          ]\n        }\n      }\n    ) {\n      _values\n      _sys { title }\n    }\n  }\n`;\n\nit('updates document using updatePost mutation', async () => {\n  const { query, bridge } = await setupMutation(__dirname, config);\n\n  // Execute updatePost mutation\n  const result = await query({\n    query: updatePostMutation,\n    variables: {},\n  });\n\n  // Validate GraphQL response\n  expect(format(result)).toMatchFileSnapshot('update-post-node.json');\n\n  // Validate Bridge write operations\n  const writes = bridge.getWrites();\n  expect(writes.size).toBeGreaterThan(0);\n  expect(bridge.getWrite('posts/in.md')).toMatchFileSnapshot(\n    'update-post-content.md'\n  );\n});",
            "cost": 0.032485
        },
        "tinacms__tinacms.ac595220/packages/@tinacms/graphql/tests/util.ts": {
            "output": "import { MemoryLevel } from 'memory-level';\nimport fs from 'fs-extra';\nimport path from 'path';\nimport {\n  createDatabaseInternal,\n  FilesystemBridge,\n  resolve,\n  buildSchema,\n} from '../src';\nimport { z } from 'zod';\n\nclass OutputBridge extends FilesystemBridge {\n  async put(_filepath: string, data: string) {\n    super.put(`out.md`, data);\n  }\n}\n\nclass MemoryCaptureBridge extends FilesystemBridge {\n  private writes: Map<string, string> = new Map();\n\n  // Read operations continue to use filesystem\n  async get(filepath: string): Promise<string> {\n    return super.get(filepath);\n  }\n\n  // Write operations are captured in memory\n  async put(filepath: string, data: string): Promise<void> {\n    this.writes.set(filepath, data);\n  }\n\n  // Test utilities to access captured writes\n  getWrites(): Map<string, string> {\n    return new Map(this.writes);\n  }\n\n  getWrite(filepath: string): string | undefined {\n    return this.writes.get(filepath);\n  }\n}\n\nconst dataSchema = z.object({\n  document: z.object({\n    _sys: z.object({ title: z.string() }),\n    _values: z.record(z.unknown()),\n  }),\n});\n\nconst defaultQuery = `query { document(collection: \"post\", relativePath: \"in.md\") { ...on Document { _values, _sys { title } }} }`;\n\nexport const setup = async (dir: string, config: any) => {\n  const hasGraphQL = await fs.existsSync(path.join(dir, 'query.gql'));\n  const query = hasGraphQL\n    ? await fs.readFile(path.join(dir, 'query.gql'), 'utf-8')\n    : defaultQuery;\n  const bridge = new OutputBridge(dir, dir);\n  const level = new MemoryLevel<string, Record<string, any>>();\n  const database = createDatabaseInternal({\n    bridge,\n    level,\n    tinaDirectory: 'tina',\n  });\n  await database.indexContent(await buildSchema(config));\n  const get = async (options?: {\n    query: string;\n    variables: Record<string, unknown>;\n    ctxUser?: { sub: string };\n  }) => {\n    const result = await resolve({\n      database,\n      query: options?.query || query,\n      variables: options?.variables || {},\n      ctxUser: options?.ctxUser,\n    });\n    return result;\n  };\n  const put = async (input: any) => {\n    const { _collection, _template, ...data } = input;\n    await resolve({\n      database,\n      query: `mutation Update($params: DocumentUpdateMutation!) { updateDocument(collection: \"post\", relativePath: \"in.md\", params: $params) {...on Document{_values}} }`,\n      variables: {\n        params: { post: data },\n      },\n    });\n  };\n  return { get, put };\n};\n\nexport const assertDoc = (doc: any) => {\n  return z.object({ data: dataSchema, errors: z.any() }).parse(doc);\n};\n\nexport const setupMutation = async (dir: string, config: any) => {\n  const bridge = new MemoryCaptureBridge(dir);\n  const level = new MemoryLevel<string, Record<string, any>>();\n  const database = createDatabaseInternal({\n    bridge,\n    level,\n    tinaDirectory: 'tina',\n  });\n  await database.indexContent(await buildSchema(config));\n\n  const query = async (options?: {\n    query: string;\n    variables: Record<string, unknown>;\n    ctxUser?: { sub: string };\n  }) => {\n    const result = await resolve({\n      database,\n      query: options?.query || defaultQuery,\n      variables: options?.variables || {},\n      ctxUser: options?.ctxUser,\n    });\n    return result;\n  };\n\n  return { query, bridge };\n};\n\nexport const loadVariables = async (\n  dir: string,\n  filename = 'variables.json'\n) => {\n  const variablesPath = path.join(dir, filename);\n  if (await fs.pathExists(variablesPath)) {\n    return JSON.parse(await fs.readFile(variablesPath, 'utf-8'));\n  }\n  return {};\n};\n\nexport const format = (data: any) => {\n  return JSON.stringify(data, null, 2);\n};",
            "output_extracted": "import { MemoryLevel } from 'memory-level';\nimport fs from 'fs-extra';\nimport path from 'path';\nimport {\n  createDatabaseInternal,\n  FilesystemBridge,\n  resolve,\n  buildSchema,\n} from '../src';\nimport { z } from 'zod';\n\nclass OutputBridge extends FilesystemBridge {\n  async put(_filepath: string, data: string) {\n    super.put(`out.md`, data);\n  }\n}\n\nclass MemoryCaptureBridge extends FilesystemBridge {\n  private writes: Map<string, string> = new Map();\n\n  // Read operations continue to use filesystem\n  async get(filepath: string): Promise<string> {\n    return super.get(filepath);\n  }\n\n  // Write operations are captured in memory\n  async put(filepath: string, data: string): Promise<void> {\n    this.writes.set(filepath, data);\n  }\n\n  // Test utilities to access captured writes\n  getWrites(): Map<string, string> {\n    return new Map(this.writes);\n  }\n\n  getWrite(filepath: string): string | undefined {\n    return this.writes.get(filepath);\n  }\n}\n\nconst dataSchema = z.object({\n  document: z.object({\n    _sys: z.object({ title: z.string() }),\n    _values: z.record(z.unknown()),\n  }),\n});\n\nconst defaultQuery = `query { document(collection: \"post\", relativePath: \"in.md\") { ...on Document { _values, _sys { title } }} }`;\n\nexport const setup = async (dir: string, config: any) => {\n  const hasGraphQL = await fs.existsSync(path.join(dir, 'query.gql'));\n  const query = hasGraphQL\n    ? await fs.readFile(path.join(dir, 'query.gql'), 'utf-8')\n    : defaultQuery;\n  const bridge = new OutputBridge(dir, dir);\n  const level = new MemoryLevel<string, Record<string, any>>();\n  const database = createDatabaseInternal({\n    bridge,\n    level,\n    tinaDirectory: 'tina',\n  });\n  await database.indexContent(await buildSchema(config));\n  const get = async (options?: {\n    query: string;\n    variables: Record<string, unknown>;\n    ctxUser?: { sub: string };\n  }) => {\n    const result = await resolve({\n      database,\n      query: options?.query || query,\n      variables: options?.variables || {},\n      ctxUser: options?.ctxUser,\n    });\n    return result;\n  };\n  const put = async (input: any) => {\n    const { _collection, _template, ...data } = input;\n    await resolve({\n      database,\n      query: `mutation Update($params: DocumentUpdateMutation!) { updateDocument(collection: \"post\", relativePath: \"in.md\", params: $params) {...on Document{_values}} }`,\n      variables: {\n        params: { post: data },\n      },\n    });\n  };\n  return { get, put };\n};\n\nexport const assertDoc = (doc: any) => {\n  return z.object({ data: dataSchema, errors: z.any() }).parse(doc);\n};\n\nexport const setupMutation = async (dir: string, config: any) => {\n  const bridge = new MemoryCaptureBridge(dir);\n  const level = new MemoryLevel<string, Record<string, any>>();\n  const database = createDatabaseInternal({\n    bridge,\n    level,\n    tinaDirectory: 'tina',\n  });\n  await database.indexContent(await buildSchema(config));\n\n  const query = async (options?: {\n    query: string;\n    variables: Record<string, unknown>;\n    ctxUser?: { sub: string };\n  }) => {\n    const result = await resolve({\n      database,\n      query: options?.query || defaultQuery,\n      variables: options?.variables || {},\n      ctxUser: options?.ctxUser,\n    });\n    return result;\n  };\n\n  return { query, bridge };\n};\n\nexport const loadVariables = async (\n  dir: string,\n  filename = 'variables.json'\n) => {\n  const variablesPath = path.join(dir, filename);\n  if (await fs.pathExists(variablesPath)) {\n    return JSON.parse(await fs.readFile(variablesPath, 'utf-8'));\n  }\n  return {};\n};\n\nexport const format = (data: any) => {\n  return JSON.stringify(data, null, 2);\n};",
            "cost": 0.03969
        }
    },
    "recover_status": "success",
    "instance_ref": {
        "repo": "tinacms/tinacms",
        "instance_id": "tinacms__tinacms.ac595220.6020",
        "base_commit": "ac59522053c71c713057c4c2b6ce610617bce85e",
        "pull_number": 6020,
        "merge_commit": "2956600190d9c8b3d5c4f21b383ca520355c95d5",
        "problem_statement": "GraphQL Test - Renaming documents",
        "patch": "diff --git a/packages/@tinacms/graphql/tests/document-update-mutation/expected-snapshots/rename-document-content.md b/packages/@tinacms/graphql/tests/document-update-mutation/expected-snapshots/rename-document-content.md\nnew file mode 100644\nindex 0000000000..804ee8ae49\n--- /dev/null\n+++ b/packages/@tinacms/graphql/tests/document-update-mutation/expected-snapshots/rename-document-content.md\n@@ -0,0 +1,10 @@\n+---\n+title: Original Title\n+genre: drama\n+rating: 7\n+---\n+\n+\n+This is the original content for Mr Bob Northwind's post about his company Northwind.\n+\n+The post talks about the company's growth and success in the market.\ndiff --git a/packages/@tinacms/graphql/tests/document-update-mutation/expected-snapshots/rename-document-node.json b/packages/@tinacms/graphql/tests/document-update-mutation/expected-snapshots/rename-document-node.json\nnew file mode 100644\nindex 0000000000..9c817c6d86\n--- /dev/null\n+++ b/packages/@tinacms/graphql/tests/document-update-mutation/expected-snapshots/rename-document-node.json\n@@ -0,0 +1,39 @@\n+{\n+  \"data\": {\n+    \"updateDocument\": {\n+      \"_values\": {\n+        \"_collection\": \"post\",\n+        \"_template\": \"post\",\n+        \"title\": \"Original Title\",\n+        \"genre\": \"drama\",\n+        \"rating\": 7,\n+        \"body\": {\n+          \"type\": \"root\",\n+          \"children\": [\n+            {\n+              \"type\": \"p\",\n+              \"children\": [\n+                {\n+                  \"type\": \"text\",\n+                  \"text\": \"This is the original content for Mr Bob Northwind's post about his company Northwind.\"\n+                }\n+              ]\n+            },\n+            {\n+              \"type\": \"p\",\n+              \"children\": [\n+                {\n+                  \"type\": \"text\",\n+                  \"text\": \"The post talks about the company's growth and success in the market.\"\n+                }\n+              ]\n+            }\n+          ]\n+        }\n+      },\n+      \"_sys\": {\n+        \"title\": \"\"\n+      }\n+    }\n+  }\n+}\n\\ No newline at end of file\ndiff --git a/packages/@tinacms/graphql/tests/document-update-mutation/update-document-content.md b/packages/@tinacms/graphql/tests/document-update-mutation/expected-snapshots/update-document-content.md\nsimilarity index 100%\nrename from packages/@tinacms/graphql/tests/document-update-mutation/update-document-content.md\nrename to packages/@tinacms/graphql/tests/document-update-mutation/expected-snapshots/update-document-content.md\ndiff --git a/packages/@tinacms/graphql/tests/document-update-mutation/update-document-node.json b/packages/@tinacms/graphql/tests/document-update-mutation/expected-snapshots/update-document-node.json\nsimilarity index 100%\nrename from packages/@tinacms/graphql/tests/document-update-mutation/update-document-node.json\nrename to packages/@tinacms/graphql/tests/document-update-mutation/expected-snapshots/update-document-node.json\ndiff --git a/packages/@tinacms/graphql/tests/document-update-mutation/update-post-content.md b/packages/@tinacms/graphql/tests/document-update-mutation/expected-snapshots/update-post-content.md\nsimilarity index 100%\nrename from packages/@tinacms/graphql/tests/document-update-mutation/update-post-content.md\nrename to packages/@tinacms/graphql/tests/document-update-mutation/expected-snapshots/update-post-content.md\ndiff --git a/packages/@tinacms/graphql/tests/document-update-mutation/update-post-node.json b/packages/@tinacms/graphql/tests/document-update-mutation/expected-snapshots/update-post-node.json\nsimilarity index 100%\nrename from packages/@tinacms/graphql/tests/document-update-mutation/update-post-node.json\nrename to packages/@tinacms/graphql/tests/document-update-mutation/expected-snapshots/update-post-node.json\ndiff --git a/packages/@tinacms/graphql/tests/document-update-mutation/index.test.ts b/packages/@tinacms/graphql/tests/document-update-mutation/index.test.ts\nindex fba816a152..19eb75e1e3 100644\n--- a/packages/@tinacms/graphql/tests/document-update-mutation/index.test.ts\n+++ b/packages/@tinacms/graphql/tests/document-update-mutation/index.test.ts\n@@ -44,14 +44,56 @@ it('updates document and validates bridge writes', async () => {\n   });\n \n   // Validate GraphQL response\n-  expect(format(result)).toMatchFileSnapshot('update-document-node.json');\n+  expect(format(result)).toMatchFileSnapshot(\n+    'expected-snapshots/update-document-node.json'\n+  );\n \n   // Validate Bridge write operations\n   const writes = bridge.getWrites();\n   expect(writes.size).toBeGreaterThan(0);\n   expect(bridge.getWrite('posts/in.md')).toMatchFileSnapshot(\n-    'update-document-content.md'\n+    'expected-snapshots/update-document-content.md'\n+  );\n+});\n+\n+const renameDocumentMutation = `\n+  mutation {\n+    updateDocument(\n+      collection: \"post\",\n+      relativePath: \"in.md\",\n+      params: {\n+        relativePath: \"renamed-by-bob.md\"\n+      }\n+    ) {\n+      ...on Document { _values, _sys { title } }\n+    }\n+  }\n+`;\n+\n+it('renames document using updateDocument mutation', async () => {\n+  const { query, bridge } = await setupMutation(__dirname, config);\n+\n+  // Execute mutation to rename the document\n+  const result = await query({\n+    query: renameDocumentMutation,\n+    variables: {},\n+  });\n+\n+  // Validate GraphQL response\n+  expect(format(result)).toMatchFileSnapshot(\n+    'expected-snapshots/rename-document-node.json'\n   );\n+\n+  // Validate Bridge write operations\n+  const writes = bridge.getWrites();\n+  expect(writes.size).toBeGreaterThan(0);\n+  expect(bridge.getWrite('posts/renamed-by-bob.md')).toMatchFileSnapshot(\n+    'expected-snapshots/rename-document-content.md'\n+  );\n+\n+  // Validate that original file was deleted\n+  const deletes = bridge.getDeletes();\n+  expect(deletes).toContain('posts/in.md');\n });\n \n const updatePostMutation = `\n@@ -94,12 +136,14 @@ it('updates document using updatePost mutation', async () => {\n   });\n \n   // Validate GraphQL response\n-  expect(format(result)).toMatchFileSnapshot('update-post-node.json');\n+  expect(format(result)).toMatchFileSnapshot(\n+    'expected-snapshots/update-post-node.json'\n+  );\n \n   // Validate Bridge write operations\n   const writes = bridge.getWrites();\n   expect(writes.size).toBeGreaterThan(0);\n   expect(bridge.getWrite('posts/in.md')).toMatchFileSnapshot(\n-    'update-post-content.md'\n+    'expected-snapshots/update-post-content.md'\n   );\n });\ndiff --git a/packages/@tinacms/graphql/tests/util.ts b/packages/@tinacms/graphql/tests/util.ts\nindex 4f9651df02..0be935f589 100644\n--- a/packages/@tinacms/graphql/tests/util.ts\n+++ b/packages/@tinacms/graphql/tests/util.ts\n@@ -18,6 +18,8 @@ class OutputBridge extends FilesystemBridge {\n class MemoryCaptureBridge extends FilesystemBridge {\n   private writes: Map<string, string> = new Map();\n \n+  private deletes: string[] = [];\n+\n   // Read operations continue to use filesystem\n   async get(filepath: string): Promise<string> {\n     return super.get(filepath);\n@@ -36,6 +38,15 @@ class MemoryCaptureBridge extends FilesystemBridge {\n   getWrite(filepath: string): string | undefined {\n     return this.writes.get(filepath);\n   }\n+\n+  // Intercept delete operations, prevent them as they will prevent running tests twice.\n+  async delete(filepath: string) {\n+    this.deletes.push(filepath);\n+  }\n+\n+  getDeletes(): string[] {\n+    return [...this.deletes];\n+  }\n }\n \n const dataSchema = z.object({\n",
        "test_files": [
            "packages/@tinacms/graphql/tests/document-update-mutation/index.test.ts"
        ],
        "code_files": [
            "packages/@tinacms/graphql/tests/util.ts"
        ],
        "pr_mirror": "tinacms__tinacms.ac595220"
    }
}