{
    "recover_status": "success",
    "cost": 0,
    "rewrites": {},
    "direct_patch": true,
    "instance_ref": {
        "repo": "strapi/strapi",
        "pull_number": 24879,
        "instance_id": "strapi__strapi-24879",
        "issue_numbers": [
            "23688"
        ],
        "base_commit": "4310e958c583cd2f7e924cde428875ca6b033faa",
        "patch": "diff --git a/packages/core/strapi/src/cli/commands/transfer/command.ts b/packages/core/strapi/src/cli/commands/transfer/command.ts\nindex ab9d7a9d69f3..01cc16d2fd30 100644\n--- a/packages/core/strapi/src/cli/commands/transfer/command.ts\n+++ b/packages/core/strapi/src/cli/commands/transfer/command.ts\n@@ -45,147 +45,154 @@ const command = () => {\n       .hook(\n         'preAction',\n         ifOptions(\n-          (opts) =>\n+          async (opts) =>\n             (opts.from && opts.to) || (opts.from && opts.toToken) || (opts.to && opts.fromToken),\n           async () =>\n             exitWith(1, 'Only one remote source (from) or destination (to) option may be provided')\n         )\n       )\n-      .hook('preAction', async (thisCommand) => {\n-        const opts = thisCommand.opts();\n-        const hasEnvUrl = process.env.STRAPI_TRANSFER_URL;\n-        const hasEnvToken = process.env.STRAPI_TRANSFER_TOKEN;\n-\n-        const logDocumentation = () => {\n-          console.info(\n-            '\u2139\ufe0f  Data transfer documentation: https://docs.strapi.io/dev-docs/data-management/transfer'\n-          );\n-        };\n-\n-        const logEnvironmentVariables = () => {\n-          if (!hasEnvUrl && !hasEnvToken) {\n-            console.info('\u2139\ufe0f  No transfer configuration found in environment variables');\n-            console.info(\n-              '   \u2192 Add STRAPI_TRANSFER_URL and STRAPI_TRANSFER_TOKEN environment variables to make the transfer process faster for future runs'\n-            );\n-            return;\n-          }\n+      .hook(\n+        'preAction',\n+        ifOptions(\n+          // Only run interactive prompts if neither --from nor --to is provided\n+          async (opts) => !opts.from && !opts.to,\n+          async (thisCommand) => {\n+            const opts = thisCommand.opts();\n+            const hasEnvUrl = process.env.STRAPI_TRANSFER_URL;\n+            const hasEnvToken = process.env.STRAPI_TRANSFER_TOKEN;\n+\n+            const logDocumentation = () => {\n+              console.info(\n+                '\u2139\ufe0f  Data transfer documentation: https://docs.strapi.io/dev-docs/data-management/transfer'\n+              );\n+            };\n+\n+            const logEnvironmentVariables = () => {\n+              if (!hasEnvUrl && !hasEnvToken) {\n+                console.info('\u2139\ufe0f  No transfer configuration found in environment variables');\n+                console.info(\n+                  '   \u2192 Add STRAPI_TRANSFER_URL and STRAPI_TRANSFER_TOKEN environment variables to make the transfer process faster for future runs'\n+                );\n+                return;\n+              }\n \n-          console.info('\u2139\ufe0f  Found transfer configuration in your environment:');\n+              console.info('\u2139\ufe0f  Found transfer configuration in your environment:');\n \n-          if (hasEnvUrl) {\n-            console.info(\n-              `   \u2192 Environment STRAPI_TRANSFER_URL (${hasEnvUrl}) will be used as the transfer URL`\n-            );\n-          }\n+              if (hasEnvUrl) {\n+                console.info(\n+                  `   \u2192 Environment STRAPI_TRANSFER_URL (${hasEnvUrl}) will be used as the transfer URL`\n+                );\n+              }\n \n-          if (hasEnvToken) {\n-            console.info(\n-              '   \u2192 Environment STRAPI_TRANSFER_TOKEN value will be used as the transfer token'\n-            );\n-          }\n+              if (hasEnvToken) {\n+                console.info(\n+                  '   \u2192 Environment STRAPI_TRANSFER_TOKEN value will be used as the transfer token'\n+                );\n+              }\n \n-          console.info(); // Empty line for better readability\n-        };\n+              console.info(); // Empty line for better readability\n+            };\n \n-        const determineDirection = async () => {\n-          // If user has not provided a direction from CLI, log the documentation\n-          if (!opts.from && !opts.to) {\n-            logDocumentation();\n-          }\n+            const determineDirection = async () => {\n+              // If user has not provided a direction from CLI, log the documentation\n+              if (!opts.from && !opts.to) {\n+                logDocumentation();\n+              }\n \n-          logEnvironmentVariables();\n+              logEnvironmentVariables();\n \n-          if (opts.from) {\n-            return opts.from;\n-          }\n-          if (opts.to) {\n-            return opts.to;\n-          }\n+              if (opts.from) {\n+                return 'from';\n+              }\n+              if (opts.to) {\n+                return 'to';\n+              }\n \n-          const { dir } = await inquirer.prompt([\n-            {\n-              type: 'list',\n-              name: 'dir',\n-              message: 'Choose transfer direction:',\n-              choices: [\n-                { name: 'Pull data from remote Strapi to local', value: 'from' },\n-                { name: 'Push local data to remote Strapi', value: 'to' },\n-              ],\n-            },\n-          ]);\n-\n-          return dir;\n-        };\n-\n-        const determineUrl = async (direction: 'from' | 'to') => {\n-          if (opts[direction]) {\n-            return new URL(opts[direction]);\n-          }\n+              const { dir } = await inquirer.prompt([\n+                {\n+                  type: 'list',\n+                  name: 'dir',\n+                  message: 'Choose transfer direction:',\n+                  choices: [\n+                    { name: 'Pull data from remote Strapi to local', value: 'from' },\n+                    { name: 'Push local data to remote Strapi', value: 'to' },\n+                  ],\n+                },\n+              ]);\n \n-          if (process.env.STRAPI_TRANSFER_URL) {\n-            return new URL(process.env.STRAPI_TRANSFER_URL);\n-          }\n+              return dir;\n+            };\n \n-          const answer = await inquirer.prompt([\n-            {\n-              type: 'input',\n-              name: 'remoteUrl',\n-              message: `Enter the URL of the remote Strapi instance to ${direction === 'from' ? 'get data from' : 'send data to'}:`,\n-              default: process.env.STRAPI_TRANSFER_URL,\n-              validate(input: string) {\n-                try {\n-                  const url = new URL(input);\n-                  if (!['http:', 'https:'].includes(url.protocol)) {\n-                    return 'URL must use http: or https: protocol';\n-                  }\n-                  return true;\n-                } catch (error) {\n-                  return 'Please enter a valid URL (e.g., http://localhost:1337/admin or https://example.com/admin)';\n-                }\n-              },\n-            },\n-          ]);\n-\n-          return new URL(answer.remoteUrl);\n-        };\n-\n-        const determineToken = async (direction: 'from' | 'to') => {\n-          if (opts[`${direction}Token`]) {\n-            return opts[`${direction}Token`];\n-          }\n+            const determineUrl = async (direction: 'from' | 'to') => {\n+              if (opts[direction]) {\n+                return new URL(opts[direction]);\n+              }\n \n-          if (process.env.STRAPI_TRANSFER_TOKEN) {\n-            return process.env.STRAPI_TRANSFER_TOKEN;\n-          }\n+              if (process.env.STRAPI_TRANSFER_URL) {\n+                return new URL(process.env.STRAPI_TRANSFER_URL);\n+              }\n \n-          const answer = await inquirer.prompt([\n-            {\n-              type: 'password',\n-              name: 'token',\n-              message: `Enter the transfer token for the remote Strapi ${direction === 'from' ? 'source' : 'destination'}:`,\n-              default: process.env.STRAPI_TRANSFER_TOKEN,\n-              validate(input: string) {\n-                if (!input?.length) {\n-                  return 'Transfer token is required';\n-                }\n-                return true;\n-              },\n-            },\n-          ]);\n-\n-          return answer.token;\n-        };\n-\n-        const direction = await determineDirection();\n-        opts[direction] = await determineUrl(direction);\n-        opts[`${direction}Token`] = await determineToken(direction);\n-      })\n+              const answer = await inquirer.prompt([\n+                {\n+                  type: 'input',\n+                  name: 'remoteUrl',\n+                  message: `Enter the URL of the remote Strapi instance to ${direction === 'from' ? 'get data from' : 'send data to'}:`,\n+                  default: process.env.STRAPI_TRANSFER_URL,\n+                  validate(input: string) {\n+                    try {\n+                      const url = new URL(input);\n+                      if (!['http:', 'https:'].includes(url.protocol)) {\n+                        return 'URL must use http: or https: protocol';\n+                      }\n+                      return true;\n+                    } catch (error) {\n+                      return 'Please enter a valid URL (e.g., http://localhost:1337/admin or https://example.com/admin)';\n+                    }\n+                  },\n+                },\n+              ]);\n+\n+              return new URL(answer.remoteUrl);\n+            };\n+\n+            const determineToken = async (direction: 'from' | 'to') => {\n+              if (opts[`${direction}Token`]) {\n+                return opts[`${direction}Token`];\n+              }\n+\n+              if (process.env.STRAPI_TRANSFER_TOKEN) {\n+                return process.env.STRAPI_TRANSFER_TOKEN;\n+              }\n+\n+              const answer = await inquirer.prompt([\n+                {\n+                  type: 'password',\n+                  name: 'token',\n+                  message: `Enter the transfer token for the remote Strapi ${direction === 'from' ? 'source' : 'destination'}:`,\n+                  default: process.env.STRAPI_TRANSFER_TOKEN,\n+                  validate(input: string) {\n+                    if (!input?.length) {\n+                      return 'Transfer token is required';\n+                    }\n+                    return true;\n+                  },\n+                },\n+              ]);\n+\n+              return answer.token;\n+            };\n+\n+            const direction = await determineDirection();\n+            opts[direction] = await determineUrl(direction);\n+            opts[`${direction}Token`] = await determineToken(direction);\n+          }\n+        )\n+      )\n       // If --from is used, validate the URL and token\n       .hook(\n         'preAction',\n         ifOptions(\n-          (opts) => opts.from,\n+          async (opts) => opts.from,\n           async (thisCommand) => {\n             assertUrlHasProtocol(thisCommand.opts().from, ['https:', 'http:']);\n             if (!thisCommand.opts().fromToken) {\n@@ -213,7 +220,7 @@ const command = () => {\n       .hook(\n         'preAction',\n         ifOptions(\n-          (opts) => opts.to,\n+          async (opts) => opts.to,\n           async (thisCommand) => {\n             assertUrlHasProtocol(thisCommand.opts().to, ['https:', 'http:']);\n             if (!thisCommand.opts().toToken) {\n",
        "test_patch": "diff --git a/packages/core/strapi/src/cli/commands/transfer/__tests__/transfer.test.ts b/packages/core/strapi/src/cli/commands/transfer/__tests__/transfer.test.ts\nindex 7e423107248e..ec056808d24c 100644\n--- a/packages/core/strapi/src/cli/commands/transfer/__tests__/transfer.test.ts\n+++ b/packages/core/strapi/src/cli/commands/transfer/__tests__/transfer.test.ts\n@@ -42,6 +42,7 @@ jest.mock('@strapi/data-transfer', () => {\n         ...acutal.strapi.providers,\n         createLocalStrapiSourceProvider: jest.fn().mockReturnValue({ name: 'testLocalSource' }),\n         createLocalStrapiDestinationProvider: jest.fn().mockReturnValue({ name: 'testLocalDest' }),\n+        createRemoteStrapiSourceProvider: jest.fn().mockReturnValue({ name: 'testRemoteSource' }),\n         createRemoteStrapiDestinationProvider: jest\n           .fn()\n           .mockReturnValue({ name: 'testRemoteDest' }),\n@@ -89,6 +90,7 @@ describe('Transfer', () => {\n   const destinationToken = 'test-token';\n \n   const sourceUrl = new URL('http://two.localhost/admin');\n+  const sourceToken = 'test-source-token';\n \n   beforeEach(() => {\n     jest.clearAllMocks();\n@@ -171,7 +173,58 @@ describe('Transfer', () => {\n     });\n   });\n \n-  it.todo('uses local Strapi destination when to is not specified');\n+  describe('--from', () => {\n+    it('exits with error when auth is not provided', async () => {\n+      await expectExit(1, async () => {\n+        await transferAction({ to: undefined, from: sourceUrl } as any);\n+      });\n+\n+      expect(console.error).toHaveBeenCalledWith(expect.stringMatching(/missing token/i));\n+\n+      expect(\n+        mockDataTransfer.strapi.providers.createRemoteStrapiSourceProvider\n+      ).not.toHaveBeenCalled();\n+    });\n+\n+    it('uses source url and token provided by user', async () => {\n+      await expectExit(0, async () => {\n+        await transferAction({\n+          to: undefined,\n+          from: sourceUrl,\n+          fromToken: sourceToken,\n+        } as any);\n+      });\n+\n+      expect(console.error).not.toHaveBeenCalled();\n+      expect(\n+        mockDataTransfer.strapi.providers.createRemoteStrapiSourceProvider\n+      ).toHaveBeenCalledWith(\n+        expect.objectContaining({\n+          url: sourceUrl,\n+          auth: {\n+            type: 'token',\n+            token: sourceToken,\n+          },\n+        })\n+      );\n+    });\n+\n+    it('uses local Strapi destination when to is not specified', async () => {\n+      await expectExit(0, async () => {\n+        await transferAction({\n+          to: undefined,\n+          from: sourceUrl,\n+          fromToken: sourceToken,\n+        } as any);\n+      });\n+\n+      expect(console.error).not.toHaveBeenCalled();\n+      expect(\n+        mockDataTransfer.strapi.providers.createLocalStrapiDestinationProvider\n+      ).toHaveBeenCalled();\n+      expect(mockDataTransfer.strapi.providers.createRemoteStrapiSourceProvider).toHaveBeenCalled();\n+    });\n+  });\n \n   it('uses restore as the default strategy', async () => {\n     await expectExit(0, async () => {\n",
        "problem_statement": "Strapi Transfer CLI --force issue\n### Node Version\n\n20.15.0\n\n### NPM/Yarn/PNPM Version\n\nyarn 4.4.1\n\n### Strapi Version\n\n5.14.0\n\n### Operating System\n\nLinux (Debian/Ubuntu)\n\n### Database\n\nPostgreSQL\n\n### Javascript or Typescript\n\nTypescript\n\n### Reproduction URL\n\n_No response_\n\n### Bug Description\n\nHey guys. It seems that in version v5.14.0 the `--force` parameter of strapi transfer CLI is broken. Below is my CLI call with said parameter and correct `--from` and `--from-token` parameters. And it still prompts for the URL (and then token) even though they're passed through the call and the `--force` parameter is present.\n\n\n```\nrunner@fv-az720-478:~/work/redacted$ yarn strapi transfer \\\n--from https://valid-origin-url.com/admin \\\n--from-token 123-valid-token-123 \\\n--force \\\n--exclude files\u2028\n\u2139\ufe0f  No transfer configuration found in environment variables\n   \u2192 Add STRAPI_TRANSFER_URL and STRAPI_TRANSFER_TOKEN environment variables to make the transfer process faster for future runs\n? Enter the URL of the remote Strapi instance to send data to: \n```\n\nIt works the same way locally (MacOS m3 14.6) and on Github runner instance (Ubuntu 22.04).\nI think it might be related to the new transfer CLI feature from [this pr](https://github.com/strapi/strapi/pull/23421)\nAm I doing something wrong or is it a bug? It worked properly in v5.13. \n\n### Steps to Reproduce\n\n1. Run transfer command with `--from`, `--from-token` and `--force` parameters.\n2. Observe CLI prompts still appearing.\n\n### Expected Behavior\n\nTransfer going through. CLI not prompting for additional information.\n\n### Logs\n\n```shell\n\n```\n\n### Code Snippets\n\n_No response_\n\n### Media\n\n_No response_\n\n### Additional information\n\n_No response_\n\n### Confirmation Checklist\n\n- [x] I have checked the existing [issues](https://github.com/strapi/strapi/issues) for duplicates.\n- [x] I agree to follow this project's [Code of Conduct](https://github.com/strapi/strapi/blob/develop/CODE_OF_CONDUCT.md).\n",
        "hints_text": "I'm having this exact same issue. CLI transfer commands that worked in v5.12 are no longer working for me in 5.15.\n\n```bash\n\u2570\u2500 npx strapi transfer --from $STRAPI_PRODUCTION_URL\n\n\u2139\ufe0f  Found transfer configuration in your environment:\n   \u2192 Environment STRAPI_TRANSFER_TOKEN value will be used as the transfer token\n\n? Enter the URL of the remote Strapi instance to send data to: \n```\nI'm still having this issue on v5.15.0, has it been fixed on latest versions ?\nI was able to work-around this problem by **providing cli flags and environment variables both**:\n\n```\n$ strapi transfer --verbose --force --from \"$STRAPI_TRANSFER_URL\" --from-token \"$STRAPI_TRANSFER_TOKEN\" \n\u2139\ufe0f  Found transfer configuration in your environment:\n   \u2192 Environment STRAPI_TRANSFER_URL (http://localhost:1337/admin) will be used as the transfer URL\n   \u2192 Environment STRAPI_TRANSFER_TOKEN value will be used as the transfer token\n? The transfer will delete all the local Strapi assets and its database. Are you sure you want to proceed? Yes\n\n... transfer started ...\n```\nRelated to this issue: https://github.com/strapi/strapi/issues/23883\nPretty sure this is caused by [this bug](https://github.com/strapi/strapi/pull/23421#discussion_r2207601028) I found on the original PR.",
        "created_at": "2025-11-19T16:06:16Z",
        "pr_mirror": "strapi__strapi.main"
    }
}