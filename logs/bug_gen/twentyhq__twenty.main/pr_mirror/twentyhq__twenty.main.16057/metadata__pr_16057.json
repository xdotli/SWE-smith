{
    "cost": 0.5019549999999999,
    "rewrites": {
        "twentyhq__twenty.main/packages/twenty-front/src/modules/auth/sign-in-up/hooks/useSignInUpForm.ts": {
            "output": "import { zodResolver } from '@hookform/resolvers/zod';\nimport { useEffect } from 'react';\nimport { useForm } from 'react-hook-form';\nimport { useSearchParams } from 'react-router-dom';\nimport { useRecoilValue } from 'recoil';\nimport { z } from 'zod';\n\nimport {\n  SignInUpStep,\n  signInUpStepState,\n} from '@/auth/states/signInUpStepState';\nimport { PASSWORD_REGEX } from '@/auth/utils/passwordRegex';\nimport { isDeveloperDefaultSignInPrefilledState } from '@/client-config/states/isDeveloperDefaultSignInPrefilledState';\nimport { isDefined } from 'twenty-shared/utils';\n\nconst makeValidationSchema = (signInUpStep: SignInUpStep) =>\n  z\n    .object({\n      exist: z.boolean(),\n      email: z\n        .string()\n        .trim()\n        .pipe(z.email({ error: 'Email must be a valid email' })),\n      password:\n        signInUpStep === SignInUpStep.Password\n          ? z\n              .string()\n              .regex(PASSWORD_REGEX, 'Password must be min. 8 characters')\n          : z.string().optional(),\n      captchaToken: z.string().default(''),\n    })\n    .required();\n\nexport type Form = z.infer<ReturnType<typeof makeValidationSchema>>;\nexport const useSignInUpForm = () => {\n  const signInUpStep = useRecoilValue(signInUpStepState);\n\n  const validationSchema = makeValidationSchema(signInUpStep); // Create schema based on the current step\n\n  const isDeveloperDefaultSignInPrefilled = useRecoilValue(\n    isDeveloperDefaultSignInPrefilledState,\n  );\n  const [searchParams] = useSearchParams();\n  const prefilledEmail = searchParams.get('email');\n\n  const form = useForm<Form>({\n    mode: 'onSubmit',\n    defaultValues: {\n      exist: false,\n      email: '',\n      password: '',\n      captchaToken: '',\n    },\n    resolver: zodResolver(validationSchema),\n  });\n\n  useEffect(() => {\n    if (isDefined(prefilledEmail)) {\n      form.setValue('email', prefilledEmail);\n    }\n\n    if (isDeveloperDefaultSignInPrefilled === true) {\n      form.setValue('email', prefilledEmail ?? 'tim@apple.dev');\n      form.setValue('password', 'tim@apple.dev');\n    }\n  }, [form, isDeveloperDefaultSignInPrefilled, prefilledEmail]);\n  return { form: form };\n};",
            "output_extracted": "import { zodResolver } from '@hookform/resolvers/zod';\nimport { useEffect } from 'react';\nimport { useForm } from 'react-hook-form';\nimport { useSearchParams } from 'react-router-dom';\nimport { useRecoilValue } from 'recoil';\nimport { z } from 'zod';\n\nimport {\n  SignInUpStep,\n  signInUpStepState,\n} from '@/auth/states/signInUpStepState';\nimport { PASSWORD_REGEX } from '@/auth/utils/passwordRegex';\nimport { isDeveloperDefaultSignInPrefilledState } from '@/client-config/states/isDeveloperDefaultSignInPrefilledState';\nimport { isDefined } from 'twenty-shared/utils';\n\nconst makeValidationSchema = (signInUpStep: SignInUpStep) =>\n  z\n    .object({\n      exist: z.boolean(),\n      email: z\n        .string()\n        .trim()\n        .pipe(z.email({ error: 'Email must be a valid email' })),\n      password:\n        signInUpStep === SignInUpStep.Password\n          ? z\n              .string()\n              .regex(PASSWORD_REGEX, 'Password must be min. 8 characters')\n          : z.string().optional(),\n      captchaToken: z.string().default(''),\n    })\n    .required();\n\nexport type Form = z.infer<ReturnType<typeof makeValidationSchema>>;\nexport const useSignInUpForm = () => {\n  const signInUpStep = useRecoilValue(signInUpStepState);\n\n  const validationSchema = makeValidationSchema(signInUpStep); // Create schema based on the current step\n\n  const isDeveloperDefaultSignInPrefilled = useRecoilValue(\n    isDeveloperDefaultSignInPrefilledState,\n  );\n  const [searchParams] = useSearchParams();\n  const prefilledEmail = searchParams.get('email');\n\n  const form = useForm<Form>({\n    mode: 'onSubmit',\n    defaultValues: {\n      exist: false,\n      email: '',\n      password: '',\n      captchaToken: '',\n    },\n    resolver: zodResolver(validationSchema),\n  });\n\n  useEffect(() => {\n    if (isDefined(prefilledEmail)) {\n      form.setValue('email', prefilledEmail);\n    }\n\n    if (isDeveloperDefaultSignInPrefilled === true) {\n      form.setValue('email', prefilledEmail ?? 'tim@apple.dev');\n      form.setValue('password', 'tim@apple.dev');\n    }\n  }, [form, isDeveloperDefaultSignInPrefilled, prefilledEmail]);\n  return { form: form };\n};",
            "cost": 0.025005
        },
        "twentyhq__twenty.main/packages/twenty-server/src/engine/core-modules/actor/services/__tests__/created-by-from-auth-context.service.spec.ts": {
            "output": "import { Test, type TestingModule } from '@nestjs/testing';\nimport { getRepositoryToken } from '@nestjs/typeorm';\n\nimport {\n  type ActorMetadata,\n  FieldActorSource,\n  type FullNameMetadata,\n} from 'twenty-shared/types';\n\nimport { CreatedByFromAuthContextService } from 'src/engine/core-modules/actor/services/created-by-from-auth-context.service';\nimport { type ApiKeyEntity } from 'src/engine/core-modules/api-key/api-key.entity';\nimport { type AuthContext } from 'src/engine/core-modules/auth/types/auth-context.type';\nimport { type UserEntity } from 'src/engine/core-modules/user/user.entity';\nimport { type WorkspaceEntity } from 'src/engine/core-modules/workspace/workspace.entity';\nimport { FieldMetadataEntity } from 'src/engine/metadata-modules/field-metadata/field-metadata.entity';\nimport { WorkspaceManyOrAllFlatEntityMapsCacheService } from 'src/engine/metadata-modules/flat-entity/services/workspace-many-or-all-flat-entity-maps-cache.service';\nimport { TwentyORMGlobalManager } from 'src/engine/twenty-orm/twenty-orm-global.manager';\nimport { type WorkspaceMemberWorkspaceEntity } from 'src/modules/workspace-member/standard-objects/workspace-member.workspace-entity';\n\ntype TestingAuthContext = Omit<AuthContext, 'workspace' | 'apiKey' | 'user'> & {\n  workspace: Partial<WorkspaceEntity>;\n  apiKey?: Partial<ApiKeyEntity>;\n  user?: Partial<UserEntity>;\n};\n\ntype ExpectedResult = { createdBy: ActorMetadata }[];\n\n// TODO create util\nconst fromFullNameMetadataToName = ({\n  firstName,\n  lastName,\n}: FullNameMetadata) => `${firstName} ${lastName}`;\n\ndescribe('CreatedByFromAuthContextService', () => {\n  let service: CreatedByFromAuthContextService;\n  const mockWorkspaceMemberRepository = {\n    findOneOrFail: jest.fn(),\n  };\n  const twentyORMGlobalManager: jest.Mocked<\n    Pick<TwentyORMGlobalManager, 'getRepositoryForWorkspace'>\n  > = {\n    getRepositoryForWorkspace: jest\n      .fn()\n      .mockResolvedValue(mockWorkspaceMemberRepository),\n  };\n\n  beforeEach(async () => {\n    const module: TestingModule = await Test.createTestingModule({\n      providers: [\n        CreatedByFromAuthContextService,\n        {\n          provide: TwentyORMGlobalManager,\n          useValue: twentyORMGlobalManager,\n        },\n        {\n          provide: getRepositoryToken(FieldMetadataEntity),\n          useValue: {\n            findOne: jest.fn().mockResolvedValue(true),\n          },\n        },\n        {\n          provide: WorkspaceManyOrAllFlatEntityMapsCacheService,\n          useValue: {\n            getOrRecomputeManyOrAllFlatEntityMaps: jest.fn().mockResolvedValue({\n              flatObjectMetadataMaps: {\n                byId: {\n                  'person-id': {\n                    id: 'person-id',\n                    nameSingular: 'person',\n                    fieldMetadataIds: ['createdBy-id'],\n                  },\n                },\n              },\n              flatFieldMetadataMaps: {\n                byId: {\n                  'createdBy-id': {\n                    id: 'createdBy-id',\n                    name: 'createdBy',\n                    objectMetadataId: 'person-id',\n                  },\n                },\n              },\n              flatIndexMaps: {\n                byId: {},\n              },\n            }),\n          },\n        },\n      ],\n    }).compile();\n\n    service = module.get<CreatedByFromAuthContextService>(\n      CreatedByFromAuthContextService,\n    );\n  });\n\n  afterEach(() => {\n    jest.clearAllMocks();\n  });\n\n  it('should be defined', () => {\n    expect(service).toBeDefined();\n  });\n  describe('injectCreatedBy', () => {\n    it('should build metadata from workspaceMemberId and user when both are present', async () => {\n      const authContext = {\n        workspaceMemberId: '20202020-0b5c-4178-bed7-d371f6411eaa',\n        user: {\n          firstName: 'John',\n          lastName: 'Doe',\n          id: '20202020-9aae-49a8-bafc-ac44bae62d6d',\n        },\n        workspace: { id: '20202020-bdec-497f-847a-1bb334fefe58' },\n      } as const satisfies TestingAuthContext;\n\n      const result = await service.injectCreatedBy(\n        [{}],\n        'person',\n        authContext as AuthContext,\n      );\n\n      expect(result).toEqual<ExpectedResult>([\n        {\n          createdBy: {\n            context: {},\n            name: fromFullNameMetadataToName(authContext.user),\n            workspaceMemberId: authContext.workspaceMemberId,\n            source: FieldActorSource.MANUAL,\n          },\n        },\n      ]);\n    });\n\n    it('should build metadata from user when workspaceMemberId is missing', async () => {\n      const authContext = {\n        user: {\n          firstName: 'John',\n          lastName: 'Doe',\n          id: '20202020-9aae-49a8-bafc-ac44bae62d6d',\n        },\n        workspace: { id: '20202020-bdec-497f-847a-1bb334fefe58' },\n      } as const satisfies TestingAuthContext;\n\n      const mockedWorkspaceMember = {\n        id: '20202020-78a3-4520-ba74-b0e1b534a501',\n        name: {\n          firstName: 'Pepito',\n          lastName: 'Dubois',\n        },\n      } as const satisfies Partial<WorkspaceMemberWorkspaceEntity>;\n\n      mockWorkspaceMemberRepository.findOneOrFail.mockResolvedValueOnce(\n        mockedWorkspaceMember,\n      );\n\n      const result = await service.injectCreatedBy(\n        [{}],\n        'person',\n        authContext as AuthContext,\n      );\n\n      expect(result).toEqual<ExpectedResult>([\n        {\n          createdBy: {\n            context: {},\n            name: fromFullNameMetadataToName(mockedWorkspaceMember.name),\n            workspaceMemberId: mockedWorkspaceMember.id,\n            source: FieldActorSource.MANUAL,\n          },\n        },\n      ]);\n    });\n\n    it('should build metadata from apiKey when only apiKey is present', async () => {\n      const authContext = {\n        apiKey: {\n          id: '20202020-56c2-471b-925d-31ed3ecd0951',\n          name: 'API Key Name',\n        },\n        workspace: { id: '20202020-bdec-497f-847a-1bb334fefe58' },\n      } as const satisfies TestingAuthContext;\n\n      const result = await service.injectCreatedBy(\n        [{}],\n        'person',\n        authContext as AuthContext,\n      );\n\n      expect(result).toEqual<ExpectedResult>([\n        {\n          createdBy: {\n            source: FieldActorSource.API,\n            workspaceMemberId: null,\n            name: authContext.apiKey.name,\n            context: {},\n          },\n        },\n      ]);\n    });\n\n    it('should throw error when no valid actor information is found', async () => {\n      const authContext = {\n        workspace: { id: 'workspace-id' },\n      } as const satisfies TestingAuthContext;\n\n      await expect(\n        service.injectCreatedBy([{}], 'person', authContext as AuthContext),\n      ).rejects.toThrowErrorMatchingInlineSnapshot(\n        `\"Unable to build createdBy metadata - no valid actor information found in auth context\"`,\n      );\n    });\n  });\n});",
            "output_extracted": "import { Test, type TestingModule } from '@nestjs/testing';\nimport { getRepositoryToken } from '@nestjs/typeorm';\n\nimport {\n  type ActorMetadata,\n  FieldActorSource,\n  type FullNameMetadata,\n} from 'twenty-shared/types';\n\nimport { CreatedByFromAuthContextService } from 'src/engine/core-modules/actor/services/created-by-from-auth-context.service';\nimport { type ApiKeyEntity } from 'src/engine/core-modules/api-key/api-key.entity';\nimport { type AuthContext } from 'src/engine/core-modules/auth/types/auth-context.type';\nimport { type UserEntity } from 'src/engine/core-modules/user/user.entity';\nimport { type WorkspaceEntity } from 'src/engine/core-modules/workspace/workspace.entity';\nimport { FieldMetadataEntity } from 'src/engine/metadata-modules/field-metadata/field-metadata.entity';\nimport { WorkspaceManyOrAllFlatEntityMapsCacheService } from 'src/engine/metadata-modules/flat-entity/services/workspace-many-or-all-flat-entity-maps-cache.service';\nimport { TwentyORMGlobalManager } from 'src/engine/twenty-orm/twenty-orm-global.manager';\nimport { type WorkspaceMemberWorkspaceEntity } from 'src/modules/workspace-member/standard-objects/workspace-member.workspace-entity';\n\ntype TestingAuthContext = Omit<AuthContext, 'workspace' | 'apiKey' | 'user'> & {\n  workspace: Partial<WorkspaceEntity>;\n  apiKey?: Partial<ApiKeyEntity>;\n  user?: Partial<UserEntity>;\n};\n\ntype ExpectedResult = { createdBy: ActorMetadata }[];\n\n// TODO create util\nconst fromFullNameMetadataToName = ({\n  firstName,\n  lastName,\n}: FullNameMetadata) => `${firstName} ${lastName}`;\n\ndescribe('CreatedByFromAuthContextService', () => {\n  let service: CreatedByFromAuthContextService;\n  const mockWorkspaceMemberRepository = {\n    findOneOrFail: jest.fn(),\n  };\n  const twentyORMGlobalManager: jest.Mocked<\n    Pick<TwentyORMGlobalManager, 'getRepositoryForWorkspace'>\n  > = {\n    getRepositoryForWorkspace: jest\n      .fn()\n      .mockResolvedValue(mockWorkspaceMemberRepository),\n  };\n\n  beforeEach(async () => {\n    const module: TestingModule = await Test.createTestingModule({\n      providers: [\n        CreatedByFromAuthContextService,\n        {\n          provide: TwentyORMGlobalManager,\n          useValue: twentyORMGlobalManager,\n        },\n        {\n          provide: getRepositoryToken(FieldMetadataEntity),\n          useValue: {\n            findOne: jest.fn().mockResolvedValue(true),\n          },\n        },\n        {\n          provide: WorkspaceManyOrAllFlatEntityMapsCacheService,\n          useValue: {\n            getOrRecomputeManyOrAllFlatEntityMaps: jest.fn().mockResolvedValue({\n              flatObjectMetadataMaps: {\n                byId: {\n                  'person-id': {\n                    id: 'person-id',\n                    nameSingular: 'person',\n                    fieldMetadataIds: ['createdBy-id'],\n                  },\n                },\n              },\n              flatFieldMetadataMaps: {\n                byId: {\n                  'createdBy-id': {\n                    id: 'createdBy-id',\n                    name: 'createdBy',\n                    objectMetadataId: 'person-id',\n                  },\n                },\n              },\n              flatIndexMaps: {\n                byId: {},\n              },\n            }),\n          },\n        },\n      ],\n    }).compile();\n\n    service = module.get<CreatedByFromAuthContextService>(\n      CreatedByFromAuthContextService,\n    );\n  });\n\n  afterEach(() => {\n    jest.clearAllMocks();\n  });\n\n  it('should be defined', () => {\n    expect(service).toBeDefined();\n  });\n  describe('injectCreatedBy', () => {\n    it('should build metadata from workspaceMemberId and user when both are present', async () => {\n      const authContext = {\n        workspaceMemberId: '20202020-0b5c-4178-bed7-d371f6411eaa',\n        user: {\n          firstName: 'John',\n          lastName: 'Doe',\n          id: '20202020-9aae-49a8-bafc-ac44bae62d6d',\n        },\n        workspace: { id: '20202020-bdec-497f-847a-1bb334fefe58' },\n      } as const satisfies TestingAuthContext;\n\n      const result = await service.injectCreatedBy(\n        [{}],\n        'person',\n        authContext as AuthContext,\n      );\n\n      expect(result).toEqual<ExpectedResult>([\n        {\n          createdBy: {\n            context: {},\n            name: fromFullNameMetadataToName(authContext.user),\n            workspaceMemberId: authContext.workspaceMemberId,\n            source: FieldActorSource.MANUAL,\n          },\n        },\n      ]);\n    });\n\n    it('should build metadata from user when workspaceMemberId is missing', async () => {\n      const authContext = {\n        user: {\n          firstName: 'John',\n          lastName: 'Doe',\n          id: '20202020-9aae-49a8-bafc-ac44bae62d6d',\n        },\n        workspace: { id: '20202020-bdec-497f-847a-1bb334fefe58' },\n      } as const satisfies TestingAuthContext;\n\n      const mockedWorkspaceMember = {\n        id: '20202020-78a3-4520-ba74-b0e1b534a501',\n        name: {\n          firstName: 'Pepito',\n          lastName: 'Dubois',\n        },\n      } as const satisfies Partial<WorkspaceMemberWorkspaceEntity>;\n\n      mockWorkspaceMemberRepository.findOneOrFail.mockResolvedValueOnce(\n        mockedWorkspaceMember,\n      );\n\n      const result = await service.injectCreatedBy(\n        [{}],\n        'person',\n        authContext as AuthContext,\n      );\n\n      expect(result).toEqual<ExpectedResult>([\n        {\n          createdBy: {\n            context: {},\n            name: fromFullNameMetadataToName(mockedWorkspaceMember.name),\n            workspaceMemberId: mockedWorkspaceMember.id,\n            source: FieldActorSource.MANUAL,\n          },\n        },\n      ]);\n    });\n\n    it('should build metadata from apiKey when only apiKey is present', async () => {\n      const authContext = {\n        apiKey: {\n          id: '20202020-56c2-471b-925d-31ed3ecd0951',\n          name: 'API Key Name',\n        },\n        workspace: { id: '20202020-bdec-497f-847a-1bb334fefe58' },\n      } as const satisfies TestingAuthContext;\n\n      const result = await service.injectCreatedBy(\n        [{}],\n        'person',\n        authContext as AuthContext,\n      );\n\n      expect(result).toEqual<ExpectedResult>([\n        {\n          createdBy: {\n            source: FieldActorSource.API,\n            workspaceMemberId: null,\n            name: authContext.apiKey.name,\n            context: {},\n          },\n        },\n      ]);\n    });\n\n    it('should throw error when no valid actor information is found', async () => {\n      const authContext = {\n        workspace: { id: 'workspace-id' },\n      } as const satisfies TestingAuthContext;\n\n      await expect(\n        service.injectCreatedBy([{}], 'person', authContext as AuthContext),\n      ).rejects.toThrowErrorMatchingInlineSnapshot(\n        `\"Unable to build createdBy metadata - no valid actor information found in auth context\"`,\n      );\n    });\n  });\n});",
            "cost": 0.070095
        },
        "twentyhq__twenty.main/packages/twenty-server/src/engine/core-modules/actor/services/created-by-from-auth-context.service.ts": {
            "output": "import { Injectable, Logger } from '@nestjs/common';\n\nimport { type ActorMetadata } from 'twenty-shared/types';\nimport { assertIsDefinedOrThrow, isDefined } from 'twenty-shared/utils';\n\nimport { buildCreatedByFromApiKey } from 'src/engine/core-modules/actor/utils/build-created-by-from-api-key.util';\nimport { buildCreatedByFromFullNameMetadata } from 'src/engine/core-modules/actor/utils/build-created-by-from-full-name-metadata.util';\nimport { type AuthContext } from 'src/engine/core-modules/auth/types/auth-context.type';\nimport { WorkspaceNotFoundDefaultError } from 'src/engine/core-modules/workspace/workspace.exception';\nimport { WorkspaceManyOrAllFlatEntityMapsCacheService } from 'src/engine/metadata-modules/flat-entity/services/workspace-many-or-all-flat-entity-maps-cache.service';\nimport { buildFieldMapsFromFlatObjectMetadata } from 'src/engine/metadata-modules/flat-field-metadata/utils/build-field-maps-from-flat-object-metadata.util';\nimport { buildObjectIdByNameMaps } from 'src/engine/metadata-modules/flat-object-metadata/utils/build-object-id-by-name-maps.util';\nimport { TwentyORMGlobalManager } from 'src/engine/twenty-orm/twenty-orm-global.manager';\nimport { WorkspaceMemberWorkspaceEntity } from 'src/modules/workspace-member/standard-objects/workspace-member.workspace-entity';\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nexport type CreateInput = Record<string, any>;\n\n@Injectable()\nexport class CreatedByFromAuthContextService {\n  private readonly logger = new Logger(CreatedByFromAuthContextService.name);\n\n  constructor(\n    private readonly twentyORMGlobalManager: TwentyORMGlobalManager,\n    private readonly flatEntityMapsCacheService: WorkspaceManyOrAllFlatEntityMapsCacheService,\n  ) {}\n\n  async injectCreatedBy(\n    records: CreateInput[],\n    objectMetadataNameSingular: string,\n    authContext: AuthContext,\n  ): Promise<CreateInput[]> {\n    const workspace = authContext.workspace;\n\n    assertIsDefinedOrThrow(workspace, WorkspaceNotFoundDefaultError);\n\n    const { flatObjectMetadataMaps, flatFieldMetadataMaps } =\n      await this.flatEntityMapsCacheService.getOrRecomputeManyOrAllFlatEntityMaps(\n        {\n          workspaceId: workspace.id,\n          flatMapsKeys: ['flatObjectMetadataMaps', 'flatFieldMetadataMaps'],\n        },\n      );\n\n    this.logger.log(\n      `Injecting createdBy from auth context for object ${objectMetadataNameSingular} and workspace ${workspace.id}`,\n    );\n\n    const { idByNameSingular } = buildObjectIdByNameMaps(\n      flatObjectMetadataMaps,\n    );\n    const objectId = idByNameSingular[objectMetadataNameSingular];\n    const objectMetadata = objectId\n      ? flatObjectMetadataMaps.byId[objectId]\n      : undefined;\n\n    const fieldIdByName = objectMetadata\n      ? buildFieldMapsFromFlatObjectMetadata(\n          flatFieldMetadataMaps,\n          objectMetadata,\n        ).fieldIdByName\n      : {};\n\n    this.logger.log(\n      `Object metadata found with fields: ${Object.keys(fieldIdByName)}`,\n    );\n\n    if (!isDefined(fieldIdByName['createdBy'])) {\n      this.logger.log(\n        `CreatedBy field not found in object metadata, skipping injection`,\n      );\n\n      return records;\n    }\n\n    const clonedRecords = structuredClone(records);\n\n    const createdBy = await this.buildCreatedBy(authContext);\n\n    if (Array.isArray(clonedRecords)) {\n      for (const datum of clonedRecords) {\n        this.injectCreatedByToRecord(createdBy, datum);\n      }\n    } else {\n      this.injectCreatedByToRecord(createdBy, clonedRecords);\n    }\n\n    return clonedRecords;\n  }\n\n  private injectCreatedByToRecord(\n    createdBy: ActorMetadata,\n    record: CreateInput,\n  ) {\n    // Front-end can fill the source field\n    if (createdBy && (!record.createdBy || !record.createdBy?.name)) {\n      record.createdBy = {\n        ...createdBy,\n        source: record.createdBy?.source ?? createdBy.source,\n      };\n    }\n  }\n\n  private async buildCreatedBy(\n    authContext: AuthContext,\n  ): Promise<ActorMetadata> {\n    const { workspace, workspaceMemberId, user, apiKey } = authContext;\n\n    assertIsDefinedOrThrow(workspace, WorkspaceNotFoundDefaultError);\n\n    // TODO: remove that code once we have the workspace member id in all tokens\n    if (isDefined(workspaceMemberId) && isDefined(user)) {\n      return buildCreatedByFromFullNameMetadata({\n        fullNameMetadata: {\n          firstName: user.firstName,\n          lastName: user.lastName,\n        },\n        workspaceMemberId,\n      });\n    }\n\n    if (isDefined(user)) {\n      this.logger.warn(\"User doesn't have a workspace member id in the token\");\n\n      const workspaceMemberRepository =\n        await this.twentyORMGlobalManager.getRepositoryForWorkspace<WorkspaceMemberWorkspaceEntity>(\n          workspace.id,\n          'workspaceMember',\n          { shouldBypassPermissionChecks: true },\n        );\n\n      const workspaceMember = await workspaceMemberRepository.findOneOrFail({\n        where: {\n          userId: user.id,\n        },\n      });\n\n      return buildCreatedByFromFullNameMetadata({\n        fullNameMetadata: workspaceMember.name,\n        workspaceMemberId: workspaceMember.id,\n      });\n    }\n\n    if (isDefined(apiKey)) {\n      return buildCreatedByFromApiKey({\n        apiKey,\n      });\n    }\n\n    throw new Error(\n      'Unable to build createdBy metadata - no valid actor information found in auth context',\n    );\n  }\n}",
            "output_extracted": "import { Injectable, Logger } from '@nestjs/common';\n\nimport { type ActorMetadata } from 'twenty-shared/types';\nimport { assertIsDefinedOrThrow, isDefined } from 'twenty-shared/utils';\n\nimport { buildCreatedByFromApiKey } from 'src/engine/core-modules/actor/utils/build-created-by-from-api-key.util';\nimport { buildCreatedByFromFullNameMetadata } from 'src/engine/core-modules/actor/utils/build-created-by-from-full-name-metadata.util';\nimport { type AuthContext } from 'src/engine/core-modules/auth/types/auth-context.type';\nimport { WorkspaceNotFoundDefaultError } from 'src/engine/core-modules/workspace/workspace.exception';\nimport { WorkspaceManyOrAllFlatEntityMapsCacheService } from 'src/engine/metadata-modules/flat-entity/services/workspace-many-or-all-flat-entity-maps-cache.service';\nimport { buildFieldMapsFromFlatObjectMetadata } from 'src/engine/metadata-modules/flat-field-metadata/utils/build-field-maps-from-flat-object-metadata.util';\nimport { buildObjectIdByNameMaps } from 'src/engine/metadata-modules/flat-object-metadata/utils/build-object-id-by-name-maps.util';\nimport { TwentyORMGlobalManager } from 'src/engine/twenty-orm/twenty-orm-global.manager';\nimport { WorkspaceMemberWorkspaceEntity } from 'src/modules/workspace-member/standard-objects/workspace-member.workspace-entity';\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nexport type CreateInput = Record<string, any>;\n\n@Injectable()\nexport class CreatedByFromAuthContextService {\n  private readonly logger = new Logger(CreatedByFromAuthContextService.name);\n\n  constructor(\n    private readonly twentyORMGlobalManager: TwentyORMGlobalManager,\n    private readonly flatEntityMapsCacheService: WorkspaceManyOrAllFlatEntityMapsCacheService,\n  ) {}\n\n  async injectCreatedBy(\n    records: CreateInput[],\n    objectMetadataNameSingular: string,\n    authContext: AuthContext,\n  ): Promise<CreateInput[]> {\n    const workspace = authContext.workspace;\n\n    assertIsDefinedOrThrow(workspace, WorkspaceNotFoundDefaultError);\n\n    const { flatObjectMetadataMaps, flatFieldMetadataMaps } =\n      await this.flatEntityMapsCacheService.getOrRecomputeManyOrAllFlatEntityMaps(\n        {\n          workspaceId: workspace.id,\n          flatMapsKeys: ['flatObjectMetadataMaps', 'flatFieldMetadataMaps'],\n        },\n      );\n\n    this.logger.log(\n      `Injecting createdBy from auth context for object ${objectMetadataNameSingular} and workspace ${workspace.id}`,\n    );\n\n    const { idByNameSingular } = buildObjectIdByNameMaps(\n      flatObjectMetadataMaps,\n    );\n    const objectId = idByNameSingular[objectMetadataNameSingular];\n    const objectMetadata = objectId\n      ? flatObjectMetadataMaps.byId[objectId]\n      : undefined;\n\n    const fieldIdByName = objectMetadata\n      ? buildFieldMapsFromFlatObjectMetadata(\n          flatFieldMetadataMaps,\n          objectMetadata,\n        ).fieldIdByName\n      : {};\n\n    this.logger.log(\n      `Object metadata found with fields: ${Object.keys(fieldIdByName)}`,\n    );\n\n    if (!isDefined(fieldIdByName['createdBy'])) {\n      this.logger.log(\n        `CreatedBy field not found in object metadata, skipping injection`,\n      );\n\n      return records;\n    }\n\n    const clonedRecords = structuredClone(records);\n\n    const createdBy = await this.buildCreatedBy(authContext);\n\n    if (Array.isArray(clonedRecords)) {\n      for (const datum of clonedRecords) {\n        this.injectCreatedByToRecord(createdBy, datum);\n      }\n    } else {\n      this.injectCreatedByToRecord(createdBy, clonedRecords);\n    }\n\n    return clonedRecords;\n  }\n\n  private injectCreatedByToRecord(\n    createdBy: ActorMetadata,\n    record: CreateInput,\n  ) {\n    // Front-end can fill the source field\n    if (createdBy && (!record.createdBy || !record.createdBy?.name)) {\n      record.createdBy = {\n        ...createdBy,\n        source: record.createdBy?.source ?? createdBy.source,\n      };\n    }\n  }\n\n  private async buildCreatedBy(\n    authContext: AuthContext,\n  ): Promise<ActorMetadata> {\n    const { workspace, workspaceMemberId, user, apiKey } = authContext;\n\n    assertIsDefinedOrThrow(workspace, WorkspaceNotFoundDefaultError);\n\n    // TODO: remove that code once we have the workspace member id in all tokens\n    if (isDefined(workspaceMemberId) && isDefined(user)) {\n      return buildCreatedByFromFullNameMetadata({\n        fullNameMetadata: {\n          firstName: user.firstName,\n          lastName: user.lastName,\n        },\n        workspaceMemberId,\n      });\n    }\n\n    if (isDefined(user)) {\n      this.logger.warn(\"User doesn't have a workspace member id in the token\");\n\n      const workspaceMemberRepository =\n        await this.twentyORMGlobalManager.getRepositoryForWorkspace<WorkspaceMemberWorkspaceEntity>(\n          workspace.id,\n          'workspaceMember',\n          { shouldBypassPermissionChecks: true },\n        );\n\n      const workspaceMember = await workspaceMemberRepository.findOneOrFail({\n        where: {\n          userId: user.id,\n        },\n      });\n\n      return buildCreatedByFromFullNameMetadata({\n        fullNameMetadata: workspaceMember.name,\n        workspaceMemberId: workspaceMember.id,\n      });\n    }\n\n    if (isDefined(apiKey)) {\n      return buildCreatedByFromApiKey({\n        apiKey,\n      });\n    }\n\n    throw new Error(\n      'Unable to build createdBy metadata - no valid actor information found in auth context',\n    );\n  }\n}",
            "cost": 0.05401
        },
        "twentyhq__twenty.main/packages/twenty-server/src/engine/core-modules/user-workspace/user-workspace.module.ts": {
            "output": "import { Module } from '@nestjs/common';\n\nimport { NestjsQueryGraphQLModule } from '@ptc-org/nestjs-query-graphql';\nimport { NestjsQueryTypeOrmModule } from '@ptc-org/nestjs-query-typeorm';\n\nimport { TypeORMModule } from 'src/database/typeorm/typeorm.module';\nimport { ApprovedAccessDomainModule } from 'src/engine/core-modules/approved-access-domain/approved-access-domain.module';\nimport { TokenModule } from 'src/engine/core-modules/auth/token/token.module';\nimport { WorkspaceDomainsModule } from 'src/engine/core-modules/domain/workspace-domains/workspace-domains.module';\nimport { FileUploadModule } from 'src/engine/core-modules/file/file-upload/file-upload.module';\nimport { FileModule } from 'src/engine/core-modules/file/file.module';\nimport { UserWorkspaceEntity } from 'src/engine/core-modules/user-workspace/user-workspace.entity';\nimport { UserWorkspaceResolver } from 'src/engine/core-modules/user-workspace/user-workspace.resolver';\nimport { UserWorkspaceService } from 'src/engine/core-modules/user-workspace/user-workspace.service';\nimport { UserEntity } from 'src/engine/core-modules/user/user.entity';\nimport { WorkspaceInvitationModule } from 'src/engine/core-modules/workspace-invitation/workspace-invitation.module';\nimport { WorkspaceEntity } from 'src/engine/core-modules/workspace/workspace.entity';\nimport { DataSourceModule } from 'src/engine/metadata-modules/data-source/data-source.module';\nimport { ObjectMetadataEntity } from 'src/engine/metadata-modules/object-metadata/object-metadata.entity';\nimport { PermissionsModule } from 'src/engine/metadata-modules/permissions/permissions.module';\nimport { RoleTargetEntity } from 'src/engine/metadata-modules/role-target/role-target.entity';\nimport { UserRoleModule } from 'src/engine/metadata-modules/user-role/user-role.module';\nimport { TwentyORMModule } from 'src/engine/twenty-orm/twenty-orm.module';\nimport { WorkspaceDataSourceModule } from 'src/engine/workspace-datasource/workspace-datasource.module';\n\n@Module({\n  imports: [\n    NestjsQueryGraphQLModule.forFeature({\n      imports: [\n        NestjsQueryTypeOrmModule.forFeature([\n          UserEntity,\n          UserWorkspaceEntity,\n          WorkspaceEntity,\n          RoleTargetEntity,\n        ]),\n        NestjsQueryTypeOrmModule.forFeature([ObjectMetadataEntity]),\n        TypeORMModule,\n        DataSourceModule,\n        WorkspaceDataSourceModule,\n        ApprovedAccessDomainModule,\n        WorkspaceInvitationModule,\n        WorkspaceDomainsModule,\n        TwentyORMModule,\n        UserRoleModule,\n        FileUploadModule,\n        FileModule,\n        TokenModule,\n        PermissionsModule,\n      ],\n      services: [UserWorkspaceService],\n    }),\n  ],\n  exports: [UserWorkspaceService],\n  providers: [UserWorkspaceService, UserWorkspaceResolver],\n})\nexport class UserWorkspaceModule {}",
            "output_extracted": "import { Module } from '@nestjs/common';\n\nimport { NestjsQueryGraphQLModule } from '@ptc-org/nestjs-query-graphql';\nimport { NestjsQueryTypeOrmModule } from '@ptc-org/nestjs-query-typeorm';\n\nimport { TypeORMModule } from 'src/database/typeorm/typeorm.module';\nimport { ApprovedAccessDomainModule } from 'src/engine/core-modules/approved-access-domain/approved-access-domain.module';\nimport { TokenModule } from 'src/engine/core-modules/auth/token/token.module';\nimport { WorkspaceDomainsModule } from 'src/engine/core-modules/domain/workspace-domains/workspace-domains.module';\nimport { FileUploadModule } from 'src/engine/core-modules/file/file-upload/file-upload.module';\nimport { FileModule } from 'src/engine/core-modules/file/file.module';\nimport { UserWorkspaceEntity } from 'src/engine/core-modules/user-workspace/user-workspace.entity';\nimport { UserWorkspaceResolver } from 'src/engine/core-modules/user-workspace/user-workspace.resolver';\nimport { UserWorkspaceService } from 'src/engine/core-modules/user-workspace/user-workspace.service';\nimport { UserEntity } from 'src/engine/core-modules/user/user.entity';\nimport { WorkspaceInvitationModule } from 'src/engine/core-modules/workspace-invitation/workspace-invitation.module';\nimport { WorkspaceEntity } from 'src/engine/core-modules/workspace/workspace.entity';\nimport { DataSourceModule } from 'src/engine/metadata-modules/data-source/data-source.module';\nimport { ObjectMetadataEntity } from 'src/engine/metadata-modules/object-metadata/object-metadata.entity';\nimport { PermissionsModule } from 'src/engine/metadata-modules/permissions/permissions.module';\nimport { RoleTargetEntity } from 'src/engine/metadata-modules/role-target/role-target.entity';\nimport { UserRoleModule } from 'src/engine/metadata-modules/user-role/user-role.module';\nimport { TwentyORMModule } from 'src/engine/twenty-orm/twenty-orm.module';\nimport { WorkspaceDataSourceModule } from 'src/engine/workspace-datasource/workspace-datasource.module';\n\n@Module({\n  imports: [\n    NestjsQueryGraphQLModule.forFeature({\n      imports: [\n        NestjsQueryTypeOrmModule.forFeature([\n          UserEntity,\n          UserWorkspaceEntity,\n          WorkspaceEntity,\n          RoleTargetEntity,\n        ]),\n        NestjsQueryTypeOrmModule.forFeature([ObjectMetadataEntity]),\n        TypeORMModule,\n        DataSourceModule,\n        WorkspaceDataSourceModule,\n        ApprovedAccessDomainModule,\n        WorkspaceInvitationModule,\n        WorkspaceDomainsModule,\n        TwentyORMModule,\n        UserRoleModule,\n        FileUploadModule,\n        FileModule,\n        TokenModule,\n        PermissionsModule,\n      ],\n      services: [UserWorkspaceService],\n    }),\n  ],\n  exports: [UserWorkspaceService],\n  providers: [UserWorkspaceService, UserWorkspaceResolver],\n})\nexport class UserWorkspaceModule {}",
            "cost": 0.032095
        },
        "twentyhq__twenty.main/packages/twenty-server/src/engine/core-modules/user-workspace/user-workspace.service.spec.ts": {
            "output": "import { Test, type TestingModule } from '@nestjs/testing';\nimport { getRepositoryToken } from '@nestjs/typeorm';\n\nimport { type DataSource, type Repository } from 'typeorm';\n\nimport { FileFolder } from 'src/engine/core-modules/file/interfaces/file-folder.interface';\n\nimport { type ApprovedAccessDomainEntity } from 'src/engine/core-modules/approved-access-domain/approved-access-domain.entity';\nimport { ApprovedAccessDomainService } from 'src/engine/core-modules/approved-access-domain/services/approved-access-domain.service';\nimport { AuthException } from 'src/engine/core-modules/auth/auth.exception';\nimport { LoginTokenService } from 'src/engine/core-modules/auth/token/services/login-token.service';\nimport { WorkspaceDomainsService } from 'src/engine/core-modules/domain/workspace-domains/services/workspace-domains.service';\nimport { FileStorageService } from 'src/engine/core-modules/file-storage/file-storage.service';\nimport {\n  FileUploadService,\n  type SignedFilesResult,\n} from 'src/engine/core-modules/file/file-upload/services/file-upload.service';\nimport { FileService } from 'src/engine/core-modules/file/services/file.service';\nimport { UserWorkspaceEntity } from 'src/engine/core-modules/user-workspace/user-workspace.entity';\nimport { UserWorkspaceService } from 'src/engine/core-modules/user-workspace/user-workspace.service';\nimport { UserEntity } from 'src/engine/core-modules/user/user.entity';\nimport { WorkspaceInvitationService } from 'src/engine/core-modules/workspace-invitation/services/workspace-invitation.service';\nimport { type WorkspaceEntity } from 'src/engine/core-modules/workspace/workspace.entity';\nimport { DataSourceService } from 'src/engine/metadata-modules/data-source/data-source.service';\nimport { ObjectMetadataEntity } from 'src/engine/metadata-modules/object-metadata/object-metadata.entity';\nimport { PermissionsException } from 'src/engine/metadata-modules/permissions/permissions.exception';\nimport { RoleTargetEntity } from 'src/engine/metadata-modules/role-target/role-target.entity';\nimport { UserRoleService } from 'src/engine/metadata-modules/user-role/user-role.service';\nimport { TwentyORMGlobalManager } from 'src/engine/twenty-orm/twenty-orm-global.manager';\n\ndescribe('UserWorkspaceService', () => {\n  let service: UserWorkspaceService;\n  let userWorkspaceRepository: Repository<UserWorkspaceEntity>;\n  let userRepository: Repository<UserEntity>;\n  let workspaceInvitationService: WorkspaceInvitationService;\n  let approvedAccessDomainService: ApprovedAccessDomainService;\n  let twentyORMGlobalManager: TwentyORMGlobalManager;\n  let userRoleService: UserRoleService;\n  let fileService: FileService;\n  let fileUploadService: FileUploadService;\n\n  beforeEach(async () => {\n    const module: TestingModule = await Test.createTestingModule({\n      providers: [\n        UserWorkspaceService,\n        {\n          provide: getRepositoryToken(UserWorkspaceEntity),\n          useValue: {\n            create: jest.fn(),\n            save: jest.fn(),\n            findOneBy: jest.fn(),\n            countBy: jest.fn(),\n            exists: jest.fn(),\n            findOne: jest.fn(),\n            findOneOrFail: jest.fn(),\n          },\n        },\n        {\n          provide: getRepositoryToken(UserEntity),\n          useValue: {\n            findOne: jest.fn(),\n          },\n        },\n        {\n          provide: getRepositoryToken(ObjectMetadataEntity),\n          useValue: {\n            findOneOrFail: jest.fn(),\n          },\n        },\n        {\n          provide: getRepositoryToken(RoleTargetEntity),\n          useValue: {\n            findOneOrFail: jest.fn(),\n          },\n        },\n        {\n          provide: DataSourceService,\n          useValue: {\n            getLastDataSourceMetadataFromWorkspaceIdOrFail: jest.fn(),\n          },\n        },\n        {\n          provide: WorkspaceInvitationService,\n          useValue: {\n            invalidateWorkspaceInvitation: jest.fn(),\n            findInvitationsByEmail: jest.fn(),\n          },\n        },\n        {\n          provide: WorkspaceDomainsService,\n          useValue: {\n            getWorkspaceUrls: jest.fn(),\n          },\n        },\n        {\n          provide: ApprovedAccessDomainService,\n          useValue: {\n            findValidatedApprovedAccessDomainWithWorkspacesAndSSOIdentityProvidersDomain:\n              jest.fn().mockResolvedValue([]),\n          },\n        },\n        {\n          provide: TwentyORMGlobalManager,\n          useValue: {\n            getRepositoryForWorkspace: jest.fn(),\n          },\n        },\n        {\n          provide: UserRoleService,\n          useValue: {\n            assignRoleToManyUserWorkspace: jest.fn(),\n          },\n        },\n        {\n          provide: FileStorageService,\n          useValue: {\n            copy: jest.fn(),\n          },\n        },\n        {\n          provide: LoginTokenService,\n          useValue: {},\n        },\n        {\n          provide: FileUploadService,\n          useValue: {\n            uploadImageFromUrl: jest.fn(),\n          },\n        },\n        {\n          provide: FileService,\n          useValue: {\n            copyFileFromWorkspaceToWorkspace: jest.fn(),\n          },\n        },\n      ],\n    }).compile();\n\n    service = module.get<UserWorkspaceService>(UserWorkspaceService);\n    fileService = module.get<FileService>(FileService);\n    userWorkspaceRepository = module.get(\n      getRepositoryToken(UserWorkspaceEntity),\n    );\n    userRepository = module.get(getRepositoryToken(UserEntity));\n    workspaceInvitationService = module.get<WorkspaceInvitationService>(\n      WorkspaceInvitationService,\n    );\n    approvedAccessDomainService = module.get<ApprovedAccessDomainService>(\n      ApprovedAccessDomainService,\n    );\n    twentyORMGlobalManager = module.get<TwentyORMGlobalManager>(\n      TwentyORMGlobalManager,\n    );\n    userRoleService = module.get<UserRoleService>(UserRoleService);\n    fileUploadService = module.get<FileUploadService>(FileUploadService);\n  });\n\n  it('should be defined', () => {\n    expect(service).toBeDefined();\n  });\n\n  describe('create', () => {\n    it(\"should create a user workspace with a default avatar url if it's an existing user with a user workspace having a default avatar url\", async () => {\n      const userId = 'user-id';\n      const workspaceId = 'workspace-id';\n      const userWorkspace = {\n        userId,\n        workspaceId,\n      } as UserWorkspaceEntity;\n\n      jest\n        .spyOn(userWorkspaceRepository, 'create')\n        .mockReturnValue(userWorkspace);\n      jest\n        .spyOn(userWorkspaceRepository, 'save')\n        .mockResolvedValue(userWorkspace);\n      jest.spyOn(userWorkspaceRepository, 'findOne').mockResolvedValue({\n        defaultAvatarUrl: 'path/to/file',\n      } as UserWorkspaceEntity);\n      jest\n        .spyOn(fileService, 'copyFileFromWorkspaceToWorkspace')\n        .mockResolvedValue(['', 'path/to', 'copy']);\n\n      const result = await service.create({\n        userId,\n        workspaceId,\n        isExistingUser: true,\n      });\n\n      expect(userWorkspaceRepository.create).toHaveBeenCalledWith({\n        userId,\n        workspaceId,\n        defaultAvatarUrl: 'path/to/copy',\n      });\n\n      expect(userWorkspaceRepository.save).toHaveBeenCalledWith(userWorkspace);\n      expect(result).toEqual(userWorkspace);\n    });\n    it(\"should create a user workspace without a default avatar url if it's an existing user without any user workspace having a default avatar url\", async () => {\n      const userId = 'user-id';\n      const workspaceId = 'workspace-id';\n      const userWorkspace = {\n        userId,\n        workspaceId,\n      } as UserWorkspaceEntity;\n\n      jest\n        .spyOn(userWorkspaceRepository, 'create')\n        .mockReturnValue(userWorkspace);\n      jest\n        .spyOn(userWorkspaceRepository, 'save')\n        .mockResolvedValue(userWorkspace);\n\n      jest.spyOn(userWorkspaceRepository, 'findOne').mockResolvedValue(null);\n\n      const result = await service.create({\n        userId,\n        workspaceId,\n        isExistingUser: true,\n      });\n\n      expect(userWorkspaceRepository.create).toHaveBeenCalledWith({\n        userId,\n        workspaceId,\n        defaultAvatarUrl: undefined,\n      });\n      expect(userWorkspaceRepository.save).toHaveBeenCalledWith(userWorkspace);\n      expect(result).toEqual(userWorkspace);\n    });\n    it(\"should create a user workspace with a default avatar url if it's a new user with a picture url\", async () => {\n      const userId = 'user-id';\n      const workspaceId = 'workspace-id';\n      const userWorkspace = {\n        userId,\n        workspaceId,\n      } as UserWorkspaceEntity;\n\n      jest\n        .spyOn(userWorkspaceRepository, 'create')\n        .mockReturnValue(userWorkspace);\n      jest\n        .spyOn(userWorkspaceRepository, 'save')\n        .mockResolvedValue(userWorkspace);\n\n      jest.spyOn(fileUploadService, 'uploadImageFromUrl').mockResolvedValue({\n        files: [{ path: 'path/to/file', token: 'token' }],\n      } as SignedFilesResult);\n\n      const result = await service.create({\n        userId,\n        workspaceId,\n        isExistingUser: false,\n        pictureUrl: 'picture-url',\n      });\n\n      expect(fileUploadService.uploadImageFromUrl).toHaveBeenCalledWith({\n        imageUrl: 'picture-url',\n        fileFolder: FileFolder.ProfilePicture,\n        workspaceId,\n      });\n      expect(userWorkspaceRepository.create).toHaveBeenCalledWith({\n        userId,\n        workspaceId,\n        defaultAvatarUrl: 'path/to/file',\n      });\n      expect(userWorkspaceRepository.save).toHaveBeenCalledWith(userWorkspace);\n      expect(result).toEqual(userWorkspace);\n    });\n    it(\"should create a user workspace without a default avatar url if it's a new user without a picture url\", async () => {\n      const userId = 'user-id';\n      const workspaceId = 'workspace-id';\n      const userWorkspace = {\n        userId,\n        workspaceId,\n      } as unknown as UserWorkspaceEntity;\n\n      jest\n        .spyOn(userWorkspaceRepository, 'create')\n        .mockReturnValue(userWorkspace);\n      jest\n        .spyOn(userWorkspaceRepository, 'save')\n        .mockResolvedValue(userWorkspace);\n\n      const result = await service.create({\n        userId,\n        workspaceId,\n        isExistingUser: false,\n        pictureUrl: undefined,\n      });\n\n      expect(userWorkspaceRepository.save).toHaveBeenCalledWith(userWorkspace);\n      expect(result).toEqual(userWorkspace);\n    });\n\n    it(\"should create a user workspace without a default avatar url if it's a new user with an empty picture url\", async () => {\n      const userId = 'user-id';\n      const workspaceId = 'workspace-id';\n      const userWorkspace = {\n        userId,\n        workspaceId,\n      } as unknown as UserWorkspaceEntity;\n\n      jest\n        .spyOn(userWorkspaceRepository, 'create')\n        .mockReturnValue(userWorkspace);\n      jest\n        .spyOn(userWorkspaceRepository, 'save')\n        .mockResolvedValue(userWorkspace);\n\n      const uploadImageFromUrlSpy = jest\n        .spyOn(fileUploadService, 'uploadImageFromUrl')\n        .mockResolvedValue({\n          files: [{ path: 'path/to/file', token: 'token' }],\n        } as SignedFilesResult);\n\n      const result = await service.create({\n        userId,\n        workspaceId,\n        isExistingUser: false,\n        pictureUrl: '',\n      });\n\n      expect(uploadImageFromUrlSpy).not.toHaveBeenCalled();\n\n      expect(userWorkspaceRepository.create).toHaveBeenCalledWith({\n        userId,\n        workspaceId,\n        defaultAvatarUrl: undefined,\n      });\n      expect(userWorkspaceRepository.save).toHaveBeenCalledWith(userWorkspace);\n      expect(result).toEqual(userWorkspace);\n    });\n  });\n\n  describe('createWorkspaceMember', () => {\n    it('should create a workspace member', async () => {\n      const workspaceId = 'workspace-id';\n      const user = {\n        id: 'user-id',\n        email: 'test@example.com',\n        firstName: 'John',\n        lastName: 'Doe',\n        defaultAvatarUrl: 'avatar-url',\n        locale: 'en',\n      } as UserEntity;\n      const mainDataSource = {\n        query: jest.fn(),\n      } as unknown as DataSource;\n      const workspaceMember = [\n        {\n          id: 'workspace-member-id',\n          nameFirstName: 'John',\n          nameLastName: 'Doe',\n          userId: 'user-id',\n          userEmail: 'test@example.com',\n        },\n      ];\n      const workspaceMemberRepository = {\n        insert: jest.fn(),\n        find: jest.fn().mockResolvedValue(workspaceMember),\n      };\n\n      jest\n        .spyOn(mainDataSource, 'query')\n        .mockResolvedValueOnce(undefined)\n        .mockResolvedValueOnce(workspaceMember);\n      jest\n        .spyOn(twentyORMGlobalManager, 'getRepositoryForWorkspace')\n        .mockResolvedValue(workspaceMemberRepository as any);\n\n      jest.spyOn(userWorkspaceRepository, 'findOneOrFail').mockResolvedValue({\n        defaultAvatarUrl: 'userWorkspace-avatar-url',\n      } as UserWorkspaceEntity);\n\n      await service.createWorkspaceMember(workspaceId, user);\n\n      expect(workspaceMemberRepository.insert).toHaveBeenCalledWith({\n        name: {\n          firstName: user.firstName,\n          lastName: user.lastName,\n        },\n        colorScheme: 'System',\n        userId: user.id,\n        userEmail: user.email,\n        locale: 'en',\n        avatarUrl: 'userWorkspace-avatar-url',\n      });\n    });\n  });\n\n  describe('addUserToWorkspaceIfUserNotInWorkspace', () => {\n    it('should add user to workspace if not already in workspace', async () => {\n      const user = {\n        id: 'user-id',\n        email: 'test@example.com',\n      } as UserEntity;\n      const workspace = {\n        id: 'workspace-id',\n        defaultRoleId: 'default-role-id',\n      } as WorkspaceEntity;\n      const userWorkspace = {\n        id: '",
            "output_extracted": "import { Test, type TestingModule } from '@nestjs/testing';\nimport { getRepositoryToken } from '@nestjs/typeorm';\n\nimport { type DataSource, type Repository } from 'typeorm';\n\nimport { FileFolder } from 'src/engine/core-modules/file/interfaces/file-folder.interface';\n\nimport { type ApprovedAccessDomainEntity } from 'src/engine/core-modules/approved-access-domain/approved-access-domain.entity';\nimport { ApprovedAccessDomainService } from 'src/engine/core-modules/approved-access-domain/services/approved-access-domain.service';\nimport { AuthException } from 'src/engine/core-modules/auth/auth.exception';\nimport { LoginTokenService } from 'src/engine/core-modules/auth/token/services/login-token.service';\nimport { WorkspaceDomainsService } from 'src/engine/core-modules/domain/workspace-domains/services/workspace-domains.service';\nimport { FileStorageService } from 'src/engine/core-modules/file-storage/file-storage.service';\nimport {\n  FileUploadService,\n  type SignedFilesResult,\n} from 'src/engine/core-modules/file/file-upload/services/file-upload.service';\nimport { FileService } from 'src/engine/core-modules/file/services/file.service';\nimport { UserWorkspaceEntity } from 'src/engine/core-modules/user-workspace/user-workspace.entity';\nimport { UserWorkspaceService } from 'src/engine/core-modules/user-workspace/user-workspace.service';\nimport { UserEntity } from 'src/engine/core-modules/user/user.entity';\nimport { WorkspaceInvitationService } from 'src/engine/core-modules/workspace-invitation/services/workspace-invitation.service';\nimport { type WorkspaceEntity } from 'src/engine/core-modules/workspace/workspace.entity';\nimport { DataSourceService } from 'src/engine/metadata-modules/data-source/data-source.service';\nimport { ObjectMetadataEntity } from 'src/engine/metadata-modules/object-metadata/object-metadata.entity';\nimport { PermissionsException } from 'src/engine/metadata-modules/permissions/permissions.exception';\nimport { RoleTargetEntity } from 'src/engine/metadata-modules/role-target/role-target.entity';\nimport { UserRoleService } from 'src/engine/metadata-modules/user-role/user-role.service';\nimport { TwentyORMGlobalManager } from 'src/engine/twenty-orm/twenty-orm-global.manager';\n\ndescribe('UserWorkspaceService', () => {\n  let service: UserWorkspaceService;\n  let userWorkspaceRepository: Repository<UserWorkspaceEntity>;\n  let userRepository: Repository<UserEntity>;\n  let workspaceInvitationService: WorkspaceInvitationService;\n  let approvedAccessDomainService: ApprovedAccessDomainService;\n  let twentyORMGlobalManager: TwentyORMGlobalManager;\n  let userRoleService: UserRoleService;\n  let fileService: FileService;\n  let fileUploadService: FileUploadService;\n\n  beforeEach(async () => {\n    const module: TestingModule = await Test.createTestingModule({\n      providers: [\n        UserWorkspaceService,\n        {\n          provide: getRepositoryToken(UserWorkspaceEntity),\n          useValue: {\n            create: jest.fn(),\n            save: jest.fn(),\n            findOneBy: jest.fn(),\n            countBy: jest.fn(),\n            exists: jest.fn(),\n            findOne: jest.fn(),\n            findOneOrFail: jest.fn(),\n          },\n        },\n        {\n          provide: getRepositoryToken(UserEntity),\n          useValue: {\n            findOne: jest.fn(),\n          },\n        },\n        {\n          provide: getRepositoryToken(ObjectMetadataEntity),\n          useValue: {\n            findOneOrFail: jest.fn(),\n          },\n        },\n        {\n          provide: getRepositoryToken(RoleTargetEntity),\n          useValue: {\n            findOneOrFail: jest.fn(),\n          },\n        },\n        {\n          provide: DataSourceService,\n          useValue: {\n            getLastDataSourceMetadataFromWorkspaceIdOrFail: jest.fn(),\n          },\n        },\n        {\n          provide: WorkspaceInvitationService,\n          useValue: {\n            invalidateWorkspaceInvitation: jest.fn(),\n            findInvitationsByEmail: jest.fn(),\n          },\n        },\n        {\n          provide: WorkspaceDomainsService,\n          useValue: {\n            getWorkspaceUrls: jest.fn(),\n          },\n        },\n        {\n          provide: ApprovedAccessDomainService,\n          useValue: {\n            findValidatedApprovedAccessDomainWithWorkspacesAndSSOIdentityProvidersDomain:\n              jest.fn().mockResolvedValue([]),\n          },\n        },\n        {\n          provide: TwentyORMGlobalManager,\n          useValue: {\n            getRepositoryForWorkspace: jest.fn(),\n          },\n        },\n        {\n          provide: UserRoleService,\n          useValue: {\n            assignRoleToManyUserWorkspace: jest.fn(),\n          },\n        },\n        {\n          provide: FileStorageService,\n          useValue: {\n            copy: jest.fn(),\n          },\n        },\n        {\n          provide: LoginTokenService,\n          useValue: {},\n        },\n        {\n          provide: FileUploadService,\n          useValue: {\n            uploadImageFromUrl: jest.fn(),\n          },\n        },\n        {\n          provide: FileService,\n          useValue: {\n            copyFileFromWorkspaceToWorkspace: jest.fn(),\n          },\n        },\n      ],\n    }).compile();\n\n    service = module.get<UserWorkspaceService>(UserWorkspaceService);\n    fileService = module.get<FileService>(FileService);\n    userWorkspaceRepository = module.get(\n      getRepositoryToken(UserWorkspaceEntity),\n    );\n    userRepository = module.get(getRepositoryToken(UserEntity));\n    workspaceInvitationService = module.get<WorkspaceInvitationService>(\n      WorkspaceInvitationService,\n    );\n    approvedAccessDomainService = module.get<ApprovedAccessDomainService>(\n      ApprovedAccessDomainService,\n    );\n    twentyORMGlobalManager = module.get<TwentyORMGlobalManager>(\n      TwentyORMGlobalManager,\n    );\n    userRoleService = module.get<UserRoleService>(UserRoleService);\n    fileUploadService = module.get<FileUploadService>(FileUploadService);\n  });\n\n  it('should be defined', () => {\n    expect(service).toBeDefined();\n  });\n\n  describe('create', () => {\n    it(\"should create a user workspace with a default avatar url if it's an existing user with a user workspace having a default avatar url\", async () => {\n      const userId = 'user-id';\n      const workspaceId = 'workspace-id';\n      const userWorkspace = {\n        userId,\n        workspaceId,\n      } as UserWorkspaceEntity;\n\n      jest\n        .spyOn(userWorkspaceRepository, 'create')\n        .mockReturnValue(userWorkspace);\n      jest\n        .spyOn(userWorkspaceRepository, 'save')\n        .mockResolvedValue(userWorkspace);\n      jest.spyOn(userWorkspaceRepository, 'findOne').mockResolvedValue({\n        defaultAvatarUrl: 'path/to/file',\n      } as UserWorkspaceEntity);\n      jest\n        .spyOn(fileService, 'copyFileFromWorkspaceToWorkspace')\n        .mockResolvedValue(['', 'path/to', 'copy']);\n\n      const result = await service.create({\n        userId,\n        workspaceId,\n        isExistingUser: true,\n      });\n\n      expect(userWorkspaceRepository.create).toHaveBeenCalledWith({\n        userId,\n        workspaceId,\n        defaultAvatarUrl: 'path/to/copy',\n      });\n\n      expect(userWorkspaceRepository.save).toHaveBeenCalledWith(userWorkspace);\n      expect(result).toEqual(userWorkspace);\n    });\n    it(\"should create a user workspace without a default avatar url if it's an existing user without any user workspace having a default avatar url\", async () => {\n      const userId = 'user-id';\n      const workspaceId = 'workspace-id';\n      const userWorkspace = {\n        userId,\n        workspaceId,\n      } as UserWorkspaceEntity;\n\n      jest\n        .spyOn(userWorkspaceRepository, 'create')\n        .mockReturnValue(userWorkspace);\n      jest\n        .spyOn(userWorkspaceRepository, 'save')\n        .mockResolvedValue(userWorkspace);\n\n      jest.spyOn(userWorkspaceRepository, 'findOne').mockResolvedValue(null);\n\n      const result = await service.create({\n        userId,\n        workspaceId,\n        isExistingUser: true,\n      });\n\n      expect(userWorkspaceRepository.create).toHaveBeenCalledWith({\n        userId,\n        workspaceId,\n        defaultAvatarUrl: undefined,\n      });\n      expect(userWorkspaceRepository.save).toHaveBeenCalledWith(userWorkspace);\n      expect(result).toEqual(userWorkspace);\n    });\n    it(\"should create a user workspace with a default avatar url if it's a new user with a picture url\", async () => {\n      const userId = 'user-id';\n      const workspaceId = 'workspace-id';\n      const userWorkspace = {\n        userId,\n        workspaceId,\n      } as UserWorkspaceEntity;\n\n      jest\n        .spyOn(userWorkspaceRepository, 'create')\n        .mockReturnValue(userWorkspace);\n      jest\n        .spyOn(userWorkspaceRepository, 'save')\n        .mockResolvedValue(userWorkspace);\n\n      jest.spyOn(fileUploadService, 'uploadImageFromUrl').mockResolvedValue({\n        files: [{ path: 'path/to/file', token: 'token' }],\n      } as SignedFilesResult);\n\n      const result = await service.create({\n        userId,\n        workspaceId,\n        isExistingUser: false,\n        pictureUrl: 'picture-url',\n      });\n\n      expect(fileUploadService.uploadImageFromUrl).toHaveBeenCalledWith({\n        imageUrl: 'picture-url',\n        fileFolder: FileFolder.ProfilePicture,\n        workspaceId,\n      });\n      expect(userWorkspaceRepository.create).toHaveBeenCalledWith({\n        userId,\n        workspaceId,\n        defaultAvatarUrl: 'path/to/file',\n      });\n      expect(userWorkspaceRepository.save).toHaveBeenCalledWith(userWorkspace);\n      expect(result).toEqual(userWorkspace);\n    });\n    it(\"should create a user workspace without a default avatar url if it's a new user without a picture url\", async () => {\n      const userId = 'user-id';\n      const workspaceId = 'workspace-id';\n      const userWorkspace = {\n        userId,\n        workspaceId,\n      } as unknown as UserWorkspaceEntity;\n\n      jest\n        .spyOn(userWorkspaceRepository, 'create')\n        .mockReturnValue(userWorkspace);\n      jest\n        .spyOn(userWorkspaceRepository, 'save')\n        .mockResolvedValue(userWorkspace);\n\n      const result = await service.create({\n        userId,\n        workspaceId,\n        isExistingUser: false,\n        pictureUrl: undefined,\n      });\n\n      expect(userWorkspaceRepository.save).toHaveBeenCalledWith(userWorkspace);\n      expect(result).toEqual(userWorkspace);\n    });\n\n    it(\"should create a user workspace without a default avatar url if it's a new user with an empty picture url\", async () => {\n      const userId = 'user-id';\n      const workspaceId = 'workspace-id';\n      const userWorkspace = {\n        userId,\n        workspaceId,\n      } as unknown as UserWorkspaceEntity;\n\n      jest\n        .spyOn(userWorkspaceRepository, 'create')\n        .mockReturnValue(userWorkspace);\n      jest\n        .spyOn(userWorkspaceRepository, 'save')\n        .mockResolvedValue(userWorkspace);\n\n      const uploadImageFromUrlSpy = jest\n        .spyOn(fileUploadService, 'uploadImageFromUrl')\n        .mockResolvedValue({\n          files: [{ path: 'path/to/file', token: 'token' }],\n        } as SignedFilesResult);\n\n      const result = await service.create({\n        userId,\n        workspaceId,\n        isExistingUser: false,\n        pictureUrl: '',\n      });\n\n      expect(uploadImageFromUrlSpy).not.toHaveBeenCalled();\n\n      expect(userWorkspaceRepository.create).toHaveBeenCalledWith({\n        userId,\n        workspaceId,\n        defaultAvatarUrl: undefined,\n      });\n      expect(userWorkspaceRepository.save).toHaveBeenCalledWith(userWorkspace);\n      expect(result).toEqual(userWorkspace);\n    });\n  });\n\n  describe('createWorkspaceMember', () => {\n    it('should create a workspace member', async () => {\n      const workspaceId = 'workspace-id';\n      const user = {\n        id: 'user-id',\n        email: 'test@example.com',\n        firstName: 'John',\n        lastName: 'Doe',\n        defaultAvatarUrl: 'avatar-url',\n        locale: 'en',\n      } as UserEntity;\n      const mainDataSource = {\n        query: jest.fn(),\n      } as unknown as DataSource;\n      const workspaceMember = [\n        {\n          id: 'workspace-member-id',\n          nameFirstName: 'John',\n          nameLastName: 'Doe',\n          userId: 'user-id',\n          userEmail: 'test@example.com',\n        },\n      ];\n      const workspaceMemberRepository = {\n        insert: jest.fn(),\n        find: jest.fn().mockResolvedValue(workspaceMember),\n      };\n\n      jest\n        .spyOn(mainDataSource, 'query')\n        .mockResolvedValueOnce(undefined)\n        .mockResolvedValueOnce(workspaceMember);\n      jest\n        .spyOn(twentyORMGlobalManager, 'getRepositoryForWorkspace')\n        .mockResolvedValue(workspaceMemberRepository as any);\n\n      jest.spyOn(userWorkspaceRepository, 'findOneOrFail').mockResolvedValue({\n        defaultAvatarUrl: 'userWorkspace-avatar-url',\n      } as UserWorkspaceEntity);\n\n      await service.createWorkspaceMember(workspaceId, user);\n\n      expect(workspaceMemberRepository.insert).toHaveBeenCalledWith({\n        name: {\n          firstName: user.firstName,\n          lastName: user.lastName,\n        },\n        colorScheme: 'System',\n        userId: user.id,\n        userEmail: user.email,\n        locale: 'en',\n        avatarUrl: 'userWorkspace-avatar-url',\n      });\n    });\n  });\n\n  describe('addUserToWorkspaceIfUserNotInWorkspace', () => {\n    it('should add user to workspace if not already in workspace', async () => {\n      const user = {\n        id: 'user-id',\n        email: 'test@example.com',\n      } as UserEntity;\n      const workspace = {\n        id: 'workspace-id',\n        defaultRoleId: 'default-role-id',\n      } as WorkspaceEntity;\n      const userWorkspace = {\n        id: '",
            "cost": 0.155205
        },
        "twentyhq__twenty.main/packages/twenty-server/src/engine/core-modules/user-workspace/user-workspace.service.ts": {
            "output": "import { InjectRepository } from '@nestjs/typeorm';\n\nimport { TypeOrmQueryService } from '@ptc-org/nestjs-query-typeorm';\nimport { type APP_LOCALES, SOURCE_LOCALE } from 'twenty-shared/translations';\nimport { assertIsDefinedOrThrow, isDefined } from 'twenty-shared/utils';\nimport { type QueryRunner, IsNull, Not, Repository } from 'typeorm';\n\nimport { FileStorageExceptionCode } from 'src/engine/core-modules/file-storage/interfaces/file-storage-exception';\nimport { FileFolder } from 'src/engine/core-modules/file/interfaces/file-folder.interface';\n\nimport { type AppTokenEntity } from 'src/engine/core-modules/app-token/app-token.entity';\nimport { ApprovedAccessDomainService } from 'src/engine/core-modules/approved-access-domain/services/approved-access-domain.service';\nimport {\n  AuthException,\n  AuthExceptionCode,\n} from 'src/engine/core-modules/auth/auth.exception';\nimport { type AvailableWorkspace } from 'src/engine/core-modules/auth/dto/available-workspaces.output';\nimport { LoginTokenService } from 'src/engine/core-modules/auth/token/services/login-token.service';\nimport { WorkspaceDomainsService } from 'src/engine/core-modules/domain/workspace-domains/services/workspace-domains.service';\nimport { FileUploadService } from 'src/engine/core-modules/file/file-upload/services/file-upload.service';\nimport { FileService } from 'src/engine/core-modules/file/services/file.service';\nimport { UserWorkspaceEntity } from 'src/engine/core-modules/user-workspace/user-workspace.entity';\nimport { UserEntity } from 'src/engine/core-modules/user/user.entity';\nimport { WorkspaceInvitationService } from 'src/engine/core-modules/workspace-invitation/services/workspace-invitation.service';\nimport { AuthProviderEnum } from 'src/engine/core-modules/workspace/types/workspace.type';\nimport { WorkspaceEntity } from 'src/engine/core-modules/workspace/workspace.entity';\nimport { workspaceValidator } from 'src/engine/core-modules/workspace/workspace.validate';\nimport {\n  PermissionsException,\n  PermissionsExceptionCode,\n  PermissionsExceptionMessage,\n} from 'src/engine/metadata-modules/permissions/permissions.exception';\nimport { RoleTargetEntity } from 'src/engine/metadata-modules/role-target/role-target.entity';\nimport { UserRoleService } from 'src/engine/metadata-modules/user-role/user-role.service';\nimport { TwentyORMGlobalManager } from 'src/engine/twenty-orm/twenty-orm-global.manager';\nimport { WorkspaceMemberWorkspaceEntity } from 'src/modules/workspace-member/standard-objects/workspace-member.workspace-entity';\nimport { assert } from 'src/utils/assert';\nimport { getDomainNameByEmail } from 'src/utils/get-domain-name-by-email';\n\nexport class UserWorkspaceService extends TypeOrmQueryService<UserWorkspaceEntity> {\n  constructor(\n    @InjectRepository(UserWorkspaceEntity)\n    private readonly userWorkspaceRepository: Repository<UserWorkspaceEntity>,\n    @InjectRepository(UserEntity)\n    private readonly userRepository: Repository<UserEntity>,\n    @InjectRepository(RoleTargetEntity)\n    private readonly roleTargetRepository: Repository<RoleTargetEntity>,\n    private readonly workspaceInvitationService: WorkspaceInvitationService,\n    private readonly workspaceDomainsService: WorkspaceDomainsService,\n    private readonly loginTokenService: LoginTokenService,\n    private readonly approvedAccessDomainService: ApprovedAccessDomainService,\n    private readonly twentyORMGlobalManager: TwentyORMGlobalManager,\n    private readonly userRoleService: UserRoleService,\n    private readonly fileUploadService: FileUploadService,\n    private readonly fileService: FileService,\n  ) {\n    super(userWorkspaceRepository);\n  }\n\n  async create(\n    {\n      userId,\n      workspaceId,\n      isExistingUser,\n      pictureUrl,\n    }: {\n      userId: string;\n      workspaceId: string;\n      isExistingUser: boolean;\n      pictureUrl?: string;\n    },\n    queryRunner?: QueryRunner,\n  ): Promise<UserWorkspaceEntity> {\n    const defaultAvatarUrl = await this.computeDefaultAvatarUrl(\n      userId,\n      workspaceId,\n      isExistingUser,\n      pictureUrl,\n    );\n\n    const userWorkspace = this.userWorkspaceRepository.create({\n      userId,\n      workspaceId,\n      defaultAvatarUrl,\n    });\n\n    return queryRunner\n      ? queryRunner.manager.save(UserWorkspaceEntity, userWorkspace)\n      : this.userWorkspaceRepository.save(userWorkspace);\n  }\n\n  async createWorkspaceMember(workspaceId: string, user: UserEntity) {\n    const workspaceMemberRepository =\n      await this.twentyORMGlobalManager.getRepositoryForWorkspace<WorkspaceMemberWorkspaceEntity>(\n        workspaceId,\n        'workspaceMember',\n        { shouldBypassPermissionChecks: true },\n      );\n\n    const userWorkspace = await this.userWorkspaceRepository.findOneOrFail({\n      where: {\n        userId: user.id,\n        workspaceId,\n      },\n    });\n\n    await workspaceMemberRepository.insert({\n      name: {\n        firstName: user.firstName,\n        lastName: user.lastName,\n      },\n      colorScheme: 'System',\n      userId: user.id,\n      userEmail: user.email,\n      avatarUrl: userWorkspace.defaultAvatarUrl ?? '',\n      locale: (user.locale ?? SOURCE_LOCALE) as keyof typeof APP_LOCALES,\n    });\n\n    const workspaceMember = await workspaceMemberRepository.find({\n      where: {\n        userId: user.id,\n      },\n    });\n\n    assert(\n      workspaceMember?.length === 1,\n      `Error while creating workspace member ${user.email} on workspace ${workspaceId}`,\n    );\n  }\n\n  async addUserToWorkspaceIfUserNotInWorkspace(\n    user: UserEntity,\n    workspace: WorkspaceEntity,\n  ) {\n    let userWorkspace = await this.checkUserWorkspaceExists(\n      user.id,\n      workspace.id,\n    );\n\n    if (!userWorkspace) {\n      userWorkspace = await this.create({\n        userId: user.id,\n        workspaceId: workspace.id,\n        isExistingUser: true,\n      });\n\n      await this.createWorkspaceMember(workspace.id, user);\n\n      const defaultRoleId = workspace.defaultRoleId;\n\n      if (!isDefined(defaultRoleId)) {\n        throw new PermissionsException(\n          PermissionsExceptionMessage.DEFAULT_ROLE_NOT_FOUND,\n          PermissionsExceptionCode.DEFAULT_ROLE_NOT_FOUND,\n        );\n      }\n\n      await this.userRoleService.assignRoleToManyUserWorkspace({\n        workspaceId: workspace.id,\n        userWorkspaceIds: [userWorkspace.id],\n        roleId: defaultRoleId,\n      });\n\n      await this.workspaceInvitationService.invalidateWorkspaceInvitation(\n        workspace.id,\n        user.email,\n      );\n\n      await this.onboardingService.setOnboardingCreateProfilePending({\n        userId: user.id,\n        workspaceId: workspace.id,\n        value: true,\n      });\n    }\n  }\n\n  public async getUserCount(workspaceId: string): Promise<number | undefined> {\n    return await this.userWorkspaceRepository.countBy({\n      workspaceId,\n    });\n  }\n\n  async checkUserWorkspaceExists(\n    userId: string,\n    workspaceId: string,\n  ): Promise<UserWorkspaceEntity | null> {\n    return this.userWorkspaceRepository.findOneBy({\n      userId,\n      workspaceId,\n    });\n  }\n\n  async checkUserWorkspaceExistsByEmail(email: string, workspaceId: string) {\n    return this.userWorkspaceRepository.exists({\n      where: {\n        workspaceId,\n        user: {\n          email,\n        },\n      },\n      relations: {\n        user: true,\n      },\n    });\n  }\n\n  async findFirstWorkspaceByUserId(userId: string) {\n    const user = await this.userRepository.findOne({\n      where: {\n        id: userId,\n      },\n      relations: { userWorkspaces: { workspace: true } },\n      order: {\n        userWorkspaces: {\n          workspace: {\n            createdAt: 'ASC',\n          },\n        },\n      },\n    });\n\n    const workspace = user?.userWorkspaces?.[0]?.workspace;\n\n    assertIsDefinedOrThrow(\n      workspace,\n      new AuthException(\n        'Workspace not found',\n        AuthExceptionCode.WORKSPACE_NOT_FOUND,\n      ),\n    );\n\n    return workspace;\n  }\n\n  async countUserWorkspaces(userId: string): Promise<number> {\n    return await this.userWorkspaceRepository.count({ where: { userId } });\n  }\n\n  async deleteUserWorkspace({\n    userWorkspaceId,\n    softDelete = false,\n  }: {\n    userWorkspaceId: string;\n    softDelete?: boolean;\n  }): Promise<void> {\n    if (softDelete) {\n      await this.roleTargetRepository.softRemove({ userWorkspaceId });\n      await this.userWorkspaceRepository.softDelete({ id: userWorkspaceId });\n    } else {\n      await this.roleTargetRepository.delete({ userWorkspaceId }); // TODO remove once userWorkspace foreign key is added on roleTarget\n      await this.userWorkspaceRepository.delete({ id: userWorkspaceId });\n    }\n  }\n\n  async findAvailableWorkspacesByEmail(email: string) {\n    const user = await this.userRepository.findOne({\n      where: {\n        email,\n      },\n      relations: {\n        userWorkspaces: {\n          workspace: {\n            workspaceSSOIdentityProviders: true,\n            approvedAccessDomains: true,\n          },\n        },\n      },\n    });\n\n    const alreadyMemberWorkspaces = user\n      ? user.userWorkspaces.map(({ workspace }) => ({ workspace }))\n      : [];\n\n    const alreadyMemberWorkspacesIds = alreadyMemberWorkspaces.map(\n      ({ workspace }) => workspace.id,\n    );\n\n    const workspacesFromApprovedAccessDomain = (\n      await this.approvedAccessDomainService.findValidatedApprovedAccessDomainWithWorkspacesAndSSOIdentityProvidersDomain(\n        getDomainNameByEmail(email),\n      )\n    )\n      .filter(\n        ({ workspace }) => !alreadyMemberWorkspacesIds.includes(workspace.id),\n      )\n      .map(({ workspace }) => ({ workspace }));\n\n    const workspacesFromApprovedAccessDomainIds =\n      workspacesFromApprovedAccessDomain.map(({ workspace }) => workspace.id);\n\n    const workspacesFromInvitations = (\n      await this.workspaceInvitationService.findInvitationsByEmail(email)\n    )\n      .filter(\n        ({ workspace }) =>\n          ![\n            ...alreadyMemberWorkspacesIds,\n            ...workspacesFromApprovedAccessDomainIds,\n          ].includes(workspace.id),\n      )\n      .map((appToken) => ({\n        workspace: appToken.workspace,\n        appToken,\n      }));\n\n    return {\n      availableWorkspacesForSignIn: alreadyMemberWorkspaces,\n      availableWorkspacesForSignUp: [\n        ...workspacesFromApprovedAccessDomain,\n        ...workspacesFromInvitations,\n      ],\n    };\n  }\n\n  async getUserWorkspaceForUserOrThrow({\n    userId,\n    workspaceId,\n  }: {\n    userId: string;\n    workspaceId: string;\n  }): Promise<UserWorkspaceEntity> {\n    const userWorkspace = await this.userWorkspaceRepository.findOne({\n      where: {\n        userId,\n        workspaceId,\n      },\n      relations: ['twoFactorAuthenticationMethods'],\n    });\n\n    if (!isDefined(userWorkspace)) {\n      throw new Error('User workspace not found');\n    }\n\n    return userWorkspace;\n  }\n\n  async getWorkspaceMemberOrThrow({\n    workspaceMemberId,\n    workspaceId,\n  }: {\n    workspaceMemberId: string;\n    workspaceId: string;\n  }): Promise<WorkspaceMemberWorkspaceEntity> {\n    const workspaceMemberRepository =\n      await this.twentyORMGlobalManager.getRepositoryForWorkspace<WorkspaceMemberWorkspaceEntity>(\n        workspaceId,\n        'workspaceMember',\n        { shouldBypassPermissionChecks: true },\n      );\n\n    const workspaceMember = await workspaceMemberRepository.findOne({\n      where: {\n        id: workspaceMemberId,\n      },\n    });\n\n    if (!isDefined(workspaceMember)) {\n      throw new Error('Workspace member not found');\n    }\n\n    return workspaceMember;\n  }\n\n  private async computeDefaultAvatarUrl(\n    userId: string,\n    workspaceId: string,\n    isExistingUser: boolean,\n    pictureUrl?: string,\n  ) {\n    if (isExistingUser) {\n      const userWorkspace = await this.userWorkspaceRepository.findOne({\n        where: {\n          userId,\n          defaultAvatarUrl: Not(IsNull()),\n        },\n        order: {\n          createdAt: 'ASC',\n        },\n      });\n\n      if (!isDefined(userWorkspace?.defaultAvatarUrl)) return;\n\n      try {\n        const [_, subFolder, filename] =\n          await this.fileService.copyFileFromWorkspaceToWorkspace(\n            userWorkspace.workspaceId,\n            userWorkspace.defaultAvatarUrl,\n            workspaceId,\n          );\n\n        return `${subFolder}/${filename}`;\n      } catch (error) {\n        if (error.code === FileStorageExceptionCode.FILE_NOT_FOUND) {\n          return;\n        }\n        throw error;\n      }\n    }\n\n    if (!isDefined(pictureUrl) || pictureUrl === '') return;\n\n    const { files } = await this.fileUploadService.uploadImageFromUrl({\n      imageUrl: pictureUrl,\n      fileFolder: FileFolder.ProfilePicture,\n      workspaceId,\n    });\n\n    if (!files.length) {\n      throw new Error('Failed to upload avatar');\n    }\n\n    return files[0].path;\n  }\n\n  castWorkspaceToAvailableWorkspace(workspace: WorkspaceEntity) {\n    return {\n      id: workspace.id,\n      displayName: workspace.displayName,\n      workspaceUrls: this.workspaceDomainsService.getWorkspaceUrls(workspace),\n      logo: workspace.logo\n        ? this.fileService.signFileUrl({\n            url: workspace.logo,\n            workspaceId: workspace.id,\n          })\n        : workspace.logo,\n      sso:\n        workspace.workspaceSSOIdentityProviders?.reduce(\n          (acc, identityProvider) =>\n            acc.concat(\n              identityProvider.status === 'Inactive'\n                ? []\n                : [\n                    {\n                      id: identityProvider.id,\n                      name: identityProvider.name,\n                      issuer: identityProvider.issuer,\n                      type: identityProvider.type,\n                      status: identityProvider.status,\n                    },\n                  ],\n            ),\n          [] as Available",
            "output_extracted": "import { InjectRepository } from '@nestjs/typeorm';\n\nimport { TypeOrmQueryService } from '@ptc-org/nestjs-query-typeorm';\nimport { type APP_LOCALES, SOURCE_LOCALE } from 'twenty-shared/translations';\nimport { assertIsDefinedOrThrow, isDefined } from 'twenty-shared/utils';\nimport { type QueryRunner, IsNull, Not, Repository } from 'typeorm';\n\nimport { FileStorageExceptionCode } from 'src/engine/core-modules/file-storage/interfaces/file-storage-exception';\nimport { FileFolder } from 'src/engine/core-modules/file/interfaces/file-folder.interface';\n\nimport { type AppTokenEntity } from 'src/engine/core-modules/app-token/app-token.entity';\nimport { ApprovedAccessDomainService } from 'src/engine/core-modules/approved-access-domain/services/approved-access-domain.service';\nimport {\n  AuthException,\n  AuthExceptionCode,\n} from 'src/engine/core-modules/auth/auth.exception';\nimport { type AvailableWorkspace } from 'src/engine/core-modules/auth/dto/available-workspaces.output';\nimport { LoginTokenService } from 'src/engine/core-modules/auth/token/services/login-token.service';\nimport { WorkspaceDomainsService } from 'src/engine/core-modules/domain/workspace-domains/services/workspace-domains.service';\nimport { FileUploadService } from 'src/engine/core-modules/file/file-upload/services/file-upload.service';\nimport { FileService } from 'src/engine/core-modules/file/services/file.service';\nimport { UserWorkspaceEntity } from 'src/engine/core-modules/user-workspace/user-workspace.entity';\nimport { UserEntity } from 'src/engine/core-modules/user/user.entity';\nimport { WorkspaceInvitationService } from 'src/engine/core-modules/workspace-invitation/services/workspace-invitation.service';\nimport { AuthProviderEnum } from 'src/engine/core-modules/workspace/types/workspace.type';\nimport { WorkspaceEntity } from 'src/engine/core-modules/workspace/workspace.entity';\nimport { workspaceValidator } from 'src/engine/core-modules/workspace/workspace.validate';\nimport {\n  PermissionsException,\n  PermissionsExceptionCode,\n  PermissionsExceptionMessage,\n} from 'src/engine/metadata-modules/permissions/permissions.exception';\nimport { RoleTargetEntity } from 'src/engine/metadata-modules/role-target/role-target.entity';\nimport { UserRoleService } from 'src/engine/metadata-modules/user-role/user-role.service';\nimport { TwentyORMGlobalManager } from 'src/engine/twenty-orm/twenty-orm-global.manager';\nimport { WorkspaceMemberWorkspaceEntity } from 'src/modules/workspace-member/standard-objects/workspace-member.workspace-entity';\nimport { assert } from 'src/utils/assert';\nimport { getDomainNameByEmail } from 'src/utils/get-domain-name-by-email';\n\nexport class UserWorkspaceService extends TypeOrmQueryService<UserWorkspaceEntity> {\n  constructor(\n    @InjectRepository(UserWorkspaceEntity)\n    private readonly userWorkspaceRepository: Repository<UserWorkspaceEntity>,\n    @InjectRepository(UserEntity)\n    private readonly userRepository: Repository<UserEntity>,\n    @InjectRepository(RoleTargetEntity)\n    private readonly roleTargetRepository: Repository<RoleTargetEntity>,\n    private readonly workspaceInvitationService: WorkspaceInvitationService,\n    private readonly workspaceDomainsService: WorkspaceDomainsService,\n    private readonly loginTokenService: LoginTokenService,\n    private readonly approvedAccessDomainService: ApprovedAccessDomainService,\n    private readonly twentyORMGlobalManager: TwentyORMGlobalManager,\n    private readonly userRoleService: UserRoleService,\n    private readonly fileUploadService: FileUploadService,\n    private readonly fileService: FileService,\n  ) {\n    super(userWorkspaceRepository);\n  }\n\n  async create(\n    {\n      userId,\n      workspaceId,\n      isExistingUser,\n      pictureUrl,\n    }: {\n      userId: string;\n      workspaceId: string;\n      isExistingUser: boolean;\n      pictureUrl?: string;\n    },\n    queryRunner?: QueryRunner,\n  ): Promise<UserWorkspaceEntity> {\n    const defaultAvatarUrl = await this.computeDefaultAvatarUrl(\n      userId,\n      workspaceId,\n      isExistingUser,\n      pictureUrl,\n    );\n\n    const userWorkspace = this.userWorkspaceRepository.create({\n      userId,\n      workspaceId,\n      defaultAvatarUrl,\n    });\n\n    return queryRunner\n      ? queryRunner.manager.save(UserWorkspaceEntity, userWorkspace)\n      : this.userWorkspaceRepository.save(userWorkspace);\n  }\n\n  async createWorkspaceMember(workspaceId: string, user: UserEntity) {\n    const workspaceMemberRepository =\n      await this.twentyORMGlobalManager.getRepositoryForWorkspace<WorkspaceMemberWorkspaceEntity>(\n        workspaceId,\n        'workspaceMember',\n        { shouldBypassPermissionChecks: true },\n      );\n\n    const userWorkspace = await this.userWorkspaceRepository.findOneOrFail({\n      where: {\n        userId: user.id,\n        workspaceId,\n      },\n    });\n\n    await workspaceMemberRepository.insert({\n      name: {\n        firstName: user.firstName,\n        lastName: user.lastName,\n      },\n      colorScheme: 'System',\n      userId: user.id,\n      userEmail: user.email,\n      avatarUrl: userWorkspace.defaultAvatarUrl ?? '',\n      locale: (user.locale ?? SOURCE_LOCALE) as keyof typeof APP_LOCALES,\n    });\n\n    const workspaceMember = await workspaceMemberRepository.find({\n      where: {\n        userId: user.id,\n      },\n    });\n\n    assert(\n      workspaceMember?.length === 1,\n      `Error while creating workspace member ${user.email} on workspace ${workspaceId}`,\n    );\n  }\n\n  async addUserToWorkspaceIfUserNotInWorkspace(\n    user: UserEntity,\n    workspace: WorkspaceEntity,\n  ) {\n    let userWorkspace = await this.checkUserWorkspaceExists(\n      user.id,\n      workspace.id,\n    );\n\n    if (!userWorkspace) {\n      userWorkspace = await this.create({\n        userId: user.id,\n        workspaceId: workspace.id,\n        isExistingUser: true,\n      });\n\n      await this.createWorkspaceMember(workspace.id, user);\n\n      const defaultRoleId = workspace.defaultRoleId;\n\n      if (!isDefined(defaultRoleId)) {\n        throw new PermissionsException(\n          PermissionsExceptionMessage.DEFAULT_ROLE_NOT_FOUND,\n          PermissionsExceptionCode.DEFAULT_ROLE_NOT_FOUND,\n        );\n      }\n\n      await this.userRoleService.assignRoleToManyUserWorkspace({\n        workspaceId: workspace.id,\n        userWorkspaceIds: [userWorkspace.id],\n        roleId: defaultRoleId,\n      });\n\n      await this.workspaceInvitationService.invalidateWorkspaceInvitation(\n        workspace.id,\n        user.email,\n      );\n\n      await this.onboardingService.setOnboardingCreateProfilePending({\n        userId: user.id,\n        workspaceId: workspace.id,\n        value: true,\n      });\n    }\n  }\n\n  public async getUserCount(workspaceId: string): Promise<number | undefined> {\n    return await this.userWorkspaceRepository.countBy({\n      workspaceId,\n    });\n  }\n\n  async checkUserWorkspaceExists(\n    userId: string,\n    workspaceId: string,\n  ): Promise<UserWorkspaceEntity | null> {\n    return this.userWorkspaceRepository.findOneBy({\n      userId,\n      workspaceId,\n    });\n  }\n\n  async checkUserWorkspaceExistsByEmail(email: string, workspaceId: string) {\n    return this.userWorkspaceRepository.exists({\n      where: {\n        workspaceId,\n        user: {\n          email,\n        },\n      },\n      relations: {\n        user: true,\n      },\n    });\n  }\n\n  async findFirstWorkspaceByUserId(userId: string) {\n    const user = await this.userRepository.findOne({\n      where: {\n        id: userId,\n      },\n      relations: { userWorkspaces: { workspace: true } },\n      order: {\n        userWorkspaces: {\n          workspace: {\n            createdAt: 'ASC',\n          },\n        },\n      },\n    });\n\n    const workspace = user?.userWorkspaces?.[0]?.workspace;\n\n    assertIsDefinedOrThrow(\n      workspace,\n      new AuthException(\n        'Workspace not found',\n        AuthExceptionCode.WORKSPACE_NOT_FOUND,\n      ),\n    );\n\n    return workspace;\n  }\n\n  async countUserWorkspaces(userId: string): Promise<number> {\n    return await this.userWorkspaceRepository.count({ where: { userId } });\n  }\n\n  async deleteUserWorkspace({\n    userWorkspaceId,\n    softDelete = false,\n  }: {\n    userWorkspaceId: string;\n    softDelete?: boolean;\n  }): Promise<void> {\n    if (softDelete) {\n      await this.roleTargetRepository.softRemove({ userWorkspaceId });\n      await this.userWorkspaceRepository.softDelete({ id: userWorkspaceId });\n    } else {\n      await this.roleTargetRepository.delete({ userWorkspaceId }); // TODO remove once userWorkspace foreign key is added on roleTarget\n      await this.userWorkspaceRepository.delete({ id: userWorkspaceId });\n    }\n  }\n\n  async findAvailableWorkspacesByEmail(email: string) {\n    const user = await this.userRepository.findOne({\n      where: {\n        email,\n      },\n      relations: {\n        userWorkspaces: {\n          workspace: {\n            workspaceSSOIdentityProviders: true,\n            approvedAccessDomains: true,\n          },\n        },\n      },\n    });\n\n    const alreadyMemberWorkspaces = user\n      ? user.userWorkspaces.map(({ workspace }) => ({ workspace }))\n      : [];\n\n    const alreadyMemberWorkspacesIds = alreadyMemberWorkspaces.map(\n      ({ workspace }) => workspace.id,\n    );\n\n    const workspacesFromApprovedAccessDomain = (\n      await this.approvedAccessDomainService.findValidatedApprovedAccessDomainWithWorkspacesAndSSOIdentityProvidersDomain(\n        getDomainNameByEmail(email),\n      )\n    )\n      .filter(\n        ({ workspace }) => !alreadyMemberWorkspacesIds.includes(workspace.id),\n      )\n      .map(({ workspace }) => ({ workspace }));\n\n    const workspacesFromApprovedAccessDomainIds =\n      workspacesFromApprovedAccessDomain.map(({ workspace }) => workspace.id);\n\n    const workspacesFromInvitations = (\n      await this.workspaceInvitationService.findInvitationsByEmail(email)\n    )\n      .filter(\n        ({ workspace }) =>\n          ![\n            ...alreadyMemberWorkspacesIds,\n            ...workspacesFromApprovedAccessDomainIds,\n          ].includes(workspace.id),\n      )\n      .map((appToken) => ({\n        workspace: appToken.workspace,\n        appToken,\n      }));\n\n    return {\n      availableWorkspacesForSignIn: alreadyMemberWorkspaces,\n      availableWorkspacesForSignUp: [\n        ...workspacesFromApprovedAccessDomain,\n        ...workspacesFromInvitations,\n      ],\n    };\n  }\n\n  async getUserWorkspaceForUserOrThrow({\n    userId,\n    workspaceId,\n  }: {\n    userId: string;\n    workspaceId: string;\n  }): Promise<UserWorkspaceEntity> {\n    const userWorkspace = await this.userWorkspaceRepository.findOne({\n      where: {\n        userId,\n        workspaceId,\n      },\n      relations: ['twoFactorAuthenticationMethods'],\n    });\n\n    if (!isDefined(userWorkspace)) {\n      throw new Error('User workspace not found');\n    }\n\n    return userWorkspace;\n  }\n\n  async getWorkspaceMemberOrThrow({\n    workspaceMemberId,\n    workspaceId,\n  }: {\n    workspaceMemberId: string;\n    workspaceId: string;\n  }): Promise<WorkspaceMemberWorkspaceEntity> {\n    const workspaceMemberRepository =\n      await this.twentyORMGlobalManager.getRepositoryForWorkspace<WorkspaceMemberWorkspaceEntity>(\n        workspaceId,\n        'workspaceMember',\n        { shouldBypassPermissionChecks: true },\n      );\n\n    const workspaceMember = await workspaceMemberRepository.findOne({\n      where: {\n        id: workspaceMemberId,\n      },\n    });\n\n    if (!isDefined(workspaceMember)) {\n      throw new Error('Workspace member not found');\n    }\n\n    return workspaceMember;\n  }\n\n  private async computeDefaultAvatarUrl(\n    userId: string,\n    workspaceId: string,\n    isExistingUser: boolean,\n    pictureUrl?: string,\n  ) {\n    if (isExistingUser) {\n      const userWorkspace = await this.userWorkspaceRepository.findOne({\n        where: {\n          userId,\n          defaultAvatarUrl: Not(IsNull()),\n        },\n        order: {\n          createdAt: 'ASC',\n        },\n      });\n\n      if (!isDefined(userWorkspace?.defaultAvatarUrl)) return;\n\n      try {\n        const [_, subFolder, filename] =\n          await this.fileService.copyFileFromWorkspaceToWorkspace(\n            userWorkspace.workspaceId,\n            userWorkspace.defaultAvatarUrl,\n            workspaceId,\n          );\n\n        return `${subFolder}/${filename}`;\n      } catch (error) {\n        if (error.code === FileStorageExceptionCode.FILE_NOT_FOUND) {\n          return;\n        }\n        throw error;\n      }\n    }\n\n    if (!isDefined(pictureUrl) || pictureUrl === '') return;\n\n    const { files } = await this.fileUploadService.uploadImageFromUrl({\n      imageUrl: pictureUrl,\n      fileFolder: FileFolder.ProfilePicture,\n      workspaceId,\n    });\n\n    if (!files.length) {\n      throw new Error('Failed to upload avatar');\n    }\n\n    return files[0].path;\n  }\n\n  castWorkspaceToAvailableWorkspace(workspace: WorkspaceEntity) {\n    return {\n      id: workspace.id,\n      displayName: workspace.displayName,\n      workspaceUrls: this.workspaceDomainsService.getWorkspaceUrls(workspace),\n      logo: workspace.logo\n        ? this.fileService.signFileUrl({\n            url: workspace.logo,\n            workspaceId: workspace.id,\n          })\n        : workspace.logo,\n      sso:\n        workspace.workspaceSSOIdentityProviders?.reduce(\n          (acc, identityProvider) =>\n            acc.concat(\n              identityProvider.status === 'Inactive'\n                ? []\n                : [\n                    {\n                      id: identityProvider.id,\n                      name: identityProvider.name,\n                      issuer: identityProvider.issuer,\n                      type: identityProvider.type,\n                      status: identityProvider.status,\n                    },\n                  ],\n            ),\n          [] as Available",
            "cost": 0.13186
        },
        "twentyhq__twenty.main/packages/twenty-server/src/modules/workspace-member/query-hooks/workspace-member-query-hook.module.ts": {
            "output": "import { Module } from '@nestjs/common';\nimport { TypeOrmModule } from '@nestjs/typeorm';\n\nimport { FeatureFlagModule } from 'src/engine/core-modules/feature-flag/feature-flag.module';\nimport { UserWorkspaceEntity } from 'src/engine/core-modules/user-workspace/user-workspace.entity';\nimport { UserWorkspaceModule } from 'src/engine/core-modules/user-workspace/user-workspace.module';\nimport { PermissionsModule } from 'src/engine/metadata-modules/permissions/permissions.module';\nimport { WorkspaceMemberCreateManyPreQueryHook } from 'src/modules/workspace-member/query-hooks/workspace-member-create-many.pre-query.hook';\nimport { WorkspaceMemberCreateOnePreQueryHook } from 'src/modules/workspace-member/query-hooks/workspace-member-create-one.pre-query.hook';\nimport { WorkspaceMemberDeleteManyPreQueryHook } from 'src/modules/workspace-member/query-hooks/workspace-member-delete-many.pre-query.hook';\nimport { WorkspaceMemberDeleteOnePostQueryHook } from 'src/modules/workspace-member/query-hooks/workspace-member-delete-one.post-query.hook';\nimport { WorkspaceMemberDeleteOnePreQueryHook } from 'src/modules/workspace-member/query-hooks/workspace-member-delete-one.pre-query.hook';\nimport { WorkspaceMemberDestroyManyPreQueryHook } from 'src/modules/workspace-member/query-hooks/workspace-member-destroy-many.pre-query.hook';\nimport { WorkspaceMemberDestroyOnePreQueryHook } from 'src/modules/workspace-member/query-hooks/workspace-member-destroy-one.pre-query.hook';\nimport { WorkspaceMemberPreQueryHookService } from 'src/modules/workspace-member/query-hooks/workspace-member-pre-query-hook.service';\nimport { WorkspaceMemberRestoreManyPreQueryHook } from 'src/modules/workspace-member/query-hooks/workspace-member-restore-many.pre-query.hook';\nimport { WorkspaceMemberRestoreOnePreQueryHook } from 'src/modules/workspace-member/query-hooks/workspace-member-restore-one.pre-query.hook';\nimport { WorkspaceMemberUpdateManyPreQueryHook } from 'src/modules/workspace-member/query-hooks/workspace-member-update-many.pre-query.hook';\nimport { WorkspaceMemberUpdateOnePreQueryHook } from 'src/modules/workspace-member/query-hooks/workspace-member-update-one.pre-query.hook';\n\n@Module({\n  providers: [\n    WorkspaceMemberPreQueryHookService,\n    WorkspaceMemberCreateOnePreQueryHook,\n    WorkspaceMemberCreateManyPreQueryHook,\n    WorkspaceMemberDeleteOnePreQueryHook,\n    WorkspaceMemberDeleteOnePostQueryHook,\n    WorkspaceMemberDeleteManyPreQueryHook,\n    WorkspaceMemberDestroyOnePreQueryHook,\n    WorkspaceMemberDestroyManyPreQueryHook,\n    WorkspaceMemberRestoreOnePreQueryHook,\n    WorkspaceMemberRestoreManyPreQueryHook,\n    WorkspaceMemberUpdateOnePreQueryHook,\n    WorkspaceMemberUpdateManyPreQueryHook,\n  ],\n  imports: [\n    FeatureFlagModule,\n    PermissionsModule,\n    UserWorkspaceModule,\n    TypeOrmModule.forFeature([UserWorkspaceEntity]),\n  ],\n})\nexport class WorkspaceMemberQueryHookModule {}",
            "output_extracted": "import { Module } from '@nestjs/common';\nimport { TypeOrmModule } from '@nestjs/typeorm';\n\nimport { FeatureFlagModule } from 'src/engine/core-modules/feature-flag/feature-flag.module';\nimport { UserWorkspaceEntity } from 'src/engine/core-modules/user-workspace/user-workspace.entity';\nimport { UserWorkspaceModule } from 'src/engine/core-modules/user-workspace/user-workspace.module';\nimport { PermissionsModule } from 'src/engine/metadata-modules/permissions/permissions.module';\nimport { WorkspaceMemberCreateManyPreQueryHook } from 'src/modules/workspace-member/query-hooks/workspace-member-create-many.pre-query.hook';\nimport { WorkspaceMemberCreateOnePreQueryHook } from 'src/modules/workspace-member/query-hooks/workspace-member-create-one.pre-query.hook';\nimport { WorkspaceMemberDeleteManyPreQueryHook } from 'src/modules/workspace-member/query-hooks/workspace-member-delete-many.pre-query.hook';\nimport { WorkspaceMemberDeleteOnePostQueryHook } from 'src/modules/workspace-member/query-hooks/workspace-member-delete-one.post-query.hook';\nimport { WorkspaceMemberDeleteOnePreQueryHook } from 'src/modules/workspace-member/query-hooks/workspace-member-delete-one.pre-query.hook';\nimport { WorkspaceMemberDestroyManyPreQueryHook } from 'src/modules/workspace-member/query-hooks/workspace-member-destroy-many.pre-query.hook';\nimport { WorkspaceMemberDestroyOnePreQueryHook } from 'src/modules/workspace-member/query-hooks/workspace-member-destroy-one.pre-query.hook';\nimport { WorkspaceMemberPreQueryHookService } from 'src/modules/workspace-member/query-hooks/workspace-member-pre-query-hook.service';\nimport { WorkspaceMemberRestoreManyPreQueryHook } from 'src/modules/workspace-member/query-hooks/workspace-member-restore-many.pre-query.hook';\nimport { WorkspaceMemberRestoreOnePreQueryHook } from 'src/modules/workspace-member/query-hooks/workspace-member-restore-one.pre-query.hook';\nimport { WorkspaceMemberUpdateManyPreQueryHook } from 'src/modules/workspace-member/query-hooks/workspace-member-update-many.pre-query.hook';\nimport { WorkspaceMemberUpdateOnePreQueryHook } from 'src/modules/workspace-member/query-hooks/workspace-member-update-one.pre-query.hook';\n\n@Module({\n  providers: [\n    WorkspaceMemberPreQueryHookService,\n    WorkspaceMemberCreateOnePreQueryHook,\n    WorkspaceMemberCreateManyPreQueryHook,\n    WorkspaceMemberDeleteOnePreQueryHook,\n    WorkspaceMemberDeleteOnePostQueryHook,\n    WorkspaceMemberDeleteManyPreQueryHook,\n    WorkspaceMemberDestroyOnePreQueryHook,\n    WorkspaceMemberDestroyManyPreQueryHook,\n    WorkspaceMemberRestoreOnePreQueryHook,\n    WorkspaceMemberRestoreManyPreQueryHook,\n    WorkspaceMemberUpdateOnePreQueryHook,\n    WorkspaceMemberUpdateManyPreQueryHook,\n  ],\n  imports: [\n    FeatureFlagModule,\n    PermissionsModule,\n    UserWorkspaceModule,\n    TypeOrmModule.forFeature([UserWorkspaceEntity]),\n  ],\n})\nexport class WorkspaceMemberQueryHookModule {}",
            "cost": 0.03368500000000001
        }
    },
    "recover_status": "success",
    "instance_ref": {
        "instance_id": "twentyhq__twenty.main.16057",
        "repo": "twentyhq/twenty",
        "base_commit": "6d141c2439cda36f09142506cac207b2b10aa72c",
        "head_commit": "770301118903345e3af6af078e655589a21140ca",
        "title": "[fix] User have no firstName nor lastName",
        "merged_at": "2025-11-25T17:23:44Z",
        "html_url": "https://github.com/twentyhq/twenty/pull/16057",
        "test_files": [
            "packages/twenty-server/src/engine/core-modules/actor/services/__tests__/created-by-from-auth-context.service.spec.ts",
            "packages/twenty-server/src/engine/core-modules/user-workspace/user-workspace.service.spec.ts"
        ],
        "code_files": [
            "packages/twenty-front/src/modules/auth/sign-in-up/hooks/useSignInUpForm.ts",
            "packages/twenty-server/src/engine/core-modules/actor/services/created-by-from-auth-context.service.ts",
            "packages/twenty-server/src/engine/core-modules/user-workspace/user-workspace.module.ts",
            "packages/twenty-server/src/engine/core-modules/user-workspace/user-workspace.service.ts",
            "packages/twenty-server/src/modules/workspace-member/query-hooks/workspace-member-query-hook.module.ts"
        ],
        "total_changes": 70,
        "num_files": 7,
        "pull_number": 16057,
        "patch": "diff --git a/packages/twenty-front/src/modules/auth/sign-in-up/hooks/useSignInUpForm.ts b/packages/twenty-front/src/modules/auth/sign-in-up/hooks/useSignInUpForm.ts\nindex cf71ceee0c2e8..b0c2b5d20f36f 100644\n--- a/packages/twenty-front/src/modules/auth/sign-in-up/hooks/useSignInUpForm.ts\n+++ b/packages/twenty-front/src/modules/auth/sign-in-up/hooks/useSignInUpForm.ts\n@@ -64,5 +64,5 @@ export const useSignInUpForm = () => {\n       form.setValue('password', 'tim@apple.dev');\n     }\n   }, [form, isDeveloperDefaultSignInPrefilled, prefilledEmail]);\n-  return { form: form };\n+  return { form };\n };\ndiff --git a/packages/twenty-server/src/engine/core-modules/actor/services/__tests__/created-by-from-auth-context.service.spec.ts b/packages/twenty-server/src/engine/core-modules/actor/services/__tests__/created-by-from-auth-context.service.spec.ts\nindex 16dfa9a136df9..b532f78729a73 100644\n--- a/packages/twenty-server/src/engine/core-modules/actor/services/__tests__/created-by-from-auth-context.service.spec.ts\n+++ b/packages/twenty-server/src/engine/core-modules/actor/services/__tests__/created-by-from-auth-context.service.spec.ts\n@@ -106,13 +106,25 @@ describe('CreatedByFromAuthContextService', () => {\n       const authContext = {\n         workspaceMemberId: '20202020-0b5c-4178-bed7-d371f6411eaa',\n         user: {\n-          firstName: 'John',\n-          lastName: 'Doe',\n+          firstName: '',\n+          lastName: '',\n           id: '20202020-9aae-49a8-bafc-ac44bae62d6d',\n         },\n         workspace: { id: '20202020-bdec-497f-847a-1bb334fefe58' },\n       } as const satisfies TestingAuthContext;\n \n+      const mockedWorkspaceMember = {\n+        id: '20202020-0b5c-4178-bed7-d371f6411eaa',\n+        name: {\n+          firstName: 'John',\n+          lastName: 'Doe',\n+        },\n+      } as const satisfies Partial<WorkspaceMemberWorkspaceEntity>;\n+\n+      mockWorkspaceMemberRepository.findOneOrFail.mockResolvedValueOnce(\n+        mockedWorkspaceMember,\n+      );\n+\n       const result = await service.injectCreatedBy(\n         [{}],\n         'person',\n@@ -123,7 +135,7 @@ describe('CreatedByFromAuthContextService', () => {\n         {\n           createdBy: {\n             context: {},\n-            name: fromFullNameMetadataToName(authContext.user),\n+            name: fromFullNameMetadataToName(mockedWorkspaceMember.name),\n             workspaceMemberId: authContext.workspaceMemberId,\n             source: FieldActorSource.MANUAL,\n           },\ndiff --git a/packages/twenty-server/src/engine/core-modules/actor/services/created-by-from-auth-context.service.ts b/packages/twenty-server/src/engine/core-modules/actor/services/created-by-from-auth-context.service.ts\nindex e7e23715fced5..5da432f910bd6 100644\n--- a/packages/twenty-server/src/engine/core-modules/actor/services/created-by-from-auth-context.service.ts\n+++ b/packages/twenty-server/src/engine/core-modules/actor/services/created-by-from-auth-context.service.ts\n@@ -102,24 +102,11 @@ export class CreatedByFromAuthContextService {\n   private async buildCreatedBy(\n     authContext: AuthContext,\n   ): Promise<ActorMetadata> {\n-    const { workspace, workspaceMemberId, user, apiKey } = authContext;\n+    const { workspace, user, apiKey } = authContext;\n \n     assertIsDefinedOrThrow(workspace, WorkspaceNotFoundDefaultError);\n \n-    // TODO: remove that code once we have the workspace member id in all tokens\n-    if (isDefined(workspaceMemberId) && isDefined(user)) {\n-      return buildCreatedByFromFullNameMetadata({\n-        fullNameMetadata: {\n-          firstName: user.firstName,\n-          lastName: user.lastName,\n-        },\n-        workspaceMemberId,\n-      });\n-    }\n-\n     if (isDefined(user)) {\n-      this.logger.warn(\"User doesn't have a workspace member id in the token\");\n-\n       const workspaceMemberRepository =\n         await this.twentyORMGlobalManager.getRepositoryForWorkspace<WorkspaceMemberWorkspaceEntity>(\n           workspace.id,\ndiff --git a/packages/twenty-server/src/engine/core-modules/user-workspace/user-workspace.module.ts b/packages/twenty-server/src/engine/core-modules/user-workspace/user-workspace.module.ts\nindex dc137c3dc6f88..47aecbc2266d3 100644\n--- a/packages/twenty-server/src/engine/core-modules/user-workspace/user-workspace.module.ts\n+++ b/packages/twenty-server/src/engine/core-modules/user-workspace/user-workspace.module.ts\n@@ -9,6 +9,7 @@ import { TokenModule } from 'src/engine/core-modules/auth/token/token.module';\n import { WorkspaceDomainsModule } from 'src/engine/core-modules/domain/workspace-domains/workspace-domains.module';\n import { FileUploadModule } from 'src/engine/core-modules/file/file-upload/file-upload.module';\n import { FileModule } from 'src/engine/core-modules/file/file.module';\n+import { OnboardingModule } from 'src/engine/core-modules/onboarding/onboarding.module';\n import { UserWorkspaceEntity } from 'src/engine/core-modules/user-workspace/user-workspace.entity';\n import { UserWorkspaceService } from 'src/engine/core-modules/user-workspace/user-workspace.service';\n import { UserEntity } from 'src/engine/core-modules/user/user.entity';\n@@ -43,6 +44,7 @@ import { WorkspaceDataSourceModule } from 'src/engine/workspace-datasource/works\n         FileUploadModule,\n         FileModule,\n         TokenModule,\n+        OnboardingModule,\n       ],\n       services: [UserWorkspaceService],\n     }),\ndiff --git a/packages/twenty-server/src/engine/core-modules/user-workspace/user-workspace.service.spec.ts b/packages/twenty-server/src/engine/core-modules/user-workspace/user-workspace.service.spec.ts\nindex 8f58d09b8a5ef..b42450254b796 100644\n--- a/packages/twenty-server/src/engine/core-modules/user-workspace/user-workspace.service.spec.ts\n+++ b/packages/twenty-server/src/engine/core-modules/user-workspace/user-workspace.service.spec.ts\n@@ -16,6 +16,7 @@ import {\n   type SignedFilesResult,\n } from 'src/engine/core-modules/file/file-upload/services/file-upload.service';\n import { FileService } from 'src/engine/core-modules/file/services/file.service';\n+import { OnboardingService } from 'src/engine/core-modules/onboarding/onboarding.service';\n import { UserWorkspaceEntity } from 'src/engine/core-modules/user-workspace/user-workspace.entity';\n import { UserWorkspaceService } from 'src/engine/core-modules/user-workspace/user-workspace.service';\n import { UserEntity } from 'src/engine/core-modules/user/user.entity';\n@@ -38,6 +39,7 @@ describe('UserWorkspaceService', () => {\n   let userRoleService: UserRoleService;\n   let fileService: FileService;\n   let fileUploadService: FileUploadService;\n+  let onboardingService: OnboardingService;\n \n   beforeEach(async () => {\n     const module: TestingModule = await Test.createTestingModule({\n@@ -133,6 +135,12 @@ describe('UserWorkspaceService', () => {\n             copyFileFromWorkspaceToWorkspace: jest.fn(),\n           },\n         },\n+        {\n+          provide: OnboardingService,\n+          useValue: {\n+            setOnboardingCreateProfilePending: jest.fn(),\n+          },\n+        },\n       ],\n     }).compile();\n \n@@ -153,6 +161,7 @@ describe('UserWorkspaceService', () => {\n     );\n     userRoleService = module.get<UserRoleService>(UserRoleService);\n     fileUploadService = module.get<FileUploadService>(FileUploadService);\n+    onboardingService = module.get<OnboardingService>(OnboardingService);\n   });\n \n   it('should be defined', () => {\n@@ -444,6 +453,17 @@ describe('UserWorkspaceService', () => {\n       expect(\n         workspaceInvitationService.invalidateWorkspaceInvitation,\n       ).toHaveBeenCalledWith(workspace.id, user.email, undefined);\n+\n+      expect(\n+        onboardingService.setOnboardingCreateProfilePending,\n+      ).toHaveBeenCalledWith(\n+        {\n+          userId: user.id,\n+          workspaceId: workspace.id,\n+          value: true,\n+        },\n+        undefined,\n+      );\n     });\n \n     it('should not add user to workspace if already in workspace', async () => {\ndiff --git a/packages/twenty-server/src/engine/core-modules/user-workspace/user-workspace.service.ts b/packages/twenty-server/src/engine/core-modules/user-workspace/user-workspace.service.ts\nindex 6e1dabc845e15..f23b8320cfeae 100644\n--- a/packages/twenty-server/src/engine/core-modules/user-workspace/user-workspace.service.ts\n+++ b/packages/twenty-server/src/engine/core-modules/user-workspace/user-workspace.service.ts\n@@ -19,6 +19,7 @@ import { LoginTokenService } from 'src/engine/core-modules/auth/token/services/l\n import { WorkspaceDomainsService } from 'src/engine/core-modules/domain/workspace-domains/services/workspace-domains.service';\n import { FileUploadService } from 'src/engine/core-modules/file/file-upload/services/file-upload.service';\n import { FileService } from 'src/engine/core-modules/file/services/file.service';\n+import { OnboardingService } from 'src/engine/core-modules/onboarding/onboarding.service';\n import { UserWorkspaceEntity } from 'src/engine/core-modules/user-workspace/user-workspace.entity';\n import { UserEntity } from 'src/engine/core-modules/user/user.entity';\n import { WorkspaceInvitationService } from 'src/engine/core-modules/workspace-invitation/services/workspace-invitation.service';\n@@ -53,6 +54,7 @@ export class UserWorkspaceService extends TypeOrmQueryService<UserWorkspaceEntit\n     private readonly userRoleService: UserRoleService,\n     private readonly fileUploadService: FileUploadService,\n     private readonly fileService: FileService,\n+    private readonly onboardingService: OnboardingService,\n   ) {\n     super(userWorkspaceRepository);\n   }\n@@ -173,6 +175,15 @@ export class UserWorkspaceService extends TypeOrmQueryService<UserWorkspaceEntit\n         user.email,\n         queryRunner,\n       );\n+\n+      await this.onboardingService.setOnboardingCreateProfilePending(\n+        {\n+          userId: user.id,\n+          workspaceId: workspace.id,\n+          value: true,\n+        },\n+        queryRunner,\n+      );\n     }\n   }\n \ndiff --git a/packages/twenty-server/src/modules/workspace-member/query-hooks/workspace-member-query-hook.module.ts b/packages/twenty-server/src/modules/workspace-member/query-hooks/workspace-member-query-hook.module.ts\nindex 0063b2000773d..97260aedca557 100644\n--- a/packages/twenty-server/src/modules/workspace-member/query-hooks/workspace-member-query-hook.module.ts\n+++ b/packages/twenty-server/src/modules/workspace-member/query-hooks/workspace-member-query-hook.module.ts\n@@ -4,6 +4,7 @@ import { TypeOrmModule } from '@nestjs/typeorm';\n import { FeatureFlagModule } from 'src/engine/core-modules/feature-flag/feature-flag.module';\n import { UserWorkspaceEntity } from 'src/engine/core-modules/user-workspace/user-workspace.entity';\n import { UserWorkspaceModule } from 'src/engine/core-modules/user-workspace/user-workspace.module';\n+import { UserModule } from 'src/engine/core-modules/user/user.module';\n import { PermissionsModule } from 'src/engine/metadata-modules/permissions/permissions.module';\n import { WorkspaceMemberCreateManyPreQueryHook } from 'src/modules/workspace-member/query-hooks/workspace-member-create-many.pre-query.hook';\n import { WorkspaceMemberCreateOnePreQueryHook } from 'src/modules/workspace-member/query-hooks/workspace-member-create-one.pre-query.hook';\n@@ -38,6 +39,7 @@ import { WorkspaceMemberUpdateOnePreQueryHook } from 'src/modules/workspace-memb\n     PermissionsModule,\n     UserWorkspaceModule,\n     TypeOrmModule.forFeature([UserWorkspaceEntity]),\n+    UserModule,\n   ],\n })\n export class WorkspaceMemberQueryHookModule {}\n",
        "pr_mirror": "twentyhq__twenty.main"
    }
}