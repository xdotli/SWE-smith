{
    "cost": 0.47309,
    "rewrites": {
        "twentyhq__twenty.main/packages/twenty-server/src/modules/calendar/calendar-event-import-manager/crons/jobs/calendar-event-list-fetch.cron.job.ts": {
            "output": "import { InjectDataSource, InjectRepository } from '@nestjs/typeorm';\n\nimport { WorkspaceActivationStatus } from 'twenty-shared/workspace';\nimport { DataSource, Repository } from 'typeorm';\n\nimport { SentryCronMonitor } from 'src/engine/core-modules/cron/sentry-cron-monitor.decorator';\nimport { ExceptionHandlerService } from 'src/engine/core-modules/exception-handler/exception-handler.service';\nimport { InjectMessageQueue } from 'src/engine/core-modules/message-queue/decorators/message-queue.decorator';\nimport { Process } from 'src/engine/core-modules/message-queue/decorators/process.decorator';\nimport { Processor } from 'src/engine/core-modules/message-queue/decorators/processor.decorator';\nimport { MessageQueue } from 'src/engine/core-modules/message-queue/message-queue.constants';\nimport { MessageQueueService } from 'src/engine/core-modules/message-queue/services/message-queue.service';\nimport { WorkspaceEntity } from 'src/engine/core-modules/workspace/workspace.entity';\nimport { getWorkspaceSchemaName } from 'src/engine/workspace-datasource/utils/get-workspace-schema-name.util';\nimport {\n  CalendarEventListFetchJob,\n  type CalendarEventListFetchJobData,\n} from 'src/modules/calendar/calendar-event-import-manager/jobs/calendar-event-list-fetch.job';\nimport { CalendarChannelSyncStage } from 'src/modules/calendar/common/standard-objects/calendar-channel.workspace-entity';\n\nexport const CALENDAR_EVENT_LIST_FETCH_CRON_PATTERN = '*/5 * * * *';\n\n@Processor({\n  queueName: MessageQueue.cronQueue,\n})\nexport class CalendarEventListFetchCronJob {\n  constructor(\n    @InjectRepository(WorkspaceEntity)\n    private readonly workspaceRepository: Repository<WorkspaceEntity>,\n    @InjectMessageQueue(MessageQueue.calendarQueue)\n    private readonly messageQueueService: MessageQueueService,\n    private readonly exceptionHandlerService: ExceptionHandlerService,\n    @InjectDataSource()\n    private readonly coreDataSource: DataSource,\n  ) {}\n\n  @Process(CalendarEventListFetchCronJob.name)\n  @SentryCronMonitor(\n    CalendarEventListFetchCronJob.name,\n    CALENDAR_EVENT_LIST_FETCH_CRON_PATTERN,\n  )\n  async handle(): Promise<void> {\n    const activeWorkspaces = await this.workspaceRepository.find({\n      where: {\n        activationStatus: WorkspaceActivationStatus.ACTIVE,\n      },\n    });\n\n    for (const activeWorkspace of activeWorkspaces) {\n      try {\n        const schemaName = getWorkspaceSchemaName(activeWorkspace.id);\n\n        const [calendarChannels] = await this.coreDataSource.query(\n          `UPDATE ${schemaName}.\"calendarChannel\" SET \"syncStage\" = '${CalendarChannelSyncStage.CALENDAR_EVENT_LIST_FETCH_SCHEDULED}' WHERE \"isSyncEnabled\" = true AND \"syncStage\" = '${CalendarChannelSyncStage.CALENDAR_EVENT_LIST_FETCH_PENDING}' RETURNING *`,\n        );\n\n        for (const calendarChannel of calendarChannels) {\n          await this.messageQueueService.add<CalendarEventListFetchJobData>(\n            CalendarEventListFetchJob.name,\n            {\n              calendarChannelId: calendarChannel.id,\n              workspaceId: activeWorkspace.id,\n            },\n          );\n        }\n      } catch (error) {\n        this.exceptionHandlerService.captureExceptions([error], {\n          workspace: {\n            id: activeWorkspace.id,\n          },\n        });\n      }\n    }\n  }\n}",
            "output_extracted": "import { InjectDataSource, InjectRepository } from '@nestjs/typeorm';\n\nimport { WorkspaceActivationStatus } from 'twenty-shared/workspace';\nimport { DataSource, Repository } from 'typeorm';\n\nimport { SentryCronMonitor } from 'src/engine/core-modules/cron/sentry-cron-monitor.decorator';\nimport { ExceptionHandlerService } from 'src/engine/core-modules/exception-handler/exception-handler.service';\nimport { InjectMessageQueue } from 'src/engine/core-modules/message-queue/decorators/message-queue.decorator';\nimport { Process } from 'src/engine/core-modules/message-queue/decorators/process.decorator';\nimport { Processor } from 'src/engine/core-modules/message-queue/decorators/processor.decorator';\nimport { MessageQueue } from 'src/engine/core-modules/message-queue/message-queue.constants';\nimport { MessageQueueService } from 'src/engine/core-modules/message-queue/services/message-queue.service';\nimport { WorkspaceEntity } from 'src/engine/core-modules/workspace/workspace.entity';\nimport { getWorkspaceSchemaName } from 'src/engine/workspace-datasource/utils/get-workspace-schema-name.util';\nimport {\n  CalendarEventListFetchJob,\n  type CalendarEventListFetchJobData,\n} from 'src/modules/calendar/calendar-event-import-manager/jobs/calendar-event-list-fetch.job';\nimport { CalendarChannelSyncStage } from 'src/modules/calendar/common/standard-objects/calendar-channel.workspace-entity';\n\nexport const CALENDAR_EVENT_LIST_FETCH_CRON_PATTERN = '*/5 * * * *';\n\n@Processor({\n  queueName: MessageQueue.cronQueue,\n})\nexport class CalendarEventListFetchCronJob {\n  constructor(\n    @InjectRepository(WorkspaceEntity)\n    private readonly workspaceRepository: Repository<WorkspaceEntity>,\n    @InjectMessageQueue(MessageQueue.calendarQueue)\n    private readonly messageQueueService: MessageQueueService,\n    private readonly exceptionHandlerService: ExceptionHandlerService,\n    @InjectDataSource()\n    private readonly coreDataSource: DataSource,\n  ) {}\n\n  @Process(CalendarEventListFetchCronJob.name)\n  @SentryCronMonitor(\n    CalendarEventListFetchCronJob.name,\n    CALENDAR_EVENT_LIST_FETCH_CRON_PATTERN,\n  )\n  async handle(): Promise<void> {\n    const activeWorkspaces = await this.workspaceRepository.find({\n      where: {\n        activationStatus: WorkspaceActivationStatus.ACTIVE,\n      },\n    });\n\n    for (const activeWorkspace of activeWorkspaces) {\n      try {\n        const schemaName = getWorkspaceSchemaName(activeWorkspace.id);\n\n        const [calendarChannels] = await this.coreDataSource.query(\n          `UPDATE ${schemaName}.\"calendarChannel\" SET \"syncStage\" = '${CalendarChannelSyncStage.CALENDAR_EVENT_LIST_FETCH_SCHEDULED}' WHERE \"isSyncEnabled\" = true AND \"syncStage\" = '${CalendarChannelSyncStage.CALENDAR_EVENT_LIST_FETCH_PENDING}' RETURNING *`,\n        );\n\n        for (const calendarChannel of calendarChannels) {\n          await this.messageQueueService.add<CalendarEventListFetchJobData>(\n            CalendarEventListFetchJob.name,\n            {\n              calendarChannelId: calendarChannel.id,\n              workspaceId: activeWorkspace.id,\n            },\n          );\n        }\n      } catch (error) {\n        this.exceptionHandlerService.captureExceptions([error], {\n          workspace: {\n            id: activeWorkspace.id,\n          },\n        });\n      }\n    }\n  }\n}",
            "cost": 0.036195000000000005
        },
        "twentyhq__twenty.main/packages/twenty-server/src/modules/calendar/calendar-event-import-manager/crons/jobs/calendar-events-import.cron.job.ts": {
            "output": "import { InjectDataSource, InjectRepository } from '@nestjs/typeorm';\n\nimport { WorkspaceActivationStatus } from 'twenty-shared/workspace';\nimport { DataSource, Repository } from 'typeorm';\n\nimport { SentryCronMonitor } from 'src/engine/core-modules/cron/sentry-cron-monitor.decorator';\nimport { ExceptionHandlerService } from 'src/engine/core-modules/exception-handler/exception-handler.service';\nimport { InjectMessageQueue } from 'src/engine/core-modules/message-queue/decorators/message-queue.decorator';\nimport { Process } from 'src/engine/core-modules/message-queue/decorators/process.decorator';\nimport { Processor } from 'src/engine/core-modules/message-queue/decorators/processor.decorator';\nimport { MessageQueue } from 'src/engine/core-modules/message-queue/message-queue.constants';\nimport { MessageQueueService } from 'src/engine/core-modules/message-queue/services/message-queue.service';\nimport { WorkspaceEntity } from 'src/engine/core-modules/workspace/workspace.entity';\nimport { getWorkspaceSchemaName } from 'src/engine/workspace-datasource/utils/get-workspace-schema-name.util';\nimport { type CalendarEventListFetchJobData } from 'src/modules/calendar/calendar-event-import-manager/jobs/calendar-event-list-fetch.job';\nimport { CalendarEventsImportJob } from 'src/modules/calendar/calendar-event-import-manager/jobs/calendar-events-import.job';\nimport { CalendarChannelSyncStage } from 'src/modules/calendar/common/standard-objects/calendar-channel.workspace-entity';\n\nexport const CALENDAR_EVENTS_IMPORT_CRON_PATTERN = '*/1 * * * *';\n\n@Processor({\n  queueName: MessageQueue.cronQueue,\n})\nexport class CalendarEventsImportCronJob {\n  constructor(\n    @InjectRepository(WorkspaceEntity)\n    private readonly workspaceRepository: Repository<WorkspaceEntity>,\n    @InjectMessageQueue(MessageQueue.calendarQueue)\n    private readonly messageQueueService: MessageQueueService,\n    @InjectDataSource()\n    private readonly coreDataSource: DataSource,\n    private readonly exceptionHandlerService: ExceptionHandlerService,\n  ) {}\n\n  @Process(CalendarEventsImportCronJob.name)\n  @SentryCronMonitor(\n    CalendarEventsImportCronJob.name,\n    CALENDAR_EVENTS_IMPORT_CRON_PATTERN,\n  )\n  async handle(): Promise<void> {\n    const activeWorkspaces = await this.workspaceRepository.find({\n      where: {\n        activationStatus: WorkspaceActivationStatus.ACTIVE,\n      },\n    });\n\n    for (const activeWorkspace of activeWorkspaces) {\n      try {\n        const schemaName = getWorkspaceSchemaName(activeWorkspace.id);\n\n        const [calendarChannels] = await this.coreDataSource.query(\n          `UPDATE ${schemaName}.\"calendarChannel\" SET \"syncStage\" = '${CalendarChannelSyncStage.CALENDAR_EVENTS_IMPORT_SCHEDULED}' WHERE \"isSyncEnabled\" = true AND \"syncStage\" = '${CalendarChannelSyncStage.CALENDAR_EVENTS_IMPORT_PENDING}' RETURNING *`,\n        );\n\n        for (const calendarChannel of calendarChannels) {\n          await this.messageQueueService.add<CalendarEventListFetchJobData>(\n            CalendarEventsImportJob.name,\n            {\n              calendarChannelId: calendarChannel.id,\n              workspaceId: activeWorkspace.id,\n            },\n          );\n        }\n      } catch (error) {\n        this.exceptionHandlerService.captureExceptions([error], {\n          workspace: {\n            id: activeWorkspace.id,\n          },\n        });\n      }\n    }\n  }\n}",
            "output_extracted": "import { InjectDataSource, InjectRepository } from '@nestjs/typeorm';\n\nimport { WorkspaceActivationStatus } from 'twenty-shared/workspace';\nimport { DataSource, Repository } from 'typeorm';\n\nimport { SentryCronMonitor } from 'src/engine/core-modules/cron/sentry-cron-monitor.decorator';\nimport { ExceptionHandlerService } from 'src/engine/core-modules/exception-handler/exception-handler.service';\nimport { InjectMessageQueue } from 'src/engine/core-modules/message-queue/decorators/message-queue.decorator';\nimport { Process } from 'src/engine/core-modules/message-queue/decorators/process.decorator';\nimport { Processor } from 'src/engine/core-modules/message-queue/decorators/processor.decorator';\nimport { MessageQueue } from 'src/engine/core-modules/message-queue/message-queue.constants';\nimport { MessageQueueService } from 'src/engine/core-modules/message-queue/services/message-queue.service';\nimport { WorkspaceEntity } from 'src/engine/core-modules/workspace/workspace.entity';\nimport { getWorkspaceSchemaName } from 'src/engine/workspace-datasource/utils/get-workspace-schema-name.util';\nimport { type CalendarEventListFetchJobData } from 'src/modules/calendar/calendar-event-import-manager/jobs/calendar-event-list-fetch.job';\nimport { CalendarEventsImportJob } from 'src/modules/calendar/calendar-event-import-manager/jobs/calendar-events-import.job';\nimport { CalendarChannelSyncStage } from 'src/modules/calendar/common/standard-objects/calendar-channel.workspace-entity';\n\nexport const CALENDAR_EVENTS_IMPORT_CRON_PATTERN = '*/1 * * * *';\n\n@Processor({\n  queueName: MessageQueue.cronQueue,\n})\nexport class CalendarEventsImportCronJob {\n  constructor(\n    @InjectRepository(WorkspaceEntity)\n    private readonly workspaceRepository: Repository<WorkspaceEntity>,\n    @InjectMessageQueue(MessageQueue.calendarQueue)\n    private readonly messageQueueService: MessageQueueService,\n    @InjectDataSource()\n    private readonly coreDataSource: DataSource,\n    private readonly exceptionHandlerService: ExceptionHandlerService,\n  ) {}\n\n  @Process(CalendarEventsImportCronJob.name)\n  @SentryCronMonitor(\n    CalendarEventsImportCronJob.name,\n    CALENDAR_EVENTS_IMPORT_CRON_PATTERN,\n  )\n  async handle(): Promise<void> {\n    const activeWorkspaces = await this.workspaceRepository.find({\n      where: {\n        activationStatus: WorkspaceActivationStatus.ACTIVE,\n      },\n    });\n\n    for (const activeWorkspace of activeWorkspaces) {\n      try {\n        const schemaName = getWorkspaceSchemaName(activeWorkspace.id);\n\n        const [calendarChannels] = await this.coreDataSource.query(\n          `UPDATE ${schemaName}.\"calendarChannel\" SET \"syncStage\" = '${CalendarChannelSyncStage.CALENDAR_EVENTS_IMPORT_SCHEDULED}' WHERE \"isSyncEnabled\" = true AND \"syncStage\" = '${CalendarChannelSyncStage.CALENDAR_EVENTS_IMPORT_PENDING}' RETURNING *`,\n        );\n\n        for (const calendarChannel of calendarChannels) {\n          await this.messageQueueService.add<CalendarEventListFetchJobData>(\n            CalendarEventsImportJob.name,\n            {\n              calendarChannelId: calendarChannel.id,\n              workspaceId: activeWorkspace.id,\n            },\n          );\n        }\n      } catch (error) {\n        this.exceptionHandlerService.captureExceptions([error], {\n          workspace: {\n            id: activeWorkspace.id,\n          },\n        });\n      }\n    }\n  }\n}",
            "cost": 0.03672500000000001
        },
        "twentyhq__twenty.main/packages/twenty-server/src/modules/messaging/common/services/message-channel-sync-status.service.ts": {
            "output": "import { Injectable } from '@nestjs/common';\n\nimport { Any, In } from 'typeorm';\n\nimport { InjectCacheStorage } from 'src/engine/core-modules/cache-storage/decorators/cache-storage.decorator';\nimport { CacheStorageService } from 'src/engine/core-modules/cache-storage/services/cache-storage.service';\nimport { CacheStorageNamespace } from 'src/engine/core-modules/cache-storage/types/cache-storage-namespace.enum';\nimport { MetricsService } from 'src/engine/core-modules/metrics/metrics.service';\nimport { MetricsKeys } from 'src/engine/core-modules/metrics/types/metrics-keys.type';\nimport { TwentyORMGlobalManager } from 'src/engine/twenty-orm/twenty-orm-global.manager';\nimport { AccountsToReconnectService } from 'src/modules/connected-account/services/accounts-to-reconnect.service';\nimport { type ConnectedAccountWorkspaceEntity } from 'src/modules/connected-account/standard-objects/connected-account.workspace-entity';\nimport { AccountsToReconnectKeys } from 'src/modules/connected-account/types/accounts-to-reconnect-key-value.type';\nimport {\n  MessageChannelPendingGroupEmailsAction,\n  MessageChannelSyncStage,\n  MessageChannelSyncStatus,\n  type MessageChannelWorkspaceEntity,\n} from 'src/modules/messaging/common/standard-objects/message-channel.workspace-entity';\nimport {\n  MessageFolderPendingSyncAction,\n  MessageFolderWorkspaceEntity,\n} from 'src/modules/messaging/common/standard-objects/message-folder.workspace-entity';\n\n@Injectable()\nexport class MessageChannelSyncStatusService {\n  constructor(\n    @InjectCacheStorage(CacheStorageNamespace.ModuleMessaging)\n    private readonly cacheStorage: CacheStorageService,\n    private readonly twentyORMGlobalManager: TwentyORMGlobalManager,\n    private readonly accountsToReconnectService: AccountsToReconnectService,\n    private readonly metricsService: MetricsService,\n  ) {}\n\n  public async scheduleMessageListFetch(\n    messageChannelIds: string[],\n    workspaceId: string,\n    preserveSyncStageStartedAt: boolean = false,\n  ) {\n    if (!messageChannelIds.length) {\n      return;\n    }\n\n    const messageChannelRepository =\n      await this.twentyORMGlobalManager.getRepositoryForWorkspace<MessageChannelWorkspaceEntity>(\n        workspaceId,\n        'messageChannel',\n      );\n\n    await messageChannelRepository.update(messageChannelIds, {\n      syncStage: MessageChannelSyncStage.MESSAGE_LIST_FETCH_PENDING,\n      ...(!preserveSyncStageStartedAt ? { syncStageStartedAt: null } : {}),\n    });\n  }\n\n  public async scheduleMessagesImport(\n    messageChannelIds: string[],\n    workspaceId: string,\n    preserveSyncStageStartedAt: boolean = false,\n  ) {\n    if (!messageChannelIds.length) {\n      return;\n    }\n\n    const messageChannelRepository =\n      await this.twentyORMGlobalManager.getRepositoryForWorkspace<MessageChannelWorkspaceEntity>(\n        workspaceId,\n        'messageChannel',\n      );\n\n    await messageChannelRepository.update(messageChannelIds, {\n      syncStage: MessageChannelSyncStage.MESSAGES_IMPORT_PENDING,\n      ...(!preserveSyncStageStartedAt ? { syncStageStartedAt: null } : {}),\n    });\n  }\n\n  public async resetAndScheduleMessageListFetch(\n    messageChannelIds: string[],\n    workspaceId: string,\n  ) {\n    if (!messageChannelIds.length) {\n      return;\n    }\n\n    for (const messageChannelId of messageChannelIds) {\n      await this.cacheStorage.del(\n        `messages-to-import:${workspaceId}:${messageChannelId}`,\n      );\n    }\n\n    const messageChannelRepository =\n      await this.twentyORMGlobalManager.getRepositoryForWorkspace<MessageChannelWorkspaceEntity>(\n        workspaceId,\n        'messageChannel',\n      );\n\n    const messageFolderRepository =\n      await this.twentyORMGlobalManager.getRepositoryForWorkspace<MessageFolderWorkspaceEntity>(\n        workspaceId,\n        'messageFolder',\n      );\n\n    await messageChannelRepository.update(messageChannelIds, {\n      syncCursor: '',\n      syncStageStartedAt: null,\n      throttleFailureCount: 0,\n      pendingGroupEmailsAction: MessageChannelPendingGroupEmailsAction.NONE,\n    });\n\n    await messageFolderRepository.update(\n      { messageChannelId: In(messageChannelIds) },\n      {\n        syncCursor: '',\n        pendingSyncAction: MessageFolderPendingSyncAction.NONE,\n      },\n    );\n\n    await this.scheduleMessageListFetch(messageChannelIds, workspaceId);\n  }\n\n  public async resetSyncStageStartedAt(\n    messageChannelIds: string[],\n    workspaceId: string,\n  ) {\n    if (!messageChannelIds.length) {\n      return;\n    }\n\n    const messageChannelRepository =\n      await this.twentyORMGlobalManager.getRepositoryForWorkspace<MessageChannelWorkspaceEntity>(\n        workspaceId,\n        'messageChannel',\n      );\n\n    await messageChannelRepository.update(messageChannelIds, {\n      syncStageStartedAt: null,\n    });\n  }\n\n  public async markAsMessagesListFetchOngoing(\n    messageChannelIds: string[],\n    workspaceId: string,\n  ) {\n    if (!messageChannelIds.length) {\n      return;\n    }\n\n    const messageChannelRepository =\n      await this.twentyORMGlobalManager.getRepositoryForWorkspace<MessageChannelWorkspaceEntity>(\n        workspaceId,\n        'messageChannel',\n      );\n\n    await messageChannelRepository.update(messageChannelIds, {\n      syncStage: MessageChannelSyncStage.MESSAGE_LIST_FETCH_ONGOING,\n      syncStatus: MessageChannelSyncStatus.ONGOING,\n      syncStageStartedAt: new Date().toISOString(),\n    });\n  }\n\n  public async markAsCompletedAndScheduleMessageListFetch(\n    messageChannelIds: string[],\n    workspaceId: string,\n  ) {\n    if (!messageChannelIds.length) {\n      return;\n    }\n\n    const messageChannelRepository =\n      await this.twentyORMGlobalManager.getRepositoryForWorkspace<MessageChannelWorkspaceEntity>(\n        workspaceId,\n        'messageChannel',\n      );\n\n    await messageChannelRepository.update(messageChannelIds, {\n      syncStatus: MessageChannelSyncStatus.ACTIVE,\n      syncStage: MessageChannelSyncStage.MESSAGE_LIST_FETCH_PENDING,\n      throttleFailureCount: 0,\n      syncStageStartedAt: null,\n      syncedAt: new Date().toISOString(),\n    });\n\n    await this.metricsService.batchIncrementCounter({\n      key: MetricsKeys.MessageChannelSyncJobActive,\n      eventIds: messageChannelIds,\n    });\n  }\n\n  public async markAsMessagesImportOngoing(\n    messageChannelIds: string[],\n    workspaceId: string,\n  ) {\n    if (!messageChannelIds.length) {\n      return;\n    }\n\n    const messageChannelRepository =\n      await this.twentyORMGlobalManager.getRepositoryForWorkspace<MessageChannelWorkspaceEntity>(\n        workspaceId,\n        'messageChannel',\n      );\n\n    await messageChannelRepository.update(messageChannelIds, {\n      syncStage: MessageChannelSyncStage.MESSAGES_IMPORT_ONGOING,\n      syncStageStartedAt: new Date().toISOString(),\n    });\n  }\n\n  public async markAsFailed(\n    messageChannelIds: string[],\n    workspaceId: string,\n    syncStatus:\n      | MessageChannelSyncStatus.FAILED_INSUFFICIENT_PERMISSIONS\n      | MessageChannelSyncStatus.FAILED_UNKNOWN,\n  ) {\n    if (!messageChannelIds.length) {\n      return;\n    }\n\n    const messageChannelRepository =\n      await this.twentyORMGlobalManager.getRepositoryForWorkspace<MessageChannelWorkspaceEntity>(\n        workspaceId,\n        'messageChannel',\n      );\n\n    await messageChannelRepository.update(messageChannelIds, {\n      syncStage: MessageChannelSyncStage.FAILED,\n      syncStatus: syncStatus,\n    });\n\n    const metricsKey =\n      syncStatus === MessageChannelSyncStatus.FAILED_INSUFFICIENT_PERMISSIONS\n        ? MetricsKeys.MessageChannelSyncJobFailedInsufficientPermissions\n        : MetricsKeys.MessageChannelSyncJobFailedUnknown;\n\n    await this.metricsService.batchIncrementCounter({\n      key: metricsKey,\n      eventIds: messageChannelIds,\n    });\n\n    if (\n      syncStatus === MessageChannelSyncStatus.FAILED_INSUFFICIENT_PERMISSIONS\n    ) {\n      const connectedAccountRepository =\n        await this.twentyORMGlobalManager.getRepositoryForWorkspace<ConnectedAccountWorkspaceEntity>(\n          workspaceId,\n          'connectedAccount',\n        );\n\n      const messageChannels = await messageChannelRepository.find({\n        select: ['id', 'connectedAccountId'],\n        where: { id: Any(messageChannelIds) },\n      });\n\n      const connectedAccountIds = messageChannels.map(\n        (messageChannel) => messageChannel.connectedAccountId,\n      );\n\n      await connectedAccountRepository.update(\n        { id: Any(connectedAccountIds) },\n        {\n          authFailedAt: new Date(),\n        },\n      );\n\n      await this.addToAccountsToReconnect(\n        messageChannels.map((messageChannel) => messageChannel.id),\n        workspaceId,\n      );\n    }\n  }\n\n  private async addToAccountsToReconnect(\n    messageChannelIds: string[],\n    workspaceId: string,\n  ) {\n    if (!messageChannelIds.length) {\n      return;\n    }\n\n    const messageChannelRepository =\n      await this.twentyORMGlobalManager.getRepositoryForWorkspace<MessageChannelWorkspaceEntity>(\n        workspaceId,\n        'messageChannel',\n      );\n\n    const messageChannels = await messageChannelRepository.find({\n      where: { id: Any(messageChannelIds) },\n      relations: {\n        connectedAccount: {\n          accountOwner: true,\n        },\n      },\n    });\n\n    for (const messageChannel of messageChannels) {\n      const userId = messageChannel.connectedAccount.accountOwner.userId;\n      const connectedAccountId = messageChannel.connectedAccount.id;\n\n      await this.accountsToReconnectService.addAccountToReconnectByKey(\n        AccountsToReconnectKeys.ACCOUNTS_TO_RECONNECT_INSUFFICIENT_PERMISSIONS,\n        userId,\n        workspaceId,\n        connectedAccountId,\n      );\n    }\n  }\n}",
            "output_extracted": "import { Injectable } from '@nestjs/common';\n\nimport { Any, In } from 'typeorm';\n\nimport { InjectCacheStorage } from 'src/engine/core-modules/cache-storage/decorators/cache-storage.decorator';\nimport { CacheStorageService } from 'src/engine/core-modules/cache-storage/services/cache-storage.service';\nimport { CacheStorageNamespace } from 'src/engine/core-modules/cache-storage/types/cache-storage-namespace.enum';\nimport { MetricsService } from 'src/engine/core-modules/metrics/metrics.service';\nimport { MetricsKeys } from 'src/engine/core-modules/metrics/types/metrics-keys.type';\nimport { TwentyORMGlobalManager } from 'src/engine/twenty-orm/twenty-orm-global.manager';\nimport { AccountsToReconnectService } from 'src/modules/connected-account/services/accounts-to-reconnect.service';\nimport { type ConnectedAccountWorkspaceEntity } from 'src/modules/connected-account/standard-objects/connected-account.workspace-entity';\nimport { AccountsToReconnectKeys } from 'src/modules/connected-account/types/accounts-to-reconnect-key-value.type';\nimport {\n  MessageChannelPendingGroupEmailsAction,\n  MessageChannelSyncStage,\n  MessageChannelSyncStatus,\n  type MessageChannelWorkspaceEntity,\n} from 'src/modules/messaging/common/standard-objects/message-channel.workspace-entity';\nimport {\n  MessageFolderPendingSyncAction,\n  MessageFolderWorkspaceEntity,\n} from 'src/modules/messaging/common/standard-objects/message-folder.workspace-entity';\n\n@Injectable()\nexport class MessageChannelSyncStatusService {\n  constructor(\n    @InjectCacheStorage(CacheStorageNamespace.ModuleMessaging)\n    private readonly cacheStorage: CacheStorageService,\n    private readonly twentyORMGlobalManager: TwentyORMGlobalManager,\n    private readonly accountsToReconnectService: AccountsToReconnectService,\n    private readonly metricsService: MetricsService,\n  ) {}\n\n  public async scheduleMessageListFetch(\n    messageChannelIds: string[],\n    workspaceId: string,\n    preserveSyncStageStartedAt: boolean = false,\n  ) {\n    if (!messageChannelIds.length) {\n      return;\n    }\n\n    const messageChannelRepository =\n      await this.twentyORMGlobalManager.getRepositoryForWorkspace<MessageChannelWorkspaceEntity>(\n        workspaceId,\n        'messageChannel',\n      );\n\n    await messageChannelRepository.update(messageChannelIds, {\n      syncStage: MessageChannelSyncStage.MESSAGE_LIST_FETCH_PENDING,\n      ...(!preserveSyncStageStartedAt ? { syncStageStartedAt: null } : {}),\n    });\n  }\n\n  public async scheduleMessagesImport(\n    messageChannelIds: string[],\n    workspaceId: string,\n    preserveSyncStageStartedAt: boolean = false,\n  ) {\n    if (!messageChannelIds.length) {\n      return;\n    }\n\n    const messageChannelRepository =\n      await this.twentyORMGlobalManager.getRepositoryForWorkspace<MessageChannelWorkspaceEntity>(\n        workspaceId,\n        'messageChannel',\n      );\n\n    await messageChannelRepository.update(messageChannelIds, {\n      syncStage: MessageChannelSyncStage.MESSAGES_IMPORT_PENDING,\n      ...(!preserveSyncStageStartedAt ? { syncStageStartedAt: null } : {}),\n    });\n  }\n\n  public async resetAndScheduleMessageListFetch(\n    messageChannelIds: string[],\n    workspaceId: string,\n  ) {\n    if (!messageChannelIds.length) {\n      return;\n    }\n\n    for (const messageChannelId of messageChannelIds) {\n      await this.cacheStorage.del(\n        `messages-to-import:${workspaceId}:${messageChannelId}`,\n      );\n    }\n\n    const messageChannelRepository =\n      await this.twentyORMGlobalManager.getRepositoryForWorkspace<MessageChannelWorkspaceEntity>(\n        workspaceId,\n        'messageChannel',\n      );\n\n    const messageFolderRepository =\n      await this.twentyORMGlobalManager.getRepositoryForWorkspace<MessageFolderWorkspaceEntity>(\n        workspaceId,\n        'messageFolder',\n      );\n\n    await messageChannelRepository.update(messageChannelIds, {\n      syncCursor: '',\n      syncStageStartedAt: null,\n      throttleFailureCount: 0,\n      pendingGroupEmailsAction: MessageChannelPendingGroupEmailsAction.NONE,\n    });\n\n    await messageFolderRepository.update(\n      { messageChannelId: In(messageChannelIds) },\n      {\n        syncCursor: '',\n        pendingSyncAction: MessageFolderPendingSyncAction.NONE,\n      },\n    );\n\n    await this.scheduleMessageListFetch(messageChannelIds, workspaceId);\n  }\n\n  public async resetSyncStageStartedAt(\n    messageChannelIds: string[],\n    workspaceId: string,\n  ) {\n    if (!messageChannelIds.length) {\n      return;\n    }\n\n    const messageChannelRepository =\n      await this.twentyORMGlobalManager.getRepositoryForWorkspace<MessageChannelWorkspaceEntity>(\n        workspaceId,\n        'messageChannel',\n      );\n\n    await messageChannelRepository.update(messageChannelIds, {\n      syncStageStartedAt: null,\n    });\n  }\n\n  public async markAsMessagesListFetchOngoing(\n    messageChannelIds: string[],\n    workspaceId: string,\n  ) {\n    if (!messageChannelIds.length) {\n      return;\n    }\n\n    const messageChannelRepository =\n      await this.twentyORMGlobalManager.getRepositoryForWorkspace<MessageChannelWorkspaceEntity>(\n        workspaceId,\n        'messageChannel',\n      );\n\n    await messageChannelRepository.update(messageChannelIds, {\n      syncStage: MessageChannelSyncStage.MESSAGE_LIST_FETCH_ONGOING,\n      syncStatus: MessageChannelSyncStatus.ONGOING,\n      syncStageStartedAt: new Date().toISOString(),\n    });\n  }\n\n  public async markAsCompletedAndScheduleMessageListFetch(\n    messageChannelIds: string[],\n    workspaceId: string,\n  ) {\n    if (!messageChannelIds.length) {\n      return;\n    }\n\n    const messageChannelRepository =\n      await this.twentyORMGlobalManager.getRepositoryForWorkspace<MessageChannelWorkspaceEntity>(\n        workspaceId,\n        'messageChannel',\n      );\n\n    await messageChannelRepository.update(messageChannelIds, {\n      syncStatus: MessageChannelSyncStatus.ACTIVE,\n      syncStage: MessageChannelSyncStage.MESSAGE_LIST_FETCH_PENDING,\n      throttleFailureCount: 0,\n      syncStageStartedAt: null,\n      syncedAt: new Date().toISOString(),\n    });\n\n    await this.metricsService.batchIncrementCounter({\n      key: MetricsKeys.MessageChannelSyncJobActive,\n      eventIds: messageChannelIds,\n    });\n  }\n\n  public async markAsMessagesImportOngoing(\n    messageChannelIds: string[],\n    workspaceId: string,\n  ) {\n    if (!messageChannelIds.length) {\n      return;\n    }\n\n    const messageChannelRepository =\n      await this.twentyORMGlobalManager.getRepositoryForWorkspace<MessageChannelWorkspaceEntity>(\n        workspaceId,\n        'messageChannel',\n      );\n\n    await messageChannelRepository.update(messageChannelIds, {\n      syncStage: MessageChannelSyncStage.MESSAGES_IMPORT_ONGOING,\n      syncStageStartedAt: new Date().toISOString(),\n    });\n  }\n\n  public async markAsFailed(\n    messageChannelIds: string[],\n    workspaceId: string,\n    syncStatus:\n      | MessageChannelSyncStatus.FAILED_INSUFFICIENT_PERMISSIONS\n      | MessageChannelSyncStatus.FAILED_UNKNOWN,\n  ) {\n    if (!messageChannelIds.length) {\n      return;\n    }\n\n    const messageChannelRepository =\n      await this.twentyORMGlobalManager.getRepositoryForWorkspace<MessageChannelWorkspaceEntity>(\n        workspaceId,\n        'messageChannel',\n      );\n\n    await messageChannelRepository.update(messageChannelIds, {\n      syncStage: MessageChannelSyncStage.FAILED,\n      syncStatus: syncStatus,\n    });\n\n    const metricsKey =\n      syncStatus === MessageChannelSyncStatus.FAILED_INSUFFICIENT_PERMISSIONS\n        ? MetricsKeys.MessageChannelSyncJobFailedInsufficientPermissions\n        : MetricsKeys.MessageChannelSyncJobFailedUnknown;\n\n    await this.metricsService.batchIncrementCounter({\n      key: metricsKey,\n      eventIds: messageChannelIds,\n    });\n\n    if (\n      syncStatus === MessageChannelSyncStatus.FAILED_INSUFFICIENT_PERMISSIONS\n    ) {\n      const connectedAccountRepository =\n        await this.twentyORMGlobalManager.getRepositoryForWorkspace<ConnectedAccountWorkspaceEntity>(\n          workspaceId,\n          'connectedAccount',\n        );\n\n      const messageChannels = await messageChannelRepository.find({\n        select: ['id', 'connectedAccountId'],\n        where: { id: Any(messageChannelIds) },\n      });\n\n      const connectedAccountIds = messageChannels.map(\n        (messageChannel) => messageChannel.connectedAccountId,\n      );\n\n      await connectedAccountRepository.update(\n        { id: Any(connectedAccountIds) },\n        {\n          authFailedAt: new Date(),\n        },\n      );\n\n      await this.addToAccountsToReconnect(\n        messageChannels.map((messageChannel) => messageChannel.id),\n        workspaceId,\n      );\n    }\n  }\n\n  private async addToAccountsToReconnect(\n    messageChannelIds: string[],\n    workspaceId: string,\n  ) {\n    if (!messageChannelIds.length) {\n      return;\n    }\n\n    const messageChannelRepository =\n      await this.twentyORMGlobalManager.getRepositoryForWorkspace<MessageChannelWorkspaceEntity>(\n        workspaceId,\n        'messageChannel',\n      );\n\n    const messageChannels = await messageChannelRepository.find({\n      where: { id: Any(messageChannelIds) },\n      relations: {\n        connectedAccount: {\n          accountOwner: true,\n        },\n      },\n    });\n\n    for (const messageChannel of messageChannels) {\n      const userId = messageChannel.connectedAccount.accountOwner.userId;\n      const connectedAccountId = messageChannel.connectedAccount.id;\n\n      await this.accountsToReconnectService.addAccountToReconnectByKey(\n        AccountsToReconnectKeys.ACCOUNTS_TO_RECONNECT_INSUFFICIENT_PERMISSIONS,\n        userId,\n        workspaceId,\n        connectedAccountId,\n      );\n    }\n  }\n}",
            "cost": 0.095935
        },
        "twentyhq__twenty.main/packages/twenty-server/src/modules/messaging/message-import-manager/crons/jobs/messaging-message-list-fetch.cron.job.ts": {
            "output": "import { InjectDataSource, InjectRepository } from '@nestjs/typeorm';\n\nimport { WorkspaceActivationStatus } from 'twenty-shared/workspace';\nimport { DataSource, Repository } from 'typeorm';\n\nimport { SentryCronMonitor } from 'src/engine/core-modules/cron/sentry-cron-monitor.decorator';\nimport { ExceptionHandlerService } from 'src/engine/core-modules/exception-handler/exception-handler.service';\nimport { InjectMessageQueue } from 'src/engine/core-modules/message-queue/decorators/message-queue.decorator';\nimport { Process } from 'src/engine/core-modules/message-queue/decorators/process.decorator';\nimport { Processor } from 'src/engine/core-modules/message-queue/decorators/processor.decorator';\nimport { MessageQueue } from 'src/engine/core-modules/message-queue/message-queue.constants';\nimport { MessageQueueService } from 'src/engine/core-modules/message-queue/services/message-queue.service';\nimport { WorkspaceEntity } from 'src/engine/core-modules/workspace/workspace.entity';\nimport { getWorkspaceSchemaName } from 'src/engine/workspace-datasource/utils/get-workspace-schema-name.util';\nimport { MessageChannelSyncStage } from 'src/modules/messaging/common/standard-objects/message-channel.workspace-entity';\nimport {\n  MessagingMessageListFetchJob,\n  type MessagingMessageListFetchJobData,\n} from 'src/modules/messaging/message-import-manager/jobs/messaging-message-list-fetch.job';\n\nexport const MESSAGING_MESSAGE_LIST_FETCH_CRON_PATTERN = '2-59/5 * * * *';\n\n@Processor(MessageQueue.cronQueue)\nexport class MessagingMessageListFetchCronJob {\n  constructor(\n    @InjectRepository(WorkspaceEntity)\n    private readonly workspaceRepository: Repository<WorkspaceEntity>,\n    @InjectMessageQueue(MessageQueue.messagingQueue)\n    private readonly messageQueueService: MessageQueueService,\n    @InjectDataSource()\n    private readonly coreDataSource: DataSource,\n    private readonly exceptionHandlerService: ExceptionHandlerService,\n  ) {}\n\n  @Process(MessagingMessageListFetchCronJob.name)\n  @SentryCronMonitor(\n    MessagingMessageListFetchCronJob.name,\n    MESSAGING_MESSAGE_LIST_FETCH_CRON_PATTERN,\n  )\n  async handle(): Promise<void> {\n    const activeWorkspaces = await this.workspaceRepository.find({\n      where: {\n        activationStatus: WorkspaceActivationStatus.ACTIVE,\n      },\n    });\n\n    for (const activeWorkspace of activeWorkspaces) {\n      try {\n        const schemaName = getWorkspaceSchemaName(activeWorkspace.id);\n\n        const [messageChannels] = await this.coreDataSource.query(\n          `UPDATE ${schemaName}.\"messageChannel\" SET \"syncStage\" = '${MessageChannelSyncStage.MESSAGE_LIST_FETCH_SCHEDULED}' WHERE \"isSyncEnabled\" = true AND \"syncStage\" = '${MessageChannelSyncStage.MESSAGE_LIST_FETCH_PENDING}' RETURNING *`,\n        );\n\n        for (const messageChannel of messageChannels) {\n          await this.messageQueueService.add<MessagingMessageListFetchJobData>(\n            MessagingMessageListFetchJob.name,\n            {\n              workspaceId: activeWorkspace.id,\n              messageChannelId: messageChannel.id,\n            },\n          );\n        }\n      } catch (error) {\n        this.exceptionHandlerService.captureExceptions([error], {\n          workspace: {\n            id: activeWorkspace.id,\n          },\n        });\n      }\n    }\n  }\n}",
            "output_extracted": "import { InjectDataSource, InjectRepository } from '@nestjs/typeorm';\n\nimport { WorkspaceActivationStatus } from 'twenty-shared/workspace';\nimport { DataSource, Repository } from 'typeorm';\n\nimport { SentryCronMonitor } from 'src/engine/core-modules/cron/sentry-cron-monitor.decorator';\nimport { ExceptionHandlerService } from 'src/engine/core-modules/exception-handler/exception-handler.service';\nimport { InjectMessageQueue } from 'src/engine/core-modules/message-queue/decorators/message-queue.decorator';\nimport { Process } from 'src/engine/core-modules/message-queue/decorators/process.decorator';\nimport { Processor } from 'src/engine/core-modules/message-queue/decorators/processor.decorator';\nimport { MessageQueue } from 'src/engine/core-modules/message-queue/message-queue.constants';\nimport { MessageQueueService } from 'src/engine/core-modules/message-queue/services/message-queue.service';\nimport { WorkspaceEntity } from 'src/engine/core-modules/workspace/workspace.entity';\nimport { getWorkspaceSchemaName } from 'src/engine/workspace-datasource/utils/get-workspace-schema-name.util';\nimport { MessageChannelSyncStage } from 'src/modules/messaging/common/standard-objects/message-channel.workspace-entity';\nimport {\n  MessagingMessageListFetchJob,\n  type MessagingMessageListFetchJobData,\n} from 'src/modules/messaging/message-import-manager/jobs/messaging-message-list-fetch.job';\n\nexport const MESSAGING_MESSAGE_LIST_FETCH_CRON_PATTERN = '2-59/5 * * * *';\n\n@Processor(MessageQueue.cronQueue)\nexport class MessagingMessageListFetchCronJob {\n  constructor(\n    @InjectRepository(WorkspaceEntity)\n    private readonly workspaceRepository: Repository<WorkspaceEntity>,\n    @InjectMessageQueue(MessageQueue.messagingQueue)\n    private readonly messageQueueService: MessageQueueService,\n    @InjectDataSource()\n    private readonly coreDataSource: DataSource,\n    private readonly exceptionHandlerService: ExceptionHandlerService,\n  ) {}\n\n  @Process(MessagingMessageListFetchCronJob.name)\n  @SentryCronMonitor(\n    MessagingMessageListFetchCronJob.name,\n    MESSAGING_MESSAGE_LIST_FETCH_CRON_PATTERN,\n  )\n  async handle(): Promise<void> {\n    const activeWorkspaces = await this.workspaceRepository.find({\n      where: {\n        activationStatus: WorkspaceActivationStatus.ACTIVE,\n      },\n    });\n\n    for (const activeWorkspace of activeWorkspaces) {\n      try {\n        const schemaName = getWorkspaceSchemaName(activeWorkspace.id);\n\n        const [messageChannels] = await this.coreDataSource.query(\n          `UPDATE ${schemaName}.\"messageChannel\" SET \"syncStage\" = '${MessageChannelSyncStage.MESSAGE_LIST_FETCH_SCHEDULED}' WHERE \"isSyncEnabled\" = true AND \"syncStage\" = '${MessageChannelSyncStage.MESSAGE_LIST_FETCH_PENDING}' RETURNING *`,\n        );\n\n        for (const messageChannel of messageChannels) {\n          await this.messageQueueService.add<MessagingMessageListFetchJobData>(\n            MessagingMessageListFetchJob.name,\n            {\n              workspaceId: activeWorkspace.id,\n              messageChannelId: messageChannel.id,\n            },\n          );\n        }\n      } catch (error) {\n        this.exceptionHandlerService.captureExceptions([error], {\n          workspace: {\n            id: activeWorkspace.id,\n          },\n        });\n      }\n    }\n  }\n}",
            "cost": 0.035605000000000005
        },
        "twentyhq__twenty.main/packages/twenty-server/src/modules/messaging/message-import-manager/crons/jobs/messaging-messages-import.cron.job.ts": {
            "output": "import { InjectDataSource, InjectRepository } from '@nestjs/typeorm';\n\nimport { isDefined } from 'twenty-shared/utils';\nimport { WorkspaceActivationStatus } from 'twenty-shared/workspace';\nimport { DataSource, Repository } from 'typeorm';\n\nimport { SentryCronMonitor } from 'src/engine/core-modules/cron/sentry-cron-monitor.decorator';\nimport { ExceptionHandlerService } from 'src/engine/core-modules/exception-handler/exception-handler.service';\nimport { InjectMessageQueue } from 'src/engine/core-modules/message-queue/decorators/message-queue.decorator';\nimport { Process } from 'src/engine/core-modules/message-queue/decorators/process.decorator';\nimport { Processor } from 'src/engine/core-modules/message-queue/decorators/processor.decorator';\nimport { MessageQueue } from 'src/engine/core-modules/message-queue/message-queue.constants';\nimport { MessageQueueService } from 'src/engine/core-modules/message-queue/services/message-queue.service';\nimport { WorkspaceEntity } from 'src/engine/core-modules/workspace/workspace.entity';\nimport {\n  DataSourceException,\n  DataSourceExceptionCode,\n} from 'src/engine/metadata-modules/data-source/data-source.exception';\nimport { getWorkspaceSchemaName } from 'src/engine/workspace-datasource/utils/get-workspace-schema-name.util';\nimport { MessageChannelSyncStage } from 'src/modules/messaging/common/standard-objects/message-channel.workspace-entity';\nimport {\n  MessagingMessagesImportJob,\n  type MessagingMessagesImportJobData,\n} from 'src/modules/messaging/message-import-manager/jobs/messaging-messages-import.job';\n\nexport const MESSAGING_MESSAGES_IMPORT_CRON_PATTERN = '*/1 * * * *';\n\n@Processor(MessageQueue.cronQueue)\nexport class MessagingMessagesImportCronJob {\n  constructor(\n    @InjectRepository(WorkspaceEntity)\n    private readonly workspaceRepository: Repository<WorkspaceEntity>,\n    @InjectMessageQueue(MessageQueue.messagingQueue)\n    private readonly messageQueueService: MessageQueueService,\n    private readonly exceptionHandlerService: ExceptionHandlerService,\n    @InjectDataSource()\n    private readonly coreDataSource: DataSource,\n  ) {}\n\n  @Process(MessagingMessagesImportCronJob.name)\n  @SentryCronMonitor(\n    MessagingMessagesImportCronJob.name,\n    MESSAGING_MESSAGES_IMPORT_CRON_PATTERN,\n  )\n  async handle(): Promise<void> {\n    const activeWorkspaces = await this.workspaceRepository.find({\n      where: {\n        activationStatus: WorkspaceActivationStatus.ACTIVE,\n      },\n    });\n\n    for (const activeWorkspace of activeWorkspaces) {\n      try {\n        const schemaName = getWorkspaceSchemaName(activeWorkspace.id);\n\n        const [messageChannels] = await this.coreDataSource.query(\n          `UPDATE ${schemaName}.\"messageChannel\" SET \"syncStage\" = '${MessageChannelSyncStage.MESSAGES_IMPORT_SCHEDULED}' WHERE \"isSyncEnabled\" = true AND \"syncStage\" = '${MessageChannelSyncStage.MESSAGES_IMPORT_PENDING}' RETURNING *`,\n        );\n\n        for (const messageChannel of messageChannels) {\n          await this.messageQueueService.add<MessagingMessagesImportJobData>(\n            MessagingMessagesImportJob.name,\n            {\n              workspaceId: activeWorkspace.id,\n              messageChannelId: messageChannel.id,\n            },\n          );\n        }\n      } catch (error) {\n        // We had issues with the workspace schema not being found, due\n        // to users deleting their workspaces in the middle of the cron job\n        // We only throw an error when the workspace is found & schema not found\n        if (\n          error.code === '42P01' &&\n          error.message.includes('messageChannel\" does not exist')\n        ) {\n          const refetchedWorkspace = await this.workspaceRepository.findOneBy({\n            id: activeWorkspace.id,\n          });\n\n          if (isDefined(refetchedWorkspace)) {\n            this.exceptionHandlerService.captureExceptions([error], {\n              workspace: {\n                id: activeWorkspace.id,\n              },\n            });\n            throw new DataSourceException(\n              'Workspace schema not found while the workspace is still active',\n              DataSourceExceptionCode.DATA_SOURCE_NOT_FOUND,\n            );\n          }\n        } else {\n          this.exceptionHandlerService.captureExceptions([error], {\n            workspace: {\n              id: activeWorkspace.id,\n            },\n          });\n        }\n      }\n    }\n  }\n}",
            "output_extracted": "import { InjectDataSource, InjectRepository } from '@nestjs/typeorm';\n\nimport { isDefined } from 'twenty-shared/utils';\nimport { WorkspaceActivationStatus } from 'twenty-shared/workspace';\nimport { DataSource, Repository } from 'typeorm';\n\nimport { SentryCronMonitor } from 'src/engine/core-modules/cron/sentry-cron-monitor.decorator';\nimport { ExceptionHandlerService } from 'src/engine/core-modules/exception-handler/exception-handler.service';\nimport { InjectMessageQueue } from 'src/engine/core-modules/message-queue/decorators/message-queue.decorator';\nimport { Process } from 'src/engine/core-modules/message-queue/decorators/process.decorator';\nimport { Processor } from 'src/engine/core-modules/message-queue/decorators/processor.decorator';\nimport { MessageQueue } from 'src/engine/core-modules/message-queue/message-queue.constants';\nimport { MessageQueueService } from 'src/engine/core-modules/message-queue/services/message-queue.service';\nimport { WorkspaceEntity } from 'src/engine/core-modules/workspace/workspace.entity';\nimport {\n  DataSourceException,\n  DataSourceExceptionCode,\n} from 'src/engine/metadata-modules/data-source/data-source.exception';\nimport { getWorkspaceSchemaName } from 'src/engine/workspace-datasource/utils/get-workspace-schema-name.util';\nimport { MessageChannelSyncStage } from 'src/modules/messaging/common/standard-objects/message-channel.workspace-entity';\nimport {\n  MessagingMessagesImportJob,\n  type MessagingMessagesImportJobData,\n} from 'src/modules/messaging/message-import-manager/jobs/messaging-messages-import.job';\n\nexport const MESSAGING_MESSAGES_IMPORT_CRON_PATTERN = '*/1 * * * *';\n\n@Processor(MessageQueue.cronQueue)\nexport class MessagingMessagesImportCronJob {\n  constructor(\n    @InjectRepository(WorkspaceEntity)\n    private readonly workspaceRepository: Repository<WorkspaceEntity>,\n    @InjectMessageQueue(MessageQueue.messagingQueue)\n    private readonly messageQueueService: MessageQueueService,\n    private readonly exceptionHandlerService: ExceptionHandlerService,\n    @InjectDataSource()\n    private readonly coreDataSource: DataSource,\n  ) {}\n\n  @Process(MessagingMessagesImportCronJob.name)\n  @SentryCronMonitor(\n    MessagingMessagesImportCronJob.name,\n    MESSAGING_MESSAGES_IMPORT_CRON_PATTERN,\n  )\n  async handle(): Promise<void> {\n    const activeWorkspaces = await this.workspaceRepository.find({\n      where: {\n        activationStatus: WorkspaceActivationStatus.ACTIVE,\n      },\n    });\n\n    for (const activeWorkspace of activeWorkspaces) {\n      try {\n        const schemaName = getWorkspaceSchemaName(activeWorkspace.id);\n\n        const [messageChannels] = await this.coreDataSource.query(\n          `UPDATE ${schemaName}.\"messageChannel\" SET \"syncStage\" = '${MessageChannelSyncStage.MESSAGES_IMPORT_SCHEDULED}' WHERE \"isSyncEnabled\" = true AND \"syncStage\" = '${MessageChannelSyncStage.MESSAGES_IMPORT_PENDING}' RETURNING *`,\n        );\n\n        for (const messageChannel of messageChannels) {\n          await this.messageQueueService.add<MessagingMessagesImportJobData>(\n            MessagingMessagesImportJob.name,\n            {\n              workspaceId: activeWorkspace.id,\n              messageChannelId: messageChannel.id,\n            },\n          );\n        }\n      } catch (error) {\n        // We had issues with the workspace schema not being found, due\n        // to users deleting their workspaces in the middle of the cron job\n        // We only throw an error when the workspace is found & schema not found\n        if (\n          error.code === '42P01' &&\n          error.message.includes('messageChannel\" does not exist')\n        ) {\n          const refetchedWorkspace = await this.workspaceRepository.findOneBy({\n            id: activeWorkspace.id,\n          });\n\n          if (isDefined(refetchedWorkspace)) {\n            this.exceptionHandlerService.captureExceptions([error], {\n              workspace: {\n                id: activeWorkspace.id,\n              },\n            });\n            throw new DataSourceException(\n              'Workspace schema not found while the workspace is still active',\n              DataSourceExceptionCode.DATA_SOURCE_NOT_FOUND,\n            );\n          }\n        } else {\n          this.exceptionHandlerService.captureExceptions([error], {\n            workspace: {\n              id: activeWorkspace.id,\n            },\n          });\n        }\n      }\n    }\n  }\n}",
            "cost": 0.043735
        },
        "twentyhq__twenty.main/packages/twenty-server/src/modules/messaging/message-import-manager/services/__tests__/messaging-message-list-fetch.service.spec.ts": {
            "output": "import { Test, type TestingModule } from '@nestjs/testing';\n\nimport { ConnectedAccountProvider } from 'twenty-shared/types';\n\nimport { CacheStorageService } from 'src/engine/core-modules/cache-storage/services/cache-storage.service';\nimport { CacheStorageNamespace } from 'src/engine/core-modules/cache-storage/types/cache-storage-namespace.enum';\nimport { TwentyORMManager } from 'src/engine/twenty-orm/twenty-orm.manager';\nimport { MessageChannelSyncStatusService } from 'src/modules/messaging/common/services/message-channel-sync-status.service';\nimport { type MessageChannelWorkspaceEntity } from 'src/modules/messaging/common/standard-objects/message-channel.workspace-entity';\nimport { type MessageFolderWorkspaceEntity } from 'src/modules/messaging/common/standard-objects/message-folder.workspace-entity';\nimport { MessagingMessageCleanerService } from 'src/modules/messaging/message-cleaner/services/messaging-message-cleaner.service';\nimport { SyncMessageFoldersService } from 'src/modules/messaging/message-folder-manager/services/sync-message-folders.service';\nimport { MessagingAccountAuthenticationService } from 'src/modules/messaging/message-import-manager/services/messaging-account-authentication.service';\nimport { MessagingCursorService } from 'src/modules/messaging/message-import-manager/services/messaging-cursor.service';\nimport { MessagingGetMessageListService } from 'src/modules/messaging/message-import-manager/services/messaging-get-message-list.service';\nimport { MessageImportExceptionHandlerService } from 'src/modules/messaging/message-import-manager/services/messaging-import-exception-handler.service';\nimport { MessagingMessageListFetchService } from 'src/modules/messaging/message-import-manager/services/messaging-message-list-fetch.service';\nimport { MessagingMessagesImportService } from 'src/modules/messaging/message-import-manager/services/messaging-messages-import.service';\nimport { MessagingProcessFolderActionsService } from 'src/modules/messaging/message-import-manager/services/messaging-process-folder-actions.service';\nimport { MessagingProcessGroupEmailActionsService } from 'src/modules/messaging/message-import-manager/services/messaging-process-group-email-actions.service';\n\ndescribe('MessagingMessageListFetchService', () => {\n  let messagingMessageListFetchService: MessagingMessageListFetchService;\n  let messagingGetMessageListService: MessagingGetMessageListService;\n  let messagingAccountAuthenticationService: MessagingAccountAuthenticationService;\n  let messageChannelSyncStatusService: MessageChannelSyncStatusService;\n  let twentyORMManager: TwentyORMManager;\n  let messagingCursorService: MessagingCursorService;\n\n  let mockMicrosoftMessageChannel: MessageChannelWorkspaceEntity;\n  let mockGoogleMessageChannel: MessageChannelWorkspaceEntity;\n\n  const workspaceId = 'workspace-id';\n\n  beforeAll(() => {\n    mockMicrosoftMessageChannel = {\n      id: 'microsoft-message-channel-id',\n      connectedAccount: {\n        id: 'microsoft-connected-account-id',\n        provider: ConnectedAccountProvider.MICROSOFT,\n        handle: 'test@microsoft.com',\n        accessToken: 'old-microsoft-access-token',\n        refreshToken: 'microsoft-refresh-token',\n        handleAliases: '',\n      },\n      messageFolders: [\n        {\n          id: 'inbox-folder-id',\n          name: 'inbox',\n          syncCursor: 'inbox-sync-cursor',\n          messageChannelId: 'microsoft-message-channel-id',\n        } as MessageFolderWorkspaceEntity,\n      ],\n    } as MessageChannelWorkspaceEntity;\n\n    mockGoogleMessageChannel = {\n      id: 'google-message-channel-id',\n      connectedAccount: {\n        id: 'google-connected-account-id',\n        provider: ConnectedAccountProvider.GOOGLE,\n        handle: 'test@gmail.com',\n        accessToken: 'old-google-access-token',\n        refreshToken: 'google-refresh-token',\n        handleAliases: '',\n      },\n      syncCursor: 'google-sync-cursor',\n    } as MessageChannelWorkspaceEntity;\n  });\n\n  beforeEach(async () => {\n    const mockMessageChannelMessageAssociationRepository = {\n      find: jest\n        .fn()\n        .mockResolvedValue([\n          { messageExternalId: 'external-id-existing-message-1' },\n          { messageExternalId: 'external-id-existing-message-2' },\n        ]),\n      delete: jest.fn().mockResolvedValue(undefined),\n    };\n\n    const mockMessageFolderRepository = {\n      find: jest.fn().mockImplementation(({ where }) => {\n        if (where?.pendingSyncAction === 'FOLDER_DELETION') {\n          return [];\n        }\n\n        return [\n          {\n            id: 'inbox-folder-id',\n            name: 'inbox',\n            syncCursor: 'inbox-sync-cursor',\n            messageChannelId: 'microsoft-message-channel-id',\n            isSynced: true,\n          },\n        ];\n      }),\n    };\n\n    const module: TestingModule = await Test.createTestingModule({\n      providers: [\n        MessagingMessageListFetchService,\n        {\n          provide: CacheStorageNamespace.ModuleMessaging,\n          useValue: {\n            setAdd: jest.fn().mockResolvedValue(undefined),\n            del: jest.fn().mockResolvedValue(undefined),\n          },\n        },\n        {\n          provide: MessagingGetMessageListService,\n          useValue: {\n            getMessageLists: jest.fn().mockImplementation((messageChannel) => {\n              if (\n                messageChannel.connectedAccount.provider ===\n                ConnectedAccountProvider.GOOGLE\n              ) {\n                return [\n                  {\n                    messageExternalIds: [\n                      'external-id-existing-message-1',\n                      'external-id-google-message-1',\n                      'external-id-google-message-2',\n                    ],\n                    nextSyncCursor: 'new-google-history-id',\n                    folderId: undefined,\n                    messageExternalIdsToDelete: [],\n                    previousSyncCursor: 'google-sync-cursor',\n                  },\n                ];\n              } else {\n                return [\n                  {\n                    messageExternalIds: [\n                      'external-id-existing-message-1',\n                      'external-id-new-message-1',\n                      'external-id-new-message-2',\n                    ],\n                    nextSyncCursor: 'new-sync-cursor',\n                    folderId: 'inbox-folder-id',\n                    messageExternalIdsToDelete: [],\n                    previousSyncCursor: 'inbox-sync-cursor',\n                  },\n                ];\n              }\n            }),\n          },\n        },\n        {\n          provide: MessagingMessagesImportService,\n          useValue: {\n            processMessageBatchImport: jest.fn().mockResolvedValue(undefined),\n          },\n        },\n        {\n          provide: MessagingAccountAuthenticationService,\n          useValue: {\n            validateAndRefreshConnectedAccountAuthentication: jest\n              .fn()\n              .mockImplementation(({ connectedAccount }) => {\n                if (\n                  connectedAccount.provider === ConnectedAccountProvider.GOOGLE\n                ) {\n                  return {\n                    accessToken: 'new-google-access-token',\n                    refreshToken: 'new-google-refresh-token',\n                  };\n                }\n\n                if (\n                  connectedAccount.provider ===\n                  ConnectedAccountProvider.MICROSOFT\n                ) {\n                  return {\n                    accessToken: 'new-microsoft-access-token',\n                    refreshToken: 'new-microsoft-refresh-token',\n                  };\n                }\n\n                return {\n                  accessToken: '',\n                  refreshToken: '',\n                };\n              }),\n          },\n        },\n        {\n          provide: MessageChannelSyncStatusService,\n          useValue: {\n            markAsMessagesListFetchOngoing: jest\n              .fn()\n              .mockResolvedValue(undefined),\n            scheduleMessagesImport: jest.fn().mockResolvedValue(undefined),\n          },\n        },\n        {\n          provide: TwentyORMManager,\n          useValue: {\n            getDatasource: jest.fn().mockResolvedValue({\n              manager: {},\n            }),\n            getRepository: jest.fn().mockImplementation((name) => {\n              if (name === 'messageChannelMessageAssociation') {\n                return mockMessageChannelMessageAssociationRepository;\n              }\n              if (name === 'messageFolder') {\n                return mockMessageFolderRepository;\n              }\n            }),\n          },\n        },\n        {\n          provide: MessagingCursorService,\n          useValue: {\n            updateCursor: jest.fn().mockResolvedValue(undefined),\n          },\n        },\n        {\n          provide: CacheStorageService,\n          useValue: {\n            setAdd: jest.fn().mockResolvedValue(undefined),\n            del: jest.fn().mockResolvedValue(undefined),\n          },\n        },\n        {\n          provide: MessageImportExceptionHandlerService,\n          useValue: {\n            handleDriverException: jest.fn().mockResolvedValue(undefined),\n          },\n        },\n        {\n          provide: MessagingMessageCleanerService,\n          useValue: {\n            cleanWorkspaceThreads: jest.fn().mockResolvedValue(undefined),\n          },\n        },\n        {\n          provide: SyncMessageFoldersService,\n          useValue: {\n            syncMessageFolders: jest.fn().mockResolvedValue(undefined),\n          },\n        },\n        {\n          provide: MessagingProcessGroupEmailActionsService,\n          useValue: {\n            processGroupEmailActions: jest.fn().mockResolvedValue(undefined),\n          },\n        },\n        {\n          provide: MessagingProcessFolderActionsService,\n          useValue: {\n            processFolderActions: jest.fn().mockResolvedValue(undefined),\n          },\n        },\n      ],\n    }).compile();\n\n    messagingMessageListFetchService =\n      module.get<MessagingMessageListFetchService>(\n        MessagingMessageListFetchService,\n      );\n    messagingAccountAuthenticationService =\n      module.get<MessagingAccountAuthenticationService>(\n        MessagingAccountAuthenticationService,\n      );\n\n    messagingGetMessageListService = module.get<MessagingGetMessageListService>(\n      MessagingGetMessageListService,\n    );\n    messageChannelSyncStatusService =\n      module.get<MessageChannelSyncStatusService>(\n        MessageChannelSyncStatusService,\n      );\n    twentyORMManager = module.get<TwentyORMManager>(TwentyORMManager);\n    messagingCursorService = module.get<MessagingCursorService>(\n      MessagingCursorService,\n    );\n  });\n\n  it('should process Microsoft message list fetch correctly', async () => {\n    await messagingMessageListFetchService.processMessageListFetch(\n      mockMicrosoftMessageChannel,\n      workspaceId,\n    );\n\n    expect(\n      messagingAccountAuthenticationService.validateAndRefreshConnectedAccountAuthentication,\n    ).toHaveBeenCalledWith({\n      connectedAccount: mockMicrosoftMessageChannel.connectedAccount,\n      workspaceId,\n      messageChannelId: mockMicrosoftMessageChannel.id,\n    });\n    expect(\n      messageChannelSyncStatusService.markAsMessagesListFetchOngoing,\n    ).toHaveBeenCalledWith([mockMicrosoftMessageChannel.id]);\n\n    expect(messagingGetMessageListService.getMessageLists).toHaveBeenCalledWith(\n      {\n        ...mockMicrosoftMessageChannel,\n        connectedAccount: {\n          ...mockMicrosoftMessageChannel.connectedAccount,\n          accessToken: 'new-microsoft-access-token',\n          refreshToken: 'new-microsoft-refresh-token',\n        },\n      },\n      [\n        {\n          id: 'inbox-folder-id',\n          name: 'inbox',\n          syncCursor: 'inbox-sync-cursor',\n          messageChannelId: 'microsoft-message-channel-id',\n          isSynced: true,\n        },\n      ],\n    );\n\n    expect(twentyORMManager.getRepository).toHaveBeenCalledWith(\n      'messageChannelMessageAssociation',\n    );\n\n    expect(messagingCursorService.updateCursor).toHaveBeenCalledWith(\n      {\n        ...mockMicrosoftMessageChannel,\n        connectedAccount: {\n          ...mockMicrosoftMessageChannel.connectedAccount,\n          accessToken: 'new-microsoft-access-token',\n          refreshToken: 'new-microsoft-refresh-token',\n        },\n      },\n      'new-sync-cursor',\n      'inbox-folder-id',\n    );\n\n    expect(\n      messageChannelSyncStatusService.scheduleMessagesImport,\n    ).toHaveBeenCalledWith([mockMicrosoftMessageChannel.id]);\n  });\n\n  it('should process Google message list fetch correctly', async () => {\n    await messagingMessageListFetchService.processMessageListFetch(\n      mockGoogleMessageChannel,\n      workspaceId,\n    );\n\n    expect(\n      messagingAccountAuthenticationService.validateAndRefreshConnectedAccountAuthentication,\n    ).toHaveBeenCalledWith({\n      connectedAccount: mockGoogleMessageChannel.connectedAccount,\n      workspaceId,\n      messageChannelId: mockGoogleMessageChannel.id,\n    });\n    expect(\n      messageChannelSyncStatusService.markAsMessagesListFetchOngoing,\n    ).toHaveBeenCalledWith([mockGoogleMessageChannel.id]);\n\n    expect(messagingGetMessageListService.getMessageLists).toHaveBeenCalledWith(\n      {\n        ...mockGoogleMessageChannel,\n        connectedAccount: {\n          ...mockGoogleMessageChannel.connectedAccount,\n          accessToken: 'new-google-access-token',\n          refreshToken: 'new-google-refresh-token',\n        },\n      },\n      [\n        {\n          id: 'inbox-folder-id',\n          name: 'inbox',\n          syncCursor: 'inbox-sync-cursor',\n          messageChannelId: 'microsoft-message-channel-id',\n          isSynced: true,\n        },\n      ],\n    );\n\n    expect(twentyORMManager.getRepository).toHaveBeenCalledWith(\n      'messageChannelMessageAssociation',\n    );\n\n    expect(messagingCursorService.updateCursor).toHaveBeenCalledWith(\n      {\n        ...mockGoogleMessageChannel,\n        connectedAccount: {\n          ...mockGoogleMessageChannel.connectedAccount,\n          accessToken: 'new-google-access-token',\n          refreshToken: 'new-google-refresh-token',\n        },\n      },\n      'new-google-history-id',\n      undefined,\n    );\n\n    expect(\n      messageChannelSyncStatusService.scheduleMessagesImport,\n    ).toHaveBeenCalledWith([mockGoogleMessageChannel.id]);\n  });\n});",
            "output_extracted": "import { Test, type TestingModule } from '@nestjs/testing';\n\nimport { ConnectedAccountProvider } from 'twenty-shared/types';\n\nimport { CacheStorageService } from 'src/engine/core-modules/cache-storage/services/cache-storage.service';\nimport { CacheStorageNamespace } from 'src/engine/core-modules/cache-storage/types/cache-storage-namespace.enum';\nimport { TwentyORMManager } from 'src/engine/twenty-orm/twenty-orm.manager';\nimport { MessageChannelSyncStatusService } from 'src/modules/messaging/common/services/message-channel-sync-status.service';\nimport { type MessageChannelWorkspaceEntity } from 'src/modules/messaging/common/standard-objects/message-channel.workspace-entity';\nimport { type MessageFolderWorkspaceEntity } from 'src/modules/messaging/common/standard-objects/message-folder.workspace-entity';\nimport { MessagingMessageCleanerService } from 'src/modules/messaging/message-cleaner/services/messaging-message-cleaner.service';\nimport { SyncMessageFoldersService } from 'src/modules/messaging/message-folder-manager/services/sync-message-folders.service';\nimport { MessagingAccountAuthenticationService } from 'src/modules/messaging/message-import-manager/services/messaging-account-authentication.service';\nimport { MessagingCursorService } from 'src/modules/messaging/message-import-manager/services/messaging-cursor.service';\nimport { MessagingGetMessageListService } from 'src/modules/messaging/message-import-manager/services/messaging-get-message-list.service';\nimport { MessageImportExceptionHandlerService } from 'src/modules/messaging/message-import-manager/services/messaging-import-exception-handler.service';\nimport { MessagingMessageListFetchService } from 'src/modules/messaging/message-import-manager/services/messaging-message-list-fetch.service';\nimport { MessagingMessagesImportService } from 'src/modules/messaging/message-import-manager/services/messaging-messages-import.service';\nimport { MessagingProcessFolderActionsService } from 'src/modules/messaging/message-import-manager/services/messaging-process-folder-actions.service';\nimport { MessagingProcessGroupEmailActionsService } from 'src/modules/messaging/message-import-manager/services/messaging-process-group-email-actions.service';\n\ndescribe('MessagingMessageListFetchService', () => {\n  let messagingMessageListFetchService: MessagingMessageListFetchService;\n  let messagingGetMessageListService: MessagingGetMessageListService;\n  let messagingAccountAuthenticationService: MessagingAccountAuthenticationService;\n  let messageChannelSyncStatusService: MessageChannelSyncStatusService;\n  let twentyORMManager: TwentyORMManager;\n  let messagingCursorService: MessagingCursorService;\n\n  let mockMicrosoftMessageChannel: MessageChannelWorkspaceEntity;\n  let mockGoogleMessageChannel: MessageChannelWorkspaceEntity;\n\n  const workspaceId = 'workspace-id';\n\n  beforeAll(() => {\n    mockMicrosoftMessageChannel = {\n      id: 'microsoft-message-channel-id',\n      connectedAccount: {\n        id: 'microsoft-connected-account-id',\n        provider: ConnectedAccountProvider.MICROSOFT,\n        handle: 'test@microsoft.com',\n        accessToken: 'old-microsoft-access-token',\n        refreshToken: 'microsoft-refresh-token',\n        handleAliases: '',\n      },\n      messageFolders: [\n        {\n          id: 'inbox-folder-id',\n          name: 'inbox',\n          syncCursor: 'inbox-sync-cursor',\n          messageChannelId: 'microsoft-message-channel-id',\n        } as MessageFolderWorkspaceEntity,\n      ],\n    } as MessageChannelWorkspaceEntity;\n\n    mockGoogleMessageChannel = {\n      id: 'google-message-channel-id',\n      connectedAccount: {\n        id: 'google-connected-account-id',\n        provider: ConnectedAccountProvider.GOOGLE,\n        handle: 'test@gmail.com',\n        accessToken: 'old-google-access-token',\n        refreshToken: 'google-refresh-token',\n        handleAliases: '',\n      },\n      syncCursor: 'google-sync-cursor',\n    } as MessageChannelWorkspaceEntity;\n  });\n\n  beforeEach(async () => {\n    const mockMessageChannelMessageAssociationRepository = {\n      find: jest\n        .fn()\n        .mockResolvedValue([\n          { messageExternalId: 'external-id-existing-message-1' },\n          { messageExternalId: 'external-id-existing-message-2' },\n        ]),\n      delete: jest.fn().mockResolvedValue(undefined),\n    };\n\n    const mockMessageFolderRepository = {\n      find: jest.fn().mockImplementation(({ where }) => {\n        if (where?.pendingSyncAction === 'FOLDER_DELETION') {\n          return [];\n        }\n\n        return [\n          {\n            id: 'inbox-folder-id',\n            name: 'inbox',\n            syncCursor: 'inbox-sync-cursor',\n            messageChannelId: 'microsoft-message-channel-id',\n            isSynced: true,\n          },\n        ];\n      }),\n    };\n\n    const module: TestingModule = await Test.createTestingModule({\n      providers: [\n        MessagingMessageListFetchService,\n        {\n          provide: CacheStorageNamespace.ModuleMessaging,\n          useValue: {\n            setAdd: jest.fn().mockResolvedValue(undefined),\n            del: jest.fn().mockResolvedValue(undefined),\n          },\n        },\n        {\n          provide: MessagingGetMessageListService,\n          useValue: {\n            getMessageLists: jest.fn().mockImplementation((messageChannel) => {\n              if (\n                messageChannel.connectedAccount.provider ===\n                ConnectedAccountProvider.GOOGLE\n              ) {\n                return [\n                  {\n                    messageExternalIds: [\n                      'external-id-existing-message-1',\n                      'external-id-google-message-1',\n                      'external-id-google-message-2',\n                    ],\n                    nextSyncCursor: 'new-google-history-id',\n                    folderId: undefined,\n                    messageExternalIdsToDelete: [],\n                    previousSyncCursor: 'google-sync-cursor',\n                  },\n                ];\n              } else {\n                return [\n                  {\n                    messageExternalIds: [\n                      'external-id-existing-message-1',\n                      'external-id-new-message-1',\n                      'external-id-new-message-2',\n                    ],\n                    nextSyncCursor: 'new-sync-cursor',\n                    folderId: 'inbox-folder-id',\n                    messageExternalIdsToDelete: [],\n                    previousSyncCursor: 'inbox-sync-cursor',\n                  },\n                ];\n              }\n            }),\n          },\n        },\n        {\n          provide: MessagingMessagesImportService,\n          useValue: {\n            processMessageBatchImport: jest.fn().mockResolvedValue(undefined),\n          },\n        },\n        {\n          provide: MessagingAccountAuthenticationService,\n          useValue: {\n            validateAndRefreshConnectedAccountAuthentication: jest\n              .fn()\n              .mockImplementation(({ connectedAccount }) => {\n                if (\n                  connectedAccount.provider === ConnectedAccountProvider.GOOGLE\n                ) {\n                  return {\n                    accessToken: 'new-google-access-token',\n                    refreshToken: 'new-google-refresh-token',\n                  };\n                }\n\n                if (\n                  connectedAccount.provider ===\n                  ConnectedAccountProvider.MICROSOFT\n                ) {\n                  return {\n                    accessToken: 'new-microsoft-access-token',\n                    refreshToken: 'new-microsoft-refresh-token',\n                  };\n                }\n\n                return {\n                  accessToken: '',\n                  refreshToken: '',\n                };\n              }),\n          },\n        },\n        {\n          provide: MessageChannelSyncStatusService,\n          useValue: {\n            markAsMessagesListFetchOngoing: jest\n              .fn()\n              .mockResolvedValue(undefined),\n            scheduleMessagesImport: jest.fn().mockResolvedValue(undefined),\n          },\n        },\n        {\n          provide: TwentyORMManager,\n          useValue: {\n            getDatasource: jest.fn().mockResolvedValue({\n              manager: {},\n            }),\n            getRepository: jest.fn().mockImplementation((name) => {\n              if (name === 'messageChannelMessageAssociation') {\n                return mockMessageChannelMessageAssociationRepository;\n              }\n              if (name === 'messageFolder') {\n                return mockMessageFolderRepository;\n              }\n            }),\n          },\n        },\n        {\n          provide: MessagingCursorService,\n          useValue: {\n            updateCursor: jest.fn().mockResolvedValue(undefined),\n          },\n        },\n        {\n          provide: CacheStorageService,\n          useValue: {\n            setAdd: jest.fn().mockResolvedValue(undefined),\n            del: jest.fn().mockResolvedValue(undefined),\n          },\n        },\n        {\n          provide: MessageImportExceptionHandlerService,\n          useValue: {\n            handleDriverException: jest.fn().mockResolvedValue(undefined),\n          },\n        },\n        {\n          provide: MessagingMessageCleanerService,\n          useValue: {\n            cleanWorkspaceThreads: jest.fn().mockResolvedValue(undefined),\n          },\n        },\n        {\n          provide: SyncMessageFoldersService,\n          useValue: {\n            syncMessageFolders: jest.fn().mockResolvedValue(undefined),\n          },\n        },\n        {\n          provide: MessagingProcessGroupEmailActionsService,\n          useValue: {\n            processGroupEmailActions: jest.fn().mockResolvedValue(undefined),\n          },\n        },\n        {\n          provide: MessagingProcessFolderActionsService,\n          useValue: {\n            processFolderActions: jest.fn().mockResolvedValue(undefined),\n          },\n        },\n      ],\n    }).compile();\n\n    messagingMessageListFetchService =\n      module.get<MessagingMessageListFetchService>(\n        MessagingMessageListFetchService,\n      );\n    messagingAccountAuthenticationService =\n      module.get<MessagingAccountAuthenticationService>(\n        MessagingAccountAuthenticationService,\n      );\n\n    messagingGetMessageListService = module.get<MessagingGetMessageListService>(\n      MessagingGetMessageListService,\n    );\n    messageChannelSyncStatusService =\n      module.get<MessageChannelSyncStatusService>(\n        MessageChannelSyncStatusService,\n      );\n    twentyORMManager = module.get<TwentyORMManager>(TwentyORMManager);\n    messagingCursorService = module.get<MessagingCursorService>(\n      MessagingCursorService,\n    );\n  });\n\n  it('should process Microsoft message list fetch correctly', async () => {\n    await messagingMessageListFetchService.processMessageListFetch(\n      mockMicrosoftMessageChannel,\n      workspaceId,\n    );\n\n    expect(\n      messagingAccountAuthenticationService.validateAndRefreshConnectedAccountAuthentication,\n    ).toHaveBeenCalledWith({\n      connectedAccount: mockMicrosoftMessageChannel.connectedAccount,\n      workspaceId,\n      messageChannelId: mockMicrosoftMessageChannel.id,\n    });\n    expect(\n      messageChannelSyncStatusService.markAsMessagesListFetchOngoing,\n    ).toHaveBeenCalledWith([mockMicrosoftMessageChannel.id]);\n\n    expect(messagingGetMessageListService.getMessageLists).toHaveBeenCalledWith(\n      {\n        ...mockMicrosoftMessageChannel,\n        connectedAccount: {\n          ...mockMicrosoftMessageChannel.connectedAccount,\n          accessToken: 'new-microsoft-access-token',\n          refreshToken: 'new-microsoft-refresh-token',\n        },\n      },\n      [\n        {\n          id: 'inbox-folder-id',\n          name: 'inbox',\n          syncCursor: 'inbox-sync-cursor',\n          messageChannelId: 'microsoft-message-channel-id',\n          isSynced: true,\n        },\n      ],\n    );\n\n    expect(twentyORMManager.getRepository).toHaveBeenCalledWith(\n      'messageChannelMessageAssociation',\n    );\n\n    expect(messagingCursorService.updateCursor).toHaveBeenCalledWith(\n      {\n        ...mockMicrosoftMessageChannel,\n        connectedAccount: {\n          ...mockMicrosoftMessageChannel.connectedAccount,\n          accessToken: 'new-microsoft-access-token',\n          refreshToken: 'new-microsoft-refresh-token',\n        },\n      },\n      'new-sync-cursor',\n      'inbox-folder-id',\n    );\n\n    expect(\n      messageChannelSyncStatusService.scheduleMessagesImport,\n    ).toHaveBeenCalledWith([mockMicrosoftMessageChannel.id]);\n  });\n\n  it('should process Google message list fetch correctly', async () => {\n    await messagingMessageListFetchService.processMessageListFetch(\n      mockGoogleMessageChannel,\n      workspaceId,\n    );\n\n    expect(\n      messagingAccountAuthenticationService.validateAndRefreshConnectedAccountAuthentication,\n    ).toHaveBeenCalledWith({\n      connectedAccount: mockGoogleMessageChannel.connectedAccount,\n      workspaceId,\n      messageChannelId: mockGoogleMessageChannel.id,\n    });\n    expect(\n      messageChannelSyncStatusService.markAsMessagesListFetchOngoing,\n    ).toHaveBeenCalledWith([mockGoogleMessageChannel.id]);\n\n    expect(messagingGetMessageListService.getMessageLists).toHaveBeenCalledWith(\n      {\n        ...mockGoogleMessageChannel,\n        connectedAccount: {\n          ...mockGoogleMessageChannel.connectedAccount,\n          accessToken: 'new-google-access-token',\n          refreshToken: 'new-google-refresh-token',\n        },\n      },\n      [\n        {\n          id: 'inbox-folder-id',\n          name: 'inbox',\n          syncCursor: 'inbox-sync-cursor',\n          messageChannelId: 'microsoft-message-channel-id',\n          isSynced: true,\n        },\n      ],\n    );\n\n    expect(twentyORMManager.getRepository).toHaveBeenCalledWith(\n      'messageChannelMessageAssociation',\n    );\n\n    expect(messagingCursorService.updateCursor).toHaveBeenCalledWith(\n      {\n        ...mockGoogleMessageChannel,\n        connectedAccount: {\n          ...mockGoogleMessageChannel.connectedAccount,\n          accessToken: 'new-google-access-token',\n          refreshToken: 'new-google-refresh-token',\n        },\n      },\n      'new-google-history-id',\n      undefined,\n    );\n\n    expect(\n      messageChannelSyncStatusService.scheduleMessagesImport,\n    ).toHaveBeenCalledWith([mockGoogleMessageChannel.id]);\n  });\n});",
            "cost": 0.125195
        },
        "twentyhq__twenty.main/packages/twenty-server/src/modules/messaging/message-import-manager/services/__tests__/messaging-messages-import.service.spec.ts": {
            "output": "import { Logger, type Provider } from '@nestjs/common';\nimport { Test, type TestingModule } from '@nestjs/testing';\n\nimport { ConnectedAccountProvider } from 'twenty-shared/types';\n\nimport { CacheStorageService } from 'src/engine/core-modules/cache-storage/services/cache-storage.service';\nimport { CacheStorageNamespace } from 'src/engine/core-modules/cache-storage/types/cache-storage-namespace.enum';\nimport { TwentyORMManager } from 'src/engine/twenty-orm/twenty-orm.manager';\nimport { BlocklistRepository } from 'src/modules/blocklist/repositories/blocklist.repository';\nimport { EmailAliasManagerService } from 'src/modules/connected-account/email-alias-manager/services/email-alias-manager.service';\nimport { ConnectedAccountRefreshTokensService } from 'src/modules/connected-account/refresh-tokens-manager/services/connected-account-refresh-tokens.service';\nimport { type ConnectedAccountWorkspaceEntity } from 'src/modules/connected-account/standard-objects/connected-account.workspace-entity';\nimport { MessageChannelSyncStatusService } from 'src/modules/messaging/common/services/message-channel-sync-status.service';\nimport {\n  MessageChannelSyncStage,\n  type MessageChannelWorkspaceEntity,\n} from 'src/modules/messaging/common/standard-objects/message-channel.workspace-entity';\nimport { MESSAGING_GMAIL_USERS_MESSAGES_GET_BATCH_SIZE } from 'src/modules/messaging/message-import-manager/drivers/gmail/constants/messaging-gmail-users-messages-get-batch-size.constant';\nimport { MessagingAccountAuthenticationService } from 'src/modules/messaging/message-import-manager/services/messaging-account-authentication.service';\nimport { MessagingGetMessagesService } from 'src/modules/messaging/message-import-manager/services/messaging-get-messages.service';\nimport { MessageImportExceptionHandlerService } from 'src/modules/messaging/message-import-manager/services/messaging-import-exception-handler.service';\nimport { MessagingMessagesImportService } from 'src/modules/messaging/message-import-manager/services/messaging-messages-import.service';\nimport { MessagingSaveMessagesAndEnqueueContactCreationService } from 'src/modules/messaging/message-import-manager/services/messaging-save-messages-and-enqueue-contact-creation.service';\nimport { MessagingMonitoringService } from 'src/modules/messaging/monitoring/services/messaging-monitoring.service';\n\ndescribe('MessagingMessagesImportService', () => {\n  let service: MessagingMessagesImportService;\n  let messageChannelSyncStatusService: MessageChannelSyncStatusService;\n  let connectedAccountRefreshTokensService: ConnectedAccountRefreshTokensService;\n  let emailAliasManagerService: EmailAliasManagerService;\n  let messagingGetMessagesService: MessagingGetMessagesService;\n  let saveMessagesService: MessagingSaveMessagesAndEnqueueContactCreationService;\n\n  const workspaceId = 'workspace-id';\n  let mockMessageChannel: MessageChannelWorkspaceEntity;\n  let mockConnectedAccount: ConnectedAccountWorkspaceEntity;\n  let providersBase: Provider[];\n\n  beforeEach(async () => {\n    mockConnectedAccount = {\n      id: 'connected-account-id',\n      provider: ConnectedAccountProvider.GOOGLE,\n      handle: 'test@gmail.com',\n      refreshToken: 'refresh-token',\n      accessToken: 'old-access-token',\n      accountOwnerId: 'account-owner-id',\n      handleAliases: 'alias1@gmail.com,alias2@gmail.com',\n    } as ConnectedAccountWorkspaceEntity;\n\n    mockMessageChannel = {\n      id: 'message-channel-id',\n      syncStage: MessageChannelSyncStage.MESSAGES_IMPORT_SCHEDULED,\n      connectedAccountId: mockConnectedAccount.id,\n      handle: 'test@gmail.com',\n    } as MessageChannelWorkspaceEntity;\n\n    providersBase = [\n      MessagingMessagesImportService,\n      {\n        provide: CacheStorageService,\n        useValue: {\n          setAdd: jest.fn().mockResolvedValue(undefined),\n        },\n      },\n      {\n        provide: MessageChannelSyncStatusService,\n        useValue: {\n          markAsMessagesImportOngoing: jest.fn().mockResolvedValue(undefined),\n          markAsCompletedAndScheduleMessageListFetch: jest\n            .fn()\n            .mockResolvedValue(undefined),\n          scheduleMessagesImport: jest.fn().mockResolvedValue(undefined),\n        },\n      },\n      {\n        provide: ConnectedAccountRefreshTokensService,\n        useValue: {\n          refreshAndSaveTokens: jest.fn().mockResolvedValue({\n            accessToken: 'new-access-token',\n            refreshToken: 'new-refresh-token',\n          }),\n        },\n      },\n      {\n        provide: MessagingMonitoringService,\n        useValue: {\n          track: jest.fn().mockResolvedValue(undefined),\n        },\n      },\n      {\n        provide: 'BlocklistRepository',\n        useValue: {\n          getByWorkspaceMemberId: jest.fn().mockResolvedValue([]),\n        },\n      },\n      {\n        provide: BlocklistRepository,\n        useValue: {\n          getByWorkspaceMemberId: jest.fn().mockResolvedValue([]),\n        },\n      },\n      {\n        provide: EmailAliasManagerService,\n        useValue: {\n          refreshHandleAliases: jest.fn().mockResolvedValue(undefined),\n        },\n      },\n      {\n        provide: TwentyORMManager,\n        useValue: {\n          getRepository: jest.fn().mockResolvedValue({\n            update: jest.fn().mockResolvedValue(undefined),\n          }),\n        },\n      },\n      {\n        provide: MessagingGetMessagesService,\n        useValue: {\n          getMessages: jest.fn().mockResolvedValue([\n            {\n              id: 'message-1',\n              from: 'sender@example.com',\n              to: 'test@gmail.com',\n            },\n            {\n              id: 'message-2',\n              from: 'test@gmail.com',\n              to: 'recipient@example.com',\n            },\n          ]),\n        },\n      },\n      {\n        provide: MessagingSaveMessagesAndEnqueueContactCreationService,\n        useValue: {\n          saveMessagesAndEnqueueContactCreation: jest\n            .fn()\n            .mockResolvedValue(undefined),\n        },\n      },\n      {\n        provide: MessageImportExceptionHandlerService,\n        useValue: {\n          handleDriverException: jest.fn().mockResolvedValue(undefined),\n        },\n      },\n      {\n        provide: MessagingAccountAuthenticationService,\n        useClass: MessagingAccountAuthenticationService,\n      },\n    ];\n    const module: TestingModule = await Test.createTestingModule({\n      providers: [\n        ...providersBase,\n        {\n          provide: CacheStorageNamespace.ModuleMessaging,\n          useValue: {\n            setPop: jest\n              .fn()\n              .mockResolvedValue(['message-id-1', 'message-id-2']),\n            setAdd: jest.fn().mockResolvedValue(undefined),\n          },\n        },\n      ],\n    })\n      .overrideProvider(Logger)\n      .useValue({ log: jest.fn() })\n      .compile();\n\n    service = module.get<MessagingMessagesImportService>(\n      MessagingMessagesImportService,\n    );\n\n    messageChannelSyncStatusService =\n      module.get<MessageChannelSyncStatusService>(\n        MessageChannelSyncStatusService,\n      );\n    connectedAccountRefreshTokensService =\n      module.get<ConnectedAccountRefreshTokensService>(\n        ConnectedAccountRefreshTokensService,\n      );\n    emailAliasManagerService = module.get<EmailAliasManagerService>(\n      EmailAliasManagerService,\n    );\n    messagingGetMessagesService = module.get<MessagingGetMessagesService>(\n      MessagingGetMessagesService,\n    );\n\n    saveMessagesService =\n      module.get<MessagingSaveMessagesAndEnqueueContactCreationService>(\n        MessagingSaveMessagesAndEnqueueContactCreationService,\n      );\n  });\n\n  it('should fails if SyncStage is not MESSAGES_IMPORT_SCHEDULED', async () => {\n    mockMessageChannel.syncStage =\n      MessageChannelSyncStage.MESSAGES_IMPORT_PENDING;\n\n    expect(\n      service.processMessageBatchImport(\n        mockMessageChannel,\n        mockConnectedAccount,\n        workspaceId,\n      ),\n    ).resolves.toBeFalsy();\n  });\n\n  it('should process message batch import successfully', async () => {\n    await service.processMessageBatchImport(\n      mockMessageChannel,\n      mockConnectedAccount,\n      workspaceId,\n    );\n    expect(\n      messageChannelSyncStatusService.markAsMessagesImportOngoing,\n    ).toHaveBeenCalledWith([mockMessageChannel.id]);\n\n    expect(\n      connectedAccountRefreshTokensService.refreshAndSaveTokens,\n    ).toHaveBeenCalledWith(mockConnectedAccount, workspaceId);\n\n    expect(emailAliasManagerService.refreshHandleAliases).toHaveBeenCalledWith({\n      ...mockConnectedAccount,\n      accessToken: 'new-access-token',\n      refreshToken: 'new-refresh-token',\n    });\n    expect(messagingGetMessagesService.getMessages).toHaveBeenCalledWith(\n      ['message-id-1', 'message-id-2'],\n      {\n        ...mockConnectedAccount,\n        accessToken: 'new-access-token',\n        refreshToken: 'new-refresh-token',\n      },\n    );\n    expect(\n      saveMessagesService.saveMessagesAndEnqueueContactCreation,\n    ).toHaveBeenCalled();\n    expect(\n      messageChannelSyncStatusService.scheduleMessagesImport,\n    ).toHaveBeenCalledTimes(0);\n  });\n\n  it('should process message batch import of more than MESSAGING_GMAIL_USERS_MESSAGES_GET_BATCH_SIZE successfully', async () => {\n    const arrayMessagesBig = Array.from(\n      { length: MESSAGING_GMAIL_USERS_MESSAGES_GET_BATCH_SIZE + 1 },\n      (_, index) => `message-id-${index + 1}`,\n    );\n\n    const module: TestingModule = await Test.createTestingModule({\n      providers: [\n        ...providersBase,\n        {\n          provide: CacheStorageNamespace.ModuleMessaging,\n          useValue: {\n            setPop: jest.fn().mockResolvedValue(arrayMessagesBig),\n            setAdd: jest.fn().mockResolvedValue(undefined),\n          },\n        },\n      ],\n    })\n      .overrideProvider(Logger)\n      .useValue({ log: jest.fn() })\n      .compile();\n\n    service = module.get<MessagingMessagesImportService>(\n      MessagingMessagesImportService,\n    );\n\n    messageChannelSyncStatusService =\n      module.get<MessageChannelSyncStatusService>(\n        MessageChannelSyncStatusService,\n      );\n    connectedAccountRefreshTokensService =\n      module.get<ConnectedAccountRefreshTokensService>(\n        ConnectedAccountRefreshTokensService,\n      );\n    emailAliasManagerService = module.get<EmailAliasManagerService>(\n      EmailAliasManagerService,\n    );\n    messagingGetMessagesService = module.get<MessagingGetMessagesService>(\n      MessagingGetMessagesService,\n    );\n\n    saveMessagesService =\n      module.get<MessagingSaveMessagesAndEnqueueContactCreationService>(\n        MessagingSaveMessagesAndEnqueueContactCreationService,\n      );\n\n    await service.processMessageBatchImport(\n      mockMessageChannel,\n      mockConnectedAccount,\n      workspaceId,\n    );\n\n    expect(\n      messageChannelSyncStatusService.scheduleMessagesImport,\n    ).toHaveBeenCalledTimes(1);\n  });\n});",
            "output_extracted": "import { Logger, type Provider } from '@nestjs/common';\nimport { Test, type TestingModule } from '@nestjs/testing';\n\nimport { ConnectedAccountProvider } from 'twenty-shared/types';\n\nimport { CacheStorageService } from 'src/engine/core-modules/cache-storage/services/cache-storage.service';\nimport { CacheStorageNamespace } from 'src/engine/core-modules/cache-storage/types/cache-storage-namespace.enum';\nimport { TwentyORMManager } from 'src/engine/twenty-orm/twenty-orm.manager';\nimport { BlocklistRepository } from 'src/modules/blocklist/repositories/blocklist.repository';\nimport { EmailAliasManagerService } from 'src/modules/connected-account/email-alias-manager/services/email-alias-manager.service';\nimport { ConnectedAccountRefreshTokensService } from 'src/modules/connected-account/refresh-tokens-manager/services/connected-account-refresh-tokens.service';\nimport { type ConnectedAccountWorkspaceEntity } from 'src/modules/connected-account/standard-objects/connected-account.workspace-entity';\nimport { MessageChannelSyncStatusService } from 'src/modules/messaging/common/services/message-channel-sync-status.service';\nimport {\n  MessageChannelSyncStage,\n  type MessageChannelWorkspaceEntity,\n} from 'src/modules/messaging/common/standard-objects/message-channel.workspace-entity';\nimport { MESSAGING_GMAIL_USERS_MESSAGES_GET_BATCH_SIZE } from 'src/modules/messaging/message-import-manager/drivers/gmail/constants/messaging-gmail-users-messages-get-batch-size.constant';\nimport { MessagingAccountAuthenticationService } from 'src/modules/messaging/message-import-manager/services/messaging-account-authentication.service';\nimport { MessagingGetMessagesService } from 'src/modules/messaging/message-import-manager/services/messaging-get-messages.service';\nimport { MessageImportExceptionHandlerService } from 'src/modules/messaging/message-import-manager/services/messaging-import-exception-handler.service';\nimport { MessagingMessagesImportService } from 'src/modules/messaging/message-import-manager/services/messaging-messages-import.service';\nimport { MessagingSaveMessagesAndEnqueueContactCreationService } from 'src/modules/messaging/message-import-manager/services/messaging-save-messages-and-enqueue-contact-creation.service';\nimport { MessagingMonitoringService } from 'src/modules/messaging/monitoring/services/messaging-monitoring.service';\n\ndescribe('MessagingMessagesImportService', () => {\n  let service: MessagingMessagesImportService;\n  let messageChannelSyncStatusService: MessageChannelSyncStatusService;\n  let connectedAccountRefreshTokensService: ConnectedAccountRefreshTokensService;\n  let emailAliasManagerService: EmailAliasManagerService;\n  let messagingGetMessagesService: MessagingGetMessagesService;\n  let saveMessagesService: MessagingSaveMessagesAndEnqueueContactCreationService;\n\n  const workspaceId = 'workspace-id';\n  let mockMessageChannel: MessageChannelWorkspaceEntity;\n  let mockConnectedAccount: ConnectedAccountWorkspaceEntity;\n  let providersBase: Provider[];\n\n  beforeEach(async () => {\n    mockConnectedAccount = {\n      id: 'connected-account-id',\n      provider: ConnectedAccountProvider.GOOGLE,\n      handle: 'test@gmail.com',\n      refreshToken: 'refresh-token',\n      accessToken: 'old-access-token',\n      accountOwnerId: 'account-owner-id',\n      handleAliases: 'alias1@gmail.com,alias2@gmail.com',\n    } as ConnectedAccountWorkspaceEntity;\n\n    mockMessageChannel = {\n      id: 'message-channel-id',\n      syncStage: MessageChannelSyncStage.MESSAGES_IMPORT_SCHEDULED,\n      connectedAccountId: mockConnectedAccount.id,\n      handle: 'test@gmail.com',\n    } as MessageChannelWorkspaceEntity;\n\n    providersBase = [\n      MessagingMessagesImportService,\n      {\n        provide: CacheStorageService,\n        useValue: {\n          setAdd: jest.fn().mockResolvedValue(undefined),\n        },\n      },\n      {\n        provide: MessageChannelSyncStatusService,\n        useValue: {\n          markAsMessagesImportOngoing: jest.fn().mockResolvedValue(undefined),\n          markAsCompletedAndScheduleMessageListFetch: jest\n            .fn()\n            .mockResolvedValue(undefined),\n          scheduleMessagesImport: jest.fn().mockResolvedValue(undefined),\n        },\n      },\n      {\n        provide: ConnectedAccountRefreshTokensService,\n        useValue: {\n          refreshAndSaveTokens: jest.fn().mockResolvedValue({\n            accessToken: 'new-access-token',\n            refreshToken: 'new-refresh-token',\n          }),\n        },\n      },\n      {\n        provide: MessagingMonitoringService,\n        useValue: {\n          track: jest.fn().mockResolvedValue(undefined),\n        },\n      },\n      {\n        provide: 'BlocklistRepository',\n        useValue: {\n          getByWorkspaceMemberId: jest.fn().mockResolvedValue([]),\n        },\n      },\n      {\n        provide: BlocklistRepository,\n        useValue: {\n          getByWorkspaceMemberId: jest.fn().mockResolvedValue([]),\n        },\n      },\n      {\n        provide: EmailAliasManagerService,\n        useValue: {\n          refreshHandleAliases: jest.fn().mockResolvedValue(undefined),\n        },\n      },\n      {\n        provide: TwentyORMManager,\n        useValue: {\n          getRepository: jest.fn().mockResolvedValue({\n            update: jest.fn().mockResolvedValue(undefined),\n          }),\n        },\n      },\n      {\n        provide: MessagingGetMessagesService,\n        useValue: {\n          getMessages: jest.fn().mockResolvedValue([\n            {\n              id: 'message-1',\n              from: 'sender@example.com',\n              to: 'test@gmail.com',\n            },\n            {\n              id: 'message-2',\n              from: 'test@gmail.com',\n              to: 'recipient@example.com',\n            },\n          ]),\n        },\n      },\n      {\n        provide: MessagingSaveMessagesAndEnqueueContactCreationService,\n        useValue: {\n          saveMessagesAndEnqueueContactCreation: jest\n            .fn()\n            .mockResolvedValue(undefined),\n        },\n      },\n      {\n        provide: MessageImportExceptionHandlerService,\n        useValue: {\n          handleDriverException: jest.fn().mockResolvedValue(undefined),\n        },\n      },\n      {\n        provide: MessagingAccountAuthenticationService,\n        useClass: MessagingAccountAuthenticationService,\n      },\n    ];\n    const module: TestingModule = await Test.createTestingModule({\n      providers: [\n        ...providersBase,\n        {\n          provide: CacheStorageNamespace.ModuleMessaging,\n          useValue: {\n            setPop: jest\n              .fn()\n              .mockResolvedValue(['message-id-1', 'message-id-2']),\n            setAdd: jest.fn().mockResolvedValue(undefined),\n          },\n        },\n      ],\n    })\n      .overrideProvider(Logger)\n      .useValue({ log: jest.fn() })\n      .compile();\n\n    service = module.get<MessagingMessagesImportService>(\n      MessagingMessagesImportService,\n    );\n\n    messageChannelSyncStatusService =\n      module.get<MessageChannelSyncStatusService>(\n        MessageChannelSyncStatusService,\n      );\n    connectedAccountRefreshTokensService =\n      module.get<ConnectedAccountRefreshTokensService>(\n        ConnectedAccountRefreshTokensService,\n      );\n    emailAliasManagerService = module.get<EmailAliasManagerService>(\n      EmailAliasManagerService,\n    );\n    messagingGetMessagesService = module.get<MessagingGetMessagesService>(\n      MessagingGetMessagesService,\n    );\n\n    saveMessagesService =\n      module.get<MessagingSaveMessagesAndEnqueueContactCreationService>(\n        MessagingSaveMessagesAndEnqueueContactCreationService,\n      );\n  });\n\n  it('should fails if SyncStage is not MESSAGES_IMPORT_SCHEDULED', async () => {\n    mockMessageChannel.syncStage =\n      MessageChannelSyncStage.MESSAGES_IMPORT_PENDING;\n\n    expect(\n      service.processMessageBatchImport(\n        mockMessageChannel,\n        mockConnectedAccount,\n        workspaceId,\n      ),\n    ).resolves.toBeFalsy();\n  });\n\n  it('should process message batch import successfully', async () => {\n    await service.processMessageBatchImport(\n      mockMessageChannel,\n      mockConnectedAccount,\n      workspaceId,\n    );\n    expect(\n      messageChannelSyncStatusService.markAsMessagesImportOngoing,\n    ).toHaveBeenCalledWith([mockMessageChannel.id]);\n\n    expect(\n      connectedAccountRefreshTokensService.refreshAndSaveTokens,\n    ).toHaveBeenCalledWith(mockConnectedAccount, workspaceId);\n\n    expect(emailAliasManagerService.refreshHandleAliases).toHaveBeenCalledWith({\n      ...mockConnectedAccount,\n      accessToken: 'new-access-token',\n      refreshToken: 'new-refresh-token',\n    });\n    expect(messagingGetMessagesService.getMessages).toHaveBeenCalledWith(\n      ['message-id-1', 'message-id-2'],\n      {\n        ...mockConnectedAccount,\n        accessToken: 'new-access-token',\n        refreshToken: 'new-refresh-token',\n      },\n    );\n    expect(\n      saveMessagesService.saveMessagesAndEnqueueContactCreation,\n    ).toHaveBeenCalled();\n    expect(\n      messageChannelSyncStatusService.scheduleMessagesImport,\n    ).toHaveBeenCalledTimes(0);\n  });\n\n  it('should process message batch import of more than MESSAGING_GMAIL_USERS_MESSAGES_GET_BATCH_SIZE successfully', async () => {\n    const arrayMessagesBig = Array.from(\n      { length: MESSAGING_GMAIL_USERS_MESSAGES_GET_BATCH_SIZE + 1 },\n      (_, index) => `message-id-${index + 1}`,\n    );\n\n    const module: TestingModule = await Test.createTestingModule({\n      providers: [\n        ...providersBase,\n        {\n          provide: CacheStorageNamespace.ModuleMessaging,\n          useValue: {\n            setPop: jest.fn().mockResolvedValue(arrayMessagesBig),\n            setAdd: jest.fn().mockResolvedValue(undefined),\n          },\n        },\n      ],\n    })\n      .overrideProvider(Logger)\n      .useValue({ log: jest.fn() })\n      .compile();\n\n    service = module.get<MessagingMessagesImportService>(\n      MessagingMessagesImportService,\n    );\n\n    messageChannelSyncStatusService =\n      module.get<MessageChannelSyncStatusService>(\n        MessageChannelSyncStatusService,\n      );\n    connectedAccountRefreshTokensService =\n      module.get<ConnectedAccountRefreshTokensService>(\n        ConnectedAccountRefreshTokensService,\n      );\n    emailAliasManagerService = module.get<EmailAliasManagerService>(\n      EmailAliasManagerService,\n    );\n    messagingGetMessagesService = module.get<MessagingGetMessagesService>(\n      MessagingGetMessagesService,\n    );\n\n    saveMessagesService =\n      module.get<MessagingSaveMessagesAndEnqueueContactCreationService>(\n        MessagingSaveMessagesAndEnqueueContactCreationService,\n      );\n\n    await service.processMessageBatchImport(\n      mockMessageChannel,\n      mockConnectedAccount,\n      workspaceId,\n    );\n\n    expect(\n      messageChannelSyncStatusService.scheduleMessagesImport,\n    ).toHaveBeenCalledTimes(1);\n  });\n});",
            "cost": 0.09970000000000001
        }
    },
    "recover_status": "success",
    "instance_ref": {
        "instance_id": "twentyhq__twenty.main.16326",
        "repo": "twentyhq/twenty",
        "base_commit": "8ee2efead7f10e125b45c9b0d4f1375d9231f51b",
        "head_commit": "4630733b5545aec0fe039440d4fe1c59a679a50f",
        "title": "Fix Message/Calendar channel stuck in SCHEDULED syncStage",
        "merged_at": "2025-12-04T15:01:12Z",
        "html_url": "https://github.com/twentyhq/twenty/pull/16326",
        "test_files": [
            "packages/twenty-server/src/modules/messaging/message-import-manager/services/__tests__/messaging-message-list-fetch.service.spec.ts",
            "packages/twenty-server/src/modules/messaging/message-import-manager/services/__tests__/messaging-messages-import.service.spec.ts"
        ],
        "code_files": [
            "packages/twenty-server/src/modules/calendar/calendar-event-import-manager/crons/jobs/calendar-event-list-fetch.cron.job.ts",
            "packages/twenty-server/src/modules/calendar/calendar-event-import-manager/crons/jobs/calendar-events-import.cron.job.ts",
            "packages/twenty-server/src/modules/messaging/common/services/message-channel-sync-status.service.ts",
            "packages/twenty-server/src/modules/messaging/message-import-manager/crons/jobs/messaging-message-list-fetch.cron.job.ts",
            "packages/twenty-server/src/modules/messaging/message-import-manager/crons/jobs/messaging-messages-import.cron.job.ts"
        ],
        "total_changes": 71,
        "num_files": 7,
        "pull_number": 16326,
        "patch": "diff --git a/packages/twenty-server/src/modules/calendar/calendar-event-import-manager/crons/jobs/calendar-event-list-fetch.cron.job.ts b/packages/twenty-server/src/modules/calendar/calendar-event-import-manager/crons/jobs/calendar-event-list-fetch.cron.job.ts\nindex 3700e337e5054..aef27c0b063cd 100644\n--- a/packages/twenty-server/src/modules/calendar/calendar-event-import-manager/crons/jobs/calendar-event-list-fetch.cron.job.ts\n+++ b/packages/twenty-server/src/modules/calendar/calendar-event-import-manager/crons/jobs/calendar-event-list-fetch.cron.job.ts\n@@ -50,8 +50,11 @@ export class CalendarEventListFetchCronJob {\n       try {\n         const schemaName = getWorkspaceSchemaName(activeWorkspace.id);\n \n+        const now = new Date().toISOString();\n+\n         const [calendarChannels] = await this.coreDataSource.query(\n-          `UPDATE ${schemaName}.\"calendarChannel\" SET \"syncStage\" = '${CalendarChannelSyncStage.CALENDAR_EVENT_LIST_FETCH_SCHEDULED}' WHERE \"isSyncEnabled\" = true AND \"syncStage\" = '${CalendarChannelSyncStage.CALENDAR_EVENT_LIST_FETCH_PENDING}' RETURNING *`,\n+          `UPDATE ${schemaName}.\"calendarChannel\" SET \"syncStage\" = '${CalendarChannelSyncStage.CALENDAR_EVENT_LIST_FETCH_SCHEDULED}', \"syncStageStartedAt\" = '${now}'\n+          WHERE \"isSyncEnabled\" = true AND \"syncStage\" = '${CalendarChannelSyncStage.CALENDAR_EVENT_LIST_FETCH_PENDING}' RETURNING *`,\n         );\n \n         for (const calendarChannel of calendarChannels) {\ndiff --git a/packages/twenty-server/src/modules/calendar/calendar-event-import-manager/crons/jobs/calendar-events-import.cron.job.ts b/packages/twenty-server/src/modules/calendar/calendar-event-import-manager/crons/jobs/calendar-events-import.cron.job.ts\nindex e75e462985971..c5e3318585ec6 100644\n--- a/packages/twenty-server/src/modules/calendar/calendar-event-import-manager/crons/jobs/calendar-events-import.cron.job.ts\n+++ b/packages/twenty-server/src/modules/calendar/calendar-event-import-manager/crons/jobs/calendar-events-import.cron.job.ts\n@@ -48,8 +48,11 @@ export class CalendarEventsImportCronJob {\n       try {\n         const schemaName = getWorkspaceSchemaName(activeWorkspace.id);\n \n+        const now = new Date().toISOString();\n+\n         const [calendarChannels] = await this.coreDataSource.query(\n-          `UPDATE ${schemaName}.\"calendarChannel\" SET \"syncStage\" = '${CalendarChannelSyncStage.CALENDAR_EVENTS_IMPORT_SCHEDULED}' WHERE \"isSyncEnabled\" = true AND \"syncStage\" = '${CalendarChannelSyncStage.CALENDAR_EVENTS_IMPORT_PENDING}' RETURNING *`,\n+          `UPDATE ${schemaName}.\"calendarChannel\" SET \"syncStage\" = '${CalendarChannelSyncStage.CALENDAR_EVENTS_IMPORT_SCHEDULED}', \"syncStageStartedAt\" = '${now}'\n+           WHERE \"isSyncEnabled\" = true AND \"syncStage\" = '${CalendarChannelSyncStage.CALENDAR_EVENTS_IMPORT_PENDING}' RETURNING *`,\n         );\n \n         for (const calendarChannel of calendarChannels) {\ndiff --git a/packages/twenty-server/src/modules/messaging/common/services/message-channel-sync-status.service.ts b/packages/twenty-server/src/modules/messaging/common/services/message-channel-sync-status.service.ts\nindex 9484e8ddc0138..fbfa95484de71 100644\n--- a/packages/twenty-server/src/modules/messaging/common/services/message-channel-sync-status.service.ts\n+++ b/packages/twenty-server/src/modules/messaging/common/services/message-channel-sync-status.service.ts\n@@ -133,6 +133,27 @@ export class MessageChannelSyncStatusService {\n     });\n   }\n \n+  public async markAsMessagesListFetchScheduled(\n+    messageChannelIds: string[],\n+    workspaceId: string,\n+  ) {\n+    if (!messageChannelIds.length) {\n+      return;\n+    }\n+\n+    const messageChannelRepository =\n+      await this.twentyORMGlobalManager.getRepositoryForWorkspace<MessageChannelWorkspaceEntity>(\n+        workspaceId,\n+        'messageChannel',\n+      );\n+\n+    await messageChannelRepository.update(messageChannelIds, {\n+      syncStage: MessageChannelSyncStage.MESSAGE_LIST_FETCH_SCHEDULED,\n+      syncStatus: MessageChannelSyncStatus.ONGOING,\n+      syncStageStartedAt: new Date().toISOString(),\n+    });\n+  }\n+\n   public async markAsMessagesListFetchOngoing(\n     messageChannelIds: string[],\n     workspaceId: string,\n@@ -150,7 +171,6 @@ export class MessageChannelSyncStatusService {\n     await messageChannelRepository.update(messageChannelIds, {\n       syncStage: MessageChannelSyncStage.MESSAGE_LIST_FETCH_ONGOING,\n       syncStatus: MessageChannelSyncStatus.ONGOING,\n-      syncStageStartedAt: new Date().toISOString(),\n     });\n   }\n \n@@ -182,6 +202,25 @@ export class MessageChannelSyncStatusService {\n     });\n   }\n \n+  public async markAsMessagesImportScheduled(\n+    messageChannelIds: string[],\n+    workspaceId: string,\n+  ) {\n+    if (!messageChannelIds.length) {\n+      return;\n+    }\n+\n+    const messageChannelRepository =\n+      await this.twentyORMGlobalManager.getRepositoryForWorkspace<MessageChannelWorkspaceEntity>(\n+        workspaceId,\n+        'messageChannel',\n+      );\n+\n+    await messageChannelRepository.update(messageChannelIds, {\n+      syncStage: MessageChannelSyncStage.MESSAGES_IMPORT_SCHEDULED,\n+    });\n+  }\n+\n   public async markAsMessagesImportOngoing(\n     messageChannelIds: string[],\n     workspaceId: string,\ndiff --git a/packages/twenty-server/src/modules/messaging/message-import-manager/crons/jobs/messaging-message-list-fetch.cron.job.ts b/packages/twenty-server/src/modules/messaging/message-import-manager/crons/jobs/messaging-message-list-fetch.cron.job.ts\nindex e51101b553a37..7e9508919e1a6 100644\n--- a/packages/twenty-server/src/modules/messaging/message-import-manager/crons/jobs/messaging-message-list-fetch.cron.job.ts\n+++ b/packages/twenty-server/src/modules/messaging/message-import-manager/crons/jobs/messaging-message-list-fetch.cron.job.ts\n@@ -48,8 +48,11 @@ export class MessagingMessageListFetchCronJob {\n       try {\n         const schemaName = getWorkspaceSchemaName(activeWorkspace.id);\n \n+        const now = new Date().toISOString();\n+\n         const [messageChannels] = await this.coreDataSource.query(\n-          `UPDATE ${schemaName}.\"messageChannel\" SET \"syncStage\" = '${MessageChannelSyncStage.MESSAGE_LIST_FETCH_SCHEDULED}' WHERE \"isSyncEnabled\" = true AND \"syncStage\" = '${MessageChannelSyncStage.MESSAGE_LIST_FETCH_PENDING}' RETURNING *`,\n+          `UPDATE ${schemaName}.\"messageChannel\" SET \"syncStage\" = '${MessageChannelSyncStage.MESSAGE_LIST_FETCH_SCHEDULED}', \"syncStageStartedAt\" = '${now}'\n+           WHERE \"isSyncEnabled\" = true AND \"syncStage\" = '${MessageChannelSyncStage.MESSAGE_LIST_FETCH_PENDING}' RETURNING *`,\n         );\n \n         for (const messageChannel of messageChannels) {\ndiff --git a/packages/twenty-server/src/modules/messaging/message-import-manager/crons/jobs/messaging-messages-import.cron.job.ts b/packages/twenty-server/src/modules/messaging/message-import-manager/crons/jobs/messaging-messages-import.cron.job.ts\nindex 091197e4ffd45..9397b37e473a5 100644\n--- a/packages/twenty-server/src/modules/messaging/message-import-manager/crons/jobs/messaging-messages-import.cron.job.ts\n+++ b/packages/twenty-server/src/modules/messaging/message-import-manager/crons/jobs/messaging-messages-import.cron.job.ts\n@@ -53,8 +53,11 @@ export class MessagingMessagesImportCronJob {\n       try {\n         const schemaName = getWorkspaceSchemaName(activeWorkspace.id);\n \n+        const now = new Date().toISOString();\n+\n         const [messageChannels] = await this.coreDataSource.query(\n-          `UPDATE ${schemaName}.\"messageChannel\" SET \"syncStage\" = '${MessageChannelSyncStage.MESSAGES_IMPORT_SCHEDULED}' WHERE \"isSyncEnabled\" = true AND \"syncStage\" = '${MessageChannelSyncStage.MESSAGES_IMPORT_PENDING}' RETURNING *`,\n+          `UPDATE ${schemaName}.\"messageChannel\" SET \"syncStage\" = '${MessageChannelSyncStage.MESSAGES_IMPORT_SCHEDULED}', \"syncStageStartedAt\" = '${now}'\n+          WHERE \"isSyncEnabled\" = true AND \"syncStage\" = '${MessageChannelSyncStage.MESSAGES_IMPORT_PENDING}' RETURNING *`,\n         );\n \n         for (const messageChannel of messageChannels) {\ndiff --git a/packages/twenty-server/src/modules/messaging/message-import-manager/services/__tests__/messaging-message-list-fetch.service.spec.ts b/packages/twenty-server/src/modules/messaging/message-import-manager/services/__tests__/messaging-message-list-fetch.service.spec.ts\nindex 1f24fbd578465..ec045ba16c386 100644\n--- a/packages/twenty-server/src/modules/messaging/message-import-manager/services/__tests__/messaging-message-list-fetch.service.spec.ts\n+++ b/packages/twenty-server/src/modules/messaging/message-import-manager/services/__tests__/messaging-message-list-fetch.service.spec.ts\n@@ -291,7 +291,7 @@ describe('MessagingMessageListFetchService', () => {\n     });\n     expect(\n       messageChannelSyncStatusService.markAsMessagesListFetchOngoing,\n-    ).toHaveBeenCalledWith([mockMicrosoftMessageChannel.id]);\n+    ).toHaveBeenCalledWith([mockMicrosoftMessageChannel.id], workspaceId);\n \n     expect(messagingGetMessageListService.getMessageLists).toHaveBeenCalledWith(\n       {\n@@ -332,7 +332,7 @@ describe('MessagingMessageListFetchService', () => {\n \n     expect(\n       messageChannelSyncStatusService.scheduleMessagesImport,\n-    ).toHaveBeenCalledWith([mockMicrosoftMessageChannel.id]);\n+    ).toHaveBeenCalledWith([mockMicrosoftMessageChannel.id], workspaceId);\n   });\n \n   it('should process Google message list fetch correctly', async () => {\n@@ -350,7 +350,7 @@ describe('MessagingMessageListFetchService', () => {\n     });\n     expect(\n       messageChannelSyncStatusService.markAsMessagesListFetchOngoing,\n-    ).toHaveBeenCalledWith([mockGoogleMessageChannel.id]);\n+    ).toHaveBeenCalledWith([mockGoogleMessageChannel.id], workspaceId);\n \n     expect(messagingGetMessageListService.getMessageLists).toHaveBeenCalledWith(\n       {\n@@ -391,6 +391,6 @@ describe('MessagingMessageListFetchService', () => {\n \n     expect(\n       messageChannelSyncStatusService.scheduleMessagesImport,\n-    ).toHaveBeenCalledWith([mockGoogleMessageChannel.id]);\n+    ).toHaveBeenCalledWith([mockGoogleMessageChannel.id], workspaceId);\n   });\n });\ndiff --git a/packages/twenty-server/src/modules/messaging/message-import-manager/services/__tests__/messaging-messages-import.service.spec.ts b/packages/twenty-server/src/modules/messaging/message-import-manager/services/__tests__/messaging-messages-import.service.spec.ts\nindex f11d03923f6c2..f4e7cba4f730a 100644\n--- a/packages/twenty-server/src/modules/messaging/message-import-manager/services/__tests__/messaging-messages-import.service.spec.ts\n+++ b/packages/twenty-server/src/modules/messaging/message-import-manager/services/__tests__/messaging-messages-import.service.spec.ts\n@@ -213,7 +213,7 @@ describe('MessagingMessagesImportService', () => {\n     );\n     expect(\n       messageChannelSyncStatusService.markAsMessagesImportOngoing,\n-    ).toHaveBeenCalledWith([mockMessageChannel.id]);\n+    ).toHaveBeenCalledWith([mockMessageChannel.id], workspaceId);\n \n     expect(\n       connectedAccountRefreshTokensService.refreshAndSaveTokens,\n",
        "pr_mirror": "twentyhq__twenty.main"
    }
}