{
    "cost": 0.452985,
    "rewrites": {
        "twentyhq__twenty.main/packages/twenty-server/src/engine/core-modules/twenty-config/config-variables.ts": {
            "output": "import { type LogLevel, Logger } from '@nestjs/common';\n\nimport { plainToClass } from 'class-transformer';\nimport {\n  IsDefined,\n  IsOptional,\n  IsUrl,\n  ValidateIf,\n  type ValidationError,\n  validateSync,\n} from 'class-validator';\nimport { isDefined } from 'twenty-shared/utils';\n\nimport { AwsRegion } from 'src/engine/core-modules/twenty-config/interfaces/aws-region.interface';\nimport { NodeEnvironment } from 'src/engine/core-modules/twenty-config/interfaces/node-environment.interface';\nimport { SupportDriver } from 'src/engine/core-modules/twenty-config/interfaces/support.interface';\n\nimport { CaptchaDriverType } from 'src/engine/core-modules/captcha/interfaces';\nimport { EmailDriver } from 'src/engine/core-modules/email/enums/email-driver.enum';\nimport { ExceptionHandlerDriver } from 'src/engine/core-modules/exception-handler/interfaces';\nimport { StorageDriverType } from 'src/engine/core-modules/file-storage/interfaces';\nimport { LoggerDriverType } from 'src/engine/core-modules/logger/interfaces';\nimport { type MeterDriver } from 'src/engine/core-modules/metrics/types/meter-driver.type';\nimport { ServerlessDriverType } from 'src/engine/core-modules/serverless/serverless.interface';\nimport { CastToLogLevelArray } from 'src/engine/core-modules/twenty-config/decorators/cast-to-log-level-array.decorator';\nimport { CastToMeterDriverArray } from 'src/engine/core-modules/twenty-config/decorators/cast-to-meter-driver.decorator';\nimport { CastToPositiveNumber } from 'src/engine/core-modules/twenty-config/decorators/cast-to-positive-number.decorator';\nimport { CastToUpperSnakeCase } from 'src/engine/core-modules/twenty-config/decorators/cast-to-upper-snake-case.decorator';\nimport { ConfigVariablesMetadata } from 'src/engine/core-modules/twenty-config/decorators/config-variables-metadata.decorator';\nimport { IsAWSRegion } from 'src/engine/core-modules/twenty-config/decorators/is-aws-region.decorator';\nimport { IsDuration } from 'src/engine/core-modules/twenty-config/decorators/is-duration.decorator';\nimport { IsOptionalOrEmptyString } from 'src/engine/core-modules/twenty-config/decorators/is-optional-or-empty-string.decorator';\nimport { IsStrictlyLowerThan } from 'src/engine/core-modules/twenty-config/decorators/is-strictly-lower-than.decorator';\nimport { IsTwentySemVer } from 'src/engine/core-modules/twenty-config/decorators/is-twenty-semver.decorator';\nimport { ConfigVariableType } from 'src/engine/core-modules/twenty-config/enums/config-variable-type.enum';\nimport { ConfigVariablesGroup } from 'src/engine/core-modules/twenty-config/enums/config-variables-group.enum';\nimport {\n  ConfigVariableException,\n  ConfigVariableExceptionCode,\n} from 'src/engine/core-modules/twenty-config/twenty-config.exception';\n\nexport class ConfigVariables {\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.OTHER,\n    description: 'Enable or disable password authentication for users',\n    type: ConfigVariableType.BOOLEAN,\n  })\n  @IsOptional()\n  AUTH_PASSWORD_ENABLED = true;\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.OTHER,\n    description:\n      'Prefills tim@apple.dev in the login form, used in local development for quicker sign-in',\n    type: ConfigVariableType.BOOLEAN,\n  })\n  @IsOptional()\n  @ValidateIf((env) => env.AUTH_PASSWORD_ENABLED)\n  SIGN_IN_PREFILLED = false;\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.OTHER,\n    description: 'Require email verification for user accounts',\n    type: ConfigVariableType.BOOLEAN,\n  })\n  @IsOptional()\n  IS_EMAIL_VERIFICATION_REQUIRED = false;\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.OTHER,\n    description:\n      'Enable safe mode for HTTP requests (prevents private IPs and other security risks)',\n    type: ConfigVariableType.BOOLEAN,\n  })\n  @IsOptional()\n  HTTP_TOOL_SAFE_MODE_ENABLED = true;\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.TOKENS_DURATION,\n    description: 'Duration for which the email verification token is valid',\n    type: ConfigVariableType.STRING,\n  })\n  @IsDuration()\n  @IsOptional()\n  EMAIL_VERIFICATION_TOKEN_EXPIRES_IN = '1h';\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.TOKENS_DURATION,\n    description: 'Duration for which the password reset token is valid',\n    type: ConfigVariableType.STRING,\n  })\n  @IsDuration()\n  @IsOptional()\n  PASSWORD_RESET_TOKEN_EXPIRES_IN = '5m';\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.GOOGLE_AUTH,\n    description: 'Enable or disable the Google Calendar integration',\n    type: ConfigVariableType.BOOLEAN,\n  })\n  CALENDAR_PROVIDER_GOOGLE_ENABLED = false;\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.GOOGLE_AUTH,\n    description: 'Callback URL for Google Auth APIs',\n    type: ConfigVariableType.STRING,\n    isSensitive: false,\n  })\n  AUTH_GOOGLE_APIS_CALLBACK_URL: string;\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.GOOGLE_AUTH,\n    description: 'Enable or disable Google Single Sign-On (SSO)',\n    type: ConfigVariableType.BOOLEAN,\n  })\n  @IsOptional()\n  AUTH_GOOGLE_ENABLED = false;\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.GOOGLE_AUTH,\n    isSensitive: false,\n    description: 'Client ID for Google authentication',\n    type: ConfigVariableType.STRING,\n  })\n  @ValidateIf((env) => env.AUTH_GOOGLE_ENABLED)\n  AUTH_GOOGLE_CLIENT_ID: string;\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.GOOGLE_AUTH,\n    isSensitive: true,\n    description: 'Client secret for Google authentication',\n    type: ConfigVariableType.STRING,\n  })\n  @ValidateIf((env) => env.AUTH_GOOGLE_ENABLED)\n  AUTH_GOOGLE_CLIENT_SECRET: string;\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.GOOGLE_AUTH,\n    isSensitive: false,\n    description: 'Callback URL for Google authentication',\n    type: ConfigVariableType.STRING,\n  })\n  @IsUrl({ require_tld: false, require_protocol: true })\n  @ValidateIf((env) => env.AUTH_GOOGLE_ENABLED)\n  AUTH_GOOGLE_CALLBACK_URL: string;\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.GOOGLE_AUTH,\n    description: 'Enable or disable the Gmail messaging integration',\n    type: ConfigVariableType.BOOLEAN,\n  })\n  MESSAGING_PROVIDER_GMAIL_ENABLED = false;\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.OTHER,\n    description: 'Enable or disable the IMAP messaging integration',\n    type: ConfigVariableType.BOOLEAN,\n  })\n  IS_IMAP_SMTP_CALDAV_ENABLED = false;\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.MICROSOFT_AUTH,\n    description: 'Enable or disable Microsoft authentication',\n    type: ConfigVariableType.BOOLEAN,\n  })\n  @IsOptional()\n  AUTH_MICROSOFT_ENABLED = false;\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.MICROSOFT_AUTH,\n    isSensitive: false,\n    description: 'Client ID for Microsoft authentication',\n    type: ConfigVariableType.STRING,\n  })\n  @ValidateIf((env) => env.AUTH_MICROSOFT_ENABLED)\n  AUTH_MICROSOFT_CLIENT_ID: string;\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.MICROSOFT_AUTH,\n    isSensitive: true,\n    description: 'Client secret for Microsoft authentication',\n    type: ConfigVariableType.STRING,\n  })\n  @ValidateIf((env) => env.AUTH_MICROSOFT_ENABLED)\n  AUTH_MICROSOFT_CLIENT_SECRET: string;\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.MICROSOFT_AUTH,\n    isSensitive: false,\n    description: 'Callback URL for Microsoft authentication',\n    type: ConfigVariableType.STRING,\n  })\n  @IsUrl({ require_tld: false, require_protocol: true })\n  @ValidateIf((env) => env.AUTH_MICROSOFT_ENABLED)\n  AUTH_MICROSOFT_CALLBACK_URL: string;\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.MICROSOFT_AUTH,\n    isSensitive: false,\n    description: 'Callback URL for Microsoft APIs',\n    type: ConfigVariableType.STRING,\n  })\n  @IsUrl({ require_tld: false, require_protocol: true })\n  @ValidateIf((env) => env.AUTH_MICROSOFT_ENABLED)\n  AUTH_MICROSOFT_APIS_CALLBACK_URL: string;\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.MICROSOFT_AUTH,\n    description: 'Enable or disable the Microsoft messaging integration',\n    type: ConfigVariableType.BOOLEAN,\n  })\n  MESSAGING_PROVIDER_MICROSOFT_ENABLED = false;\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.MICROSOFT_AUTH,\n    description: 'Enable or disable the Microsoft Calendar integration',\n    type: ConfigVariableType.BOOLEAN,\n  })\n  CALENDAR_PROVIDER_MICROSOFT_ENABLED = false;\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.OTHER,\n    isSensitive: true,\n    description:\n      'Legacy variable to be deprecated when all API Keys expire. Replaced by APP_KEY',\n    type: ConfigVariableType.STRING,\n    isEnvOnly: true,\n  })\n  @IsOptional()\n  ACCESS_TOKEN_SECRET: string;\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.TOKENS_DURATION,\n    description: 'Duration for which the access token is valid',\n    type: ConfigVariableType.STRING,\n  })\n  @IsDuration()\n  @IsOptional()\n  ACCESS_TOKEN_EXPIRES_IN = '30m';\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.TOKENS_DURATION,\n    description: 'Duration for which the workspace agnostic token is valid',\n    type: ConfigVariableType.STRING,\n  })\n  @IsDuration()\n  @IsOptional()\n  WORKSPACE_AGNOSTIC_TOKEN_EXPIRES_IN = '30m';\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.TOKENS_DURATION,\n    description: 'Duration for which the refresh token is valid',\n    type: ConfigVariableType.STRING,\n  })\n  @IsOptional()\n  REFRESH_TOKEN_EXPIRES_IN = '60d';\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.TOKENS_DURATION,\n    description: 'Cooldown period for refreshing tokens',\n    type: ConfigVariableType.STRING,\n  })\n  @IsDuration()\n  @IsOptional()\n  REFRESH_TOKEN_COOL_DOWN = '1m';\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.TOKENS_DURATION,\n    description: 'Duration for which the login token is valid',\n    type: ConfigVariableType.STRING,\n  })\n  @IsDuration()\n  @IsOptional()\n  LOGIN_TOKEN_EXPIRES_IN = '15m';\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.TOKENS_DURATION,\n    description: 'Duration for which the file token is valid',\n    type: ConfigVariableType.STRING,\n  })\n  @IsDuration()\n  @IsOptional()\n  FILE_TOKEN_EXPIRES_IN = '1d';\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.TOKENS_DURATION,\n    description: 'Duration for which the invitation token is valid',\n    type: ConfigVariableType.STRING,\n  })\n  @IsDuration()\n  @IsOptional()\n  INVITATION_TOKEN_EXPIRES_IN = '30d';\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.TOKENS_DURATION,\n    description: 'Duration for which the short-term token is valid',\n    type: ConfigVariableType.STRING,\n  })\n  SHORT_TERM_TOKEN_EXPIRES_IN = '5m';\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.EMAIL_SETTINGS,\n    description: 'Email address used as the sender for outgoing emails',\n    type: ConfigVariableType.STRING,\n  })\n  EMAIL_FROM_ADDRESS = 'noreply@yourdomain.com';\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.EMAIL_SETTINGS,\n    description: 'Email address used for system notifications',\n    type: ConfigVariableType.STRING,\n  })\n  EMAIL_SYSTEM_ADDRESS = 'system@yourdomain.com';\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.EMAIL_SETTINGS,\n    description: 'Name used in the From header for outgoing emails',\n    type: ConfigVariableType.STRING,\n  })\n  EMAIL_FROM_NAME = 'Felix from Twenty';\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.EMAIL_SETTINGS,\n    description: 'Email driver to use for sending emails',\n    type: ConfigVariableType.ENUM,\n    options: Object.values(EmailDriver),\n  })\n  @CastToUpperSnakeCase()\n  EMAIL_DRIVER: EmailDriver = EmailDriver.LOGGER;\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.EMAIL_SETTINGS,\n    description: 'SMTP host for sending emails',\n    type: ConfigVariableType.STRING,\n  })\n  EMAIL_SMTP_HOST: string;\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.EMAIL_SETTINGS,\n    description: 'Use unsecure connection for SMTP',\n    type: ConfigVariableType.BOOLEAN,\n  })\n  @IsOptional()\n  EMAIL_SMTP_NO_TLS = false;\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.EMAIL_SETTINGS,\n    description: 'SMTP port for sending emails',\n    type: ConfigVariableType.NUMBER,\n  })\n  @CastToPositiveNumber()\n  EMAIL_SMTP_PORT = 587;\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.EMAIL_SETTINGS,\n    description: 'SMTP user for authentication',\n    type: ConfigVariableType.STRING,\n    isSensitive: true,\n  })\n  EMAIL_SMTP_USER: string;\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.EMAIL_SETTINGS,\n    isSensitive: true,\n    description: 'SMTP password for authentication',\n    type: ConfigVariableType.STRING,\n  })",
            "output_extracted": "import { type LogLevel, Logger } from '@nestjs/common';\n\nimport { plainToClass } from 'class-transformer';\nimport {\n  IsDefined,\n  IsOptional,\n  IsUrl,\n  ValidateIf,\n  type ValidationError,\n  validateSync,\n} from 'class-validator';\nimport { isDefined } from 'twenty-shared/utils';\n\nimport { AwsRegion } from 'src/engine/core-modules/twenty-config/interfaces/aws-region.interface';\nimport { NodeEnvironment } from 'src/engine/core-modules/twenty-config/interfaces/node-environment.interface';\nimport { SupportDriver } from 'src/engine/core-modules/twenty-config/interfaces/support.interface';\n\nimport { CaptchaDriverType } from 'src/engine/core-modules/captcha/interfaces';\nimport { EmailDriver } from 'src/engine/core-modules/email/enums/email-driver.enum';\nimport { ExceptionHandlerDriver } from 'src/engine/core-modules/exception-handler/interfaces';\nimport { StorageDriverType } from 'src/engine/core-modules/file-storage/interfaces';\nimport { LoggerDriverType } from 'src/engine/core-modules/logger/interfaces';\nimport { type MeterDriver } from 'src/engine/core-modules/metrics/types/meter-driver.type';\nimport { ServerlessDriverType } from 'src/engine/core-modules/serverless/serverless.interface';\nimport { CastToLogLevelArray } from 'src/engine/core-modules/twenty-config/decorators/cast-to-log-level-array.decorator';\nimport { CastToMeterDriverArray } from 'src/engine/core-modules/twenty-config/decorators/cast-to-meter-driver.decorator';\nimport { CastToPositiveNumber } from 'src/engine/core-modules/twenty-config/decorators/cast-to-positive-number.decorator';\nimport { CastToUpperSnakeCase } from 'src/engine/core-modules/twenty-config/decorators/cast-to-upper-snake-case.decorator';\nimport { ConfigVariablesMetadata } from 'src/engine/core-modules/twenty-config/decorators/config-variables-metadata.decorator';\nimport { IsAWSRegion } from 'src/engine/core-modules/twenty-config/decorators/is-aws-region.decorator';\nimport { IsDuration } from 'src/engine/core-modules/twenty-config/decorators/is-duration.decorator';\nimport { IsOptionalOrEmptyString } from 'src/engine/core-modules/twenty-config/decorators/is-optional-or-empty-string.decorator';\nimport { IsStrictlyLowerThan } from 'src/engine/core-modules/twenty-config/decorators/is-strictly-lower-than.decorator';\nimport { IsTwentySemVer } from 'src/engine/core-modules/twenty-config/decorators/is-twenty-semver.decorator';\nimport { ConfigVariableType } from 'src/engine/core-modules/twenty-config/enums/config-variable-type.enum';\nimport { ConfigVariablesGroup } from 'src/engine/core-modules/twenty-config/enums/config-variables-group.enum';\nimport {\n  ConfigVariableException,\n  ConfigVariableExceptionCode,\n} from 'src/engine/core-modules/twenty-config/twenty-config.exception';\n\nexport class ConfigVariables {\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.OTHER,\n    description: 'Enable or disable password authentication for users',\n    type: ConfigVariableType.BOOLEAN,\n  })\n  @IsOptional()\n  AUTH_PASSWORD_ENABLED = true;\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.OTHER,\n    description:\n      'Prefills tim@apple.dev in the login form, used in local development for quicker sign-in',\n    type: ConfigVariableType.BOOLEAN,\n  })\n  @IsOptional()\n  @ValidateIf((env) => env.AUTH_PASSWORD_ENABLED)\n  SIGN_IN_PREFILLED = false;\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.OTHER,\n    description: 'Require email verification for user accounts',\n    type: ConfigVariableType.BOOLEAN,\n  })\n  @IsOptional()\n  IS_EMAIL_VERIFICATION_REQUIRED = false;\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.OTHER,\n    description:\n      'Enable safe mode for HTTP requests (prevents private IPs and other security risks)',\n    type: ConfigVariableType.BOOLEAN,\n  })\n  @IsOptional()\n  HTTP_TOOL_SAFE_MODE_ENABLED = true;\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.TOKENS_DURATION,\n    description: 'Duration for which the email verification token is valid',\n    type: ConfigVariableType.STRING,\n  })\n  @IsDuration()\n  @IsOptional()\n  EMAIL_VERIFICATION_TOKEN_EXPIRES_IN = '1h';\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.TOKENS_DURATION,\n    description: 'Duration for which the password reset token is valid',\n    type: ConfigVariableType.STRING,\n  })\n  @IsDuration()\n  @IsOptional()\n  PASSWORD_RESET_TOKEN_EXPIRES_IN = '5m';\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.GOOGLE_AUTH,\n    description: 'Enable or disable the Google Calendar integration',\n    type: ConfigVariableType.BOOLEAN,\n  })\n  CALENDAR_PROVIDER_GOOGLE_ENABLED = false;\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.GOOGLE_AUTH,\n    description: 'Callback URL for Google Auth APIs',\n    type: ConfigVariableType.STRING,\n    isSensitive: false,\n  })\n  AUTH_GOOGLE_APIS_CALLBACK_URL: string;\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.GOOGLE_AUTH,\n    description: 'Enable or disable Google Single Sign-On (SSO)',\n    type: ConfigVariableType.BOOLEAN,\n  })\n  @IsOptional()\n  AUTH_GOOGLE_ENABLED = false;\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.GOOGLE_AUTH,\n    isSensitive: false,\n    description: 'Client ID for Google authentication',\n    type: ConfigVariableType.STRING,\n  })\n  @ValidateIf((env) => env.AUTH_GOOGLE_ENABLED)\n  AUTH_GOOGLE_CLIENT_ID: string;\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.GOOGLE_AUTH,\n    isSensitive: true,\n    description: 'Client secret for Google authentication',\n    type: ConfigVariableType.STRING,\n  })\n  @ValidateIf((env) => env.AUTH_GOOGLE_ENABLED)\n  AUTH_GOOGLE_CLIENT_SECRET: string;\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.GOOGLE_AUTH,\n    isSensitive: false,\n    description: 'Callback URL for Google authentication',\n    type: ConfigVariableType.STRING,\n  })\n  @IsUrl({ require_tld: false, require_protocol: true })\n  @ValidateIf((env) => env.AUTH_GOOGLE_ENABLED)\n  AUTH_GOOGLE_CALLBACK_URL: string;\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.GOOGLE_AUTH,\n    description: 'Enable or disable the Gmail messaging integration',\n    type: ConfigVariableType.BOOLEAN,\n  })\n  MESSAGING_PROVIDER_GMAIL_ENABLED = false;\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.OTHER,\n    description: 'Enable or disable the IMAP messaging integration',\n    type: ConfigVariableType.BOOLEAN,\n  })\n  IS_IMAP_SMTP_CALDAV_ENABLED = false;\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.MICROSOFT_AUTH,\n    description: 'Enable or disable Microsoft authentication',\n    type: ConfigVariableType.BOOLEAN,\n  })\n  @IsOptional()\n  AUTH_MICROSOFT_ENABLED = false;\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.MICROSOFT_AUTH,\n    isSensitive: false,\n    description: 'Client ID for Microsoft authentication',\n    type: ConfigVariableType.STRING,\n  })\n  @ValidateIf((env) => env.AUTH_MICROSOFT_ENABLED)\n  AUTH_MICROSOFT_CLIENT_ID: string;\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.MICROSOFT_AUTH,\n    isSensitive: true,\n    description: 'Client secret for Microsoft authentication',\n    type: ConfigVariableType.STRING,\n  })\n  @ValidateIf((env) => env.AUTH_MICROSOFT_ENABLED)\n  AUTH_MICROSOFT_CLIENT_SECRET: string;\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.MICROSOFT_AUTH,\n    isSensitive: false,\n    description: 'Callback URL for Microsoft authentication',\n    type: ConfigVariableType.STRING,\n  })\n  @IsUrl({ require_tld: false, require_protocol: true })\n  @ValidateIf((env) => env.AUTH_MICROSOFT_ENABLED)\n  AUTH_MICROSOFT_CALLBACK_URL: string;\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.MICROSOFT_AUTH,\n    isSensitive: false,\n    description: 'Callback URL for Microsoft APIs',\n    type: ConfigVariableType.STRING,\n  })\n  @IsUrl({ require_tld: false, require_protocol: true })\n  @ValidateIf((env) => env.AUTH_MICROSOFT_ENABLED)\n  AUTH_MICROSOFT_APIS_CALLBACK_URL: string;\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.MICROSOFT_AUTH,\n    description: 'Enable or disable the Microsoft messaging integration',\n    type: ConfigVariableType.BOOLEAN,\n  })\n  MESSAGING_PROVIDER_MICROSOFT_ENABLED = false;\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.MICROSOFT_AUTH,\n    description: 'Enable or disable the Microsoft Calendar integration',\n    type: ConfigVariableType.BOOLEAN,\n  })\n  CALENDAR_PROVIDER_MICROSOFT_ENABLED = false;\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.OTHER,\n    isSensitive: true,\n    description:\n      'Legacy variable to be deprecated when all API Keys expire. Replaced by APP_KEY',\n    type: ConfigVariableType.STRING,\n    isEnvOnly: true,\n  })\n  @IsOptional()\n  ACCESS_TOKEN_SECRET: string;\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.TOKENS_DURATION,\n    description: 'Duration for which the access token is valid',\n    type: ConfigVariableType.STRING,\n  })\n  @IsDuration()\n  @IsOptional()\n  ACCESS_TOKEN_EXPIRES_IN = '30m';\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.TOKENS_DURATION,\n    description: 'Duration for which the workspace agnostic token is valid',\n    type: ConfigVariableType.STRING,\n  })\n  @IsDuration()\n  @IsOptional()\n  WORKSPACE_AGNOSTIC_TOKEN_EXPIRES_IN = '30m';\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.TOKENS_DURATION,\n    description: 'Duration for which the refresh token is valid',\n    type: ConfigVariableType.STRING,\n  })\n  @IsOptional()\n  REFRESH_TOKEN_EXPIRES_IN = '60d';\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.TOKENS_DURATION,\n    description: 'Cooldown period for refreshing tokens',\n    type: ConfigVariableType.STRING,\n  })\n  @IsDuration()\n  @IsOptional()\n  REFRESH_TOKEN_COOL_DOWN = '1m';\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.TOKENS_DURATION,\n    description: 'Duration for which the login token is valid',\n    type: ConfigVariableType.STRING,\n  })\n  @IsDuration()\n  @IsOptional()\n  LOGIN_TOKEN_EXPIRES_IN = '15m';\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.TOKENS_DURATION,\n    description: 'Duration for which the file token is valid',\n    type: ConfigVariableType.STRING,\n  })\n  @IsDuration()\n  @IsOptional()\n  FILE_TOKEN_EXPIRES_IN = '1d';\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.TOKENS_DURATION,\n    description: 'Duration for which the invitation token is valid',\n    type: ConfigVariableType.STRING,\n  })\n  @IsDuration()\n  @IsOptional()\n  INVITATION_TOKEN_EXPIRES_IN = '30d';\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.TOKENS_DURATION,\n    description: 'Duration for which the short-term token is valid',\n    type: ConfigVariableType.STRING,\n  })\n  SHORT_TERM_TOKEN_EXPIRES_IN = '5m';\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.EMAIL_SETTINGS,\n    description: 'Email address used as the sender for outgoing emails',\n    type: ConfigVariableType.STRING,\n  })\n  EMAIL_FROM_ADDRESS = 'noreply@yourdomain.com';\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.EMAIL_SETTINGS,\n    description: 'Email address used for system notifications',\n    type: ConfigVariableType.STRING,\n  })\n  EMAIL_SYSTEM_ADDRESS = 'system@yourdomain.com';\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.EMAIL_SETTINGS,\n    description: 'Name used in the From header for outgoing emails',\n    type: ConfigVariableType.STRING,\n  })\n  EMAIL_FROM_NAME = 'Felix from Twenty';\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.EMAIL_SETTINGS,\n    description: 'Email driver to use for sending emails',\n    type: ConfigVariableType.ENUM,\n    options: Object.values(EmailDriver),\n  })\n  @CastToUpperSnakeCase()\n  EMAIL_DRIVER: EmailDriver = EmailDriver.LOGGER;\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.EMAIL_SETTINGS,\n    description: 'SMTP host for sending emails',\n    type: ConfigVariableType.STRING,\n  })\n  EMAIL_SMTP_HOST: string;\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.EMAIL_SETTINGS,\n    description: 'Use unsecure connection for SMTP',\n    type: ConfigVariableType.BOOLEAN,\n  })\n  @IsOptional()\n  EMAIL_SMTP_NO_TLS = false;\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.EMAIL_SETTINGS,\n    description: 'SMTP port for sending emails',\n    type: ConfigVariableType.NUMBER,\n  })\n  @CastToPositiveNumber()\n  EMAIL_SMTP_PORT = 587;\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.EMAIL_SETTINGS,\n    description: 'SMTP user for authentication',\n    type: ConfigVariableType.STRING,\n    isSensitive: true,\n  })\n  EMAIL_SMTP_USER: string;\n\n  @ConfigVariablesMetadata({\n    group: ConfigVariablesGroup.EMAIL_SETTINGS,\n    isSensitive: true,\n    description: 'SMTP password for authentication',\n    type: ConfigVariableType.STRING,\n  })",
            "cost": 0.186635
        },
        "twentyhq__twenty.main/packages/twenty-server/src/engine/core-modules/workspace-invitation/services/workspace-invitation.service.spec.ts": {
            "output": "import { Test, type TestingModule } from '@nestjs/testing';\nimport { getRepositoryToken } from '@nestjs/typeorm';\n\nimport { Repository } from 'typeorm';\n\nimport {\n  AppTokenEntity,\n  AppTokenType,\n} from 'src/engine/core-modules/app-token/app-token.entity';\nimport { WorkspaceDomainsService } from 'src/engine/core-modules/domain/workspace-domains/services/workspace-domains.service';\nimport { EmailService } from 'src/engine/core-modules/email/email.service';\nimport { FileService } from 'src/engine/core-modules/file/services/file.service';\nimport { I18nService } from 'src/engine/core-modules/i18n/i18n.service';\nimport { OnboardingService } from 'src/engine/core-modules/onboarding/onboarding.service';\nimport { TwentyConfigService } from 'src/engine/core-modules/twenty-config/twenty-config.service';\nimport { UserWorkspaceEntity } from 'src/engine/core-modules/user-workspace/user-workspace.entity';\nimport { WorkspaceInvitationException } from 'src/engine/core-modules/workspace-invitation/workspace-invitation.exception';\nimport { WorkspaceService } from 'src/engine/core-modules/workspace/services/workspace.service';\nimport { WorkspaceEntity } from 'src/engine/core-modules/workspace/workspace.entity';\nimport { type WorkspaceMemberWorkspaceEntity } from 'src/modules/workspace-member/standard-objects/workspace-member.workspace-entity';\n\nimport { WorkspaceInvitationService } from './workspace-invitation.service';\n\n// To fix a circular dependency issue\njest.mock('src/engine/core-modules/workspace/services/workspace.service');\n\n// To avoid dynamic import issues in Jest\njest.mock('@react-email/render', () => ({\n  render: jest.fn().mockImplementation(async (template, options) => {\n    if (options?.plainText) {\n      return 'Plain Text Email';\n    }\n\n    return '<html><body>HTML email content</body></html>';\n  }),\n}));\n\ndescribe('WorkspaceInvitationService', () => {\n  let service: WorkspaceInvitationService;\n  let appTokenRepository: Repository<AppTokenEntity>;\n  let userWorkspaceRepository: Repository<UserWorkspaceEntity>;\n  let twentyConfigService: TwentyConfigService;\n  let emailService: EmailService;\n  let onboardingService: OnboardingService;\n\n  beforeEach(async () => {\n    const module: TestingModule = await Test.createTestingModule({\n      providers: [\n        WorkspaceInvitationService,\n        {\n          provide: getRepositoryToken(AppTokenEntity),\n          useClass: Repository,\n        },\n        {\n          provide: getRepositoryToken(UserWorkspaceEntity),\n          useClass: Repository,\n        },\n        {\n          provide: getRepositoryToken(WorkspaceEntity),\n          useClass: Repository,\n        },\n        {\n          provide: WorkspaceDomainsService,\n          useValue: {\n            buildWorkspaceURL: jest\n              .fn()\n              .mockResolvedValue(new URL('http://localhost:3001')),\n          },\n        },\n        {\n          provide: TwentyConfigService,\n          useValue: {\n            get: jest.fn(),\n          },\n        },\n        {\n          provide: EmailService,\n          useValue: {\n            send: jest.fn(),\n          },\n        },\n        {\n          provide: OnboardingService,\n          useValue: {\n            setOnboardingInviteTeamPending: jest.fn(),\n            setOnboardingBookOnboardingPending: jest.fn(),\n          },\n        },\n        {\n          provide: WorkspaceService,\n          useValue: {\n            // Mock methods you expect WorkspaceInvitationService to call\n            getDefaultWorkspace: jest\n              .fn()\n              .mockResolvedValue({ id: 'default-workspace-id' }),\n            // Add other methods as needed\n          },\n        },\n        {\n          provide: I18nService,\n          useValue: {\n            getI18nInstance: jest.fn().mockReturnValue({\n              _: jest.fn().mockReturnValue('mocked-translation'),\n            }),\n          },\n        },\n        {\n          provide: FileService,\n          useValue: {\n            signFileUrl: jest\n              .fn()\n              .mockReturnValue('https://signed-url.com/logo.png'),\n          },\n        },\n      ],\n    }).compile();\n\n    service = module.get<WorkspaceInvitationService>(\n      WorkspaceInvitationService,\n    );\n    appTokenRepository = module.get<Repository<AppTokenEntity>>(\n      getRepositoryToken(AppTokenEntity),\n    );\n    userWorkspaceRepository = module.get<Repository<UserWorkspaceEntity>>(\n      getRepositoryToken(UserWorkspaceEntity),\n    );\n    twentyConfigService = module.get<TwentyConfigService>(TwentyConfigService);\n    emailService = module.get<EmailService>(EmailService);\n    onboardingService = module.get<OnboardingService>(OnboardingService);\n  });\n\n  it('should be defined', () => {\n    expect(service).toBeDefined();\n  });\n\n  describe('createWorkspaceInvitation', () => {\n    it('should create a workspace invitation successfully', async () => {\n      const email = 'test@example.com';\n      const workspace = { id: 'workspace-id' } as WorkspaceEntity;\n\n      jest.spyOn(appTokenRepository, 'createQueryBuilder').mockReturnValue({\n        where: jest.fn().mockReturnThis(),\n        andWhere: jest.fn().mockReturnThis(),\n        getOne: jest.fn().mockResolvedValue(null),\n      } as any);\n\n      jest.spyOn(userWorkspaceRepository, 'exists').mockResolvedValue(false);\n      jest\n        .spyOn(service, 'generateInvitationToken')\n        .mockResolvedValue({} as AppTokenEntity);\n\n      await expect(\n        service.createWorkspaceInvitation(email, workspace),\n      ).resolves.not.toThrow();\n    });\n\n    it('should throw an exception if invitation already exists', async () => {\n      const email = 'test@example.com';\n      const workspace = { id: 'workspace-id' } as WorkspaceEntity;\n\n      jest.spyOn(appTokenRepository, 'createQueryBuilder').mockReturnValue({\n        where: jest.fn().mockReturnThis(),\n        andWhere: jest.fn().mockReturnThis(),\n        getOne: jest.fn().mockResolvedValue({}),\n      } as any);\n\n      await expect(\n        service.createWorkspaceInvitation(email, workspace),\n      ).rejects.toThrow(WorkspaceInvitationException);\n    });\n  });\n\n  describe('sendInvitations', () => {\n    it('should send invitations successfully', async () => {\n      const emails = ['test1@example.com', 'test2@example.com'];\n      const workspace = {\n        id: 'workspace-id',\n        inviteHash: 'invite-hash',\n        displayName: 'Test Workspace',\n      } as WorkspaceEntity;\n      const sender = {\n        userEmail: 'sender@example.com',\n        name: { firstName: 'Sender' },\n        locale: 'en',\n      };\n\n      jest.spyOn(service, 'createWorkspaceInvitation').mockResolvedValue({\n        context: { email: 'test@example.com' },\n        value: 'token-value',\n        type: AppTokenType.InvitationToken,\n      } as AppTokenEntity);\n      jest\n        .spyOn(twentyConfigService, 'get')\n        .mockReturnValue('http://localhost:3000');\n      jest.spyOn(emailService, 'send').mockResolvedValue({} as any);\n      jest\n        .spyOn(onboardingService, 'setOnboardingInviteTeamPending')\n        .mockResolvedValue({} as any);\n\n      const result = await service.sendInvitations(\n        emails,\n        workspace,\n        sender as WorkspaceMemberWorkspaceEntity,\n      );\n\n      expect(result.success).toBe(true);\n      expect(result.result.length).toBe(2);\n      expect(emailService.send).toHaveBeenCalledTimes(2);\n      expect(\n        onboardingService.setOnboardingInviteTeamPending,\n      ).toHaveBeenCalledWith({\n        workspaceId: workspace.id,\n        value: false,\n      });\n      expect(\n        onboardingService.setOnboardingBookOnboardingPending,\n      ).toHaveBeenCalledWith({\n        workspaceId: workspace.id,\n        value: true,\n      });\n    });\n  });\n});",
            "output_extracted": "import { Test, type TestingModule } from '@nestjs/testing';\nimport { getRepositoryToken } from '@nestjs/typeorm';\n\nimport { Repository } from 'typeorm';\n\nimport {\n  AppTokenEntity,\n  AppTokenType,\n} from 'src/engine/core-modules/app-token/app-token.entity';\nimport { WorkspaceDomainsService } from 'src/engine/core-modules/domain/workspace-domains/services/workspace-domains.service';\nimport { EmailService } from 'src/engine/core-modules/email/email.service';\nimport { FileService } from 'src/engine/core-modules/file/services/file.service';\nimport { I18nService } from 'src/engine/core-modules/i18n/i18n.service';\nimport { OnboardingService } from 'src/engine/core-modules/onboarding/onboarding.service';\nimport { TwentyConfigService } from 'src/engine/core-modules/twenty-config/twenty-config.service';\nimport { UserWorkspaceEntity } from 'src/engine/core-modules/user-workspace/user-workspace.entity';\nimport { WorkspaceInvitationException } from 'src/engine/core-modules/workspace-invitation/workspace-invitation.exception';\nimport { WorkspaceService } from 'src/engine/core-modules/workspace/services/workspace.service';\nimport { WorkspaceEntity } from 'src/engine/core-modules/workspace/workspace.entity';\nimport { type WorkspaceMemberWorkspaceEntity } from 'src/modules/workspace-member/standard-objects/workspace-member.workspace-entity';\n\nimport { WorkspaceInvitationService } from './workspace-invitation.service';\n\n// To fix a circular dependency issue\njest.mock('src/engine/core-modules/workspace/services/workspace.service');\n\n// To avoid dynamic import issues in Jest\njest.mock('@react-email/render', () => ({\n  render: jest.fn().mockImplementation(async (template, options) => {\n    if (options?.plainText) {\n      return 'Plain Text Email';\n    }\n\n    return '<html><body>HTML email content</body></html>';\n  }),\n}));\n\ndescribe('WorkspaceInvitationService', () => {\n  let service: WorkspaceInvitationService;\n  let appTokenRepository: Repository<AppTokenEntity>;\n  let userWorkspaceRepository: Repository<UserWorkspaceEntity>;\n  let twentyConfigService: TwentyConfigService;\n  let emailService: EmailService;\n  let onboardingService: OnboardingService;\n\n  beforeEach(async () => {\n    const module: TestingModule = await Test.createTestingModule({\n      providers: [\n        WorkspaceInvitationService,\n        {\n          provide: getRepositoryToken(AppTokenEntity),\n          useClass: Repository,\n        },\n        {\n          provide: getRepositoryToken(UserWorkspaceEntity),\n          useClass: Repository,\n        },\n        {\n          provide: getRepositoryToken(WorkspaceEntity),\n          useClass: Repository,\n        },\n        {\n          provide: WorkspaceDomainsService,\n          useValue: {\n            buildWorkspaceURL: jest\n              .fn()\n              .mockResolvedValue(new URL('http://localhost:3001')),\n          },\n        },\n        {\n          provide: TwentyConfigService,\n          useValue: {\n            get: jest.fn(),\n          },\n        },\n        {\n          provide: EmailService,\n          useValue: {\n            send: jest.fn(),\n          },\n        },\n        {\n          provide: OnboardingService,\n          useValue: {\n            setOnboardingInviteTeamPending: jest.fn(),\n            setOnboardingBookOnboardingPending: jest.fn(),\n          },\n        },\n        {\n          provide: WorkspaceService,\n          useValue: {\n            // Mock methods you expect WorkspaceInvitationService to call\n            getDefaultWorkspace: jest\n              .fn()\n              .mockResolvedValue({ id: 'default-workspace-id' }),\n            // Add other methods as needed\n          },\n        },\n        {\n          provide: I18nService,\n          useValue: {\n            getI18nInstance: jest.fn().mockReturnValue({\n              _: jest.fn().mockReturnValue('mocked-translation'),\n            }),\n          },\n        },\n        {\n          provide: FileService,\n          useValue: {\n            signFileUrl: jest\n              .fn()\n              .mockReturnValue('https://signed-url.com/logo.png'),\n          },\n        },\n      ],\n    }).compile();\n\n    service = module.get<WorkspaceInvitationService>(\n      WorkspaceInvitationService,\n    );\n    appTokenRepository = module.get<Repository<AppTokenEntity>>(\n      getRepositoryToken(AppTokenEntity),\n    );\n    userWorkspaceRepository = module.get<Repository<UserWorkspaceEntity>>(\n      getRepositoryToken(UserWorkspaceEntity),\n    );\n    twentyConfigService = module.get<TwentyConfigService>(TwentyConfigService);\n    emailService = module.get<EmailService>(EmailService);\n    onboardingService = module.get<OnboardingService>(OnboardingService);\n  });\n\n  it('should be defined', () => {\n    expect(service).toBeDefined();\n  });\n\n  describe('createWorkspaceInvitation', () => {\n    it('should create a workspace invitation successfully', async () => {\n      const email = 'test@example.com';\n      const workspace = { id: 'workspace-id' } as WorkspaceEntity;\n\n      jest.spyOn(appTokenRepository, 'createQueryBuilder').mockReturnValue({\n        where: jest.fn().mockReturnThis(),\n        andWhere: jest.fn().mockReturnThis(),\n        getOne: jest.fn().mockResolvedValue(null),\n      } as any);\n\n      jest.spyOn(userWorkspaceRepository, 'exists').mockResolvedValue(false);\n      jest\n        .spyOn(service, 'generateInvitationToken')\n        .mockResolvedValue({} as AppTokenEntity);\n\n      await expect(\n        service.createWorkspaceInvitation(email, workspace),\n      ).resolves.not.toThrow();\n    });\n\n    it('should throw an exception if invitation already exists', async () => {\n      const email = 'test@example.com';\n      const workspace = { id: 'workspace-id' } as WorkspaceEntity;\n\n      jest.spyOn(appTokenRepository, 'createQueryBuilder').mockReturnValue({\n        where: jest.fn().mockReturnThis(),\n        andWhere: jest.fn().mockReturnThis(),\n        getOne: jest.fn().mockResolvedValue({}),\n      } as any);\n\n      await expect(\n        service.createWorkspaceInvitation(email, workspace),\n      ).rejects.toThrow(WorkspaceInvitationException);\n    });\n  });\n\n  describe('sendInvitations', () => {\n    it('should send invitations successfully', async () => {\n      const emails = ['test1@example.com', 'test2@example.com'];\n      const workspace = {\n        id: 'workspace-id',\n        inviteHash: 'invite-hash',\n        displayName: 'Test Workspace',\n      } as WorkspaceEntity;\n      const sender = {\n        userEmail: 'sender@example.com',\n        name: { firstName: 'Sender' },\n        locale: 'en',\n      };\n\n      jest.spyOn(service, 'createWorkspaceInvitation').mockResolvedValue({\n        context: { email: 'test@example.com' },\n        value: 'token-value',\n        type: AppTokenType.InvitationToken,\n      } as AppTokenEntity);\n      jest\n        .spyOn(twentyConfigService, 'get')\n        .mockReturnValue('http://localhost:3000');\n      jest.spyOn(emailService, 'send').mockResolvedValue({} as any);\n      jest\n        .spyOn(onboardingService, 'setOnboardingInviteTeamPending')\n        .mockResolvedValue({} as any);\n\n      const result = await service.sendInvitations(\n        emails,\n        workspace,\n        sender as WorkspaceMemberWorkspaceEntity,\n      );\n\n      expect(result.success).toBe(true);\n      expect(result.result.length).toBe(2);\n      expect(emailService.send).toHaveBeenCalledTimes(2);\n      expect(\n        onboardingService.setOnboardingInviteTeamPending,\n      ).toHaveBeenCalledWith({\n        workspaceId: workspace.id,\n        value: false,\n      });\n      expect(\n        onboardingService.setOnboardingBookOnboardingPending,\n      ).toHaveBeenCalledWith({\n        workspaceId: workspace.id,\n        value: true,\n      });\n    });\n  });\n});",
            "cost": 0.07445
        },
        "twentyhq__twenty.main/packages/twenty-server/src/engine/core-modules/workspace-invitation/services/workspace-invitation.service.ts": {
            "output": "import { Injectable } from '@nestjs/common';\nimport { InjectRepository } from '@nestjs/typeorm';\n\nimport crypto from 'crypto';\n\nimport { msg } from '@lingui/core/macro';\nimport { render } from '@react-email/render';\nimport { addMilliseconds } from 'date-fns';\nimport ms from 'ms';\nimport { SendInviteLinkEmail } from 'twenty-emails';\nimport { AppPath } from 'twenty-shared/types';\nimport { getAppPath, isDefined } from 'twenty-shared/utils';\nimport { IsNull, Repository } from 'typeorm';\n\nimport {\n  AppTokenEntity,\n  AppTokenType,\n} from 'src/engine/core-modules/app-token/app-token.entity';\nimport {\n  AuthException,\n  AuthExceptionCode,\n} from 'src/engine/core-modules/auth/auth.exception';\nimport { WorkspaceDomainsService } from 'src/engine/core-modules/domain/workspace-domains/services/workspace-domains.service';\nimport { EmailService } from 'src/engine/core-modules/email/email.service';\nimport { FileService } from 'src/engine/core-modules/file/services/file.service';\nimport { I18nService } from 'src/engine/core-modules/i18n/i18n.service';\nimport { OnboardingService } from 'src/engine/core-modules/onboarding/onboarding.service';\nimport { TwentyConfigService } from 'src/engine/core-modules/twenty-config/twenty-config.service';\nimport { UserWorkspaceEntity } from 'src/engine/core-modules/user-workspace/user-workspace.entity';\nimport { type SendInvitationsOutput } from 'src/engine/core-modules/workspace-invitation/dtos/send-invitations.output';\nimport { castAppTokenToWorkspaceInvitationUtil } from 'src/engine/core-modules/workspace-invitation/utils/cast-app-token-to-workspace-invitation.util';\nimport {\n  WorkspaceInvitationException,\n  WorkspaceInvitationExceptionCode,\n} from 'src/engine/core-modules/workspace-invitation/workspace-invitation.exception';\nimport { WorkspaceEntity } from 'src/engine/core-modules/workspace/workspace.entity';\nimport { WorkspaceMemberWorkspaceEntity } from 'src/modules/workspace-member/standard-objects/workspace-member.workspace-entity';\n\n@Injectable()\nexport class WorkspaceInvitationService {\n  constructor(\n    @InjectRepository(AppTokenEntity)\n    private readonly appTokenRepository: Repository<AppTokenEntity>,\n    @InjectRepository(UserWorkspaceEntity)\n    private readonly userWorkspaceRepository: Repository<UserWorkspaceEntity>,\n    private readonly twentyConfigService: TwentyConfigService,\n    private readonly emailService: EmailService,\n    private readonly onboardingService: OnboardingService,\n    private readonly workspaceDomainsService: WorkspaceDomainsService,\n    private readonly i18nService: I18nService,\n    private readonly fileService: FileService,\n  ) {}\n\n  async validatePersonalInvitation({\n    workspacePersonalInviteToken,\n    email,\n  }: {\n    workspacePersonalInviteToken?: string;\n    email: string;\n  }) {\n    try {\n      const appToken = await this.appTokenRepository.findOne({\n        where: {\n          value: workspacePersonalInviteToken,\n          type: AppTokenType.InvitationToken,\n        },\n        relations: { workspace: true },\n      });\n\n      if (!appToken) {\n        throw new Error('Invalid invitation token');\n      }\n\n      if (!appToken.context?.email || appToken.context?.email !== email) {\n        throw new Error('Email does not match the invitation');\n      }\n\n      if (new Date(appToken.expiresAt) < new Date()) {\n        throw new Error('Invitation expired');\n      }\n\n      return { isValid: true, workspace: appToken.workspace };\n    } catch (err) {\n      throw new AuthException(\n        err.message,\n        AuthExceptionCode.FORBIDDEN_EXCEPTION,\n      );\n    }\n  }\n\n  async findInvitationsByEmail(email: string) {\n    return await this.appTokenRepository\n      .createQueryBuilder('appToken')\n      .innerJoinAndSelect('appToken.workspace', 'workspace')\n      .where('\"appToken\".type = :type', {\n        type: AppTokenType.InvitationToken,\n      })\n      .andWhere('\"appToken\".context->>\\'email\\' = :email', { email })\n      .andWhere('appToken.deletedAt IS NULL')\n      .andWhere('appToken.expiresAt > :now', {\n        now: new Date(),\n      })\n      .getMany();\n  }\n\n  async getOneWorkspaceInvitation(workspaceId: string, email: string) {\n    return await this.appTokenRepository\n      .createQueryBuilder('appToken')\n      .where('\"appToken\".\"workspaceId\" = :workspaceId', {\n        workspaceId,\n      })\n      .andWhere('\"appToken\".type = :type', {\n        type: AppTokenType.InvitationToken,\n      })\n      .andWhere('\"appToken\".context->>\\'email\\' = :email', { email })\n      .getOne();\n  }\n\n  async getAppTokenByInvitationToken(invitationToken: string) {\n    const appToken = await this.appTokenRepository.findOne({\n      where: {\n        value: invitationToken,\n        type: AppTokenType.InvitationToken,\n      },\n      relations: { workspace: true },\n    });\n\n    if (!appToken) {\n      throw new WorkspaceInvitationException(\n        'Invalid invitation token',\n        WorkspaceInvitationExceptionCode.INVALID_INVITATION,\n      );\n    }\n\n    return appToken;\n  }\n\n  async loadWorkspaceInvitations(workspace: WorkspaceEntity) {\n    const appTokens = await this.appTokenRepository.find({\n      where: {\n        workspaceId: workspace.id,\n        type: AppTokenType.InvitationToken,\n        deletedAt: IsNull(),\n      },\n      select: {\n        value: false,\n      },\n    });\n\n    return appTokens.map(castAppTokenToWorkspaceInvitationUtil);\n  }\n\n  async createWorkspaceInvitation(email: string, workspace: WorkspaceEntity) {\n    const maybeWorkspaceInvitation = await this.getOneWorkspaceInvitation(\n      workspace.id,\n      email.toLowerCase(),\n    );\n\n    if (maybeWorkspaceInvitation) {\n      throw new WorkspaceInvitationException(\n        `${email} already invited`,\n        WorkspaceInvitationExceptionCode.INVITATION_ALREADY_EXIST,\n      );\n    }\n\n    const isUserAlreadyInWorkspace = await this.userWorkspaceRepository.exists({\n      where: {\n        workspaceId: workspace.id,\n        user: {\n          email,\n        },\n      },\n      relations: {\n        user: true,\n      },\n    });\n\n    if (isUserAlreadyInWorkspace) {\n      throw new WorkspaceInvitationException(\n        `${email} is already in the workspace`,\n        WorkspaceInvitationExceptionCode.USER_ALREADY_EXIST,\n      );\n    }\n\n    return this.generateInvitationToken(workspace.id, email);\n  }\n\n  async deleteWorkspaceInvitation(appTokenId: string, workspaceId: string) {\n    const appToken = await this.appTokenRepository.findOne({\n      where: {\n        id: appTokenId,\n        workspaceId,\n        type: AppTokenType.InvitationToken,\n      },\n    });\n\n    if (!appToken) {\n      return 'error';\n    }\n\n    await this.appTokenRepository.delete(appToken.id);\n\n    return 'success';\n  }\n\n  async invalidateWorkspaceInvitation(workspaceId: string, email: string) {\n    const appToken = await this.getOneWorkspaceInvitation(workspaceId, email);\n\n    if (!isDefined(appToken)) {\n      return;\n    }\n\n    await this.appTokenRepository.delete(appToken.id);\n  }\n\n  async resendWorkspaceInvitation(\n    appTokenId: string,\n    workspace: WorkspaceEntity,\n    sender: WorkspaceMemberWorkspaceEntity,\n  ) {\n    const appToken = await this.appTokenRepository.findOne({\n      where: {\n        id: appTokenId,\n        workspaceId: workspace.id,\n        type: AppTokenType.InvitationToken,\n      },\n    });\n\n    if (!appToken || !appToken.context?.email) {\n      throw new WorkspaceInvitationException(\n        'Invalid appToken',\n        WorkspaceInvitationExceptionCode.INVALID_INVITATION,\n      );\n    }\n\n    await this.appTokenRepository.delete(appToken.id);\n\n    return this.sendInvitations([appToken.context.email], workspace, sender);\n  }\n\n  async sendInvitations(\n    emails: string[],\n    workspace: WorkspaceEntity,\n    sender: WorkspaceMemberWorkspaceEntity,\n    usePersonalInvitation = true,\n  ): Promise<SendInvitationsOutput> {\n    if (!workspace?.inviteHash) {\n      return {\n        success: false,\n        errors: ['Workspace invite hash not found'],\n        result: [],\n      };\n    }\n\n    const invitationsPr = await Promise.allSettled(\n      emails.map(async (email) => {\n        if (usePersonalInvitation) {\n          const appToken = await this.createWorkspaceInvitation(\n            email,\n            workspace,\n          );\n\n          if (!appToken.context?.email) {\n            throw new WorkspaceInvitationException(\n              'Invalid email',\n              WorkspaceInvitationExceptionCode.EMAIL_MISSING,\n            );\n          }\n\n          return {\n            isPersonalInvitation: true as const,\n            appToken,\n            email: appToken.context.email,\n          };\n        }\n\n        return {\n          isPersonalInvitation: false as const,\n          email,\n        };\n      }),\n    );\n\n    for (const invitation of invitationsPr) {\n      if (invitation.status === 'fulfilled') {\n        const link = this.workspaceDomainsService.buildWorkspaceURL({\n          workspace,\n          pathname: getAppPath(AppPath.Invite, {\n            workspaceInviteHash: workspace?.inviteHash,\n          }),\n          searchParams: invitation.value.isPersonalInvitation\n            ? {\n                inviteToken: invitation.value.appToken.value,\n                email: invitation.value.email,\n              }\n            : {},\n        });\n\n        if (!isDefined(sender.userEmail)) {\n          throw new WorkspaceInvitationException(\n            'Sender email is missing',\n            WorkspaceInvitationExceptionCode.EMAIL_MISSING,\n          );\n        }\n\n        const emailData = {\n          link: link.toString(),\n          workspace: {\n            name: workspace.displayName,\n            logo: workspace.logo\n              ? this.fileService.signFileUrl({\n                  url: workspace.logo,\n                  workspaceId: workspace.id,\n                })\n              : workspace.logo,\n          },\n          sender: {\n            email: sender.userEmail,\n            firstName: sender.name.firstName,\n            lastName: sender.name.lastName,\n          },\n          serverUrl: this.twentyConfigService.get('SERVER_URL'),\n          locale: sender.locale,\n        };\n\n        const emailTemplate = SendInviteLinkEmail(emailData);\n        const html = await render(emailTemplate);\n        const text = await render(emailTemplate, {\n          plainText: true,\n        });\n\n        const joinTeamMsg = msg`Join your team on Twenty`;\n        const i18n = this.i18nService.getI18nInstance(sender.locale);\n        const subject = i18n._(joinTeamMsg);\n\n        await this.emailService.send({\n          from: `${sender.name.firstName} ${sender.name.lastName} (via Twenty) <${this.twentyConfigService.get('EMAIL_FROM_ADDRESS')}>`,\n          to: invitation.value.email,\n          subject,\n          text,\n          html,\n        });\n      }\n    }\n\n    await this.onboardingService.setOnboardingInviteTeamPending({\n      workspaceId: workspace.id,\n      value: false,\n    });\n\n    await this.onboardingService.setOnboardingBookOnboardingPending({\n      workspaceId: workspace.id,\n      value: true,\n    });\n\n    const result = invitationsPr.reduce<{\n      errors: string[];\n      result: ReturnType<\n        typeof this.workspaceInvitationService.createWorkspaceInvitation\n      >['status'] extends 'rejected'\n        ? never\n        : ReturnType<\n            typeof this.workspaceInvitationService.appTokenToWorkspaceInvitation\n          >;\n    }>(\n      (acc, invitation) => {\n        if (invitation.status === 'rejected') {\n          acc.errors.push(invitation.reason?.message ?? 'Unknown error');\n        } else {\n          acc.result.push(\n            invitation.value.isPersonalInvitation\n              ? castAppTokenToWorkspaceInvitationUtil(invitation.value.appToken)\n              : { email: invitation.value.email },\n          );\n        }\n\n        return acc;\n      },\n      { errors: [], result: [] },\n    );\n\n    return {\n      success: result.errors.length === 0,\n      ...result,\n    };\n  }\n\n  async generateInvitationToken(workspaceId: string, email: string) {\n    const expiresIn = this.twentyConfigService.get(\n      'INVITATION_TOKEN_EXPIRES_IN',\n    );\n\n    if (!expiresIn) {\n      throw new AuthException(\n        'Expiration time for invitation token is not set',\n        AuthExceptionCode.INTERNAL_SERVER_ERROR,\n      );\n    }\n\n    const expiresAt = addMilliseconds(new Date().getTime(), ms(expiresIn));\n\n    const invitationToken = this.appTokenRepository.create({\n      workspaceId,\n      expiresAt,\n      type: AppTokenType.InvitationToken,\n      value: crypto.randomBytes(32).toString('hex'),\n      context: {\n        email,\n      },\n    });\n\n    return this.appTokenRepository.save(invitationToken);\n  }\n}",
            "output_extracted": "import { Injectable } from '@nestjs/common';\nimport { InjectRepository } from '@nestjs/typeorm';\n\nimport crypto from 'crypto';\n\nimport { msg } from '@lingui/core/macro';\nimport { render } from '@react-email/render';\nimport { addMilliseconds } from 'date-fns';\nimport ms from 'ms';\nimport { SendInviteLinkEmail } from 'twenty-emails';\nimport { AppPath } from 'twenty-shared/types';\nimport { getAppPath, isDefined } from 'twenty-shared/utils';\nimport { IsNull, Repository } from 'typeorm';\n\nimport {\n  AppTokenEntity,\n  AppTokenType,\n} from 'src/engine/core-modules/app-token/app-token.entity';\nimport {\n  AuthException,\n  AuthExceptionCode,\n} from 'src/engine/core-modules/auth/auth.exception';\nimport { WorkspaceDomainsService } from 'src/engine/core-modules/domain/workspace-domains/services/workspace-domains.service';\nimport { EmailService } from 'src/engine/core-modules/email/email.service';\nimport { FileService } from 'src/engine/core-modules/file/services/file.service';\nimport { I18nService } from 'src/engine/core-modules/i18n/i18n.service';\nimport { OnboardingService } from 'src/engine/core-modules/onboarding/onboarding.service';\nimport { TwentyConfigService } from 'src/engine/core-modules/twenty-config/twenty-config.service';\nimport { UserWorkspaceEntity } from 'src/engine/core-modules/user-workspace/user-workspace.entity';\nimport { type SendInvitationsOutput } from 'src/engine/core-modules/workspace-invitation/dtos/send-invitations.output';\nimport { castAppTokenToWorkspaceInvitationUtil } from 'src/engine/core-modules/workspace-invitation/utils/cast-app-token-to-workspace-invitation.util';\nimport {\n  WorkspaceInvitationException,\n  WorkspaceInvitationExceptionCode,\n} from 'src/engine/core-modules/workspace-invitation/workspace-invitation.exception';\nimport { WorkspaceEntity } from 'src/engine/core-modules/workspace/workspace.entity';\nimport { WorkspaceMemberWorkspaceEntity } from 'src/modules/workspace-member/standard-objects/workspace-member.workspace-entity';\n\n@Injectable()\nexport class WorkspaceInvitationService {\n  constructor(\n    @InjectRepository(AppTokenEntity)\n    private readonly appTokenRepository: Repository<AppTokenEntity>,\n    @InjectRepository(UserWorkspaceEntity)\n    private readonly userWorkspaceRepository: Repository<UserWorkspaceEntity>,\n    private readonly twentyConfigService: TwentyConfigService,\n    private readonly emailService: EmailService,\n    private readonly onboardingService: OnboardingService,\n    private readonly workspaceDomainsService: WorkspaceDomainsService,\n    private readonly i18nService: I18nService,\n    private readonly fileService: FileService,\n  ) {}\n\n  async validatePersonalInvitation({\n    workspacePersonalInviteToken,\n    email,\n  }: {\n    workspacePersonalInviteToken?: string;\n    email: string;\n  }) {\n    try {\n      const appToken = await this.appTokenRepository.findOne({\n        where: {\n          value: workspacePersonalInviteToken,\n          type: AppTokenType.InvitationToken,\n        },\n        relations: { workspace: true },\n      });\n\n      if (!appToken) {\n        throw new Error('Invalid invitation token');\n      }\n\n      if (!appToken.context?.email || appToken.context?.email !== email) {\n        throw new Error('Email does not match the invitation');\n      }\n\n      if (new Date(appToken.expiresAt) < new Date()) {\n        throw new Error('Invitation expired');\n      }\n\n      return { isValid: true, workspace: appToken.workspace };\n    } catch (err) {\n      throw new AuthException(\n        err.message,\n        AuthExceptionCode.FORBIDDEN_EXCEPTION,\n      );\n    }\n  }\n\n  async findInvitationsByEmail(email: string) {\n    return await this.appTokenRepository\n      .createQueryBuilder('appToken')\n      .innerJoinAndSelect('appToken.workspace', 'workspace')\n      .where('\"appToken\".type = :type', {\n        type: AppTokenType.InvitationToken,\n      })\n      .andWhere('\"appToken\".context->>\\'email\\' = :email', { email })\n      .andWhere('appToken.deletedAt IS NULL')\n      .andWhere('appToken.expiresAt > :now', {\n        now: new Date(),\n      })\n      .getMany();\n  }\n\n  async getOneWorkspaceInvitation(workspaceId: string, email: string) {\n    return await this.appTokenRepository\n      .createQueryBuilder('appToken')\n      .where('\"appToken\".\"workspaceId\" = :workspaceId', {\n        workspaceId,\n      })\n      .andWhere('\"appToken\".type = :type', {\n        type: AppTokenType.InvitationToken,\n      })\n      .andWhere('\"appToken\".context->>\\'email\\' = :email', { email })\n      .getOne();\n  }\n\n  async getAppTokenByInvitationToken(invitationToken: string) {\n    const appToken = await this.appTokenRepository.findOne({\n      where: {\n        value: invitationToken,\n        type: AppTokenType.InvitationToken,\n      },\n      relations: { workspace: true },\n    });\n\n    if (!appToken) {\n      throw new WorkspaceInvitationException(\n        'Invalid invitation token',\n        WorkspaceInvitationExceptionCode.INVALID_INVITATION,\n      );\n    }\n\n    return appToken;\n  }\n\n  async loadWorkspaceInvitations(workspace: WorkspaceEntity) {\n    const appTokens = await this.appTokenRepository.find({\n      where: {\n        workspaceId: workspace.id,\n        type: AppTokenType.InvitationToken,\n        deletedAt: IsNull(),\n      },\n      select: {\n        value: false,\n      },\n    });\n\n    return appTokens.map(castAppTokenToWorkspaceInvitationUtil);\n  }\n\n  async createWorkspaceInvitation(email: string, workspace: WorkspaceEntity) {\n    const maybeWorkspaceInvitation = await this.getOneWorkspaceInvitation(\n      workspace.id,\n      email.toLowerCase(),\n    );\n\n    if (maybeWorkspaceInvitation) {\n      throw new WorkspaceInvitationException(\n        `${email} already invited`,\n        WorkspaceInvitationExceptionCode.INVITATION_ALREADY_EXIST,\n      );\n    }\n\n    const isUserAlreadyInWorkspace = await this.userWorkspaceRepository.exists({\n      where: {\n        workspaceId: workspace.id,\n        user: {\n          email,\n        },\n      },\n      relations: {\n        user: true,\n      },\n    });\n\n    if (isUserAlreadyInWorkspace) {\n      throw new WorkspaceInvitationException(\n        `${email} is already in the workspace`,\n        WorkspaceInvitationExceptionCode.USER_ALREADY_EXIST,\n      );\n    }\n\n    return this.generateInvitationToken(workspace.id, email);\n  }\n\n  async deleteWorkspaceInvitation(appTokenId: string, workspaceId: string) {\n    const appToken = await this.appTokenRepository.findOne({\n      where: {\n        id: appTokenId,\n        workspaceId,\n        type: AppTokenType.InvitationToken,\n      },\n    });\n\n    if (!appToken) {\n      return 'error';\n    }\n\n    await this.appTokenRepository.delete(appToken.id);\n\n    return 'success';\n  }\n\n  async invalidateWorkspaceInvitation(workspaceId: string, email: string) {\n    const appToken = await this.getOneWorkspaceInvitation(workspaceId, email);\n\n    if (!isDefined(appToken)) {\n      return;\n    }\n\n    await this.appTokenRepository.delete(appToken.id);\n  }\n\n  async resendWorkspaceInvitation(\n    appTokenId: string,\n    workspace: WorkspaceEntity,\n    sender: WorkspaceMemberWorkspaceEntity,\n  ) {\n    const appToken = await this.appTokenRepository.findOne({\n      where: {\n        id: appTokenId,\n        workspaceId: workspace.id,\n        type: AppTokenType.InvitationToken,\n      },\n    });\n\n    if (!appToken || !appToken.context?.email) {\n      throw new WorkspaceInvitationException(\n        'Invalid appToken',\n        WorkspaceInvitationExceptionCode.INVALID_INVITATION,\n      );\n    }\n\n    await this.appTokenRepository.delete(appToken.id);\n\n    return this.sendInvitations([appToken.context.email], workspace, sender);\n  }\n\n  async sendInvitations(\n    emails: string[],\n    workspace: WorkspaceEntity,\n    sender: WorkspaceMemberWorkspaceEntity,\n    usePersonalInvitation = true,\n  ): Promise<SendInvitationsOutput> {\n    if (!workspace?.inviteHash) {\n      return {\n        success: false,\n        errors: ['Workspace invite hash not found'],\n        result: [],\n      };\n    }\n\n    const invitationsPr = await Promise.allSettled(\n      emails.map(async (email) => {\n        if (usePersonalInvitation) {\n          const appToken = await this.createWorkspaceInvitation(\n            email,\n            workspace,\n          );\n\n          if (!appToken.context?.email) {\n            throw new WorkspaceInvitationException(\n              'Invalid email',\n              WorkspaceInvitationExceptionCode.EMAIL_MISSING,\n            );\n          }\n\n          return {\n            isPersonalInvitation: true as const,\n            appToken,\n            email: appToken.context.email,\n          };\n        }\n\n        return {\n          isPersonalInvitation: false as const,\n          email,\n        };\n      }),\n    );\n\n    for (const invitation of invitationsPr) {\n      if (invitation.status === 'fulfilled') {\n        const link = this.workspaceDomainsService.buildWorkspaceURL({\n          workspace,\n          pathname: getAppPath(AppPath.Invite, {\n            workspaceInviteHash: workspace?.inviteHash,\n          }),\n          searchParams: invitation.value.isPersonalInvitation\n            ? {\n                inviteToken: invitation.value.appToken.value,\n                email: invitation.value.email,\n              }\n            : {},\n        });\n\n        if (!isDefined(sender.userEmail)) {\n          throw new WorkspaceInvitationException(\n            'Sender email is missing',\n            WorkspaceInvitationExceptionCode.EMAIL_MISSING,\n          );\n        }\n\n        const emailData = {\n          link: link.toString(),\n          workspace: {\n            name: workspace.displayName,\n            logo: workspace.logo\n              ? this.fileService.signFileUrl({\n                  url: workspace.logo,\n                  workspaceId: workspace.id,\n                })\n              : workspace.logo,\n          },\n          sender: {\n            email: sender.userEmail,\n            firstName: sender.name.firstName,\n            lastName: sender.name.lastName,\n          },\n          serverUrl: this.twentyConfigService.get('SERVER_URL'),\n          locale: sender.locale,\n        };\n\n        const emailTemplate = SendInviteLinkEmail(emailData);\n        const html = await render(emailTemplate);\n        const text = await render(emailTemplate, {\n          plainText: true,\n        });\n\n        const joinTeamMsg = msg`Join your team on Twenty`;\n        const i18n = this.i18nService.getI18nInstance(sender.locale);\n        const subject = i18n._(joinTeamMsg);\n\n        await this.emailService.send({\n          from: `${sender.name.firstName} ${sender.name.lastName} (via Twenty) <${this.twentyConfigService.get('EMAIL_FROM_ADDRESS')}>`,\n          to: invitation.value.email,\n          subject,\n          text,\n          html,\n        });\n      }\n    }\n\n    await this.onboardingService.setOnboardingInviteTeamPending({\n      workspaceId: workspace.id,\n      value: false,\n    });\n\n    await this.onboardingService.setOnboardingBookOnboardingPending({\n      workspaceId: workspace.id,\n      value: true,\n    });\n\n    const result = invitationsPr.reduce<{\n      errors: string[];\n      result: ReturnType<\n        typeof this.workspaceInvitationService.createWorkspaceInvitation\n      >['status'] extends 'rejected'\n        ? never\n        : ReturnType<\n            typeof this.workspaceInvitationService.appTokenToWorkspaceInvitation\n          >;\n    }>(\n      (acc, invitation) => {\n        if (invitation.status === 'rejected') {\n          acc.errors.push(invitation.reason?.message ?? 'Unknown error');\n        } else {\n          acc.result.push(\n            invitation.value.isPersonalInvitation\n              ? castAppTokenToWorkspaceInvitationUtil(invitation.value.appToken)\n              : { email: invitation.value.email },\n          );\n        }\n\n        return acc;\n      },\n      { errors: [], result: [] },\n    );\n\n    return {\n      success: result.errors.length === 0,\n      ...result,\n    };\n  }\n\n  async generateInvitationToken(workspaceId: string, email: string) {\n    const expiresIn = this.twentyConfigService.get(\n      'INVITATION_TOKEN_EXPIRES_IN',\n    );\n\n    if (!expiresIn) {\n      throw new AuthException(\n        'Expiration time for invitation token is not set',\n        AuthExceptionCode.INTERNAL_SERVER_ERROR,\n      );\n    }\n\n    const expiresAt = addMilliseconds(new Date().getTime(), ms(expiresIn));\n\n    const invitationToken = this.appTokenRepository.create({\n      workspaceId,\n      expiresAt,\n      type: AppTokenType.InvitationToken,\n      value: crypto.randomBytes(32).toString('hex'),\n      context: {\n        email,\n      },\n    });\n\n    return this.appTokenRepository.save(invitationToken);\n  }\n}",
            "cost": 0.12334
        },
        "twentyhq__twenty.main/packages/twenty-server/src/engine/core-modules/workspace-invitation/workspace-invitation.module.ts": {
            "output": "import { Module } from '@nestjs/common';\n\nimport { NestjsQueryTypeOrmModule } from '@ptc-org/nestjs-query-typeorm';\n\nimport { AppTokenEntity } from 'src/engine/core-modules/app-token/app-token.entity';\nimport { WorkspaceDomainsModule } from 'src/engine/core-modules/domain/workspace-domains/workspace-domains.module';\nimport { FeatureFlagModule } from 'src/engine/core-modules/feature-flag/feature-flag.module';\nimport { FileModule } from 'src/engine/core-modules/file/file.module';\nimport { OnboardingModule } from 'src/engine/core-modules/onboarding/onboarding.module';\nimport { UserWorkspaceEntity } from 'src/engine/core-modules/user-workspace/user-workspace.entity';\nimport { WorkspaceInvitationService } from 'src/engine/core-modules/workspace-invitation/services/workspace-invitation.service';\nimport { WorkspaceInvitationResolver } from 'src/engine/core-modules/workspace-invitation/workspace-invitation.resolver';\nimport { WorkspaceEntity } from 'src/engine/core-modules/workspace/workspace.entity';\nimport { PermissionsModule } from 'src/engine/metadata-modules/permissions/permissions.module';\n\n@Module({\n  imports: [\n    WorkspaceDomainsModule,\n    NestjsQueryTypeOrmModule.forFeature([\n      AppTokenEntity,\n      UserWorkspaceEntity,\n      WorkspaceEntity,\n    ]),\n    FileModule,\n    OnboardingModule,\n    PermissionsModule,\n    FeatureFlagModule,\n  ],\n  exports: [WorkspaceInvitationService],\n  providers: [WorkspaceInvitationService, WorkspaceInvitationResolver],\n})\nexport class WorkspaceInvitationModule {}",
            "output_extracted": "import { Module } from '@nestjs/common';\n\nimport { NestjsQueryTypeOrmModule } from '@ptc-org/nestjs-query-typeorm';\n\nimport { AppTokenEntity } from 'src/engine/core-modules/app-token/app-token.entity';\nimport { WorkspaceDomainsModule } from 'src/engine/core-modules/domain/workspace-domains/workspace-domains.module';\nimport { FeatureFlagModule } from 'src/engine/core-modules/feature-flag/feature-flag.module';\nimport { FileModule } from 'src/engine/core-modules/file/file.module';\nimport { OnboardingModule } from 'src/engine/core-modules/onboarding/onboarding.module';\nimport { UserWorkspaceEntity } from 'src/engine/core-modules/user-workspace/user-workspace.entity';\nimport { WorkspaceInvitationService } from 'src/engine/core-modules/workspace-invitation/services/workspace-invitation.service';\nimport { WorkspaceInvitationResolver } from 'src/engine/core-modules/workspace-invitation/workspace-invitation.resolver';\nimport { WorkspaceEntity } from 'src/engine/core-modules/workspace/workspace.entity';\nimport { PermissionsModule } from 'src/engine/metadata-modules/permissions/permissions.module';\n\n@Module({\n  imports: [\n    WorkspaceDomainsModule,\n    NestjsQueryTypeOrmModule.forFeature([\n      AppTokenEntity,\n      UserWorkspaceEntity,\n      WorkspaceEntity,\n    ]),\n    FileModule,\n    OnboardingModule,\n    PermissionsModule,\n    FeatureFlagModule,\n  ],\n  exports: [WorkspaceInvitationService],\n  providers: [WorkspaceInvitationService, WorkspaceInvitationResolver],\n})\nexport class WorkspaceInvitationModule {}",
            "cost": 0.02065
        },
        "twentyhq__twenty.main/packages/twenty-server/src/engine/core-modules/workspace-invitation/workspace-invitation.resolver.ts": {
            "output": "import { UseFilters, UseGuards, UsePipes } from '@nestjs/common';\nimport { Args, Mutation, Query, Resolver } from '@nestjs/graphql';\n\nimport { FileService } from 'src/engine/core-modules/file/services/file.service';\nimport { PreventNestToAutoLogGraphqlErrorsFilter } from 'src/engine/core-modules/graphql/filters/prevent-nest-to-auto-log-graphql-errors.filter';\nimport { ResolverValidationPipe } from 'src/engine/core-modules/graphql/pipes/resolver-validation.pipe';\nimport { UserEntity } from 'src/engine/core-modules/user/user.entity';\nimport { SendInvitationsOutput } from 'src/engine/core-modules/workspace-invitation/dtos/send-invitations.output';\nimport { WorkspaceInvitation } from 'src/engine/core-modules/workspace-invitation/dtos/workspace-invitation.dto';\nimport { WorkspaceInvitationService } from 'src/engine/core-modules/workspace-invitation/services/workspace-invitation.service';\nimport { WorkspaceEntity } from 'src/engine/core-modules/workspace/workspace.entity';\nimport { AuthUser } from 'src/engine/decorators/auth/auth-user.decorator';\nimport { AuthWorkspace } from 'src/engine/decorators/auth/auth-workspace.decorator';\nimport { SettingsPermissionGuard } from 'src/engine/guards/settings-permission.guard';\nimport { UserAuthGuard } from 'src/engine/guards/user-auth.guard';\nimport { WorkspaceAuthGuard } from 'src/engine/guards/workspace-auth.guard';\nimport { PermissionFlagType } from 'src/engine/metadata-modules/permissions/constants/permission-flag-type.constants';\nimport { PermissionsGraphqlApiExceptionFilter } from 'src/engine/metadata-modules/permissions/utils/permissions-graphql-api-exception.filter';\nimport { TwentyORMGlobalManager } from 'src/engine/twenty-orm/twenty-orm-global.manager';\nimport { WorkspaceMemberWorkspaceEntity } from 'src/modules/workspace-member/standard-objects/workspace-member.workspace-entity';\n\nimport { SendInvitationsInput } from './dtos/send-invitations.input';\n\n@UseGuards(\n  WorkspaceAuthGuard,\n  SettingsPermissionGuard(PermissionFlagType.WORKSPACE_MEMBERS),\n)\n@UsePipes(ResolverValidationPipe)\n@UseFilters(\n  PermissionsGraphqlApiExceptionFilter,\n  PreventNestToAutoLogGraphqlErrorsFilter,\n)\n@Resolver()\nexport class WorkspaceInvitationResolver {\n  constructor(\n    private readonly twentyORMGlobalManager: TwentyORMGlobalManager,\n    private readonly workspaceInvitationService: WorkspaceInvitationService,\n    private readonly fileService: FileService,\n  ) {}\n\n  @Mutation(() => String)\n  async deleteWorkspaceInvitation(\n    @Args('appTokenId') appTokenId: string,\n    @AuthWorkspace() { id: workspaceId }: WorkspaceEntity,\n  ) {\n    return this.workspaceInvitationService.deleteWorkspaceInvitation(\n      appTokenId,\n      workspaceId,\n    );\n  }\n\n  @Mutation(() => SendInvitationsOutput)\n  @UseGuards(UserAuthGuard)\n  async resendWorkspaceInvitation(\n    @Args('appTokenId') appTokenId: string,\n    @AuthWorkspace() workspace: WorkspaceEntity,\n    @AuthUser() user: UserEntity,\n  ) {\n    const workspaceMemberRepository =\n      await this.twentyORMGlobalManager.getRepositoryForWorkspace<WorkspaceMemberWorkspaceEntity>(\n        workspace.id,\n        'workspaceMember',\n        { shouldBypassPermissionChecks: true },\n      );\n\n    const workspaceMember = await workspaceMemberRepository.findOneOrFail({\n      where: {\n        userId: user.id,\n      },\n    });\n\n    return this.workspaceInvitationService.resendWorkspaceInvitation(\n      appTokenId,\n      workspace,\n      workspaceMember,\n    );\n  }\n\n  @Query(() => [WorkspaceInvitation])\n  async findWorkspaceInvitations(@AuthWorkspace() workspace: WorkspaceEntity) {\n    return this.workspaceInvitationService.loadWorkspaceInvitations(workspace);\n  }\n\n  @Mutation(() => SendInvitationsOutput)\n  @UseGuards(UserAuthGuard)\n  async sendInvitations(\n    @Args() sendInviteLinkInput: SendInvitationsInput,\n    @AuthUser() user: UserEntity,\n    @AuthWorkspace() workspace: WorkspaceEntity,\n  ): Promise<SendInvitationsOutput> {\n    const workspaceMemberRepository =\n      await this.twentyORMGlobalManager.getRepositoryForWorkspace<WorkspaceMemberWorkspaceEntity>(\n        workspace.id,\n        'workspaceMember',\n        { shouldBypassPermissionChecks: true },\n      );\n\n    const workspaceMember = await workspaceMemberRepository.findOneOrFail({\n      where: {\n        userId: user.id,\n      },\n    });\n\n    return await this.workspaceInvitationService.sendInvitations(\n      sendInviteLinkInput.emails,\n      workspace,\n      workspaceMember,\n    );\n  }\n}",
            "output_extracted": "import { UseFilters, UseGuards, UsePipes } from '@nestjs/common';\nimport { Args, Mutation, Query, Resolver } from '@nestjs/graphql';\n\nimport { FileService } from 'src/engine/core-modules/file/services/file.service';\nimport { PreventNestToAutoLogGraphqlErrorsFilter } from 'src/engine/core-modules/graphql/filters/prevent-nest-to-auto-log-graphql-errors.filter';\nimport { ResolverValidationPipe } from 'src/engine/core-modules/graphql/pipes/resolver-validation.pipe';\nimport { UserEntity } from 'src/engine/core-modules/user/user.entity';\nimport { SendInvitationsOutput } from 'src/engine/core-modules/workspace-invitation/dtos/send-invitations.output';\nimport { WorkspaceInvitation } from 'src/engine/core-modules/workspace-invitation/dtos/workspace-invitation.dto';\nimport { WorkspaceInvitationService } from 'src/engine/core-modules/workspace-invitation/services/workspace-invitation.service';\nimport { WorkspaceEntity } from 'src/engine/core-modules/workspace/workspace.entity';\nimport { AuthUser } from 'src/engine/decorators/auth/auth-user.decorator';\nimport { AuthWorkspace } from 'src/engine/decorators/auth/auth-workspace.decorator';\nimport { SettingsPermissionGuard } from 'src/engine/guards/settings-permission.guard';\nimport { UserAuthGuard } from 'src/engine/guards/user-auth.guard';\nimport { WorkspaceAuthGuard } from 'src/engine/guards/workspace-auth.guard';\nimport { PermissionFlagType } from 'src/engine/metadata-modules/permissions/constants/permission-flag-type.constants';\nimport { PermissionsGraphqlApiExceptionFilter } from 'src/engine/metadata-modules/permissions/utils/permissions-graphql-api-exception.filter';\nimport { TwentyORMGlobalManager } from 'src/engine/twenty-orm/twenty-orm-global.manager';\nimport { WorkspaceMemberWorkspaceEntity } from 'src/modules/workspace-member/standard-objects/workspace-member.workspace-entity';\n\nimport { SendInvitationsInput } from './dtos/send-invitations.input';\n\n@UseGuards(\n  WorkspaceAuthGuard,\n  SettingsPermissionGuard(PermissionFlagType.WORKSPACE_MEMBERS),\n)\n@UsePipes(ResolverValidationPipe)\n@UseFilters(\n  PermissionsGraphqlApiExceptionFilter,\n  PreventNestToAutoLogGraphqlErrorsFilter,\n)\n@Resolver()\nexport class WorkspaceInvitationResolver {\n  constructor(\n    private readonly twentyORMGlobalManager: TwentyORMGlobalManager,\n    private readonly workspaceInvitationService: WorkspaceInvitationService,\n    private readonly fileService: FileService,\n  ) {}\n\n  @Mutation(() => String)\n  async deleteWorkspaceInvitation(\n    @Args('appTokenId') appTokenId: string,\n    @AuthWorkspace() { id: workspaceId }: WorkspaceEntity,\n  ) {\n    return this.workspaceInvitationService.deleteWorkspaceInvitation(\n      appTokenId,\n      workspaceId,\n    );\n  }\n\n  @Mutation(() => SendInvitationsOutput)\n  @UseGuards(UserAuthGuard)\n  async resendWorkspaceInvitation(\n    @Args('appTokenId') appTokenId: string,\n    @AuthWorkspace() workspace: WorkspaceEntity,\n    @AuthUser() user: UserEntity,\n  ) {\n    const workspaceMemberRepository =\n      await this.twentyORMGlobalManager.getRepositoryForWorkspace<WorkspaceMemberWorkspaceEntity>(\n        workspace.id,\n        'workspaceMember',\n        { shouldBypassPermissionChecks: true },\n      );\n\n    const workspaceMember = await workspaceMemberRepository.findOneOrFail({\n      where: {\n        userId: user.id,\n      },\n    });\n\n    return this.workspaceInvitationService.resendWorkspaceInvitation(\n      appTokenId,\n      workspace,\n      workspaceMember,\n    );\n  }\n\n  @Query(() => [WorkspaceInvitation])\n  async findWorkspaceInvitations(@AuthWorkspace() workspace: WorkspaceEntity) {\n    return this.workspaceInvitationService.loadWorkspaceInvitations(workspace);\n  }\n\n  @Mutation(() => SendInvitationsOutput)\n  @UseGuards(UserAuthGuard)\n  async sendInvitations(\n    @Args() sendInviteLinkInput: SendInvitationsInput,\n    @AuthUser() user: UserEntity,\n    @AuthWorkspace() workspace: WorkspaceEntity,\n  ): Promise<SendInvitationsOutput> {\n    const workspaceMemberRepository =\n      await this.twentyORMGlobalManager.getRepositoryForWorkspace<WorkspaceMemberWorkspaceEntity>(\n        workspace.id,\n        'workspaceMember',\n        { shouldBypassPermissionChecks: true },\n      );\n\n    const workspaceMember = await workspaceMemberRepository.findOneOrFail({\n      where: {\n        userId: user.id,\n      },\n    });\n\n    return await this.workspaceInvitationService.sendInvitations(\n      sendInviteLinkInput.emails,\n      workspace,\n      workspaceMember,\n    );\n  }\n}",
            "cost": 0.04791
        }
    },
    "recover_status": "success",
    "instance_ref": {
        "instance_id": "twentyhq__twenty.main.16070",
        "repo": "twentyhq/twenty",
        "base_commit": "7bf68e5f31575e6582692f9a06497ffb59699e0c",
        "head_commit": "dfd3380b6dd8a906952a68ddb1d1696a76d2deb3",
        "title": "Security - add throttle in message resend",
        "merged_at": "2025-11-28T17:33:06Z",
        "html_url": "https://github.com/twentyhq/twenty/pull/16070",
        "test_files": [
            "packages/twenty-server/src/engine/core-modules/workspace-invitation/services/workspace-invitation.service.spec.ts"
        ],
        "code_files": [
            "packages/twenty-server/src/engine/core-modules/twenty-config/config-variables.ts",
            "packages/twenty-server/src/engine/core-modules/workspace-invitation/services/workspace-invitation.service.ts",
            "packages/twenty-server/src/engine/core-modules/workspace-invitation/workspace-invitation.module.ts",
            "packages/twenty-server/src/engine/core-modules/workspace-invitation/workspace-invitation.resolver.ts"
        ],
        "total_changes": 96,
        "num_files": 5,
        "pull_number": 16070,
        "patch": "diff --git a/packages/twenty-server/src/engine/core-modules/twenty-config/config-variables.ts b/packages/twenty-server/src/engine/core-modules/twenty-config/config-variables.ts\nindex 8904189de5ee1..d72b44186a19f 100644\n--- a/packages/twenty-server/src/engine/core-modules/twenty-config/config-variables.ts\n+++ b/packages/twenty-server/src/engine/core-modules/twenty-config/config-variables.ts\n@@ -975,7 +975,7 @@ export class ConfigVariables {\n     type: ConfigVariableType.NUMBER,\n   })\n   @CastToPositiveNumber()\n-  API_RATE_LIMITING_LONG_TTL_IN_MS = 60000;\n+  API_RATE_LIMITING_LONG_TTL_IN_MS = 60_000;\n \n   @ConfigVariablesMetadata({\n     group: ConfigVariablesGroup.RATE_LIMITING,\n@@ -994,6 +994,42 @@ export class ConfigVariables {\n   })\n   GRAPHQL_MAX_COMPLEXITY = 2000;\n \n+  @ConfigVariablesMetadata({\n+    group: ConfigVariablesGroup.RATE_LIMITING,\n+    description:\n+      'Time-to-live for workspace-level invitations resending rate limiting in milliseconds',\n+    type: ConfigVariableType.NUMBER,\n+  })\n+  @CastToPositiveNumber()\n+  INVITATION_SENDING_BY_WORKSPACE_THROTTLE_TTL_IN_MS = 604_800_000; // 7 days\n+\n+  @ConfigVariablesMetadata({\n+    group: ConfigVariablesGroup.RATE_LIMITING,\n+    description:\n+      'Maximum number of workspace-level invitations resending allowed in the rate limiting window',\n+    type: ConfigVariableType.NUMBER,\n+  })\n+  @CastToPositiveNumber()\n+  INVITATION_SENDING_BY_WORKSPACE_THROTTLE_LIMIT = 500;\n+\n+  @ConfigVariablesMetadata({\n+    group: ConfigVariablesGroup.RATE_LIMITING,\n+    description:\n+      'Time-to-live for email-level invitations sending rate limiting in milliseconds',\n+    type: ConfigVariableType.NUMBER,\n+  })\n+  @CastToPositiveNumber()\n+  INVITATION_SENDING_BY_EMAIL_THROTTLE_TTL_IN_MS = 604_800_000; // 7 days\n+\n+  @ConfigVariablesMetadata({\n+    group: ConfigVariablesGroup.RATE_LIMITING,\n+    description:\n+      'Maximum number of email-level invitations sending allowed in the rate limiting window',\n+    type: ConfigVariableType.NUMBER,\n+  })\n+  @CastToPositiveNumber()\n+  INVITATION_SENDING_BY_EMAIL_THROTTLE_LIMIT = 10;\n+\n   @ConfigVariablesMetadata({\n     group: ConfigVariablesGroup.SSL,\n     description: 'Path to the SSL key for enabling HTTPS in local development',\ndiff --git a/packages/twenty-server/src/engine/core-modules/workspace-invitation/services/workspace-invitation.service.spec.ts b/packages/twenty-server/src/engine/core-modules/workspace-invitation/services/workspace-invitation.service.spec.ts\nindex 4661d89b81895..c603b0b98dc84 100644\n--- a/packages/twenty-server/src/engine/core-modules/workspace-invitation/services/workspace-invitation.service.spec.ts\n+++ b/packages/twenty-server/src/engine/core-modules/workspace-invitation/services/workspace-invitation.service.spec.ts\n@@ -12,6 +12,7 @@ import { EmailService } from 'src/engine/core-modules/email/email.service';\n import { FileService } from 'src/engine/core-modules/file/services/file.service';\n import { I18nService } from 'src/engine/core-modules/i18n/i18n.service';\n import { OnboardingService } from 'src/engine/core-modules/onboarding/onboarding.service';\n+import { ThrottlerService } from 'src/engine/core-modules/throttler/throttler.service';\n import { TwentyConfigService } from 'src/engine/core-modules/twenty-config/twenty-config.service';\n import { UserWorkspaceEntity } from 'src/engine/core-modules/user-workspace/user-workspace.entity';\n import { WorkspaceInvitationException } from 'src/engine/core-modules/workspace-invitation/workspace-invitation.exception';\n@@ -112,6 +113,12 @@ describe('WorkspaceInvitationService', () => {\n               .mockReturnValue('https://signed-url.com/logo.png'),\n           },\n         },\n+        {\n+          provide: ThrottlerService,\n+          useValue: {\n+            tokenBucketThrottleOrThrow: jest.fn(),\n+          },\n+        },\n       ],\n     }).compile();\n \ndiff --git a/packages/twenty-server/src/engine/core-modules/workspace-invitation/services/workspace-invitation.service.ts b/packages/twenty-server/src/engine/core-modules/workspace-invitation/services/workspace-invitation.service.ts\nindex df6932a71d5bd..d6acc364997e1 100644\n--- a/packages/twenty-server/src/engine/core-modules/workspace-invitation/services/workspace-invitation.service.ts\n+++ b/packages/twenty-server/src/engine/core-modules/workspace-invitation/services/workspace-invitation.service.ts\n@@ -25,6 +25,7 @@ import { EmailService } from 'src/engine/core-modules/email/email.service';\n import { FileService } from 'src/engine/core-modules/file/services/file.service';\n import { I18nService } from 'src/engine/core-modules/i18n/i18n.service';\n import { OnboardingService } from 'src/engine/core-modules/onboarding/onboarding.service';\n+import { ThrottlerService } from 'src/engine/core-modules/throttler/throttler.service';\n import { TwentyConfigService } from 'src/engine/core-modules/twenty-config/twenty-config.service';\n import { UserWorkspaceEntity } from 'src/engine/core-modules/user-workspace/user-workspace.entity';\n import { type SendInvitationsOutput } from 'src/engine/core-modules/workspace-invitation/dtos/send-invitations.output';\n@@ -49,6 +50,7 @@ export class WorkspaceInvitationService {\n     private readonly workspaceDomainsService: WorkspaceDomainsService,\n     private readonly i18nService: I18nService,\n     private readonly fileService: FileService,\n+    private readonly throttlerService: ThrottlerService,\n   ) {}\n \n   async validatePersonalInvitation({\n@@ -262,6 +264,8 @@ export class WorkspaceInvitationService {\n       };\n     }\n \n+    await this.throttleInvitationSending(workspace.id, emails);\n+\n     const invitationsPr = await Promise.allSettled(\n       emails.map(async (email) => {\n         if (usePersonalInvitation) {\n@@ -421,4 +425,47 @@ export class WorkspaceInvitationService {\n \n     return this.appTokenRepository.save(invitationToken);\n   }\n+\n+  private async throttleInvitationSending(\n+    workspaceId: string,\n+    emails: string[],\n+  ) {\n+    try {\n+      //limit invitation sending for specific invite emails\n+      await Promise.all(\n+        emails.map(async (email) => {\n+          await this.throttlerService.tokenBucketThrottleOrThrow(\n+            `invitation-resending-workspace:throttler:${email}`,\n+            1,\n+            this.twentyConfigService.get(\n+              'INVITATION_SENDING_BY_EMAIL_THROTTLE_LIMIT',\n+            ),\n+            this.twentyConfigService.get(\n+              'INVITATION_SENDING_BY_EMAIL_THROTTLE_TTL_IN_MS',\n+            ),\n+          );\n+        }),\n+      );\n+\n+      //limit invitation sending for a specific workspace\n+      await this.throttlerService.tokenBucketThrottleOrThrow(\n+        `invitation-resending-workspace:throttler:${workspaceId}`,\n+        emails.length,\n+        this.twentyConfigService.get(\n+          'INVITATION_SENDING_BY_WORKSPACE_THROTTLE_LIMIT',\n+        ),\n+        this.twentyConfigService.get(\n+          'INVITATION_SENDING_BY_WORKSPACE_THROTTLE_TTL_IN_MS',\n+        ),\n+      );\n+    } catch {\n+      throw new WorkspaceInvitationException(\n+        'Workspace invitation sending rate limit exceeded.',\n+        WorkspaceInvitationExceptionCode.INVALID_INVITATION,\n+        {\n+          userFriendlyMessage: msg`Too many workspace invitations sent. Please try again later.`,\n+        },\n+      );\n+    }\n+  }\n }\ndiff --git a/packages/twenty-server/src/engine/core-modules/workspace-invitation/workspace-invitation.module.ts b/packages/twenty-server/src/engine/core-modules/workspace-invitation/workspace-invitation.module.ts\nindex becf292d1bc9a..c88b7fef67c0b 100644\n--- a/packages/twenty-server/src/engine/core-modules/workspace-invitation/workspace-invitation.module.ts\n+++ b/packages/twenty-server/src/engine/core-modules/workspace-invitation/workspace-invitation.module.ts\n@@ -7,6 +7,7 @@ import { WorkspaceDomainsModule } from 'src/engine/core-modules/domain/workspace\n import { FeatureFlagModule } from 'src/engine/core-modules/feature-flag/feature-flag.module';\n import { FileModule } from 'src/engine/core-modules/file/file.module';\n import { OnboardingModule } from 'src/engine/core-modules/onboarding/onboarding.module';\n+import { ThrottlerModule } from 'src/engine/core-modules/throttler/throttler.module';\n import { UserWorkspaceEntity } from 'src/engine/core-modules/user-workspace/user-workspace.entity';\n import { WorkspaceInvitationService } from 'src/engine/core-modules/workspace-invitation/services/workspace-invitation.service';\n import { WorkspaceInvitationResolver } from 'src/engine/core-modules/workspace-invitation/workspace-invitation.resolver';\n@@ -25,6 +26,7 @@ import { PermissionsModule } from 'src/engine/metadata-modules/permissions/permi\n     OnboardingModule,\n     PermissionsModule,\n     FeatureFlagModule,\n+    ThrottlerModule,\n   ],\n   exports: [WorkspaceInvitationService],\n   providers: [WorkspaceInvitationService, WorkspaceInvitationResolver],\ndiff --git a/packages/twenty-server/src/engine/core-modules/workspace-invitation/workspace-invitation.resolver.ts b/packages/twenty-server/src/engine/core-modules/workspace-invitation/workspace-invitation.resolver.ts\nindex bc71e5efec1f7..81fdce79036ee 100644\n--- a/packages/twenty-server/src/engine/core-modules/workspace-invitation/workspace-invitation.resolver.ts\n+++ b/packages/twenty-server/src/engine/core-modules/workspace-invitation/workspace-invitation.resolver.ts\n@@ -1,7 +1,6 @@\n import { UseFilters, UseGuards, UsePipes } from '@nestjs/common';\n import { Args, Mutation, Query, Resolver } from '@nestjs/graphql';\n \n-import { FileService } from 'src/engine/core-modules/file/services/file.service';\n import { PreventNestToAutoLogGraphqlErrorsFilter } from 'src/engine/core-modules/graphql/filters/prevent-nest-to-auto-log-graphql-errors.filter';\n import { ResolverValidationPipe } from 'src/engine/core-modules/graphql/pipes/resolver-validation.pipe';\n import { UserEntity } from 'src/engine/core-modules/user/user.entity';\n@@ -35,7 +34,6 @@ export class WorkspaceInvitationResolver {\n   constructor(\n     private readonly twentyORMGlobalManager: TwentyORMGlobalManager,\n     private readonly workspaceInvitationService: WorkspaceInvitationService,\n-    private readonly fileService: FileService,\n   ) {}\n \n   @Mutation(() => String)\n",
        "pr_mirror": "twentyhq__twenty.main"
    }
}