{
    "cost": 0.113405,
    "rewrites": {
        "twentyhq__twenty.main/packages/twenty-server/src/modules/messaging/message-import-manager/drivers/gmail/services/gmail-messages-import-error-handler.service.ts": {
            "output": "import { Injectable, Logger } from '@nestjs/common';\n\nimport {\n  MessageImportDriverException,\n  MessageImportDriverExceptionCode,\n} from 'src/modules/messaging/message-import-manager/drivers/exceptions/message-import-driver.exception';\nimport { isGmailApiBatchError } from 'src/modules/messaging/message-import-manager/drivers/gmail/utils/is-gmail-api-batch-error.util';\nimport { isGmailNetworkError } from 'src/modules/messaging/message-import-manager/drivers/gmail/utils/is-gmail-network-error.util';\nimport { parseGmailApiBatchError } from 'src/modules/messaging/message-import-manager/drivers/gmail/utils/parse-gmail-api-batch-error.util';\nimport { parseGmailNetworkError } from 'src/modules/messaging/message-import-manager/drivers/gmail/utils/parse-gmail-network-error.util';\n\n@Injectable()\nexport class GmailMessagesImportErrorHandler {\n  private readonly logger = new Logger(GmailMessagesImportErrorHandler.name);\n\n  constructor() {}\n\n  public handleError(error: unknown, messageExternalId: string): void {\n    this.logger.error(`Gmail: Error importing messages: ${error}`);\n\n    if (isGmailNetworkError(error)) {\n      throw parseGmailNetworkError(error);\n    }\n\n    if (isGmailApiBatchError(error)) {\n      throw parseGmailApiBatchError(error, messageExternalId);\n    }\n\n    throw new MessageImportDriverException(\n      'Unknown error',\n      MessageImportDriverExceptionCode.UNKNOWN,\n    );\n  }\n}",
            "output_extracted": "import { Injectable, Logger } from '@nestjs/common';\n\nimport {\n  MessageImportDriverException,\n  MessageImportDriverExceptionCode,\n} from 'src/modules/messaging/message-import-manager/drivers/exceptions/message-import-driver.exception';\nimport { isGmailApiBatchError } from 'src/modules/messaging/message-import-manager/drivers/gmail/utils/is-gmail-api-batch-error.util';\nimport { isGmailNetworkError } from 'src/modules/messaging/message-import-manager/drivers/gmail/utils/is-gmail-network-error.util';\nimport { parseGmailApiBatchError } from 'src/modules/messaging/message-import-manager/drivers/gmail/utils/parse-gmail-api-batch-error.util';\nimport { parseGmailNetworkError } from 'src/modules/messaging/message-import-manager/drivers/gmail/utils/parse-gmail-network-error.util';\n\n@Injectable()\nexport class GmailMessagesImportErrorHandler {\n  private readonly logger = new Logger(GmailMessagesImportErrorHandler.name);\n\n  constructor() {}\n\n  public handleError(error: unknown, messageExternalId: string): void {\n    this.logger.error(`Gmail: Error importing messages: ${error}`);\n\n    if (isGmailNetworkError(error)) {\n      throw parseGmailNetworkError(error);\n    }\n\n    if (isGmailApiBatchError(error)) {\n      throw parseGmailApiBatchError(error, messageExternalId);\n    }\n\n    throw new MessageImportDriverException(\n      'Unknown error',\n      MessageImportDriverExceptionCode.UNKNOWN,\n    );\n  }\n}",
            "cost": 0.018520000000000002
        },
        "twentyhq__twenty.main/packages/twenty-server/src/modules/messaging/message-import-manager/drivers/gmail/utils/__tests__/parse-gmail-messages-import-error.spec.ts": {
            "output": "import {\n  MessageImportDriverException,\n  MessageImportDriverExceptionCode,\n} from 'src/modules/messaging/message-import-manager/drivers/exceptions/message-import-driver.exception';\nimport { default as gmailBatchApiErrorMocks } from 'src/modules/messaging/message-import-manager/drivers/gmail/mocks/gmail-batch-api-error-mocks';\nimport { parseGmailApiBatchError } from 'src/modules/messaging/message-import-manager/drivers/gmail/utils/parse-gmail-api-batch-error.util';\n\nconst messageExternalId = '123';\n\ndescribe('parseGmailApiBatchError', () => {\n  it('should handle 400 Bad Request', () => {\n    const error = gmailBatchApiErrorMocks.getError(400);\n    const exception = parseGmailApiBatchError(error, messageExternalId);\n\n    expect(exception).toBeInstanceOf(MessageImportDriverException);\n    expect(exception?.code).toBe(MessageImportDriverExceptionCode.UNKNOWN);\n    expect(exception?.message).toBe(\n      `${error.errors[0].message} for message with externalId: ${messageExternalId}`,\n    );\n  });\n\n  it('should handle 400 Invalid Grant', () => {\n    const error = gmailBatchApiErrorMocks.getError(400, 'invalid_grant');\n    const exception = parseGmailApiBatchError(error, messageExternalId);\n\n    expect(exception).toBeInstanceOf(MessageImportDriverException);\n    expect(exception?.code).toBe(\n      MessageImportDriverExceptionCode.INSUFFICIENT_PERMISSIONS,\n    );\n    expect(exception?.message).toBe(\n      `${error.errors[0].message} for message with externalId: ${messageExternalId}`,\n    );\n  });\n\n  it('should handle 400 Failed Precondition', () => {\n    const error = gmailBatchApiErrorMocks.getError(400, 'failedPrecondition');\n    const exception = parseGmailApiBatchError(error, messageExternalId);\n\n    expect(exception).toBeInstanceOf(MessageImportDriverException);\n    expect(exception?.code).toBe(\n      MessageImportDriverExceptionCode.TEMPORARY_ERROR,\n    );\n  });\n\n  it('should handle 401 Invalid Credentials', () => {\n    const error = gmailBatchApiErrorMocks.getError(401);\n    const exception = parseGmailApiBatchError(error, messageExternalId);\n\n    expect(exception).toBeInstanceOf(MessageImportDriverException);\n    expect(exception?.code).toBe(\n      MessageImportDriverExceptionCode.INSUFFICIENT_PERMISSIONS,\n    );\n    expect(exception?.message).toBe(\n      `${error.errors[0].message} for message with externalId: ${messageExternalId}`,\n    );\n  });\n\n  it('should handle 403 Daily Limit Exceeded', () => {\n    const error = gmailBatchApiErrorMocks.getError(403, 'dailyLimit');\n    const exception = parseGmailApiBatchError(error, messageExternalId);\n\n    expect(exception).toBeInstanceOf(MessageImportDriverException);\n    expect(exception?.code).toBe(\n      MessageImportDriverExceptionCode.TEMPORARY_ERROR,\n    );\n    expect(exception?.message).toBe(\n      `${error.errors[0].message} for message with externalId: ${messageExternalId}`,\n    );\n  });\n\n  it('should handle 403 User Rate Limit Exceeded', () => {\n    const error = gmailBatchApiErrorMocks.getError(403, 'userRateLimit');\n    const exception = parseGmailApiBatchError(error, messageExternalId);\n\n    expect(exception).toBeInstanceOf(MessageImportDriverException);\n    expect(exception?.code).toBe(\n      MessageImportDriverExceptionCode.TEMPORARY_ERROR,\n    );\n    expect(exception?.message).toBe(\n      `${error.errors[0].message} for message with externalId: ${messageExternalId}`,\n    );\n  });\n\n  it('should handle 403 Rate Limit Exceeded', () => {\n    const error = gmailBatchApiErrorMocks.getError(403, 'rateLimit');\n    const exception = parseGmailApiBatchError(error, messageExternalId);\n\n    expect(exception).toBeInstanceOf(MessageImportDriverException);\n    expect(exception?.code).toBe(\n      MessageImportDriverExceptionCode.TEMPORARY_ERROR,\n    );\n    expect(exception?.message).toBe(\n      `${error.errors[0].message} for message with externalId: ${messageExternalId}`,\n    );\n  });\n\n  it('should handle 403 Domain Policy Error', () => {\n    const error = gmailBatchApiErrorMocks.getError(403, 'domainPolicy');\n    const exception = parseGmailApiBatchError(error, messageExternalId);\n\n    expect(exception).toBeInstanceOf(MessageImportDriverException);\n    expect(exception?.code).toBe(\n      MessageImportDriverExceptionCode.INSUFFICIENT_PERMISSIONS,\n    );\n    expect(exception?.message).toBe(\n      `${error.errors[0].message} for message with externalId: ${messageExternalId}`,\n    );\n  });\n\n  it('should handle 404 Not Found', () => {\n    const error = gmailBatchApiErrorMocks.getError(404);\n    const exception = parseGmailApiBatchError(error, messageExternalId);\n\n    expect(exception).toBeInstanceOf(MessageImportDriverException);\n    expect(exception?.code).toBe(\n      MessageImportDriverExceptionCode.SYNC_CURSOR_ERROR,\n    );\n    expect(exception?.message).toBe(\n      `${error.errors[0].message} for message with externalId: ${messageExternalId}`,\n    );\n  });\n\n  it('should handle 410 Gone', () => {\n    const error = gmailBatchApiErrorMocks.getError(410);\n    const exception = parseGmailApiBatchError(error, messageExternalId);\n\n    expect(exception).toBeInstanceOf(MessageImportDriverException);\n    expect(exception?.code).toBe(\n      MessageImportDriverExceptionCode.SYNC_CURSOR_ERROR,\n    );\n    expect(exception?.message).toBe(\n      `${error.errors[0].message} for message with externalId: ${messageExternalId}`,\n    );\n  });\n\n  it('should handle 429 Too Many Requests', () => {\n    const error = gmailBatchApiErrorMocks.getError(429, 'concurrent');\n    const exception = parseGmailApiBatchError(error, messageExternalId);\n\n    expect(exception).toBeInstanceOf(MessageImportDriverException);\n    expect(exception?.code).toBe(\n      MessageImportDriverExceptionCode.TEMPORARY_ERROR,\n    );\n    expect(exception?.message).toBe(\n      `${error.errors[0].message} for message with externalId: ${messageExternalId}`,\n    );\n  });\n\n  it('should handle 500 Backend Error', () => {\n    const error = gmailBatchApiErrorMocks.getError(500);\n    const exception = parseGmailApiBatchError(error, messageExternalId);\n\n    expect(exception).toBeInstanceOf(MessageImportDriverException);\n    expect(exception?.code).toBe(\n      MessageImportDriverExceptionCode.TEMPORARY_ERROR,\n    );\n    expect(exception?.message).toBe(\n      `${error.errors[0].message} for message with externalId: ${messageExternalId}`,\n    );\n  });\n});",
            "output_extracted": "import {\n  MessageImportDriverException,\n  MessageImportDriverExceptionCode,\n} from 'src/modules/messaging/message-import-manager/drivers/exceptions/message-import-driver.exception';\nimport { default as gmailBatchApiErrorMocks } from 'src/modules/messaging/message-import-manager/drivers/gmail/mocks/gmail-batch-api-error-mocks';\nimport { parseGmailApiBatchError } from 'src/modules/messaging/message-import-manager/drivers/gmail/utils/parse-gmail-api-batch-error.util';\n\nconst messageExternalId = '123';\n\ndescribe('parseGmailApiBatchError', () => {\n  it('should handle 400 Bad Request', () => {\n    const error = gmailBatchApiErrorMocks.getError(400);\n    const exception = parseGmailApiBatchError(error, messageExternalId);\n\n    expect(exception).toBeInstanceOf(MessageImportDriverException);\n    expect(exception?.code).toBe(MessageImportDriverExceptionCode.UNKNOWN);\n    expect(exception?.message).toBe(\n      `${error.errors[0].message} for message with externalId: ${messageExternalId}`,\n    );\n  });\n\n  it('should handle 400 Invalid Grant', () => {\n    const error = gmailBatchApiErrorMocks.getError(400, 'invalid_grant');\n    const exception = parseGmailApiBatchError(error, messageExternalId);\n\n    expect(exception).toBeInstanceOf(MessageImportDriverException);\n    expect(exception?.code).toBe(\n      MessageImportDriverExceptionCode.INSUFFICIENT_PERMISSIONS,\n    );\n    expect(exception?.message).toBe(\n      `${error.errors[0].message} for message with externalId: ${messageExternalId}`,\n    );\n  });\n\n  it('should handle 400 Failed Precondition', () => {\n    const error = gmailBatchApiErrorMocks.getError(400, 'failedPrecondition');\n    const exception = parseGmailApiBatchError(error, messageExternalId);\n\n    expect(exception).toBeInstanceOf(MessageImportDriverException);\n    expect(exception?.code).toBe(\n      MessageImportDriverExceptionCode.TEMPORARY_ERROR,\n    );\n  });\n\n  it('should handle 401 Invalid Credentials', () => {\n    const error = gmailBatchApiErrorMocks.getError(401);\n    const exception = parseGmailApiBatchError(error, messageExternalId);\n\n    expect(exception).toBeInstanceOf(MessageImportDriverException);\n    expect(exception?.code).toBe(\n      MessageImportDriverExceptionCode.INSUFFICIENT_PERMISSIONS,\n    );\n    expect(exception?.message).toBe(\n      `${error.errors[0].message} for message with externalId: ${messageExternalId}`,\n    );\n  });\n\n  it('should handle 403 Daily Limit Exceeded', () => {\n    const error = gmailBatchApiErrorMocks.getError(403, 'dailyLimit');\n    const exception = parseGmailApiBatchError(error, messageExternalId);\n\n    expect(exception).toBeInstanceOf(MessageImportDriverException);\n    expect(exception?.code).toBe(\n      MessageImportDriverExceptionCode.TEMPORARY_ERROR,\n    );\n    expect(exception?.message).toBe(\n      `${error.errors[0].message} for message with externalId: ${messageExternalId}`,\n    );\n  });\n\n  it('should handle 403 User Rate Limit Exceeded', () => {\n    const error = gmailBatchApiErrorMocks.getError(403, 'userRateLimit');\n    const exception = parseGmailApiBatchError(error, messageExternalId);\n\n    expect(exception).toBeInstanceOf(MessageImportDriverException);\n    expect(exception?.code).toBe(\n      MessageImportDriverExceptionCode.TEMPORARY_ERROR,\n    );\n    expect(exception?.message).toBe(\n      `${error.errors[0].message} for message with externalId: ${messageExternalId}`,\n    );\n  });\n\n  it('should handle 403 Rate Limit Exceeded', () => {\n    const error = gmailBatchApiErrorMocks.getError(403, 'rateLimit');\n    const exception = parseGmailApiBatchError(error, messageExternalId);\n\n    expect(exception).toBeInstanceOf(MessageImportDriverException);\n    expect(exception?.code).toBe(\n      MessageImportDriverExceptionCode.TEMPORARY_ERROR,\n    );\n    expect(exception?.message).toBe(\n      `${error.errors[0].message} for message with externalId: ${messageExternalId}`,\n    );\n  });\n\n  it('should handle 403 Domain Policy Error', () => {\n    const error = gmailBatchApiErrorMocks.getError(403, 'domainPolicy');\n    const exception = parseGmailApiBatchError(error, messageExternalId);\n\n    expect(exception).toBeInstanceOf(MessageImportDriverException);\n    expect(exception?.code).toBe(\n      MessageImportDriverExceptionCode.INSUFFICIENT_PERMISSIONS,\n    );\n    expect(exception?.message).toBe(\n      `${error.errors[0].message} for message with externalId: ${messageExternalId}`,\n    );\n  });\n\n  it('should handle 404 Not Found', () => {\n    const error = gmailBatchApiErrorMocks.getError(404);\n    const exception = parseGmailApiBatchError(error, messageExternalId);\n\n    expect(exception).toBeInstanceOf(MessageImportDriverException);\n    expect(exception?.code).toBe(\n      MessageImportDriverExceptionCode.SYNC_CURSOR_ERROR,\n    );\n    expect(exception?.message).toBe(\n      `${error.errors[0].message} for message with externalId: ${messageExternalId}`,\n    );\n  });\n\n  it('should handle 410 Gone', () => {\n    const error = gmailBatchApiErrorMocks.getError(410);\n    const exception = parseGmailApiBatchError(error, messageExternalId);\n\n    expect(exception).toBeInstanceOf(MessageImportDriverException);\n    expect(exception?.code).toBe(\n      MessageImportDriverExceptionCode.SYNC_CURSOR_ERROR,\n    );\n    expect(exception?.message).toBe(\n      `${error.errors[0].message} for message with externalId: ${messageExternalId}`,\n    );\n  });\n\n  it('should handle 429 Too Many Requests', () => {\n    const error = gmailBatchApiErrorMocks.getError(429, 'concurrent');\n    const exception = parseGmailApiBatchError(error, messageExternalId);\n\n    expect(exception).toBeInstanceOf(MessageImportDriverException);\n    expect(exception?.code).toBe(\n      MessageImportDriverExceptionCode.TEMPORARY_ERROR,\n    );\n    expect(exception?.message).toBe(\n      `${error.errors[0].message} for message with externalId: ${messageExternalId}`,\n    );\n  });\n\n  it('should handle 500 Backend Error', () => {\n    const error = gmailBatchApiErrorMocks.getError(500);\n    const exception = parseGmailApiBatchError(error, messageExternalId);\n\n    expect(exception).toBeInstanceOf(MessageImportDriverException);\n    expect(exception?.code).toBe(\n      MessageImportDriverExceptionCode.TEMPORARY_ERROR,\n    );\n    expect(exception?.message).toBe(\n      `${error.errors[0].message} for message with externalId: ${messageExternalId}`,\n    );\n  });\n});",
            "cost": 0.063305
        },
        "twentyhq__twenty.main/packages/twenty-server/src/modules/messaging/message-import-manager/drivers/gmail/utils/parse-gmail-api-batch-error.util.ts": {
            "output": "import {\n  MessageImportDriverException,\n  MessageImportDriverExceptionCode,\n} from 'src/modules/messaging/message-import-manager/drivers/exceptions/message-import-driver.exception';\nimport { type GmailApiBatchError } from 'src/modules/messaging/message-import-manager/drivers/gmail/types/gmail-api-batch-error.type';\n\nexport const parseGmailApiBatchError = (\n  error: GmailApiBatchError,\n  messageExternalId?: string,\n): MessageImportDriverException | undefined => {\n  const { code, errors } = error;\n\n  const reason = errors?.[0]?.reason;\n  const originalMessage = errors?.[0]?.message;\n  const message = `${errors?.[0]?.message} for message with externalId: ${messageExternalId}`;\n\n  switch (code) {\n    case 400:\n      if (reason === 'invalid_grant') {\n        return new MessageImportDriverException(\n          message,\n          MessageImportDriverExceptionCode.INSUFFICIENT_PERMISSIONS,\n        );\n      }\n      if (reason === 'failedPrecondition') {\n        if (originalMessage.includes('Mail service not enabled')) {\n          return new MessageImportDriverException(\n            message,\n            MessageImportDriverExceptionCode.INSUFFICIENT_PERMISSIONS,\n          );\n        }\n\n        return new MessageImportDriverException(\n          message,\n          MessageImportDriverExceptionCode.TEMPORARY_ERROR,\n        );\n      }\n\n      return new MessageImportDriverException(\n        message,\n        MessageImportDriverExceptionCode.UNKNOWN,\n      );\n\n    case 404:\n    case 410:\n      return new MessageImportDriverException(\n        message,\n        MessageImportDriverExceptionCode.SYNC_CURSOR_ERROR,\n      );\n\n    case 429:\n      return new MessageImportDriverException(\n        message,\n        MessageImportDriverExceptionCode.TEMPORARY_ERROR,\n      );\n\n    case 403:\n      if (\n        reason === 'rateLimitExceeded' ||\n        reason === 'userRateLimitExceeded' ||\n        reason === 'dailyLimitExceeded'\n      ) {\n        return new MessageImportDriverException(\n          message,\n          MessageImportDriverExceptionCode.TEMPORARY_ERROR,\n        );\n      }\n      if (reason === 'domainPolicy') {\n        return new MessageImportDriverException(\n          message,\n          MessageImportDriverExceptionCode.INSUFFICIENT_PERMISSIONS,\n        );\n      }\n\n      break;\n\n    case 401:\n      return new MessageImportDriverException(\n        message,\n        MessageImportDriverExceptionCode.INSUFFICIENT_PERMISSIONS,\n      );\n\n    case 503:\n      return new MessageImportDriverException(\n        message,\n        MessageImportDriverExceptionCode.TEMPORARY_ERROR,\n      );\n\n    case 500:\n    case 502:\n    case 504:\n      if (reason === 'backendError') {\n        return new MessageImportDriverException(\n          message,\n          MessageImportDriverExceptionCode.TEMPORARY_ERROR,\n        );\n      }\n\n      if (errors?.[0]?.message.includes(`Authentication backend unavailable`)) {\n        return new MessageImportDriverException(\n          `${code} - ${reason} - ${message}`,\n          MessageImportDriverExceptionCode.TEMPORARY_ERROR,\n        );\n      }\n      break;\n\n    default:\n      break;\n  }\n\n  return new MessageImportDriverException(\n    message,\n    MessageImportDriverExceptionCode.UNKNOWN,\n  );\n};",
            "output_extracted": "import {\n  MessageImportDriverException,\n  MessageImportDriverExceptionCode,\n} from 'src/modules/messaging/message-import-manager/drivers/exceptions/message-import-driver.exception';\nimport { type GmailApiBatchError } from 'src/modules/messaging/message-import-manager/drivers/gmail/types/gmail-api-batch-error.type';\n\nexport const parseGmailApiBatchError = (\n  error: GmailApiBatchError,\n  messageExternalId?: string,\n): MessageImportDriverException | undefined => {\n  const { code, errors } = error;\n\n  const reason = errors?.[0]?.reason;\n  const originalMessage = errors?.[0]?.message;\n  const message = `${errors?.[0]?.message} for message with externalId: ${messageExternalId}`;\n\n  switch (code) {\n    case 400:\n      if (reason === 'invalid_grant') {\n        return new MessageImportDriverException(\n          message,\n          MessageImportDriverExceptionCode.INSUFFICIENT_PERMISSIONS,\n        );\n      }\n      if (reason === 'failedPrecondition') {\n        if (originalMessage.includes('Mail service not enabled')) {\n          return new MessageImportDriverException(\n            message,\n            MessageImportDriverExceptionCode.INSUFFICIENT_PERMISSIONS,\n          );\n        }\n\n        return new MessageImportDriverException(\n          message,\n          MessageImportDriverExceptionCode.TEMPORARY_ERROR,\n        );\n      }\n\n      return new MessageImportDriverException(\n        message,\n        MessageImportDriverExceptionCode.UNKNOWN,\n      );\n\n    case 404:\n    case 410:\n      return new MessageImportDriverException(\n        message,\n        MessageImportDriverExceptionCode.SYNC_CURSOR_ERROR,\n      );\n\n    case 429:\n      return new MessageImportDriverException(\n        message,\n        MessageImportDriverExceptionCode.TEMPORARY_ERROR,\n      );\n\n    case 403:\n      if (\n        reason === 'rateLimitExceeded' ||\n        reason === 'userRateLimitExceeded' ||\n        reason === 'dailyLimitExceeded'\n      ) {\n        return new MessageImportDriverException(\n          message,\n          MessageImportDriverExceptionCode.TEMPORARY_ERROR,\n        );\n      }\n      if (reason === 'domainPolicy') {\n        return new MessageImportDriverException(\n          message,\n          MessageImportDriverExceptionCode.INSUFFICIENT_PERMISSIONS,\n        );\n      }\n\n      break;\n\n    case 401:\n      return new MessageImportDriverException(\n        message,\n        MessageImportDriverExceptionCode.INSUFFICIENT_PERMISSIONS,\n      );\n\n    case 503:\n      return new MessageImportDriverException(\n        message,\n        MessageImportDriverExceptionCode.TEMPORARY_ERROR,\n      );\n\n    case 500:\n    case 502:\n    case 504:\n      if (reason === 'backendError') {\n        return new MessageImportDriverException(\n          message,\n          MessageImportDriverExceptionCode.TEMPORARY_ERROR,\n        );\n      }\n\n      if (errors?.[0]?.message.includes(`Authentication backend unavailable`)) {\n        return new MessageImportDriverException(\n          `${code} - ${reason} - ${message}`,\n          MessageImportDriverExceptionCode.TEMPORARY_ERROR,\n        );\n      }\n      break;\n\n    default:\n      break;\n  }\n\n  return new MessageImportDriverException(\n    message,\n    MessageImportDriverExceptionCode.UNKNOWN,\n  );\n};",
            "cost": 0.031580000000000004
        }
    },
    "recover_status": "success",
    "instance_ref": {
        "instance_id": "twentyhq__twenty.main.16112",
        "repo": "twentyhq/twenty",
        "base_commit": "5d1c2a33480540375b70ef3e1199ca8afac22e3a",
        "head_commit": "fcdcddda7e24bc6e9d32af19164374a9951bdcf6",
        "title": "Fix messaging import",
        "merged_at": "2025-11-26T22:13:12Z",
        "html_url": "https://github.com/twentyhq/twenty/pull/16112",
        "test_files": [
            "packages/twenty-server/src/modules/messaging/message-import-manager/drivers/gmail/utils/__tests__/parse-gmail-messages-import-error.spec.ts"
        ],
        "code_files": [
            "packages/twenty-server/src/modules/messaging/message-import-manager/drivers/gmail/services/gmail-messages-import-error-handler.service.ts",
            "packages/twenty-server/src/modules/messaging/message-import-manager/drivers/gmail/utils/parse-gmail-api-batch-error.util.ts"
        ],
        "total_changes": 31,
        "num_files": 3,
        "pull_number": 16112,
        "patch": "diff --git a/packages/twenty-server/src/modules/messaging/message-import-manager/drivers/gmail/services/gmail-messages-import-error-handler.service.ts b/packages/twenty-server/src/modules/messaging/message-import-manager/drivers/gmail/services/gmail-messages-import-error-handler.service.ts\nindex 9ab22c68174b2..569820634aa07 100644\n--- a/packages/twenty-server/src/modules/messaging/message-import-manager/drivers/gmail/services/gmail-messages-import-error-handler.service.ts\n+++ b/packages/twenty-server/src/modules/messaging/message-import-manager/drivers/gmail/services/gmail-messages-import-error-handler.service.ts\n@@ -1,5 +1,7 @@\n import { Injectable, Logger } from '@nestjs/common';\n \n+import { isDefined } from 'twenty-shared/utils';\n+\n import {\n   MessageImportDriverException,\n   MessageImportDriverExceptionCode,\n@@ -23,7 +25,13 @@ export class GmailMessagesImportErrorHandler {\n     }\n \n     if (isGmailApiBatchError(error)) {\n-      throw parseGmailApiBatchError(error, messageExternalId);\n+      const exception = parseGmailApiBatchError(error, messageExternalId);\n+\n+      if (!isDefined(exception)) {\n+        return;\n+      }\n+\n+      throw exception;\n     }\n \n     throw new MessageImportDriverException(\ndiff --git a/packages/twenty-server/src/modules/messaging/message-import-manager/drivers/gmail/utils/__tests__/parse-gmail-messages-import-error.spec.ts b/packages/twenty-server/src/modules/messaging/message-import-manager/drivers/gmail/utils/__tests__/parse-gmail-messages-import-error.spec.ts\nindex 6f2b99524bb59..bd1c44455eda8 100644\n--- a/packages/twenty-server/src/modules/messaging/message-import-manager/drivers/gmail/utils/__tests__/parse-gmail-messages-import-error.spec.ts\n+++ b/packages/twenty-server/src/modules/messaging/message-import-manager/drivers/gmail/utils/__tests__/parse-gmail-messages-import-error.spec.ts\n@@ -111,26 +111,14 @@ describe('parseGmailApiBatchError', () => {\n     const error = gmailBatchApiErrorMocks.getError(404);\n     const exception = parseGmailApiBatchError(error, messageExternalId);\n \n-    expect(exception).toBeInstanceOf(MessageImportDriverException);\n-    expect(exception?.code).toBe(\n-      MessageImportDriverExceptionCode.SYNC_CURSOR_ERROR,\n-    );\n-    expect(exception?.message).toBe(\n-      `${error.errors[0].message} for message with externalId: ${messageExternalId}`,\n-    );\n+    expect(exception).toBeUndefined();\n   });\n \n   it('should handle 410 Gone', () => {\n     const error = gmailBatchApiErrorMocks.getError(410);\n     const exception = parseGmailApiBatchError(error, messageExternalId);\n \n-    expect(exception).toBeInstanceOf(MessageImportDriverException);\n-    expect(exception?.code).toBe(\n-      MessageImportDriverExceptionCode.SYNC_CURSOR_ERROR,\n-    );\n-    expect(exception?.message).toBe(\n-      `${error.errors[0].message} for message with externalId: ${messageExternalId}`,\n-    );\n+    expect(exception).toBeUndefined();\n   });\n \n   it('should handle 429 Too Many Requests', () => {\ndiff --git a/packages/twenty-server/src/modules/messaging/message-import-manager/drivers/gmail/utils/parse-gmail-api-batch-error.util.ts b/packages/twenty-server/src/modules/messaging/message-import-manager/drivers/gmail/utils/parse-gmail-api-batch-error.util.ts\nindex 1314e8e72a0f3..f2d9755bfdc75 100644\n--- a/packages/twenty-server/src/modules/messaging/message-import-manager/drivers/gmail/utils/parse-gmail-api-batch-error.util.ts\n+++ b/packages/twenty-server/src/modules/messaging/message-import-manager/drivers/gmail/utils/parse-gmail-api-batch-error.util.ts\n@@ -43,10 +43,7 @@ export const parseGmailApiBatchError = (\n \n     case 404:\n     case 410:\n-      return new MessageImportDriverException(\n-        message,\n-        MessageImportDriverExceptionCode.SYNC_CURSOR_ERROR,\n-      );\n+      return undefined;\n \n     case 429:\n       return new MessageImportDriverException(\n",
        "pr_mirror": "twentyhq__twenty.main"
    }
}