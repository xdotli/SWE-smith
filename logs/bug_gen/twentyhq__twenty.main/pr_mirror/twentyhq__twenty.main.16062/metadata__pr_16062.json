{
    "cost": 0.22976000000000002,
    "rewrites": {
        "twentyhq__twenty.main/packages/twenty-server/src/modules/messaging/message-import-manager/messaging-import-manager.module.ts": {
            "output": "import { Module } from '@nestjs/common';\nimport { TypeOrmModule } from '@nestjs/typeorm';\n\nimport { FeatureFlagModule } from 'src/engine/core-modules/feature-flag/feature-flag.module';\nimport { WorkspaceEntity } from 'src/engine/core-modules/workspace/workspace.entity';\nimport { DataSourceEntity } from 'src/engine/metadata-modules/data-source/data-source.entity';\nimport { ObjectMetadataEntity } from 'src/engine/metadata-modules/object-metadata/object-metadata.entity';\nimport { WorkspaceDataSourceModule } from 'src/engine/workspace-datasource/workspace-datasource.module';\nimport { WorkspaceEventEmitterModule } from 'src/engine/workspace-event-emitter/workspace-event-emitter.module';\nimport { ConnectedAccountModule } from 'src/modules/connected-account/connected-account.module';\nimport { EmailAliasManagerModule } from 'src/modules/connected-account/email-alias-manager/email-alias-manager.module';\nimport { OAuth2ClientManagerModule } from 'src/modules/connected-account/oauth2-client-manager/oauth2-client-manager.module';\nimport { RefreshTokensManagerModule } from 'src/modules/connected-account/refresh-tokens-manager/connected-account-refresh-tokens-manager.module';\nimport { MessagingCommonModule } from 'src/modules/messaging/common/messaging-common.module';\nimport { MessagingMessageCleanerModule } from 'src/modules/messaging/message-cleaner/messaging-message-cleaner.module';\nimport { MessagingFolderSyncManagerModule } from 'src/modules/messaging/message-folder-manager/messaging-folder-sync-manager.module';\nimport { MessagingSingleMessageImportCommand } from 'src/modules/messaging/message-import-manager/commands/messaging-single-message-import.command';\nimport { MessagingMessageListFetchCronCommand } from 'src/modules/messaging/message-import-manager/crons/commands/messaging-message-list-fetch.cron.command';\nimport { MessagingMessagesImportCronCommand } from 'src/modules/messaging/message-import-manager/crons/commands/messaging-messages-import.cron.command';\nimport { MessagingOngoingStaleCronCommand } from 'src/modules/messaging/message-import-manager/crons/commands/messaging-ongoing-stale.cron.command';\nimport { MessagingProcessFolderActionsCronCommand } from 'src/modules/messaging/message-import-manager/crons/commands/messaging-process-folder-actions.cron.command';\nimport { MessagingRelaunchFailedMessageChannelsCronCommand } from 'src/modules/messaging/message-import-manager/crons/commands/messaging-relaunch-failed-message-channels.cron.command';\nimport { MessagingMessageListFetchCronJob } from 'src/modules/messaging/message-import-manager/crons/jobs/messaging-message-list-fetch.cron.job';\nimport { MessagingMessagesImportCronJob } from 'src/modules/messaging/message-import-manager/crons/jobs/messaging-messages-import.cron.job';\nimport { MessagingOngoingStaleCronJob } from 'src/modules/messaging/message-import-manager/crons/jobs/messaging-ongoing-stale.cron.job';\nimport { MessagingProcessFolderActionsCronJob } from 'src/modules/messaging/message-import-manager/crons/jobs/messaging-process-folder-actions.cron.job';\nimport { MessagingRelaunchFailedMessageChannelsCronJob } from 'src/modules/messaging/message-import-manager/crons/jobs/messaging-relaunch-failed-message-channels.cron.job';\nimport { MessagingGmailDriverModule } from 'src/modules/messaging/message-import-manager/drivers/gmail/messaging-gmail-driver.module';\nimport { MessagingIMAPDriverModule } from 'src/modules/messaging/message-import-manager/drivers/imap/messaging-imap-driver.module';\nimport { MessagingMicrosoftDriverModule } from 'src/modules/messaging/message-import-manager/drivers/microsoft/messaging-microsoft-driver.module';\nimport { MessagingSmtpDriverModule } from 'src/modules/messaging/message-import-manager/drivers/smtp/messaging-smtp-driver.module';\nimport { MessagingAddSingleMessageToCacheForImportJob } from 'src/modules/messaging/message-import-manager/jobs/messaging-add-single-message-to-cache-for-import.job';\nimport { MessagingCleanCacheJob } from 'src/modules/messaging/message-import-manager/jobs/messaging-clean-cache';\nimport { MessagingMessageListFetchJob } from 'src/modules/messaging/message-import-manager/jobs/messaging-message-list-fetch.job';\nimport { MessagingMessagesImportJob } from 'src/modules/messaging/message-import-manager/jobs/messaging-messages-import.job';\nimport { MessagingOngoingStaleJob } from 'src/modules/messaging/message-import-manager/jobs/messaging-ongoing-stale.job';\nimport { MessagingProcessFolderActionsJob } from 'src/modules/messaging/message-import-manager/jobs/messaging-process-folder-actions.job';\nimport { MessagingRelaunchFailedMessageChannelJob } from 'src/modules/messaging/message-import-manager/jobs/messaging-relaunch-failed-message-channel.job';\nimport { MessagingMessageImportManagerMessageChannelListener } from 'src/modules/messaging/message-import-manager/listeners/messaging-import-manager-message-channel.listener';\nimport { MessagingAccountAuthenticationService } from 'src/modules/messaging/message-import-manager/services/messaging-account-authentication.service';\nimport { MessagingCursorService } from 'src/modules/messaging/message-import-manager/services/messaging-cursor.service';\nimport { MessagingDeleteFolderMessagesService } from 'src/modules/messaging/message-import-manager/services/messaging-delete-folder-messages.service';\nimport { MessagingDeleteGroupEmailMessagesService } from 'src/modules/messaging/message-import-manager/services/messaging-delete-group-email-messages.service';\nimport { MessagingGetMessageListService } from 'src/modules/messaging/message-import-manager/services/messaging-get-message-list.service';\nimport { MessagingGetMessagesService } from 'src/modules/messaging/message-import-manager/services/messaging-get-messages.service';\nimport { MessageImportExceptionHandlerService } from 'src/modules/messaging/message-import-manager/services/messaging-import-exception-handler.service';\nimport { MessagingMessageListFetchService } from 'src/modules/messaging/message-import-manager/services/messaging-message-list-fetch.service';\nimport { MessagingMessageService } from 'src/modules/messaging/message-import-manager/services/messaging-message.service';\nimport { MessagingMessagesImportService } from 'src/modules/messaging/message-import-manager/services/messaging-messages-import.service';\nimport { MessagingProcessFolderActionsService } from 'src/modules/messaging/message-import-manager/services/messaging-process-folder-actions.service';\nimport { MessagingProcessGroupEmailActionsService } from 'src/modules/messaging/message-import-manager/services/messaging-process-group-email-actions.service';\nimport { MessagingSaveMessagesAndEnqueueContactCreationService } from 'src/modules/messaging/message-import-manager/services/messaging-save-messages-and-enqueue-contact-creation.service';\nimport { MessagingSendMessageService } from 'src/modules/messaging/message-import-manager/services/messaging-send-message.service';\nimport { MessageParticipantManagerModule } from 'src/modules/messaging/message-participant-manager/message-participant-manager.module';\nimport { MessagingMonitoringModule } from 'src/modules/messaging/monitoring/messaging-monitoring.module';\n@Module({\n  imports: [\n    RefreshTokensManagerModule,\n    WorkspaceDataSourceModule,\n    OAuth2ClientManagerModule,\n    MessagingGmailDriverModule,\n    MessagingMicrosoftDriverModule,\n    MessagingIMAPDriverModule,\n    MessagingSmtpDriverModule,\n    MessagingCommonModule,\n    TypeOrmModule.forFeature([\n      WorkspaceEntity,\n      DataSourceEntity,\n      ObjectMetadataEntity,\n    ]),\n    EmailAliasManagerModule,\n    FeatureFlagModule,\n    MessageParticipantManagerModule,\n    MessagingFolderSyncManagerModule,\n    MessagingMonitoringModule,\n    MessagingMessageCleanerModule,\n    WorkspaceEventEmitterModule,\n    ConnectedAccountModule,\n  ],\n  providers: [\n    MessagingMessageListFetchCronCommand,\n    MessagingMessagesImportCronCommand,\n    MessagingOngoingStaleCronCommand,\n    MessagingProcessFolderActionsCronCommand,\n    MessagingRelaunchFailedMessageChannelsCronCommand,\n    MessagingSingleMessageImportCommand,\n    MessagingMessageListFetchJob,\n    MessagingMessagesImportJob,\n    MessagingOngoingStaleJob,\n    MessagingProcessFolderActionsJob,\n    MessagingRelaunchFailedMessageChannelJob,\n    MessagingMessageListFetchCronJob,\n    MessagingMessagesImportCronJob,\n    MessagingOngoingStaleCronJob,\n    MessagingProcessFolderActionsCronJob,\n    MessagingRelaunchFailedMessageChannelsCronJob,\n    MessagingAddSingleMessageToCacheForImportJob,\n    MessagingMessageImportManagerMessageChannelListener,\n    MessagingCleanCacheJob,\n    MessagingMessageService,\n    MessagingMessageListFetchService,\n    MessagingMessagesImportService,\n    MessagingSaveMessagesAndEnqueueContactCreationService,\n    MessagingGetMessageListService,\n    MessagingGetMessagesService,\n    MessageImportExceptionHandlerService,\n    MessagingCursorService,\n    MessagingSendMessageService,\n    MessagingAccountAuthenticationService,\n    MessagingProcessFolderActionsService,\n    MessagingProcessGroupEmailActionsService,\n    MessagingDeleteFolderMessagesService,\n    MessagingDeleteGroupEmailMessagesService,\n  ],\n  exports: [\n    MessagingSendMessageService,\n    MessagingMessageListFetchCronCommand,\n    MessagingMessagesImportCronCommand,\n    MessagingOngoingStaleCronCommand,\n    MessagingRelaunchFailedMessageChannelsCronCommand,\n    MessagingProcessGroupEmailActionsService,\n  ],\n})\nexport class MessagingImportManagerModule {}",
            "output_extracted": "import { Module } from '@nestjs/common';\nimport { TypeOrmModule } from '@nestjs/typeorm';\n\nimport { FeatureFlagModule } from 'src/engine/core-modules/feature-flag/feature-flag.module';\nimport { WorkspaceEntity } from 'src/engine/core-modules/workspace/workspace.entity';\nimport { DataSourceEntity } from 'src/engine/metadata-modules/data-source/data-source.entity';\nimport { ObjectMetadataEntity } from 'src/engine/metadata-modules/object-metadata/object-metadata.entity';\nimport { WorkspaceDataSourceModule } from 'src/engine/workspace-datasource/workspace-datasource.module';\nimport { WorkspaceEventEmitterModule } from 'src/engine/workspace-event-emitter/workspace-event-emitter.module';\nimport { ConnectedAccountModule } from 'src/modules/connected-account/connected-account.module';\nimport { EmailAliasManagerModule } from 'src/modules/connected-account/email-alias-manager/email-alias-manager.module';\nimport { OAuth2ClientManagerModule } from 'src/modules/connected-account/oauth2-client-manager/oauth2-client-manager.module';\nimport { RefreshTokensManagerModule } from 'src/modules/connected-account/refresh-tokens-manager/connected-account-refresh-tokens-manager.module';\nimport { MessagingCommonModule } from 'src/modules/messaging/common/messaging-common.module';\nimport { MessagingMessageCleanerModule } from 'src/modules/messaging/message-cleaner/messaging-message-cleaner.module';\nimport { MessagingFolderSyncManagerModule } from 'src/modules/messaging/message-folder-manager/messaging-folder-sync-manager.module';\nimport { MessagingSingleMessageImportCommand } from 'src/modules/messaging/message-import-manager/commands/messaging-single-message-import.command';\nimport { MessagingMessageListFetchCronCommand } from 'src/modules/messaging/message-import-manager/crons/commands/messaging-message-list-fetch.cron.command';\nimport { MessagingMessagesImportCronCommand } from 'src/modules/messaging/message-import-manager/crons/commands/messaging-messages-import.cron.command';\nimport { MessagingOngoingStaleCronCommand } from 'src/modules/messaging/message-import-manager/crons/commands/messaging-ongoing-stale.cron.command';\nimport { MessagingProcessFolderActionsCronCommand } from 'src/modules/messaging/message-import-manager/crons/commands/messaging-process-folder-actions.cron.command';\nimport { MessagingRelaunchFailedMessageChannelsCronCommand } from 'src/modules/messaging/message-import-manager/crons/commands/messaging-relaunch-failed-message-channels.cron.command';\nimport { MessagingMessageListFetchCronJob } from 'src/modules/messaging/message-import-manager/crons/jobs/messaging-message-list-fetch.cron.job';\nimport { MessagingMessagesImportCronJob } from 'src/modules/messaging/message-import-manager/crons/jobs/messaging-messages-import.cron.job';\nimport { MessagingOngoingStaleCronJob } from 'src/modules/messaging/message-import-manager/crons/jobs/messaging-ongoing-stale.cron.job';\nimport { MessagingProcessFolderActionsCronJob } from 'src/modules/messaging/message-import-manager/crons/jobs/messaging-process-folder-actions.cron.job';\nimport { MessagingRelaunchFailedMessageChannelsCronJob } from 'src/modules/messaging/message-import-manager/crons/jobs/messaging-relaunch-failed-message-channels.cron.job';\nimport { MessagingGmailDriverModule } from 'src/modules/messaging/message-import-manager/drivers/gmail/messaging-gmail-driver.module';\nimport { MessagingIMAPDriverModule } from 'src/modules/messaging/message-import-manager/drivers/imap/messaging-imap-driver.module';\nimport { MessagingMicrosoftDriverModule } from 'src/modules/messaging/message-import-manager/drivers/microsoft/messaging-microsoft-driver.module';\nimport { MessagingSmtpDriverModule } from 'src/modules/messaging/message-import-manager/drivers/smtp/messaging-smtp-driver.module';\nimport { MessagingAddSingleMessageToCacheForImportJob } from 'src/modules/messaging/message-import-manager/jobs/messaging-add-single-message-to-cache-for-import.job';\nimport { MessagingCleanCacheJob } from 'src/modules/messaging/message-import-manager/jobs/messaging-clean-cache';\nimport { MessagingMessageListFetchJob } from 'src/modules/messaging/message-import-manager/jobs/messaging-message-list-fetch.job';\nimport { MessagingMessagesImportJob } from 'src/modules/messaging/message-import-manager/jobs/messaging-messages-import.job';\nimport { MessagingOngoingStaleJob } from 'src/modules/messaging/message-import-manager/jobs/messaging-ongoing-stale.job';\nimport { MessagingProcessFolderActionsJob } from 'src/modules/messaging/message-import-manager/jobs/messaging-process-folder-actions.job';\nimport { MessagingRelaunchFailedMessageChannelJob } from 'src/modules/messaging/message-import-manager/jobs/messaging-relaunch-failed-message-channel.job';\nimport { MessagingMessageImportManagerMessageChannelListener } from 'src/modules/messaging/message-import-manager/listeners/messaging-import-manager-message-channel.listener';\nimport { MessagingAccountAuthenticationService } from 'src/modules/messaging/message-import-manager/services/messaging-account-authentication.service';\nimport { MessagingCursorService } from 'src/modules/messaging/message-import-manager/services/messaging-cursor.service';\nimport { MessagingDeleteFolderMessagesService } from 'src/modules/messaging/message-import-manager/services/messaging-delete-folder-messages.service';\nimport { MessagingDeleteGroupEmailMessagesService } from 'src/modules/messaging/message-import-manager/services/messaging-delete-group-email-messages.service';\nimport { MessagingGetMessageListService } from 'src/modules/messaging/message-import-manager/services/messaging-get-message-list.service';\nimport { MessagingGetMessagesService } from 'src/modules/messaging/message-import-manager/services/messaging-get-messages.service';\nimport { MessageImportExceptionHandlerService } from 'src/modules/messaging/message-import-manager/services/messaging-import-exception-handler.service';\nimport { MessagingMessageListFetchService } from 'src/modules/messaging/message-import-manager/services/messaging-message-list-fetch.service';\nimport { MessagingMessageService } from 'src/modules/messaging/message-import-manager/services/messaging-message.service';\nimport { MessagingMessagesImportService } from 'src/modules/messaging/message-import-manager/services/messaging-messages-import.service';\nimport { MessagingProcessFolderActionsService } from 'src/modules/messaging/message-import-manager/services/messaging-process-folder-actions.service';\nimport { MessagingProcessGroupEmailActionsService } from 'src/modules/messaging/message-import-manager/services/messaging-process-group-email-actions.service';\nimport { MessagingSaveMessagesAndEnqueueContactCreationService } from 'src/modules/messaging/message-import-manager/services/messaging-save-messages-and-enqueue-contact-creation.service';\nimport { MessagingSendMessageService } from 'src/modules/messaging/message-import-manager/services/messaging-send-message.service';\nimport { MessageParticipantManagerModule } from 'src/modules/messaging/message-participant-manager/message-participant-manager.module';\nimport { MessagingMonitoringModule } from 'src/modules/messaging/monitoring/messaging-monitoring.module';\n@Module({\n  imports: [\n    RefreshTokensManagerModule,\n    WorkspaceDataSourceModule,\n    OAuth2ClientManagerModule,\n    MessagingGmailDriverModule,\n    MessagingMicrosoftDriverModule,\n    MessagingIMAPDriverModule,\n    MessagingSmtpDriverModule,\n    MessagingCommonModule,\n    TypeOrmModule.forFeature([\n      WorkspaceEntity,\n      DataSourceEntity,\n      ObjectMetadataEntity,\n    ]),\n    EmailAliasManagerModule,\n    FeatureFlagModule,\n    MessageParticipantManagerModule,\n    MessagingFolderSyncManagerModule,\n    MessagingMonitoringModule,\n    MessagingMessageCleanerModule,\n    WorkspaceEventEmitterModule,\n    ConnectedAccountModule,\n  ],\n  providers: [\n    MessagingMessageListFetchCronCommand,\n    MessagingMessagesImportCronCommand,\n    MessagingOngoingStaleCronCommand,\n    MessagingProcessFolderActionsCronCommand,\n    MessagingRelaunchFailedMessageChannelsCronCommand,\n    MessagingSingleMessageImportCommand,\n    MessagingMessageListFetchJob,\n    MessagingMessagesImportJob,\n    MessagingOngoingStaleJob,\n    MessagingProcessFolderActionsJob,\n    MessagingRelaunchFailedMessageChannelJob,\n    MessagingMessageListFetchCronJob,\n    MessagingMessagesImportCronJob,\n    MessagingOngoingStaleCronJob,\n    MessagingProcessFolderActionsCronJob,\n    MessagingRelaunchFailedMessageChannelsCronJob,\n    MessagingAddSingleMessageToCacheForImportJob,\n    MessagingMessageImportManagerMessageChannelListener,\n    MessagingCleanCacheJob,\n    MessagingMessageService,\n    MessagingMessageListFetchService,\n    MessagingMessagesImportService,\n    MessagingSaveMessagesAndEnqueueContactCreationService,\n    MessagingGetMessageListService,\n    MessagingGetMessagesService,\n    MessageImportExceptionHandlerService,\n    MessagingCursorService,\n    MessagingSendMessageService,\n    MessagingAccountAuthenticationService,\n    MessagingProcessFolderActionsService,\n    MessagingProcessGroupEmailActionsService,\n    MessagingDeleteFolderMessagesService,\n    MessagingDeleteGroupEmailMessagesService,\n  ],\n  exports: [\n    MessagingSendMessageService,\n    MessagingMessageListFetchCronCommand,\n    MessagingMessagesImportCronCommand,\n    MessagingOngoingStaleCronCommand,\n    MessagingRelaunchFailedMessageChannelsCronCommand,\n    MessagingProcessGroupEmailActionsService,\n  ],\n})\nexport class MessagingImportManagerModule {}",
            "cost": 0.09315000000000001
        },
        "twentyhq__twenty.main/packages/twenty-server/src/modules/messaging/message-import-manager/services/messaging-message-list-fetch.service.ts": {
            "output": "import { Injectable, Logger } from '@nestjs/common';\n\nimport { isNonEmptyString } from '@sniptt/guards';\nimport chunk from 'lodash.chunk';\nimport { isDefined } from 'twenty-shared/utils';\nimport { In, MoreThanOrEqual } from 'typeorm';\n\nimport { InjectCacheStorage } from 'src/engine/core-modules/cache-storage/decorators/cache-storage.decorator';\nimport { CacheStorageService } from 'src/engine/core-modules/cache-storage/services/cache-storage.service';\nimport { CacheStorageNamespace } from 'src/engine/core-modules/cache-storage/types/cache-storage-namespace.enum';\nimport { TwentyORMManager } from 'src/engine/twenty-orm/twenty-orm.manager';\nimport { MessageChannelSyncStatusService } from 'src/modules/messaging/common/services/message-channel-sync-status.service';\nimport { type MessageChannelMessageAssociationWorkspaceEntity } from 'src/modules/messaging/common/standard-objects/message-channel-message-association.workspace-entity';\nimport {\n  MessageChannelPendingGroupEmailsAction,\n  MessageChannelSyncStage,\n  MessageChannelWorkspaceEntity,\n} from 'src/modules/messaging/common/standard-objects/message-channel.workspace-entity';\nimport {\n  MessageFolderPendingSyncAction,\n  MessageFolderWorkspaceEntity,\n} from 'src/modules/messaging/common/standard-objects/message-folder.workspace-entity';\nimport { MessagingMessageCleanerService } from 'src/modules/messaging/message-cleaner/services/messaging-message-cleaner.service';\nimport { SyncMessageFoldersService } from 'src/modules/messaging/message-folder-manager/services/sync-message-folders.service';\nimport { MessagingAccountAuthenticationService } from 'src/modules/messaging/message-import-manager/services/messaging-account-authentication.service';\nimport { MessagingCursorService } from 'src/modules/messaging/message-import-manager/services/messaging-cursor.service';\nimport { MessagingGetMessageListService } from 'src/modules/messaging/message-import-manager/services/messaging-get-message-list.service';\nimport {\n  MessageImportExceptionHandlerService,\n  MessageImportSyncStep,\n} from 'src/modules/messaging/message-import-manager/services/messaging-import-exception-handler.service';\nimport { MessagingMessagesImportService } from 'src/modules/messaging/message-import-manager/services/messaging-messages-import.service';\nimport { MessagingProcessGroupEmailActionsService } from 'src/modules/messaging/message-import-manager/services/messaging-process-group-email-actions.service';\n\nconst ONE_WEEK_IN_MILLISECONDS = 7 * 24 * 60 * 60 * 1000;\n\n@Injectable()\nexport class MessagingMessageListFetchService {\n  private readonly logger = new Logger(MessagingMessageListFetchService.name);\n  constructor(\n    @InjectCacheStorage(CacheStorageNamespace.ModuleMessaging)\n    private readonly cacheStorage: CacheStorageService,\n    private readonly messageChannelSyncStatusService: MessageChannelSyncStatusService,\n    private readonly twentyORMManager: TwentyORMManager,\n    private readonly messagingGetMessageListService: MessagingGetMessageListService,\n    private readonly messageImportErrorHandlerService: MessageImportExceptionHandlerService,\n    private readonly messagingMessageCleanerService: MessagingMessageCleanerService,\n    private readonly messagingCursorService: MessagingCursorService,\n    private readonly messagingMessagesImportService: MessagingMessagesImportService,\n    private readonly messagingAccountAuthenticationService: MessagingAccountAuthenticationService,\n    private readonly syncMessageFoldersService: SyncMessageFoldersService,\n    private readonly messagingProcessGroupEmailActionsService: MessagingProcessGroupEmailActionsService,\n  ) {}\n\n  public async processMessageListFetch(\n    messageChannel: MessageChannelWorkspaceEntity,\n    workspaceId: string,\n  ) {\n    try {\n      if (\n        messageChannel.pendingGroupEmailsAction ===\n          MessageChannelPendingGroupEmailsAction.GROUP_EMAILS_DELETION ||\n        messageChannel.pendingGroupEmailsAction ===\n          MessageChannelPendingGroupEmailsAction.GROUP_EMAILS_IMPORT\n      ) {\n        this.logger.log(\n          `messageChannelId: ${messageChannel.id} Processing pending group emails action before message list fetch: ${messageChannel.pendingGroupEmailsAction}`,\n        );\n\n        await this.messagingProcessGroupEmailActionsService.processGroupEmailActions(\n          messageChannel,\n          workspaceId,\n        );\n\n        return;\n      }\n\n      await this.messageChannelSyncStatusService.markAsMessagesListFetchOngoing(\n        [messageChannel.id],\n        workspaceId,\n      );\n\n      this.logger.log(\n        `messageChannelId: ${messageChannel.id} Processing message list fetch`,\n      );\n\n      const messageChannelRepository =\n        await this.twentyORMManager.getRepository<MessageChannelWorkspaceEntity>(\n          'messageChannel',\n        );\n\n      const freshMessageChannel =\n        pendingGroupEmailActionsProcessed || pendingFolderActionsProcessed\n          ? await messageChannelRepository.findOne({\n              where: {\n                id: messageChannel.id,\n              },\n              relations: ['connectedAccount', 'messageFolders'],\n            })\n          : messageChannel;\n\n      if (!isDefined(freshMessageChannel)) {\n        this.logger.error(\n          `error processing message list fetch: messageChannelId: ${messageChannel.id} Message channel not found`,\n        );\n\n        return;\n      }\n\n      const { accessToken, refreshToken } =\n        await this.messagingAccountAuthenticationService.validateAndRefreshConnectedAccountAuthentication(\n          {\n            connectedAccount: freshMessageChannel.connectedAccount,\n            workspaceId,\n            messageChannelId: freshMessageChannel.id,\n          },\n        );\n\n      const messageChannelWithFreshTokens = {\n        ...freshMessageChannel,\n        connectedAccount: {\n          ...freshMessageChannel.connectedAccount,\n          accessToken,\n          refreshToken,\n        },\n      };\n\n      const datasource = await this.twentyORMManager.getDatasource();\n\n      await this.syncMessageFoldersService.syncMessageFolders({\n        workspaceId,\n        messageChannel: messageChannelWithFreshTokens,\n        manager: datasource.manager,\n      });\n\n      const messageFolderRepository =\n        await this.twentyORMManager.getRepository<MessageFolderWorkspaceEntity>(\n          'messageFolder',\n        );\n\n      const messageFolders = await messageFolderRepository.find({\n        where: {\n          messageChannelId: freshMessageChannel.id,\n          pendingSyncAction: MessageFolderPendingSyncAction.NONE,\n        },\n      });\n\n      const messageLists =\n        await this.messagingGetMessageListService.getMessageLists(\n          messageChannelWithFreshTokens,\n          messageFolders,\n        );\n\n      await this.cacheStorage.del(\n        `messages-to-import:${workspaceId}:${freshMessageChannel.id}`,\n      );\n\n      const messageExternalIds = messageLists.flatMap(\n        (messageList) => messageList.messageExternalIds,\n      );\n\n      const messageExternalIdsToDelete = messageLists.flatMap(\n        (messageList) => messageList.messageExternalIdsToDelete,\n      );\n\n      const isFullSync =\n        messageLists.every(\n          (messageList) => !isNonEmptyString(messageList.previousSyncCursor),\n        ) && !isNonEmptyString(freshMessageChannel.syncCursor);\n\n      let totalMessagesToImportCount = 0;\n\n      this.logger.log(\n        `messageChannelId: ${freshMessageChannel.id} Is full sync: ${isFullSync} and toImportCount: ${messageExternalIds.length}, toDeleteCount: ${messageExternalIdsToDelete.length}, cursors: ${messageLists.map(\n          (messageList) => {\n            messageList.nextSyncCursor;\n          },\n        )}`,\n      );\n\n      const messageChannelMessageAssociationRepository =\n        await this.twentyORMManager.getRepository<MessageChannelMessageAssociationWorkspaceEntity>(\n          'messageChannelMessageAssociation',\n        );\n\n      const messageExternalIdsChunks = chunk(messageExternalIds, 200);\n\n      for (const [\n        index,\n        messageExternalIdsChunk,\n      ] of messageExternalIdsChunks.entries()) {\n        const existingMessageChannelMessageAssociations =\n          await messageChannelMessageAssociationRepository.find({\n            where: {\n              messageChannelId: freshMessageChannel.id,\n              messageExternalId: In(messageExternalIdsChunk),\n            },\n          });\n\n        const existingMessageChannelMessageAssociationsExternalIds =\n          existingMessageChannelMessageAssociations.map(\n            (messageChannelMessageAssociation) =>\n              messageChannelMessageAssociation.messageExternalId,\n          );\n\n        const messageExternalIdsToImport = messageExternalIdsChunk.filter(\n          (messageExternalId) =>\n            !existingMessageChannelMessageAssociationsExternalIds.includes(\n              messageExternalId,\n            ),\n        );\n\n        if (messageExternalIdsToImport.length) {\n          this.logger.log(\n            `messageChannelId: ${freshMessageChannel.id} Adding ${messageExternalIdsToImport.length} message external ids to import in batch ${index + 1}`,\n          );\n\n          totalMessagesToImportCount += messageExternalIdsToImport.length;\n\n          await this.cacheStorage.setAdd(\n            `messages-to-import:${workspaceId}:${messageChannelWithFreshTokens.id}`,\n            messageExternalIdsToImport,\n            ONE_WEEK_IN_MILLISECONDS,\n          );\n        }\n      }\n\n      for (const messageList of messageLists) {\n        const { nextSyncCursor, folderId } = messageList;\n\n        await this.messagingCursorService.updateCursor(\n          messageChannelWithFreshTokens,\n          nextSyncCursor,\n          folderId,\n        );\n      }\n\n      const fullSyncMessageChannelMessageAssociationsToDelete = isFullSync\n        ? await this.computeFullSyncMessageChannelMessageAssociationsToDelete(\n            freshMessageChannel,\n            messageExternalIds,\n          )\n        : [];\n\n      const allMessageExternalIdsToDelete = [\n        ...messageExternalIdsToDelete,\n        ...fullSyncMessageChannelMessageAssociationsToDelete.map(\n          (messageChannelMessageAssociation) =>\n            messageChannelMessageAssociation.messageExternalId,\n        ),\n      ];\n\n      if (allMessageExternalIdsToDelete.length) {\n        this.logger.log(\n          `messageChannelId: ${freshMessageChannel.id} Deleting ${allMessageExternalIdsToDelete.length} message channel message associations`,\n        );\n\n        const toDeleteChunks = chunk(allMessageExternalIdsToDelete, 200);\n\n        for (const [index, toDeleteChunk] of toDeleteChunks.entries()) {\n          this.logger.log(\n            `messageChannelId: ${freshMessageChannel.id} Deleting ${toDeleteChunk.length} message channel message associations in batch ${index + 1}`,\n          );\n\n          await this.messagingMessageCleanerService.deleteMessagesChannelMessageAssociationsAndRelatedOrphans(\n            {\n              workspaceId,\n              messageExternalIds: toDeleteChunk.filter((messageExternalId) =>\n                isNonEmptyString(messageExternalId),\n              ),\n              messageChannelId: messageChannelWithFreshTokens.id,\n            },\n          );\n        }\n      }\n\n      this.logger.log(\n        `messageChannelId: ${freshMessageChannel.id} Total messages to import count: ${totalMessagesToImportCount}`,\n      );\n\n      if (totalMessagesToImportCount === 0) {\n        await this.messageChannelSyncStatusService.markAsCompletedAndScheduleMessageListFetch(\n          [messageChannelWithFreshTokens.id],\n          workspaceId,\n        );\n\n        return;\n      }\n\n      this.logger.log(\n        `messageChannelId: ${freshMessageChannel.id} Scheduling direct messages import`,\n      );\n\n      await this.messageChannelSyncStatusService.scheduleMessagesImport(\n        [messageChannelWithFreshTokens.id],\n        workspaceId,\n      );\n\n      await this.messagingMessagesImportService.processMessageBatchImport(\n        {\n          ...messageChannelWithFreshTokens,\n          syncStage: MessageChannelSyncStage.MESSAGES_IMPORT_PENDING,\n        },\n        messageChannelWithFreshTokens.connectedAccount,\n        workspaceId,\n      );\n    } catch (error) {\n      await this.messageImportErrorHandlerService.handleDriverException(\n        error,\n        MessageImportSyncStep.MESSAGE_LIST_FETCH,\n        messageChannel,\n        workspaceId,\n      );\n    }\n  }\n\n  private async computeFullSyncMessageChannelMessageAssociationsToDelete(\n    messageChannel: Pick<MessageChannelWorkspaceEntity, 'id'>,\n    messageExternalIds: string[],\n  ) {\n    const messageChannelMessageAssociationRepository =\n      await this.twentyORMManager.getRepository<MessageChannelMessageAssociationWorkspaceEntity>(\n        'messageChannelMessageAssociation',\n      );\n\n    const fullSyncMessageChannelMessageAssociationsToDelete = [];\n\n    const firstMessageChannelMessageAssociation =\n      await messageChannelMessageAssociationRepository.findOne({\n        where: {\n          messageChannelId: messageChannel.id,\n        },\n        order: {\n          id: 'ASC',\n        },\n      });\n\n    if (!isDefined(firstMessageChannelMessageAssociation)) {\n      this.logger.log(\n        `messageChannelId: ${messageChannel.id} Full sync: No message channel message associations found`,\n      );\n\n      return [];\n    }\n\n    this.logger.log(\n      `messageChannelId: ${messageChannel.id} Full sync: First message channel message association id: ${firstMessageChannelMessageAssociation.id}`,\n    );\n\n    let nextFirstBatchMessageChannelMessageAssociationId: string | undefined =\n      firstMessageChannelMessageAssociation.id;\n    let batchIndex = 0;\n\n    while (isDefined(nextFirstBatchMessageChannelMessageAssociationId)) {\n      const existingMessageChannelMessageAssociations =\n        await messageChannelMessageAssociationRepository.find({\n          where: {\n            messageChannelId: messageChannel.id,\n            id: MoreThanOrEqual(\n              nextFirstBatchMessageChannelMessageAssociationId,\n            ),\n          },\n          order: {\n            id: 'ASC',\n          },\n          take: 200,\n        });\n\n      const messageChannelMessageAssociationsToDelete =\n        existingMessageChannelMessageAssociations.filter(\n          (existingMessageChannelMessageAssociation) =>\n            isDefined(\n              existingMessageChannelMessageAssociation.messageExternalId,\n            ) &&\n            !messageExternalIds.includes(\n              existingMessageChannelMessageAssociation.messageExternalId,\n            ),\n        );\n\n      this.logger.log(\n        `messageChannelId: ${messageChannel.id} Full sync: Message channel message associations to delete in batch ${batchIndex}: ${messageChannelMessageAssociationsToDelete.length}`,\n      );\n\n      fullSyncMessageChannelMessageAssociationsToDelete.push(\n        ...messageChannelMessageAssociationsToDelete,\n      );\n\n      if (existingMessageChannelMessageAssociations.length < 200) {\n        nextFirstBatchMessageChannelMessageAssociationId = undefined;\n        break;\n      }\n\n      nextFirstBatchMessageChannelMessageAssociationId =\n        existingMessageChannel",
            "output_extracted": "import { Injectable, Logger } from '@nestjs/common';\n\nimport { isNonEmptyString } from '@sniptt/guards';\nimport chunk from 'lodash.chunk';\nimport { isDefined } from 'twenty-shared/utils';\nimport { In, MoreThanOrEqual } from 'typeorm';\n\nimport { InjectCacheStorage } from 'src/engine/core-modules/cache-storage/decorators/cache-storage.decorator';\nimport { CacheStorageService } from 'src/engine/core-modules/cache-storage/services/cache-storage.service';\nimport { CacheStorageNamespace } from 'src/engine/core-modules/cache-storage/types/cache-storage-namespace.enum';\nimport { TwentyORMManager } from 'src/engine/twenty-orm/twenty-orm.manager';\nimport { MessageChannelSyncStatusService } from 'src/modules/messaging/common/services/message-channel-sync-status.service';\nimport { type MessageChannelMessageAssociationWorkspaceEntity } from 'src/modules/messaging/common/standard-objects/message-channel-message-association.workspace-entity';\nimport {\n  MessageChannelPendingGroupEmailsAction,\n  MessageChannelSyncStage,\n  MessageChannelWorkspaceEntity,\n} from 'src/modules/messaging/common/standard-objects/message-channel.workspace-entity';\nimport {\n  MessageFolderPendingSyncAction,\n  MessageFolderWorkspaceEntity,\n} from 'src/modules/messaging/common/standard-objects/message-folder.workspace-entity';\nimport { MessagingMessageCleanerService } from 'src/modules/messaging/message-cleaner/services/messaging-message-cleaner.service';\nimport { SyncMessageFoldersService } from 'src/modules/messaging/message-folder-manager/services/sync-message-folders.service';\nimport { MessagingAccountAuthenticationService } from 'src/modules/messaging/message-import-manager/services/messaging-account-authentication.service';\nimport { MessagingCursorService } from 'src/modules/messaging/message-import-manager/services/messaging-cursor.service';\nimport { MessagingGetMessageListService } from 'src/modules/messaging/message-import-manager/services/messaging-get-message-list.service';\nimport {\n  MessageImportExceptionHandlerService,\n  MessageImportSyncStep,\n} from 'src/modules/messaging/message-import-manager/services/messaging-import-exception-handler.service';\nimport { MessagingMessagesImportService } from 'src/modules/messaging/message-import-manager/services/messaging-messages-import.service';\nimport { MessagingProcessGroupEmailActionsService } from 'src/modules/messaging/message-import-manager/services/messaging-process-group-email-actions.service';\n\nconst ONE_WEEK_IN_MILLISECONDS = 7 * 24 * 60 * 60 * 1000;\n\n@Injectable()\nexport class MessagingMessageListFetchService {\n  private readonly logger = new Logger(MessagingMessageListFetchService.name);\n  constructor(\n    @InjectCacheStorage(CacheStorageNamespace.ModuleMessaging)\n    private readonly cacheStorage: CacheStorageService,\n    private readonly messageChannelSyncStatusService: MessageChannelSyncStatusService,\n    private readonly twentyORMManager: TwentyORMManager,\n    private readonly messagingGetMessageListService: MessagingGetMessageListService,\n    private readonly messageImportErrorHandlerService: MessageImportExceptionHandlerService,\n    private readonly messagingMessageCleanerService: MessagingMessageCleanerService,\n    private readonly messagingCursorService: MessagingCursorService,\n    private readonly messagingMessagesImportService: MessagingMessagesImportService,\n    private readonly messagingAccountAuthenticationService: MessagingAccountAuthenticationService,\n    private readonly syncMessageFoldersService: SyncMessageFoldersService,\n    private readonly messagingProcessGroupEmailActionsService: MessagingProcessGroupEmailActionsService,\n  ) {}\n\n  public async processMessageListFetch(\n    messageChannel: MessageChannelWorkspaceEntity,\n    workspaceId: string,\n  ) {\n    try {\n      if (\n        messageChannel.pendingGroupEmailsAction ===\n          MessageChannelPendingGroupEmailsAction.GROUP_EMAILS_DELETION ||\n        messageChannel.pendingGroupEmailsAction ===\n          MessageChannelPendingGroupEmailsAction.GROUP_EMAILS_IMPORT\n      ) {\n        this.logger.log(\n          `messageChannelId: ${messageChannel.id} Processing pending group emails action before message list fetch: ${messageChannel.pendingGroupEmailsAction}`,\n        );\n\n        await this.messagingProcessGroupEmailActionsService.processGroupEmailActions(\n          messageChannel,\n          workspaceId,\n        );\n\n        return;\n      }\n\n      await this.messageChannelSyncStatusService.markAsMessagesListFetchOngoing(\n        [messageChannel.id],\n        workspaceId,\n      );\n\n      this.logger.log(\n        `messageChannelId: ${messageChannel.id} Processing message list fetch`,\n      );\n\n      const messageChannelRepository =\n        await this.twentyORMManager.getRepository<MessageChannelWorkspaceEntity>(\n          'messageChannel',\n        );\n\n      const freshMessageChannel =\n        pendingGroupEmailActionsProcessed || pendingFolderActionsProcessed\n          ? await messageChannelRepository.findOne({\n              where: {\n                id: messageChannel.id,\n              },\n              relations: ['connectedAccount', 'messageFolders'],\n            })\n          : messageChannel;\n\n      if (!isDefined(freshMessageChannel)) {\n        this.logger.error(\n          `error processing message list fetch: messageChannelId: ${messageChannel.id} Message channel not found`,\n        );\n\n        return;\n      }\n\n      const { accessToken, refreshToken } =\n        await this.messagingAccountAuthenticationService.validateAndRefreshConnectedAccountAuthentication(\n          {\n            connectedAccount: freshMessageChannel.connectedAccount,\n            workspaceId,\n            messageChannelId: freshMessageChannel.id,\n          },\n        );\n\n      const messageChannelWithFreshTokens = {\n        ...freshMessageChannel,\n        connectedAccount: {\n          ...freshMessageChannel.connectedAccount,\n          accessToken,\n          refreshToken,\n        },\n      };\n\n      const datasource = await this.twentyORMManager.getDatasource();\n\n      await this.syncMessageFoldersService.syncMessageFolders({\n        workspaceId,\n        messageChannel: messageChannelWithFreshTokens,\n        manager: datasource.manager,\n      });\n\n      const messageFolderRepository =\n        await this.twentyORMManager.getRepository<MessageFolderWorkspaceEntity>(\n          'messageFolder',\n        );\n\n      const messageFolders = await messageFolderRepository.find({\n        where: {\n          messageChannelId: freshMessageChannel.id,\n          pendingSyncAction: MessageFolderPendingSyncAction.NONE,\n        },\n      });\n\n      const messageLists =\n        await this.messagingGetMessageListService.getMessageLists(\n          messageChannelWithFreshTokens,\n          messageFolders,\n        );\n\n      await this.cacheStorage.del(\n        `messages-to-import:${workspaceId}:${freshMessageChannel.id}`,\n      );\n\n      const messageExternalIds = messageLists.flatMap(\n        (messageList) => messageList.messageExternalIds,\n      );\n\n      const messageExternalIdsToDelete = messageLists.flatMap(\n        (messageList) => messageList.messageExternalIdsToDelete,\n      );\n\n      const isFullSync =\n        messageLists.every(\n          (messageList) => !isNonEmptyString(messageList.previousSyncCursor),\n        ) && !isNonEmptyString(freshMessageChannel.syncCursor);\n\n      let totalMessagesToImportCount = 0;\n\n      this.logger.log(\n        `messageChannelId: ${freshMessageChannel.id} Is full sync: ${isFullSync} and toImportCount: ${messageExternalIds.length}, toDeleteCount: ${messageExternalIdsToDelete.length}, cursors: ${messageLists.map(\n          (messageList) => {\n            messageList.nextSyncCursor;\n          },\n        )}`,\n      );\n\n      const messageChannelMessageAssociationRepository =\n        await this.twentyORMManager.getRepository<MessageChannelMessageAssociationWorkspaceEntity>(\n          'messageChannelMessageAssociation',\n        );\n\n      const messageExternalIdsChunks = chunk(messageExternalIds, 200);\n\n      for (const [\n        index,\n        messageExternalIdsChunk,\n      ] of messageExternalIdsChunks.entries()) {\n        const existingMessageChannelMessageAssociations =\n          await messageChannelMessageAssociationRepository.find({\n            where: {\n              messageChannelId: freshMessageChannel.id,\n              messageExternalId: In(messageExternalIdsChunk),\n            },\n          });\n\n        const existingMessageChannelMessageAssociationsExternalIds =\n          existingMessageChannelMessageAssociations.map(\n            (messageChannelMessageAssociation) =>\n              messageChannelMessageAssociation.messageExternalId,\n          );\n\n        const messageExternalIdsToImport = messageExternalIdsChunk.filter(\n          (messageExternalId) =>\n            !existingMessageChannelMessageAssociationsExternalIds.includes(\n              messageExternalId,\n            ),\n        );\n\n        if (messageExternalIdsToImport.length) {\n          this.logger.log(\n            `messageChannelId: ${freshMessageChannel.id} Adding ${messageExternalIdsToImport.length} message external ids to import in batch ${index + 1}`,\n          );\n\n          totalMessagesToImportCount += messageExternalIdsToImport.length;\n\n          await this.cacheStorage.setAdd(\n            `messages-to-import:${workspaceId}:${messageChannelWithFreshTokens.id}`,\n            messageExternalIdsToImport,\n            ONE_WEEK_IN_MILLISECONDS,\n          );\n        }\n      }\n\n      for (const messageList of messageLists) {\n        const { nextSyncCursor, folderId } = messageList;\n\n        await this.messagingCursorService.updateCursor(\n          messageChannelWithFreshTokens,\n          nextSyncCursor,\n          folderId,\n        );\n      }\n\n      const fullSyncMessageChannelMessageAssociationsToDelete = isFullSync\n        ? await this.computeFullSyncMessageChannelMessageAssociationsToDelete(\n            freshMessageChannel,\n            messageExternalIds,\n          )\n        : [];\n\n      const allMessageExternalIdsToDelete = [\n        ...messageExternalIdsToDelete,\n        ...fullSyncMessageChannelMessageAssociationsToDelete.map(\n          (messageChannelMessageAssociation) =>\n            messageChannelMessageAssociation.messageExternalId,\n        ),\n      ];\n\n      if (allMessageExternalIdsToDelete.length) {\n        this.logger.log(\n          `messageChannelId: ${freshMessageChannel.id} Deleting ${allMessageExternalIdsToDelete.length} message channel message associations`,\n        );\n\n        const toDeleteChunks = chunk(allMessageExternalIdsToDelete, 200);\n\n        for (const [index, toDeleteChunk] of toDeleteChunks.entries()) {\n          this.logger.log(\n            `messageChannelId: ${freshMessageChannel.id} Deleting ${toDeleteChunk.length} message channel message associations in batch ${index + 1}`,\n          );\n\n          await this.messagingMessageCleanerService.deleteMessagesChannelMessageAssociationsAndRelatedOrphans(\n            {\n              workspaceId,\n              messageExternalIds: toDeleteChunk.filter((messageExternalId) =>\n                isNonEmptyString(messageExternalId),\n              ),\n              messageChannelId: messageChannelWithFreshTokens.id,\n            },\n          );\n        }\n      }\n\n      this.logger.log(\n        `messageChannelId: ${freshMessageChannel.id} Total messages to import count: ${totalMessagesToImportCount}`,\n      );\n\n      if (totalMessagesToImportCount === 0) {\n        await this.messageChannelSyncStatusService.markAsCompletedAndScheduleMessageListFetch(\n          [messageChannelWithFreshTokens.id],\n          workspaceId,\n        );\n\n        return;\n      }\n\n      this.logger.log(\n        `messageChannelId: ${freshMessageChannel.id} Scheduling direct messages import`,\n      );\n\n      await this.messageChannelSyncStatusService.scheduleMessagesImport(\n        [messageChannelWithFreshTokens.id],\n        workspaceId,\n      );\n\n      await this.messagingMessagesImportService.processMessageBatchImport(\n        {\n          ...messageChannelWithFreshTokens,\n          syncStage: MessageChannelSyncStage.MESSAGES_IMPORT_PENDING,\n        },\n        messageChannelWithFreshTokens.connectedAccount,\n        workspaceId,\n      );\n    } catch (error) {\n      await this.messageImportErrorHandlerService.handleDriverException(\n        error,\n        MessageImportSyncStep.MESSAGE_LIST_FETCH,\n        messageChannel,\n        workspaceId,\n      );\n    }\n  }\n\n  private async computeFullSyncMessageChannelMessageAssociationsToDelete(\n    messageChannel: Pick<MessageChannelWorkspaceEntity, 'id'>,\n    messageExternalIds: string[],\n  ) {\n    const messageChannelMessageAssociationRepository =\n      await this.twentyORMManager.getRepository<MessageChannelMessageAssociationWorkspaceEntity>(\n        'messageChannelMessageAssociation',\n      );\n\n    const fullSyncMessageChannelMessageAssociationsToDelete = [];\n\n    const firstMessageChannelMessageAssociation =\n      await messageChannelMessageAssociationRepository.findOne({\n        where: {\n          messageChannelId: messageChannel.id,\n        },\n        order: {\n          id: 'ASC',\n        },\n      });\n\n    if (!isDefined(firstMessageChannelMessageAssociation)) {\n      this.logger.log(\n        `messageChannelId: ${messageChannel.id} Full sync: No message channel message associations found`,\n      );\n\n      return [];\n    }\n\n    this.logger.log(\n      `messageChannelId: ${messageChannel.id} Full sync: First message channel message association id: ${firstMessageChannelMessageAssociation.id}`,\n    );\n\n    let nextFirstBatchMessageChannelMessageAssociationId: string | undefined =\n      firstMessageChannelMessageAssociation.id;\n    let batchIndex = 0;\n\n    while (isDefined(nextFirstBatchMessageChannelMessageAssociationId)) {\n      const existingMessageChannelMessageAssociations =\n        await messageChannelMessageAssociationRepository.find({\n          where: {\n            messageChannelId: messageChannel.id,\n            id: MoreThanOrEqual(\n              nextFirstBatchMessageChannelMessageAssociationId,\n            ),\n          },\n          order: {\n            id: 'ASC',\n          },\n          take: 200,\n        });\n\n      const messageChannelMessageAssociationsToDelete =\n        existingMessageChannelMessageAssociations.filter(\n          (existingMessageChannelMessageAssociation) =>\n            isDefined(\n              existingMessageChannelMessageAssociation.messageExternalId,\n            ) &&\n            !messageExternalIds.includes(\n              existingMessageChannelMessageAssociation.messageExternalId,\n            ),\n        );\n\n      this.logger.log(\n        `messageChannelId: ${messageChannel.id} Full sync: Message channel message associations to delete in batch ${batchIndex}: ${messageChannelMessageAssociationsToDelete.length}`,\n      );\n\n      fullSyncMessageChannelMessageAssociationsToDelete.push(\n        ...messageChannelMessageAssociationsToDelete,\n      );\n\n      if (existingMessageChannelMessageAssociations.length < 200) {\n        nextFirstBatchMessageChannelMessageAssociationId = undefined;\n        break;\n      }\n\n      nextFirstBatchMessageChannelMessageAssociationId =\n        existingMessageChannel",
            "cost": 0.13661
        }
    },
    "recover_status": "success",
    "instance_ref": {
        "instance_id": "twentyhq__twenty.main.16062",
        "repo": "twentyhq/twenty",
        "base_commit": "71724de7dd08c7153bc1a45158296feb75a11fdd",
        "head_commit": "9ba583bec3d2ba4f9ed8ff0a341046533ae4fe17",
        "title": "move folder cron to `message-list-fetch`",
        "merged_at": "2025-11-25T17:06:39Z",
        "html_url": "https://github.com/twentyhq/twenty/pull/16062",
        "test_files": [
            "packages/twenty-server/src/modules/messaging/message-import-manager/services/messaging-message-list-fetch.service.spec.ts"
        ],
        "code_files": [
            "packages/twenty-server/src/modules/messaging/message-import-manager/crons/commands/messaging-process-folder-actions.cron.command.ts",
            "packages/twenty-server/src/modules/messaging/message-import-manager/crons/jobs/messaging-process-folder-actions.cron.job.ts",
            "packages/twenty-server/src/modules/messaging/message-import-manager/jobs/messaging-process-folder-actions.job.ts",
            "packages/twenty-server/src/modules/messaging/message-import-manager/messaging-import-manager.module.ts",
            "packages/twenty-server/src/modules/messaging/message-import-manager/services/messaging-message-list-fetch.service.ts"
        ],
        "total_changes": 323,
        "num_files": 6,
        "pull_number": 16062,
        "patch": "diff --git a/packages/twenty-server/src/modules/messaging/message-import-manager/crons/commands/messaging-process-folder-actions.cron.command.ts b/packages/twenty-server/src/modules/messaging/message-import-manager/crons/commands/messaging-process-folder-actions.cron.command.ts\ndeleted file mode 100644\nindex 84f97a2433970..0000000000000\n--- a/packages/twenty-server/src/modules/messaging/message-import-manager/crons/commands/messaging-process-folder-actions.cron.command.ts\n+++ /dev/null\n@@ -1,35 +0,0 @@\n-import { Command, CommandRunner } from 'nest-commander';\n-\n-import { InjectMessageQueue } from 'src/engine/core-modules/message-queue/decorators/message-queue.decorator';\n-import { MessageQueue } from 'src/engine/core-modules/message-queue/message-queue.constants';\n-import { MessageQueueService } from 'src/engine/core-modules/message-queue/services/message-queue.service';\n-import {\n-  MESSAGING_PROCESS_FOLDER_ACTIONS_CRON_PATTERN,\n-  MessagingProcessFolderActionsCronJob,\n-} from 'src/modules/messaging/message-import-manager/crons/jobs/messaging-process-folder-actions.cron.job';\n-\n-@Command({\n-  name: 'cron:messaging:process-folder-actions',\n-  description:\n-    'Starts a cron job to process pending folder actions (deletion) for message channels',\n-})\n-export class MessagingProcessFolderActionsCronCommand extends CommandRunner {\n-  constructor(\n-    @InjectMessageQueue(MessageQueue.cronQueue)\n-    private readonly messageQueueService: MessageQueueService,\n-  ) {\n-    super();\n-  }\n-\n-  async run(): Promise<void> {\n-    await this.messageQueueService.addCron<undefined>({\n-      jobName: MessagingProcessFolderActionsCronJob.name,\n-      data: undefined,\n-      options: {\n-        repeat: {\n-          pattern: MESSAGING_PROCESS_FOLDER_ACTIONS_CRON_PATTERN,\n-        },\n-      },\n-    });\n-  }\n-}\ndiff --git a/packages/twenty-server/src/modules/messaging/message-import-manager/crons/jobs/messaging-process-folder-actions.cron.job.ts b/packages/twenty-server/src/modules/messaging/message-import-manager/crons/jobs/messaging-process-folder-actions.cron.job.ts\ndeleted file mode 100644\nindex 95298dc3bd224..0000000000000\n--- a/packages/twenty-server/src/modules/messaging/message-import-manager/crons/jobs/messaging-process-folder-actions.cron.job.ts\n+++ /dev/null\n@@ -1,76 +0,0 @@\n-import { InjectDataSource, InjectRepository } from '@nestjs/typeorm';\n-\n-import { WorkspaceActivationStatus } from 'twenty-shared/workspace';\n-import { DataSource, Repository } from 'typeorm';\n-\n-import { SentryCronMonitor } from 'src/engine/core-modules/cron/sentry-cron-monitor.decorator';\n-import { ExceptionHandlerService } from 'src/engine/core-modules/exception-handler/exception-handler.service';\n-import { InjectMessageQueue } from 'src/engine/core-modules/message-queue/decorators/message-queue.decorator';\n-import { Process } from 'src/engine/core-modules/message-queue/decorators/process.decorator';\n-import { Processor } from 'src/engine/core-modules/message-queue/decorators/processor.decorator';\n-import { MessageQueue } from 'src/engine/core-modules/message-queue/message-queue.constants';\n-import { MessageQueueService } from 'src/engine/core-modules/message-queue/services/message-queue.service';\n-import { WorkspaceEntity } from 'src/engine/core-modules/workspace/workspace.entity';\n-import { getWorkspaceSchemaName } from 'src/engine/workspace-datasource/utils/get-workspace-schema-name.util';\n-import { MessageFolderPendingSyncAction } from 'src/modules/messaging/common/standard-objects/message-folder.workspace-entity';\n-import {\n-  MessagingProcessFolderActionsJob,\n-  type MessagingProcessFolderActionsJobData,\n-} from 'src/modules/messaging/message-import-manager/jobs/messaging-process-folder-actions.job';\n-\n-export const MESSAGING_PROCESS_FOLDER_ACTIONS_CRON_PATTERN = '*/15 * * * *';\n-\n-@Processor(MessageQueue.cronQueue)\n-export class MessagingProcessFolderActionsCronJob {\n-  constructor(\n-    @InjectRepository(WorkspaceEntity)\n-    private readonly workspaceRepository: Repository<WorkspaceEntity>,\n-    @InjectMessageQueue(MessageQueue.messagingQueue)\n-    private readonly messageQueueService: MessageQueueService,\n-    @InjectDataSource()\n-    private readonly coreDataSource: DataSource,\n-    private readonly exceptionHandlerService: ExceptionHandlerService,\n-  ) {}\n-\n-  @Process(MessagingProcessFolderActionsCronJob.name)\n-  @SentryCronMonitor(\n-    MessagingProcessFolderActionsCronJob.name,\n-    MESSAGING_PROCESS_FOLDER_ACTIONS_CRON_PATTERN,\n-  )\n-  async handle(): Promise<void> {\n-    const activeWorkspaces = await this.workspaceRepository.find({\n-      where: {\n-        activationStatus: WorkspaceActivationStatus.ACTIVE,\n-      },\n-    });\n-\n-    for (const activeWorkspace of activeWorkspaces) {\n-      try {\n-        const schemaName = getWorkspaceSchemaName(activeWorkspace.id);\n-\n-        const messageChannels = await this.coreDataSource.query(\n-          `SELECT DISTINCT mc.id\n-           FROM ${schemaName}.\"messageChannel\" mc\n-           INNER JOIN ${schemaName}.\"messageFolder\" mf ON mf.\"messageChannelId\" = mc.id\n-           WHERE mf.\"pendingSyncAction\" = '${MessageFolderPendingSyncAction.FOLDER_DELETION}'`,\n-        );\n-\n-        for (const messageChannel of messageChannels) {\n-          await this.messageQueueService.add<MessagingProcessFolderActionsJobData>(\n-            MessagingProcessFolderActionsJob.name,\n-            {\n-              workspaceId: activeWorkspace.id,\n-              messageChannelId: messageChannel.id,\n-            },\n-          );\n-        }\n-      } catch (error) {\n-        this.exceptionHandlerService.captureExceptions([error], {\n-          workspace: {\n-            id: activeWorkspace.id,\n-          },\n-        });\n-      }\n-    }\n-  }\n-}\ndiff --git a/packages/twenty-server/src/modules/messaging/message-import-manager/jobs/messaging-process-folder-actions.job.ts b/packages/twenty-server/src/modules/messaging/message-import-manager/jobs/messaging-process-folder-actions.job.ts\ndeleted file mode 100644\nindex 1fe47a92e2d88..0000000000000\n--- a/packages/twenty-server/src/modules/messaging/message-import-manager/jobs/messaging-process-folder-actions.job.ts\n+++ /dev/null\n@@ -1,92 +0,0 @@\n-import { Logger, Scope } from '@nestjs/common';\n-\n-import { Process } from 'src/engine/core-modules/message-queue/decorators/process.decorator';\n-import { Processor } from 'src/engine/core-modules/message-queue/decorators/processor.decorator';\n-import { MessageQueue } from 'src/engine/core-modules/message-queue/message-queue.constants';\n-import { TwentyORMManager } from 'src/engine/twenty-orm/twenty-orm.manager';\n-import { type MessageChannelWorkspaceEntity } from 'src/modules/messaging/common/standard-objects/message-channel.workspace-entity';\n-import {\n-  MessageFolderPendingSyncAction,\n-  type MessageFolderWorkspaceEntity,\n-} from 'src/modules/messaging/common/standard-objects/message-folder.workspace-entity';\n-import { MessagingProcessFolderActionsService } from 'src/modules/messaging/message-import-manager/services/messaging-process-folder-actions.service';\n-\n-export type MessagingProcessFolderActionsJobData = {\n-  workspaceId: string;\n-  messageChannelId: string;\n-};\n-\n-@Processor({\n-  queueName: MessageQueue.messagingQueue,\n-  scope: Scope.REQUEST,\n-})\n-export class MessagingProcessFolderActionsJob {\n-  private readonly logger = new Logger(MessagingProcessFolderActionsJob.name);\n-\n-  constructor(\n-    private readonly twentyORMManager: TwentyORMManager,\n-    private readonly messagingProcessFolderActionsService: MessagingProcessFolderActionsService,\n-  ) {}\n-\n-  @Process(MessagingProcessFolderActionsJob.name)\n-  async handle(data: MessagingProcessFolderActionsJobData): Promise<void> {\n-    const { workspaceId, messageChannelId } = data;\n-\n-    this.logger.log(\n-      `Processing pending folder actions for message channel ${messageChannelId} in workspace ${workspaceId}`,\n-    );\n-\n-    const messageChannelRepository =\n-      await this.twentyORMManager.getRepository<MessageChannelWorkspaceEntity>(\n-        'messageChannel',\n-      );\n-\n-    const messageChannel = await messageChannelRepository.findOne({\n-      where: {\n-        id: messageChannelId,\n-      },\n-    });\n-\n-    if (!messageChannel) {\n-      this.logger.warn(\n-        `Message channel ${messageChannelId} not found in workspace ${workspaceId}`,\n-      );\n-\n-      return;\n-    }\n-\n-    const messageFolderRepository =\n-      await this.twentyORMManager.getRepository<MessageFolderWorkspaceEntity>(\n-        'messageFolder',\n-      );\n-\n-    const messageFolders = await messageFolderRepository.find({\n-      where: {\n-        messageChannelId: messageChannel.id,\n-        pendingSyncAction: MessageFolderPendingSyncAction.FOLDER_DELETION,\n-      },\n-    });\n-\n-    if (messageFolders.length === 0) {\n-      this.logger.log(\n-        `Message channel ${messageChannelId} has no folders with pending deletion actions, skipping`,\n-      );\n-\n-      return;\n-    }\n-\n-    try {\n-      await this.messagingProcessFolderActionsService.processFolderActions(\n-        messageChannel,\n-        messageFolders,\n-        workspaceId,\n-      );\n-    } catch (error) {\n-      this.logger.error(\n-        `Error processing folder actions for message channel ${messageChannelId} in workspace ${workspaceId}: ${error.message}`,\n-        error.stack,\n-      );\n-      throw error;\n-    }\n-  }\n-}\ndiff --git a/packages/twenty-server/src/modules/messaging/message-import-manager/messaging-import-manager.module.ts b/packages/twenty-server/src/modules/messaging/message-import-manager/messaging-import-manager.module.ts\nindex aec2e14b86005..623ebaceb2951 100644\n--- a/packages/twenty-server/src/modules/messaging/message-import-manager/messaging-import-manager.module.ts\n+++ b/packages/twenty-server/src/modules/messaging/message-import-manager/messaging-import-manager.module.ts\n@@ -18,12 +18,10 @@ import { MessagingSingleMessageImportCommand } from 'src/modules/messaging/messa\n import { MessagingMessageListFetchCronCommand } from 'src/modules/messaging/message-import-manager/crons/commands/messaging-message-list-fetch.cron.command';\n import { MessagingMessagesImportCronCommand } from 'src/modules/messaging/message-import-manager/crons/commands/messaging-messages-import.cron.command';\n import { MessagingOngoingStaleCronCommand } from 'src/modules/messaging/message-import-manager/crons/commands/messaging-ongoing-stale.cron.command';\n-import { MessagingProcessFolderActionsCronCommand } from 'src/modules/messaging/message-import-manager/crons/commands/messaging-process-folder-actions.cron.command';\n import { MessagingRelaunchFailedMessageChannelsCronCommand } from 'src/modules/messaging/message-import-manager/crons/commands/messaging-relaunch-failed-message-channels.cron.command';\n import { MessagingMessageListFetchCronJob } from 'src/modules/messaging/message-import-manager/crons/jobs/messaging-message-list-fetch.cron.job';\n import { MessagingMessagesImportCronJob } from 'src/modules/messaging/message-import-manager/crons/jobs/messaging-messages-import.cron.job';\n import { MessagingOngoingStaleCronJob } from 'src/modules/messaging/message-import-manager/crons/jobs/messaging-ongoing-stale.cron.job';\n-import { MessagingProcessFolderActionsCronJob } from 'src/modules/messaging/message-import-manager/crons/jobs/messaging-process-folder-actions.cron.job';\n import { MessagingRelaunchFailedMessageChannelsCronJob } from 'src/modules/messaging/message-import-manager/crons/jobs/messaging-relaunch-failed-message-channels.cron.job';\n import { MessagingGmailDriverModule } from 'src/modules/messaging/message-import-manager/drivers/gmail/messaging-gmail-driver.module';\n import { MessagingIMAPDriverModule } from 'src/modules/messaging/message-import-manager/drivers/imap/messaging-imap-driver.module';\n@@ -34,7 +32,6 @@ import { MessagingCleanCacheJob } from 'src/modules/messaging/message-import-man\n import { MessagingMessageListFetchJob } from 'src/modules/messaging/message-import-manager/jobs/messaging-message-list-fetch.job';\n import { MessagingMessagesImportJob } from 'src/modules/messaging/message-import-manager/jobs/messaging-messages-import.job';\n import { MessagingOngoingStaleJob } from 'src/modules/messaging/message-import-manager/jobs/messaging-ongoing-stale.job';\n-import { MessagingProcessFolderActionsJob } from 'src/modules/messaging/message-import-manager/jobs/messaging-process-folder-actions.job';\n import { MessagingRelaunchFailedMessageChannelJob } from 'src/modules/messaging/message-import-manager/jobs/messaging-relaunch-failed-message-channel.job';\n import { MessagingMessageImportManagerMessageChannelListener } from 'src/modules/messaging/message-import-manager/listeners/messaging-import-manager-message-channel.listener';\n import { MessagingAccountAuthenticationService } from 'src/modules/messaging/message-import-manager/services/messaging-account-authentication.service';\n@@ -83,18 +80,15 @@ import { MessagingMonitoringModule } from 'src/modules/messaging/monitoring/mess\n     MessagingMessageListFetchCronCommand,\n     MessagingMessagesImportCronCommand,\n     MessagingOngoingStaleCronCommand,\n-    MessagingProcessFolderActionsCronCommand,\n     MessagingRelaunchFailedMessageChannelsCronCommand,\n     MessagingSingleMessageImportCommand,\n     MessagingMessageListFetchJob,\n     MessagingMessagesImportJob,\n     MessagingOngoingStaleJob,\n-    MessagingProcessFolderActionsJob,\n     MessagingRelaunchFailedMessageChannelJob,\n     MessagingMessageListFetchCronJob,\n     MessagingMessagesImportCronJob,\n     MessagingOngoingStaleCronJob,\n-    MessagingProcessFolderActionsCronJob,\n     MessagingRelaunchFailedMessageChannelsCronJob,\n     MessagingAddSingleMessageToCacheForImportJob,\n     MessagingMessageImportManagerMessageChannelListener,\ndiff --git a/packages/twenty-server/src/modules/messaging/message-import-manager/services/messaging-message-list-fetch.service.spec.ts b/packages/twenty-server/src/modules/messaging/message-import-manager/services/messaging-message-list-fetch.service.spec.ts\nindex 6c6c14a77f4c3..1f24fbd578465 100644\n--- a/packages/twenty-server/src/modules/messaging/message-import-manager/services/messaging-message-list-fetch.service.spec.ts\n+++ b/packages/twenty-server/src/modules/messaging/message-import-manager/services/messaging-message-list-fetch.service.spec.ts\n@@ -16,6 +16,7 @@ import { MessagingGetMessageListService } from 'src/modules/messaging/message-im\n import { MessageImportExceptionHandlerService } from 'src/modules/messaging/message-import-manager/services/messaging-import-exception-handler.service';\n import { MessagingMessageListFetchService } from 'src/modules/messaging/message-import-manager/services/messaging-message-list-fetch.service';\n import { MessagingMessagesImportService } from 'src/modules/messaging/message-import-manager/services/messaging-messages-import.service';\n+import { MessagingProcessFolderActionsService } from 'src/modules/messaging/message-import-manager/services/messaging-process-folder-actions.service';\n import { MessagingProcessGroupEmailActionsService } from 'src/modules/messaging/message-import-manager/services/messaging-process-group-email-actions.service';\n \n describe('MessagingMessageListFetchService', () => {\n@@ -78,15 +79,21 @@ describe('MessagingMessageListFetchService', () => {\n     };\n \n     const mockMessageFolderRepository = {\n-      find: jest.fn().mockResolvedValue([\n-        {\n-          id: 'inbox-folder-id',\n-          name: 'inbox',\n-          syncCursor: 'inbox-sync-cursor',\n-          messageChannelId: 'microsoft-message-channel-id',\n-          isSynced: true,\n-        },\n-      ]),\n+      find: jest.fn().mockImplementation(({ where }) => {\n+        if (where?.pendingSyncAction === 'FOLDER_DELETION') {\n+          return [];\n+        }\n+\n+        return [\n+          {\n+            id: 'inbox-folder-id',\n+            name: 'inbox',\n+            syncCursor: 'inbox-sync-cursor',\n+            messageChannelId: 'microsoft-message-channel-id',\n+            isSynced: true,\n+          },\n+        ];\n+      }),\n     };\n \n     const module: TestingModule = await Test.createTestingModule({\n@@ -238,6 +245,12 @@ describe('MessagingMessageListFetchService', () => {\n             processGroupEmailActions: jest.fn().mockResolvedValue(undefined),\n           },\n         },\n+        {\n+          provide: MessagingProcessFolderActionsService,\n+          useValue: {\n+            processFolderActions: jest.fn().mockResolvedValue(undefined),\n+          },\n+        },\n       ],\n     }).compile();\n \ndiff --git a/packages/twenty-server/src/modules/messaging/message-import-manager/services/messaging-message-list-fetch.service.ts b/packages/twenty-server/src/modules/messaging/message-import-manager/services/messaging-message-list-fetch.service.ts\nindex 067742bfe16b3..bdff77fb58bd0 100644\n--- a/packages/twenty-server/src/modules/messaging/message-import-manager/services/messaging-message-list-fetch.service.ts\n+++ b/packages/twenty-server/src/modules/messaging/message-import-manager/services/messaging-message-list-fetch.service.ts\n@@ -30,6 +30,7 @@ import {\n   MessageImportSyncStep,\n } from 'src/modules/messaging/message-import-manager/services/messaging-import-exception-handler.service';\n import { MessagingMessagesImportService } from 'src/modules/messaging/message-import-manager/services/messaging-messages-import.service';\n+import { MessagingProcessFolderActionsService } from 'src/modules/messaging/message-import-manager/services/messaging-process-folder-actions.service';\n import { MessagingProcessGroupEmailActionsService } from 'src/modules/messaging/message-import-manager/services/messaging-process-group-email-actions.service';\n \n const ONE_WEEK_IN_MILLISECONDS = 7 * 24 * 60 * 60 * 1000;\n@@ -50,6 +51,7 @@ export class MessagingMessageListFetchService {\n     private readonly messagingAccountAuthenticationService: MessagingAccountAuthenticationService,\n     private readonly syncMessageFoldersService: SyncMessageFoldersService,\n     private readonly messagingProcessGroupEmailActionsService: MessagingProcessGroupEmailActionsService,\n+    private readonly messagingProcessFolderActionsService: MessagingProcessFolderActionsService,\n   ) {}\n \n   public async processMessageListFetch(\n@@ -57,21 +59,17 @@ export class MessagingMessageListFetchService {\n     workspaceId: string,\n   ) {\n     try {\n-      if (\n-        messageChannel.pendingGroupEmailsAction ===\n-          MessageChannelPendingGroupEmailsAction.GROUP_EMAILS_DELETION ||\n-        messageChannel.pendingGroupEmailsAction ===\n-          MessageChannelPendingGroupEmailsAction.GROUP_EMAILS_IMPORT\n-      ) {\n-        this.logger.log(\n-          `messageChannelId: ${messageChannel.id} Processing pending group emails action before message list fetch: ${messageChannel.pendingGroupEmailsAction}`,\n-        );\n+      const pendingGroupEmailActionsProcessed =\n+        await this.processPendingGroupEmailActions(messageChannel, workspaceId);\n \n-        await this.messagingProcessGroupEmailActionsService.processGroupEmailActions(\n-          messageChannel,\n-          workspaceId,\n-        );\n+      if (pendingGroupEmailActionsProcessed) {\n+        return;\n+      }\n+\n+      const pendingFolderActionsProcessed =\n+        await this.processPendingFolderActions(messageChannel, workspaceId);\n \n+      if (pendingFolderActionsProcessed) {\n         return;\n       }\n \n@@ -288,6 +286,65 @@ export class MessagingMessageListFetchService {\n     }\n   }\n \n+  private async processPendingGroupEmailActions(\n+    messageChannel: MessageChannelWorkspaceEntity,\n+    workspaceId: string,\n+  ): Promise<boolean> {\n+    const hasPendingGroupEmailAction =\n+      messageChannel.pendingGroupEmailsAction ===\n+        MessageChannelPendingGroupEmailsAction.GROUP_EMAILS_DELETION ||\n+      messageChannel.pendingGroupEmailsAction ===\n+        MessageChannelPendingGroupEmailsAction.GROUP_EMAILS_IMPORT;\n+\n+    if (!hasPendingGroupEmailAction) {\n+      return false;\n+    }\n+\n+    this.logger.log(\n+      `messageChannelId: ${messageChannel.id} Processing pending group emails action before message list fetch: ${messageChannel.pendingGroupEmailsAction}`,\n+    );\n+\n+    await this.messagingProcessGroupEmailActionsService.processGroupEmailActions(\n+      messageChannel,\n+      workspaceId,\n+    );\n+\n+    return true;\n+  }\n+\n+  private async processPendingFolderActions(\n+    messageChannel: MessageChannelWorkspaceEntity,\n+    workspaceId: string,\n+  ): Promise<boolean> {\n+    const messageFolderRepository =\n+      await this.twentyORMManager.getRepository<MessageFolderWorkspaceEntity>(\n+        'messageFolder',\n+      );\n+\n+    const foldersWithPendingActions = await messageFolderRepository.find({\n+      where: {\n+        messageChannelId: messageChannel.id,\n+        pendingSyncAction: MessageFolderPendingSyncAction.FOLDER_DELETION,\n+      },\n+    });\n+\n+    if (foldersWithPendingActions.length === 0) {\n+      return false;\n+    }\n+\n+    this.logger.log(\n+      `messageChannelId: ${messageChannel.id} Processing pending folder actions before message list fetch`,\n+    );\n+\n+    await this.messagingProcessFolderActionsService.processFolderActions(\n+      messageChannel,\n+      foldersWithPendingActions,\n+      workspaceId,\n+    );\n+\n+    return true;\n+  }\n+\n   private async computeFullSyncMessageChannelMessageAssociationsToDelete(\n     messageChannel: Pick<MessageChannelWorkspaceEntity, 'id'>,\n     messageExternalIds: string[],\n",
        "pr_mirror": "twentyhq__twenty.main"
    }
}