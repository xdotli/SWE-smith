{
    "cost": 0.079225,
    "rewrites": {
        "twentyhq__twenty.main/packages/twenty-server/src/modules/messaging/message-import-manager/services/messaging-messages-import.service.ts": {
            "output": "import { Injectable, Logger } from '@nestjs/common';\n\nimport { isDefined } from 'twenty-shared/utils';\n\nimport { InjectCacheStorage } from 'src/engine/core-modules/cache-storage/decorators/cache-storage.decorator';\nimport { CacheStorageService } from 'src/engine/core-modules/cache-storage/services/cache-storage.service';\nimport { CacheStorageNamespace } from 'src/engine/core-modules/cache-storage/types/cache-storage-namespace.enum';\nimport { InjectObjectMetadataRepository } from 'src/engine/object-metadata-repository/object-metadata-repository.decorator';\nimport { TwentyORMManager } from 'src/engine/twenty-orm/twenty-orm.manager';\nimport { BlocklistRepository } from 'src/modules/blocklist/repositories/blocklist.repository';\nimport { BlocklistWorkspaceEntity } from 'src/modules/blocklist/standard-objects/blocklist.workspace-entity';\nimport { EmailAliasManagerService } from 'src/modules/connected-account/email-alias-manager/services/email-alias-manager.service';\nimport { type ConnectedAccountWorkspaceEntity } from 'src/modules/connected-account/standard-objects/connected-account.workspace-entity';\nimport { MessageChannelSyncStatusService } from 'src/modules/messaging/common/services/message-channel-sync-status.service';\nimport {\n  MessageChannelSyncStage,\n  type MessageChannelWorkspaceEntity,\n} from 'src/modules/messaging/common/standard-objects/message-channel.workspace-entity';\nimport {\n  MessageImportDriverException,\n  MessageImportDriverExceptionCode,\n} from 'src/modules/messaging/message-import-manager/drivers/exceptions/message-import-driver.exception';\nimport { MESSAGING_GMAIL_USERS_MESSAGES_GET_BATCH_SIZE } from 'src/modules/messaging/message-import-manager/drivers/gmail/constants/messaging-gmail-users-messages-get-batch-size.constant';\nimport { MessagingAccountAuthenticationService } from 'src/modules/messaging/message-import-manager/services/messaging-account-authentication.service';\nimport { MessagingGetMessagesService } from 'src/modules/messaging/message-import-manager/services/messaging-get-messages.service';\nimport {\n  MessageImportExceptionHandlerService,\n  MessageImportSyncStep,\n} from 'src/modules/messaging/message-import-manager/services/messaging-import-exception-handler.service';\nimport { MessagingSaveMessagesAndEnqueueContactCreationService } from 'src/modules/messaging/message-import-manager/services/messaging-save-messages-and-enqueue-contact-creation.service';\nimport { filterEmails } from 'src/modules/messaging/message-import-manager/utils/filter-emails.util';\nimport { MessagingMonitoringService } from 'src/modules/messaging/monitoring/services/messaging-monitoring.service';\n@Injectable()\nexport class MessagingMessagesImportService {\n  private readonly logger = new Logger(MessagingMessagesImportService.name);\n\n  constructor(\n    @InjectCacheStorage(CacheStorageNamespace.ModuleMessaging)\n    private readonly cacheStorage: CacheStorageService,\n    private readonly messageChannelSyncStatusService: MessageChannelSyncStatusService,\n    private readonly saveMessagesAndEnqueueContactCreationService: MessagingSaveMessagesAndEnqueueContactCreationService,\n    private readonly messagingMonitoringService: MessagingMonitoringService,\n    @InjectObjectMetadataRepository(BlocklistWorkspaceEntity)\n    private readonly blocklistRepository: BlocklistRepository,\n    private readonly emailAliasManagerService: EmailAliasManagerService,\n    private readonly twentyORMManager: TwentyORMManager,\n    private readonly messagingGetMessagesService: MessagingGetMessagesService,\n    private readonly messageImportErrorHandlerService: MessageImportExceptionHandlerService,\n    private readonly messagingAccountAuthenticationService: MessagingAccountAuthenticationService,\n  ) {}\n\n  async processMessageBatchImport(\n    messageChannel: MessageChannelWorkspaceEntity,\n    connectedAccount: ConnectedAccountWorkspaceEntity,\n    workspaceId: string,\n  ) {\n    let messageIdsToFetch: string[] = [];\n\n    try {\n      if (\n        messageChannel.syncStage !==\n        MessageChannelSyncStage.MESSAGES_IMPORT_PENDING\n      ) {\n        return;\n      }\n\n      await this.messagingMonitoringService.track({\n        eventName: 'messages_import.started',\n        workspaceId,\n        connectedAccountId: messageChannel.connectedAccountId,\n        messageChannelId: messageChannel.id,\n      });\n\n      await this.messageChannelSyncStatusService.markAsMessagesImportOngoing(\n        [messageChannel.id],\n        workspaceId,\n      );\n\n      const { accessToken, refreshToken } =\n        await this.messagingAccountAuthenticationService.validateAndRefreshConnectedAccountAuthentication(\n          {\n            connectedAccount,\n            workspaceId,\n            messageChannelId: messageChannel.id,\n          },\n        );\n\n      const connectedAccountWithFreshTokens = {\n        ...connectedAccount,\n        accessToken,\n        refreshToken,\n      };\n\n      await this.emailAliasManagerService.refreshHandleAliases(\n        connectedAccountWithFreshTokens,\n      );\n\n      messageIdsToFetch = await this.cacheStorage.setPop(\n        `messages-to-import:${workspaceId}:${messageChannel.id}`,\n        MESSAGING_GMAIL_USERS_MESSAGES_GET_BATCH_SIZE,\n      );\n\n      if (!messageIdsToFetch?.length) {\n        await this.messageChannelSyncStatusService.markAsCompletedAndScheduleMessageListFetch(\n          [messageChannel.id],\n          workspaceId,\n        );\n\n        return await this.trackMessageImportCompleted(\n          messageChannel,\n          workspaceId,\n        );\n      }\n\n      const allMessages = await this.messagingGetMessagesService.getMessages(\n        messageIdsToFetch,\n        connectedAccountWithFreshTokens,\n      );\n\n      const blocklist = await this.blocklistRepository.getByWorkspaceMemberId(\n        connectedAccountWithFreshTokens.accountOwnerId,\n        workspaceId,\n      );\n\n      if (!isDefined(messageChannel.handle)) {\n        throw new MessageImportDriverException(\n          'Message channel handle is required',\n          MessageImportDriverExceptionCode.CHANNEL_MISCONFIGURED,\n        );\n      }\n\n      if (!isDefined(connectedAccountWithFreshTokens.handleAliases)) {\n        throw new MessageImportDriverException(\n          'Message channel handle is required',\n          MessageImportDriverExceptionCode.CHANNEL_MISCONFIGURED,\n        );\n      }\n\n      const messagesToSave = filterEmails(\n        messageChannel.handle,\n        [...connectedAccountWithFreshTokens.handleAliases.split(',')],\n        allMessages,\n        blocklist\n          .map((blocklistItem) => blocklistItem.handle)\n          .filter(isDefined),\n        messageChannel.excludeGroupEmails,\n      );\n\n      if (messagesToSave.length > 0) {\n        await this.saveMessagesAndEnqueueContactCreationService.saveMessagesAndEnqueueContactCreation(\n          messagesToSave,\n          messageChannel,\n          connectedAccountWithFreshTokens,\n          workspaceId,\n        );\n      }\n\n      if (\n        messageIdsToFetch.length < MESSAGING_GMAIL_USERS_MESSAGES_GET_BATCH_SIZE\n      ) {\n        await this.messageChannelSyncStatusService.markAsCompletedAndScheduleMessageListFetch(\n          [messageChannel.id],\n          workspaceId,\n        );\n      } else {\n        await this.messageChannelSyncStatusService.scheduleMessagesImport(\n          [messageChannel.id],\n          workspaceId,\n        );\n      }\n\n      const messageChannelRepository =\n        await this.twentyORMManager.getRepository<MessageChannelWorkspaceEntity>(\n          'messageChannel',\n        );\n\n      await messageChannelRepository.update(\n        {\n          id: messageChannel.id,\n        },\n        {\n          throttleFailureCount: 0,\n          syncStageStartedAt: null,\n        },\n      );\n\n      return await this.trackMessageImportCompleted(\n        messageChannel,\n        workspaceId,\n      );\n    } catch (error) {\n      // TODO: remove this log once we catch better the error codes\n      this.logger.error(\n        `Error (${error.code}) importing messages for workspace ${workspaceId.slice(0, 8)} and account ${connectedAccount.id.slice(0, 8)}: ${error.message} - ${error.body}`,\n      );\n      await this.cacheStorage.setAdd(\n        `messages-to-import:${workspaceId}:${messageChannel.id}`,\n        messageIdsToFetch,\n      );\n\n      await this.messageImportErrorHandlerService.handleDriverException(\n        error,\n        MessageImportSyncStep.MESSAGES_IMPORT_ONGOING,\n        messageChannel,\n        workspaceId,\n      );\n\n      return await this.trackMessageImportCompleted(\n        messageChannel,\n        workspaceId,\n      );\n    }\n  }\n\n  private async trackMessageImportCompleted(\n    messageChannel: MessageChannelWorkspaceEntity,\n    workspaceId: string,\n  ) {\n    await this.messagingMonitoringService.track({\n      eventName: 'messages_import.completed',\n      workspaceId,\n      connectedAccountId: messageChannel.connectedAccountId,\n      messageChannelId: messageChannel.id,\n    });\n  }\n}",
            "output_extracted": "import { Injectable, Logger } from '@nestjs/common';\n\nimport { isDefined } from 'twenty-shared/utils';\n\nimport { InjectCacheStorage } from 'src/engine/core-modules/cache-storage/decorators/cache-storage.decorator';\nimport { CacheStorageService } from 'src/engine/core-modules/cache-storage/services/cache-storage.service';\nimport { CacheStorageNamespace } from 'src/engine/core-modules/cache-storage/types/cache-storage-namespace.enum';\nimport { InjectObjectMetadataRepository } from 'src/engine/object-metadata-repository/object-metadata-repository.decorator';\nimport { TwentyORMManager } from 'src/engine/twenty-orm/twenty-orm.manager';\nimport { BlocklistRepository } from 'src/modules/blocklist/repositories/blocklist.repository';\nimport { BlocklistWorkspaceEntity } from 'src/modules/blocklist/standard-objects/blocklist.workspace-entity';\nimport { EmailAliasManagerService } from 'src/modules/connected-account/email-alias-manager/services/email-alias-manager.service';\nimport { type ConnectedAccountWorkspaceEntity } from 'src/modules/connected-account/standard-objects/connected-account.workspace-entity';\nimport { MessageChannelSyncStatusService } from 'src/modules/messaging/common/services/message-channel-sync-status.service';\nimport {\n  MessageChannelSyncStage,\n  type MessageChannelWorkspaceEntity,\n} from 'src/modules/messaging/common/standard-objects/message-channel.workspace-entity';\nimport {\n  MessageImportDriverException,\n  MessageImportDriverExceptionCode,\n} from 'src/modules/messaging/message-import-manager/drivers/exceptions/message-import-driver.exception';\nimport { MESSAGING_GMAIL_USERS_MESSAGES_GET_BATCH_SIZE } from 'src/modules/messaging/message-import-manager/drivers/gmail/constants/messaging-gmail-users-messages-get-batch-size.constant';\nimport { MessagingAccountAuthenticationService } from 'src/modules/messaging/message-import-manager/services/messaging-account-authentication.service';\nimport { MessagingGetMessagesService } from 'src/modules/messaging/message-import-manager/services/messaging-get-messages.service';\nimport {\n  MessageImportExceptionHandlerService,\n  MessageImportSyncStep,\n} from 'src/modules/messaging/message-import-manager/services/messaging-import-exception-handler.service';\nimport { MessagingSaveMessagesAndEnqueueContactCreationService } from 'src/modules/messaging/message-import-manager/services/messaging-save-messages-and-enqueue-contact-creation.service';\nimport { filterEmails } from 'src/modules/messaging/message-import-manager/utils/filter-emails.util';\nimport { MessagingMonitoringService } from 'src/modules/messaging/monitoring/services/messaging-monitoring.service';\n@Injectable()\nexport class MessagingMessagesImportService {\n  private readonly logger = new Logger(MessagingMessagesImportService.name);\n\n  constructor(\n    @InjectCacheStorage(CacheStorageNamespace.ModuleMessaging)\n    private readonly cacheStorage: CacheStorageService,\n    private readonly messageChannelSyncStatusService: MessageChannelSyncStatusService,\n    private readonly saveMessagesAndEnqueueContactCreationService: MessagingSaveMessagesAndEnqueueContactCreationService,\n    private readonly messagingMonitoringService: MessagingMonitoringService,\n    @InjectObjectMetadataRepository(BlocklistWorkspaceEntity)\n    private readonly blocklistRepository: BlocklistRepository,\n    private readonly emailAliasManagerService: EmailAliasManagerService,\n    private readonly twentyORMManager: TwentyORMManager,\n    private readonly messagingGetMessagesService: MessagingGetMessagesService,\n    private readonly messageImportErrorHandlerService: MessageImportExceptionHandlerService,\n    private readonly messagingAccountAuthenticationService: MessagingAccountAuthenticationService,\n  ) {}\n\n  async processMessageBatchImport(\n    messageChannel: MessageChannelWorkspaceEntity,\n    connectedAccount: ConnectedAccountWorkspaceEntity,\n    workspaceId: string,\n  ) {\n    let messageIdsToFetch: string[] = [];\n\n    try {\n      if (\n        messageChannel.syncStage !==\n        MessageChannelSyncStage.MESSAGES_IMPORT_PENDING\n      ) {\n        return;\n      }\n\n      await this.messagingMonitoringService.track({\n        eventName: 'messages_import.started',\n        workspaceId,\n        connectedAccountId: messageChannel.connectedAccountId,\n        messageChannelId: messageChannel.id,\n      });\n\n      await this.messageChannelSyncStatusService.markAsMessagesImportOngoing(\n        [messageChannel.id],\n        workspaceId,\n      );\n\n      const { accessToken, refreshToken } =\n        await this.messagingAccountAuthenticationService.validateAndRefreshConnectedAccountAuthentication(\n          {\n            connectedAccount,\n            workspaceId,\n            messageChannelId: messageChannel.id,\n          },\n        );\n\n      const connectedAccountWithFreshTokens = {\n        ...connectedAccount,\n        accessToken,\n        refreshToken,\n      };\n\n      await this.emailAliasManagerService.refreshHandleAliases(\n        connectedAccountWithFreshTokens,\n      );\n\n      messageIdsToFetch = await this.cacheStorage.setPop(\n        `messages-to-import:${workspaceId}:${messageChannel.id}`,\n        MESSAGING_GMAIL_USERS_MESSAGES_GET_BATCH_SIZE,\n      );\n\n      if (!messageIdsToFetch?.length) {\n        await this.messageChannelSyncStatusService.markAsCompletedAndScheduleMessageListFetch(\n          [messageChannel.id],\n          workspaceId,\n        );\n\n        return await this.trackMessageImportCompleted(\n          messageChannel,\n          workspaceId,\n        );\n      }\n\n      const allMessages = await this.messagingGetMessagesService.getMessages(\n        messageIdsToFetch,\n        connectedAccountWithFreshTokens,\n      );\n\n      const blocklist = await this.blocklistRepository.getByWorkspaceMemberId(\n        connectedAccountWithFreshTokens.accountOwnerId,\n        workspaceId,\n      );\n\n      if (!isDefined(messageChannel.handle)) {\n        throw new MessageImportDriverException(\n          'Message channel handle is required',\n          MessageImportDriverExceptionCode.CHANNEL_MISCONFIGURED,\n        );\n      }\n\n      if (!isDefined(connectedAccountWithFreshTokens.handleAliases)) {\n        throw new MessageImportDriverException(\n          'Message channel handle is required',\n          MessageImportDriverExceptionCode.CHANNEL_MISCONFIGURED,\n        );\n      }\n\n      const messagesToSave = filterEmails(\n        messageChannel.handle,\n        [...connectedAccountWithFreshTokens.handleAliases.split(',')],\n        allMessages,\n        blocklist\n          .map((blocklistItem) => blocklistItem.handle)\n          .filter(isDefined),\n        messageChannel.excludeGroupEmails,\n      );\n\n      if (messagesToSave.length > 0) {\n        await this.saveMessagesAndEnqueueContactCreationService.saveMessagesAndEnqueueContactCreation(\n          messagesToSave,\n          messageChannel,\n          connectedAccountWithFreshTokens,\n          workspaceId,\n        );\n      }\n\n      if (\n        messageIdsToFetch.length < MESSAGING_GMAIL_USERS_MESSAGES_GET_BATCH_SIZE\n      ) {\n        await this.messageChannelSyncStatusService.markAsCompletedAndScheduleMessageListFetch(\n          [messageChannel.id],\n          workspaceId,\n        );\n      } else {\n        await this.messageChannelSyncStatusService.scheduleMessagesImport(\n          [messageChannel.id],\n          workspaceId,\n        );\n      }\n\n      const messageChannelRepository =\n        await this.twentyORMManager.getRepository<MessageChannelWorkspaceEntity>(\n          'messageChannel',\n        );\n\n      await messageChannelRepository.update(\n        {\n          id: messageChannel.id,\n        },\n        {\n          throttleFailureCount: 0,\n          syncStageStartedAt: null,\n        },\n      );\n\n      return await this.trackMessageImportCompleted(\n        messageChannel,\n        workspaceId,\n      );\n    } catch (error) {\n      // TODO: remove this log once we catch better the error codes\n      this.logger.error(\n        `Error (${error.code}) importing messages for workspace ${workspaceId.slice(0, 8)} and account ${connectedAccount.id.slice(0, 8)}: ${error.message} - ${error.body}`,\n      );\n      await this.cacheStorage.setAdd(\n        `messages-to-import:${workspaceId}:${messageChannel.id}`,\n        messageIdsToFetch,\n      );\n\n      await this.messageImportErrorHandlerService.handleDriverException(\n        error,\n        MessageImportSyncStep.MESSAGES_IMPORT_ONGOING,\n        messageChannel,\n        workspaceId,\n      );\n\n      return await this.trackMessageImportCompleted(\n        messageChannel,\n        workspaceId,\n      );\n    }\n  }\n\n  private async trackMessageImportCompleted(\n    messageChannel: MessageChannelWorkspaceEntity,\n    workspaceId: string,\n  ) {\n    await this.messagingMonitoringService.track({\n      eventName: 'messages_import.completed',\n      workspaceId,\n      connectedAccountId: messageChannel.connectedAccountId,\n      messageChannelId: messageChannel.id,\n    });\n  }\n}",
            "cost": 0.079225
        }
    },
    "recover_status": "success",
    "instance_ref": {
        "instance_id": "twentyhq__twenty.main.16071",
        "repo": "twentyhq/twenty",
        "base_commit": "6c1c78ea3d94ac6dc3031c00bd67fa28aa5d16db",
        "head_commit": "afeb0ad57ff4e7d34356a1bb18af9ae1f8af9304",
        "title": "Fix message import scheduled",
        "merged_at": "2025-11-26T07:54:53Z",
        "html_url": "https://github.com/twentyhq/twenty/pull/16071",
        "test_files": [
            "packages/twenty-server/src/modules/messaging/message-import-manager/services/messaging-messages-import.service.spec.ts"
        ],
        "code_files": [
            "packages/twenty-server/src/modules/messaging/message-import-manager/services/messaging-messages-import.service.ts"
        ],
        "total_changes": 8,
        "num_files": 2,
        "pull_number": 16071,
        "patch": "diff --git a/packages/twenty-server/src/modules/messaging/message-import-manager/services/messaging-messages-import.service.spec.ts b/packages/twenty-server/src/modules/messaging/message-import-manager/services/messaging-messages-import.service.spec.ts\nindex f973b916cf4ef..f11d03923f6c2 100644\n--- a/packages/twenty-server/src/modules/messaging/message-import-manager/services/messaging-messages-import.service.spec.ts\n+++ b/packages/twenty-server/src/modules/messaging/message-import-manager/services/messaging-messages-import.service.spec.ts\n@@ -49,7 +49,7 @@ describe('MessagingMessagesImportService', () => {\n \n     mockMessageChannel = {\n       id: 'message-channel-id',\n-      syncStage: MessageChannelSyncStage.MESSAGES_IMPORT_PENDING,\n+      syncStage: MessageChannelSyncStage.MESSAGES_IMPORT_SCHEDULED,\n       connectedAccountId: mockConnectedAccount.id,\n       handle: 'test@gmail.com',\n     } as MessageChannelWorkspaceEntity;\n@@ -192,9 +192,9 @@ describe('MessagingMessagesImportService', () => {\n       );\n   });\n \n-  it('should fails if SyncStage is not MESSAGES_IMPORT_PENDING', async () => {\n+  it('should fails if SyncStage is not MESSAGES_IMPORT_SCHEDULED', async () => {\n     mockMessageChannel.syncStage =\n-      MessageChannelSyncStage.MESSAGE_LIST_FETCH_PENDING;\n+      MessageChannelSyncStage.MESSAGES_IMPORT_PENDING;\n \n     expect(\n       service.processMessageBatchImport(\ndiff --git a/packages/twenty-server/src/modules/messaging/message-import-manager/services/messaging-messages-import.service.ts b/packages/twenty-server/src/modules/messaging/message-import-manager/services/messaging-messages-import.service.ts\nindex 57ffaa8e4136c..73e448df7cf03 100644\n--- a/packages/twenty-server/src/modules/messaging/message-import-manager/services/messaging-messages-import.service.ts\n+++ b/packages/twenty-server/src/modules/messaging/message-import-manager/services/messaging-messages-import.service.ts\n@@ -53,7 +53,7 @@ export class MessagingMessagesImportService {\n     try {\n       if (\n         messageChannel.syncStage !==\n-        MessageChannelSyncStage.MESSAGES_IMPORT_PENDING\n+        MessageChannelSyncStage.MESSAGES_IMPORT_SCHEDULED\n       ) {\n         return;\n       }\n",
        "pr_mirror": "twentyhq__twenty.main"
    }
}