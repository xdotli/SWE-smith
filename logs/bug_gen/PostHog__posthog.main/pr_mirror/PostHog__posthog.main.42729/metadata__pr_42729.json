{
    "cost": 0.18071500000000001,
    "rewrites": {
        "PostHog__posthog.main/frontend/src/scenes/session-recordings/player/rrweb/index.test.ts": {
            "output": "import { CorsPlugin, WindowTitlePlugin } from '.'\n\ndescribe('CorsPlugin', () => {\n    it.each(['https://some-external.js'])('should replace JS urls', (jsUrl) => {\n        expect(CorsPlugin._replaceJSUrl(jsUrl)).toEqual(`https://replay.ph-proxy.com/proxy?url=${jsUrl}`)\n    })\n    it.each([\n        `@font-face { font-display: fallback; font-family: \"Roboto Condensed\"; font-weight: 400; font-style: normal; src: url(\"https://posthog.com/assets/fonts/roboto/roboto_condensed_reg-webfont.woff2?11012022\") format(\"woff2\"), url(\"https://posthog.com/assets/fonts/roboto/roboto_condensed_reg-webfont.woff?11012022\")`,\n        `url(\"https://app.posthog.com/fonts/my-font.woff2\")`,\n    ])('should replace font urls in stylesheets', (content: string) => {\n        expect(CorsPlugin._replaceFontCssUrls(content)).toMatchSnapshot()\n    })\n\n    it.each(['https://app.posthog.com/fonts/my-font.woff2?t=1234', 'https://app.posthog.com/fonts/my-font.ttf'])(\n        'should replace font urls in links',\n        (content: string) => {\n            expect(CorsPlugin._replaceFontUrl(content)).toEqual(`https://replay.ph-proxy.com/proxy?url=${content}`)\n        }\n    )\n\n    it.each([\n        'https://app.posthog.com/my-image.jpeg',\n        // ttf substring was matching in a previous version\n        'https://app-static.eu.posthog.com/static/index-EBVVDttf.css',\n    ])('should not replace non-font urls in links', (content: string) => {\n        expect(CorsPlugin._replaceFontUrl(content)).toEqual(content)\n    })\n\n    it('can replace a modulepreload js link', () => {\n        const el = document.createElement('link')\n        el.setAttribute('rel', 'modulepreload')\n        el.href = 'https://app.posthog.com/my-image.js'\n        CorsPlugin.onBuild?.(el, { id: 1, replayer: null as unknown as any })\n        expect(el.href).toEqual(`https://replay.ph-proxy.com/proxy?url=https://app.posthog.com/my-image.js`)\n    })\n\n    it('can replace a stylesheet css link', () => {\n        const el = document.createElement('link')\n        el.setAttribute('rel', 'stylesheet')\n        el.href = 'https://app.posthog.com/assets/styles.css'\n        CorsPlugin.onBuild?.(el, { id: 1, replayer: null as unknown as any })\n        expect(el.href).toEqual(`https://replay.ph-proxy.com/proxy?url=https://app.posthog.com/assets/styles.css`)\n    })\n\n    it('can replace a stylesheet css link with query parameters', () => {\n        const el = document.createElement('link')\n        el.setAttribute('rel', 'stylesheet')\n        el.href = 'https://app.posthog.com/assets/styles.css?v=123'\n        CorsPlugin.onBuild?.(el, { id: 1, replayer: null as unknown as any })\n        expect(el.href).toEqual(`https://replay.ph-proxy.com/proxy?url=https://app.posthog.com/assets/styles.css?v=123`)\n    })\n\n    it.each([\n        'https://app.posthog.com/styles.css',\n        'https://app.posthog.com/styles.css?v=123',\n        'https://app.posthog.com/assets/main.css?t=1234567890',\n    ])('should replace CSS urls', (cssUrl) => {\n        expect(CorsPlugin._replaceCSSUrl(cssUrl)).toEqual(`https://replay.ph-proxy.com/proxy?url=${cssUrl}`)\n    })\n})\n\ndescribe('WindowTitlePlugin', () => {\n    it('issues a callback with a valid full snapshot and subsequent incremental mutations', () => {\n        const mockCallback = jest.fn()\n        const plugin = WindowTitlePlugin(mockCallback)\n        plugin.handler?.(\n            {\n                windowId: '0191dd6c-cd35-71ad-9114-264ebef5ab38',\n                type: 2,\n                data: {\n                    node: {\n                        type: 0,\n                        childNodes: [\n                            {\n                                type: 1,\n                                name: 'html',\n                            },\n                            {\n                                type: 2,\n                                tagName: 'html',\n                                childNodes: [\n                                    {\n                                        type: 2,\n                                        tagName: 'head',\n                                        childNodes: [\n                                            {\n                                                type: 2,\n                                                tagName: 'meta',\n                                            },\n                                            {\n                                                type: 2,\n                                                tagName: 'title',\n                                                attributes: {},\n                                                childNodes: [\n                                                    {\n                                                        id: 123456789,\n                                                        type: 3,\n                                                        textContent: 'Recordings \u2022 PostHog',\n                                                    },\n                                                ],\n                                            },\n                                        ],\n                                    },\n                                ],\n                            },\n                        ],\n                    },\n                },\n            } as any,\n            true,\n            { replayer: null as unknown as any }\n        )\n        expect(mockCallback).toHaveBeenCalledWith('0191dd6c-cd35-71ad-9114-264ebef5ab38', 'Recordings \u2022 PostHog')\n\n        mockCallback.mockClear()\n\n        plugin.handler?.(\n            {\n                type: 3,\n                windowId: '0191dd6c-cd35-71ad-9114-264ebef5ab38',\n                data: { texts: [{ id: 123, value: 'PostHog \u2022 A new title' }] },\n            } as any,\n            true,\n            { replayer: null as unknown as any }\n        )\n        // not called because the id is not a title element\n        expect(mockCallback).not.toHaveBeenCalled()\n\n        plugin.handler?.(\n            {\n                type: 3,\n                windowId: '0191dd6c-cd35-71ad-9114-264ebef5ab38',\n                data: { source: 0, texts: [{ id: 123456789, value: 'PostHog \u2022 A new title' }] },\n            } as any,\n            true,\n            { replayer: null as unknown as any }\n        )\n        // callback for title node\n        expect(mockCallback).toHaveBeenCalledWith('0191dd6c-cd35-71ad-9114-264ebef5ab38', 'PostHog \u2022 A new title')\n\n        // new full snapshot\n        mockCallback.mockClear()\n        plugin.handler?.(\n            {\n                windowId: '0191dd6c-cd35-71ad-9114-264ebef5ab38',\n                type: 2,\n                data: { node: { type: 0, childNodes: [] } },\n            } as any,\n            true,\n            { replayer: null as unknown as any }\n        )\n\n        plugin.handler?.(\n            {\n                type: 3,\n                windowId: '0191dd6c-cd35-71ad-9114-264ebef5ab38',\n                data: { source: 0, texts: [{ id: 123456789, value: 'PostHog \u2022 A new title' }] },\n            } as any,\n            true,\n            { replayer: null as unknown as any }\n        )\n        // not called because the title references have changed\n        expect(mockCallback).not.toHaveBeenCalled()\n    })\n\n    it('does not issue a callback when the windowId is missing', () => {\n        const mockCallback = jest.fn()\n        const plugin = WindowTitlePlugin(mockCallback)\n        plugin.handler?.(\n            {\n                type: 2,\n                data: {\n                    node: {\n                        type: 0,\n                        childNodes: [\n                            {\n                                type: 1,\n                                name: 'html',\n                            },\n                            {\n                                type: 2,\n                                tagName: 'html',\n                                childNodes: [\n                                    {\n                                        type: 2,\n                                        tagName: 'head',\n                                        childNodes: [\n                                            {\n                                                type: 2,\n                                                tagName: 'meta',\n                                            },\n                                            {\n                                                type: 2,\n                                                tagName: 'title',\n                                                attributes: {},\n                                                childNodes: [\n                                                    {\n                                                        type: 3,\n                                                        textContent: 'Recordings \u2022 PostHog',\n                                                    },\n                                                ],\n                                            },\n                                        ],\n                                    },\n                                ],\n                            },\n                        ],\n                    },\n                },\n            } as any,\n            true,\n            { replayer: null as unknown as any }\n        )\n        expect(mockCallback).not.toHaveBeenCalled()\n    })\n\n    it('does not issue a callback when no title in head element', () => {\n        const mockCallback = jest.fn()\n        const plugin = WindowTitlePlugin(mockCallback)\n        plugin.handler?.(\n            {\n                windowId: '0191dd6c-cd35-71ad-9114-264ebef5ab38',\n                type: 2,\n                data: {\n                    node: {\n                        type: 0,\n                        childNodes: [\n                            {\n                                type: 1,\n                                name: 'html',\n                            },\n                            {\n                                type: 2,\n                                tagName: 'html',\n                                childNodes: [\n                                    {\n                                        type: 2,\n                                        tagName: 'head',\n                                        childNodes: [\n                                            {\n                                                type: 2,\n                                                tagName: 'meta',\n                                            },\n                                        ],\n                                    },\n                                ],\n                            },\n                        ],\n                    },\n                },\n            } as any,\n            true,\n            { replayer: null as unknown as any }\n        )\n        expect(mockCallback).not.toHaveBeenCalled()\n    })\n})",
            "output_extracted": "import { CorsPlugin, WindowTitlePlugin } from '.'\n\ndescribe('CorsPlugin', () => {\n    it.each(['https://some-external.js'])('should replace JS urls', (jsUrl) => {\n        expect(CorsPlugin._replaceJSUrl(jsUrl)).toEqual(`https://replay.ph-proxy.com/proxy?url=${jsUrl}`)\n    })\n    it.each([\n        `@font-face { font-display: fallback; font-family: \"Roboto Condensed\"; font-weight: 400; font-style: normal; src: url(\"https://posthog.com/assets/fonts/roboto/roboto_condensed_reg-webfont.woff2?11012022\") format(\"woff2\"), url(\"https://posthog.com/assets/fonts/roboto/roboto_condensed_reg-webfont.woff?11012022\")`,\n        `url(\"https://app.posthog.com/fonts/my-font.woff2\")`,\n    ])('should replace font urls in stylesheets', (content: string) => {\n        expect(CorsPlugin._replaceFontCssUrls(content)).toMatchSnapshot()\n    })\n\n    it.each(['https://app.posthog.com/fonts/my-font.woff2?t=1234', 'https://app.posthog.com/fonts/my-font.ttf'])(\n        'should replace font urls in links',\n        (content: string) => {\n            expect(CorsPlugin._replaceFontUrl(content)).toEqual(`https://replay.ph-proxy.com/proxy?url=${content}`)\n        }\n    )\n\n    it.each([\n        'https://app.posthog.com/my-image.jpeg',\n        // ttf substring was matching in a previous version\n        'https://app-static.eu.posthog.com/static/index-EBVVDttf.css',\n    ])('should not replace non-font urls in links', (content: string) => {\n        expect(CorsPlugin._replaceFontUrl(content)).toEqual(content)\n    })\n\n    it('can replace a modulepreload js link', () => {\n        const el = document.createElement('link')\n        el.setAttribute('rel', 'modulepreload')\n        el.href = 'https://app.posthog.com/my-image.js'\n        CorsPlugin.onBuild?.(el, { id: 1, replayer: null as unknown as any })\n        expect(el.href).toEqual(`https://replay.ph-proxy.com/proxy?url=https://app.posthog.com/my-image.js`)\n    })\n\n    it('can replace a stylesheet css link', () => {\n        const el = document.createElement('link')\n        el.setAttribute('rel', 'stylesheet')\n        el.href = 'https://app.posthog.com/assets/styles.css'\n        CorsPlugin.onBuild?.(el, { id: 1, replayer: null as unknown as any })\n        expect(el.href).toEqual(`https://replay.ph-proxy.com/proxy?url=https://app.posthog.com/assets/styles.css`)\n    })\n\n    it('can replace a stylesheet css link with query parameters', () => {\n        const el = document.createElement('link')\n        el.setAttribute('rel', 'stylesheet')\n        el.href = 'https://app.posthog.com/assets/styles.css?v=123'\n        CorsPlugin.onBuild?.(el, { id: 1, replayer: null as unknown as any })\n        expect(el.href).toEqual(`https://replay.ph-proxy.com/proxy?url=https://app.posthog.com/assets/styles.css?v=123`)\n    })\n\n    it.each([\n        'https://app.posthog.com/styles.css',\n        'https://app.posthog.com/styles.css?v=123',\n        'https://app.posthog.com/assets/main.css?t=1234567890',\n    ])('should replace CSS urls', (cssUrl) => {\n        expect(CorsPlugin._replaceCSSUrl(cssUrl)).toEqual(`https://replay.ph-proxy.com/proxy?url=${cssUrl}`)\n    })\n})\n\ndescribe('WindowTitlePlugin', () => {\n    it('issues a callback with a valid full snapshot and subsequent incremental mutations', () => {\n        const mockCallback = jest.fn()\n        const plugin = WindowTitlePlugin(mockCallback)\n        plugin.handler?.(\n            {\n                windowId: '0191dd6c-cd35-71ad-9114-264ebef5ab38',\n                type: 2,\n                data: {\n                    node: {\n                        type: 0,\n                        childNodes: [\n                            {\n                                type: 1,\n                                name: 'html',\n                            },\n                            {\n                                type: 2,\n                                tagName: 'html',\n                                childNodes: [\n                                    {\n                                        type: 2,\n                                        tagName: 'head',\n                                        childNodes: [\n                                            {\n                                                type: 2,\n                                                tagName: 'meta',\n                                            },\n                                            {\n                                                type: 2,\n                                                tagName: 'title',\n                                                attributes: {},\n                                                childNodes: [\n                                                    {\n                                                        id: 123456789,\n                                                        type: 3,\n                                                        textContent: 'Recordings \u2022 PostHog',\n                                                    },\n                                                ],\n                                            },\n                                        ],\n                                    },\n                                ],\n                            },\n                        ],\n                    },\n                },\n            } as any,\n            true,\n            { replayer: null as unknown as any }\n        )\n        expect(mockCallback).toHaveBeenCalledWith('0191dd6c-cd35-71ad-9114-264ebef5ab38', 'Recordings \u2022 PostHog')\n\n        mockCallback.mockClear()\n\n        plugin.handler?.(\n            {\n                type: 3,\n                windowId: '0191dd6c-cd35-71ad-9114-264ebef5ab38',\n                data: { texts: [{ id: 123, value: 'PostHog \u2022 A new title' }] },\n            } as any,\n            true,\n            { replayer: null as unknown as any }\n        )\n        // not called because the id is not a title element\n        expect(mockCallback).not.toHaveBeenCalled()\n\n        plugin.handler?.(\n            {\n                type: 3,\n                windowId: '0191dd6c-cd35-71ad-9114-264ebef5ab38',\n                data: { source: 0, texts: [{ id: 123456789, value: 'PostHog \u2022 A new title' }] },\n            } as any,\n            true,\n            { replayer: null as unknown as any }\n        )\n        // callback for title node\n        expect(mockCallback).toHaveBeenCalledWith('0191dd6c-cd35-71ad-9114-264ebef5ab38', 'PostHog \u2022 A new title')\n\n        // new full snapshot\n        mockCallback.mockClear()\n        plugin.handler?.(\n            {\n                windowId: '0191dd6c-cd35-71ad-9114-264ebef5ab38',\n                type: 2,\n                data: { node: { type: 0, childNodes: [] } },\n            } as any,\n            true,\n            { replayer: null as unknown as any }\n        )\n\n        plugin.handler?.(\n            {\n                type: 3,\n                windowId: '0191dd6c-cd35-71ad-9114-264ebef5ab38',\n                data: { source: 0, texts: [{ id: 123456789, value: 'PostHog \u2022 A new title' }] },\n            } as any,\n            true,\n            { replayer: null as unknown as any }\n        )\n        // not called because the title references have changed\n        expect(mockCallback).not.toHaveBeenCalled()\n    })\n\n    it('does not issue a callback when the windowId is missing', () => {\n        const mockCallback = jest.fn()\n        const plugin = WindowTitlePlugin(mockCallback)\n        plugin.handler?.(\n            {\n                type: 2,\n                data: {\n                    node: {\n                        type: 0,\n                        childNodes: [\n                            {\n                                type: 1,\n                                name: 'html',\n                            },\n                            {\n                                type: 2,\n                                tagName: 'html',\n                                childNodes: [\n                                    {\n                                        type: 2,\n                                        tagName: 'head',\n                                        childNodes: [\n                                            {\n                                                type: 2,\n                                                tagName: 'meta',\n                                            },\n                                            {\n                                                type: 2,\n                                                tagName: 'title',\n                                                attributes: {},\n                                                childNodes: [\n                                                    {\n                                                        type: 3,\n                                                        textContent: 'Recordings \u2022 PostHog',\n                                                    },\n                                                ],\n                                            },\n                                        ],\n                                    },\n                                ],\n                            },\n                        ],\n                    },\n                },\n            } as any,\n            true,\n            { replayer: null as unknown as any }\n        )\n        expect(mockCallback).not.toHaveBeenCalled()\n    })\n\n    it('does not issue a callback when no title in head element', () => {\n        const mockCallback = jest.fn()\n        const plugin = WindowTitlePlugin(mockCallback)\n        plugin.handler?.(\n            {\n                windowId: '0191dd6c-cd35-71ad-9114-264ebef5ab38',\n                type: 2,\n                data: {\n                    node: {\n                        type: 0,\n                        childNodes: [\n                            {\n                                type: 1,\n                                name: 'html',\n                            },\n                            {\n                                type: 2,\n                                tagName: 'html',\n                                childNodes: [\n                                    {\n                                        type: 2,\n                                        tagName: 'head',\n                                        childNodes: [\n                                            {\n                                                type: 2,\n                                                tagName: 'meta',\n                                            },\n                                        ],\n                                    },\n                                ],\n                            },\n                        ],\n                    },\n                },\n            } as any,\n            true,\n            { replayer: null as unknown as any }\n        )\n        expect(mockCallback).not.toHaveBeenCalled()\n    })\n})",
            "cost": 0.08636
        },
        "PostHog__posthog.main/frontend/src/scenes/session-recordings/player/rrweb/index.ts": {
            "output": "import Hls from 'hls.js'\n\nimport { ReplayPlugin, playerConfig } from '@posthog/rrweb'\nimport { EventType, IncrementalSource, eventWithTime } from '@posthog/rrweb-types'\n\nexport const PLACEHOLDER_SVG_DATA_IMAGE_URL =\n    'url(\"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjE2IiBoZWlnaHQ9IjE2IiBmaWxsPSJibGFjayIvPgo8cGF0aCBkPSJNOCAwSDE2TDAgMTZWOEw4IDBaIiBmaWxsPSIjMkQyRDJEIi8+CjxwYXRoIGQ9Ik0xNiA4VjE2SDhMMTYgOFoiIGZpbGw9IiMyRDJEMkQiLz4KPC9zdmc+Cg==\");'\n\nconst PROXY_URL = 'https://replay.ph-proxy.com' as const\n\nexport const CorsPlugin: ReplayPlugin & {\n    _replaceFontCssUrls: (value: string | null) => string | null\n    _replaceFontUrl: (value: string) => string\n    _replaceJSUrl: (value: string) => string\n    _replaceCSSUrl: (value: string) => string\n} = {\n    _replaceFontCssUrls: (value: string | null): string | null => {\n        return (\n            value?.replace(\n                /url\\(\"(https:\\/\\/\\S*(?:\\.eot|\\.woff2|\\.ttf|\\.woff)\\S*)\"\\)/gi,\n                `url(\"${PROXY_URL}/proxy?url=$1\")`\n            ) || null\n        )\n    },\n\n    _replaceFontUrl: (value: string): string => {\n        return value.replace(/^(https:\\/\\/\\S*(?:\\.eot|\\.woff2|\\.ttf|\\.woff)\\S*)$/i, `${PROXY_URL}/proxy?url=$1`)\n    },\n\n    _replaceJSUrl: (value: string): string => {\n        return value.replace(/^(https:\\/\\/\\S*(?:\\.js)\\S*)$/i, `${PROXY_URL}/proxy?url=$1`)\n    },\n\n    _replaceCSSUrl: (value: string): string => {\n        return value.replace(/^(https:\\/\\/\\S*(?:\\.css)\\S*)$/i, `${PROXY_URL}/proxy?url=$1`)\n    },\n\n    onBuild: (node) => {\n        if (node.nodeName === 'STYLE') {\n            const styleElement = node as HTMLStyleElement\n            const childNodes = styleElement.childNodes\n            for (let i = 0; i < childNodes.length; i++) {\n                // not every node in a style element is text\n                // e.g. formatted text might cause some <br/> elements to be present\n                // separating lines of text\n                if (childNodes[i].nodeType == 3) {\n                    // then this is a text node\n                    // TODO what about CSS import URLs we could replace those too?\n                    const updatedContent = CorsPlugin._replaceFontCssUrls(childNodes[i].textContent)\n                    if (updatedContent !== childNodes[i].textContent) {\n                        childNodes[i].textContent = updatedContent\n                    }\n                }\n            }\n        }\n\n        if (node.nodeName === 'LINK') {\n            const linkElement = node as HTMLLinkElement\n            const href = linkElement.href\n            if (!href) {\n                return\n            }\n            const rel = linkElement.getAttribute('rel')\n            if (rel === 'modulepreload') {\n                linkElement.href = CorsPlugin._replaceJSUrl(href)\n            } else if (rel === 'stylesheet') {\n                linkElement.href = CorsPlugin._replaceCSSUrl(href)\n            } else {\n                linkElement.href = CorsPlugin._replaceFontUrl(href)\n            }\n        }\n\n        if (node.nodeName === 'SCRIPT') {\n            const scriptElement = node as HTMLScriptElement\n            scriptElement.src = CorsPlugin._replaceJSUrl(scriptElement.src)\n        }\n    },\n}\n\nexport type Node = {\n    id: number\n    type: number\n    tagName: string\n    childNodes: Node[]\n    textContent?: string\n}\n\nexport const WindowTitlePlugin = (cb: (windowId: string, title: string) => void): ReplayPlugin => {\n    const titleElementIds = new Set<number>()\n\n    const extractTitleTextEl = (node: Node): Node | undefined => {\n        // Document node\n        if (node.type === 0) {\n            const el = node.childNodes.find((n) => n.type === 2) // element node\n\n            if (el) {\n                const headEl = el.childNodes.filter((n) => n.type === 2).find((n) => n.tagName === 'head')\n\n                if (headEl) {\n                    const titleEl = headEl.childNodes.filter((n) => n.type === 2).find((n) => n.tagName === 'title')\n\n                    if (titleEl) {\n                        const textEl = titleEl.childNodes.find((n) => n.type === 3) // text node\n                        return textEl\n                    }\n                }\n            }\n        }\n    }\n\n    return {\n        handler: async (e: eventWithTime, isSync) => {\n            if ('windowId' in e && e.windowId && isSync) {\n                const windowId = e.windowId as string\n                if (e.type === EventType.FullSnapshot) {\n                    titleElementIds.clear()\n                    const el = extractTitleTextEl(e.data.node as Node)\n                    if (windowId && el && el.textContent) {\n                        titleElementIds.add(el.id)\n                        cb(windowId, el.textContent)\n                    }\n                } else if (e.type === EventType.IncrementalSnapshot && e.data.source === IncrementalSource.Mutation) {\n                    e.data.texts.forEach(({ id, value }) => {\n                        if (titleElementIds.has(id) && value) {\n                            cb(windowId, value)\n                        }\n                    })\n                }\n            }\n        },\n    }\n}\n\nexport const HLSPlayerPlugin: ReplayPlugin = {\n    onBuild: (node) => {\n        if (node && node.nodeName === 'VIDEO' && node.nodeType === 1) {\n            const videoEl = node as HTMLVideoElement\n            const hlsSrc = videoEl.getAttribute('hls-src')\n\n            if (videoEl && hlsSrc) {\n                if (Hls.isSupported()) {\n                    const hls = new Hls()\n                    hls.loadSource(hlsSrc)\n                    hls.attachMedia(videoEl)\n\n                    hls.on(Hls.Events.ERROR, (_, data) => {\n                        if (data.fatal) {\n                            switch (data.type) {\n                                case Hls.ErrorTypes.NETWORK_ERROR:\n                                    hls.startLoad()\n                                    break\n                                case Hls.ErrorTypes.MEDIA_ERROR:\n                                    hls.recoverMediaError()\n                                    break\n                                // Unrecoverable error\n                                default:\n                                    hls.destroy()\n                                    break\n                            }\n                        }\n                    })\n                }\n                // HLS not supported natively but can play in Safari\n                else if (videoEl.canPlayType('application/vnd.apple.mpegurl')) {\n                    videoEl.src = hlsSrc\n                }\n            }\n        }\n    },\n}\n\nconst defaultStyleRules = `.ph-no-capture { background-image: ${PLACEHOLDER_SVG_DATA_IMAGE_URL} }`\n// replaces a common rule in Shopify templates removed during capture\n// fix tracked in https://github.com/rrweb-io/rrweb/pull/1322\nconst shopifyShorthandCSSFix =\n    '@media (prefers-reduced-motion: no-preference) { .scroll-trigger:not(.scroll-trigger--offscreen).animate--slide-in { animation: var(--animation-slide-in) } }'\n\nexport type LogType = 'log' | 'warning'\nexport type LoggingTimers = Record<LogType, NodeJS.Timeout | null>\nexport type BuiltLogging = {\n    logger: playerConfig['logger']\n    timers: LoggingTimers\n}\n\nexport const makeNoOpLogger = (): BuiltLogging => {\n    return {\n        logger: {\n            log: () => {},\n            warn: () => {},\n        },\n        timers: { log: null, warning: null },\n    }\n}\n\nexport const makeLogger = (onIncrement: (count: number) => void): BuiltLogging => {\n    const counters = {\n        log: 0,\n        warning: 0,\n    }\n\n    ;(window as any)[`__posthog_player_logs`] = (window as any)[`__posthog_player_logs`] || []\n    ;(window as any)[`__posthog_player_warnings`] = (window as any)[`__posthog_player_warnings`] || []\n\n    const logStores: Record<LogType, any[]> = {\n        log: (window as any)[`__posthog_player_logs`],\n        warning: (window as any)[`__posthog_player_warnings`],\n    }\n\n    const timers: LoggingTimers = {\n        log: null,\n        warning: null,\n    }\n\n    const logger = (type: LogType): ((message?: any, ...optionalParams: any[]) => void) => {\n        // NOTE: RRWeb can log _alot_ of warnings,\n        // so we debounce the count otherwise we just end up making the performance worse\n        // We also don't log the messages directly.\n        // Sometimes the sheer size of messages and warnings can cause the browser to crash deserializing it all\n\n        return (...args: any[]): void => {\n            logStores[type].push(args)\n            counters[type] += 1\n\n            if (!timers[type]) {\n                timers[type] = setTimeout(() => {\n                    timers[type] = null\n                    if (type === 'warning') {\n                        onIncrement(logStores[type].length)\n                    }\n\n                    console.warn(\n                        `[PostHog Replayer] ${counters[type]} ${type}s (window.__posthog_player_${type}s to safely log them)`\n                    )\n                    counters[type] = 0\n                }, 5000)\n            }\n        }\n    }\n\n    return {\n        logger: {\n            log: logger('log'),\n            warn: logger('warning'),\n        },\n        timers,\n    }\n}\n\nexport const COMMON_REPLAYER_CONFIG: Partial<playerConfig> = {\n    triggerFocus: false,\n    insertStyleRules: [defaultStyleRules, shopifyShorthandCSSFix],\n}",
            "output_extracted": "import Hls from 'hls.js'\n\nimport { ReplayPlugin, playerConfig } from '@posthog/rrweb'\nimport { EventType, IncrementalSource, eventWithTime } from '@posthog/rrweb-types'\n\nexport const PLACEHOLDER_SVG_DATA_IMAGE_URL =\n    'url(\"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjE2IiBoZWlnaHQ9IjE2IiBmaWxsPSJibGFjayIvPgo8cGF0aCBkPSJNOCAwSDE2TDAgMTZWOEw4IDBaIiBmaWxsPSIjMkQyRDJEIi8+CjxwYXRoIGQ9Ik0xNiA4VjE2SDhMMTYgOFoiIGZpbGw9IiMyRDJEMkQiLz4KPC9zdmc+Cg==\");'\n\nconst PROXY_URL = 'https://replay.ph-proxy.com' as const\n\nexport const CorsPlugin: ReplayPlugin & {\n    _replaceFontCssUrls: (value: string | null) => string | null\n    _replaceFontUrl: (value: string) => string\n    _replaceJSUrl: (value: string) => string\n    _replaceCSSUrl: (value: string) => string\n} = {\n    _replaceFontCssUrls: (value: string | null): string | null => {\n        return (\n            value?.replace(\n                /url\\(\"(https:\\/\\/\\S*(?:\\.eot|\\.woff2|\\.ttf|\\.woff)\\S*)\"\\)/gi,\n                `url(\"${PROXY_URL}/proxy?url=$1\")`\n            ) || null\n        )\n    },\n\n    _replaceFontUrl: (value: string): string => {\n        return value.replace(/^(https:\\/\\/\\S*(?:\\.eot|\\.woff2|\\.ttf|\\.woff)\\S*)$/i, `${PROXY_URL}/proxy?url=$1`)\n    },\n\n    _replaceJSUrl: (value: string): string => {\n        return value.replace(/^(https:\\/\\/\\S*(?:\\.js)\\S*)$/i, `${PROXY_URL}/proxy?url=$1`)\n    },\n\n    _replaceCSSUrl: (value: string): string => {\n        return value.replace(/^(https:\\/\\/\\S*(?:\\.css)\\S*)$/i, `${PROXY_URL}/proxy?url=$1`)\n    },\n\n    onBuild: (node) => {\n        if (node.nodeName === 'STYLE') {\n            const styleElement = node as HTMLStyleElement\n            const childNodes = styleElement.childNodes\n            for (let i = 0; i < childNodes.length; i++) {\n                // not every node in a style element is text\n                // e.g. formatted text might cause some <br/> elements to be present\n                // separating lines of text\n                if (childNodes[i].nodeType == 3) {\n                    // then this is a text node\n                    // TODO what about CSS import URLs we could replace those too?\n                    const updatedContent = CorsPlugin._replaceFontCssUrls(childNodes[i].textContent)\n                    if (updatedContent !== childNodes[i].textContent) {\n                        childNodes[i].textContent = updatedContent\n                    }\n                }\n            }\n        }\n\n        if (node.nodeName === 'LINK') {\n            const linkElement = node as HTMLLinkElement\n            const href = linkElement.href\n            if (!href) {\n                return\n            }\n            const rel = linkElement.getAttribute('rel')\n            if (rel === 'modulepreload') {\n                linkElement.href = CorsPlugin._replaceJSUrl(href)\n            } else if (rel === 'stylesheet') {\n                linkElement.href = CorsPlugin._replaceCSSUrl(href)\n            } else {\n                linkElement.href = CorsPlugin._replaceFontUrl(href)\n            }\n        }\n\n        if (node.nodeName === 'SCRIPT') {\n            const scriptElement = node as HTMLScriptElement\n            scriptElement.src = CorsPlugin._replaceJSUrl(scriptElement.src)\n        }\n    },\n}\n\nexport type Node = {\n    id: number\n    type: number\n    tagName: string\n    childNodes: Node[]\n    textContent?: string\n}\n\nexport const WindowTitlePlugin = (cb: (windowId: string, title: string) => void): ReplayPlugin => {\n    const titleElementIds = new Set<number>()\n\n    const extractTitleTextEl = (node: Node): Node | undefined => {\n        // Document node\n        if (node.type === 0) {\n            const el = node.childNodes.find((n) => n.type === 2) // element node\n\n            if (el) {\n                const headEl = el.childNodes.filter((n) => n.type === 2).find((n) => n.tagName === 'head')\n\n                if (headEl) {\n                    const titleEl = headEl.childNodes.filter((n) => n.type === 2).find((n) => n.tagName === 'title')\n\n                    if (titleEl) {\n                        const textEl = titleEl.childNodes.find((n) => n.type === 3) // text node\n                        return textEl\n                    }\n                }\n            }\n        }\n    }\n\n    return {\n        handler: async (e: eventWithTime, isSync) => {\n            if ('windowId' in e && e.windowId && isSync) {\n                const windowId = e.windowId as string\n                if (e.type === EventType.FullSnapshot) {\n                    titleElementIds.clear()\n                    const el = extractTitleTextEl(e.data.node as Node)\n                    if (windowId && el && el.textContent) {\n                        titleElementIds.add(el.id)\n                        cb(windowId, el.textContent)\n                    }\n                } else if (e.type === EventType.IncrementalSnapshot && e.data.source === IncrementalSource.Mutation) {\n                    e.data.texts.forEach(({ id, value }) => {\n                        if (titleElementIds.has(id) && value) {\n                            cb(windowId, value)\n                        }\n                    })\n                }\n            }\n        },\n    }\n}\n\nexport const HLSPlayerPlugin: ReplayPlugin = {\n    onBuild: (node) => {\n        if (node && node.nodeName === 'VIDEO' && node.nodeType === 1) {\n            const videoEl = node as HTMLVideoElement\n            const hlsSrc = videoEl.getAttribute('hls-src')\n\n            if (videoEl && hlsSrc) {\n                if (Hls.isSupported()) {\n                    const hls = new Hls()\n                    hls.loadSource(hlsSrc)\n                    hls.attachMedia(videoEl)\n\n                    hls.on(Hls.Events.ERROR, (_, data) => {\n                        if (data.fatal) {\n                            switch (data.type) {\n                                case Hls.ErrorTypes.NETWORK_ERROR:\n                                    hls.startLoad()\n                                    break\n                                case Hls.ErrorTypes.MEDIA_ERROR:\n                                    hls.recoverMediaError()\n                                    break\n                                // Unrecoverable error\n                                default:\n                                    hls.destroy()\n                                    break\n                            }\n                        }\n                    })\n                }\n                // HLS not supported natively but can play in Safari\n                else if (videoEl.canPlayType('application/vnd.apple.mpegurl')) {\n                    videoEl.src = hlsSrc\n                }\n            }\n        }\n    },\n}\n\nconst defaultStyleRules = `.ph-no-capture { background-image: ${PLACEHOLDER_SVG_DATA_IMAGE_URL} }`\n// replaces a common rule in Shopify templates removed during capture\n// fix tracked in https://github.com/rrweb-io/rrweb/pull/1322\nconst shopifyShorthandCSSFix =\n    '@media (prefers-reduced-motion: no-preference) { .scroll-trigger:not(.scroll-trigger--offscreen).animate--slide-in { animation: var(--animation-slide-in) } }'\n\nexport type LogType = 'log' | 'warning'\nexport type LoggingTimers = Record<LogType, NodeJS.Timeout | null>\nexport type BuiltLogging = {\n    logger: playerConfig['logger']\n    timers: LoggingTimers\n}\n\nexport const makeNoOpLogger = (): BuiltLogging => {\n    return {\n        logger: {\n            log: () => {},\n            warn: () => {},\n        },\n        timers: { log: null, warning: null },\n    }\n}\n\nexport const makeLogger = (onIncrement: (count: number) => void): BuiltLogging => {\n    const counters = {\n        log: 0,\n        warning: 0,\n    }\n\n    ;(window as any)[`__posthog_player_logs`] = (window as any)[`__posthog_player_logs`] || []\n    ;(window as any)[`__posthog_player_warnings`] = (window as any)[`__posthog_player_warnings`] || []\n\n    const logStores: Record<LogType, any[]> = {\n        log: (window as any)[`__posthog_player_logs`],\n        warning: (window as any)[`__posthog_player_warnings`],\n    }\n\n    const timers: LoggingTimers = {\n        log: null,\n        warning: null,\n    }\n\n    const logger = (type: LogType): ((message?: any, ...optionalParams: any[]) => void) => {\n        // NOTE: RRWeb can log _alot_ of warnings,\n        // so we debounce the count otherwise we just end up making the performance worse\n        // We also don't log the messages directly.\n        // Sometimes the sheer size of messages and warnings can cause the browser to crash deserializing it all\n\n        return (...args: any[]): void => {\n            logStores[type].push(args)\n            counters[type] += 1\n\n            if (!timers[type]) {\n                timers[type] = setTimeout(() => {\n                    timers[type] = null\n                    if (type === 'warning') {\n                        onIncrement(logStores[type].length)\n                    }\n\n                    console.warn(\n                        `[PostHog Replayer] ${counters[type]} ${type}s (window.__posthog_player_${type}s to safely log them)`\n                    )\n                    counters[type] = 0\n                }, 5000)\n            }\n        }\n    }\n\n    return {\n        logger: {\n            log: logger('log'),\n            warn: logger('warning'),\n        },\n        timers,\n    }\n}\n\nexport const COMMON_REPLAYER_CONFIG: Partial<playerConfig> = {\n    triggerFocus: false,\n    insertStyleRules: [defaultStyleRules, shopifyShorthandCSSFix],\n}",
            "cost": 0.09435500000000001
        }
    },
    "recover_status": "success",
    "instance_ref": {
        "instance_id": "PostHog__posthog.main.42729",
        "repo": "PostHog/posthog",
        "base_commit": "7e9060facaf104f63f506ff0ef5480d5704ea615",
        "head_commit": "67934a0548e84f66a3c1fd3ef47bed3cb116ca12",
        "title": "revert: \"fix(replay): account for css stylesheets\"",
        "merged_at": "2025-12-04T19:08:51Z",
        "html_url": "https://github.com/PostHog/posthog/pull/42729",
        "test_files": [
            "frontend/src/scenes/session-recordings/player/rrweb/index.test.ts"
        ],
        "code_files": [
            "frontend/src/scenes/session-recordings/player/rrweb/index.ts"
        ],
        "total_changes": 34,
        "num_files": 2,
        "pull_number": 42729,
        "patch": "diff --git a/frontend/src/scenes/session-recordings/player/rrweb/index.test.ts b/frontend/src/scenes/session-recordings/player/rrweb/index.test.ts\nindex d24ed895f3be4..c71605038780d 100644\n--- a/frontend/src/scenes/session-recordings/player/rrweb/index.test.ts\n+++ b/frontend/src/scenes/session-recordings/player/rrweb/index.test.ts\n@@ -33,30 +33,6 @@ describe('CorsPlugin', () => {\n         CorsPlugin.onBuild?.(el, { id: 1, replayer: null as unknown as any })\n         expect(el.href).toEqual(`https://replay.ph-proxy.com/proxy?url=https://app.posthog.com/my-image.js`)\n     })\n-\n-    it('can replace a stylesheet css link', () => {\n-        const el = document.createElement('link')\n-        el.setAttribute('rel', 'stylesheet')\n-        el.href = 'https://app.posthog.com/assets/styles.css'\n-        CorsPlugin.onBuild?.(el, { id: 1, replayer: null as unknown as any })\n-        expect(el.href).toEqual(`https://replay.ph-proxy.com/proxy?url=https://app.posthog.com/assets/styles.css`)\n-    })\n-\n-    it('can replace a stylesheet css link with query parameters', () => {\n-        const el = document.createElement('link')\n-        el.setAttribute('rel', 'stylesheet')\n-        el.href = 'https://app.posthog.com/assets/styles.css?v=123'\n-        CorsPlugin.onBuild?.(el, { id: 1, replayer: null as unknown as any })\n-        expect(el.href).toEqual(`https://replay.ph-proxy.com/proxy?url=https://app.posthog.com/assets/styles.css?v=123`)\n-    })\n-\n-    it.each([\n-        'https://app.posthog.com/styles.css',\n-        'https://app.posthog.com/styles.css?v=123',\n-        'https://app.posthog.com/assets/main.css?t=1234567890',\n-    ])('should replace CSS urls', (cssUrl) => {\n-        expect(CorsPlugin._replaceCSSUrl(cssUrl)).toEqual(`https://replay.ph-proxy.com/proxy?url=${cssUrl}`)\n-    })\n })\n \n describe('WindowTitlePlugin', () => {\ndiff --git a/frontend/src/scenes/session-recordings/player/rrweb/index.ts b/frontend/src/scenes/session-recordings/player/rrweb/index.ts\nindex 8dd021ca88428..ee36a8be2ea11 100644\n--- a/frontend/src/scenes/session-recordings/player/rrweb/index.ts\n+++ b/frontend/src/scenes/session-recordings/player/rrweb/index.ts\n@@ -12,7 +12,6 @@ export const CorsPlugin: ReplayPlugin & {\n     _replaceFontCssUrls: (value: string | null) => string | null\n     _replaceFontUrl: (value: string) => string\n     _replaceJSUrl: (value: string) => string\n-    _replaceCSSUrl: (value: string) => string\n } = {\n     _replaceFontCssUrls: (value: string | null): string | null => {\n         return (\n@@ -31,10 +30,6 @@ export const CorsPlugin: ReplayPlugin & {\n         return value.replace(/^(https:\\/\\/\\S*(?:\\.js)\\S*)$/i, `${PROXY_URL}/proxy?url=$1`)\n     },\n \n-    _replaceCSSUrl: (value: string): string => {\n-        return value.replace(/^(https:\\/\\/\\S*(?:\\.css)\\S*)$/i, `${PROXY_URL}/proxy?url=$1`)\n-    },\n-\n     onBuild: (node) => {\n         if (node.nodeName === 'STYLE') {\n             const styleElement = node as HTMLStyleElement\n@@ -60,11 +55,8 @@ export const CorsPlugin: ReplayPlugin & {\n             if (!href) {\n                 return\n             }\n-            const rel = linkElement.getAttribute('rel')\n-            if (rel === 'modulepreload') {\n+            if (linkElement.getAttribute('rel') == 'modulepreload') {\n                 linkElement.href = CorsPlugin._replaceJSUrl(href)\n-            } else if (rel === 'stylesheet') {\n-                linkElement.href = CorsPlugin._replaceCSSUrl(href)\n             } else {\n                 linkElement.href = CorsPlugin._replaceFontUrl(href)\n             }\n",
        "pr_mirror": "PostHog__posthog.main"
    }
}