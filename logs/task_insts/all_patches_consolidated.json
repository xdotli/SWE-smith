[
  {
    "instance_id": "iamkun__dayjs.c8a26460.2930",
    "repo": "iamkun/dayjs",
    "pull_number": 2930,
    "base_commit": "c8a26460",
    "patch": "diff --git a/src/locale/it.js b/src/locale/it.js\nindex 08f660bef..b4bceb00d 100644\n--- a/src/locale/it.js\n+++ b/src/locale/it.js\n@@ -23,7 +23,7 @@ const locale = {\n     s: 'qualche secondo',\n     m: 'un minuto',\n     mm: '%d minuti',\n-    h: 'un\\' ora',\n+    h: 'un\\'ora',\n     hh: '%d ore',\n     d: 'un giorno',\n     dd: '%d giorni',\n",
    "test_patch": "diff --git a/test/locale/it.test.js b/test/locale/it.test.js\nnew file mode 100644\nindex 000000000..56043b1de\n--- /dev/null\n+++ b/test/locale/it.test.js\n@@ -0,0 +1,84 @@\n+import moment from 'moment'\n+import MockDate from 'mockdate'\n+import dayjs from '../../src'\n+import '../../src/locale/it'\n+import relativeTime from '../../src/plugin/relativeTime'\n+import localizedFormat from '../../src/plugin/localizedFormat'\n+\n+dayjs.extend(relativeTime)\n+dayjs.extend(localizedFormat)\n+\n+describe('Italian formats', () => {\n+  beforeEach(() => {\n+    dayjs.locale('it')\n+    moment.locale('it')\n+\n+    MockDate.set(new Date())\n+  })\n+\n+  afterEach(() => {\n+    MockDate.reset()\n+  })\n+\n+\n+  it('Format month with locale function', () => {\n+    for (let i = 0; i <= 7; i += 1) {\n+      const dayjsWithLocale = dayjs().add(i, 'day')\n+      const momentWithLocale = moment().add(i, 'day')\n+      const testFormat1 = 'DD MMMM YYYY MMM'\n+      const testFormat2 = 'dddd, MMMM D YYYY'\n+      const testFormat3 = 'MMMM'\n+      const testFormat4 = 'MMM'\n+      const testFormat5 = 'L'\n+      expect(dayjsWithLocale.format(testFormat1)).toEqual(momentWithLocale.format(testFormat1))\n+      expect(dayjsWithLocale.format(testFormat2)).toEqual(momentWithLocale.format(testFormat2))\n+      expect(dayjsWithLocale.format(testFormat3)).toEqual(momentWithLocale.format(testFormat3))\n+      expect(dayjsWithLocale.format(testFormat4)).toEqual(momentWithLocale.format(testFormat4))\n+      expect(dayjsWithLocale.format(testFormat5)).toEqual(momentWithLocale.format(testFormat5))\n+    }\n+  })\n+\n+  it('RelativeTime: Time from X', () => {\n+    const T = [\n+      [89.5, 'second'], // a minute\n+      [2, 'minute'], // 2 minutes\n+      [5, 'minute'], // 5 minutes\n+      [43, 'minute'], // 44 minutes\n+      [45, 'minute'], // an hour\n+      [3, 'hour'], // 3 hours\n+      [21, 'hour'], // 21 hours\n+      [1, 'day'], // a day\n+      [3, 'day'], // 3 day\n+      [25, 'day'], // 25 days\n+      [1, 'month'], // a month\n+      [2, 'month'], // 2 month\n+      [10, 'month'], // 10 month\n+      [1, 'year'], // a year\n+      [2, 'year'], // 2 year\n+      [5, 'year'], // 5 year\n+      [18, 'month'] // 2 years\n+    ]\n+\n+\n+    T.forEach((t) => {\n+      expect(dayjs().from(dayjs().add(t[0], t[1])))\n+        .toBe(moment().from(moment().add(t[0], t[1])))\n+      expect(dayjs().from(dayjs().add(t[0], t[1]), true))\n+        .toBe(moment().from(moment().add(t[0], t[1]), true))\n+    })\n+  })\n+\n+  // moment.js uses `alcuni secondi` while dayjs uses `qualche secondo`.\n+  it('RelativeTime: A few seconds', () => {\n+    const T = [\n+      [44.4, 'second'] // a few seconds\n+    ]\n+\n+    T.forEach((t) => {\n+      expect(dayjs().from(dayjs().add(t[0], t[1])))\n+        .toBe('qualche secondo fa')\n+      expect(dayjs().from(dayjs().add(t[0], t[1]), true))\n+        .toBe('qualche secondo')\n+    })\n+  })\n+})\n",
    "problem_statement": "Fix for Italian locale relative time translation\nThe phrase 'One hour ago' is currently translated as 'un\u2019 ora fa', but the correct translation is 'un\u2019ora fa' (without the space after the apostrophe)\n\n",
    "direct_patch": true,
    "has_rewrites": false,
    "_file": "logs/bug_gen/iamkun__dayjs.c8a26460/pr_mirror/iamkun__dayjs.c8a26460.2930/metadata__pr_2930.json"
  },
  {
    "instance_id": "iamkun__dayjs.c8a26460.2922",
    "repo": "iamkun/dayjs",
    "pull_number": 2922,
    "base_commit": "c8a26460",
    "patch": "diff --git a/.npmignore b/.npmignore\nindex 4577b0a50..136e98f46 100644\n--- a/.npmignore\n+++ b/.npmignore\n@@ -20,6 +20,7 @@ build\n babel.config.js\n prettier.config.js\n .eslintrc.json\n+patches\n \n #doc\n CONTRIBUTING.md\ndiff --git a/patches/@semantic-release+github+11.0.4.patch b/patches/@semantic-release+github+11.0.4.patch\nindex 74974377b..0b2f179a3 100644\n--- a/patches/@semantic-release+github+11.0.4.patch\n+++ b/patches/@semantic-release+github+11.0.4.patch\n@@ -1,76 +1,13 @@\n diff --git a/node_modules/@semantic-release/github/lib/success.js b/node_modules/@semantic-release/github/lib/success.js\n-index 29c8def..576c68a 100644\n+index 29c8def..7e57161 100644\n --- a/node_modules/@semantic-release/github/lib/success.js\n +++ b/node_modules/@semantic-release/github/lib/success.js\n-@@ -15,6 +15,8 @@ import getReleaseLinks from \"./get-release-links.js\";\n- const debug = debugFactory(\"semantic-release:github\");\n- \n- export default async function success(pluginConfig, context, { Octokit }) {\n-+  console.log('pluginConfig: ', pluginConfig);\n-+  console.log('context: ', context);\n-   const {\n-     options: { repositoryUrl },\n-     commits,\n-@@ -37,6 +39,21 @@ export default async function success(pluginConfig, context, { Octokit }) {\n-     releasedLabels,\n-     addReleases,\n-   } = resolveConfig(pluginConfig, context);\n-+  console.log('resolveConfig', {\n-+    githubToken,\n-+    githubUrl,\n-+    githubApiPathPrefix,\n-+    githubApiUrl,\n-+    proxy,\n-+    labels,\n-+    successComment,\n-+    successCommentCondition,\n-+    failTitle,\n-+    failComment,\n-+    failCommentCondition,\n-+    releasedLabels,\n-+    addReleases,\n-+  })\n- \n-   const octokit = new Octokit(\n-     toOctokitOptions({\n-@@ -74,17 +91,21 @@ export default async function success(pluginConfig, context, { Octokit }) {\n-     );\n-     const releaseInfos = releases.filter((release) => Boolean(release.name));\n-     const shas = commits.map(({ hash }) => hash);\n-+    console.log('shas: ', shas);\n- \n-     // Get associatedPRs\n-     const associatedPRs = await inChunks(shas, 100, async (chunk) => {\n-+      console.log('chunk: ', chunk);\n-       const responsePRs = [];\n-       const { repository } = await octokit.graphql(\n-         buildAssociatedPRsQuery(chunk),\n-         { owner, repo },\n-       );\n-+      console.log('repository: ', repository);\n-       const responseAssociatedPRs = Object.values(repository).map(\n-         (item) => item.associatedPullRequests,\n-       );\n-+      console.log('responseAssociatedPRs: ', responseAssociatedPRs);\n-       for (const { nodes, pageInfo } of responseAssociatedPRs) {\n-         if (nodes.length === 0) continue;\n- \n-@@ -116,8 +137,10 @@ export default async function success(pluginConfig, context, { Octokit }) {\n-     });\n- \n+@@ -118,6 +118,8 @@ export default async function success(pluginConfig, context, { Octokit }) {\n      const uniqueAssociatedPRs = uniqBy(flatten(associatedPRs), \"number\");\n-+    console.log('uniqueAssociatedPRs: ', uniqueAssociatedPRs);\n  \n      const prs = await pFilter(uniqueAssociatedPRs, async ({ number }) => {\n +      console.log('number: ', number);\n++      if (number < 2000) return false;\n        const commits = await octokit.paginate(\n          \"GET /repos/{owner}/{repo}/pulls/{pull_number}/commits\",\n          {\n-@@ -539,6 +562,7 @@ const loadSingleCommitAssociatedPRs = `#graphql\n-  * @returns {object[]}\n-  */\n- function buildIssuesOrPRsFromResponseNode(responseNodes) {\n-+  console.log('responseNodes: ', responseNodes);\n-   const resultArray = [];\n-   for (const node of responseNodes) {\n-     let baseProps = {\ndiff --git a/src/locale/en-au.js b/src/locale/en-au.js\nindex 90c83c423..add967d7c 100644\n--- a/src/locale/en-au.js\n+++ b/src/locale/en-au.js\n@@ -9,7 +9,6 @@ const locale = {\n   weekdaysShort: 'Sun_Mon_Tue_Wed_Thu_Fri_Sat'.split('_'),\n   monthsShort: 'Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec'.split('_'),\n   weekdaysMin: 'Su_Mo_Tu_We_Th_Fr_Sa'.split('_'),\n-  ordinal: n => n,\n   formats: {\n     LT: 'h:mm A',\n     LTS: 'h:mm:ss A',\n@@ -32,6 +31,11 @@ const locale = {\n     MM: '%d months',\n     y: 'a year',\n     yy: '%d years'\n+  },\n+  ordinal: (n) => {\n+    const s = ['th', 'st', 'nd', 'rd']\n+    const v = n % 100\n+    return `[${n}${(s[(v - 20) % 10] || s[v] || s[0])}]`\n   }\n }\n \n",
    "test_patch": "",
    "problem_statement": "",
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/iamkun__dayjs.c8a26460/pr_mirror/iamkun__dayjs.c8a26460.2922/metadata__pr_2922.json"
  },
  {
    "instance_id": "iamkun__dayjs.c8a26460.2948",
    "repo": "iamkun/dayjs",
    "pull_number": 2948,
    "base_commit": "c8a26460",
    "patch": "diff --git a/src/plugin/devHelper/index.js b/src/plugin/devHelper/index.js\nindex bdb83caf7..2f163a25f 100644\n--- a/src/plugin/devHelper/index.js\n+++ b/src/plugin/devHelper/index.js\n@@ -26,6 +26,15 @@ export default (o, c, d) => {\n       }\n       return oldLocale(preset, object, isLocal)\n     }\n+\n+    const oldDiff = proto.diff\n+    proto.diff = function (date, unit, float) {\n+      const isInvalidDate = !date || !d(date).isValid()\n+      if (isInvalidDate) {\n+        console.warn('Invalid usage: diff() requires a valid comparison date as the first argument. https://day.js.org/docs/en/display/difference')\n+      }\n+\n+      return oldDiff.call(this, date, unit, float)\n+    }\n   }\n }\n-\n",
    "test_patch": "diff --git a/test/plugin/devHelper.test.js b/test/plugin/devHelper.test.js\nindex c69190a14..ff63d434d 100644\n--- a/test/plugin/devHelper.test.js\n+++ b/test/plugin/devHelper.test.js\n@@ -1,6 +1,8 @@\n import MockDate from 'mockdate'\n import dayjs from '../../src'\n+import customParseFormat from '../../src/plugin/customParseFormat'\n import devHelper from '../../src/plugin/devHelper'\n+import localeData from '../../src/plugin/localeData'\n \n dayjs.extend(devHelper)\n \n@@ -38,3 +40,46 @@ it('Warning: Setting locale before loading locale', () => {\n   dayjs.locale('zh-cn')\n   expect(consoleSpy).toHaveBeenCalledWith('Guessing you may want to use locale zh-cn, you have to load it before using it. https://day.js.org/docs/en/i18n/loading-into-nodejs')\n })\n+\n+describe('dev-helper: diff() usage warnings', () => {\n+  const diffWarningMsg = 'Invalid usage: diff() requires a valid comparison date as the first argument. https://day.js.org/docs/en/display/difference'\n+\n+  beforeAll(() => {\n+    dayjs.extend(customParseFormat)\n+    dayjs.extend(localeData)\n+  })\n+\n+  beforeEach(() => {\n+    jest.clearAllMocks()\n+  })\n+\n+  it('warns when diff() is called with no comparison date', () => {\n+    const consoleSpy = jest.spyOn(console, 'warn')\n+    dayjs('2025-01-10').diff()\n+    expect(consoleSpy).toHaveBeenCalledWith(diffWarningMsg)\n+  })\n+\n+  it('warns when diff() is called with just the unit', () => {\n+    const consoleSpy = jest.spyOn(console, 'warn')\n+    dayjs('2025-01-10').diff('days')\n+    expect(consoleSpy).toHaveBeenCalledWith(diffWarningMsg)\n+  })\n+\n+  it('warns when diff() is called with an invalid comparison date (unparsable string)', () => {\n+    const consoleSpy = jest.spyOn(console, 'warn')\n+    dayjs('2025-01-10').diff('invalid-date', 'days')\n+    expect(consoleSpy).toHaveBeenCalledWith(diffWarningMsg)\n+  })\n+\n+  it('does NOT warn when diff() is called with a valid string date', () => {\n+    const consoleSpy = jest.spyOn(console, 'warn')\n+    dayjs('2025-01-10').diff('2025-01-09', 'days')\n+    expect(consoleSpy).not.toHaveBeenCalledWith(diffWarningMsg)\n+  })\n+\n+  it('does NOT warn when diff() is called with a valid Day.js instance', () => {\n+    const consoleSpy = jest.spyOn(console, 'warn')\n+    dayjs('2025-01-10').diff(dayjs(), 'days')\n+    expect(consoleSpy).not.toHaveBeenCalledWith(diffWarningMsg)\n+  })\n+})\n",
    "problem_statement": "",
    "direct_patch": true,
    "has_rewrites": false,
    "_file": "logs/bug_gen/iamkun__dayjs.c8a26460/pr_mirror/iamkun__dayjs.c8a26460.2948/metadata__pr_2948.json"
  },
  {
    "instance_id": "iamkun__dayjs.c8a26460.2934",
    "repo": "iamkun/dayjs",
    "pull_number": 2934,
    "base_commit": "c8a26460",
    "patch": "diff --git a/src/locale/be.js b/src/locale/be.js\nindex f83703958..c35d56574 100644\n--- a/src/locale/be.js\n+++ b/src/locale/be.js\n@@ -18,8 +18,8 @@ function relativeTimeWithPlural(number, withoutSuffix, key) {\n     ss: withoutSuffix ? '\u0441\u0435\u043a\u0443\u043d\u0434\u0430_\u0441\u0435\u043a\u0443\u043d\u0434\u044b_\u0441\u0435\u043a\u0443\u043d\u0434' : '\u0441\u0435\u043a\u0443\u043d\u0434\u0443_\u0441\u0435\u043a\u0443\u043d\u0434\u044b_\u0441\u0435\u043a\u0443\u043d\u0434',\n     mm: withoutSuffix ? '\u0445\u0432\u0456\u043b\u0456\u043d\u0430_\u0445\u0432\u0456\u043b\u0456\u043d\u044b_\u0445\u0432\u0456\u043b\u0456\u043d' : '\u0445\u0432\u0456\u043b\u0456\u043d\u0443_\u0445\u0432\u0456\u043b\u0456\u043d\u044b_\u0445\u0432\u0456\u043b\u0456\u043d',\n     hh: withoutSuffix ? '\u0433\u0430\u0434\u0437\u0456\u043d\u0430_\u0433\u0430\u0434\u0437\u0456\u043d\u044b_\u0433\u0430\u0434\u0437\u0456\u043d' : '\u0433\u0430\u0434\u0437\u0456\u043d\u0443_\u0433\u0430\u0434\u0437\u0456\u043d\u044b_\u0433\u0430\u0434\u0437\u0456\u043d',\n-    dd: '\u0434\u0437\u0435\u043d\u044c_\u0434\u043d\u044f_\u0434\u0437\u0451\u043d',\n-    MM: '\u043c\u0435\u0441\u044f\u0446_\u043c\u0435\u0441\u044f\u0446\u0430_\u043c\u0435\u0441\u044f\u0446\u0430\u045e',\n+    dd: '\u0434\u0437\u0435\u043d\u044c_\u0434\u043d\u0456_\u0434\u0437\u0451\u043d',\n+    MM: '\u043c\u0435\u0441\u044f\u0446_\u043c\u0435\u0441\u044f\u0446\u044b_\u043c\u0435\u0441\u044f\u0446\u0430\u045e',\n     yy: '\u0433\u043e\u0434_\u0433\u0430\u0434\u044b_\u0433\u0430\u0434\u043e\u045e'\n   }\n   if (key === 'm') {\n",
    "test_patch": "diff --git a/test/locale/be.test.js b/test/locale/be.test.js\nnew file mode 100644\nindex 000000000..0c39f224b\n--- /dev/null\n+++ b/test/locale/be.test.js\n@@ -0,0 +1,142 @@\n+import MockDate from 'mockdate'\n+import moment from 'moment'\n+import dayjs from '../../src'\n+import '../../src/locale/be'\n+import relativeTime from '../../src/plugin/relativeTime'\n+\n+dayjs.extend(relativeTime)\n+\n+beforeEach(() => {\n+  MockDate.set(new Date())\n+})\n+\n+afterEach(() => {\n+  MockDate.reset()\n+})\n+\n+it('Belarusian locale relative time in past and future with suffix', () => {\n+  const cases = [\n+    [1, 's', '\u043f\u0440\u0430\u0437 \u043d\u0435\u043a\u0430\u043b\u044c\u043a\u0456 \u0441\u0435\u043a\u0443\u043d\u0434'],\n+    [-1, 's', '\u043d\u0435\u043a\u0430\u043b\u044c\u043a\u0456 \u0441\u0435\u043a\u0443\u043d\u0434 \u0442\u0430\u043c\u0443'],\n+    [1, 'm', '\u043f\u0440\u0430\u0437 \u0445\u0432\u0456\u043b\u0456\u043d\u0443'],\n+    [-1, 'm', '\u0445\u0432\u0456\u043b\u0456\u043d\u0443 \u0442\u0430\u043c\u0443'],\n+    [1, 'h', '\u043f\u0440\u0430\u0437 \u0433\u0430\u0434\u0437\u0456\u043d\u0443'],\n+    [-1, 'h', '\u0433\u0430\u0434\u0437\u0456\u043d\u0443 \u0442\u0430\u043c\u0443'],\n+    [1, 'd', '\u043f\u0440\u0430\u0437 \u0434\u0437\u0435\u043d\u044c'],\n+    [-1, 'd', '\u0434\u0437\u0435\u043d\u044c \u0442\u0430\u043c\u0443'],\n+    [1, 'M', '\u043f\u0440\u0430\u0437 \u043c\u0435\u0441\u044f\u0446'],\n+    [-1, 'M', '\u043c\u0435\u0441\u044f\u0446 \u0442\u0430\u043c\u0443'],\n+    [2, 'd', '\u043f\u0440\u0430\u0437 2 \u0434\u043d\u0456'],\n+    [-2, 'd', '2 \u0434\u043d\u0456 \u0442\u0430\u043c\u0443'],\n+    [10, 'd', '\u043f\u0440\u0430\u0437 10 \u0434\u0437\u0451\u043d'],\n+    [-10, 'd', '10 \u0434\u0437\u0451\u043d \u0442\u0430\u043c\u0443'],\n+    [6, 'm', '\u043f\u0440\u0430\u0437 6 \u0445\u0432\u0456\u043b\u0456\u043d'],\n+    [-6, 'm', '6 \u0445\u0432\u0456\u043b\u0456\u043d \u0442\u0430\u043c\u0443'],\n+    [5, 'h', '\u043f\u0440\u0430\u0437 5 \u0433\u0430\u0434\u0437\u0456\u043d'],\n+    [-5, 'h', '5 \u0433\u0430\u0434\u0437\u0456\u043d \u0442\u0430\u043c\u0443'],\n+    [3, 'M', '\u043f\u0440\u0430\u0437 3 \u043c\u0435\u0441\u044f\u0446\u044b'],\n+    [-3, 'M', '3 \u043c\u0435\u0441\u044f\u0446\u044b \u0442\u0430\u043c\u0443'],\n+    [4, 'y', '\u043f\u0440\u0430\u0437 4 \u0433\u0430\u0434\u044b'],\n+    [-4, 'y', '4 \u0433\u0430\u0434\u044b \u0442\u0430\u043c\u0443']\n+  ]\n+\n+  const locales = ['be']\n+  locales.forEach((locale) => {\n+    cases.forEach((c) => {\n+      expect(dayjs()\n+        .add(c[0], c[1])\n+        .locale(locale)\n+        .fromNow()).toBe(c[2])\n+      expect(dayjs()\n+        .add(c[0], c[1])\n+        .locale(locale)\n+        .fromNow()).toBe(moment()\n+        .add(c[0], c[1])\n+        .locale(locale)\n+        .fromNow())\n+    })\n+  })\n+})\n+\n+it('Belarusian locale relative time in past and future without suffix', () => {\n+  const cases = [\n+    [1, 's', '\u043d\u0435\u043a\u0430\u043b\u044c\u043a\u0456 \u0441\u0435\u043a\u0443\u043d\u0434'],\n+    [-1, 's', '\u043d\u0435\u043a\u0430\u043b\u044c\u043a\u0456 \u0441\u0435\u043a\u0443\u043d\u0434'],\n+\n+    [1, 'm', '\u0445\u0432\u0456\u043b\u0456\u043d\u0430'],\n+    [-1, 'm', '\u0445\u0432\u0456\u043b\u0456\u043d\u0430'],\n+    [1, 'h', '\u0433\u0430\u0434\u0437\u0456\u043d\u0430'],\n+    [-1, 'h', '\u0433\u0430\u0434\u0437\u0456\u043d\u0430'],\n+\n+    // Test all plural forms for days\n+    [1, 'd', '\u0434\u0437\u0435\u043d\u044c'],\n+    [21, 'd', '21 \u0434\u0437\u0435\u043d\u044c'],\n+    [31, 'd', '\u043c\u0435\u0441\u044f\u0446'],\n+    // 2-4 form\n+    [2, 'd', '2 \u0434\u043d\u0456'],\n+    [3, 'd', '3 \u0434\u043d\u0456'],\n+    [4, 'd', '4 \u0434\u043d\u0456'],\n+    // 5-20 and other cases\n+    [5, 'd', '5 \u0434\u0437\u0451\u043d'],\n+    [6, 'd', '6 \u0434\u0437\u0451\u043d'],\n+    // 11-14 special case\n+    [11, 'd', '11 \u0434\u0437\u0451\u043d'],\n+    [12, 'd', '12 \u0434\u0437\u0451\u043d'],\n+    [13, 'd', '13 \u0434\u0437\u0451\u043d'],\n+    [14, 'd', '14 \u0434\u0437\u0451\u043d'],\n+    // 22-24\n+    [22, 'd', '22 \u0434\u043d\u0456'],\n+    [23, 'd', '23 \u0434\u043d\u0456'],\n+    [24, 'd', '24 \u0434\u043d\u0456'],\n+\n+    // Test all plural forms for months\n+    [1, 'M', '\u043c\u0435\u0441\u044f\u0446'],\n+    [2, 'M', '2 \u043c\u0435\u0441\u044f\u0446\u044b'],\n+    [5, 'M', '5 \u043c\u0435\u0441\u044f\u0446\u0430\u045e'],\n+\n+    // Test all plural forms for years\n+    [1, 'y', '\u0433\u043e\u0434'],\n+    [2, 'y', '2 \u0433\u0430\u0434\u044b'],\n+    [5, 'y', '5 \u0433\u0430\u0434\u043e\u045e'],\n+    [11, 'y', '11 \u0433\u0430\u0434\u043e\u045e'],\n+    [21, 'y', '21 \u0433\u043e\u0434']\n+  ]\n+\n+  const locales = ['be']\n+  locales.forEach((locale) => {\n+    cases.forEach((c) => {\n+      expect(dayjs()\n+        .add(c[0], c[1])\n+        .locale(locale)\n+        .fromNow(true)).toBe(c[2])\n+      expect(dayjs()\n+        .add(c[0], c[1])\n+        .locale(locale)\n+        .fromNow(true)).toBe(moment()\n+        .add(c[0], c[1])\n+        .locale(locale)\n+        .fromNow(true))\n+    })\n+  })\n+})\n+\n+it('Belarusian locale formats dates with correct month forms', () => {\n+  const tests = [\n+    // Full month names\n+    { date: '2022-01-19', format: 'dd, D MMMM YYYY \u0433.', expected: '\u0441\u0440, 19 \u0441\u0442\u0443\u0434\u0437\u0435\u043d\u044f 2022 \u0433.' },\n+    { date: '2022-01-01', format: 'MMMM', expected: '\u0441\u0442\u0443\u0434\u0437\u0435\u043d\u044c' },\n+\n+    // Short month names in format form (with day)\n+    { date: '2022-01-15', format: 'D MMM', expected: '15 \u0441\u0442\u0443\u0434' },\n+    { date: '2022-02-15', format: 'D MMM', expected: '15 \u043b\u044e\u0442' },\n+\n+    // Short month names in standalone form\n+    { date: '2022-01-01', format: 'MMM', expected: '\u0441\u0442\u0443\u0434' },\n+    { date: '2022-02-01', format: 'MMM', expected: '\u043b\u044e\u0442' }\n+  ]\n+\n+  tests.forEach(({ date, format, expected }) => {\n+    const dayjsWithLocale = dayjs(date).locale('be')\n+    expect(dayjsWithLocale.format(format)).toEqual(expected)\n+  })\n+})\n",
    "problem_statement": "",
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/iamkun__dayjs.c8a26460/pr_mirror/iamkun__dayjs.c8a26460.2934/metadata__pr_2934.json"
  },
  {
    "instance_id": "iamkun__dayjs.c8a26460.2950",
    "repo": "iamkun/dayjs",
    "pull_number": 2950,
    "base_commit": "c8a26460",
    "patch": "diff --git a/README.md b/README.md\nindex 8516adcfe..b713eaa33 100644\n--- a/README.md\n+++ b/README.md\n@@ -1,3 +1,27 @@\n+<div align=\"center\">\n+\t<a href=\"https://go.warp.dev/dayjs\" target=\"_blank\">\n+\t\t<img alt=\"Warp sponsorship\" width=\"400\" src=\"https://github.com/warpdotdev/brand-assets/blob/main/Github/Sponsor/Warp-Github-LG-02.png\">\n+\t\t<br>\n+\t\t<h>Warp is built for coding with multiple AI agents</b>\n+\t</a>\n+</div>\n+\n+---   \n+\n+<div align=\"center\" style=\"margin-top: 30px;\">\n+<a href=\"https://requestly.com/?utm_source=github&utm_medium=partnered&utm_campaign=rq_dayjs_github\">\n+   <div>\n+   <img alt=\"Requestly sponsorship\" width=\"400\" src=\"https://github.com/user-attachments/assets/24670320-997d-4d62-9bca-955c59fe883d\">\n+   </div>\n+   <b>Requestly - Free & Open-Source alternative to Postman</b>\n+   <div>\n+      <sup>All-in-one platform to Test, Mock and Intercept APIs.</sup>\n+   </div>\n+</a>\n+</div>\n+\n+---   \n+\n English | [\u7b80\u4f53\u4e2d\u6587](./docs/zh-cn/README.zh-CN.md) | [\u65e5\u672c\u8a9e](./docs/ja/README-ja.md) | [Portugu\u00eas Brasileiro](./docs/pt-br/README-pt-br.md) | [\ud55c\uad6d\uc5b4](./docs/ko/README-ko.md) | [Espa\u00f1ol (Espa\u00f1a)](./docs/es-es/README-es-es.md) | [\u0420\u0443\u0441\u0441\u043a\u0438\u0439](./docs/ru/README-ru.md) | [T\u00fcrk\u00e7e](./docs/tr/README-tr.md) | [\u0dc3\u0dd2\u0d82\u0dc4\u0dbd](./docs/si/README-si.md) | [\u05e2\u05d1\u05e8\u05d9\u05ea](./docs/he/README-he.md)\n \n <p align=\"center\"><a href=\"https://day.js.org/\" target=\"_blank\" rel=\"noopener noreferrer\"><img width=\"550\"\n@@ -99,12 +123,6 @@ dayjs().format('Q Do k kk X x') // more available formats\n \n \ud83d\udcda[Plugin List](https://day.js.org/docs/en/plugin/plugin)\n \n-### Usage Trend\n-\n-<a href=\"https://npm-compare.com/moment,dayjs/#timeRange=THREE_YEARS\" target=\"_blank\">\n-  <img src=\"https://user-images.githubusercontent.com/3455798/270162667-c7bd2ebe-675e-45c6-a2c9-dc67f3b65d6e.png\">\n-</a>\n-\n ## Sponsors\n \n Support this project by becoming a sponsor. Your logo will show up here with a link to your website.\n@@ -123,12 +141,8 @@ Support this project by becoming a sponsor. Your logo will show up here with a l\n   <img width=\"70\" src=\"https://images.opencollective.com/sight-sound/54f7220/logo/256.png?height=256\">\n </a>\n &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\n-<a href=\"https://www.exoflare.com/open-source/?utm_source=dayjs&utm_campaign=open_source\" target=\"_blank\">\n-  <img width=\"70\" src=\"https://user-images.githubusercontent.com/17680888/162761622-1407a849-0c41-4591-8aa9-f98114ec2092.png\">\n-</a>\n-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\n-<a href=\"https://chudovo.com/front-end-development/\" target=\"_blank\">\n-  <img width=\"70\" src=\"https://images.opencollective.com/chudovo/3c866f5/logo/256.png?height=256\">\n+<a href=\"https://opencollective.com/filerev\" target=\"_blank\">\n+  <img width=\"70\" src=\"https://images.opencollective.com/filerev/93a8f05/logo/256.png?height=256\" />\n </a>\n &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\n <a href=\"https://github.com/radioplusexperts\" target=\"_blank\">\n@@ -139,6 +153,14 @@ Support this project by becoming a sponsor. Your logo will show up here with a l\n   <img width=\"70\" src=\"https://avatars.githubusercontent.com/u/13880908?s=200&v=4\">\n </a>\n &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\n+<a href=\"https://github.com/Ayo1984\" target=\"_blank\">\n+  <img width=\"70\" src=\"https://avatars.githubusercontent.com/u/117122666?v=4\">\n+</a>\n+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\n+<a href=\"https://anonstories.com\" target=\"_blank\">\n+  <img alt=\"Instagram Story Viewer\" width=\"70\" src=\"https://avatars.githubusercontent.com/u/240702364?v=4\">\n+</a>\n+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\n <a href=\"https://bestkru.com/\" target=\"_blank\">\n   <img width=\"70\" src=\"https://avatars.githubusercontent.com/u/159320286\" alt=\"BestKru\">\n </a>\ndiff --git a/docs/es-es/README-es-es.md b/docs/es-es/README-es-es.md\nindex d9b54c794..e3519168f 100644\n--- a/docs/es-es/README-es-es.md\n+++ b/docs/es-es/README-es-es.md\n@@ -108,12 +108,6 @@ dayjs().format('Q Do k kk X x') // ahora tenemos m\u00e1s formatos disponibles\n \n \ud83d\udcda[Lista de complementos](https://day.js.org/docs/en/plugin/plugin)\n \n-### Tendencia de Uso\n-\n-<a href=\"https://npm-compare.com/moment,dayjs/#timeRange=THREE_YEARS\" target=\"_blank\">\n-  <img src=\"https://user-images.githubusercontent.com/3455798/270162667-c7bd2ebe-675e-45c6-a2c9-dc67f3b65d6e.png\">\n-</a>\n-\n ## Patrocinadores\n \n Apoya a este proyecto convirti\u00e9ndote en un patrocinador. Tu logo aparecer\u00e1 aqu\u00ed, enlazado a tu sitio web. [[Convi\u00e9rtete en un patrocinador](https://opencollective.com/dayjs#sponsor)]\ndiff --git a/docs/he/README-he.md b/docs/he/README-he.md\nindex f410269ef..00cc6a2cb 100644\n--- a/docs/he/README-he.md\n+++ b/docs/he/README-he.md\n@@ -120,12 +120,6 @@ dayjs().format('Q Do k kk X x') // \u05db\u05e2\u05ea \u05d9\u05d5\u05ea\u05e8 \u05d0\u05e4\u05e9\u05e8\u05d5\u05d9\u05d5\u05ea \u05d6\u05de\u05d9\u05e0\u05d5\u05ea\n \n \ud83d\udcda[\u05e8\u05e9\u05d9\u05de\u05ea \u05ea\u05d5\u05e1\u05e4\u05d9\u05dd](https://day.js.org/docs/en/plugin/plugin)\n \n-### \u05de\u05d2\u05de\u05ea \u05d4\u05e9\u05d9\u05de\u05d5\u05e9\n-\n-<a href=\"https://npm-compare.com/moment,dayjs/#timeRange=THREE_YEARS\" target=\"_blank\">\n-  <img src=\"https://user-images.githubusercontent.com/3455798/270162667-c7bd2ebe-675e-45c6-a2c9-dc67f3b65d6e.png\">\n-</a>\n-\n ### \u05e1\u05e4\u05d5\u05e0\u05e1\u05e8\u05d9\u05dd\n \u05ea\u05de\u05db\u05d5 \u05d1\u05e4\u05e8\u05d5\u05d9\u05e7\u05d8 \u05d6\u05d4 \u05db\u05d3\u05d9 \u05dc\u05d4\u05d9\u05d5\u05ea \u05e1\u05e4\u05d5\u05e0\u05e1\u05e8. \u05e7\u05d1\u05dc\u05d5 \u05dc\u05d5\u05d2\u05d5 \u05e2\u05dd \u05e7\u05d9\u05e9\u05d5\u05e8 \u05dc\u05d0\u05ea\u05e8 \u05e9\u05dc\u05db\u05dd \u05e9\u05d9\u05d5\u05e4\u05d9\u05e2 \u05db\u05d0\u05df.\n \ndiff --git a/docs/ja/README-ja.md b/docs/ja/README-ja.md\nindex 783e86801..17f7fbe1d 100644\n--- a/docs/ja/README-ja.md\n+++ b/docs/ja/README-ja.md\n@@ -108,12 +108,6 @@ dayjs().format('Q Do k kk X x') // \u591a\u69d8\u306a\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u304c\u5229\u7528\u53ef\u80fd\u306b\n \n \ud83d\udcda[\u30d7\u30e9\u30b0\u30a4\u30f3\u30ea\u30b9\u30c8](https://day.js.org/docs/en/plugin/plugin)\n \n-### \u4f7f\u7528\u30c8\u30ec\u30f3\u30c9\n-\n-<a href=\"https://npm-compare.com/moment,dayjs/#timeRange=THREE_YEARS\" target=\"_blank\">\n-  <img src=\"https://user-images.githubusercontent.com/3455798/270162667-c7bd2ebe-675e-45c6-a2c9-dc67f3b65d6e.png\">\n-</a>\n-\n ## \u30e9\u30a4\u30bb\u30f3\u30b9\n \n Day.js \u306f [MIT License](../../LICENSE) \u306e\u3082\u3068\u3067\u5229\u7528\u3092\u8a31\u8afe\u3057\u307e\u3059\u3002\ndiff --git a/docs/ko/README-ko.md b/docs/ko/README-ko.md\nindex 3b1b985b5..9a66dfcb5 100644\n--- a/docs/ko/README-ko.md\n+++ b/docs/ko/README-ko.md\n@@ -108,12 +108,6 @@ dayjs().format('Q Do k kk X x') // more available formats\n \n \ud83d\udcda[\ud50c\ub7ec\uadf8\uc778 \ubaa9\ub85d](https://day.js.org/docs/en/plugin/plugin)\n \n-### \uc0ac\uc6a9 \ud2b8\ub80c\ub4dc\n-\n-<a href=\"https://npm-compare.com/moment,dayjs/#timeRange=THREE_YEARS\" target=\"_blank\">\n-  <img src=\"https://user-images.githubusercontent.com/3455798/270162667-c7bd2ebe-675e-45c6-a2c9-dc67f3b65d6e.png\">\n-</a>\n-\n ## License\n \n Day.js\ub294 [MIT License](./LICENSE)\ub97c \uc0ac\uc6a9\ud569\ub2c8\ub2e4.\ndiff --git a/docs/pt-br/README-pt-br.md b/docs/pt-br/README-pt-br.md\nindex 31d0bdbc4..0721771d2 100644\n--- a/docs/pt-br/README-pt-br.md\n+++ b/docs/pt-br/README-pt-br.md\n@@ -107,12 +107,6 @@ dayjs().format('Q Do k kk X x') // mais formatos dispon\u00edveis pelo plugin\n \n \ud83d\udcda[Lista de Plugins](https://day.js.org/docs/en/plugin/plugin)\n \n-### Tend\u00eancia de Uso\n-\n-<a href=\"https://npm-compare.com/moment,dayjs/#timeRange=THREE_YEARS\" target=\"_blank\">\n-  <img src=\"https://user-images.githubusercontent.com/3455798/270162667-c7bd2ebe-675e-45c6-a2c9-dc67f3b65d6e.png\">\n-</a>\n-\n ## Patrocinadores\n \n Ajude este projeto se tornando um patrocinador. O seu logo ser\u00e1 exibido aqui, com um link para o seu site. [[Tornar-se um Patrocinador](https://opencollective.com/dayjs#sponsor)].\ndiff --git a/docs/ru/README-ru.md b/docs/ru/README-ru.md\nindex 065af14ba..2d1079c77 100644\n--- a/docs/ru/README-ru.md\n+++ b/docs/ru/README-ru.md\n@@ -98,12 +98,6 @@ dayjs().format('Q Do k kk X x') // \u0431\u043e\u043b\u044c\u0448\u0435 \u0434\u043e\u0441\u0442\u0443\u043f\u043d\u044b\u0445 \u0444\u043e\u0440\u043c\u0430\u0442\n \n \ud83d\udcda[\u0421\u043f\u0438\u0441\u043e\u043a \u043f\u043b\u0430\u0433\u0438\u043d\u043e\u0432](https://day.js.org/docs/ru/plugin/plugin)\n \n-### \u0422\u0435\u043d\u0434\u0435\u043d\u0446\u0438\u044f \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u043d\u0438\u044f\n-\n-<a href=\"https://npm-compare.com/moment,dayjs/#timeRange=THREE_YEARS\" target=\"_blank\">\n-  <img src=\"https://user-images.githubusercontent.com/3455798/270162667-c7bd2ebe-675e-45c6-a2c9-dc67f3b65d6e.png\">\n-</a>\n-\n ## \u0421\u043f\u043e\u043d\u0441\u043e\u0440\u044b\n \n \u041f\u043e\u0434\u0434\u0435\u0440\u0436\u0438\u0442\u0435 \u044d\u0442\u043e\u0442 \u043f\u0440\u043e\u0435\u043a\u0442, \u0441\u0442\u0430\u0432 \u0441\u043f\u043e\u043d\u0441\u043e\u0440\u043e\u043c. \u0412\u0430\u0448 \u043b\u043e\u0433\u043e\u0442\u0438\u043f \u0431\u0443\u0434\u0435\u0442 \u043f\u043e\u043a\u0430\u0437\u0430\u043d \u0437\u0434\u0435\u0441\u044c \u0441 \u0441\u0441\u044b\u043b\u043a\u043e\u0439 \u043d\u0430 \u0432\u0430\u0448 \u0432\u0435\u0431-\u0441\u0430\u0439\u0442. [[\u0421\u0442\u0430\u0442\u044c \u0441\u043f\u043e\u043d\u0441\u043e\u0440\u043e\u043c](https://opencollective.com/dayjs#sponsor)]\ndiff --git a/docs/si/README-si.md b/docs/si/README-si.md\nindex e5f7fb92b..b170a516b 100644\n--- a/docs/si/README-si.md\n+++ b/docs/si/README-si.md\n@@ -98,12 +98,6 @@ dayjs().format('Q Do k kk X x') // more available formats\n \n \ud83d\udcda[ \u0daf\u0dd2\u0d9c\u0dd4 \u0dbd\u0dda\u0d9b\u0db1\u0dba](https://day.js.org/docs/en/plugin/plugin)\n \n-### \u0db7\u0dcf\u0dc0\u0dd2\u0dad \u0db4\u0dca\u200d\u0dbb\u0db8\u0dcf\u0dab\u0dba\u0dda \u0db4\u0dca\u200d\u0dbb\u0dc3\u0dd6\u0dad\u0dd2\u0dba\n-\n-<a href=\"https://npm-compare.com/moment,dayjs/#timeRange=THREE_YEARS\" target=\"_blank\">\n-  <img src=\"https://user-images.githubusercontent.com/3455798/270162667-c7bd2ebe-675e-45c6-a2c9-dc67f3b65d6e.png\">\n-</a>\n-\n ## \u0d85\u0db1\u0dd4\u0d9c\u0dca\u200d\u0dbb\u0dcf\u0dc4\u0d9a\u0dba\u0dd2\u0db1\u0dca\n \n \u0d85\u0db1\u0dd4\u0d9c\u0dca\u200d\u0dbb\u0dc4\u0dba \u0daf\u0dd0\u0d9a\u0dca\u0dc0\u0dd3\u0db8\u0dd9\u0db1\u0dca \u0db8\u0dd9\u0db8 \u0dc0\u0dca\u200d\u0dba\u0dcf\u0db4\u0dd8\u0dad\u0dd2\u0dba\u0da7 \u0dc3\u0dc4\u0dcf\u0dba \u0dc0\u0db1\u0dca\u0db1. \u0d94\u0db6\u0d9c\u0dda \u0d85\u0da9\u0dc0\u0dd2\u0dba\u0dda \u0dc3\u0db6\u0dd0\u0db3\u0dd2\u0dba\u0d9a\u0dca \u0dc3\u0db8\u0d9f \u0d94\u0db6\u0d9c\u0dda \u0dbd\u0dcf\u0d82\u0da1\u0db1\u0dba \u0db8\u0dd9\u0dc4\u0dd2 \u0db4\u0dd9\u0db1\u0dca\u0dc0\u0db1\u0dd4 \u0d87\u0dad.\ndiff --git a/docs/tr/README-tr.md b/docs/tr/README-tr.md\nindex 2b1a63549..e408dd77c 100644\n--- a/docs/tr/README-tr.md\n+++ b/docs/tr/README-tr.md\n@@ -108,12 +108,6 @@ dayjs().format('Q Do k kk X x') // di\u011fer mevcut formatlar\n \n \ud83d\udcda[Eklenti Listesi](https://day.js.org/docs/en/plugin/plugin)\n \n-### Kullan\u0131m Trendi\n-\n-<a href=\"https://npm-compare.com/moment,dayjs/#timeRange=THREE_YEARS\" target=\"_blank\">\n-  <img src=\"https://user-images.githubusercontent.com/3455798/270162667-c7bd2ebe-675e-45c6-a2c9-dc67f3b65d6e.png\">\n-</a>\n-\n ## Sponsorlar\n \n Sponsor olarak bu projeye destek olun. Logonuz, web sayfan\u0131z\u0131n linki ile birlikte burada g\u00f6r\u00fcn\u00fcr. [[Sponsor Ol](https://opencollective.com/dayjs#sponsor)]\ndiff --git a/docs/zh-cn/README.zh-CN.md b/docs/zh-cn/README.zh-CN.md\nindex d7bb1ecbc..5abdea0a3 100644\n--- a/docs/zh-cn/README.zh-CN.md\n+++ b/docs/zh-cn/README.zh-CN.md\n@@ -108,12 +108,6 @@ dayjs().format('Q Do k kk X x') // \u4f7f\u7528\u6269\u5c55\u540e\u7684API\n \n \ud83d\udcda[\u63d2\u4ef6\u5217\u8868](https://day.js.org/docs/zh-CN/plugin/plugin)\n \n-### \u4f7f\u7528\u91cf\u8d8b\u52bf\n-\n-<a href=\"https://npm-compare.com/moment,dayjs/#timeRange=THREE_YEARS\" target=\"_blank\">\n-  <img src=\"https://user-images.githubusercontent.com/3455798/270162667-c7bd2ebe-675e-45c6-a2c9-dc67f3b65d6e.png\">\n-</a>\n-\n ## \u5f00\u6e90\u534f\u8bae\n \n Day.js \u9075\u5faa [MIT \u5f00\u6e90\u534f\u8bae](../../LICENSE).\ndiff --git a/package.json b/package.json\nindex 2c74cddc7..e2baf268a 100644\n--- a/package.json\n+++ b/package.json\n@@ -5,7 +5,7 @@\n   \"main\": \"dayjs.min.js\",\n   \"types\": \"index.d.ts\",\n   \"scripts\": {\n-    \"test\": \"TZ=Pacific/Auckland npm run test-tz && TZ=Europe/London npm run test-tz && TZ=America/Whitehorse npm run test-tz && npm run test-tz && jest\",\n+    \"test\": \"TZ=Pacific/Auckland npm run test-tz && TZ=Europe/London npm run test-tz && TZ=America/Whitehorse npm run test-tz && npm run test-tz && jest --coverage --coverageThreshold='{ \\\"global\\\": { \\\"lines\\\": 100} }'\",\n     \"test-tz\": \"date && jest test/timezone.test --coverage=false\",\n     \"lint\": \"./node_modules/.bin/eslint src/* test/* build/*\",\n     \"prettier\": \"prettier --write \\\"docs/**/*.md\\\"\",\ndiff --git a/src/locale/ar.js b/src/locale/ar.js\nindex f418379c8..5d28a1d31 100644\n--- a/src/locale/ar.js\n+++ b/src/locale/ar.js\n@@ -29,6 +29,12 @@ const numberMap = {\n   '\u0660': '0'\n }\n \n+const fromArabNumeralsRegex = /[\u0661\u0662\u0663\u0664\u0665\u0666\u0667\u0668\u0669\u0660]/g\n+const fromArabComaRegex = /\u060c/g\n+\n+const toArabNumeralsRegex = /\\d/g\n+const toArabComaRegex = /,/g\n+\n const locale = {\n   name: 'ar',\n   weekdays: '\u0627\u0644\u0623\u062d\u062f_\u0627\u0644\u0625\u062b\u0646\u064a\u0646_\u0627\u0644\u062b\u0644\u0627\u062b\u0627\u0621_\u0627\u0644\u0623\u0631\u0628\u0639\u0627\u0621_\u0627\u0644\u062e\u0645\u064a\u0633_\u0627\u0644\u062c\u0645\u0639\u0629_\u0627\u0644\u0633\u0628\u062a'.split('_'),\n@@ -56,15 +62,15 @@ const locale = {\n   preparse(string) {\n     return string\n       .replace(\n-        /[\u0661\u0662\u0663\u0664\u0665\u0666\u0667\u0668\u0669\u0660]/g,\n+        fromArabNumeralsRegex,\n         match => numberMap[match]\n       )\n-      .replace(/\u060c/g, ',')\n+      .replace(fromArabComaRegex, ',')\n   },\n   postformat(string) {\n     return string\n-      .replace(/\\d/g, match => symbolMap[match])\n-      .replace(/,/g, '\u060c')\n+      .replace(toArabNumeralsRegex, match => symbolMap[match])\n+      .replace(toArabComaRegex, '\u060c')\n   },\n   ordinal: n => n,\n   formats: {\ndiff --git a/src/locale/be.js b/src/locale/be.js\nindex 3b4e2d731..c35d56574 100644\n--- a/src/locale/be.js\n+++ b/src/locale/be.js\n@@ -1,15 +1,63 @@\n // Belarusian [be]\n import dayjs from 'dayjs'\n \n+const monthFormat = '\u0441\u0442\u0443\u0434\u0437\u0435\u043d\u044f_\u043b\u044e\u0442\u0430\u0433\u0430_\u0441\u0430\u043a\u0430\u0432\u0456\u043a\u0430_\u043a\u0440\u0430\u0441\u0430\u0432\u0456\u043a\u0430_\u0442\u0440\u0430\u045e\u043d\u044f_\u0447\u044d\u0440\u0432\u0435\u043d\u044f_\u043b\u0456\u043f\u0435\u043d\u044f_\u0436\u043d\u0456\u045e\u043d\u044f_\u0432\u0435\u0440\u0430\u0441\u043d\u044f_\u043a\u0430\u0441\u0442\u0440\u044b\u0447\u043d\u0456\u043a\u0430_\u043b\u0456\u0441\u0442\u0430\u043f\u0430\u0434\u0430_\u0441\u043d\u0435\u0436\u043d\u044f'.split('_')\n+const monthStandalone = '\u0441\u0442\u0443\u0434\u0437\u0435\u043d\u044c_\u043b\u044e\u0442\u044b\u0439_\u0441\u0430\u043a\u0430\u0432\u0456\u043a_\u043a\u0440\u0430\u0441\u0430\u0432\u0456\u043a_\u0442\u0440\u0430\u0432\u0435\u043d\u044c_\u0447\u044d\u0440\u0432\u0435\u043d\u044c_\u043b\u0456\u043f\u0435\u043d\u044c_\u0436\u043d\u0456\u0432\u0435\u043d\u044c_\u0432\u0435\u0440\u0430\u0441\u0435\u043d\u044c_\u043a\u0430\u0441\u0442\u0440\u044b\u0447\u043d\u0456\u043a_\u043b\u0456\u0441\u0442\u0430\u043f\u0430\u0434_\u0441\u043d\u0435\u0436\u0430\u043d\u044c'.split('_')\n+\n+const monthShortFormat = '\u0441\u0442\u0443\u0434_\u043b\u044e\u0442_\u0441\u0430\u043a_\u043a\u0440\u0430\u0441_\u0442\u0440\u0430\u0432_\u0447\u044d\u0440\u0432_\u043b\u0456\u043f_\u0436\u043d\u0456\u0432_\u0432\u0435\u0440_\u043a\u0430\u0441\u0442_\u043b\u0456\u0441\u0442_\u0441\u043d\u0435\u0436.'.split('_')\n+const monthShortStandalone = '\u0441\u0442\u0443\u0434_\u043b\u044e\u0442_\u0441\u0430\u043a_\u043a\u0440\u0430\u0441_\u0442\u0440\u0430\u0432_\u0447\u044d\u0440\u0432_\u043b\u0456\u043f_\u0436\u043d\u0456\u0432_\u0432\u0435\u0440_\u043a\u0430\u0441\u0442_\u043b\u0456\u0441\u0442_\u0441\u043d\u0435\u0436'.split('_')\n+\n+const MONTHS_IN_FORMAT = /D[oD]?(\\[[^[\\]]*\\]|\\s)+MMMM?/\n+\n+function plural(word, num) {\n+  const forms = word.split('_')\n+  return num % 10 === 1 && num % 100 !== 11 ? forms[0] : (num % 10 >= 2 && num % 10 <= 4 && (num % 100 < 10 || num % 100 >= 20) ? forms[1] : forms[2]) // eslint-disable-line\n+}\n+function relativeTimeWithPlural(number, withoutSuffix, key) {\n+  const format = {\n+    ss: withoutSuffix ? '\u0441\u0435\u043a\u0443\u043d\u0434\u0430_\u0441\u0435\u043a\u0443\u043d\u0434\u044b_\u0441\u0435\u043a\u0443\u043d\u0434' : '\u0441\u0435\u043a\u0443\u043d\u0434\u0443_\u0441\u0435\u043a\u0443\u043d\u0434\u044b_\u0441\u0435\u043a\u0443\u043d\u0434',\n+    mm: withoutSuffix ? '\u0445\u0432\u0456\u043b\u0456\u043d\u0430_\u0445\u0432\u0456\u043b\u0456\u043d\u044b_\u0445\u0432\u0456\u043b\u0456\u043d' : '\u0445\u0432\u0456\u043b\u0456\u043d\u0443_\u0445\u0432\u0456\u043b\u0456\u043d\u044b_\u0445\u0432\u0456\u043b\u0456\u043d',\n+    hh: withoutSuffix ? '\u0433\u0430\u0434\u0437\u0456\u043d\u0430_\u0433\u0430\u0434\u0437\u0456\u043d\u044b_\u0433\u0430\u0434\u0437\u0456\u043d' : '\u0433\u0430\u0434\u0437\u0456\u043d\u0443_\u0433\u0430\u0434\u0437\u0456\u043d\u044b_\u0433\u0430\u0434\u0437\u0456\u043d',\n+    dd: '\u0434\u0437\u0435\u043d\u044c_\u0434\u043d\u0456_\u0434\u0437\u0451\u043d',\n+    MM: '\u043c\u0435\u0441\u044f\u0446_\u043c\u0435\u0441\u044f\u0446\u044b_\u043c\u0435\u0441\u044f\u0446\u0430\u045e',\n+    yy: '\u0433\u043e\u0434_\u0433\u0430\u0434\u044b_\u0433\u0430\u0434\u043e\u045e'\n+  }\n+  if (key === 'm') {\n+    return withoutSuffix ? '\u0445\u0432\u0456\u043b\u0456\u043d\u0430' : '\u0445\u0432\u0456\u043b\u0456\u043d\u0443'\n+  } else if (key === 'h') {\n+    return withoutSuffix ? '\u0433\u0430\u0434\u0437\u0456\u043d\u0430' : '\u0433\u0430\u0434\u0437\u0456\u043d\u0443'\n+  }\n+\n+  return `${number} ${plural(format[key], +number)}`\n+}\n+\n+const months = (dayjsInstance, format) => {\n+  if (MONTHS_IN_FORMAT.test(format)) {\n+    return monthFormat[dayjsInstance.month()]\n+  }\n+  return monthStandalone[dayjsInstance.month()]\n+}\n+months.s = monthStandalone\n+months.f = monthFormat\n+\n+const monthsShort = (dayjsInstance, format) => {\n+  if (MONTHS_IN_FORMAT.test(format)) {\n+    return monthShortFormat[dayjsInstance.month()]\n+  }\n+  return monthShortStandalone[dayjsInstance.month()]\n+}\n+monthsShort.s = monthShortStandalone\n+monthsShort.f = monthShortFormat\n+\n const locale = {\n   name: 'be',\n-  weekdays: '\u043d\u044f\u0434\u0437\u0435\u043b\u044e_\u043f\u0430\u043d\u044f\u0434\u0437\u0435\u043b\u0430\u043a_\u0430\u045e\u0442\u043e\u0440\u0430\u043a_\u0441\u0435\u0440\u0430\u0434\u0443_\u0447\u0430\u0446\u0432\u0435\u0440_\u043f\u044f\u0442\u043d\u0456\u0446\u0443_\u0441\u0443\u0431\u043e\u0442\u0443'.split('_'),\n-  months: '\u0441\u0442\u0443\u0434\u0437\u0435\u043d\u044f_\u043b\u044e\u0442\u0430\u0433\u0430_\u0441\u0430\u043a\u0430\u0432\u0456\u043a\u0430_\u043a\u0440\u0430\u0441\u0430\u0432\u0456\u043a\u0430_\u0442\u0440\u0430\u045e\u043d\u044f_\u0447\u044d\u0440\u0432\u0435\u043d\u044f_\u043b\u0456\u043f\u0435\u043d\u044f_\u0436\u043d\u0456\u045e\u043d\u044f_\u0432\u0435\u0440\u0430\u0441\u043d\u044f_\u043a\u0430\u0441\u0442\u0440\u044b\u0447\u043d\u0456\u043a\u0430_\u043b\u0456\u0441\u0442\u0430\u043f\u0430\u0434\u0430_\u0441\u043d\u0435\u0436\u043d\u044f'.split('_'),\n+  weekdays: '\u043d\u044f\u0434\u0437\u0435\u043b\u044f_\u043f\u0430\u043d\u044f\u0434\u0437\u0435\u043b\u0430\u043a_\u0430\u045e\u0442\u043e\u0440\u0430\u043a_\u0441\u0435\u0440\u0430\u0434\u0430_\u0447\u0430\u0446\u0432\u0435\u0440_\u043f\u044f\u0442\u043d\u0456\u0446\u0430_\u0441\u0443\u0431\u043e\u0442\u0430'.split('_'),\n+  weekdaysShort: '\u043d\u044f\u0434_\u043f\u043d\u0434_\u0430\u045e\u0442_\u0441\u0435\u0440_\u0447\u0446\u0432_\u043f\u044f\u0442_\u0441\u0443\u0431'.split('_'),\n+  weekdaysMin: '\u043d\u0434_\u043f\u043d_\u0430\u045e_\u0441\u0440_\u0447\u0446_\u043f\u0442_\u0441\u0431'.split('_'),\n+  months,\n+  monthsShort,\n   weekStart: 1,\n-  weekdaysShort: '\u043d\u0434_\u043f\u043d_\u0430\u0442_\u0441\u0440_\u0447\u0446_\u043f\u0442_\u0441\u0431'.split('_'),\n-  monthsShort: '\u0441\u0442\u0443\u0434_\u043b\u044e\u0442_\u0441\u0430\u043a_\u043a\u0440\u0430\u0441_\u0442\u0440\u0430\u0432_\u0447\u044d\u0440\u0432_\u043b\u0456\u043f_\u0436\u043d\u0456\u0432_\u0432\u0435\u0440_\u043a\u0430\u0441\u0442_\u043b\u0456\u0441\u0442_\u0441\u043d\u0435\u0436'.split('_'),\n-  weekdaysMin: '\u043d\u0434_\u043f\u043d_\u0430\u0442_\u0441\u0440_\u0447\u0446_\u043f\u0442_\u0441\u0431'.split('_'),\n-  ordinal: n => n,\n+  yearStart: 4,\n   formats: {\n     LT: 'HH:mm',\n     LTS: 'HH:mm:ss',\n@@ -17,10 +65,35 @@ const locale = {\n     LL: 'D MMMM YYYY \u0433.',\n     LLL: 'D MMMM YYYY \u0433., HH:mm',\n     LLLL: 'dddd, D MMMM YYYY \u0433., HH:mm'\n+  },\n+  relativeTime: {\n+    future: '\u043f\u0440\u0430\u0437 %s',\n+    past: '%s \u0442\u0430\u043c\u0443',\n+    s: '\u043d\u0435\u043a\u0430\u043b\u044c\u043a\u0456 \u0441\u0435\u043a\u0443\u043d\u0434',\n+    m: relativeTimeWithPlural,\n+    mm: relativeTimeWithPlural,\n+    h: relativeTimeWithPlural,\n+    hh: relativeTimeWithPlural,\n+    d: '\u0434\u0437\u0435\u043d\u044c',\n+    dd: relativeTimeWithPlural,\n+    M: '\u043c\u0435\u0441\u044f\u0446',\n+    MM: relativeTimeWithPlural,\n+    y: '\u0433\u043e\u0434',\n+    yy: relativeTimeWithPlural\n+  },\n+  ordinal: n => n,\n+  meridiem: (hour) => {\n+    if (hour < 4) {\n+      return '\u043d\u043e\u0447\u044b'\n+    } else if (hour < 12) {\n+      return '\u0440\u0430\u043d\u0456\u0446\u044b'\n+    } else if (hour < 17) {\n+      return '\u0434\u043d\u044f'\n+    }\n+    return '\u0432\u0435\u0447\u0430\u0440\u0430'\n   }\n }\n \n dayjs.locale(locale, null, true)\n \n export default locale\n-\ndiff --git a/src/locale/it.js b/src/locale/it.js\nindex 08f660bef..b4bceb00d 100644\n--- a/src/locale/it.js\n+++ b/src/locale/it.js\n@@ -23,7 +23,7 @@ const locale = {\n     s: 'qualche secondo',\n     m: 'un minuto',\n     mm: '%d minuti',\n-    h: 'un\\' ora',\n+    h: 'un\\'ora',\n     hh: '%d ore',\n     d: 'un giorno',\n     dd: '%d giorni',\ndiff --git a/src/plugin/devHelper/index.js b/src/plugin/devHelper/index.js\nindex bdb83caf7..2f163a25f 100644\n--- a/src/plugin/devHelper/index.js\n+++ b/src/plugin/devHelper/index.js\n@@ -26,6 +26,15 @@ export default (o, c, d) => {\n       }\n       return oldLocale(preset, object, isLocal)\n     }\n+\n+    const oldDiff = proto.diff\n+    proto.diff = function (date, unit, float) {\n+      const isInvalidDate = !date || !d(date).isValid()\n+      if (isInvalidDate) {\n+        console.warn('Invalid usage: diff() requires a valid comparison date as the first argument. https://day.js.org/docs/en/display/difference')\n+      }\n+\n+      return oldDiff.call(this, date, unit, float)\n+    }\n   }\n }\n-\n",
    "test_patch": "diff --git a/test/locale/be.test.js b/test/locale/be.test.js\nnew file mode 100644\nindex 000000000..0c39f224b\n--- /dev/null\n+++ b/test/locale/be.test.js\n@@ -0,0 +1,142 @@\n+import MockDate from 'mockdate'\n+import moment from 'moment'\n+import dayjs from '../../src'\n+import '../../src/locale/be'\n+import relativeTime from '../../src/plugin/relativeTime'\n+\n+dayjs.extend(relativeTime)\n+\n+beforeEach(() => {\n+  MockDate.set(new Date())\n+})\n+\n+afterEach(() => {\n+  MockDate.reset()\n+})\n+\n+it('Belarusian locale relative time in past and future with suffix', () => {\n+  const cases = [\n+    [1, 's', '\u043f\u0440\u0430\u0437 \u043d\u0435\u043a\u0430\u043b\u044c\u043a\u0456 \u0441\u0435\u043a\u0443\u043d\u0434'],\n+    [-1, 's', '\u043d\u0435\u043a\u0430\u043b\u044c\u043a\u0456 \u0441\u0435\u043a\u0443\u043d\u0434 \u0442\u0430\u043c\u0443'],\n+    [1, 'm', '\u043f\u0440\u0430\u0437 \u0445\u0432\u0456\u043b\u0456\u043d\u0443'],\n+    [-1, 'm', '\u0445\u0432\u0456\u043b\u0456\u043d\u0443 \u0442\u0430\u043c\u0443'],\n+    [1, 'h', '\u043f\u0440\u0430\u0437 \u0433\u0430\u0434\u0437\u0456\u043d\u0443'],\n+    [-1, 'h', '\u0433\u0430\u0434\u0437\u0456\u043d\u0443 \u0442\u0430\u043c\u0443'],\n+    [1, 'd', '\u043f\u0440\u0430\u0437 \u0434\u0437\u0435\u043d\u044c'],\n+    [-1, 'd', '\u0434\u0437\u0435\u043d\u044c \u0442\u0430\u043c\u0443'],\n+    [1, 'M', '\u043f\u0440\u0430\u0437 \u043c\u0435\u0441\u044f\u0446'],\n+    [-1, 'M', '\u043c\u0435\u0441\u044f\u0446 \u0442\u0430\u043c\u0443'],\n+    [2, 'd', '\u043f\u0440\u0430\u0437 2 \u0434\u043d\u0456'],\n+    [-2, 'd', '2 \u0434\u043d\u0456 \u0442\u0430\u043c\u0443'],\n+    [10, 'd', '\u043f\u0440\u0430\u0437 10 \u0434\u0437\u0451\u043d'],\n+    [-10, 'd', '10 \u0434\u0437\u0451\u043d \u0442\u0430\u043c\u0443'],\n+    [6, 'm', '\u043f\u0440\u0430\u0437 6 \u0445\u0432\u0456\u043b\u0456\u043d'],\n+    [-6, 'm', '6 \u0445\u0432\u0456\u043b\u0456\u043d \u0442\u0430\u043c\u0443'],\n+    [5, 'h', '\u043f\u0440\u0430\u0437 5 \u0433\u0430\u0434\u0437\u0456\u043d'],\n+    [-5, 'h', '5 \u0433\u0430\u0434\u0437\u0456\u043d \u0442\u0430\u043c\u0443'],\n+    [3, 'M', '\u043f\u0440\u0430\u0437 3 \u043c\u0435\u0441\u044f\u0446\u044b'],\n+    [-3, 'M', '3 \u043c\u0435\u0441\u044f\u0446\u044b \u0442\u0430\u043c\u0443'],\n+    [4, 'y', '\u043f\u0440\u0430\u0437 4 \u0433\u0430\u0434\u044b'],\n+    [-4, 'y', '4 \u0433\u0430\u0434\u044b \u0442\u0430\u043c\u0443']\n+  ]\n+\n+  const locales = ['be']\n+  locales.forEach((locale) => {\n+    cases.forEach((c) => {\n+      expect(dayjs()\n+        .add(c[0], c[1])\n+        .locale(locale)\n+        .fromNow()).toBe(c[2])\n+      expect(dayjs()\n+        .add(c[0], c[1])\n+        .locale(locale)\n+        .fromNow()).toBe(moment()\n+        .add(c[0], c[1])\n+        .locale(locale)\n+        .fromNow())\n+    })\n+  })\n+})\n+\n+it('Belarusian locale relative time in past and future without suffix', () => {\n+  const cases = [\n+    [1, 's', '\u043d\u0435\u043a\u0430\u043b\u044c\u043a\u0456 \u0441\u0435\u043a\u0443\u043d\u0434'],\n+    [-1, 's', '\u043d\u0435\u043a\u0430\u043b\u044c\u043a\u0456 \u0441\u0435\u043a\u0443\u043d\u0434'],\n+\n+    [1, 'm', '\u0445\u0432\u0456\u043b\u0456\u043d\u0430'],\n+    [-1, 'm', '\u0445\u0432\u0456\u043b\u0456\u043d\u0430'],\n+    [1, 'h', '\u0433\u0430\u0434\u0437\u0456\u043d\u0430'],\n+    [-1, 'h', '\u0433\u0430\u0434\u0437\u0456\u043d\u0430'],\n+\n+    // Test all plural forms for days\n+    [1, 'd', '\u0434\u0437\u0435\u043d\u044c'],\n+    [21, 'd', '21 \u0434\u0437\u0435\u043d\u044c'],\n+    [31, 'd', '\u043c\u0435\u0441\u044f\u0446'],\n+    // 2-4 form\n+    [2, 'd', '2 \u0434\u043d\u0456'],\n+    [3, 'd', '3 \u0434\u043d\u0456'],\n+    [4, 'd', '4 \u0434\u043d\u0456'],\n+    // 5-20 and other cases\n+    [5, 'd', '5 \u0434\u0437\u0451\u043d'],\n+    [6, 'd', '6 \u0434\u0437\u0451\u043d'],\n+    // 11-14 special case\n+    [11, 'd', '11 \u0434\u0437\u0451\u043d'],\n+    [12, 'd', '12 \u0434\u0437\u0451\u043d'],\n+    [13, 'd', '13 \u0434\u0437\u0451\u043d'],\n+    [14, 'd', '14 \u0434\u0437\u0451\u043d'],\n+    // 22-24\n+    [22, 'd', '22 \u0434\u043d\u0456'],\n+    [23, 'd', '23 \u0434\u043d\u0456'],\n+    [24, 'd', '24 \u0434\u043d\u0456'],\n+\n+    // Test all plural forms for months\n+    [1, 'M', '\u043c\u0435\u0441\u044f\u0446'],\n+    [2, 'M', '2 \u043c\u0435\u0441\u044f\u0446\u044b'],\n+    [5, 'M', '5 \u043c\u0435\u0441\u044f\u0446\u0430\u045e'],\n+\n+    // Test all plural forms for years\n+    [1, 'y', '\u0433\u043e\u0434'],\n+    [2, 'y', '2 \u0433\u0430\u0434\u044b'],\n+    [5, 'y', '5 \u0433\u0430\u0434\u043e\u045e'],\n+    [11, 'y', '11 \u0433\u0430\u0434\u043e\u045e'],\n+    [21, 'y', '21 \u0433\u043e\u0434']\n+  ]\n+\n+  const locales = ['be']\n+  locales.forEach((locale) => {\n+    cases.forEach((c) => {\n+      expect(dayjs()\n+        .add(c[0], c[1])\n+        .locale(locale)\n+        .fromNow(true)).toBe(c[2])\n+      expect(dayjs()\n+        .add(c[0], c[1])\n+        .locale(locale)\n+        .fromNow(true)).toBe(moment()\n+        .add(c[0], c[1])\n+        .locale(locale)\n+        .fromNow(true))\n+    })\n+  })\n+})\n+\n+it('Belarusian locale formats dates with correct month forms', () => {\n+  const tests = [\n+    // Full month names\n+    { date: '2022-01-19', format: 'dd, D MMMM YYYY \u0433.', expected: '\u0441\u0440, 19 \u0441\u0442\u0443\u0434\u0437\u0435\u043d\u044f 2022 \u0433.' },\n+    { date: '2022-01-01', format: 'MMMM', expected: '\u0441\u0442\u0443\u0434\u0437\u0435\u043d\u044c' },\n+\n+    // Short month names in format form (with day)\n+    { date: '2022-01-15', format: 'D MMM', expected: '15 \u0441\u0442\u0443\u0434' },\n+    { date: '2022-02-15', format: 'D MMM', expected: '15 \u043b\u044e\u0442' },\n+\n+    // Short month names in standalone form\n+    { date: '2022-01-01', format: 'MMM', expected: '\u0441\u0442\u0443\u0434' },\n+    { date: '2022-02-01', format: 'MMM', expected: '\u043b\u044e\u0442' }\n+  ]\n+\n+  tests.forEach(({ date, format, expected }) => {\n+    const dayjsWithLocale = dayjs(date).locale('be')\n+    expect(dayjsWithLocale.format(format)).toEqual(expected)\n+  })\n+})\ndiff --git a/test/locale/it.test.js b/test/locale/it.test.js\nnew file mode 100644\nindex 000000000..56043b1de\n--- /dev/null\n+++ b/test/locale/it.test.js\n@@ -0,0 +1,84 @@\n+import moment from 'moment'\n+import MockDate from 'mockdate'\n+import dayjs from '../../src'\n+import '../../src/locale/it'\n+import relativeTime from '../../src/plugin/relativeTime'\n+import localizedFormat from '../../src/plugin/localizedFormat'\n+\n+dayjs.extend(relativeTime)\n+dayjs.extend(localizedFormat)\n+\n+describe('Italian formats', () => {\n+  beforeEach(() => {\n+    dayjs.locale('it')\n+    moment.locale('it')\n+\n+    MockDate.set(new Date())\n+  })\n+\n+  afterEach(() => {\n+    MockDate.reset()\n+  })\n+\n+\n+  it('Format month with locale function', () => {\n+    for (let i = 0; i <= 7; i += 1) {\n+      const dayjsWithLocale = dayjs().add(i, 'day')\n+      const momentWithLocale = moment().add(i, 'day')\n+      const testFormat1 = 'DD MMMM YYYY MMM'\n+      const testFormat2 = 'dddd, MMMM D YYYY'\n+      const testFormat3 = 'MMMM'\n+      const testFormat4 = 'MMM'\n+      const testFormat5 = 'L'\n+      expect(dayjsWithLocale.format(testFormat1)).toEqual(momentWithLocale.format(testFormat1))\n+      expect(dayjsWithLocale.format(testFormat2)).toEqual(momentWithLocale.format(testFormat2))\n+      expect(dayjsWithLocale.format(testFormat3)).toEqual(momentWithLocale.format(testFormat3))\n+      expect(dayjsWithLocale.format(testFormat4)).toEqual(momentWithLocale.format(testFormat4))\n+      expect(dayjsWithLocale.format(testFormat5)).toEqual(momentWithLocale.format(testFormat5))\n+    }\n+  })\n+\n+  it('RelativeTime: Time from X', () => {\n+    const T = [\n+      [89.5, 'second'], // a minute\n+      [2, 'minute'], // 2 minutes\n+      [5, 'minute'], // 5 minutes\n+      [43, 'minute'], // 44 minutes\n+      [45, 'minute'], // an hour\n+      [3, 'hour'], // 3 hours\n+      [21, 'hour'], // 21 hours\n+      [1, 'day'], // a day\n+      [3, 'day'], // 3 day\n+      [25, 'day'], // 25 days\n+      [1, 'month'], // a month\n+      [2, 'month'], // 2 month\n+      [10, 'month'], // 10 month\n+      [1, 'year'], // a year\n+      [2, 'year'], // 2 year\n+      [5, 'year'], // 5 year\n+      [18, 'month'] // 2 years\n+    ]\n+\n+\n+    T.forEach((t) => {\n+      expect(dayjs().from(dayjs().add(t[0], t[1])))\n+        .toBe(moment().from(moment().add(t[0], t[1])))\n+      expect(dayjs().from(dayjs().add(t[0], t[1]), true))\n+        .toBe(moment().from(moment().add(t[0], t[1]), true))\n+    })\n+  })\n+\n+  // moment.js uses `alcuni secondi` while dayjs uses `qualche secondo`.\n+  it('RelativeTime: A few seconds', () => {\n+    const T = [\n+      [44.4, 'second'] // a few seconds\n+    ]\n+\n+    T.forEach((t) => {\n+      expect(dayjs().from(dayjs().add(t[0], t[1])))\n+        .toBe('qualche secondo fa')\n+      expect(dayjs().from(dayjs().add(t[0], t[1]), true))\n+        .toBe('qualche secondo')\n+    })\n+  })\n+})\ndiff --git a/test/plugin/devHelper.test.js b/test/plugin/devHelper.test.js\nindex c69190a14..ff63d434d 100644\n--- a/test/plugin/devHelper.test.js\n+++ b/test/plugin/devHelper.test.js\n@@ -1,6 +1,8 @@\n import MockDate from 'mockdate'\n import dayjs from '../../src'\n+import customParseFormat from '../../src/plugin/customParseFormat'\n import devHelper from '../../src/plugin/devHelper'\n+import localeData from '../../src/plugin/localeData'\n \n dayjs.extend(devHelper)\n \n@@ -38,3 +40,46 @@ it('Warning: Setting locale before loading locale', () => {\n   dayjs.locale('zh-cn')\n   expect(consoleSpy).toHaveBeenCalledWith('Guessing you may want to use locale zh-cn, you have to load it before using it. https://day.js.org/docs/en/i18n/loading-into-nodejs')\n })\n+\n+describe('dev-helper: diff() usage warnings', () => {\n+  const diffWarningMsg = 'Invalid usage: diff() requires a valid comparison date as the first argument. https://day.js.org/docs/en/display/difference'\n+\n+  beforeAll(() => {\n+    dayjs.extend(customParseFormat)\n+    dayjs.extend(localeData)\n+  })\n+\n+  beforeEach(() => {\n+    jest.clearAllMocks()\n+  })\n+\n+  it('warns when diff() is called with no comparison date', () => {\n+    const consoleSpy = jest.spyOn(console, 'warn')\n+    dayjs('2025-01-10').diff()\n+    expect(consoleSpy).toHaveBeenCalledWith(diffWarningMsg)\n+  })\n+\n+  it('warns when diff() is called with just the unit', () => {\n+    const consoleSpy = jest.spyOn(console, 'warn')\n+    dayjs('2025-01-10').diff('days')\n+    expect(consoleSpy).toHaveBeenCalledWith(diffWarningMsg)\n+  })\n+\n+  it('warns when diff() is called with an invalid comparison date (unparsable string)', () => {\n+    const consoleSpy = jest.spyOn(console, 'warn')\n+    dayjs('2025-01-10').diff('invalid-date', 'days')\n+    expect(consoleSpy).toHaveBeenCalledWith(diffWarningMsg)\n+  })\n+\n+  it('does NOT warn when diff() is called with a valid string date', () => {\n+    const consoleSpy = jest.spyOn(console, 'warn')\n+    dayjs('2025-01-10').diff('2025-01-09', 'days')\n+    expect(consoleSpy).not.toHaveBeenCalledWith(diffWarningMsg)\n+  })\n+\n+  it('does NOT warn when diff() is called with a valid Day.js instance', () => {\n+    const consoleSpy = jest.spyOn(console, 'warn')\n+    dayjs('2025-01-10').diff(dayjs(), 'days')\n+    expect(consoleSpy).not.toHaveBeenCalledWith(diffWarningMsg)\n+  })\n+})\n",
    "problem_statement": "",
    "direct_patch": true,
    "has_rewrites": false,
    "_file": "logs/bug_gen/iamkun__dayjs.c8a26460/pr_mirror/iamkun__dayjs.c8a26460.2950/metadata__pr_2950.json"
  },
  {
    "instance_id": "iamkun__dayjs.c8a26460.2920",
    "repo": "iamkun/dayjs",
    "pull_number": 2920,
    "base_commit": "c8a26460",
    "patch": "diff --git a/.github/workflows/check.yml b/.github/workflows/check.yml\nindex 53167a1e3..c9359f95e 100644\n--- a/.github/workflows/check.yml\n+++ b/.github/workflows/check.yml\n@@ -4,22 +4,9 @@ on:\n     branches: [master, dev]\n   pull_request:\n     branches: [dev]\n+\n jobs:\n   check:\n-    runs-on: ubuntu-latest\n-    steps:\n-      - name: Checkout\n-        uses: actions/checkout@v3\n-      - name: Setup Node.js\n-        uses: actions/setup-node@v3\n-        with:\n-          node-version: 'lts/*'\n-          cache: 'npm'\n-      - name: Install dependencies\n-        run: npm install -g codecov && npm install\n-      - name: Run Lint\n-        run: npm run lint\n-      - name: Run tests\n-        run: npm test\n-      - name: Upload coverage\n-        run: codecov || echo \"Codecov upload failed, continuing...\"\n+    uses: ./.github/workflows/lint-test.yml\n+    secrets:\n+      inherit\ndiff --git a/.github/workflows/release.yml b/.github/workflows/release.yml\nindex 4f1bc2441..396931caf 100644\n--- a/.github/workflows/release.yml\n+++ b/.github/workflows/release.yml\n@@ -1,52 +1,42 @@\n name: Release\n on:\n-  workflow_run:\n-    workflows: ['Lint & Unit Test']\n+  push:\n     branches: [master]\n-    types:\n-      - completed\n-\n-permissions:\n-  contents: read # for checkout\n \n jobs:\n+  lint-and-test:\n+    uses: ./.github/workflows/lint-test.yml\n+    secrets:\n+      inherit\n   release:\n-    env: \n-      GITHUB_TRIGGER_REF: ${{ github.event.workflow_run.head_branch }} # For workflow_run the GITHUB_REF is the default branch, as mentioned in the docs \n-    if: ${{ github.event.workflow_run.conclusion == 'success' }}\n-    name: Release\n+    needs: lint-and-test\n     runs-on: ubuntu-latest\n     permissions:\n-      contents: write # to be able to publish a GitHub release\n-      issues: write # to be able to comment on released issues\n-      pull-requests: write # to be able to comment on released pull requests\n-      id-token: write # to enable use of OIDC for npm provenance\n+      contents: write\n+      issues: write\n+      pull-requests: write\n+      id-token: write\n     steps:\n       - name: Checkout\n         uses: actions/checkout@v3\n         with:\n           fetch-depth: 0\n-          ref: ${{ env.GITHUB_TRIGGER_REF }}\n       - name: Setup Node.js\n         uses: actions/setup-node@v3\n         with:\n-          node-version: 'lts/*' # semantic-release requires Node >= 18\n+          node-version: 'lts/*'\n       - name: Install dependencies\n         run: npm clean-install\n       - name: Build\n-        env: # temporary workaround for \"Error: error:0308010C:digital envelope routines::unsupported\" in Node lts / 18\n+        env:\n           NODE_OPTIONS: --openssl-legacy-provider\n         run: npm run build && npm run babel\n-      - name: Verify the integrity of provenance attestations and registry signatures for installed dependencies\n+      - name: Verify provenance\n         run: npm audit signatures\n       - name: Release\n         env:\n           GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}\n           NPM_TOKEN: ${{ secrets.NPM_TOKEN }}\n         run: |\n-          npm install -g @semantic-release/changelog @semantic-release/git semantic-release \n-          GITHUB_REF=${{ env.GITHUB_TRIGGER_REF }} semantic-release\n-          echo release success\n-      - name: Notify\n-        run: |\n-          curl -s ${{ secrets.GITEE_SYNC_URL }}\n+          npm install -g @semantic-release/changelog @semantic-release/git semantic-release\n+          semantic-release\ndiff --git a/src/locale/ga.js b/src/locale/ga.js\nindex 1e433cddf..fd0dbbca8 100644\n--- a/src/locale/ga.js\n+++ b/src/locale/ga.js\n@@ -3,12 +3,12 @@ import dayjs from 'dayjs'\n \n const locale = {\n   name: 'ga',\n-  weekdays: 'D\u00e9 Domhnaigh_D\u00e9 Luain_D\u00e9 M\u00e1irt_D\u00e9 C\u00e9adaoin_D\u00e9ardaoin_D\u00e9 hAoine_D\u00e9 Satharn'.split('_'),\n-  months: 'Ean\u00e1ir_Feabhra_M\u00e1rta_Aibre\u00e1n_Bealtaine_M\u00e9itheamh_I\u00fail_L\u00fanasa_Me\u00e1n F\u00f3mhair_Deaireadh F\u00f3mhair_Samhain_Nollaig'.split('_'),\n+  weekdays: 'D\u00e9 Domhnaigh_D\u00e9 Luain_D\u00e9 M\u00e1irt_D\u00e9 C\u00e9adaoin_D\u00e9ardaoin_D\u00e9 hAoine_D\u00e9 Sathairn'.split('_'),\n+  months: 'Ean\u00e1ir_Feabhra_M\u00e1rta_Aibre\u00e1n_Bealtaine_Meitheamh_I\u00fail_L\u00fanasa_Me\u00e1n F\u00f3mhair_Deireadh F\u00f3mhair_Samhain_Nollaig'.split('_'),\n   weekStart: 1,\n-  weekdaysShort: 'Dom_Lua_M\u00e1i_C\u00e9a_D\u00e9a_hAo_Sat'.split('_'),\n-  monthsShort: 'Ean\u00e1_Feab_M\u00e1rt_Aibr_Beal_M\u00e9it_I\u00fail_L\u00fana_Me\u00e1n_Deai_Samh_Noll'.split('_'),\n-  weekdaysMin: 'Do_Lu_M\u00e1_Ce_D\u00e9_hA_Sa'.split('_'),\n+  weekdaysShort: 'Dom_Lua_M\u00e1i_C\u00e9a_D\u00e9a_Aoi_Sat'.split('_'),\n+  monthsShort: 'Ean_Fea_M\u00e1r_Aib_Beal_Mei_I\u00fail_L\u00fan_MF\u00f3mh_DF\u00f3mh_Samh_Noll'.split('_'),\n+  weekdaysMin: 'Do_Lu_M\u00e1_C\u00e9_D\u00e9_Ao_Sa'.split('_'),\n   ordinal: n => n,\n   formats: {\n     LT: 'HH:mm',\n",
    "test_patch": "diff --git a/.github/workflows/lint-test.yml b/.github/workflows/lint-test.yml\nnew file mode 100644\nindex 000000000..c908f07b6\n--- /dev/null\n+++ b/.github/workflows/lint-test.yml\n@@ -0,0 +1,30 @@\n+on:\n+  workflow_call:\n+    secrets:\n+      CODECOV_TOKEN:\n+        required: false\n+\n+jobs:\n+  lint-and-test:\n+    runs-on: ubuntu-latest\n+    steps:\n+      - name: Checkout\n+        uses: actions/checkout@v3\n+      - name: Setup Node\n+        uses: actions/setup-node@v3\n+        with:\n+          node-version: 'lts/*'\n+          cache: 'npm'\n+      - name: Install dependencies\n+        run: npm install\n+      - name: Run Lint\n+        run: npm run lint\n+      - name: Run tests\n+        run: npm test\n+      - name: Upload coverage to Codecov\n+        env:\n+          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}\n+        if: env.CODECOV_TOKEN != null\n+        uses: codecov/codecov-action@v4\n+        with:\n+          token: ${{ env.CODECOV_TOKEN }}\ndiff --git a/test/locale/zh-hk.test.js b/test/locale/zh-hk.test.js\nindex 5b65c6cfc..f858c7218 100644\n--- a/test/locale/zh-hk.test.js\n+++ b/test/locale/zh-hk.test.js\n@@ -25,3 +25,13 @@ test('Meridiem', () => {\n     expect(zh.add(i, 'hour').format('A')).toBe(zhCN.add(i, 'hour').format('A'))\n   }\n })\n+\n+test('Meridiem', () => {\n+  expect(dayjs('2020-01-01 05:59:59').locale('zh-hk').format('A')).toEqual('\u51cc\u6668')\n+  expect(dayjs('2020-01-01 08:59:59').locale('zh-hk').format('A')).toEqual('\u65e9\u4e0a')\n+  expect(dayjs('2020-01-01 10:59:59').locale('zh-hk').format('A')).toEqual('\u4e0a\u5348')\n+  expect(dayjs('2020-01-01 11:00:00').locale('zh-hk').format('A')).toEqual('\u4e2d\u5348')\n+  expect(dayjs('2020-01-01 12:59:59').locale('zh-hk').format('A')).toEqual('\u4e2d\u5348')\n+  expect(dayjs('2020-01-01 13:00:00').locale('zh-hk').format('A')).toEqual('\u4e0b\u5348')\n+})\n+\ndiff --git a/test/plugin/negativeYear.test.js b/test/plugin/negativeYear.test.js\nindex a9713fa26..2b281b45d 100644\n--- a/test/plugin/negativeYear.test.js\n+++ b/test/plugin/negativeYear.test.js\n@@ -22,10 +22,12 @@ describe('negativeYear', () => {\n     const date = '-2021/01/03'\n     const date2 = '01/03/-2021'\n     const date3 = '01-03--2021'\n+    const date4 = '-03-15'\n     const d = date.match(REGEX_PARSE)\n     expect(dayjs(date).format('YYYY-MM-DD')).toBe('-2021-01-03')\n     expect(dayjs(date2).format('YYYY-MM-DD')).toBe('Invalid Date')\n     expect(dayjs(date3).format()).toBe('Invalid Date')\n+    expect(dayjs(date4).format('YYYY-MM-DD')).toBe('2001-03-15')\n     expect(d).toBe(null)\n   })\n \n",
    "problem_statement": "",
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/iamkun__dayjs.c8a26460/pr_mirror/iamkun__dayjs.c8a26460.2920/metadata__pr_2920.json"
  },
  {
    "instance_id": "dubinc__dub.main.3171",
    "repo": "dubinc/dub",
    "pull_number": 3171,
    "base_commit": "d126bfc73138f802e31d8f4a262cc32d683a3211",
    "patch": "diff --git a/apps/web/lib/middleware/utils/get-identity-hash.ts b/apps/web/lib/middleware/utils/get-identity-hash.ts\nindex 4ef076bd688..4609fff0fdf 100644\n--- a/apps/web/lib/middleware/utils/get-identity-hash.ts\n+++ b/apps/web/lib/middleware/utils/get-identity-hash.ts\n@@ -1,24 +1,11 @@\n import { LOCALHOST_IP, hashStringSHA256 } from \"@dub/utils\";\n import { ipAddress } from \"@vercel/functions\";\n import { userAgent } from \"next/server\";\n-import { DUB_TEST_IDENTITY_HEADER } from \"tests/utils/resource\";\n \n /**\n  * Combine IP + UA to create a unique identifier for the user (for deduplication)\n  */\n export async function getIdentityHash(req: Request) {\n-  // If provided, use this identity directly (for E2E)\n-  if (\n-    process.env.NODE_ENV === \"development\" ||\n-    process.env.VERCEL_ENV === \"preview\"\n-  ) {\n-    const testOverride = req.headers.get(DUB_TEST_IDENTITY_HEADER);\n-\n-    if (testOverride) {\n-      return await hashStringSHA256(testOverride);\n-    }\n-  }\n-\n   const ip = ipAddress(req) || LOCALHOST_IP;\n   const ua = userAgent(req);\n   return await hashStringSHA256(`${ip}-${ua.ua}`);\ndiff --git a/apps/web/tests/fraud/index.test.ts b/apps/web/tests/fraud/index.test.ts\nindex e788eec903e..53b5aa38d47 100644\n--- a/apps/web/tests/fraud/index.test.ts\n+++ b/apps/web/tests/fraud/index.test.ts\n@@ -1,9 +1,8 @@\n import { Customer, fraudEventGroupProps, TrackLeadResponse } from \"@/lib/types\";\n import { FraudRuleType } from \"@prisma/client\";\n-import { randomCustomer, randomId, retry } from \"tests/utils/helpers\";\n+import { randomCustomer, retry } from \"tests/utils/helpers\";\n import { HttpClient } from \"tests/utils/http\";\n import {\n-  DUB_TEST_IDENTITY_HEADER,\n   E2E_FRAUD_PARTNER,\n   E2E_FRAUD_REFERRAL_SOURCE_BANNED_DOMAIN,\n   E2E_TRACK_CLICK_HEADERS,\n@@ -16,14 +15,13 @@ describe.concurrent(\"/fraud/**\", async () => {\n   const { http } = await h.init();\n \n   test(\"FraudRuleType = customerEmailMatch\", async () => {\n-    const clickLink = E2E_FRAUD_PARTNER.link;\n+    const clickLink = E2E_FRAUD_PARTNER.links.customerEmailMatch;\n \n     // Track a click\n     const clickResponse = await http.post<{ clickId: string }>({\n       path: \"/track/click\",\n       headers: {\n         ...E2E_TRACK_CLICK_HEADERS,\n-        [DUB_TEST_IDENTITY_HEADER]: randomId(10),\n       },\n       body: {\n         domain: clickLink.domain,\n@@ -59,14 +57,13 @@ describe.concurrent(\"/fraud/**\", async () => {\n   });\n \n   test(\"FraudRuleType = customerEmailSuspiciousDomain\", async () => {\n-    const clickLink = E2E_FRAUD_PARTNER.link;\n+    const clickLink = E2E_FRAUD_PARTNER.links.customerEmailSuspiciousDomain;\n \n     // Track a click\n     const clickResponse = await http.post<{ clickId: string }>({\n       path: \"/track/click\",\n       headers: {\n         ...E2E_TRACK_CLICK_HEADERS,\n-        [DUB_TEST_IDENTITY_HEADER]: randomId(10),\n       },\n       body: {\n         domain: clickLink.domain,\n@@ -99,7 +96,7 @@ describe.concurrent(\"/fraud/**\", async () => {\n   });\n \n   test(\"FraudRuleType = referralSourceBanned\", async () => {\n-    const clickLink = E2E_FRAUD_PARTNER.link;\n+    const clickLink = E2E_FRAUD_PARTNER.links.referralSourceBanned;\n \n     // Track a click\n     const clickResponse = await http.post<{ clickId: string }>({\n@@ -107,7 +104,6 @@ describe.concurrent(\"/fraud/**\", async () => {\n       headers: {\n         ...E2E_TRACK_CLICK_HEADERS,\n         referer: `https://${E2E_FRAUD_REFERRAL_SOURCE_BANNED_DOMAIN}`,\n-        [DUB_TEST_IDENTITY_HEADER]: randomId(10),\n       },\n       body: {\n         domain: clickLink.domain,\n@@ -140,14 +136,13 @@ describe.concurrent(\"/fraud/**\", async () => {\n   });\n \n   test(\"FraudRuleType = paidTrafficDetected\", async () => {\n-    const clickLink = E2E_FRAUD_PARTNER.link;\n+    const clickLink = E2E_FRAUD_PARTNER.links.paidTrafficDetected;\n \n     // Track a click\n     const clickResponse = await http.post<{ clickId: string }>({\n       path: \"/track/click\",\n       headers: {\n         ...E2E_TRACK_CLICK_HEADERS,\n-        [DUB_TEST_IDENTITY_HEADER]: randomId(10),\n       },\n       body: {\n         domain: clickLink.domain,\ndiff --git a/apps/web/tests/utils/resource.ts b/apps/web/tests/utils/resource.ts\nindex d942699cb5e..94685c462e2 100644\n--- a/apps/web/tests/utils/resource.ts\n+++ b/apps/web/tests/utils/resource.ts\n@@ -8,16 +8,6 @@ export const E2E_LINK = {\n   url: \"https://github.com/dubinc\",\n };\n \n-/**\n- * Used exclusively in E2E tests to override the computed identity hash.\n- * When this header is present, `getIdentityHash()` will use its value\n- * as the hash input instead of relying on the real IP/User-Agent.\n- *\n- * This prevents deduplication during automated tests where multiple\n- * requests originate from the same IP and UA.\n- */\n-export const DUB_TEST_IDENTITY_HEADER = \"x-dub-test-identity\";\n-\n export const E2E_TRACK_CLICK_HEADERS = {\n   referer: \"https://dub.co\",\n   \"User-Agent\":\n@@ -220,9 +210,23 @@ export const E2E_CUSTOMERS = [\n export const E2E_FRAUD_PARTNER = {\n   id: \"pn_1K8ND11BZ4XPEX39QX3YMBGY0\",\n   email: \"kiran+e2e+1@dub.co\",\n-  link: {\n-    domain: \"getacme.link\",\n-    key: \"kiran-e2e-1\",\n+  links: {\n+    customerEmailMatch: {\n+      domain: \"getacme.link\",\n+      key: \"fraud-customer-match\",\n+    },\n+    customerEmailSuspiciousDomain: {\n+      domain: \"getacme.link\",\n+      key: \"fraud-customer-suspicious\",\n+    },\n+    referralSourceBanned: {\n+      domain: \"getacme.link\",\n+      key: \"fraud-referral-source-banned\",\n+    },\n+    paidTrafficDetected: {\n+      domain: \"getacme.link\",\n+      key: \"fraud-paid-traffic\",\n+    },\n   },\n } as const;\n \n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/dubinc__dub.main/pr_mirror/dubinc__dub.main.3171/metadata__pr_3171.json"
  },
  {
    "instance_id": "dubinc__dub.main.2975",
    "repo": "dubinc/dub",
    "pull_number": 2975,
    "base_commit": "46a8b5aa9328c75c02054b66ba5879c4e2e82345",
    "patch": "diff --git a/apps/web/tests/campaigns/index.test.ts b/apps/web/tests/campaigns/index.test.ts\nnew file mode 100644\nindex 00000000000..90cf7a77baf\n--- /dev/null\n+++ b/apps/web/tests/campaigns/index.test.ts\n@@ -0,0 +1,213 @@\n+import { Campaign, CampaignList } from \"@/lib/types\";\n+import { updateCampaignSchema } from \"@/lib/zod/schemas/campaigns\";\n+import { E2E_PARTNER_GROUP } from \"tests/utils/resource\";\n+import { describe, expect, onTestFinished, test } from \"vitest\";\n+import { z } from \"zod\";\n+import { IntegrationHarness } from \"../utils/integration\";\n+\n+const campaign: z.infer<typeof updateCampaignSchema> = {\n+  name: \"Updated Test Campaign\",\n+  subject: \"Updated Test Subject\",\n+  triggerCondition: {\n+    attribute: \"totalConversions\",\n+    operator: \"gte\",\n+    value: 50,\n+  },\n+  bodyJson: {\n+    type: \"doc\",\n+    content: [\n+      {\n+        type: \"paragraph\",\n+        content: [\n+          {\n+            type: \"text\",\n+            text: \"Test campaign body\",\n+          },\n+        ],\n+      },\n+    ],\n+  },\n+};\n+\n+const expectedCampaign: Partial<Campaign> = {\n+  ...campaign,\n+  type: \"transactional\",\n+  groups: [{ id: E2E_PARTNER_GROUP.id }],\n+  createdAt: expect.any(String),\n+  updatedAt: expect.any(String),\n+};\n+\n+describe.sequential(\"/campaigns/**\", async () => {\n+  const h = new IntegrationHarness();\n+  const { http } = await h.init();\n+\n+  let campaignId = \"\";\n+\n+  test(\"POST /campaigns - create draft campaign\", async () => {\n+    const { status, data } = await http.post<{ id: string }>({\n+      path: \"/campaigns\",\n+      body: {\n+        type: \"transactional\",\n+      },\n+    });\n+\n+    expect(status).toEqual(200);\n+    expect(data).toMatchObject({\n+      id: expect.any(String),\n+    });\n+\n+    campaignId = data.id;\n+  });\n+\n+  test(\"PATCH /campaigns/[campaignId] - update campaign content\", async () => {\n+    const { status, data: updatedCampaign } = await http.patch<Campaign>({\n+      path: `/campaigns/${campaignId}`,\n+      body: {\n+        ...campaign,\n+        groupIds: [E2E_PARTNER_GROUP.id],\n+      },\n+    });\n+\n+    expect(status).toEqual(200);\n+    expect(updatedCampaign).toStrictEqual({\n+      ...expectedCampaign,\n+      id: campaignId,\n+      status: \"draft\",\n+    });\n+  });\n+\n+  test(\"GET /campaigns/[campaignId] - make sure the draft campaign is created\", async () => {\n+    const { status, data: fetchedCampaign } = await http.get<Campaign>({\n+      path: `/campaigns/${campaignId}`,\n+    });\n+\n+    expect(status).toEqual(200);\n+    expect(fetchedCampaign).toStrictEqual({\n+      ...expectedCampaign,\n+      id: campaignId,\n+      status: \"draft\",\n+    });\n+  });\n+\n+  test(\"PATCH /campaigns/[campaignId] - publish campaign\", async () => {\n+    const { status, data: publishedCampaign } = await http.patch<Campaign>({\n+      path: `/campaigns/${campaignId}`,\n+      body: {\n+        status: \"active\",\n+      },\n+    });\n+\n+    expect(status).toEqual(200);\n+    expect(publishedCampaign).toStrictEqual({\n+      ...expectedCampaign,\n+      id: campaignId,\n+      status: \"active\",\n+    });\n+  });\n+\n+  test(\"PATCH /campaigns/[campaignId] - pause campaign\", async () => {\n+    const { status, data: pausedCampaign } = await http.patch<Campaign>({\n+      path: `/campaigns/${campaignId}`,\n+      body: {\n+        status: \"paused\",\n+      },\n+    });\n+\n+    expect(status).toEqual(200);\n+    expect(pausedCampaign).toStrictEqual({\n+      ...expectedCampaign,\n+      id: campaignId,\n+      status: \"paused\",\n+    });\n+  });\n+\n+  test(\"PATCH /campaigns/[campaignId] - resume campaign\", async () => {\n+    const { status, data: resumedCampaign } = await http.patch<Campaign>({\n+      path: `/campaigns/${campaignId}`,\n+      body: {\n+        status: \"active\",\n+      },\n+    });\n+\n+    expect(status).toEqual(200);\n+    expect(resumedCampaign).toStrictEqual({\n+      ...expectedCampaign,\n+      id: campaignId,\n+      status: \"active\",\n+    });\n+  });\n+\n+  test(\"POST /campaigns/[campaignId]/duplicate - duplicate campaign\", async () => {\n+    const { status, data } = await http.post<{ id: string }>({\n+      path: `/campaigns/${campaignId}/duplicate`,\n+    });\n+\n+    expect(status).toEqual(200);\n+    expect(data.id).toBeDefined();\n+\n+    onTestFinished(async () => {\n+      await h.deleteCampaign(data.id);\n+    });\n+\n+    const { data: duplicatedCampaign } = await http.get<Campaign>({\n+      path: `/campaigns/${data.id}`,\n+    });\n+\n+    expect(duplicatedCampaign).toStrictEqual({\n+      ...expectedCampaign,\n+      id: data.id,\n+      name: `${expectedCampaign.name} (copy)`,\n+      status: \"draft\",\n+    });\n+  });\n+\n+  test(\"GET /campaigns - list campaigns\", async () => {\n+    const { status, data: campaigns } = await http.get<CampaignList[]>({\n+      path: \"/campaigns\",\n+    });\n+\n+    expect(status).toEqual(200);\n+    expect(Array.isArray(campaigns)).toBe(true);\n+    expect(campaigns.length).toBeGreaterThan(0);\n+\n+    const campaign = campaigns.find((c) => c.id === campaignId);\n+\n+    expect(campaign).toStrictEqual({\n+      id: campaignId,\n+      name: expectedCampaign.name,\n+      type: expectedCampaign.type,\n+      status: \"active\",\n+      groups: [{ id: E2E_PARTNER_GROUP.id }],\n+      delivered: 0,\n+      sent: 0,\n+      bounced: 0,\n+      opened: 0,\n+      createdAt: expect.any(String),\n+      updatedAt: expect.any(String),\n+    });\n+  });\n+\n+  test(\"GET /campaigns/[campaignId] - get single campaign\", async () => {\n+    const { status, data: fetchedCampaign } = await http.get<Campaign>({\n+      path: `/campaigns/${campaignId}`,\n+    });\n+\n+    expect(status).toEqual(200);\n+    expect(fetchedCampaign).toStrictEqual({\n+      ...expectedCampaign,\n+      id: campaignId,\n+      status: \"active\",\n+    });\n+  });\n+\n+  test(\"DELETE /campaigns/[campaignId] - delete campaign\", async () => {\n+    const { status, data } = await http.delete<{ id: string }>({\n+      path: `/campaigns/${campaignId}`,\n+    });\n+\n+    expect(status).toEqual(200);\n+    expect(data).toStrictEqual({\n+      id: campaignId,\n+    });\n+  });\n+});\ndiff --git a/apps/web/tests/utils/integration.ts b/apps/web/tests/utils/integration.ts\nindex 934e2a7065d..d2a02cb8ff6 100644\n--- a/apps/web/tests/utils/integration.ts\n+++ b/apps/web/tests/utils/integration.ts\n@@ -106,4 +106,13 @@ export class IntegrationHarness {\n       path: `/bounties/${id}`,\n     });\n   }\n+\n+  // Delete campaign\n+  public async deleteCampaign(id: string) {\n+    if (!id) return;\n+\n+    await this.http.delete({\n+      path: `/campaigns/${id}`,\n+    });\n+  }\n }\n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/dubinc__dub.main/pr_mirror/dubinc__dub.main.2975/metadata__pr_2975.json"
  },
  {
    "instance_id": "dubinc__dub.main.3020",
    "repo": "dubinc/dub",
    "pull_number": 3020,
    "base_commit": "31d5d189c7760029408dbd5115b44fdcefd6bb0b",
    "patch": "diff --git a/apps/web/tests/rewards/lead-reward.test.ts b/apps/web/tests/rewards/lead-reward.test.ts\nnew file mode 100644\nindex 00000000000..990167233e9\n--- /dev/null\n+++ b/apps/web/tests/rewards/lead-reward.test.ts\n@@ -0,0 +1,91 @@\n+import { TrackLeadResponse } from \"@/lib/types\";\n+import { randomCustomer } from \"tests/utils/helpers\";\n+import {\n+  E2E_LEAD_REWARD,\n+  E2E_PARTNERS,\n+  E2E_TRACK_CLICK_HEADERS,\n+} from \"tests/utils/resource\";\n+import { verifyCommission } from \"tests/utils/verify-commission\";\n+import { describe, expect, test } from \"vitest\";\n+import { IntegrationHarness } from \"../utils/integration\";\n+\n+describe.concurrent(\"Lead rewards\", async () => {\n+  const h = new IntegrationHarness();\n+  const { http } = await h.init();\n+\n+  test(\"when {Partner} {Country} is {US}\", async () => {\n+    // Track the click\n+    const clickResponse = await http.post<{ clickId: string }>({\n+      path: \"/track/click\",\n+      headers: E2E_TRACK_CLICK_HEADERS,\n+      body: {\n+        ...E2E_PARTNERS[0].shortLink,\n+      },\n+    });\n+\n+    expect(clickResponse.status).toEqual(200);\n+\n+    const clickId = clickResponse.data.clickId;\n+    const customer = randomCustomer();\n+\n+    // Track the lead\n+    const trackLeadResponse = await http.post<TrackLeadResponse>({\n+      path: \"/track/lead\",\n+      body: {\n+        clickId,\n+        eventName: \"Signup\",\n+        customerExternalId: customer.externalId,\n+        customerName: customer.name,\n+        customerEmail: customer.email,\n+        customerAvatar: customer.avatar,\n+      },\n+    });\n+\n+    expect(trackLeadResponse.status).toEqual(200);\n+\n+    // Verify the commission\n+    await verifyCommission({\n+      http,\n+      customerExternalId: customer.externalId,\n+      expectedEarnings: E2E_LEAD_REWARD.modifiers[0].amountInCents,\n+    });\n+  });\n+\n+  test(\"when {Partner} {Country} is not {US}\", async () => {\n+    // Track the click\n+    const clickResponse = await http.post<{ clickId: string }>({\n+      path: \"/track/click\",\n+      headers: E2E_TRACK_CLICK_HEADERS,\n+      body: {\n+        ...E2E_PARTNERS[1].shortLink,\n+      },\n+    });\n+\n+    expect(clickResponse.status).toEqual(200);\n+\n+    const clickId = clickResponse.data.clickId;\n+    const customer = randomCustomer();\n+\n+    // Track the lead\n+    const trackLeadResponse = await http.post<TrackLeadResponse>({\n+      path: \"/track/lead\",\n+      body: {\n+        clickId,\n+        eventName: \"Signup\",\n+        customerExternalId: customer.externalId,\n+        customerName: customer.name,\n+        customerEmail: customer.email,\n+        customerAvatar: customer.avatar,\n+      },\n+    });\n+\n+    expect(trackLeadResponse.status).toEqual(200);\n+\n+    // Verify the commission\n+    await verifyCommission({\n+      http,\n+      customerExternalId: customer.externalId,\n+      expectedEarnings: E2E_LEAD_REWARD.amountInCents,\n+    });\n+  });\n+});\ndiff --git a/apps/web/tests/rewards/sale-reward.test.ts b/apps/web/tests/rewards/sale-reward.test.ts\nnew file mode 100644\nindex 00000000000..27bdf0ced11\n--- /dev/null\n+++ b/apps/web/tests/rewards/sale-reward.test.ts\n@@ -0,0 +1,65 @@\n+import { TrackSaleResponse } from \"@/lib/types\";\n+import { randomId } from \"tests/utils/helpers\";\n+import { E2E_CUSTOMERS, E2E_SALE_REWARD } from \"tests/utils/resource\";\n+import { verifyCommission } from \"tests/utils/verify-commission\";\n+import { describe, expect, test } from \"vitest\";\n+import { IntegrationHarness } from \"../utils/integration\";\n+\n+describe.concurrent(\"Sale rewards\", async () => {\n+  const h = new IntegrationHarness();\n+  const { http } = await h.init();\n+\n+  test(\"when {Customer} {Country} is {SG}\", async () => {\n+    const saleAmount = 10000; // $100 in cents\n+    const invoiceId = `INV_${randomId()}`;\n+\n+    // Track the sale\n+    const trackSaleResponse = await http.post<TrackSaleResponse>({\n+      path: \"/track/sale\",\n+      body: {\n+        customerExternalId: E2E_CUSTOMERS[0].externalId,\n+        eventName: \"Subscription\",\n+        amount: saleAmount,\n+        currency: \"usd\",\n+        invoiceId,\n+        paymentProcessor: \"stripe\",\n+      },\n+    });\n+\n+    expect(trackSaleResponse.status).toEqual(200);\n+\n+    // Verify the commission (10% of sale amount)\n+    await verifyCommission({\n+      http,\n+      invoiceId,\n+      expectedEarnings: saleAmount * 0.1,\n+    });\n+  });\n+\n+  test.skip(\"when {Customer} {Country} is {CA}\", async () => {\n+    const saleAmount = 10000; // $100 in cents\n+    const invoiceId = `INV_${randomId()}`;\n+\n+    // Track the sale\n+    const trackSaleResponse = await http.post<TrackSaleResponse>({\n+      path: \"/track/sale\",\n+      body: {\n+        customerExternalId: E2E_CUSTOMERS[1].externalId,\n+        eventName: \"Subscription\",\n+        amount: saleAmount,\n+        currency: \"usd\",\n+        invoiceId,\n+        paymentProcessor: \"stripe\",\n+      },\n+    });\n+\n+    expect(trackSaleResponse.status).toEqual(200);\n+\n+    // Verify the commission (base reward)\n+    await verifyCommission({\n+      http,\n+      invoiceId,\n+      expectedEarnings: E2E_SALE_REWARD.amountInCents,\n+    });\n+  });\n+});\ndiff --git a/apps/web/tests/tracks/track-lead.test.ts b/apps/web/tests/tracks/track-lead.test.ts\nindex 53921ac8512..a1e7a83c21d 100644\n--- a/apps/web/tests/tracks/track-lead.test.ts\n+++ b/apps/web/tests/tracks/track-lead.test.ts\n@@ -1,12 +1,6 @@\n-import {\n-  CommissionResponse,\n-  Customer,\n-  TrackLeadResponse,\n-  TrackSaleResponse,\n-} from \"@/lib/types\";\n+import { TrackLeadResponse, TrackSaleResponse } from \"@/lib/types\";\n import { randomCustomer } from \"tests/utils/helpers\";\n-import { HttpClient } from \"tests/utils/http\";\n-import { E2E_LEAD_REWARD, E2E_TRACK_CLICK_HEADERS } from \"tests/utils/resource\";\n+import { E2E_TRACK_CLICK_HEADERS } from \"tests/utils/resource\";\n import { describe, expect, test } from \"vitest\";\n import { IntegrationHarness } from \"../utils/integration\";\n \n@@ -30,39 +24,6 @@ const expectValidLeadResponse = ({\n   });\n };\n \n-const verifyCommission = async ({\n-  http,\n-  customerExternalId,\n-  expectedEarnings,\n-}: {\n-  http: HttpClient;\n-  customerExternalId: string;\n-  expectedEarnings: number;\n-}) => {\n-  // Find the customer first\n-  const { data: customers } = await http.get<Customer[]>({\n-    path: \"/customers\",\n-    query: {\n-      externalId: customerExternalId,\n-    },\n-  });\n-\n-  const customer = customers[0];\n-\n-  // Find the commission for the customer\n-  const { status, data: commissions } = await http.get<CommissionResponse[]>({\n-    path: \"/commissions\",\n-    query: {\n-      customerId: customer.id,\n-    },\n-  });\n-\n-  expect(status).toEqual(200);\n-  expect(commissions).toHaveLength(1);\n-  expect(commissions[0].customer?.id).toEqual(customer.id);\n-  expect(commissions[0].earnings).toEqual(expectedEarnings);\n-};\n-\n describe(\"POST /track/lead\", async () => {\n   const h = new IntegrationHarness();\n   const { http } = await h.init();\n@@ -254,44 +215,4 @@ describe(\"POST /track/lead\", async () => {\n       clickId: trackedClickId,\n     });\n   });\n-\n-  test(\"track a lead and verify the reward based on the partner.country (US)\", async () => {\n-    const clickResponse = await http.post<{ clickId: string }>({\n-      path: \"/track/click\",\n-      headers: E2E_TRACK_CLICK_HEADERS,\n-      body: {\n-        domain: \"getacme.link\",\n-        key: \"marvin\",\n-      },\n-    });\n-\n-    const trackedClickId = clickResponse.data.clickId;\n-    const customer = randomCustomer();\n-\n-    const response = await http.post<TrackLeadResponse>({\n-      path: \"/track/lead\",\n-      body: {\n-        clickId: trackedClickId,\n-        customerId: customer.externalId,\n-        eventName: \"Signup\",\n-        customerName: customer.name,\n-        customerEmail: customer.email,\n-        customerAvatar: customer.avatar,\n-      },\n-    });\n-\n-    expectValidLeadResponse({\n-      response,\n-      customer: customer,\n-      clickId: trackedClickId,\n-    });\n-\n-    await new Promise((resolve) => setTimeout(resolve, 2000));\n-\n-    await verifyCommission({\n-      http,\n-      customerExternalId: customer.externalId,\n-      expectedEarnings: E2E_LEAD_REWARD.modifiers[0].amountInCents,\n-    });\n-  });\n });\ndiff --git a/apps/web/tests/tracks/track-sale.test.ts b/apps/web/tests/tracks/track-sale.test.ts\nindex 562036082ff..2acbb45e1e5 100644\n--- a/apps/web/tests/tracks/track-sale.test.ts\n+++ b/apps/web/tests/tracks/track-sale.test.ts\n@@ -11,6 +11,7 @@ import {\n   E2E_SALE_REWARD,\n   E2E_TRACK_CLICK_HEADERS,\n } from \"tests/utils/resource\";\n+import { verifyCommission } from \"tests/utils/verify-commission\";\n import { describe, expect, test } from \"vitest\";\n import { IntegrationHarness } from \"../utils/integration\";\n \n@@ -38,25 +39,6 @@ const expectValidSaleResponse = (\n   });\n };\n \n-// Helper function to verify commission details\n-const verifyCommission = async (\n-  http: any,\n-  invoiceId: string,\n-  expectedAmount: number,\n-  expectedEarnings: number,\n-) => {\n-  const { status, data: commissions } = await http.get({\n-    path: \"/commissions\",\n-    query: { invoiceId },\n-  });\n-\n-  expect(status).toEqual(200);\n-  expect(commissions).toHaveLength(1);\n-  expect(commissions[0].invoiceId).toEqual(invoiceId);\n-  expect(commissions[0].amount).toEqual(expectedAmount);\n-  expect(commissions[0].earnings).toEqual(expectedEarnings);\n-};\n-\n describe(\"POST /track/sale\", async () => {\n   const h = new IntegrationHarness();\n   const { http } = await h.init();\n@@ -129,19 +111,19 @@ describe(\"POST /track/sale\", async () => {\n     // pause for 2 seconds for data to be fully processed\n     await new Promise((resolve) => setTimeout(resolve, 2000));\n \n-    // Verify commissions\n-    await verifyCommission(\n+    await verifyCommission({\n       http,\n-      regularInvoiceId,\n-      response1.data.sale?.amount!,\n-      E2E_SALE_REWARD.amountInCents,\n-    );\n-    await verifyCommission(\n+      invoiceId: regularInvoiceId,\n+      expectedAmount: response1.data.sale?.amount!,\n+      expectedEarnings: E2E_SALE_REWARD.amountInCents,\n+    });\n+\n+    await verifyCommission({\n       http,\n-      premiumInvoiceId,\n-      response2.data.sale?.amount!,\n-      E2E_SALE_REWARD.modifiers[0].amountInCents,\n-    );\n+      invoiceId: premiumInvoiceId,\n+      expectedAmount: response2.data.sale?.amount!,\n+      expectedEarnings: E2E_SALE_REWARD.modifiers[0].amountInCents!,\n+    });\n   });\n \n   test(\"track a sale with an externalId that does not exist (should return null customer and sale)\", async () => {\n@@ -311,18 +293,18 @@ describe(\"POST /track/sale\", async () => {\n     // Pause for 2 seconds for data to be fully processed\n     await new Promise((resolve) => setTimeout(resolve, 2000));\n \n-    await verifyCommission(\n+    await verifyCommission({\n       http,\n-      smallSaleInvoiceId,\n-      response1.data.sale?.amount!,\n-      E2E_SALE_REWARD.amountInCents,\n-    );\n+      invoiceId: smallSaleInvoiceId,\n+      expectedAmount: response1.data.sale?.amount!,\n+      expectedEarnings: E2E_SALE_REWARD.amountInCents,\n+    });\n \n-    await verifyCommission(\n+    await verifyCommission({\n       http,\n-      largeSaleInvoiceId,\n-      response2.data.sale?.amount!,\n-      E2E_SALE_REWARD.modifiers[1].amountInCents,\n-    );\n+      invoiceId: largeSaleInvoiceId,\n+      expectedAmount: response2.data.sale?.amount!,\n+      expectedEarnings: E2E_SALE_REWARD.modifiers[1].amountInCents!,\n+    });\n   });\n });\ndiff --git a/apps/web/tests/utils/resource.ts b/apps/web/tests/utils/resource.ts\nindex 67221a21284..6aefc236eb2 100644\n--- a/apps/web/tests/utils/resource.ts\n+++ b/apps/web/tests/utils/resource.ts\n@@ -45,42 +45,72 @@ export const E2E_SALE_REWARD = {\n   amountInCents: 1000,\n   modifiers: [\n     {\n-      operator: \"AND\",\n       type: \"flat\",\n-      amountInCents: 3000,\n+      operator: \"AND\",\n       conditions: [\n         {\n+          value: \"premiumProductId\",\n           entity: \"sale\",\n-          attribute: \"productId\",\n           operator: \"equals_to\",\n-          value: \"premiumProductId\",\n+          attribute: \"productId\",\n         },\n       ],\n+      maxDuration: null,\n+      amountInCents: 3000,\n     },\n     {\n-      operator: \"AND\",\n       type: \"flat\",\n-      amountInCents: 5000,\n+      operator: \"AND\",\n       conditions: [\n         {\n+          value: 15000,\n           entity: \"sale\",\n-          attribute: \"amount\",\n           operator: \"greater_than\",\n-          value: 15000,\n+          attribute: \"amount\",\n+        },\n+      ],\n+      maxDuration: null,\n+      amountInCents: 5000,\n+    },\n+    {\n+      type: \"percentage\",\n+      operator: \"AND\",\n+      conditions: [\n+        {\n+          value: \"US\",\n+          entity: \"customer\",\n+          operator: \"equals_to\",\n+          attribute: \"country\",\n+        },\n+      ],\n+      maxDuration: null,\n+      amountInPercentage: 10,\n+    },\n+    {\n+      type: \"flat\",\n+      operator: \"AND\",\n+      conditions: [\n+        {\n+          value: \"CA\",\n+          entity: \"customer\",\n+          operator: \"equals_to\",\n+          attribute: \"country\",\n         },\n       ],\n+      maxDuration: null,\n+      amountInCents: 50,\n     },\n   ],\n };\n+\n export const E2E_LEAD_REWARD = {\n   id: \"rw_1K82ESAT4YPY0STR20GKXZ7DR\",\n   event: \"lead\",\n   type: \"flat\",\n-  amountInCents: 1000,\n+  amountInCents: 100,\n   modifiers: [\n     {\n       type: \"flat\",\n-      amountInCents: 200,\n       operator: \"AND\",\n       conditions: [\n         {\n@@ -91,6 +121,21 @@ export const E2E_LEAD_REWARD = {\n         },\n       ],\n       maxDuration: null,\n+      amountInCents: 200,\n+    },\n+    {\n+      type: \"flat\",\n+      operator: \"AND\",\n+      conditions: [\n+        {\n+          value: \"US\",\n+          entity: \"customer\",\n+          operator: \"equals_to\",\n+          attribute: \"country\",\n+        },\n+      ],\n+      maxDuration: null,\n+      amountInCents: 400,\n     },\n   ],\n };\n@@ -128,3 +173,35 @@ export const E2E_PARTNER_GROUP = {\n   id: \"grp_1K2E25381GVMG7HHM057TB92F\",\n   url: \"https://acme.dub.sh/\",\n };\n+\n+export const E2E_PARTNERS = [\n+  {\n+    id: \"pn_NNG3YjwhLhA7nCZSaXeLIsWu\",\n+    country: \"US\",\n+    shortLink: {\n+      domain: \"getacme.link\",\n+      key: \"marvin\",\n+    },\n+  },\n+  {\n+    id: \"pn_1K8ND11BZ4XPEX39QX3YMBGY0\",\n+    country: \"SG\",\n+    shortLink: {\n+      domain: \"getacme.link\",\n+      key: \"kiran-e2e-1\",\n+    },\n+  },\n+] as const;\n+\n+export const E2E_CUSTOMERS = [\n+  {\n+    id: \"cus_1K82FYFF7RANMCGRHRGMWDNEC\",\n+    externalId: \"cus_LnZbkb8boLsOn1YGLPxZGZMU\",\n+    country: \"SG\",\n+  },\n+  {\n+    id: \"cus_1K86CG1DZFW8EMSSWXX4AVZFA\",\n+    externalId: \"cus_vq3UgXINHS99MIon8vNvAO1n\",\n+    country: \"CA\",\n+  },\n+] as const;\ndiff --git a/apps/web/tests/utils/verify-commission.ts b/apps/web/tests/utils/verify-commission.ts\nnew file mode 100644\nindex 00000000000..94e9b5304ff\n--- /dev/null\n+++ b/apps/web/tests/utils/verify-commission.ts\n@@ -0,0 +1,69 @@\n+import { CommissionResponse, Customer } from \"@/lib/types\";\n+import { expect } from \"vitest\";\n+import { HttpClient } from \"./http\";\n+\n+interface VerifyCommissionProps {\n+  http: HttpClient;\n+  customerExternalId?: string;\n+  invoiceId?: string;\n+  expectedAmount?: number;\n+  expectedEarnings: number;\n+}\n+\n+export const verifyCommission = async ({\n+  http,\n+  customerExternalId,\n+  invoiceId,\n+  expectedAmount,\n+  expectedEarnings,\n+}: VerifyCommissionProps) => {\n+  let customerId: string | undefined;\n+\n+  // Optional: resolve customer ID if customerExternalId is given\n+  if (customerExternalId) {\n+    const { data: customers } = await http.get<Customer[]>({\n+      path: \"/customers\",\n+      query: { externalId: customerExternalId },\n+    });\n+\n+    expect(customers.length).toBeGreaterThan(0);\n+    customerId = customers[0].id;\n+\n+    // Small delay if necessary for async commission processing\n+    await new Promise((resolve) => setTimeout(resolve, 2000));\n+  }\n+\n+  const query: Record<string, string> = {};\n+\n+  if (invoiceId) {\n+    query.invoiceId = invoiceId;\n+  }\n+\n+  if (customerId) {\n+    query.customerId = customerId;\n+  }\n+\n+  const { status, data: commissions } = await http.get<CommissionResponse[]>({\n+    path: \"/commissions\",\n+    query,\n+  });\n+\n+  expect(status).toEqual(200);\n+  expect(commissions).toHaveLength(1);\n+\n+  const commission = commissions[0];\n+\n+  if (invoiceId) {\n+    expect(commission.invoiceId).toEqual(invoiceId);\n+  }\n+\n+  if (customerId) {\n+    expect(commission.customer?.id).toEqual(customerId);\n+  }\n+\n+  if (expectedAmount !== undefined) {\n+    expect(commission.amount).toEqual(expectedAmount);\n+  }\n+\n+  expect(commission.earnings).toEqual(expectedEarnings);\n+};\n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/dubinc__dub.main/pr_mirror/dubinc__dub.main.3020/metadata__pr_3020.json"
  },
  {
    "instance_id": "dubinc__dub.main.3027",
    "repo": "dubinc/dub",
    "pull_number": 3027,
    "base_commit": "5d86b60093e63dc01ab8ba41a7d06bd46c92cfba",
    "patch": "diff --git a/apps/web/tests/rewards/lead-reward.test.ts b/apps/web/tests/rewards/lead-reward.test.ts\nindex 990167233e9..95456359ec5 100644\n--- a/apps/web/tests/rewards/lead-reward.test.ts\n+++ b/apps/web/tests/rewards/lead-reward.test.ts\n@@ -13,7 +13,7 @@ describe.concurrent(\"Lead rewards\", async () => {\n   const h = new IntegrationHarness();\n   const { http } = await h.init();\n \n-  test(\"when {Partner} {Country} is {US}\", async () => {\n+  test(\"when customer country is US and partner country is US\", async () => {\n     // Track the click\n     const clickResponse = await http.post<{ clickId: string }>({\n       path: \"/track/click\",\n@@ -47,11 +47,11 @@ describe.concurrent(\"Lead rewards\", async () => {\n     await verifyCommission({\n       http,\n       customerExternalId: customer.externalId,\n-      expectedEarnings: E2E_LEAD_REWARD.modifiers[0].amountInCents,\n+      expectedEarnings: E2E_LEAD_REWARD.modifiers[1].amountInCents,\n     });\n   });\n \n-  test(\"when {Partner} {Country} is not {US}\", async () => {\n+  test(\"when customer country is US and partner country is not US\", async () => {\n     // Track the click\n     const clickResponse = await http.post<{ clickId: string }>({\n       path: \"/track/click\",\n@@ -85,7 +85,7 @@ describe.concurrent(\"Lead rewards\", async () => {\n     await verifyCommission({\n       http,\n       customerExternalId: customer.externalId,\n-      expectedEarnings: E2E_LEAD_REWARD.amountInCents,\n+      expectedEarnings: E2E_LEAD_REWARD.modifiers[0].amountInCents,\n     });\n   });\n });\ndiff --git a/apps/web/tests/utils/resource.ts b/apps/web/tests/utils/resource.ts\nindex 6aefc236eb2..2114f8b2454 100644\n--- a/apps/web/tests/utils/resource.ts\n+++ b/apps/web/tests/utils/resource.ts\n@@ -115,7 +115,7 @@ export const E2E_LEAD_REWARD = {\n       conditions: [\n         {\n           value: \"US\",\n-          entity: \"partner\",\n+          entity: \"customer\",\n           operator: \"equals_to\",\n           attribute: \"country\",\n         },\n@@ -129,13 +129,13 @@ export const E2E_LEAD_REWARD = {\n       conditions: [\n         {\n           value: \"US\",\n-          entity: \"customer\",\n+          entity: \"partner\",\n           operator: \"equals_to\",\n           attribute: \"country\",\n         },\n       ],\n-      maxDuration: null,\n-      amountInCents: 400,\n+      maxDuration: 0,\n+      amountInCents: 300,\n     },\n   ],\n };\n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/dubinc__dub.main/pr_mirror/dubinc__dub.main.3027/metadata__pr_3027.json"
  },
  {
    "instance_id": "dubinc__dub.main.3036",
    "repo": "dubinc/dub",
    "pull_number": 3036,
    "base_commit": "6784533571d3339f600df223f9c3981d71a6b9a2",
    "patch": "diff --git a/apps/web/lib/types.ts b/apps/web/lib/types.ts\nindex e49bf22c85a..93e1b0674fe 100644\n--- a/apps/web/lib/types.ts\n+++ b/apps/web/lib/types.ts\n@@ -442,7 +442,6 @@ export type PartnerProps = z.infer<typeof PartnerSchema> & {\n };\n \n export type PartnerUserProps = z.infer<typeof partnerUserSchema>;\n-\n export type PartnerProfileCustomerProps = z.infer<\n   typeof PartnerProfileCustomerSchema\n >;\n@@ -480,7 +479,6 @@ export type ProgramApplicationFormDataWithValues = z.infer<\n export type ProgramApplicationFormFieldWithValues = z.infer<\n   typeof programApplicationFormFieldWithValuesSchema\n >;\n-\n export type ProgramEnrollmentProps = z.infer<typeof ProgramEnrollmentSchema>;\n \n export type PayoutsCount = {\ndiff --git a/apps/web/tests/partner-groups/index.test.ts b/apps/web/tests/partner-groups/index.test.ts\nnew file mode 100644\nindex 00000000000..42c4770621c\n--- /dev/null\n+++ b/apps/web/tests/partner-groups/index.test.ts\n@@ -0,0 +1,162 @@\n+import { generateRandomName } from \"@/lib/names\";\n+import {\n+  GroupExtendedProps,\n+  GroupProps,\n+  GroupWithProgramProps,\n+} from \"@/lib/types\";\n+import { GroupSchema } from \"@/lib/zod/schemas/groups\";\n+import { RESOURCE_COLORS } from \"@/ui/colors\";\n+import { randomValue } from \"@dub/utils\";\n+import slugify from \"@sindresorhus/slugify\";\n+import { describe, expect, test } from \"vitest\";\n+import { IntegrationHarness } from \"../utils/integration\";\n+\n+const expectedGroup: Partial<GroupProps> = {\n+  id: expect.any(String),\n+  name: expect.any(String),\n+  slug: expect.any(String),\n+  color: expect.any(String),\n+  clickReward: null,\n+  leadReward: null,\n+  saleReward: null,\n+  discount: null,\n+  maxPartnerLinks: 10,\n+  linkStructure: \"short\",\n+  additionalLinks: expect.any(Array),\n+};\n+\n+describe.sequential(\"/groups/**\", async () => {\n+  const h = new IntegrationHarness();\n+  const { http } = await h.init();\n+\n+  let group: GroupProps;\n+\n+  test(\"POST /groups - create group\", async () => {\n+    const groupName = generateRandomName();\n+\n+    const newGroup = {\n+      name: `E2E-${groupName}`,\n+      slug: slugify(groupName),\n+      color: randomValue(RESOURCE_COLORS),\n+    };\n+\n+    const { status, data } = await http.post<GroupProps>({\n+      path: \"/groups\",\n+      body: newGroup,\n+    });\n+\n+    expect(status).toEqual(201);\n+    expect(() => GroupSchema.parse(data)).not.toThrow();\n+    expect(data).toStrictEqual({\n+      ...expectedGroup,\n+      ...newGroup,\n+    });\n+\n+    group = data;\n+  });\n+\n+  test(\"GET /groups/[groupId] - fetch single group\", async () => {\n+    const { status, data } = await http.get<GroupWithProgramProps>({\n+      path: `/groups/${group.id}`,\n+    });\n+\n+    const {\n+      applicationFormData,\n+      applicationFormPublishedAt,\n+      landerData,\n+      landerPublishedAt,\n+      program,\n+      ...fetchedGroup\n+    } = data;\n+\n+    expect(status).toEqual(200);\n+    expect(fetchedGroup).toStrictEqual({\n+      ...group,\n+      utmTemplate: null,\n+    });\n+  });\n+\n+  test(\"PATCH /groups/[groupId] - update group\", async () => {\n+    const toUpdate = {\n+      name: `E2E-${generateRandomName()}`,\n+      color: randomValue(RESOURCE_COLORS),\n+      maxPartnerLinks: 5,\n+      linkStructure: \"query\",\n+      additionalLinks: [\n+        {\n+          domain: \"example.com\",\n+          path: \"\",\n+          validationMode: \"domain\",\n+        },\n+        {\n+          domain: \"acme.com\",\n+          path: \"/products\",\n+          validationMode: \"exact\",\n+        },\n+      ],\n+    };\n+\n+    const { status, data: updatedGroup } = await http.patch<GroupProps>({\n+      path: `/groups/${group.id}`,\n+      body: toUpdate,\n+    });\n+\n+    expect(status).toEqual(200);\n+    expect(updatedGroup).toStrictEqual({\n+      ...group,\n+      ...toUpdate,\n+    });\n+\n+    group = updatedGroup;\n+  });\n+\n+  test(\"GET /groups - fetch all groups\", async () => {\n+    const { status, data: groups } = await http.get<GroupExtendedProps[]>({\n+      path: \"/groups\",\n+    });\n+\n+    expect(status).toEqual(200);\n+    expect(Array.isArray(groups)).toBe(true);\n+    expect(groups.length).toBeGreaterThan(0);\n+\n+    const fetchedGroup = groups.find((g) => g.id === group.id);\n+\n+    expect(fetchedGroup).toStrictEqual({\n+      id: group.id,\n+      name: group.name,\n+      slug: group.slug,\n+      color: group.color,\n+      additionalLinks: group.additionalLinks,\n+      maxPartnerLinks: group.maxPartnerLinks,\n+      linkStructure: group.linkStructure,\n+      totalPartners: 0,\n+      totalClicks: 0,\n+      totalLeads: 0,\n+      totalSales: 0,\n+      totalSaleAmount: 0,\n+      totalConversions: 0,\n+      totalCommissions: 0,\n+      netRevenue: 0,\n+    });\n+  });\n+\n+  test(\"DELETE /groups/[groupId] - delete group\", async () => {\n+    const { status, data } = await http.delete<{ id: string }>({\n+      path: `/groups/${group.id}`,\n+    });\n+\n+    expect(status).toEqual(200);\n+    expect(data).toStrictEqual({\n+      id: group.id,\n+    });\n+\n+    const { status: getStatus } = await http.get({\n+      path: `/groups/${group.id}`,\n+    });\n+\n+    expect(getStatus).toEqual(404);\n+  });\n+});\n+\n+// TODO(kiran):\n+// Add more test cases to test the default link creation and group move\ndiff --git a/apps/web/ui/modals/delete-group-modal.tsx b/apps/web/ui/modals/delete-group-modal.tsx\nindex f86ce304765..253b7c36e4d 100644\n--- a/apps/web/ui/modals/delete-group-modal.tsx\n+++ b/apps/web/ui/modals/delete-group-modal.tsx\n@@ -98,7 +98,7 @@ const DeleteGroupModal = ({\n                 <p className=\"block text-sm text-neutral-500\">\n                   To verify, type{\" \"}\n                   <span className=\"font-medium text-neutral-700\">\n-                    Delete group\n+                    confirm delete group\n                   </span>{\" \"}\n                   below\n                 </p>\n@@ -113,7 +113,7 @@ const DeleteGroupModal = ({\n                     className=\"block w-full rounded-md border-neutral-300 text-neutral-900 placeholder-neutral-400 focus:border-neutral-500 focus:outline-none focus:ring-neutral-500 sm:text-sm\"\n                     aria-invalid=\"true\"\n                     autoFocus={!isMobile}\n-                    pattern=\"Delete group\"\n+                    pattern=\"confirm delete group\"\n                   />\n                 </div>\n               </div>\n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/dubinc__dub.main/pr_mirror/dubinc__dub.main.3036/metadata__pr_3036.json"
  },
  {
    "instance_id": "dubinc__dub.main.3166",
    "repo": "dubinc/dub",
    "pull_number": 3166,
    "base_commit": "beac3b75f8feb4b1a78fd33801c5544adbfaaad9",
    "patch": "diff --git a/apps/web/app/(ee)/api/stripe/connect/webhook/account-updated.ts b/apps/web/app/(ee)/api/stripe/connect/webhook/account-updated.ts\nindex dc63bac2cde..dc9e139f5ba 100644\n--- a/apps/web/app/(ee)/api/stripe/connect/webhook/account-updated.ts\n+++ b/apps/web/app/(ee)/api/stripe/connect/webhook/account-updated.ts\n@@ -1,9 +1,14 @@\n import { createFraudEvents } from \"@/lib/api/fraud/create-fraud-events\";\n+import { qstash } from \"@/lib/cron\";\n import { stripe } from \"@/lib/stripe\";\n import { prisma } from \"@dub/prisma\";\n-import { log } from \"@dub/utils\";\n+import { APP_DOMAIN_WITH_NGROK, log } from \"@dub/utils\";\n import Stripe from \"stripe\";\n \n+const queue = qstash.queue({\n+  queueName: \"withdraw-stripe-balance\",\n+});\n+\n export async function accountUpdated(event: Stripe.Event) {\n   const account = event.data.object as Stripe.Account;\n \n@@ -110,5 +115,26 @@ export async function accountUpdated(event: Stripe.Event) {\n     }\n   }\n \n+  // Retry payouts that got stuck when the account was restricted (e.g: payout sent but paused\n+  // due to verification requirements). Once payouts are re-enabled, queue them for processing.\n+  const pendingPayouts = await prisma.payout.count({\n+    where: {\n+      partnerId: partner.id,\n+      status: \"sent\",\n+      mode: \"internal\",\n+    },\n+  });\n+\n+  if (pendingPayouts > 0) {\n+    await queue.enqueueJSON({\n+      url: `${APP_DOMAIN_WITH_NGROK}/api/cron/payouts/balance-available`,\n+      deduplicationId: event.id,\n+      method: \"POST\",\n+      body: {\n+        stripeAccount: partner.stripeConnectId,\n+      },\n+    });\n+  }\n+\n   return `Updated partner ${partner.email} (${partner.stripeConnectId}) with country ${country}, payoutsEnabledAt set, payoutMethodHash ${defaultExternalAccount.fingerprint}`;\n }\ndiff --git a/apps/web/tests/fraud/index.test.ts b/apps/web/tests/fraud/index.test.ts\nindex 27354a54165..e788eec903e 100644\n--- a/apps/web/tests/fraud/index.test.ts\n+++ b/apps/web/tests/fraud/index.test.ts\n@@ -254,6 +254,6 @@ async function waitForFraudEvent({\n \n       return data[0];\n     },\n-    { retries: 10, interval: 300 },\n+    { retries: 10, interval: 600 },\n   );\n }\n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/dubinc__dub.main/pr_mirror/dubinc__dub.main.3166/metadata__pr_3166.json"
  },
  {
    "instance_id": "dubinc__dub.main.3157",
    "repo": "dubinc/dub",
    "pull_number": 3157,
    "base_commit": "63b1aa50622b3ebb8d0e25f8e808a3617ac8ecef",
    "patch": "diff --git a/apps/web/app/(ee)/api/customers/[id]/route.ts b/apps/web/app/(ee)/api/customers/[id]/route.ts\nindex c071e34e861..6e15be6f9c6 100644\n--- a/apps/web/app/(ee)/api/customers/[id]/route.ts\n+++ b/apps/web/app/(ee)/api/customers/[id]/route.ts\n@@ -96,21 +96,30 @@ export const PATCH = withWorkspace(\n \n       if (avatar && !isStored(avatar) && finalCustomerAvatar) {\n         waitUntil(\n-          Promise.allSettled([\n-            storage.upload({\n+          storage\n+            .upload({\n               key: finalCustomerAvatar.replace(`${R2_URL}/`, \"\"),\n               body: avatar,\n               opts: {\n                 width: 128,\n                 height: 128,\n               },\n+            })\n+            .then(() => {\n+              if (oldCustomerAvatar && isStored(oldCustomerAvatar)) {\n+                storage.delete({\n+                  key: oldCustomerAvatar.replace(`${R2_URL}/`, \"\"),\n+                });\n+              }\n+            })\n+            .catch(async (error) => {\n+              console.error(\"Error persisting customer avatar to R2\", error);\n+              // if the avatar fails to upload to R2, set the avatar to null in the database\n+              await prisma.customer.update({\n+                where: { id: customer.id },\n+                data: { avatar: null },\n+              });\n             }),\n-            oldCustomerAvatar &&\n-              isStored(oldCustomerAvatar) &&\n-              storage.delete({\n-                key: oldCustomerAvatar.replace(`${R2_URL}/`, \"\"),\n-              }),\n-          ]),\n         );\n       }\n \ndiff --git a/apps/web/app/(ee)/api/customers/route.ts b/apps/web/app/(ee)/api/customers/route.ts\nindex e8583bd759a..ecdeb52892c 100644\n--- a/apps/web/app/(ee)/api/customers/route.ts\n+++ b/apps/web/app/(ee)/api/customers/route.ts\n@@ -165,14 +165,27 @@ export const POST = withWorkspace(\n \n       if (avatar && !isStored(avatar) && finalCustomerAvatar) {\n         waitUntil(\n-          storage.upload({\n-            key: finalCustomerAvatar.replace(`${R2_URL}/`, \"\"),\n-            body: avatar,\n-            opts: {\n-              width: 128,\n-              height: 128,\n-            },\n-          }),\n+          storage\n+            .upload({\n+              key: finalCustomerAvatar.replace(`${R2_URL}/`, \"\"),\n+              body: avatar,\n+              opts: {\n+                width: 128,\n+                height: 128,\n+              },\n+            })\n+            .catch(async (error) => {\n+              console.error(\"Error persisting customer avatar to R2\", error);\n+              // if the avatar fails to upload to R2, set the avatar to null in the database\n+              await prisma.customer.update({\n+                where: {\n+                  id: customer.id,\n+                },\n+                data: {\n+                  avatar: null,\n+                },\n+              });\n+            }),\n         );\n       }\n \ndiff --git a/apps/web/lib/api/conversions/track-lead.ts b/apps/web/lib/api/conversions/track-lead.ts\nindex efe241234de..f940dafe4e4 100644\n--- a/apps/web/lib/api/conversions/track-lead.ts\n+++ b/apps/web/lib/api/conversions/track-lead.ts\n@@ -238,14 +238,25 @@ export const trackLead = async ({\n           finalCustomerAvatar\n         ) {\n           // persist customer avatar to R2\n-          await storage.upload({\n-            key: finalCustomerAvatar.replace(`${R2_URL}/`, \"\"),\n-            body: customerAvatar,\n-            opts: {\n-              width: 128,\n-              height: 128,\n-            },\n-          });\n+          await storage\n+            .upload({\n+              key: finalCustomerAvatar.replace(`${R2_URL}/`, \"\"),\n+              body: customerAvatar,\n+              opts: {\n+                width: 128,\n+                height: 128,\n+              },\n+            })\n+            .catch(async (error) => {\n+              console.error(\"Error persisting customer avatar to R2\", error);\n+              // if the avatar fails to upload to R2, set the avatar to null in the database\n+              if (customer) {\n+                await prisma.customer.update({\n+                  where: { id: customer.id },\n+                  data: { avatar: null },\n+                });\n+              }\n+            });\n         }\n \n         // if not deferred mode, process the following right away:\ndiff --git a/apps/web/lib/api/conversions/track-sale.ts b/apps/web/lib/api/conversions/track-sale.ts\nindex 87bc7613326..a6edaa83b05 100644\n--- a/apps/web/lib/api/conversions/track-sale.ts\n+++ b/apps/web/lib/api/conversions/track-sale.ts\n@@ -214,14 +214,25 @@ export const trackSale = async ({\n     if (customerAvatar && !isStored(customerAvatar) && finalCustomerAvatar) {\n       // persist customer avatar to R2 if it's not already stored\n       waitUntil(\n-        storage.upload({\n-          key: finalCustomerAvatar.replace(`${R2_URL}/`, \"\"),\n-          body: customerAvatar,\n-          opts: {\n-            width: 128,\n-            height: 128,\n-          },\n-        }),\n+        storage\n+          .upload({\n+            key: finalCustomerAvatar.replace(`${R2_URL}/`, \"\"),\n+            body: customerAvatar,\n+            opts: {\n+              width: 128,\n+              height: 128,\n+            },\n+          })\n+          .catch(async (error) => {\n+            console.error(\"Error persisting customer avatar to R2\", error);\n+            // if the avatar fails to upload to R2, set the avatar to null in the database\n+            if (newCustomer) {\n+              await prisma.customer.update({\n+                where: { id: newCustomer.id },\n+                data: { avatar: null },\n+              });\n+            }\n+          }),\n       );\n     }\n \ndiff --git a/apps/web/lib/openapi/customers/create-customer.ts b/apps/web/lib/openapi/customers/create-customer.ts\ndeleted file mode 100644\nindex d80e6f70abf..00000000000\n--- a/apps/web/lib/openapi/customers/create-customer.ts\n+++ /dev/null\n@@ -1,35 +0,0 @@\n-import { openApiErrorResponses } from \"@/lib/openapi/responses\";\n-import { ZodOpenApiOperationObject } from \"zod-openapi\";\n-import {\n-  createCustomerBodySchema,\n-  CustomerEnrichedSchema,\n-} from \"../../zod/schemas/customers\";\n-\n-export const createCustomer: ZodOpenApiOperationObject = {\n-  operationId: \"createCustomer\",\n-  \"x-speakeasy-name-override\": \"create\",\n-  summary: \"Create a customer\",\n-  description:\n-    \"[Deprecated]: Customer creation can only be done via tracking a lead event. Use the /track/lead endpoint instead.\",\n-  deprecated: true,\n-  requestBody: {\n-    content: {\n-      \"application/json\": {\n-        schema: createCustomerBodySchema,\n-      },\n-    },\n-  },\n-  responses: {\n-    \"201\": {\n-      description: \"The customer was created.\",\n-      content: {\n-        \"application/json\": {\n-          schema: CustomerEnrichedSchema,\n-        },\n-      },\n-    },\n-    ...openApiErrorResponses,\n-  },\n-  tags: [\"Customers\"],\n-  security: [{ token: [] }],\n-};\ndiff --git a/apps/web/lib/openapi/customers/index.ts b/apps/web/lib/openapi/customers/index.ts\nindex 0cc5eb085f0..dd5015a8c3f 100644\n--- a/apps/web/lib/openapi/customers/index.ts\n+++ b/apps/web/lib/openapi/customers/index.ts\n@@ -1,5 +1,4 @@\n import { ZodOpenApiPathsObject } from \"zod-openapi\";\n-import { createCustomer } from \"./create-customer\";\n import { deleteCustomer } from \"./delete-customer\";\n import { getCustomer } from \"./get-customer\";\n import { getCustomers } from \"./get-customers\";\n@@ -8,7 +7,6 @@ import { updateCustomer } from \"./update-customer\";\n export const customersPaths: ZodOpenApiPathsObject = {\n   \"/customers\": {\n     get: getCustomers,\n-    post: createCustomer,\n   },\n   \"/customers/{id}\": {\n     get: getCustomer,\ndiff --git a/apps/web/tests/fraud/index.test.ts b/apps/web/tests/fraud/index.test.ts\nindex 5ec68ae360c..cc2c5c50afc 100644\n--- a/apps/web/tests/fraud/index.test.ts\n+++ b/apps/web/tests/fraud/index.test.ts\n@@ -11,7 +11,7 @@ import {\n import { describe, expect, test } from \"vitest\";\n import { IntegrationHarness } from \"../utils/integration\";\n \n-describe.concurrent(\"/fraud/**\", async () => {\n+describe.skip.concurrent(\"/fraud/**\", async () => {\n   const h = new IntegrationHarness();\n   const { http } = await h.init();\n \n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/dubinc__dub.main/pr_mirror/dubinc__dub.main.3157/metadata__pr_3157.json"
  },
  {
    "instance_id": "medusajs__medusa.56ed9cf9.14220",
    "repo": "medusajs/medusa",
    "pull_number": 14220,
    "base_commit": "b7adfb225b4e81bd388c01afe254e2de140266b9",
    "patch": "diff --git a/packages/modules/providers/file-s3/integration-tests/__tests__/services.spec.ts b/packages/modules/providers/file-s3/integration-tests/__tests__/services.spec.ts\nindex 50fa4ca54bded..d20590060114f 100644\n--- a/packages/modules/providers/file-s3/integration-tests/__tests__/services.spec.ts\n+++ b/packages/modules/providers/file-s3/integration-tests/__tests__/services.spec.ts\n@@ -99,6 +99,23 @@ describe.skip(\"S3 File Plugin\", () => {\n     })\n   })\n \n+  it(\"uploads a file with special URL characters in the name\", async () => {\n+    const fileContent = await fs.readFile(fixtureImagePath)\n+    const fixtureAsBinary = fileContent.toString(\"base64\")\n+\n+    const resp = await s3Service.upload({\n+      filename: \"cat?photo.jpg\",\n+      mimeType: \"image/jpeg\",\n+      content: fixtureAsBinary,\n+      access: \"private\",\n+    })\n+\n+    expect(resp).toEqual({\n+      key: expect.stringMatching(/tests\\/catphoto.*\\.jpg/),\n+      url: expect.stringMatching(/https:\\/\\/.*\\/cat%3Fphoto.*\\.jpg/),\n+    })\n+  })\n+\n   it(\"gets a presigned upload URL and uploads a file successfully\", async () => {\n     const fileContent = await fs.readFile(fixtureImagePath)\n     const fixtureAsBinary = fileContent.toString(\"binary\")\ndiff --git a/packages/modules/providers/file-s3/src/services/s3-file.ts b/packages/modules/providers/file-s3/src/services/s3-file.ts\nindex ef3b8be1352f2..f617a722f8058 100644\n--- a/packages/modules/providers/file-s3/src/services/s3-file.ts\n+++ b/packages/modules/providers/file-s3/src/services/s3-file.ts\n@@ -160,7 +160,7 @@ export class S3FileService extends AbstractFileProviderService {\n     }\n \n     return {\n-      url: `${this.config_.fileUrl}/${encodeURI(fileKey)}`,\n+      url: `${this.config_.fileUrl}/${encodeURIComponent(fileKey)}`,\n       key: fileKey,\n     }\n   }\n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/medusajs__medusa.56ed9cf9/pr_mirror/medusajs__medusa.56ed9cf9.14220/metadata__pr_14220.json"
  },
  {
    "instance_id": "medusajs__medusa.56ed9cf9.14209",
    "repo": "medusajs/medusa",
    "pull_number": 14209,
    "base_commit": "765232948900b7be98fb2cef1a9c8caf108a2d1e",
    "patch": "diff --git a/.changeset/shiny-hounds-learn.md b/.changeset/shiny-hounds-learn.md\nnew file mode 100644\nindex 0000000000000..df370ca61eba5\n--- /dev/null\n+++ b/.changeset/shiny-hounds-learn.md\n@@ -0,0 +1,5 @@\n+---\n+\"@medusajs/file-s3\": patch\n+---\n+\n+URL-encode S3 object metadata and returned URL\ndiff --git a/packages/modules/providers/file-s3/integration-tests/__tests__/services.spec.ts b/packages/modules/providers/file-s3/integration-tests/__tests__/services.spec.ts\nindex d874e88c3a21f..50fa4ca54bded 100644\n--- a/packages/modules/providers/file-s3/integration-tests/__tests__/services.spec.ts\n+++ b/packages/modules/providers/file-s3/integration-tests/__tests__/services.spec.ts\n@@ -1,5 +1,5 @@\n-import fs from \"fs/promises\"\n import axios from \"axios\"\n+import fs from \"fs/promises\"\n import { S3FileService } from \"../../src/services/s3-file\"\n jest.setTimeout(100000)\n \n@@ -82,6 +82,23 @@ describe.skip(\"S3 File Plugin\", () => {\n     })\n   })\n \n+  it(\"uploads a file with non-ascii characters in the name\", async () => {\n+    const fileContent = await fs.readFile(fixtureImagePath)\n+    const fixtureAsBinary = fileContent.toString(\"base64\")\n+\n+    const resp = await s3Service.upload({\n+      filename: \"catphoto-\u304b.jpg\",\n+      mimeType: \"image/jpeg\",\n+      content: fixtureAsBinary,\n+      access: \"private\",\n+    })\n+\n+    expect(resp).toEqual({\n+      key: expect.stringMatching(/tests\\/catphoto-\u304b.*\\.jpg/),\n+      url: expect.stringMatching(/https:\\/\\/.*\\/catphoto-%E3%81%8B.*\\.jpg/),\n+    })\n+  })\n+\n   it(\"gets a presigned upload URL and uploads a file successfully\", async () => {\n     const fileContent = await fs.readFile(fixtureImagePath)\n     const fixtureAsBinary = fileContent.toString(\"binary\")\ndiff --git a/packages/modules/providers/file-s3/src/services/s3-file.ts b/packages/modules/providers/file-s3/src/services/s3-file.ts\nindex 4caedd5587468..ef3b8be1352f2 100644\n--- a/packages/modules/providers/file-s3/src/services/s3-file.ts\n+++ b/packages/modules/providers/file-s3/src/services/s3-file.ts\n@@ -148,7 +148,7 @@ export class S3FileService extends AbstractFileProviderService {\n       // Note: We could potentially set the content disposition when uploading,\n       // but storing the original filename as metadata should suffice.\n       Metadata: {\n-        \"x-amz-meta-original-filename\": file.filename,\n+        \"original-filename\": encodeURIComponent(file.filename),\n       },\n     })\n \n@@ -160,7 +160,7 @@ export class S3FileService extends AbstractFileProviderService {\n     }\n \n     return {\n-      url: `${this.config_.fileUrl}/${fileKey}`,\n+      url: `${this.config_.fileUrl}/${encodeURI(fileKey)}`,\n       key: fileKey,\n     }\n   }\n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/medusajs__medusa.56ed9cf9/pr_mirror/medusajs__medusa.56ed9cf9.14209/metadata__pr_14209.json"
  },
  {
    "instance_id": "calcom__cal.com.main.25369",
    "repo": "calcom/cal.com",
    "pull_number": 25369,
    "base_commit": "f2b2b6e491cbb850a917a50c6a0cb3850ffd156a",
    "patch": "diff --git a/packages/features/bookings/lib/getLuckyUser.test.ts b/packages/features/bookings/lib/getLuckyUser.test.ts\nindex 08e553a83bdfcc..4974f6cd1facae 100644\n--- a/packages/features/bookings/lib/getLuckyUser.test.ts\n+++ b/packages/features/bookings/lib/getLuckyUser.test.ts\n@@ -827,6 +827,75 @@ describe(\"maximize availability and weights\", () => {\n     );\n   });\n \n+  it(\"skips OOO calibration when there is only one host\", async () => {\n+    const users: GetLuckyUserAvailableUsersType = [\n+      buildUser({\n+        id: 1,\n+        username: \"test1\",\n+        name: \"Test User 1\",\n+        email: \"test1@example.com\",\n+        bookings: [],\n+      }),\n+    ];\n+\n+    const allRRHosts = [\n+      {\n+        user: {\n+          id: users[0].id,\n+          email: users[0].email,\n+          credentials: [],\n+          userLevelSelectedCalendars: [],\n+        },\n+        weight: users[0].weight,\n+        createdAt: new Date(0),\n+      },\n+    ];\n+\n+    CalendarManagerMock.getBusyCalendarTimes.mockResolvedValue({ success: true, data: [] });\n+\n+    // Mock OOO entry for the single host\n+    prismaMock.outOfOfficeEntry.findMany.mockResolvedValue([\n+      {\n+        start: dayjs().subtract(10, \"day\").toDate(),\n+        end: dayjs().subtract(5, \"day\").toDate(),\n+        userId: users[0].id,\n+      },\n+    ]);\n+\n+    prismaMock.user.findMany.mockResolvedValue(users);\n+    prismaMock.host.findMany.mockResolvedValue([\n+      {\n+        userId: allRRHosts[0].user.id,\n+        weight: allRRHosts[0].weight,\n+        createdAt: allRRHosts[0].createdAt,\n+      },\n+    ]);\n+\n+    // Mock some bookings during the OOO period (though there's only one host)\n+    prismaMock.booking.findMany.mockResolvedValue([\n+      buildBooking({\n+        id: 1,\n+        userId: 1,\n+        createdAt: dayjs().subtract(7, \"days\").toDate(),\n+      }),\n+    ]);\n+\n+    // Should return the only available user without throwing division by zero error\n+    await expect(\n+      luckyUserService.getLuckyUser({\n+        availableUsers: users,\n+        eventType: {\n+          id: 1,\n+          isRRWeightsEnabled: true,\n+          team: { rrResetInterval: RRResetInterval.MONTH, rrTimestampBasis: RRTimestampBasis.CREATED_AT },\n+          includeNoShowInRRCalculation: false,\n+        },\n+        allRRHosts,\n+        routingFormResponse: null,\n+      })\n+    ).resolves.toStrictEqual(users[0]);\n+  });\n+\n   it(\"applies calibration to newly added hosts so they are not penalized unfairly compared to their peers\", async () => {\n     const users: GetLuckyUserAvailableUsersType = [\n       buildUser({\ndiff --git a/packages/features/bookings/lib/getLuckyUser.ts b/packages/features/bookings/lib/getLuckyUser.ts\nindex 8d6c75d8bc5b52..e0afa668f4608d 100644\n--- a/packages/features/bookings/lib/getLuckyUser.ts\n+++ b/packages/features/bookings/lib/getLuckyUser.ts\n@@ -300,6 +300,11 @@ export class LuckyUserService implements ILuckyUserService {\n     const oooCalibration = new Map<number, number>();\n \n     oooData.forEach(({ userId, oooEntries }) => {\n+      // Skip OOO calibration if there's only one host (division by zero would occur)\n+      if (hosts.length <= 1) {\n+        return;\n+      }\n+\n       let calibration = 0;\n \n       oooEntries.forEach((oooEntry) => {\n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/calcom__cal.com.main/pr_mirror/calcom__cal.com.main.25369/metadata__pr_25369.json"
  },
  {
    "instance_id": "calcom__cal.com.main.25394",
    "repo": "calcom/cal.com",
    "pull_number": 25394,
    "base_commit": "81224f324ada684cd47a6be44388447b12dea1f2",
    "patch": "diff --git a/apps/web/test/lib/confirm.handler.test.ts b/apps/web/test/lib/confirm.handler.test.ts\nindex ca85519cfb04d5..0ef053d381fc2e 100644\n--- a/apps/web/test/lib/confirm.handler.test.ts\n+++ b/apps/web/test/lib/confirm.handler.test.ts\n@@ -73,6 +73,7 @@ describe(\"confirmHandler\", () => {\n             location: \"integrations:daily\",\n             attendees: [attendeeUser],\n             responses: { name: attendeeUser.name, email: attendeeUser.email, notes: \"Sensitive information\" },\n+            user: { id: organizer.id },\n           },\n         ],\n         organizer,\ndiff --git a/packages/trpc/server/routers/viewer/bookings/confirm.handler.ts b/packages/trpc/server/routers/viewer/bookings/confirm.handler.ts\nindex 558d98d9960e99..a170e1a7306e05 100644\n--- a/packages/trpc/server/routers/viewer/bookings/confirm.handler.ts\n+++ b/packages/trpc/server/routers/viewer/bookings/confirm.handler.ts\n@@ -45,7 +45,6 @@ type ConfirmOptions = {\n };\n \n export const confirmHandler = async ({ ctx, input }: ConfirmOptions) => {\n-  const { user } = ctx;\n   const {\n     bookingId,\n     recurringEventId,\n@@ -139,12 +138,17 @@ export const confirmHandler = async ({ ctx, input }: ConfirmOptions) => {\n     },\n   });\n \n+  const user = booking.user;\n+  if (!user) {\n+    throw new TRPCError({ code: \"BAD_REQUEST\", message: \"Booking must have an organizer\" });\n+  }\n+\n   await checkIfUserIsAuthorizedToConfirmBooking({\n     eventTypeId: booking.eventTypeId,\n-    loggedInUserId: user.id,\n+    loggedInUserId: ctx.user.id,\n     teamId: booking.eventType?.teamId || booking.eventType?.parent?.teamId,\n     bookingUserId: booking.userId,\n-    userRole: user.role,\n+    userRole: ctx.user.role,\n   });\n \n   // Do not move this before authorization check.\n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/calcom__cal.com.main/pr_mirror/calcom__cal.com.main.25394/metadata__pr_25394.json"
  },
  {
    "instance_id": "calcom__cal.com.main.25597",
    "repo": "calcom/cal.com",
    "pull_number": 25597,
    "base_commit": "06055729692e4e6df0f1684d94158b75ac7c02bb",
    "patch": "diff --git a/packages/features/CalendarEventBuilder.test.ts b/packages/features/CalendarEventBuilder.test.ts\nindex cd12f0f26e85dc..4bede68260953e 100644\n--- a/packages/features/CalendarEventBuilder.test.ts\n+++ b/packages/features/CalendarEventBuilder.test.ts\n@@ -980,6 +980,9 @@ describe(\"CalendarEventBuilder\", () => {\n     });\n \n     it(\"should create a calendar event from booking with team\", async () => {\n+      // Note: The CalendarEventBuilder filters team members to only include hosts\n+      // whose emails appear in booking.attendees. This simulates a COLLECTIVE event\n+      // where all hosts are assigned to the booking.\n       const mockBooking = {\n         uid: \"booking-789\",\n         metadata: null,\n@@ -1001,6 +1004,14 @@ describe(\"CalendarEventBuilder\", () => {\n             locale: \"en\",\n             phoneNumber: null,\n           },\n+          {\n+            // Team member host - included in attendees for COLLECTIVE events\n+            name: \"Team Member\",\n+            email: \"member@example.com\",\n+            timeZone: \"America/Los_Angeles\",\n+            locale: \"en\",\n+            phoneNumber: null,\n+          },\n         ],\n         user: {\n           id: 3,\n@@ -1647,6 +1658,14 @@ describe(\"CalendarEventBuilder\", () => {\n             locale: \"en\",\n             phoneNumber: null,\n           },\n+          {\n+            // Team member host - included in attendees for COLLECTIVE events\n+            name: \"Team Member\",\n+            email: \"member@example.com\",\n+            timeZone: \"America/Los_Angeles\",\n+            locale: \"en\",\n+            phoneNumber: null,\n+          },\n         ],\n         user: {\n           id: 100,\n@@ -1836,12 +1855,14 @@ describe(\"CalendarEventBuilder\", () => {\n       expect(builtFromBooking.organizer.username).toBe(\"teamlead\");\n       expect(builtFromBooking.organizer.timeZone).toBe(\"America/New_York\");\n \n-      expect(builtFromBooking.attendees).toHaveLength(2);\n+      expect(builtFromBooking.attendees).toHaveLength(3);\n       expect(builtFromBooking.attendees[0].name).toBe(\"Complete User\");\n       expect(builtFromBooking.attendees[0].email).toBe(\"complete@example.com\");\n       expect(builtFromBooking.attendees[0].timeZone).toBe(\"America/New_York\");\n       expect(builtFromBooking.attendees[1].name).toBe(\"Guest User\");\n       expect(builtFromBooking.attendees[1].email).toBe(\"guest@example.com\");\n+      expect(builtFromBooking.attendees[2].name).toBe(\"Team Member\");\n+      expect(builtFromBooking.attendees[2].email).toBe(\"member@example.com\");\n \n       expect(builtFromBooking.team).toBeDefined();\n       expect(builtFromBooking.team?.id).toBe(50);\ndiff --git a/packages/features/CalendarEventBuilder.ts b/packages/features/CalendarEventBuilder.ts\nindex 9ec0e6346a25ba..492b1aed7d455a 100644\n--- a/packages/features/CalendarEventBuilder.ts\n+++ b/packages/features/CalendarEventBuilder.ts\n@@ -7,7 +7,7 @@ import { parseRecurringEvent } from \"@calcom/lib/isRecurringEvent\";\n import { getTranslation } from \"@calcom/lib/server/i18n\";\n import { getTimeFormatStringFromUserTimeFormat, type TimeFormat } from \"@calcom/lib/timeFormat\";\n import type { Attendee, BookingSeat, DestinationCalendar, Prisma, User } from \"@calcom/prisma/client\";\n-import type { SchedulingType } from \"@calcom/prisma/enums\";\n+import { SchedulingType } from \"@calcom/prisma/enums\";\n import { bookingResponses as bookingResponsesSchema } from \"@calcom/prisma/zod-utils\";\n import type { CalendarEvent, Person, CalEventResponses, AppsStatus } from \"@calcom/types/Calendar\";\n import type { VideoCallData } from \"@calcom/types/VideoApiAdapter\";\n@@ -226,12 +226,25 @@ export class CalendarEventBuilder {\n \n     // Team & calendars\n     if (eventType.team) {\n+      // We need to get the team members assigned to the booking\n+      // In the DB team members are stored in the Attendee table\n+      const bookingAttendees = booking.attendees;\n+\n+      const hostsToInclude = eventType.hosts.filter((host) =>\n+        bookingAttendees.some((attendee) => attendee.email === host.user.email)\n+      );\n+\n+      const hostsWithoutOrganizerData = hostsToInclude.filter(\n+        (host) => host.user.email !== user.email\n+      );\n+\n       const hostsWithoutOrganizer = await Promise.all(\n-        eventType.hosts.filter((h) => h.user.email !== user.email).map((h) => _buildPersonFromUser(h.user))\n+        hostsWithoutOrganizerData.map((host) => _buildPersonFromUser(host.user))\n       );\n \n       const hostCalendars = [\n-        ...eventType.hosts.map((h) => h.user.destinationCalendar).filter(Boolean),\n+        user.destinationCalendar,\n+        ...hostsWithoutOrganizerData.map((h) => h.user.destinationCalendar).filter(Boolean),\n         user.destinationCalendar,\n       ].filter(Boolean) as NonNullable<DestinationCalendar>[];\n \ndiff --git a/packages/features/ee/workflows/lib/service/EmailWorkflowService.test.ts b/packages/features/ee/workflows/lib/service/EmailWorkflowService.test.ts\nindex 64fd338591ab7c..b11f5d7cc1cc27 100644\n--- a/packages/features/ee/workflows/lib/service/EmailWorkflowService.test.ts\n+++ b/packages/features/ee/workflows/lib/service/EmailWorkflowService.test.ts\n@@ -2,9 +2,17 @@ import { describe, expect, vi, beforeEach, test } from \"vitest\";\n \n import type { BookingSeatRepository } from \"@calcom/features/bookings/repositories/BookingSeatRepository\";\n import type { WorkflowReminderRepository } from \"@calcom/features/ee/workflows/repositories/WorkflowReminderRepository\";\n-import { WorkflowActions, WorkflowTemplates, WorkflowTriggerEvents } from \"@calcom/prisma/enums\";\n+import {\n+  SchedulingType,\n+  TimeUnit,\n+  WorkflowActions,\n+  WorkflowTemplates,\n+  WorkflowTriggerEvents,\n+} from \"@calcom/prisma/enums\";\n import type { CalendarEvent } from \"@calcom/types/Calendar\";\n \n+import { EmailWorkflowService } from \"./EmailWorkflowService\";\n+\n vi.mock(\"@calcom/emails/workflow-email-service\", () => ({\n   sendCustomWorkflowEmail: vi.fn(),\n }));\n@@ -22,8 +30,6 @@ vi.mock(\"@calcom/prisma\", () => ({\n   prisma: {},\n }));\n \n-import { EmailWorkflowService } from \"./EmailWorkflowService\";\n-\n const mockWorkflowReminderRepository: Pick<WorkflowReminderRepository, \"findByIdIncludeStepAndWorkflow\"> = {\n   findByIdIncludeStepAndWorkflow: vi.fn(),\n };\n@@ -156,4 +162,223 @@ describe(\"EmailWorkflowService\", () => {\n       expect(mockBookingSeatRepository.getByUidIncludeAttendee).toHaveBeenCalledWith(\"seat-123\");\n     });\n   });\n+\n+  describe(\"generateParametersToBuildEmailWorkflowContent - EMAIL_HOST\", () => {\n+    const mockCommonScheduleFunctionParams = {\n+      triggerEvent: WorkflowTriggerEvents.BEFORE_EVENT,\n+      timeSpan: {\n+        time: 24,\n+        timeUnit: TimeUnit.HOUR,\n+      },\n+      workflowStepId: 1,\n+      template: WorkflowTemplates.REMINDER,\n+      userId: 1,\n+      teamId: null,\n+      seatReferenceUid: undefined,\n+      verifiedAt: new Date(),\n+      creditCheckFn: vi.fn().mockResolvedValue(true),\n+    };\n+\n+    const baseMockEvt: Partial<CalendarEvent> = {\n+      uid: \"booking-123\",\n+      bookerUrl: \"https://cal.com\",\n+      title: \"Test Meeting\",\n+      startTime: \"2024-12-01T10:00:00Z\",\n+      endTime: \"2024-12-01T11:00:00Z\",\n+      organizer: {\n+        name: \"Organizer Name\",\n+        email: \"organizer@example.com\",\n+        timeZone: \"UTC\",\n+        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n+        language: { locale: \"en\", translate: (() => \"\") as any },\n+        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n+        timeFormat: \"h:mma\" as any,\n+      },\n+      attendees: [\n+        {\n+          name: \"Attendee Name\",\n+          email: \"attendee@example.com\",\n+          timeZone: \"UTC\",\n+          // eslint-disable-next-line @typescript-eslint/no-explicit-any\n+          language: { locale: \"en\", translate: (() => \"\") as any },\n+        },\n+      ],\n+    };\n+\n+    const mockWorkflowStep = {\n+      id: 1,\n+      action: WorkflowActions.EMAIL_HOST,\n+      verifiedAt: new Date(),\n+      sendTo: null,\n+      template: WorkflowTemplates.REMINDER,\n+      reminderBody: null,\n+      emailSubject: null,\n+      sender: null,\n+      includeCalendarEvent: false,\n+      numberVerificationPending: false,\n+      numberRequired: false,\n+    };\n+\n+    test(\"should send to organizer and team members for ROUND_ROBIN scheduling type\", async () => {\n+      // Note: For ROUND_ROBIN, the CalendarEventBuilder filters team members to only include\n+      // those assigned to the booking. EmailWorkflowService sends to all team members in evt.team.members.\n+      const mockEvt: Partial<CalendarEvent> = {\n+        ...baseMockEvt,\n+        schedulingType: SchedulingType.ROUND_ROBIN,\n+        team: {\n+          id: 1,\n+          name: \"Test Team\",\n+          members: [\n+            {\n+              id: 1,\n+              name: \"Team Member 1\",\n+              email: \"team1@example.com\",\n+              timeZone: \"UTC\",\n+              // eslint-disable-next-line @typescript-eslint/no-explicit-any\n+              language: { locale: \"en\", translate: (() => \"\") as any },\n+            },\n+            {\n+              id: 2,\n+              name: \"Team Member 2\",\n+              email: \"team2@example.com\",\n+              timeZone: \"UTC\",\n+              // eslint-disable-next-line @typescript-eslint/no-explicit-any\n+              language: { locale: \"en\", translate: (() => \"\") as any },\n+            },\n+          ],\n+        },\n+      };\n+\n+      const result = await emailWorkflowService.generateParametersToBuildEmailWorkflowContent({\n+        evt: mockEvt as CalendarEvent,\n+        workflowStep: mockWorkflowStep,\n+        workflow: { userId: 1 },\n+        commonScheduleFunctionParams: mockCommonScheduleFunctionParams,\n+        hideBranding: false,\n+      });\n+\n+      // EmailWorkflowService sends to organizer + all team members in evt.team.members\n+      // The filtering of team members happens in CalendarEventBuilder, not here\n+      expect(result.sendTo).toContain(\"organizer@example.com\");\n+      expect(result.sendTo).toContain(\"team1@example.com\");\n+      expect(result.sendTo).toContain(\"team2@example.com\");\n+      expect(result.sendTo.length).toBe(3);\n+    });\n+\n+    test(\"should send to organizer and team members for COLLECTIVE scheduling type\", async () => {\n+      const mockEvt: Partial<CalendarEvent> = {\n+        ...baseMockEvt,\n+        schedulingType: SchedulingType.COLLECTIVE,\n+        team: {\n+          id: 1,\n+          name: \"Test Team\",\n+          members: [\n+            {\n+              id: 1,\n+              name: \"Team Member 1\",\n+              email: \"team1@example.com\",\n+              timeZone: \"UTC\",\n+              // eslint-disable-next-line @typescript-eslint/no-explicit-any\n+              language: { locale: \"en\", translate: (() => \"\") as any },\n+            },\n+            {\n+              id: 2,\n+              name: \"Team Member 2\",\n+              email: \"team2@example.com\",\n+              timeZone: \"UTC\",\n+              // eslint-disable-next-line @typescript-eslint/no-explicit-any\n+              language: { locale: \"en\", translate: (() => \"\") as any },\n+            },\n+          ],\n+        },\n+      };\n+\n+      const result = await emailWorkflowService.generateParametersToBuildEmailWorkflowContent({\n+        evt: mockEvt as CalendarEvent,\n+        workflowStep: mockWorkflowStep,\n+        workflow: { userId: 1 },\n+        commonScheduleFunctionParams: mockCommonScheduleFunctionParams,\n+        hideBranding: false,\n+      });\n+\n+      expect(result.sendTo).toContain(\"organizer@example.com\");\n+      expect(result.sendTo).toContain(\"team1@example.com\");\n+      expect(result.sendTo).toContain(\"team2@example.com\");\n+      expect(result.sendTo.length).toBe(3);\n+    });\n+\n+    test(\"should send to organizer only when team is undefined for COLLECTIVE\", async () => {\n+      const mockEvt: Partial<CalendarEvent> = {\n+        ...baseMockEvt,\n+        schedulingType: SchedulingType.COLLECTIVE,\n+        team: undefined,\n+      } as Partial<CalendarEvent>;\n+\n+      const result = await emailWorkflowService.generateParametersToBuildEmailWorkflowContent({\n+        evt: mockEvt as CalendarEvent,\n+        workflowStep: mockWorkflowStep,\n+        workflow: { userId: 1 },\n+        commonScheduleFunctionParams: mockCommonScheduleFunctionParams,\n+        hideBranding: false,\n+      });\n+\n+      expect(result.sendTo).toEqual([\"organizer@example.com\"]);\n+      expect(result.sendTo.length).toBe(1);\n+    });\n+\n+    test(\"should send to organizer only when team members array is empty for COLLECTIVE\", async () => {\n+      const mockEvt: Partial<CalendarEvent> = {\n+        ...baseMockEvt,\n+        schedulingType: SchedulingType.COLLECTIVE,\n+        team: {\n+          id: 1,\n+          name: \"Test Team\",\n+          members: [],\n+        },\n+      };\n+\n+      const result = await emailWorkflowService.generateParametersToBuildEmailWorkflowContent({\n+        evt: mockEvt as CalendarEvent,\n+        workflowStep: mockWorkflowStep,\n+        workflow: { userId: 1 },\n+        commonScheduleFunctionParams: mockCommonScheduleFunctionParams,\n+        hideBranding: false,\n+      });\n+\n+      expect(result.sendTo).toEqual([\"organizer@example.com\"]);\n+      expect(result.sendTo.length).toBe(1);\n+    });\n+\n+    test(\"should send to organizer only for other scheduling types (e.g., null)\", async () => {\n+      const mockEvt: Partial<CalendarEvent> = {\n+        ...baseMockEvt,\n+        schedulingType: null,\n+        team: {\n+          id: 1,\n+          name: \"Test Team\",\n+          members: [\n+            {\n+              id: 1,\n+              name: \"Team Member 1\",\n+              email: \"team1@example.com\",\n+              timeZone: \"UTC\",\n+              // eslint-disable-next-line @typescript-eslint/no-explicit-any\n+              language: { locale: \"en\", translate: (() => \"\") as any },\n+            },\n+          ],\n+        },\n+      } as Partial<CalendarEvent>;\n+\n+      const result = await emailWorkflowService.generateParametersToBuildEmailWorkflowContent({\n+        evt: mockEvt as CalendarEvent,\n+        workflowStep: mockWorkflowStep,\n+        workflow: { userId: 1 },\n+        commonScheduleFunctionParams: mockCommonScheduleFunctionParams,\n+        hideBranding: false,\n+      });\n+\n+      expect(result.sendTo).toEqual([\"organizer@example.com\"]);\n+      expect(result.sendTo.length).toBe(1);\n+    });\n+  });\n });\n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/calcom__cal.com.main/pr_mirror/calcom__cal.com.main.25597/metadata__pr_25597.json"
  },
  {
    "instance_id": "calcom__cal.com.main.25332",
    "repo": "calcom/cal.com",
    "pull_number": 25332,
    "base_commit": "9c2d7f99c2ba3b845fe13456722557555bf2d963",
    "patch": "diff --git a/packages/trpc/server/routers/viewer/teams/update.handler.test.ts b/packages/trpc/server/routers/viewer/teams/update.handler.test.ts\nnew file mode 100644\nindex 00000000000000..59cabfd4dc81c5\n--- /dev/null\n+++ b/packages/trpc/server/routers/viewer/teams/update.handler.test.ts\n@@ -0,0 +1,215 @@\n+import { describe, it, expect, vi, beforeEach } from \"vitest\";\n+\n+import { TeamRepository } from \"@calcom/features/ee/teams/repositories/TeamRepository\";\n+import { PermissionCheckService } from \"@calcom/features/pbac/services/permission-check.service\";\n+import { prisma } from \"@calcom/prisma\";\n+import { RRTimestampBasis } from \"@calcom/prisma/enums\";\n+\n+import type { TrpcSessionUser } from \"../../../types\";\n+import { updateHandler } from \"./update.handler\";\n+import type { TUpdateInputSchema } from \"./update.schema\";\n+\n+vi.mock(\"@calcom/prisma\", () => ({\n+  prisma: {\n+    team: {\n+      findUnique: vi.fn(),\n+      update: vi.fn(),\n+      updateMany: vi.fn(),\n+    },\n+    eventType: {\n+      updateMany: vi.fn(),\n+    },\n+    tempOrgRedirect: {\n+      updateMany: vi.fn(),\n+    },\n+  },\n+}));\n+\n+vi.mock(\"@calcom/features/pbac/services/permission-check.service\", () => ({\n+  PermissionCheckService: vi.fn().mockImplementation(() => ({\n+    checkPermission: vi.fn(),\n+  })),\n+}));\n+\n+vi.mock(\"@calcom/features/ee/teams/repositories/TeamRepository\", () => ({\n+  TeamRepository: vi.fn().mockImplementation(() => ({\n+    isSlugAvailableForUpdate: vi.fn().mockResolvedValue(true),\n+  })),\n+}));\n+\n+vi.mock(\"@calcom/lib/server/avatar\", () => ({\n+  uploadLogo: vi.fn().mockResolvedValue(\"https://example.com/logo.png\"),\n+}));\n+\n+vi.mock(\"@calcom/lib/intervalLimits/validateIntervalLimitOrder\", () => ({\n+  validateIntervalLimitOrder: vi.fn().mockReturnValue(true),\n+}));\n+\n+vi.mock(\"@calcom/lib/constants\", () => ({\n+  IS_TEAM_BILLING_ENABLED: false,\n+}));\n+\n+vi.mock(\"@calcom/ee/organizations/lib/orgDomains\", () => ({\n+  getOrgFullOrigin: vi.fn((slug: string) => `https://${slug}.cal.com`),\n+}));\n+\n+describe(\"updateHandler - Permission Check Tests\", () => {\n+  const mockPermissionCheckService = {\n+    checkPermission: vi.fn(),\n+  };\n+\n+  const mockTeamRepository = {\n+    isSlugAvailableForUpdate: vi.fn().mockResolvedValue(true),\n+  };\n+\n+  beforeEach(() => {\n+    vi.clearAllMocks();\n+    vi.mocked(PermissionCheckService).mockImplementation(\n+      () => mockPermissionCheckService as unknown as InstanceType<typeof PermissionCheckService>\n+    );\n+    vi.mocked(TeamRepository).mockImplementation(\n+      () => mockTeamRepository as unknown as InstanceType<typeof TeamRepository>\n+    );\n+  });\n+\n+  describe(\"Permission Check Service\", () => {\n+    const user: NonNullable<TrpcSessionUser> = {\n+      id: 1,\n+      organizationId: 100,\n+    } as NonNullable<TrpcSessionUser>;\n+\n+    it(\"should use permission check service for all users\", async () => {\n+      const input: TUpdateInputSchema = {\n+        id: 50,\n+        name: \"Updated Team\",\n+      };\n+\n+      mockPermissionCheckService.checkPermission.mockResolvedValue(true);\n+\n+      vi.mocked(prisma.team.findUnique).mockResolvedValue({\n+        id: 50,\n+        parentId: 100,\n+        slug: \"test-team\",\n+        metadata: {},\n+        rrTimestampBasis: RRTimestampBasis.CREATED_AT,\n+      } as any);\n+\n+      vi.mocked(prisma.team.update).mockResolvedValue({\n+        id: 50,\n+        name: \"Updated Team\",\n+        bio: null,\n+        slug: \"test-team\",\n+        theme: null,\n+        brandColor: null,\n+        darkBrandColor: null,\n+        logoUrl: null,\n+        bookingLimits: null,\n+        includeManagedEventsInLimits: null,\n+        rrResetInterval: null,\n+        rrTimestampBasis: RRTimestampBasis.CREATED_AT,\n+      } as any);\n+\n+      await updateHandler({\n+        ctx: { user },\n+        input,\n+      });\n+\n+      expect(mockPermissionCheckService.checkPermission).toHaveBeenCalledWith({\n+        userId: user.id,\n+        teamId: input.id,\n+        permission: \"team.update\",\n+        fallbackRoles: expect.any(Array),\n+      });\n+      expect(prisma.team.update).toHaveBeenCalled();\n+    });\n+\n+    it(\"should throw UNAUTHORIZED when permission check fails\", async () => {\n+      const input: TUpdateInputSchema = {\n+        id: 50,\n+        name: \"Unauthorized Update\",\n+      };\n+\n+      mockPermissionCheckService.checkPermission.mockResolvedValue(false);\n+\n+      vi.mocked(prisma.team.findUnique).mockResolvedValue({\n+        id: 50,\n+        parentId: 100,\n+        slug: \"test-team\",\n+        metadata: {},\n+        rrTimestampBasis: RRTimestampBasis.CREATED_AT,\n+      } as any);\n+\n+      await expect(\n+        updateHandler({\n+          ctx: { user },\n+          input,\n+        })\n+      ).rejects.toMatchObject({\n+        code: \"UNAUTHORIZED\",\n+      });\n+\n+      expect(prisma.team.update).not.toHaveBeenCalled();\n+    });\n+\n+    it(\"should throw UNAUTHORIZED when user has no id\", async () => {\n+      const userWithoutId = {\n+        id: undefined,\n+        organizationId: 100,\n+      } as unknown as NonNullable<TrpcSessionUser>;\n+\n+      const input: TUpdateInputSchema = {\n+        id: 50,\n+        name: \"Updated Team\",\n+      };\n+\n+      vi.mocked(prisma.team.findUnique).mockResolvedValue({\n+        id: 50,\n+        parentId: 100,\n+        slug: \"test-team\",\n+        metadata: {},\n+        rrTimestampBasis: RRTimestampBasis.CREATED_AT,\n+      } as any);\n+\n+      await expect(\n+        updateHandler({\n+          ctx: { user: userWithoutId },\n+          input,\n+        })\n+      ).rejects.toMatchObject({\n+        code: \"UNAUTHORIZED\",\n+      });\n+\n+      expect(mockPermissionCheckService.checkPermission).not.toHaveBeenCalled();\n+      expect(prisma.team.update).not.toHaveBeenCalled();\n+    });\n+  });\n+\n+  describe(\"Team Not Found\", () => {\n+    const user: NonNullable<TrpcSessionUser> = {\n+      id: 1,\n+      organizationId: 100,\n+    } as NonNullable<TrpcSessionUser>;\n+\n+    it(\"should throw NOT_FOUND when team does not exist\", async () => {\n+      const input: TUpdateInputSchema = {\n+        id: 999,\n+        name: \"Non-existent Team\",\n+      };\n+\n+      vi.mocked(prisma.team.findUnique).mockResolvedValue(null);\n+\n+      await expect(\n+        updateHandler({\n+          ctx: { user },\n+          input,\n+        })\n+      ).rejects.toMatchObject({\n+        code: \"NOT_FOUND\",\n+        message: \"Team not found.\",\n+      });\n+\n+      // Should not check permissions if team doesn't exist\n+      expect(mockPermissionCheckService.checkPermission).not.toHaveBeenCalled();\n+    });\n+  });\n+});\ndiff --git a/packages/trpc/server/routers/viewer/teams/update.handler.ts b/packages/trpc/server/routers/viewer/teams/update.handler.ts\nindex 55022aad5aeb59..43fa3859940f52 100644\n--- a/packages/trpc/server/routers/viewer/teams/update.handler.ts\n+++ b/packages/trpc/server/routers/viewer/teams/update.handler.ts\n@@ -23,20 +23,35 @@ type UpdateOptions = {\n };\n \n export const updateHandler = async ({ ctx, input }: UpdateOptions) => {\n-  const isOrgAdmin = ctx.user?.organization?.isOrgAdmin;\n+  const prevTeam = await prisma.team.findUnique({\n+    where: {\n+      id: input.id,\n+    },\n+    select: {\n+      id: true,\n+      parentId: true,\n+      slug: true,\n+      metadata: true,\n+      rrTimestampBasis: true,\n+    },\n+  });\n \n-  if (!isOrgAdmin) {\n-    const permissionCheckService = new PermissionCheckService();\n-    const hasTeamUpdatePermission = await permissionCheckService.checkPermission({\n-      userId: ctx.user?.id || 0,\n-      teamId: input.id,\n-      permission: \"team.update\",\n-      fallbackRoles: [MembershipRole.OWNER, MembershipRole.ADMIN],\n-    });\n+  if (!prevTeam) throw new TRPCError({ code: \"NOT_FOUND\", message: \"Team not found.\" });\n \n-    if (!hasTeamUpdatePermission) {\n-      throw new TRPCError({ code: \"UNAUTHORIZED\" });\n-    }\n+  if (!ctx.user?.id) {\n+    throw new TRPCError({ code: \"UNAUTHORIZED\" });\n+  }\n+\n+  const permissionCheckService = new PermissionCheckService();\n+  const hasTeamUpdatePermission = await permissionCheckService.checkPermission({\n+    userId: ctx.user.id,\n+    teamId: input.id,\n+    permission: \"team.update\",\n+    fallbackRoles: [MembershipRole.OWNER, MembershipRole.ADMIN],\n+  });\n+\n+  if (!hasTeamUpdatePermission) {\n+    throw new TRPCError({ code: \"UNAUTHORIZED\" });\n   }\n \n   if (input.slug) {\n@@ -52,14 +67,6 @@ export const updateHandler = async ({ ctx, input }: UpdateOptions) => {\n     }\n   }\n \n-  const prevTeam = await prisma.team.findUnique({\n-    where: {\n-      id: input.id,\n-    },\n-  });\n-\n-  if (!prevTeam) throw new TRPCError({ code: \"NOT_FOUND\", message: \"Team not found.\" });\n-\n   if (input.bookingLimits) {\n     const isValid = validateIntervalLimitOrder(input.bookingLimits);\n     if (!isValid)\n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/calcom__cal.com.main/pr_mirror/calcom__cal.com.main.25332/metadata__pr_25332.json"
  },
  {
    "instance_id": "calcom__cal.com.main.25321",
    "repo": "calcom/cal.com",
    "pull_number": 25321,
    "base_commit": "6499243a42c565c444b6b86f8c288413b5ac5a7c",
    "patch": "diff --git a/packages/features/membership/repositories/MembershipRepository.ts b/packages/features/membership/repositories/MembershipRepository.ts\nindex b016ea5bec2190..2975224066f362 100644\n--- a/packages/features/membership/repositories/MembershipRepository.ts\n+++ b/packages/features/membership/repositories/MembershipRepository.ts\n@@ -134,6 +134,22 @@ export class MembershipRepository {\n     });\n   }\n \n+  static async findAcceptedMembershipsByUserIdsInTeam({\n+    userIds,\n+    teamId,\n+  }: {\n+    userIds: number[];\n+    teamId: number;\n+  }) {\n+    return prisma.membership.findMany({\n+      where: {\n+        userId: { in: userIds },\n+        accepted: true,\n+        teamId,\n+      },\n+    });\n+  }\n+\n   static async createMany(data: IMembership[]) {\n     return await prisma.membership.createMany({\n       data: data.map((item) => ({\ndiff --git a/packages/trpc/server/routers/viewer/teams/removeHostsFromEventTypes.handler.test.ts b/packages/trpc/server/routers/viewer/teams/removeHostsFromEventTypes.handler.test.ts\nnew file mode 100644\nindex 00000000000000..b7c5c85e07394e\n--- /dev/null\n+++ b/packages/trpc/server/routers/viewer/teams/removeHostsFromEventTypes.handler.test.ts\n@@ -0,0 +1,346 @@\n+/* eslint-disable @typescript-eslint/no-explicit-any */\n+import { describe, it, beforeEach, vi, expect } from \"vitest\";\n+\n+import { MembershipRepository } from \"@calcom/features/membership/repositories/MembershipRepository\";\n+import { PermissionCheckService } from \"@calcom/features/pbac/services/permission-check.service\";\n+import prisma from \"@calcom/prisma\";\n+\n+import type { TrpcSessionUser } from \"../../../types\";\n+import removeHostsFromEventTypesHandler from \"./removeHostsFromEventTypes.handler\";\n+\n+vi.mock(\"@calcom/prisma\", () => ({\n+  default: {\n+    host: {\n+      deleteMany: vi.fn(),\n+    },\n+  },\n+}));\n+\n+vi.mock(\"@calcom/features/pbac/services/permission-check.service\", () => ({\n+  PermissionCheckService: vi.fn(),\n+}));\n+\n+vi.mock(\"@calcom/features/membership/repositories/MembershipRepository\", () => ({\n+  MembershipRepository: {\n+    findAcceptedMembershipsByUserIdsInTeam: vi.fn(),\n+  },\n+}));\n+\n+describe(\"removeHostsFromEventTypesHandler\", () => {\n+  const mockUser = {\n+    id: 1,\n+    name: \"Test User\",\n+  } as NonNullable<TrpcSessionUser>;\n+\n+  const mockInput = {\n+    userIds: [101, 102],\n+    eventTypeIds: [201, 202],\n+    teamId: 300,\n+  };\n+\n+  beforeEach(() => {\n+    vi.clearAllMocks();\n+  });\n+\n+  it(\"throws UNAUTHORIZED if user does not have eventType.update permission\", async () => {\n+    const mockCheckPermission = vi.fn().mockResolvedValue(false);\n+    (PermissionCheckService as any).mockImplementation(() => ({\n+      checkPermission: mockCheckPermission,\n+    }));\n+\n+    await expect(\n+      removeHostsFromEventTypesHandler({\n+        ctx: { user: mockUser },\n+        input: mockInput,\n+      })\n+    ).rejects.toMatchObject({\n+      code: \"UNAUTHORIZED\",\n+    });\n+\n+    expect(mockCheckPermission).toHaveBeenCalledWith({\n+      userId: mockUser.id,\n+      teamId: mockInput.teamId,\n+      permission: \"eventType.update\",\n+      fallbackRoles: [\"OWNER\", \"ADMIN\"],\n+    });\n+\n+    expect(MembershipRepository.findAcceptedMembershipsByUserIdsInTeam).not.toHaveBeenCalled();\n+    expect(prisma.host.deleteMany).not.toHaveBeenCalled();\n+  });\n+\n+  it(\"deletes hosts when user has permission and all users are team members\", async () => {\n+    const mockCheckPermission = vi.fn().mockResolvedValue(true);\n+    (PermissionCheckService as any).mockImplementation(() => ({\n+      checkPermission: mockCheckPermission,\n+    }));\n+\n+    // Mock that all userIds are valid team members\n+    (MembershipRepository.findAcceptedMembershipsByUserIdsInTeam as any).mockResolvedValue([\n+      { userId: 101 },\n+      { userId: 102 },\n+    ]);\n+\n+    const mockDeleteResult = { count: 3 };\n+    (prisma.host.deleteMany as any).mockResolvedValue(mockDeleteResult);\n+\n+    const result = await removeHostsFromEventTypesHandler({\n+      ctx: { user: mockUser },\n+      input: mockInput,\n+    });\n+\n+    expect(result).toEqual(mockDeleteResult);\n+\n+    expect(mockCheckPermission).toHaveBeenCalledWith({\n+      userId: mockUser.id,\n+      teamId: mockInput.teamId,\n+      permission: \"eventType.update\",\n+      fallbackRoles: [\"OWNER\", \"ADMIN\"],\n+    });\n+\n+    expect(MembershipRepository.findAcceptedMembershipsByUserIdsInTeam).toHaveBeenCalledWith({\n+      userIds: mockInput.userIds,\n+      teamId: mockInput.teamId,\n+    });\n+\n+    expect(prisma.host.deleteMany).toHaveBeenCalledWith({\n+      where: {\n+        eventTypeId: {\n+          in: mockInput.eventTypeIds,\n+        },\n+        eventType: {\n+          teamId: mockInput.teamId,\n+        },\n+        userId: {\n+          in: mockInput.userIds,\n+        },\n+      },\n+    });\n+  });\n+\n+  it(\"only removes hosts for userIds that are team members (filters out non-members)\", async () => {\n+    const mockCheckPermission = vi.fn().mockResolvedValue(true);\n+    (PermissionCheckService as any).mockImplementation(() => ({\n+      checkPermission: mockCheckPermission,\n+    }));\n+\n+    // Mock that only userId 101 is a team member, 102 is not\n+    (MembershipRepository.findAcceptedMembershipsByUserIdsInTeam as any).mockResolvedValue([\n+      { userId: 101 },\n+    ]);\n+\n+    const mockDeleteResult = { count: 1 };\n+    (prisma.host.deleteMany as any).mockResolvedValue(mockDeleteResult);\n+\n+    const result = await removeHostsFromEventTypesHandler({\n+      ctx: { user: mockUser },\n+      input: mockInput,\n+    });\n+\n+    expect(result).toEqual(mockDeleteResult);\n+\n+    expect(MembershipRepository.findAcceptedMembershipsByUserIdsInTeam).toHaveBeenCalledWith({\n+      userIds: mockInput.userIds,\n+      teamId: mockInput.teamId,\n+    });\n+\n+    // Should only delete for userId 101, not 102\n+    expect(prisma.host.deleteMany).toHaveBeenCalledWith({\n+      where: {\n+        eventTypeId: {\n+          in: mockInput.eventTypeIds,\n+        },\n+        eventType: {\n+          teamId: mockInput.teamId,\n+        },\n+        userId: {\n+          in: [101], // Only 101, not 102\n+        },\n+      },\n+    });\n+  });\n+\n+  it(\"handles empty userIds array\", async () => {\n+    const mockCheckPermission = vi.fn().mockResolvedValue(true);\n+    (PermissionCheckService as any).mockImplementation(() => ({\n+      checkPermission: mockCheckPermission,\n+    }));\n+\n+    // Empty array means no memberships to validate\n+    (MembershipRepository.findAcceptedMembershipsByUserIdsInTeam as any).mockResolvedValue([]);\n+\n+    const mockDeleteResult = { count: 0 };\n+    (prisma.host.deleteMany as any).mockResolvedValue(mockDeleteResult);\n+\n+    const emptyUsersInput = {\n+      ...mockInput,\n+      userIds: [],\n+    };\n+\n+    const result = await removeHostsFromEventTypesHandler({\n+      ctx: { user: mockUser },\n+      input: emptyUsersInput,\n+    });\n+\n+    expect(result).toEqual(mockDeleteResult);\n+\n+    expect(prisma.host.deleteMany).toHaveBeenCalledWith({\n+      where: {\n+        eventTypeId: {\n+          in: mockInput.eventTypeIds,\n+        },\n+        eventType: {\n+          teamId: mockInput.teamId,\n+        },\n+        userId: {\n+          in: [],\n+        },\n+      },\n+    });\n+  });\n+\n+  it(\"handles empty eventTypeIds array\", async () => {\n+    const mockCheckPermission = vi.fn().mockResolvedValue(true);\n+    (PermissionCheckService as any).mockImplementation(() => ({\n+      checkPermission: mockCheckPermission,\n+    }));\n+\n+    // Mock that all userIds are valid team members\n+    (MembershipRepository.findAcceptedMembershipsByUserIdsInTeam as any).mockResolvedValue([\n+      { userId: 101 },\n+      { userId: 102 },\n+    ]);\n+\n+    const mockDeleteResult = { count: 0 };\n+    (prisma.host.deleteMany as any).mockResolvedValue(mockDeleteResult);\n+\n+    const emptyEventTypesInput = {\n+      ...mockInput,\n+      eventTypeIds: [],\n+    };\n+\n+    const result = await removeHostsFromEventTypesHandler({\n+      ctx: { user: mockUser },\n+      input: emptyEventTypesInput,\n+    });\n+\n+    expect(result).toEqual(mockDeleteResult);\n+\n+    expect(prisma.host.deleteMany).toHaveBeenCalledWith({\n+      where: {\n+        eventTypeId: {\n+          in: [],\n+        },\n+        eventType: {\n+          teamId: mockInput.teamId,\n+        },\n+        userId: {\n+          in: mockInput.userIds,\n+        },\n+      },\n+    });\n+  });\n+\n+  it(\"returns count of 0 when no hosts match the criteria\", async () => {\n+    const mockCheckPermission = vi.fn().mockResolvedValue(true);\n+    (PermissionCheckService as any).mockImplementation(() => ({\n+      checkPermission: mockCheckPermission,\n+    }));\n+\n+    // Mock that all userIds are valid team members\n+    (MembershipRepository.findAcceptedMembershipsByUserIdsInTeam as any).mockResolvedValue([\n+      { userId: 101 },\n+      { userId: 102 },\n+    ]);\n+\n+    const mockDeleteResult = { count: 0 };\n+    (prisma.host.deleteMany as any).mockResolvedValue(mockDeleteResult);\n+\n+    const result = await removeHostsFromEventTypesHandler({\n+      ctx: { user: mockUser },\n+      input: mockInput,\n+    });\n+\n+    expect(result.count).toBe(0);\n+  });\n+\n+  it(\"returns count of 0 when userId is a team member but not a host on the specified event types\", async () => {\n+    const mockCheckPermission = vi.fn().mockResolvedValue(true);\n+    (PermissionCheckService as any).mockImplementation(() => ({\n+      checkPermission: mockCheckPermission,\n+    }));\n+\n+    // User 999 is a valid team member\n+    (MembershipRepository.findAcceptedMembershipsByUserIdsInTeam as any).mockResolvedValue([\n+      { userId: 999 },\n+    ]);\n+\n+    // But they're not a host on any of the event types\n+    const mockDeleteResult = { count: 0 };\n+    (prisma.host.deleteMany as any).mockResolvedValue(mockDeleteResult);\n+\n+    const nonHostInput = {\n+      ...mockInput,\n+      userIds: [999],\n+    };\n+\n+    const result = await removeHostsFromEventTypesHandler({\n+      ctx: { user: mockUser },\n+      input: nonHostInput,\n+    });\n+\n+    expect(result.count).toBe(0);\n+\n+    expect(prisma.host.deleteMany).toHaveBeenCalledWith({\n+      where: {\n+        eventTypeId: {\n+          in: mockInput.eventTypeIds,\n+        },\n+        eventType: {\n+          teamId: mockInput.teamId,\n+        },\n+        userId: {\n+          in: [999],\n+        },\n+      },\n+    });\n+  });\n+\n+  it(\"returns count of 0 when event types do not belong to the specified team\", async () => {\n+    const mockCheckPermission = vi.fn().mockResolvedValue(true);\n+    (PermissionCheckService as any).mockImplementation(() => ({\n+      checkPermission: mockCheckPermission,\n+    }));\n+\n+    // Mock that all userIds are valid team members\n+    (MembershipRepository.findAcceptedMembershipsByUserIdsInTeam as any).mockResolvedValue([\n+      { userId: 101 },\n+      { userId: 102 },\n+    ]);\n+\n+    // Event types belong to a different team, so no hosts should be deleted\n+    const mockDeleteResult = { count: 0 };\n+    (prisma.host.deleteMany as any).mockResolvedValue(mockDeleteResult);\n+\n+    const result = await removeHostsFromEventTypesHandler({\n+      ctx: { user: mockUser },\n+      input: mockInput,\n+    });\n+\n+    expect(result.count).toBe(0);\n+\n+    // Verify the query includes the teamId check\n+    expect(prisma.host.deleteMany).toHaveBeenCalledWith({\n+      where: {\n+        eventTypeId: {\n+          in: mockInput.eventTypeIds,\n+        },\n+        eventType: {\n+          teamId: mockInput.teamId,\n+        },\n+        userId: {\n+          in: mockInput.userIds,\n+        },\n+      },\n+    });\n+  });\n+});\ndiff --git a/packages/trpc/server/routers/viewer/teams/removeHostsFromEventTypes.handler.ts b/packages/trpc/server/routers/viewer/teams/removeHostsFromEventTypes.handler.ts\nindex e819766fee8d44..ba0a7add791387 100644\n--- a/packages/trpc/server/routers/viewer/teams/removeHostsFromEventTypes.handler.ts\n+++ b/packages/trpc/server/routers/viewer/teams/removeHostsFromEventTypes.handler.ts\n@@ -1,3 +1,4 @@\n+import { MembershipRepository } from \"@calcom/features/membership/repositories/MembershipRepository\";\n import { PermissionCheckService } from \"@calcom/features/pbac/services/permission-check.service\";\n import prisma from \"@calcom/prisma\";\n import { MembershipRole } from \"@calcom/prisma/enums\";\n@@ -28,13 +29,24 @@ export async function removeHostsFromEventTypesHandler({ ctx, input }: RemoveHos\n   // check if user has permission to update event types\n   if (!hasEventTypeUpdatePermission) throw new TRPCError({ code: \"UNAUTHORIZED\" });\n \n+  // verify that all userIds are members of the team\n+  const teamMemberIds = await MembershipRepository.findAcceptedMembershipsByUserIdsInTeam({\n+    userIds,\n+    teamId,\n+  });\n+\n+  const filteredUserIds = teamMemberIds.map((teamMember) => teamMember.userId);\n+\n   return await prisma.host.deleteMany({\n     where: {\n       eventTypeId: {\n         in: eventTypeIds,\n       },\n+      eventType: {\n+        teamId: teamId,\n+      },\n       userId: {\n-        in: userIds,\n+        in: filteredUserIds,\n       },\n     },\n   });\n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/calcom__cal.com.main/pr_mirror/calcom__cal.com.main.25321/metadata__pr_25321.json"
  },
  {
    "instance_id": "calcom__cal.com.main.25326",
    "repo": "calcom/cal.com",
    "pull_number": 25326,
    "base_commit": "44311f51badd99513e0774500444da72d2230658",
    "patch": "diff --git a/packages/features/pbac/services/__tests__/role-management.factory.test.ts b/packages/features/pbac/services/__tests__/role-management.factory.test.ts\nindex 669ad39345b884..0cdf1109c44a0e 100644\n--- a/packages/features/pbac/services/__tests__/role-management.factory.test.ts\n+++ b/packages/features/pbac/services/__tests__/role-management.factory.test.ts\n@@ -1,7 +1,7 @@\n import { vi, describe, it, expect, beforeEach } from \"vitest\";\n \n import { FeaturesRepository } from \"@calcom/features/flags/features.repository\";\n-import { isOrganisationAdmin } from \"@calcom/lib/server/queries/organisations\";\n+import { isOrganisationAdmin, isOrganisationOwner } from \"@calcom/lib/server/queries/organisations\";\n import { prisma } from \"@calcom/prisma\";\n import { MembershipRole } from \"@calcom/prisma/enums\";\n \n@@ -26,6 +26,7 @@ vi.mock(\"@calcom/prisma\", () => ({\n }));\n vi.mock(\"@calcom/lib/server/queries/organisations\", () => ({\n   isOrganisationAdmin: vi.fn(),\n+  isOrganisationOwner: vi.fn(),\n }));\n \n describe(\"RoleManagementFactory\", () => {\n@@ -407,6 +408,33 @@ describe(\"RoleManagementFactory\", () => {\n           )\n         );\n       });\n+\n+      it(\"should prevent changing admin to owner\", async () => {\n+        vi.mocked(isOrganisationAdmin).mockResolvedValue({\n+          id: membershipId,\n+          userId,\n+          teamId: organizationId,\n+          role: MembershipRole.ADMIN,\n+          accepted: true,\n+          disableImpersonation: false,\n+          createdAt: new Date(),\n+          updatedAt: new Date(),\n+          customRoleId: null,\n+        });\n+        vi.mocked(isOrganisationOwner).mockResolvedValue(false);\n+        const manager = await factory.createRoleManager(organizationId);\n+        await expect(\n+          manager.checkPermissionToChangeRole(\n+            userId,\n+            organizationId,\n+            \"org\",\n+            membershipId,\n+            MembershipRole.OWNER\n+          )\n+        ).rejects.toThrow(\n+          new RoleManagementError(\"Only owners can update this role\", RoleManagementErrorCode.UNAUTHORIZED)\n+        );\n+      });\n     });\n \n     describe(\"assignRole\", () => {\ndiff --git a/packages/features/pbac/services/legacy-role-manager.service.ts b/packages/features/pbac/services/legacy-role-manager.service.ts\nindex 14e0c807cedb3c..c4c8e3ef308b9b 100644\n--- a/packages/features/pbac/services/legacy-role-manager.service.ts\n+++ b/packages/features/pbac/services/legacy-role-manager.service.ts\n@@ -1,5 +1,5 @@\n import { isTeamOwner } from \"@calcom/features/ee/teams/lib/queries\";\n-import { isOrganisationAdmin } from \"@calcom/lib/server/queries/organisations\";\n+import { isOrganisationAdmin, isOrganisationOwner } from \"@calcom/lib/server/queries/organisations\";\n import { prisma } from \"@calcom/prisma\";\n import type { Membership } from \"@calcom/prisma/client\";\n import { MembershipRole } from \"@calcom/prisma/enums\";\n@@ -73,6 +73,7 @@ export class LegacyRoleManager implements IRoleManager {\n     newRole?: MembershipRole | string\n   ): Promise<void> {\n     let hasPermission = false;\n+    const isOwnerChange = newRole === MembershipRole.OWNER;\n     if (scope === \"team\") {\n       const team = await prisma.membership.findFirst({\n         where: {\n@@ -84,13 +85,16 @@ export class LegacyRoleManager implements IRoleManager {\n       });\n       hasPermission = !!team;\n     } else {\n-      hasPermission = !!(await isOrganisationAdmin(userId, targetId));\n+      hasPermission =\n+        newRole === MembershipRole.OWNER\n+          ? !!(await isOrganisationOwner(userId, targetId))\n+          : !!(await isOrganisationAdmin(userId, targetId));\n     }\n \n     // Only OWNER/ADMIN can update role\n     if (!hasPermission) {\n       throw new RoleManagementError(\n-        \"Only owners or admin can update roles\",\n+        isOwnerChange ? \"Only owners can update this role\" : \"Only owners or admin can update roles\",\n         RoleManagementErrorCode.UNAUTHORIZED\n       );\n     }\n@@ -112,7 +116,7 @@ export class LegacyRoleManager implements IRoleManager {\n     organizationId: number,\n     role: MembershipRole | string,\n     // Used in other implementation\n-     \n+\n     _membershipId: number\n   ): Promise<void> {\n     await prisma.membership.update({\n@@ -129,7 +133,7 @@ export class LegacyRoleManager implements IRoleManager {\n   }\n \n   // Used in other implementation\n-   \n+\n   async getAllRoles(_organizationId: number): Promise<{ id: string; name: string }[]> {\n     return [\n       { id: MembershipRole.OWNER, name: \"Owner\" },\n@@ -139,7 +143,7 @@ export class LegacyRoleManager implements IRoleManager {\n   }\n \n   // Used in other implementation\n-   \n+\n   async getTeamRoles(_teamId: number): Promise<{ id: string; name: string }[]> {\n     return [\n       { id: MembershipRole.OWNER, name: \"Owner\" },\ndiff --git a/packages/trpc/server/routers/viewer/organizations/updateUser.handler.ts b/packages/trpc/server/routers/viewer/organizations/updateUser.handler.ts\nindex 049781a3c6e381..d30ebbecb0d2ca 100644\n--- a/packages/trpc/server/routers/viewer/organizations/updateUser.handler.ts\n+++ b/packages/trpc/server/routers/viewer/organizations/updateUser.handler.ts\n@@ -43,19 +43,6 @@ export const updateUserHandler = async ({ ctx, input }: UpdateUserOptions) => {\n   if (!organizationId)\n     throw new TRPCError({ code: \"UNAUTHORIZED\", message: \"You must be a member of an organizaiton\" });\n \n-  const roleManager = await RoleManagementFactory.getInstance().createRoleManager(organizationId);\n-\n-  try {\n-    await roleManager.checkPermissionToChangeRole(userId, organizationId, \"org\");\n-  } catch (error) {\n-    if (error instanceof RoleManagementError) {\n-      throw new TRPCError({ code: \"UNAUTHORIZED\", message: error.message });\n-    }\n-    throw error;\n-  }\n-\n-  await ensureOrganizationIsReviewed(organizationId);\n-\n   // Is requested user a member of the organization?\n   const requestedMember = await prisma.membership.findFirst({\n     where: {\n@@ -96,6 +83,25 @@ export const updateUserHandler = async ({ ctx, input }: UpdateUserOptions) => {\n   if (!requestedMember)\n     throw new TRPCError({ code: \"UNAUTHORIZED\", message: \"User does not belong to your organization\" });\n \n+  const roleManager = await RoleManagementFactory.getInstance().createRoleManager(organizationId);\n+\n+  try {\n+    await roleManager.checkPermissionToChangeRole(\n+      userId,\n+      organizationId,\n+      \"org\",\n+      requestedMember.id,\n+      input.role\n+    );\n+  } catch (error) {\n+    if (error instanceof RoleManagementError) {\n+      throw new TRPCError({ code: \"UNAUTHORIZED\", message: error.message });\n+    }\n+    throw error;\n+  }\n+\n+  await ensureOrganizationIsReviewed(organizationId);\n+\n   const hasUsernameUpdated = input.username !== requestedMember.user.profiles[0]?.username;\n \n   if (input.username && hasUsernameUpdated && user.profile.organization?.slug) {\n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/calcom__cal.com.main/pr_mirror/calcom__cal.com.main.25326/metadata__pr_25326.json"
  },
  {
    "instance_id": "calcom__cal.com.main.25435",
    "repo": "calcom/cal.com",
    "pull_number": 25435,
    "base_commit": "a23400777a4696afea85e2e07c090665248afbfa",
    "patch": "diff --git a/packages/features/auth/lib/next-auth-options.ts b/packages/features/auth/lib/next-auth-options.ts\nindex bab3b102745350..fedc3e958a3b9a 100644\n--- a/packages/features/auth/lib/next-auth-options.ts\n+++ b/packages/features/auth/lib/next-auth-options.ts\n@@ -15,8 +15,8 @@ import { LicenseKeySingleton } from \"@calcom/ee/common/server/LicenseKeyService\"\n import { CredentialRepository } from \"@calcom/features/credentials/repositories/CredentialRepository\";\n import createUsersAndConnectToOrg from \"@calcom/features/ee/dsync/lib/users/createUsersAndConnectToOrg\";\n import ImpersonationProvider from \"@calcom/features/ee/impersonation/lib/ImpersonationProvider\";\n-import { getOrgFullOrigin, subdomainSuffix } from \"@calcom/features/ee/organizations/lib/orgDomains\";\n import { getOrganizationRepository } from \"@calcom/features/ee/organizations/di/OrganizationRepository.container\";\n+import { getOrgFullOrigin, subdomainSuffix } from \"@calcom/features/ee/organizations/lib/orgDomains\";\n import { clientSecretVerifier, hostedCal, isSAMLLoginEnabled } from \"@calcom/features/ee/sso/lib/saml\";\n import { ProfileRepository } from \"@calcom/features/profile/repositories/ProfileRepository\";\n import { UserRepository } from \"@calcom/features/users/repositories/UserRepository\";\n@@ -962,7 +962,7 @@ export const getOptions = ({\n                 email: user.email,\n                 // Slugify the incoming name and append a few random characters to\n                 // prevent conflicts for users with the same name.\n-                username: getOrgUsernameFromEmail(user.name, getDomainFromEmail(user.email)),\n+                username: getOrgUsernameFromEmail(user.email, getDomainFromEmail(user.email)),\n                 emailVerified: new Date(Date.now()),\n                 name: user.name,\n                 identityProvider: idP,\ndiff --git a/packages/features/auth/signup/utils/getOrgUsernameFromEmail.test.ts b/packages/features/auth/signup/utils/getOrgUsernameFromEmail.test.ts\nindex 62aa8aed79b13b..d5d1cdb1af5088 100644\n--- a/packages/features/auth/signup/utils/getOrgUsernameFromEmail.test.ts\n+++ b/packages/features/auth/signup/utils/getOrgUsernameFromEmail.test.ts\n@@ -16,6 +16,30 @@ describe(\"getOrgUsernameFromEmail\", () => {\n     const result = getOrgUsernameFromEmail(email, autoAcceptEmailDomain);\n     expect(result).toBe(\"john.doe-example\");\n   });\n+\n+  it(\"should generate unique usernames for different emails even with same name\", () => {\n+    const email1 = \"alice@acme.com\";\n+    const email2 = \"alice+work@corp.com\";\n+\n+    const username1 = getOrgUsernameFromEmail(email1, null);\n+    const username2 = getOrgUsernameFromEmail(email2, null);\n+\n+    expect(username1).toBe(\"alice-acme\");\n+    expect(username2).toBe(\"alice-work-corp\");\n+    expect(username1).not.toBe(username2);\n+  });\n+\n+  it(\"should handle email with plus sign correctly\", () => {\n+    const email = \"bob+test@example.com\";\n+    const result = getOrgUsernameFromEmail(email, \"example.com\");\n+    expect(result).toBe(\"bob-test\");\n+  });\n+\n+  it(\"should handle null autoAcceptEmailDomain\", () => {\n+    const email = \"user@company.com\";\n+    const result = getOrgUsernameFromEmail(email, null);\n+    expect(result).toBe(\"user-company\");\n+  });\n });\n \n describe(\"deriveNameFromOrgUsername\", () => {\n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/calcom__cal.com.main/pr_mirror/calcom__cal.com.main.25435/metadata__pr_25435.json"
  },
  {
    "instance_id": "calcom__cal.com.main.25330",
    "repo": "calcom/cal.com",
    "pull_number": 25330,
    "base_commit": "0af77be1272bc5b64961e639fe0ee20b040d2abd",
    "patch": "diff --git a/packages/trpc/server/routers/viewer/teams/inviteMember/inviteMemberUtils.test.ts b/packages/trpc/server/routers/viewer/teams/inviteMember/inviteMemberUtils.test.ts\nindex 04a71d338012b2..d1952ee36e3263 100644\n--- a/packages/trpc/server/routers/viewer/teams/inviteMember/inviteMemberUtils.test.ts\n+++ b/packages/trpc/server/routers/viewer/teams/inviteMember/inviteMemberUtils.test.ts\n@@ -1,4 +1,4 @@\n-import { describe, it, vi, expect } from \"vitest\";\n+import { describe, it, vi, expect, beforeEach } from \"vitest\";\n \n import { PermissionCheckService } from \"@calcom/features/pbac/services/permission-check.service\";\n import { MembershipRole } from \"@calcom/prisma/enums\";\n@@ -16,11 +16,21 @@ import {\n   canBeInvited,\n   getAutoJoinStatus,\n   checkInputEmailIsValid,\n+  createMemberships,\n } from \"./utils\";\n \n+const { mockCreateMany } = vi.hoisted(() => {\n+  const mockCreateManyFn = vi.fn();\n+  return { mockCreateMany: mockCreateManyFn };\n+});\n+\n vi.mock(\"@calcom/prisma\", () => {\n   return {\n-    prisma: vi.fn(),\n+    prisma: {\n+      membership: {\n+        createMany: mockCreateMany,\n+      },\n+    },\n   };\n });\n \n@@ -37,6 +47,27 @@ vi.mock(\"@calcom/features/pbac/services/permission-check.service\", () => {\n   };\n });\n \n+vi.mock(\"@calcom/lib/logger\", () => {\n+  const mockSubLogger = {\n+    debug: vi.fn(),\n+    error: vi.fn(),\n+    log: vi.fn(),\n+    warn: vi.fn(),\n+    info: vi.fn(),\n+    getSubLogger: vi.fn(() => mockSubLogger),\n+  };\n+  return {\n+    default: {\n+      getSubLogger: vi.fn(() => mockSubLogger),\n+      error: vi.fn(),\n+      debug: vi.fn(),\n+      log: vi.fn(),\n+      warn: vi.fn(),\n+      info: vi.fn(),\n+    },\n+  };\n+});\n+\n const mockedRegularTeam: TeamWithParent = {\n   id: 1,\n   name: \"Team A\",\n@@ -609,6 +640,178 @@ describe(\"Invite Member Utils\", () => {\n       });\n     });\n   });\n+\n+  describe(\"createMemberships - Privilege Escalation Prevention\", () => {\n+    beforeEach(() => {\n+      mockCreateMany.mockClear();\n+      mockCreateMany.mockResolvedValue({ count: 0 });\n+    });\n+\n+    it(\"should NOT escalate privilege when attacker has OWNER role in unrelated team\", async () => {\n+      const attackerTeamId = 999; // Attacker's personal team\n+      const victimTeamId = 100; // Victim team being invited to\n+      const victimOrgId = 200; // Parent organization of victim team\n+\n+      const attacker: UserWithMembership & {\n+        newRole: MembershipRole;\n+        needToCreateOrgMembership: boolean | null;\n+      } = {\n+        ...mockUser,\n+        id: 1,\n+        email: \"attacker@example.com\",\n+        username: \"attacker\",\n+        teams: [\n+          // Attacker controls this - OWNER role in their personal team (first in array)\n+          { teamId: attackerTeamId, userId: 1, accepted: true, role: MembershipRole.OWNER },\n+          // Some other unrelated membership\n+          { teamId: 50, userId: 1, accepted: true, role: MembershipRole.MEMBER },\n+        ],\n+        newRole: MembershipRole.MEMBER, // Inviter wants to invite as MEMBER\n+        needToCreateOrgMembership: true,\n+      };\n+\n+      await createMemberships({\n+        teamId: victimTeamId,\n+        language: \"en\",\n+        invitees: [attacker],\n+        parentId: victimOrgId,\n+        accepted: false,\n+      });\n+\n+      // Verify createMany was called\n+      expect(mockCreateMany).toHaveBeenCalledTimes(1);\n+\n+      // Get the data that was passed to createMany\n+      const callArgs = mockCreateMany.mock.calls[0][0];\n+      const createdMemberships = callArgs.data;\n+\n+      // Should create 2 memberships: one for team, one for org\n+      expect(createdMemberships).toHaveLength(2);\n+\n+      // Check team membership - should be MEMBER (inviter's choice), NOT OWNER\n+      const teamMembership = createdMemberships.find((m: any) => m.teamId === victimTeamId);\n+      expect(teamMembership).toBeDefined();\n+      expect(teamMembership.role).toBe(MembershipRole.MEMBER);\n+      expect(teamMembership.userId).toBe(attacker.id);\n+      expect(teamMembership.accepted).toBe(false);\n+\n+      // Check org membership\n+      const orgMembership = createdMemberships.find((m: any) => m.teamId === victimOrgId);\n+      expect(orgMembership).toBeDefined();\n+      expect(orgMembership.role).toBe(MembershipRole.MEMBER);\n+    });\n+\n+    it(\"should preserve ADMIN role when user is already ADMIN in parent organization\", async () => {\n+      const teamId = 100;\n+      const parentOrgId = 200;\n+\n+      const existingAdmin: UserWithMembership & {\n+        newRole: MembershipRole;\n+        needToCreateOrgMembership: boolean | null;\n+      } = {\n+        ...mockUser,\n+        id: 2,\n+        email: \"admin@example.com\",\n+        username: \"admin\",\n+        teams: [\n+          // User is already ADMIN in the parent org\n+          { teamId: parentOrgId, userId: 2, accepted: true, role: MembershipRole.ADMIN },\n+        ],\n+        newRole: MembershipRole.MEMBER, // Inviter wants MEMBER, but should preserve ADMIN\n+        needToCreateOrgMembership: false, // Already has org membership\n+      };\n+\n+      await createMemberships({\n+        teamId,\n+        language: \"en\",\n+        invitees: [existingAdmin],\n+        parentId: parentOrgId,\n+        accepted: true,\n+      });\n+\n+      const callArgs = mockCreateMany.mock.calls[0][0];\n+      const createdMemberships = callArgs.data;\n+\n+      // Should only create team membership (org membership already exists)\n+      expect(createdMemberships).toHaveLength(1);\n+\n+      // Should preserve ADMIN role since user is ADMIN in parent org\n+      const teamMembership = createdMemberships.find((m: any) => m.teamId === teamId);\n+      expect(teamMembership.role).toBe(MembershipRole.ADMIN);\n+    });\n+\n+    it(\"should use inviter's role when user has no membership in parent organization\", async () => {\n+      const teamId = 100;\n+      const parentOrgId = 200;\n+      const unrelatedTeamId = 999;\n+\n+      const user: UserWithMembership & {\n+        newRole: MembershipRole;\n+        needToCreateOrgMembership: boolean | null;\n+      } = {\n+        ...mockUser,\n+        id: 3,\n+        email: \"user@example.com\",\n+        username: \"user\",\n+        teams: [\n+          // User has OWNER in unrelated team, but NOT in parent org\n+          { teamId: unrelatedTeamId, userId: 3, accepted: true, role: MembershipRole.OWNER },\n+        ],\n+        newRole: MembershipRole.MEMBER,\n+        needToCreateOrgMembership: true,\n+      };\n+\n+      await createMemberships({\n+        teamId,\n+        language: \"en\",\n+        invitees: [user],\n+        parentId: parentOrgId,\n+        accepted: false,\n+      });\n+\n+      const callArgs = mockCreateMany.mock.calls[0][0];\n+      const createdMemberships = callArgs.data;\n+\n+      const teamMembership = createdMemberships.find((m: any) => m.teamId === teamId);\n+      // Should use inviter's chosen role (MEMBER), not OWNER from unrelated team\n+      expect(teamMembership.role).toBe(MembershipRole.MEMBER);\n+    });\n+\n+    it(\"should use inviter's role when inviting to team without parent organization\", async () => {\n+      const teamId = 100;\n+\n+      const user: UserWithMembership & {\n+        newRole: MembershipRole;\n+        needToCreateOrgMembership: boolean | null;\n+      } = {\n+        ...mockUser,\n+        id: 4,\n+        email: \"user2@example.com\",\n+        username: \"user2\",\n+        teams: [\n+          // User has OWNER in unrelated team\n+          { teamId: 999, userId: 4, accepted: true, role: MembershipRole.OWNER },\n+        ],\n+        newRole: MembershipRole.MEMBER,\n+        needToCreateOrgMembership: null,\n+      };\n+\n+      await createMemberships({\n+        teamId,\n+        language: \"en\",\n+        invitees: [user],\n+        parentId: null, // No parent org\n+        accepted: false,\n+      });\n+\n+      const callArgs = mockCreateMany.mock.calls[0][0];\n+      const createdMemberships = callArgs.data;\n+\n+      expect(createdMemberships).toHaveLength(1);\n+      // Should use inviter's chosen role when no parentId\n+      expect(createdMemberships[0].role).toBe(MembershipRole.MEMBER);\n+    });\n+  });\n });\n function getSampleProfile({ organizationId }: { organizationId?: number } = {}): {\n   id: number;\ndiff --git a/packages/trpc/server/routers/viewer/teams/inviteMember/utils.ts b/packages/trpc/server/routers/viewer/teams/inviteMember/utils.ts\nindex d00bf42f9c0333..0bf2ae50705264 100644\n--- a/packages/trpc/server/routers/viewer/teams/inviteMember/utils.ts\n+++ b/packages/trpc/server/routers/viewer/teams/inviteMember/utils.ts\n@@ -5,11 +5,11 @@ import { getOrgFullOrigin } from \"@calcom/ee/organizations/lib/orgDomains\";\n import { sendTeamInviteEmail } from \"@calcom/emails/organization-email-service\";\n import { checkAdminOrOwner } from \"@calcom/features/auth/lib/checkAdminOrOwner\";\n import { updateNewTeamMemberEventTypes } from \"@calcom/features/ee/teams/lib/queries\";\n+import { OnboardingPathService } from \"@calcom/features/onboarding/lib/onboarding-path.service\";\n import { PermissionCheckService } from \"@calcom/features/pbac/services/permission-check.service\";\n import { createAProfileForAnExistingUser } from \"@calcom/features/profile/lib/createAProfileForAnExistingUser\";\n import { ProfileRepository } from \"@calcom/features/profile/repositories/ProfileRepository\";\n import { UserRepository } from \"@calcom/features/users/repositories/UserRepository\";\n-import { OnboardingPathService } from \"@calcom/features/onboarding/lib/onboarding-path.service\";\n import { DEFAULT_SCHEDULE, getAvailabilityFromSchedule } from \"@calcom/lib/availability\";\n import { ENABLE_PROFILE_SWITCHER, WEBAPP_URL } from \"@calcom/lib/constants\";\n import logger from \"@calcom/lib/logger\";\n@@ -437,7 +437,9 @@ export async function createMemberships({\n   try {\n     await prisma.membership.createMany({\n       data: invitees.flatMap((invitee) => {\n-        const organizationRole = invitee?.teams?.[0]?.role;\n+        const organizationRole = parentId\n+          ? invitee?.teams?.find((membership) => membership.teamId === parentId)?.role\n+          : undefined;\n         const data = [];\n         const createdAt = new Date();\n         // membership for the team\n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/calcom__cal.com.main/pr_mirror/calcom__cal.com.main.25330/metadata__pr_25330.json"
  },
  {
    "instance_id": "calcom__cal.com.main.25502",
    "repo": "calcom/cal.com",
    "pull_number": 25502,
    "base_commit": "41ad0f718dcda69d502b28302571741470672e05",
    "patch": "diff --git a/packages/features/calendar-subscription/lib/CalendarSubscriptionService.ts b/packages/features/calendar-subscription/lib/CalendarSubscriptionService.ts\nindex 236a718392a33d..6dfc3ae7031e8d 100644\n--- a/packages/features/calendar-subscription/lib/CalendarSubscriptionService.ts\n+++ b/packages/features/calendar-subscription/lib/CalendarSubscriptionService.ts\n@@ -12,7 +12,7 @@ import type { CalendarSyncService } from \"@calcom/features/calendar-subscription\n import type { FeaturesRepository } from \"@calcom/features/flags/features.repository\";\n import logger from \"@calcom/lib/logger\";\n import type { ISelectedCalendarRepository } from \"@calcom/lib/server/repository/SelectedCalendarRepository.interface\";\n-import { SelectedCalendar } from \"@calcom/prisma/client\";\n+import type { SelectedCalendar } from \"@calcom/prisma/client\";\n \n const log = logger.getSubLogger({ prefix: [\"CalendarSubscriptionService\"] });\n \n@@ -204,9 +204,14 @@ export class CalendarSubscriptionService {\n    * Subscribe periodically to new calendars\n    */\n   async checkForNewSubscriptions() {\n+    const teamIds = await this.deps.featuresRepository.getTeamsWithFeatureEnabled(\n+      CalendarSubscriptionService.CALENDAR_SUBSCRIPTION_CACHE_FEATURE\n+    );\n+\n     const rows = await this.deps.selectedCalendarRepository.findNextSubscriptionBatch({\n       take: 100,\n       integrations: this.deps.adapterFactory.getProviders(),\n+      teamIds,\n     });\n     log.debug(\"checkForNewSubscriptions\", { count: rows.length });\n     await Promise.allSettled(rows.map(({ id }) => this.subscribe(id)));\ndiff --git a/packages/features/calendar-subscription/lib/__tests__/CalendarSubscriptionService.test.ts b/packages/features/calendar-subscription/lib/__tests__/CalendarSubscriptionService.test.ts\nindex a1081a2b1aaa3c..459b870a568b71 100644\n--- a/packages/features/calendar-subscription/lib/__tests__/CalendarSubscriptionService.test.ts\n+++ b/packages/features/calendar-subscription/lib/__tests__/CalendarSubscriptionService.test.ts\n@@ -125,6 +125,8 @@ describe(\"CalendarSubscriptionService\", () => {\n     mockFeaturesRepository = {\n       checkIfFeatureIsEnabledGlobally: vi.fn().mockResolvedValue(true),\n       checkIfUserHasFeature: vi.fn().mockResolvedValue(true),\n+      checkIfTeamHasFeature: vi.fn().mockResolvedValue(true),\n+      getTeamsWithFeatureEnabled: vi.fn().mockResolvedValue([1, 2, 3]),\n     };\n \n     mockCalendarCacheEventService = {\n@@ -376,12 +378,94 @@ describe(\"CalendarSubscriptionService\", () => {\n \n       await service.checkForNewSubscriptions();\n \n+      expect(mockFeaturesRepository.getTeamsWithFeatureEnabled).toHaveBeenCalledWith(\n+        \"calendar-subscription-cache\"\n+      );\n       expect(mockSelectedCalendarRepository.findNextSubscriptionBatch).toHaveBeenCalledWith({\n         take: 100,\n         integrations: [\"google_calendar\", \"office365_calendar\"],\n+        teamIds: [1, 2, 3],\n       });\n       expect(subscribeSpy).toHaveBeenCalledWith(mockSelectedCalendar.id);\n     });\n+\n+    test(\"should handle mixed cache scenario where some teams have cache enabled and some do not\", async () => {\n+      const calendarWithCache = { ...mockSelectedCalendar, id: \"calendar-with-cache\", userId: 1 };\n+      const calendarWithCache2 = { ...mockSelectedCalendar, id: \"calendar-with-cache-2\", userId: 2 };\n+\n+      mockFeaturesRepository.getTeamsWithFeatureEnabled.mockResolvedValue([10, 20]);\n+\n+      mockSelectedCalendarRepository.findNextSubscriptionBatch.mockResolvedValue([\n+        calendarWithCache,\n+        calendarWithCache2,\n+      ]);\n+\n+      const subscribeSpy = vi.spyOn(service, \"subscribe\").mockResolvedValue(undefined);\n+\n+      await service.checkForNewSubscriptions();\n+\n+      expect(mockFeaturesRepository.getTeamsWithFeatureEnabled).toHaveBeenCalledWith(\n+        \"calendar-subscription-cache\"\n+      );\n+      expect(mockSelectedCalendarRepository.findNextSubscriptionBatch).toHaveBeenCalledWith({\n+        take: 100,\n+        integrations: [\"google_calendar\", \"office365_calendar\"],\n+        teamIds: [10, 20],\n+      });\n+      expect(subscribeSpy).toHaveBeenCalledTimes(2);\n+      expect(subscribeSpy).toHaveBeenCalledWith(\"calendar-with-cache\");\n+      expect(subscribeSpy).toHaveBeenCalledWith(\"calendar-with-cache-2\");\n+    });\n+\n+    test(\"should only fetch calendars for teams with feature enabled, not entire organization hierarchy\", async () => {\n+      const teamId = 100;\n+      const parentOrgId = 1;\n+\n+      mockFeaturesRepository.getTeamsWithFeatureEnabled.mockResolvedValue([teamId]);\n+\n+      const calendarForTeamMember = { ...mockSelectedCalendar, id: \"team-member-calendar\", userId: 5 };\n+      mockSelectedCalendarRepository.findNextSubscriptionBatch.mockResolvedValue([calendarForTeamMember]);\n+\n+      const subscribeSpy = vi.spyOn(service, \"subscribe\").mockResolvedValue(undefined);\n+\n+      await service.checkForNewSubscriptions();\n+\n+      expect(mockFeaturesRepository.getTeamsWithFeatureEnabled).toHaveBeenCalledWith(\n+        \"calendar-subscription-cache\"\n+      );\n+      expect(mockSelectedCalendarRepository.findNextSubscriptionBatch).toHaveBeenCalledWith({\n+        take: 100,\n+        integrations: [\"google_calendar\", \"office365_calendar\"],\n+        teamIds: [teamId],\n+      });\n+      expect(mockSelectedCalendarRepository.findNextSubscriptionBatch).not.toHaveBeenCalledWith(\n+        expect.objectContaining({\n+          teamIds: expect.arrayContaining([parentOrgId]),\n+        })\n+      );\n+      expect(subscribeSpy).toHaveBeenCalledTimes(1);\n+      expect(subscribeSpy).toHaveBeenCalledWith(\"team-member-calendar\");\n+    });\n+\n+    test(\"should not process any calendars when no teams have the feature enabled\", async () => {\n+      mockFeaturesRepository.getTeamsWithFeatureEnabled.mockResolvedValue([]);\n+\n+      mockSelectedCalendarRepository.findNextSubscriptionBatch.mockResolvedValue([]);\n+\n+      const subscribeSpy = vi.spyOn(service, \"subscribe\").mockResolvedValue(undefined);\n+\n+      await service.checkForNewSubscriptions();\n+\n+      expect(mockFeaturesRepository.getTeamsWithFeatureEnabled).toHaveBeenCalledWith(\n+        \"calendar-subscription-cache\"\n+      );\n+      expect(mockSelectedCalendarRepository.findNextSubscriptionBatch).toHaveBeenCalledWith({\n+        take: 100,\n+        integrations: [\"google_calendar\", \"office365_calendar\"],\n+        teamIds: [],\n+      });\n+      expect(subscribeSpy).not.toHaveBeenCalled();\n+    });\n   });\n \n   describe(\"feature flag methods\", () => {\ndiff --git a/packages/features/flags/features.repository.interface.ts b/packages/features/flags/features.repository.interface.ts\nindex 60fa9a7f9d1e16..782714d4d9284d 100644\n--- a/packages/features/flags/features.repository.interface.ts\n+++ b/packages/features/flags/features.repository.interface.ts\n@@ -4,4 +4,5 @@ export interface IFeaturesRepository {\n   checkIfFeatureIsEnabledGlobally(slug: keyof AppFlags): Promise<boolean>;\n   checkIfUserHasFeature(userId: number, slug: string): Promise<boolean>;\n   checkIfTeamHasFeature(teamId: number, slug: keyof AppFlags): Promise<boolean>;\n+  getTeamsWithFeatureEnabled(slug: keyof AppFlags): Promise<number[]>;\n }\ndiff --git a/packages/features/flags/features.repository.ts b/packages/features/flags/features.repository.ts\nindex b6df40504e82c0..48e3bd010470b6 100644\n--- a/packages/features/flags/features.repository.ts\n+++ b/packages/features/flags/features.repository.ts\n@@ -351,4 +351,23 @@ export class FeaturesRepository implements IFeaturesRepository {\n       throw err;\n     }\n   }\n+\n+  async getTeamsWithFeatureEnabled(slug: keyof AppFlags): Promise<number[]> {\n+    try {\n+      // If globally disabled, treat as effectively disabled everywhere\n+      const isGloballyEnabled = await this.checkIfFeatureIsEnabledGlobally(slug);\n+      if (!isGloballyEnabled) return [];\n+\n+      const rows = await this.prismaClient.teamFeatures.findMany({\n+        where: { featureId: slug },\n+        select: { teamId: true },\n+        orderBy: { teamId: \"asc\" },\n+      });\n+\n+      return rows.map((r) => r.teamId);\n+    } catch (err) {\n+      captureException(err);\n+      throw err;\n+    }\n+  }\n }\ndiff --git a/packages/lib/server/repository/SelectedCalendarRepository.interface.ts b/packages/lib/server/repository/SelectedCalendarRepository.interface.ts\nindex 55b49b7b5ecebd..2d119385175042 100644\n--- a/packages/lib/server/repository/SelectedCalendarRepository.interface.ts\n+++ b/packages/lib/server/repository/SelectedCalendarRepository.interface.ts\n@@ -24,9 +24,11 @@ export interface ISelectedCalendarRepository {\n    */\n   findNextSubscriptionBatch({\n     take,\n+    teamIds,\n     integrations,\n   }: {\n     take: number;\n+    teamIds: number[];\n     integrations?: string[];\n   }): Promise<SelectedCalendar[]>;\n \ndiff --git a/packages/lib/server/repository/SelectedCalendarRepository.ts b/packages/lib/server/repository/SelectedCalendarRepository.ts\nindex b40cfc70a37b57..716a35e646c42b 100644\n--- a/packages/lib/server/repository/SelectedCalendarRepository.ts\n+++ b/packages/lib/server/repository/SelectedCalendarRepository.ts\n@@ -15,26 +15,24 @@ export class SelectedCalendarRepository implements ISelectedCalendarRepository {\n     return this.prismaClient.selectedCalendar.findFirst({ where: { channelId } });\n   }\n \n-  async findNextSubscriptionBatch({ take, integrations }: { take: number; integrations: string[] }) {\n+  async findNextSubscriptionBatch({\n+    take,\n+    teamIds,\n+    integrations,\n+  }: {\n+    take: number;\n+    teamIds: number[];\n+    integrations: string[];\n+  }) {\n     return this.prismaClient.selectedCalendar.findMany({\n       where: {\n         integration: { in: integrations },\n         OR: [{ syncSubscribedAt: null }, { channelExpiration: { lte: new Date() } }],\n-        // initially we will run subscription only for teams that have\n-        // the feature flags enabled and it should be removed later\n         user: {\n           teams: {\n             some: {\n-              team: {\n-                features: {\n-                  some: {\n-                    OR: [\n-                      { featureId: \"calendar-subscription-cache\" },\n-                      { featureId: \"calendar-subscription-sync\" },\n-                    ],\n-                  },\n-                },\n-              },\n+              teamId: { in: teamIds },\n+              accepted: true,\n             },\n           },\n         },\ndiff --git a/packages/lib/server/repository/__tests__/SelectedCalendarRepository.test.ts b/packages/lib/server/repository/__tests__/SelectedCalendarRepository.test.ts\nindex d649c6da1754d6..ac1b8153a7335d 100644\n--- a/packages/lib/server/repository/__tests__/SelectedCalendarRepository.test.ts\n+++ b/packages/lib/server/repository/__tests__/SelectedCalendarRepository.test.ts\n@@ -116,6 +116,7 @@ describe(\"SelectedCalendarRepository\", () => {\n \n       const result = await repository.findNextSubscriptionBatch({\n         take: 10,\n+        teamIds: [1, 2, 3],\n         integrations: [\"google_calendar\", \"office365_calendar\"],\n       });\n \n@@ -126,16 +127,8 @@ describe(\"SelectedCalendarRepository\", () => {\n           user: {\n             teams: {\n               some: {\n-                team: {\n-                  features: {\n-                    some: {\n-                      OR: [\n-                        { featureId: \"calendar-subscription-cache\" },\n-                        { featureId: \"calendar-subscription-sync\" },\n-                      ],\n-                    },\n-                  },\n-                },\n+                teamId: { in: [1, 2, 3] },\n+                accepted: true,\n               },\n             },\n           },\n@@ -152,6 +145,7 @@ describe(\"SelectedCalendarRepository\", () => {\n \n       const result = await repository.findNextSubscriptionBatch({\n         take: 5,\n+        teamIds: [10, 20],\n         integrations: [],\n       });\n \n@@ -162,16 +156,8 @@ describe(\"SelectedCalendarRepository\", () => {\n           user: {\n             teams: {\n               some: {\n-                team: {\n-                  features: {\n-                    some: {\n-                      OR: [\n-                        { featureId: \"calendar-subscription-cache\" },\n-                        { featureId: \"calendar-subscription-sync\" },\n-                      ],\n-                    },\n-                  },\n-                },\n+                teamId: { in: [10, 20] },\n+                accepted: true,\n               },\n             },\n           },\n@@ -181,6 +167,35 @@ describe(\"SelectedCalendarRepository\", () => {\n \n       expect(result).toEqual(mockCalendars);\n     });\n+\n+    test(\"should handle empty teamIds array\", async () => {\n+      const mockCalendars: SelectedCalendar[] = [];\n+      vi.mocked(mockPrismaClient.selectedCalendar.findMany).mockResolvedValue(mockCalendars);\n+\n+      const result = await repository.findNextSubscriptionBatch({\n+        take: 10,\n+        teamIds: [],\n+        integrations: [\"google_calendar\"],\n+      });\n+\n+      expect(mockPrismaClient.selectedCalendar.findMany).toHaveBeenCalledWith({\n+        where: {\n+          integration: { in: [\"google_calendar\"] },\n+          OR: [{ syncSubscribedAt: null }, { channelExpiration: { lte: expect.any(Date) } }],\n+          user: {\n+            teams: {\n+              some: {\n+                teamId: { in: [] },\n+                accepted: true,\n+              },\n+            },\n+          },\n+        },\n+        take: 10,\n+      });\n+\n+      expect(result).toEqual(mockCalendars);\n+    });\n   });\n \n   describe(\"updateSyncStatus\", () => {\n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/calcom__cal.com.main/pr_mirror/calcom__cal.com.main.25502/metadata__pr_25502.json"
  },
  {
    "instance_id": "calcom__cal.com.main.25314",
    "repo": "calcom/cal.com",
    "pull_number": 25314,
    "base_commit": "3c8215add3f250b44d98700795dc40ade280ecbb",
    "patch": "diff --git a/packages/features/ee/dsync/lib/handleUserEvents.test.ts b/packages/features/ee/dsync/lib/handleUserEvents.test.ts\nnew file mode 100644\nindex 00000000000000..fd4cf4eae5421b\n--- /dev/null\n+++ b/packages/features/ee/dsync/lib/handleUserEvents.test.ts\n@@ -0,0 +1,433 @@\n+import prismock from \"../../../../../tests/libs/__mocks__/prisma\";\n+\n+import type { DirectorySyncEvent } from \"@boxyhq/saml-jackson\";\n+import { describe, expect, it, vi, beforeEach } from \"vitest\";\n+\n+import { IdentityProvider, MembershipRole } from \"@calcom/prisma/enums\";\n+\n+import handleUserEvents from \"./handleUserEvents\";\n+\n+vi.mock(\"@calcom/lib/logger\", () => ({\n+  default: {\n+    getSubLogger: () => ({\n+      debug: vi.fn(),\n+      error: vi.fn(),\n+      warn: vi.fn(),\n+    }),\n+  },\n+}));\n+\n+vi.mock(\"@calcom/lib/server/i18n\", () => ({\n+  getTranslation: vi.fn().mockResolvedValue((key: string) => key),\n+}));\n+\n+vi.mock(\"@calcom/trpc/server/routers/viewer/teams/inviteMember/utils\", () => ({\n+  getTeamOrThrow: vi.fn(),\n+  sendExistingUserTeamInviteEmails: vi.fn(),\n+  sendSignupToOrganizationEmail: vi.fn(),\n+}));\n+\n+vi.mock(\"./assignValueToUser\", () => ({\n+  assignValueToUserInOrgBulk: vi.fn(),\n+}));\n+\n+vi.mock(\"./users/createUsersAndConnectToOrg\", () => ({\n+  default: vi.fn(),\n+}));\n+\n+vi.mock(\"./users/inviteExistingUserToOrg\", () => ({\n+  default: vi.fn().mockResolvedValue({\n+    id: 1,\n+    username: \"testuser\",\n+    email: \"test@example.com\",\n+  }),\n+}));\n+\n+vi.mock(\"./removeUserFromOrg\", () => ({\n+  default: vi.fn(),\n+}));\n+\n+vi.mock(\"@calcom/features/users/repositories/UserRepository\", () => ({\n+  UserRepository: vi.fn().mockImplementation(() => ({\n+    isAMemberOfOrganization: vi.fn().mockResolvedValue(false),\n+  })),\n+}));\n+\n+async function createMockOrganization({ id, name, slug }: { id: number; name: string; slug: string }) {\n+  return prismock.team.create({\n+    data: {\n+      id,\n+      name,\n+      slug,\n+      isOrganization: true,\n+    },\n+  });\n+}\n+\n+async function createMockUser({ email, organizationId }: { email: string; organizationId: number | null }) {\n+  return prismock.user.create({\n+    data: {\n+      email,\n+      username: email.split(\"@\")[0],\n+      organizationId,\n+      completedOnboarding: true,\n+      identityProvider: IdentityProvider.CAL,\n+      locale: \"en\",\n+    },\n+  });\n+}\n+\n+async function createMockMembership({\n+  userId,\n+  teamId,\n+  role = MembershipRole.MEMBER,\n+}: {\n+  userId: number;\n+  teamId: number;\n+  role?: MembershipRole;\n+}) {\n+  return prismock.membership.create({\n+    data: {\n+      userId,\n+      teamId,\n+      role,\n+      accepted: true,\n+      disableImpersonation: false,\n+    },\n+  });\n+}\n+\n+describe(\"handleUserEvents\", () => {\n+  const directoryId = \"test-directory-id\";\n+  const organizationId = 1001;\n+  const organizationName = \"Test Organization\";\n+  const organizationSlug = \"test-org\";\n+\n+  beforeEach(async () => {\n+    vi.clearAllMocks();\n+\n+    await createMockOrganization({\n+      id: organizationId,\n+      name: organizationName,\n+      slug: organizationSlug,\n+    });\n+\n+    const { getTeamOrThrow } = await import(\"@calcom/trpc/server/routers/viewer/teams/inviteMember/utils\");\n+    vi.mocked(getTeamOrThrow).mockResolvedValue({\n+      id: organizationId,\n+      name: organizationName,\n+      slug: organizationSlug,\n+      isOrganization: true,\n+      parent: null,\n+      parentId: null,\n+      metadata: null,\n+    } as Awaited<ReturnType<typeof getTeamOrThrow>>);\n+  });\n+\n+  describe(\"Cross-tenant hijack prevention\", () => {\n+    it(\"should throw an error when user belongs to a different organization\", async () => {\n+      const userEmail = \"user@example.com\";\n+      const differentOrgId = 2002;\n+\n+      await createMockOrganization({\n+        id: differentOrgId,\n+        name: \"Different Organization\",\n+        slug: \"different-org\",\n+      });\n+\n+      await createMockUser({\n+        email: userEmail,\n+        organizationId: 9999,\n+      });\n+\n+      const event: DirectorySyncEvent = {\n+        event: \"user.created\",\n+        tenant: \"test-tenant\",\n+        directory_id: directoryId,\n+        data: {\n+          id: \"user-123\",\n+          email: userEmail,\n+          first_name: \"Test\",\n+          last_name: \"User\",\n+          active: true,\n+          raw: {\n+            schemas: [],\n+          },\n+        },\n+      };\n+\n+      await expect(handleUserEvents(event, organizationId)).rejects.toThrow(\n+        \"User belongs to another organization.\"\n+      );\n+    });\n+\n+    it(\"should succeed when user belongs to the correct organization\", async () => {\n+      const userEmail = \"user@example.com\";\n+\n+      const user = await createMockUser({\n+        email: userEmail,\n+        organizationId: organizationId,\n+      });\n+\n+      await createMockMembership({\n+        userId: user.id,\n+        teamId: organizationId,\n+      });\n+\n+      const event: DirectorySyncEvent = {\n+        event: \"user.created\",\n+        tenant: \"test-tenant\",\n+        directory_id: directoryId,\n+        data: {\n+          id: \"user-123\",\n+          email: userEmail,\n+          first_name: \"Test\",\n+          last_name: \"User\",\n+          active: true,\n+          raw: {\n+            schemas: [],\n+          },\n+        },\n+      };\n+\n+      const { UserRepository } = await import(\"@calcom/features/users/repositories/UserRepository\");\n+      vi.mocked(UserRepository).mockImplementation(\n+        () =>\n+          ({\n+            isAMemberOfOrganization: vi.fn().mockResolvedValue(true),\n+          } as unknown as InstanceType<typeof UserRepository>)\n+      );\n+\n+      await expect(handleUserEvents(event, organizationId)).resolves.not.toThrow();\n+    });\n+\n+    it(\"should pass when user has no organizationId (allow existing user to be added to an org)\", async () => {\n+      const userEmail = \"legacy@example.com\";\n+\n+      await createMockUser({\n+        email: userEmail,\n+        organizationId: null,\n+      });\n+\n+      const event: DirectorySyncEvent = {\n+        event: \"user.created\",\n+        tenant: \"test-tenant\",\n+        directory_id: directoryId,\n+        data: {\n+          id: \"user-123\",\n+          email: userEmail,\n+          first_name: \"Legacy\",\n+          last_name: \"User\",\n+          active: true,\n+          raw: {\n+            schemas: [],\n+          },\n+        },\n+      };\n+\n+      await expect(handleUserEvents(event, organizationId)).resolves.toBeUndefined();\n+    });\n+\n+    it(\"should succeed when user does not exist yet (new user creation)\", async () => {\n+      const userEmail = \"newuser@example.com\";\n+\n+      const event: DirectorySyncEvent = {\n+        event: \"user.created\",\n+        tenant: \"test-tenant\",\n+        directory_id: directoryId,\n+        data: {\n+          id: \"user-123\",\n+          email: userEmail,\n+          first_name: \"New\",\n+          last_name: \"User\",\n+          active: true,\n+          raw: {\n+            schemas: [],\n+          },\n+        },\n+      };\n+\n+      const createUsersAndConnectToOrg = (await import(\"./users/createUsersAndConnectToOrg\")).default;\n+      vi.mocked(createUsersAndConnectToOrg).mockResolvedValue(undefined);\n+\n+      await expect(handleUserEvents(event, organizationId)).resolves.not.toThrow();\n+\n+      expect(createUsersAndConnectToOrg).toHaveBeenCalledWith({\n+        createUsersAndConnectToOrgProps: {\n+          emailsToCreate: [userEmail],\n+          identityProvider: IdentityProvider.CAL,\n+          identityProviderId: null,\n+        },\n+        org: expect.objectContaining({\n+          id: organizationId,\n+          name: organizationName,\n+        }),\n+      });\n+    });\n+  });\n+\n+  describe(\"User activation and deactivation\", () => {\n+    it(\"should invite existing user when active is true and user is not a member\", async () => {\n+      const userEmail = \"user@example.com\";\n+\n+      await createMockUser({\n+        email: userEmail,\n+        organizationId: organizationId,\n+      });\n+\n+      const event: DirectorySyncEvent = {\n+        event: \"user.updated\",\n+        tenant: \"test-tenant\",\n+        directory_id: directoryId,\n+        data: {\n+          id: \"user-123\",\n+          email: userEmail,\n+          first_name: \"Test\",\n+          last_name: \"User\",\n+          active: true,\n+          raw: {\n+            schemas: [],\n+          },\n+        },\n+      };\n+\n+      const { UserRepository } = await import(\"@calcom/features/users/repositories/UserRepository\");\n+      vi.mocked(UserRepository).mockImplementation(\n+        () =>\n+          ({\n+            isAMemberOfOrganization: vi.fn().mockResolvedValue(false),\n+          } as unknown as InstanceType<typeof UserRepository>)\n+      );\n+\n+      const inviteExistingUserToOrg = (await import(\"./users/inviteExistingUserToOrg\")).default;\n+      const sendExistingUserTeamInviteEmails = (\n+        await import(\"@calcom/trpc/server/routers/viewer/teams/inviteMember/utils\")\n+      ).sendExistingUserTeamInviteEmails;\n+\n+      await handleUserEvents(event, organizationId);\n+\n+      expect(inviteExistingUserToOrg).toHaveBeenCalled();\n+      expect(sendExistingUserTeamInviteEmails).toHaveBeenCalled();\n+    });\n+\n+    it(\"should remove user from organization when active is false\", async () => {\n+      const userEmail = \"user@example.com\";\n+\n+      const user = await createMockUser({\n+        email: userEmail,\n+        organizationId: organizationId,\n+      });\n+\n+      const event: DirectorySyncEvent = {\n+        event: \"user.updated\",\n+        tenant: \"test-tenant\",\n+        directory_id: directoryId,\n+        data: {\n+          id: \"user-123\",\n+          email: userEmail,\n+          first_name: \"Test\",\n+          last_name: \"User\",\n+          active: false,\n+          raw: {\n+            schemas: [],\n+          },\n+        },\n+      };\n+\n+      const removeUserFromOrg = (await import(\"./removeUserFromOrg\")).default;\n+\n+      await handleUserEvents(event, organizationId);\n+\n+      expect(removeUserFromOrg).toHaveBeenCalledWith({\n+        userId: user.id,\n+        orgId: organizationId,\n+      });\n+    });\n+\n+    it(\"should sync custom attributes when user is already a member and active\", async () => {\n+      const userEmail = \"user@example.com\";\n+\n+      const user = await createMockUser({\n+        email: userEmail,\n+        organizationId: organizationId,\n+      });\n+\n+      await createMockMembership({\n+        userId: user.id,\n+        teamId: organizationId,\n+      });\n+\n+      const event: DirectorySyncEvent = {\n+        event: \"user.updated\",\n+        tenant: \"test-tenant\",\n+        directory_id: directoryId,\n+        data: {\n+          id: \"user-123\",\n+          email: userEmail,\n+          first_name: \"Test\",\n+          last_name: \"User\",\n+          active: true,\n+          raw: {\n+            schemas: [\"custom:enterprise\"],\n+            \"custom:enterprise\": {\n+              department: \"Engineering\",\n+            },\n+          },\n+        },\n+      };\n+\n+      const { UserRepository } = await import(\"@calcom/features/users/repositories/UserRepository\");\n+      vi.mocked(UserRepository).mockImplementation(\n+        () =>\n+          ({\n+            isAMemberOfOrganization: vi.fn().mockResolvedValue(true),\n+          } as unknown as InstanceType<typeof UserRepository>)\n+      );\n+\n+      const { assignValueToUserInOrgBulk } = await import(\"./assignValueToUser\");\n+\n+      await handleUserEvents(event, organizationId);\n+\n+      expect(assignValueToUserInOrgBulk).toHaveBeenCalledWith({\n+        orgId: organizationId,\n+        userId: user.id,\n+        attributeLabelToValueMap: {\n+          department: \"Engineering\",\n+        },\n+        updater: {\n+          dsyncId: directoryId,\n+        },\n+      });\n+    });\n+  });\n+\n+  describe(\"Error handling\", () => {\n+    it(\"should throw an error when organization is not found\", async () => {\n+      const userEmail = \"user@example.com\";\n+      const nonExistentOrgId = 9999;\n+\n+      const event: DirectorySyncEvent = {\n+        event: \"user.created\",\n+        tenant: \"test-tenant\",\n+        directory_id: directoryId,\n+        data: {\n+          id: \"user-123\",\n+          email: userEmail,\n+          first_name: \"Test\",\n+          last_name: \"User\",\n+          active: true,\n+          raw: {\n+            schemas: [],\n+          },\n+        },\n+      };\n+\n+      const { getTeamOrThrow } = await import(\"@calcom/trpc/server/routers/viewer/teams/inviteMember/utils\");\n+      vi.mocked(getTeamOrThrow).mockResolvedValue(\n+        null as unknown as Awaited<ReturnType<typeof getTeamOrThrow>>\n+      );\n+\n+      await expect(handleUserEvents(event, nonExistentOrgId)).rejects.toThrow(\"Org not found\");\n+    });\n+  });\n+});\ndiff --git a/packages/features/ee/dsync/lib/handleUserEvents.ts b/packages/features/ee/dsync/lib/handleUserEvents.ts\nindex bee2c1fe67343a..d117a2fadd42af 100644\n--- a/packages/features/ee/dsync/lib/handleUserEvents.ts\n+++ b/packages/features/ee/dsync/lib/handleUserEvents.ts\n@@ -78,6 +78,9 @@ const handleUserEvents = async (event: DirectorySyncEvent, organizationId: numbe\n   }\n \n   if (user) {\n+    if (user.organizationId && user.organizationId !== org.id) {\n+      throw new Error(\"User belongs to another organization.\");\n+    }\n     if (eventData.active) {\n       if (await new UserRepository(prisma).isAMemberOfOrganization({ user, organizationId })) {\n         await syncCustomAttributesToUser({\n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/calcom__cal.com.main/pr_mirror/calcom__cal.com.main.25314/metadata__pr_25314.json"
  },
  {
    "instance_id": "calcom__cal.com.main.25587",
    "repo": "calcom/cal.com",
    "pull_number": 25587,
    "base_commit": "1c3ced5b7040115e0ac1301e8482d49a80881d6c",
    "patch": "diff --git a/apps/web/app/(use-page-wrapper)/settings/(settings-layout)/teams/[id]/members/page.tsx b/apps/web/app/(use-page-wrapper)/settings/(settings-layout)/teams/[id]/members/page.tsx\nindex 97adac481de73b..3cf44ce444e2a9 100644\n--- a/apps/web/app/(use-page-wrapper)/settings/(settings-layout)/teams/[id]/members/page.tsx\n+++ b/apps/web/app/(use-page-wrapper)/settings/(settings-layout)/teams/[id]/members/page.tsx\n@@ -5,13 +5,11 @@ import { headers, cookies } from \"next/headers\";\n import { redirect } from \"next/navigation\";\n \n import { getServerSession } from \"@calcom/features/auth/lib/getServerSession\";\n-import { Resource, CustomAction } from \"@calcom/features/pbac/domain/types/permission-registry\";\n-import { getSpecificPermissions } from \"@calcom/features/pbac/lib/resource-permissions\";\n+import { getTeamMemberPermissions } from \"@calcom/features/pbac/lib/team-member-permissions\";\n import { RoleManagementFactory } from \"@calcom/features/pbac/services/role-management.factory\";\n import SettingsHeader from \"@calcom/features/settings/appDir/SettingsHeader\";\n import { PrismaAttributeRepository } from \"@calcom/lib/server/repository/PrismaAttributeRepository\";\n import { prisma } from \"@calcom/prisma\";\n-import { MembershipRole } from \"@calcom/prisma/enums\";\n import { viewerTeamsRouter } from \"@calcom/trpc/server/routers/viewer/teams/_router\";\n \n import { buildLegacyRequest } from \"@lib/buildLegacyCtx\";\n@@ -33,7 +31,7 @@ const getCachedTeamRoles = unstable_cache(\n     try {\n       const roleManager = await RoleManagementFactory.getInstance().createRoleManager(organizationId);\n       return await roleManager.getTeamRoles(teamId);\n-    } catch (error) {\n+    } catch {\n       // PBAC not enabled or error occurred, return empty array\n       return [];\n     }\n@@ -49,7 +47,7 @@ const getCachedTeamAttributes = unstable_cache(\n \n     try {\n       return await attributeRepo.findAllByOrgIdWithOptions({ orgId: organizationId });\n-    } catch (error) {\n+    } catch {\n       return [];\n     }\n   },\n@@ -79,65 +77,15 @@ const Page = async ({ params }: { params: Promise<{ id: string }> }) => {\n   const organizationId = team.parentId || teamId;\n \n   // Load PBAC roles and attributes if available\n-  const [roles, attributes] = await Promise.all([\n+  const [roles, attributes, memberPermissions] = await Promise.all([\n     getCachedTeamRoles(teamId, organizationId),\n     getCachedTeamAttributes(organizationId),\n+    getTeamMemberPermissions({\n+      userId: session.user.id,\n+      team,\n+    }),\n   ]);\n \n-  const fallbackRolesCanListMembers: MembershipRole[] = [MembershipRole.ADMIN, MembershipRole.OWNER];\n-\n-  // If the team is not private we allow members to list other members\n-  if (!team.isPrivate) {\n-    fallbackRolesCanListMembers.push(MembershipRole.MEMBER);\n-  }\n-\n-  // Get specific PBAC permissions for team member actions\n-  const permissions = await getSpecificPermissions({\n-    userId: session.user.id,\n-    teamId: teamId,\n-    resource: Resource.Team,\n-    userRole: team.membership.role,\n-    actions: [\n-      CustomAction.Invite,\n-      CustomAction.ChangeMemberRole,\n-      CustomAction.Remove,\n-      CustomAction.ListMembers,\n-      CustomAction.ListMembersPrivate,\n-      CustomAction.Impersonate,\n-    ],\n-    fallbackRoles: {\n-      [CustomAction.Invite]: {\n-        roles: [MembershipRole.ADMIN, MembershipRole.OWNER],\n-      },\n-      [CustomAction.ChangeMemberRole]: {\n-        roles: [MembershipRole.ADMIN, MembershipRole.OWNER],\n-      },\n-      [CustomAction.Remove]: {\n-        roles: [MembershipRole.ADMIN, MembershipRole.OWNER],\n-      },\n-      [CustomAction.ListMembers]: {\n-        roles: fallbackRolesCanListMembers,\n-      },\n-      [CustomAction.Impersonate]: {\n-        roles: [MembershipRole.ADMIN, MembershipRole.OWNER],\n-      },\n-      [CustomAction.ListMembersPrivate]: {\n-        roles: fallbackRolesCanListMembers,\n-      },\n-    },\n-  });\n-\n-  // Map specific permissions to member actions\n-  const memberPermissions = {\n-    canListMembers: team.isPrivate\n-      ? permissions[CustomAction.ListMembersPrivate]\n-      : permissions[CustomAction.ListMembers],\n-    canInvite: permissions[CustomAction.Invite],\n-    canChangeMemberRole: permissions[CustomAction.ChangeMemberRole],\n-    canRemove: permissions[CustomAction.Remove],\n-    canImpersonate: permissions[CustomAction.Impersonate],\n-  };\n-\n   const facetedTeamValues = {\n     roles,\n     teams: [team],\ndiff --git a/packages/features/ee/teams/components/EditMemberSheet.test.tsx b/packages/features/ee/teams/components/EditMemberSheet.test.tsx\nnew file mode 100644\nindex 00000000000000..77f8e480db0fa9\n--- /dev/null\n+++ b/packages/features/ee/teams/components/EditMemberSheet.test.tsx\n@@ -0,0 +1,327 @@\n+import { render } from \"@testing-library/react\";\n+import React, { type ReactNode } from \"react\";\n+import { vi } from \"vitest\";\n+\n+import type { MemberPermissions } from \"@calcom/features/users/components/UserTable/types\";\n+import { MembershipRole } from \"@calcom/prisma/enums\";\n+\n+import { EditMemberSheet } from \"./EditMemberSheet\";\n+import type { State, User } from \"./MemberList\";\n+\n+// Mock dependencies\n+vi.mock(\"@calcom/lib/hooks/useLocale\", () => ({\n+  useLocale: () => ({\n+    t: (key: string) => key,\n+  }),\n+}));\n+\n+vi.mock(\"@calcom/trpc/react\", () => ({\n+  trpc: {\n+    viewer: {\n+      pbac: {\n+        getTeamRoles: {\n+          useQuery: () => ({\n+            data: undefined,\n+            isPending: false,\n+          }),\n+        },\n+      },\n+      teams: {\n+        getUserConnectedApps: {\n+          useQuery: () => ({\n+            data: {},\n+            isPending: false,\n+          }),\n+        },\n+        changeMemberRole: {\n+          useMutation: () => ({\n+            mutate: vi.fn(),\n+            mutateAsync: vi.fn(),\n+          }),\n+        },\n+        listMembers: {\n+          cancel: vi.fn(),\n+          getInfiniteData: vi.fn(),\n+          invalidate: vi.fn(),\n+        },\n+        get: {\n+          setData: vi.fn(),\n+          invalidate: vi.fn(),\n+        },\n+      },\n+    },\n+    useUtils: () => ({\n+      viewer: {\n+        teams: {\n+          listMembers: {\n+            cancel: vi.fn(),\n+            getInfiniteData: vi.fn(),\n+            invalidate: vi.fn(),\n+          },\n+          get: {\n+            setData: vi.fn(),\n+            invalidate: vi.fn(),\n+          },\n+        },\n+      },\n+    }),\n+  },\n+}));\n+\n+const mockSetEditMode = vi.fn();\n+const mockSetMutationLoading = vi.fn();\n+\n+vi.mock(\"@calcom/features/users/components/UserTable/EditSheet/store\", () => ({\n+  useEditMode: vi.fn((selector) => {\n+    const state = {\n+      editMode: false,\n+      setEditMode: mockSetEditMode,\n+      mutationLoading: false,\n+      setMutationLoading: mockSetMutationLoading,\n+    };\n+    if (typeof selector === \"function\") {\n+      return selector(state);\n+    }\n+    return state;\n+  }),\n+}));\n+\n+// Mock SheetFooterControls to verify props\n+let capturedProps: { canChangeMemberRole?: boolean; canEditAttributesForUser?: boolean }[] = [];\n+vi.mock(\"@calcom/features/users/components/UserTable/EditSheet/SheetFooterControls\", () => ({\n+  SheetFooterControls: (props: { canChangeMemberRole?: boolean; canEditAttributesForUser?: boolean }) => {\n+    capturedProps.push(props);\n+    return React.createElement(\"div\", { \"data-testid\": \"sheet-footer-controls\" }, \"SheetFooterControls\");\n+  },\n+}));\n+\n+// Mock other UI components\n+vi.mock(\"@calcom/ui/components/sheet\", () => ({\n+  Sheet: ({ children }: { children: ReactNode }) =>\n+    React.createElement(\"div\", { \"data-testid\": \"sheet\" }, children),\n+  SheetContent: ({ children }: { children: ReactNode }) =>\n+    React.createElement(\"div\", { \"data-testid\": \"sheet-content\" }, children),\n+  SheetHeader: ({ children }: { children: ReactNode }) =>\n+    React.createElement(\"div\", { \"data-testid\": \"sheet-header\" }, children),\n+  SheetBody: ({ children }: { children: ReactNode }) =>\n+    React.createElement(\"div\", { \"data-testid\": \"sheet-body\" }, children),\n+  SheetFooter: ({ children }: { children: ReactNode }) =>\n+    React.createElement(\"div\", { \"data-testid\": \"sheet-footer\" }, children),\n+}));\n+\n+vi.mock(\"@calcom/ui/components/form\", () => ({\n+  Form: ({ children }: { children: ReactNode }) => React.createElement(\"form\", null, children),\n+  ToggleGroup: () => React.createElement(\"div\", { \"data-testid\": \"toggle-group\" }, \"ToggleGroup\"),\n+  Select: () => React.createElement(\"div\", { \"data-testid\": \"select\" }, \"Select\"),\n+}));\n+\n+vi.mock(\"@calcom/ui/components/avatar\", () => ({\n+  Avatar: () => React.createElement(\"div\", { \"data-testid\": \"avatar\" }, \"Avatar\"),\n+}));\n+\n+vi.mock(\"@calcom/ui/components/skeleton\", () => ({\n+  Skeleton: ({ children }: { children: ReactNode }) => React.createElement(\"div\", null, children),\n+  Loader: () => React.createElement(\"div\", { \"data-testid\": \"loader\" }, \"Loading...\"),\n+}));\n+\n+vi.mock(\"@calcom/features/users/components/UserTable/EditSheet/DisplayInfo\", () => ({\n+  DisplayInfo: () => <div data-testid=\"display-info\">DisplayInfo</div>,\n+}));\n+\n+describe(\"EditMemberSheet\", () => {\n+  const mockDispatch = vi.fn();\n+\n+  // Create a minimal mock user that satisfies the User type\n+  const mockUser = {\n+    id: 1,\n+    name: \"Test User\",\n+    email: \"test@example.com\",\n+    username: \"testuser\",\n+    role: MembershipRole.MEMBER,\n+    accepted: true,\n+    avatarUrl: \"\",\n+    bookerUrl: \"https://cal.com\",\n+    lastActiveAt: \"2024-01-01\",\n+    customRoleId: null,\n+  } as User;\n+\n+  const mockState: State = {\n+    editSheet: {\n+      user: mockUser,\n+      showModal: true,\n+    },\n+    deleteMember: {\n+      showModal: false,\n+    },\n+    impersonateMember: {\n+      showModal: false,\n+    },\n+    teamAvailability: {\n+      showModal: false,\n+    },\n+  };\n+\n+  beforeEach(() => {\n+    vi.clearAllMocks();\n+    mockSetEditMode.mockClear();\n+    mockSetMutationLoading.mockClear();\n+    capturedProps = [];\n+  });\n+\n+  describe(\"Fix verification: canChangeMemberRole prop passing\", () => {\n+    it(\"should pass canChangeMemberRole=true to SheetFooterControls when permissions.canChangeMemberRole is true\", () => {\n+      const permissions: MemberPermissions = {\n+        canListMembers: false,\n+        canInvite: false,\n+        canChangeMemberRole: true,\n+        canRemove: false,\n+        canImpersonate: false,\n+      };\n+\n+      render(\n+        <EditMemberSheet\n+          state={mockState}\n+          dispatch={mockDispatch}\n+          currentMember={MembershipRole.OWNER}\n+          teamId={1}\n+          permissions={permissions}\n+        />\n+      );\n+\n+      // Verify SheetFooterControls was called with canChangeMemberRole=true\n+      expect(capturedProps).toContainEqual(\n+        expect.objectContaining({\n+          canChangeMemberRole: true,\n+        })\n+      );\n+    });\n+\n+    it(\"should pass canChangeMemberRole=false to SheetFooterControls when permissions.canChangeMemberRole is false\", () => {\n+      const permissions: MemberPermissions = {\n+        canListMembers: false,\n+        canInvite: false,\n+        canChangeMemberRole: false,\n+        canRemove: false,\n+        canImpersonate: false,\n+      };\n+\n+      render(\n+        <EditMemberSheet\n+          state={mockState}\n+          dispatch={mockDispatch}\n+          currentMember={MembershipRole.OWNER}\n+          teamId={1}\n+          permissions={permissions}\n+        />\n+      );\n+\n+      // Verify SheetFooterControls was called with canChangeMemberRole=false\n+      expect(capturedProps).toContainEqual(\n+        expect.objectContaining({\n+          canChangeMemberRole: false,\n+        })\n+      );\n+    });\n+\n+    it(\"should pass canChangeMemberRole=undefined to SheetFooterControls when permissions is undefined\", () => {\n+      render(\n+        <EditMemberSheet\n+          state={mockState}\n+          dispatch={mockDispatch}\n+          currentMember={MembershipRole.OWNER}\n+          teamId={1}\n+          permissions={undefined}\n+        />\n+      );\n+\n+      // Verify SheetFooterControls was called with canChangeMemberRole=undefined\n+      expect(capturedProps).toContainEqual(\n+        expect.objectContaining({\n+          canChangeMemberRole: undefined,\n+        })\n+      );\n+    });\n+\n+    it(\"should pass canChangeMemberRole=undefined to SheetFooterControls when permissions object exists but canChangeMemberRole is undefined\", () => {\n+      const permissions: Partial<MemberPermissions> = {\n+        canListMembers: true,\n+        canInvite: false,\n+        // canChangeMemberRole is intentionally omitted\n+      };\n+\n+      render(\n+        <EditMemberSheet\n+          state={mockState}\n+          dispatch={mockDispatch}\n+          currentMember={MembershipRole.OWNER}\n+          teamId={1}\n+          permissions={permissions as MemberPermissions}\n+        />\n+      );\n+\n+      // Verify SheetFooterControls was called with canChangeMemberRole=undefined\n+      expect(capturedProps).toContainEqual(\n+        expect.objectContaining({\n+          canChangeMemberRole: undefined,\n+        })\n+      );\n+    });\n+\n+    it(\"should pass canEditAttributesForUser from permissions to SheetFooterControls\", () => {\n+      const permissions: MemberPermissions = {\n+        canListMembers: false,\n+        canInvite: false,\n+        canChangeMemberRole: true,\n+        canRemove: false,\n+        canImpersonate: false,\n+        canEditAttributesForUser: true,\n+      };\n+\n+      render(\n+        <EditMemberSheet\n+          state={mockState}\n+          dispatch={mockDispatch}\n+          currentMember={MembershipRole.OWNER}\n+          teamId={1}\n+          permissions={permissions}\n+        />\n+      );\n+\n+      // Verify SheetFooterControls was called with both props\n+      expect(capturedProps).toContainEqual(\n+        expect.objectContaining({\n+          canChangeMemberRole: true,\n+          canEditAttributesForUser: true,\n+        })\n+      );\n+    });\n+\n+    it(\"should correctly extract canChangeMemberRole from permissions object (verifies fix)\", () => {\n+      // This test specifically verifies the fix where permissions?.canChangeMemberRole\n+      // is now correctly passed to SheetFooterControls\n+      const permissions: MemberPermissions = {\n+        canListMembers: false,\n+        canInvite: false,\n+        canChangeMemberRole: true, // This should be passed to SheetFooterControls\n+        canRemove: false,\n+        canImpersonate: false,\n+      };\n+\n+      render(\n+        <EditMemberSheet\n+          state={mockState}\n+          dispatch={mockDispatch}\n+          currentMember={MembershipRole.OWNER}\n+          teamId={1}\n+          permissions={permissions}\n+        />\n+      );\n+\n+      expect(capturedProps).toContainEqual(\n+        expect.objectContaining({\n+          canChangeMemberRole: true,\n+        })\n+      );\n+    });\n+  });\n+});\ndiff --git a/packages/features/ee/teams/components/EditMemberSheet.tsx b/packages/features/ee/teams/components/EditMemberSheet.tsx\nindex 61bbb6693c8ded..8611d8d9f35582 100644\n--- a/packages/features/ee/teams/components/EditMemberSheet.tsx\n+++ b/packages/features/ee/teams/components/EditMemberSheet.tsx\n@@ -8,6 +8,7 @@ import { shallow } from \"zustand/shallow\";\n import { DisplayInfo } from \"@calcom/features/users/components/UserTable/EditSheet/DisplayInfo\";\n import { SheetFooterControls } from \"@calcom/features/users/components/UserTable/EditSheet/SheetFooterControls\";\n import { useEditMode } from \"@calcom/features/users/components/UserTable/EditSheet/store\";\n+import type { MemberPermissions } from \"@calcom/features/users/components/UserTable/types\";\n import { useLocale } from \"@calcom/lib/hooks/useLocale\";\n import { MembershipRole } from \"@calcom/prisma/enums\";\n import { trpc } from \"@calcom/trpc/react\";\n@@ -34,11 +35,13 @@ export function EditMemberSheet({\n   dispatch,\n   currentMember,\n   teamId,\n+  permissions,\n }: {\n   state: State;\n   dispatch: Dispatch<Action>;\n   currentMember: MembershipRole;\n   teamId: number;\n+  permissions?: MemberPermissions;\n }) {\n   const { t } = useLocale();\n   const { user } = state.editSheet;\n@@ -277,7 +280,10 @@ export function EditMemberSheet({\n               </div>\n             </SheetBody>\n             <SheetFooter className=\"mt-auto\">\n-              <SheetFooterControls />\n+              <SheetFooterControls\n+                canChangeMemberRole={permissions?.canChangeMemberRole}\n+                canEditAttributesForUser={permissions?.canEditAttributesForUser}\n+              />\n             </SheetFooter>\n           </Form>\n         ) : (\ndiff --git a/packages/features/ee/teams/components/MemberList.tsx b/packages/features/ee/teams/components/MemberList.tsx\nindex b2be14f2ee159c..ff1ee1627c3b9a 100644\n--- a/packages/features/ee/teams/components/MemberList.tsx\n+++ b/packages/features/ee/teams/components/MemberList.tsx\n@@ -830,6 +830,7 @@ function MemberListContent(props: Props) {\n           state={state}\n           currentMember={props.team.membership.role}\n           teamId={props.team.id}\n+          permissions={props.permissions}\n         />\n       )}\n     </>\ndiff --git a/packages/features/pbac/lib/team-member-permissions.ts b/packages/features/pbac/lib/team-member-permissions.ts\nnew file mode 100644\nindex 00000000000000..ad27cdf27669b7\n--- /dev/null\n+++ b/packages/features/pbac/lib/team-member-permissions.ts\n@@ -0,0 +1,80 @@\n+import type { MemberPermissions } from \"@calcom/features/users/components/UserTable/types\";\n+import { MembershipRole } from \"@calcom/prisma/enums\";\n+\n+import { Resource, CustomAction } from \"../domain/types/permission-registry\";\n+import { getSpecificPermissions } from \"./resource-permissions\";\n+\n+interface TeamWithMembership {\n+  id: number;\n+  isPrivate: boolean;\n+  membership: {\n+    role: MembershipRole;\n+    accepted: boolean;\n+  };\n+}\n+\n+interface GetTeamMemberPermissionsOptions {\n+  userId: number;\n+  team: TeamWithMembership;\n+}\n+\n+/**\n+ * Gets team member permissions using PBAC or fallback to role-based permissions.\n+ */\n+export async function getTeamMemberPermissions({\n+  userId,\n+  team,\n+}: GetTeamMemberPermissionsOptions): Promise<MemberPermissions> {\n+  // Determine fallback roles for ListMembers based on team privacy\n+  const fallbackRolesCanListMembers: MembershipRole[] = [MembershipRole.ADMIN, MembershipRole.OWNER];\n+  if (!team.isPrivate) {\n+    fallbackRolesCanListMembers.push(MembershipRole.MEMBER);\n+  }\n+\n+  // Get specific PBAC permissions for team member actions\n+  const permissions = await getSpecificPermissions({\n+    userId,\n+    teamId: team.id,\n+    resource: Resource.Team,\n+    userRole: team.membership.role,\n+    actions: [\n+      CustomAction.Invite,\n+      CustomAction.ChangeMemberRole,\n+      CustomAction.Remove,\n+      CustomAction.ListMembers,\n+      CustomAction.ListMembersPrivate,\n+      CustomAction.Impersonate,\n+    ],\n+    fallbackRoles: {\n+      [CustomAction.Invite]: {\n+        roles: [MembershipRole.ADMIN, MembershipRole.OWNER],\n+      },\n+      [CustomAction.ChangeMemberRole]: {\n+        roles: [MembershipRole.ADMIN, MembershipRole.OWNER],\n+      },\n+      [CustomAction.Remove]: {\n+        roles: [MembershipRole.ADMIN, MembershipRole.OWNER],\n+      },\n+      [CustomAction.ListMembers]: {\n+        roles: fallbackRolesCanListMembers,\n+      },\n+      [CustomAction.Impersonate]: {\n+        roles: [MembershipRole.ADMIN, MembershipRole.OWNER],\n+      },\n+      [CustomAction.ListMembersPrivate]: {\n+        roles: fallbackRolesCanListMembers,\n+      },\n+    },\n+  });\n+\n+  // Map specific permissions to member actions\n+  return {\n+    canListMembers: team.isPrivate\n+      ? permissions[CustomAction.ListMembersPrivate]\n+      : permissions[CustomAction.ListMembers],\n+    canInvite: permissions[CustomAction.Invite],\n+    canChangeMemberRole: permissions[CustomAction.ChangeMemberRole],\n+    canRemove: permissions[CustomAction.Remove],\n+    canImpersonate: permissions[CustomAction.Impersonate],\n+  };\n+}\n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/calcom__cal.com.main/pr_mirror/calcom__cal.com.main.25587/metadata__pr_25587.json"
  },
  {
    "instance_id": "calcom__cal.com.main.25325",
    "repo": "calcom/cal.com",
    "pull_number": 25325,
    "base_commit": "0af6354954b8e71b139a91f44f3b5c7b8d6454f2",
    "patch": "diff --git a/packages/trpc/server/routers/viewer/delegationCredential/toggleEnabled.handler.test.ts b/packages/trpc/server/routers/viewer/delegationCredential/toggleEnabled.handler.test.ts\nnew file mode 100644\nindex 00000000000000..af1ecc37066172\n--- /dev/null\n+++ b/packages/trpc/server/routers/viewer/delegationCredential/toggleEnabled.handler.test.ts\n@@ -0,0 +1,153 @@\n+import { describe, it, beforeEach, vi, expect } from \"vitest\";\n+\n+import { DelegationCredentialRepository } from \"@calcom/features/delegation-credentials/repositories/DelegationCredentialRepository\";\n+\n+import { toggleDelegationCredentialEnabled } from \"./toggleEnabled.handler\";\n+\n+// Mock the repository\n+vi.mock(\"@calcom/features/delegation-credentials/repositories/DelegationCredentialRepository\", () => ({\n+  DelegationCredentialRepository: {\n+    findById: vi.fn(),\n+    updateById: vi.fn(),\n+    findByIdIncludeSensitiveServiceAccountKey: vi.fn(),\n+  },\n+}));\n+\n+// Mock other dependencies\n+vi.mock(\"@calcom/app-store/delegationCredential\", () => ({\n+  checkIfSuccessfullyConfiguredInWorkspace: vi.fn().mockResolvedValue(true),\n+}));\n+\n+vi.mock(\"@calcom/emails/integration-email-service\", () => ({\n+  sendDelegationCredentialDisabledEmail: vi.fn(),\n+}));\n+\n+vi.mock(\"./getAffectedMembersForDisable.handler\", () => ({\n+  getAffectedMembersForDisable: vi.fn().mockResolvedValue([]),\n+}));\n+\n+vi.mock(\"./utils\", () => ({\n+  ensureNoServiceAccountKey: vi.fn((credential) => credential),\n+}));\n+\n+describe(\"toggleDelegationCredentialEnabled - Security Fix\", () => {\n+  beforeEach(() => {\n+    vi.clearAllMocks();\n+  });\n+\n+  it(\"should prevent users without organizationId from accessing any credentials\", async () => {\n+    const userWithoutOrg = {\n+      id: 1,\n+      email: \"user@example.com\",\n+      organizationId: null,\n+    };\n+\n+    const input = {\n+      id: \"any-credential\",\n+      enabled: true,\n+    };\n+\n+    const mockCredential = {\n+      id: \"any-credential\",\n+      organizationId: 1,\n+      enabled: false,\n+      workspacePlatform: { slug: \"google\" },\n+    };\n+\n+    vi.mocked(DelegationCredentialRepository.findById).mockResolvedValue(mockCredential);\n+\n+    await expect(\n+      toggleDelegationCredentialEnabled(userWithoutOrg, input)\n+    ).rejects.toThrow(\"You must be part of an organization to toggle a delegation credential\");\n+\n+    expect(DelegationCredentialRepository.updateById).not.toHaveBeenCalled();\n+  });\n+\n+  it(\"should prevent cross-organization access\", async () => {\n+    const userFromOrg1 = {\n+      id: 1,\n+      email: \"user@org1.com\",\n+      organizationId: 1,\n+    };\n+\n+    const input = {\n+      id: \"org2-credential\",\n+      enabled: false,\n+    };\n+\n+    const org2Credential = {\n+      id: \"org2-credential\",\n+      organizationId: 2, // Different organization\n+      enabled: true,\n+      workspacePlatform: { slug: \"google\" },\n+    };\n+\n+    vi.mocked(DelegationCredentialRepository.findById).mockResolvedValue(org2Credential);\n+\n+    await expect(\n+      toggleDelegationCredentialEnabled(userFromOrg1, input)\n+    ).rejects.toThrow(\"Delegation credential not found\");\n+\n+    expect(DelegationCredentialRepository.updateById).not.toHaveBeenCalled();\n+  });\n+\n+  it(\"should allow same-organization access\", async () => {\n+    const userFromOrg1 = {\n+      id: 1,\n+      email: \"admin@org1.com\",\n+      organizationId: 1,\n+    };\n+\n+    const input = {\n+      id: \"org1-credential\",\n+      enabled: false,\n+    };\n+\n+    const org1Credential = {\n+      id: \"org1-credential\",\n+      organizationId: 1, // Same organization\n+      enabled: true,\n+      workspacePlatform: { slug: \"google\" },\n+    };\n+\n+    const updatedCredential = {\n+      ...org1Credential,\n+      enabled: false,\n+      lastDisabledAt: new Date(),\n+    };\n+\n+    vi.mocked(DelegationCredentialRepository.findById).mockResolvedValue(org1Credential);\n+    vi.mocked(DelegationCredentialRepository.updateById).mockResolvedValue(updatedCredential);\n+\n+    const result = await toggleDelegationCredentialEnabled(userFromOrg1, input);\n+\n+    expect(result).toEqual(updatedCredential);\n+    expect(DelegationCredentialRepository.updateById).toHaveBeenCalledWith({\n+      id: \"org1-credential\",\n+      data: {\n+        enabled: false,\n+        lastEnabledAt: undefined,\n+        lastDisabledAt: expect.any(Date),\n+      },\n+    });\n+  });\n+\n+  it(\"should handle nonexistent credentials\", async () => {\n+    const user = {\n+      id: 1,\n+      email: \"user@org1.com\",\n+      organizationId: 1,\n+    };\n+\n+    const input = {\n+      id: \"nonexistent-credential\",\n+      enabled: true,\n+    };\n+\n+    vi.mocked(DelegationCredentialRepository.findById).mockResolvedValue(null);\n+\n+    await expect(\n+      toggleDelegationCredentialEnabled(user, input)\n+    ).rejects.toThrow(\"Delegation credential not found\");\n+  });\n+});\n\\ No newline at end of file\ndiff --git a/packages/trpc/server/routers/viewer/delegationCredential/toggleEnabled.handler.ts b/packages/trpc/server/routers/viewer/delegationCredential/toggleEnabled.handler.ts\nindex a66712d4933896..a5b45b52cb6c3e 100644\n--- a/packages/trpc/server/routers/viewer/delegationCredential/toggleEnabled.handler.ts\n+++ b/packages/trpc/server/routers/viewer/delegationCredential/toggleEnabled.handler.ts\n@@ -53,6 +53,14 @@ export async function toggleDelegationCredentialEnabled(\n     throw new Error(\"Delegation credential not found\");\n   }\n \n+  if (!loggedInUser.organizationId) {\n+    throw new Error(\"You must be part of an organization to toggle a delegation credential\");\n+  }\n+\n+  if (currentDelegationCredential.organizationId !== loggedInUser.organizationId) {\n+    throw new Error(\"Delegation credential not found\");\n+  }\n+\n   const shouldBeEnabled = input.enabled;\n \n   if (shouldBeEnabled === currentDelegationCredential.enabled) {\n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/calcom__cal.com.main/pr_mirror/calcom__cal.com.main.25325/metadata__pr_25325.json"
  },
  {
    "instance_id": "calcom__cal.com.main.25323",
    "repo": "calcom/cal.com",
    "pull_number": 25323,
    "base_commit": "6499243a42c565c444b6b86f8c288413b5ac5a7c",
    "patch": "diff --git a/packages/app-store/utils.test.ts b/packages/app-store/utils.test.ts\nnew file mode 100644\nindex 00000000000000..e2dd98931d15a0\n--- /dev/null\n+++ b/packages/app-store/utils.test.ts\n@@ -0,0 +1,140 @@\n+import { describe, it, expect } from \"vitest\";\n+\n+import type { App } from \"@calcom/types/App\";\n+import type { CredentialForCalendarService } from \"@calcom/types/Credential\";\n+\n+import { sanitizeAppForViewer } from \"./utils\";\n+import type { CredentialDataWithTeamName, LocationOption } from \"./utils\";\n+\n+describe(\"sanitizeAppForViewer\", () => {\n+  it(\"should remove key, credential, and credentials properties\", () => {\n+    const mockCredential: CredentialDataWithTeamName = {\n+      id: 1,\n+      type: \"daily_video\",\n+      key: { api_key: \"secret-api-key\" },\n+      userId: 1,\n+      user: { email: \"test@example.com\" },\n+      teamId: null,\n+      appId: \"daily-video\",\n+      invalid: false,\n+      delegatedTo: null,\n+      delegatedToId: null,\n+      delegationCredentialId: null,\n+      team: null,\n+    };\n+\n+    const mockApp: App & {\n+      credential: CredentialDataWithTeamName | null;\n+      credentials: CredentialDataWithTeamName[];\n+      locationOption: LocationOption | null;\n+    } = {\n+      type: \"daily_video\",\n+      name: \"Daily Video\",\n+      description: \"Video conferencing\",\n+      variant: \"conferencing\",\n+      slug: \"daily-video\",\n+      categories: [\"conferencing\"],\n+      logo: \"/logo.png\",\n+      publisher: \"Daily\",\n+      url: \"https://daily.co\",\n+      email: \"support@daily.co\",\n+      key: { api_key: \"secret-global-api-key\" },\n+      credential: mockCredential,\n+      credentials: [mockCredential],\n+      locationOption: {\n+        value: \"integrations:daily_video\",\n+        label: \"Daily Video\",\n+      },\n+    };\n+\n+    const sanitized = sanitizeAppForViewer(mockApp);\n+\n+    // Should not have key, credential, or credentials\n+    expect(sanitized).not.toHaveProperty(\"key\");\n+    expect(sanitized).not.toHaveProperty(\"credential\");\n+    expect(sanitized).not.toHaveProperty(\"credentials\");\n+\n+    // Should have all other properties\n+    expect(sanitized).toHaveProperty(\"type\", \"daily_video\");\n+    expect(sanitized).toHaveProperty(\"name\", \"Daily Video\");\n+    expect(sanitized).toHaveProperty(\"slug\", \"daily-video\");\n+    expect(sanitized).toHaveProperty(\"locationOption\");\n+    expect(sanitized.locationOption).toEqual({\n+      value: \"integrations:daily_video\",\n+      label: \"Daily Video\",\n+    });\n+  });\n+\n+  it(\"should handle apps without credential or credentials\", () => {\n+    const mockApp: App & {\n+      credential?: CredentialDataWithTeamName | null;\n+      credentials?: CredentialDataWithTeamName[];\n+      locationOption?: LocationOption | null;\n+    } = {\n+      type: \"zoom_video\",\n+      name: \"Zoom\",\n+      description: \"Video conferencing\",\n+      variant: \"conferencing\",\n+      slug: \"zoom\",\n+      categories: [\"conferencing\"],\n+      logo: \"/logo.png\",\n+      publisher: \"Zoom\",\n+      url: \"https://zoom.us\",\n+      email: \"support@zoom.us\",\n+      key: { api_key: \"secret-key\" },\n+    };\n+\n+    const sanitized = sanitizeAppForViewer(mockApp);\n+\n+    expect(sanitized).not.toHaveProperty(\"key\");\n+    expect(sanitized).not.toHaveProperty(\"credential\");\n+    expect(sanitized).not.toHaveProperty(\"credentials\");\n+    expect(sanitized).toHaveProperty(\"slug\", \"zoom\");\n+  });\n+\n+  it(\"should preserve all non-sensitive properties\", () => {\n+    const mockApp: App & {\n+      credential: CredentialDataWithTeamName | null;\n+      credentials: CredentialDataWithTeamName[];\n+      locationOption: LocationOption | null;\n+    } = {\n+      type: \"stripe_payment\",\n+      name: \"Stripe\",\n+      description: \"Payment processing\",\n+      variant: \"payment\",\n+      slug: \"stripe\",\n+      categories: [\"payment\"],\n+      logo: \"/logo.png\",\n+      publisher: \"Stripe\",\n+      url: \"https://stripe.com\",\n+      email: \"support@stripe.com\",\n+      verified: true,\n+      trending: true,\n+      rating: 4.5,\n+      reviews: 1000,\n+      isGlobal: false,\n+      key: { api_key: \"sk_live_secret\" },\n+      credential: null,\n+      credentials: [],\n+      locationOption: null,\n+      appData: {\n+        location: {\n+          type: \"integrations:stripe\",\n+          label: \"Stripe\",\n+          linkType: \"dynamic\",\n+        },\n+      },\n+    };\n+\n+    const sanitized = sanitizeAppForViewer(mockApp);\n+\n+    expect(sanitized).not.toHaveProperty(\"key\");\n+    expect(sanitized).not.toHaveProperty(\"credential\");\n+    expect(sanitized).not.toHaveProperty(\"credentials\");\n+    expect(sanitized.verified).toBe(true);\n+    expect(sanitized.trending).toBe(true);\n+    expect(sanitized.rating).toBe(4.5);\n+    expect(sanitized.reviews).toBe(1000);\n+    expect(sanitized.appData).toBeDefined();\n+  });\n+});\ndiff --git a/packages/app-store/utils.ts b/packages/app-store/utils.ts\nindex f0675f49958fbe..78a9b0a4f5906c 100644\n--- a/packages/app-store/utils.ts\n+++ b/packages/app-store/utils.ts\n@@ -57,7 +57,7 @@ function getApps(credentials: CredentialDataWithTeamName[], filterOnCredentials?\n       const credential = {\n         id: 0,\n         type: appMeta.type,\n-         \n+\n         key: appMeta.key!,\n         userId: 0,\n         user: { email: \"\" },\n@@ -174,4 +174,15 @@ export const defaultVideoAppCategories: AppCategories[] = [\n   \"video\",\n ];\n \n+export function sanitizeAppForViewer<\n+  T extends App & {\n+    credential?: CredentialDataWithTeamName | null;\n+    credentials?: CredentialDataWithTeamName[];\n+    locationOption?: LocationOption | null;\n+  }\n+>(app: T): Omit<T, \"key\" | \"credential\" | \"credentials\"> {\n+  const { key: _, credential: _1, credentials: _2, ...sanitizedApp } = app;\n+  return sanitizedApp;\n+}\n+\n export default getApps;\ndiff --git a/packages/trpc/server/routers/viewer/apps/appById.handler.test.ts b/packages/trpc/server/routers/viewer/apps/appById.handler.test.ts\nnew file mode 100644\nindex 00000000000000..29704af7fcd0d4\n--- /dev/null\n+++ b/packages/trpc/server/routers/viewer/apps/appById.handler.test.ts\n@@ -0,0 +1,235 @@\n+import { describe, it, expect, vi, beforeEach } from \"vitest\";\n+\n+import { TRPCError } from \"@trpc/server\";\n+\n+import type { CredentialForCalendarService } from \"@calcom/types/Credential\";\n+\n+import { appByIdHandler } from \"./appById.handler\";\n+import type { TAppByIdInputSchema } from \"./appById.schema\";\n+\n+// Mock the dependencies\n+vi.mock(\"@calcom/app-store/delegationCredential\", () => ({\n+  getUsersCredentialsIncludeServiceAccountKey: vi.fn(),\n+}));\n+\n+vi.mock(\"@calcom/app-store/utils\", () => ({\n+  default: vi.fn(),\n+  sanitizeAppForViewer: vi.fn((app) => {\n+    const { key: _, credential: _1, credentials: _2, ...sanitized } = app;\n+    return sanitized;\n+  }),\n+}));\n+\n+import { getUsersCredentialsIncludeServiceAccountKey } from \"@calcom/app-store/delegationCredential\";\n+import getApps, { sanitizeAppForViewer } from \"@calcom/app-store/utils\";\n+\n+import type { CredentialDataWithTeamName, LocationOption } from \"@calcom/app-store/utils\";\n+import type { App } from \"@calcom/types/App\";\n+\n+describe(\"appByIdHandler\", () => {\n+  const mockUser = {\n+    id: 1,\n+    email: \"test@example.com\",\n+    username: \"testuser\",\n+    name: \"Test User\",\n+  };\n+\n+  beforeEach(() => {\n+    vi.clearAllMocks();\n+  });\n+\n+  it(\"should not expose key field for globally installed apps\", async () => {\n+    const secretApiKey = \"secret-daily-api-key-12345\";\n+    const mockCredential: CredentialDataWithTeamName = {\n+      id: 0,\n+      type: \"daily_video\",\n+      key: { apikey: secretApiKey },\n+      userId: 0,\n+      user: { email: \"\" },\n+      teamId: null,\n+      appId: \"daily-video\",\n+      invalid: false,\n+      delegatedTo: null,\n+      delegatedToId: null,\n+      delegationCredentialId: null,\n+      team: {\n+        name: \"Default\",\n+      },\n+    };\n+\n+    const mockApp: App & {\n+      credential: CredentialDataWithTeamName | null;\n+      credentials: CredentialDataWithTeamName[];\n+      locationOption: LocationOption | null;\n+    } = {\n+      type: \"daily_video\",\n+      name: \"Cal Video\",\n+      description: \"Video conferencing\",\n+      variant: \"conferencing\",\n+      slug: \"daily-video\",\n+      categories: [\"conferencing\"],\n+      logo: \"icon.svg\",\n+      publisher: \"Cal.com\",\n+      url: \"https://daily.co\",\n+      email: \"help@cal.com\",\n+      isGlobal: true,\n+      // This is the sensitive key that should NOT be exposed\n+      key: { apikey: secretApiKey },\n+      credential: mockCredential,\n+      credentials: [mockCredential],\n+      locationOption: {\n+        value: \"integrations:daily\",\n+        label: \"Cal Video\",\n+      },\n+      appData: {\n+        location: {\n+          linkType: \"dynamic\",\n+          type: \"integrations:daily\",\n+          label: \"Cal Video\",\n+        },\n+      },\n+    };\n+\n+    vi.mocked(getUsersCredentialsIncludeServiceAccountKey).mockResolvedValue([]);\n+    vi.mocked(getApps).mockReturnValue([mockApp]);\n+\n+    const result = await appByIdHandler({\n+      ctx: { user: mockUser },\n+      input: { appId: \"daily-video\" } as TAppByIdInputSchema,\n+    });\n+\n+    // Verify that key is NOT in the response\n+    expect(result).not.toHaveProperty(\"key\");\n+    expect(result).not.toHaveProperty(\"credential\");\n+    expect(result).not.toHaveProperty(\"credentials\");\n+\n+    // Verify that other properties are preserved\n+    expect(result).toHaveProperty(\"slug\", \"daily-video\");\n+    expect(result).toHaveProperty(\"name\", \"Cal Video\");\n+    expect(result).toHaveProperty(\"isGlobal\", true);\n+    expect(result).toHaveProperty(\"locationOption\");\n+    expect(result).toHaveProperty(\"isInstalled\", 1);\n+\n+    // Verify sanitizeAppForViewer was called\n+    expect(sanitizeAppForViewer).toHaveBeenCalledWith(mockApp);\n+  });\n+\n+  it(\"should throw BAD_REQUEST when app is not found\", async () => {\n+    vi.mocked(getUsersCredentialsIncludeServiceAccountKey).mockResolvedValue([]);\n+    vi.mocked(getApps).mockReturnValue([]);\n+\n+    await expect(\n+      appByIdHandler({\n+        ctx: { user: mockUser },\n+        input: { appId: \"non-existent-app\" } as TAppByIdInputSchema,\n+      })\n+    ).rejects.toThrow(TRPCError);\n+\n+    await expect(\n+      appByIdHandler({\n+        ctx: { user: mockUser },\n+        input: { appId: \"non-existent-app\" } as TAppByIdInputSchema,\n+      })\n+    ).rejects.toThrow(\"Could not find app non-existent-app\");\n+  });\n+\n+  it(\"should preserve all non-sensitive properties\", async () => {\n+    const mockApp: App & {\n+      credential: CredentialDataWithTeamName | null;\n+      credentials: CredentialDataWithTeamName[];\n+      locationOption: LocationOption | null;\n+    } = {\n+      type: \"zoom_video\",\n+      name: \"Zoom\",\n+      description: \"Video conferencing\",\n+      variant: \"conferencing\",\n+      slug: \"zoom\",\n+      categories: [\"conferencing\"],\n+      logo: \"icon.svg\",\n+      publisher: \"Zoom\",\n+      url: \"https://zoom.us\",\n+      email: \"support@zoom.us\",\n+      isGlobal: false,\n+      verified: true,\n+      trending: true,\n+      rating: 4.5,\n+      reviews: 1000,\n+      key: { api_key: \"secret-zoom-key\" },\n+      credential: null,\n+      credentials: [],\n+      locationOption: null,\n+    };\n+\n+    vi.mocked(getUsersCredentialsIncludeServiceAccountKey).mockResolvedValue([]);\n+    vi.mocked(getApps).mockReturnValue([mockApp]);\n+\n+    const result = await appByIdHandler({\n+      ctx: { user: mockUser },\n+      input: { appId: \"zoom\" } as TAppByIdInputSchema,\n+    });\n+\n+    // Verify sensitive fields are removed\n+    expect(result).not.toHaveProperty(\"key\");\n+    expect(result).not.toHaveProperty(\"credential\");\n+    expect(result).not.toHaveProperty(\"credentials\");\n+\n+    // Verify non-sensitive fields are preserved\n+    expect(result).toHaveProperty(\"slug\", \"zoom\");\n+    expect(result).toHaveProperty(\"name\", \"Zoom\");\n+    expect(result).toHaveProperty(\"verified\", true);\n+    expect(result).toHaveProperty(\"trending\", true);\n+    expect(result).toHaveProperty(\"rating\", 4.5);\n+    expect(result).toHaveProperty(\"reviews\", 1000);\n+    expect(result).toHaveProperty(\"isInstalled\", 0);\n+  });\n+\n+  it(\"should correctly set isInstalled based on credentials length\", async () => {\n+    const mockCredential: CredentialDataWithTeamName = {\n+      id: 1,\n+      type: \"google_calendar\",\n+      key: { access_token: \"token\" },\n+      userId: 1,\n+      user: { email: \"test@example.com\" },\n+      teamId: null,\n+      appId: \"google-calendar\",\n+      invalid: false,\n+      delegatedTo: null,\n+      delegatedToId: null,\n+      delegationCredentialId: null,\n+      team: null,\n+    };\n+\n+    const mockApp: App & {\n+      credential: CredentialDataWithTeamName | null;\n+      credentials: CredentialDataWithTeamName[];\n+      locationOption: LocationOption | null;\n+    } = {\n+      type: \"google_calendar\",\n+      name: \"Google Calendar\",\n+      description: \"Calendar integration\",\n+      variant: \"calendar\",\n+      slug: \"google-calendar\",\n+      categories: [\"calendar\"],\n+      logo: \"icon.svg\",\n+      publisher: \"Google\",\n+      url: \"https://google.com\",\n+      email: \"support@google.com\",\n+      key: { api_key: \"secret-key\" },\n+      credential: mockCredential,\n+      credentials: [mockCredential],\n+      locationOption: null,\n+    };\n+\n+    vi.mocked(getUsersCredentialsIncludeServiceAccountKey).mockResolvedValue([]);\n+    vi.mocked(getApps).mockReturnValue([mockApp]);\n+\n+    const result = await appByIdHandler({\n+      ctx: { user: mockUser },\n+      input: { appId: \"google-calendar\" } as TAppByIdInputSchema,\n+    });\n+\n+    expect(result.isInstalled).toBe(1);\n+    expect(result).not.toHaveProperty(\"key\");\n+  });\n+});\n+\ndiff --git a/packages/trpc/server/routers/viewer/apps/appById.handler.ts b/packages/trpc/server/routers/viewer/apps/appById.handler.ts\nindex 3737db59cffd8f..bf14841871271d 100644\n--- a/packages/trpc/server/routers/viewer/apps/appById.handler.ts\n+++ b/packages/trpc/server/routers/viewer/apps/appById.handler.ts\n@@ -1,5 +1,5 @@\n import { getUsersCredentialsIncludeServiceAccountKey } from \"@calcom/app-store/delegationCredential\";\n-import getApps from \"@calcom/app-store/utils\";\n+import getApps, { sanitizeAppForViewer } from \"@calcom/app-store/utils\";\n import type { TrpcSessionUser } from \"@calcom/trpc/server/types\";\n \n import { TRPCError } from \"@trpc/server\";\n@@ -24,10 +24,9 @@ export const appByIdHandler = async ({ ctx, input }: AppByIdOptions) => {\n     throw new TRPCError({ code: \"BAD_REQUEST\", message: `Could not find app ${appId}` });\n   }\n \n-   \n-  const { credential: _, credentials: _1, ...app } = appFromDb;\n+  const safeApp = sanitizeAppForViewer(appFromDb);\n   return {\n     isInstalled: appFromDb.credentials.length,\n-    ...app,\n+    ...safeApp,\n   };\n };\n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/calcom__cal.com.main/pr_mirror/calcom__cal.com.main.25323/metadata__pr_25323.json"
  },
  {
    "instance_id": "calcom__cal.com.main.25312",
    "repo": "calcom/cal.com",
    "pull_number": 25312,
    "base_commit": "1578dee6223806d7b70d6cbb721e8cae9a3406d7",
    "patch": "diff --git a/packages/features/ee/billing/credit-service.ts b/packages/features/ee/billing/credit-service.ts\nindex 864114c4e355e5..8b8b78819f5a6e 100644\n--- a/packages/features/ee/billing/credit-service.ts\n+++ b/packages/features/ee/billing/credit-service.ts\n@@ -605,11 +605,15 @@ export class CreditService {\n             \"@calcom/features/ee/workflows/lib/reminders/reminderScheduler\"\n           );\n           promises.push(\n-            cancelScheduledMessagesAndScheduleEmails({ teamId: result.teamId, userId: result.userId }).catch(\n-              (error) => {\n-                log.error(\"Failed to cancel scheduled messages\", error, { result });\n-              }\n-            )\n+            cancelScheduledMessagesAndScheduleEmails({\n+              teamId: result.teamId,\n+              userIdsWithNoCredits: await this._getUserIdsWithoutCredits({\n+                teamId: result.teamId ?? null,\n+                userId: result.userId ?? null,\n+              }),\n+            }).catch((error) => {\n+              log.error(\"Failed to cancel scheduled messages\", error, { result });\n+            })\n           );\n         }\n \n@@ -826,4 +830,34 @@ export class CreditService {\n       };\n     });\n   }\n+\n+  private async _getUserIdsWithoutCredits({\n+    teamId,\n+    userId,\n+  }: {\n+    teamId: number | null;\n+    userId: number | null;\n+  }) {\n+    let userIdsWithNoCredits: number[] = userId ? [userId] : [];\n+    if (teamId) {\n+      const teamMembers = await prisma.membership.findMany({\n+        where: {\n+          teamId,\n+          accepted: true,\n+        },\n+      });\n+\n+      userIdsWithNoCredits = (\n+        await Promise.all(\n+          teamMembers.map(async (member) => {\n+            const hasCredits = await this.hasAvailableCredits({ userId: member.userId });\n+            return { userId: member.userId, hasCredits };\n+          })\n+        )\n+      )\n+        .filter(({ hasCredits }) => !hasCredits)\n+        .map(({ userId }) => userId);\n+    }\n+    return userIdsWithNoCredits;\n+  }\n }\ndiff --git a/packages/features/ee/workflows/lib/reminders/reminderScheduler.test.ts b/packages/features/ee/workflows/lib/reminders/reminderScheduler.test.ts\nindex aa8549db6aa9b7..fbd3c98b0241e9 100644\n--- a/packages/features/ee/workflows/lib/reminders/reminderScheduler.test.ts\n+++ b/packages/features/ee/workflows/lib/reminders/reminderScheduler.test.ts\n@@ -34,8 +34,6 @@ describe(\"reminderScheduler\", () => {\n \n   describe(\"cancelScheduledMessagesAndScheduleEmails\", () => {\n     it(\"should cancel SMS messages and schedule emails for team\", async () => {\n-      prismaMock.membership.findMany.mockResolvedValue([]);\n-\n       const mockScheduledMessages = [\n         {\n           id: 1,\n@@ -63,7 +61,7 @@ describe(\"reminderScheduler\", () => {\n \n       prismaMock.workflowReminder.updateMany.mockResolvedValue({ count: 1 });\n \n-      await cancelScheduledMessagesAndScheduleEmails({ teamId: 10 });\n+      await cancelScheduledMessagesAndScheduleEmails({ teamId: 10, userIdsWithNoCredits: [1, 2, 3] });\n \n       expect(twilioProvider.cancelSMS).toHaveBeenCalledWith(\"sms-123\");\n \n@@ -76,12 +74,13 @@ describe(\"reminderScheduler\", () => {\n       );\n \n       const callArgs = prismaMock.workflowReminder.findMany.mock.calls[0][0];\n-      expect(callArgs.where.workflowStep.workflow.OR).toEqual([{ userId: { in: [] } }, { teamId: 10 }]);\n+      expect(callArgs.where.workflowStep.workflow.OR).toEqual([\n+        { userId: { in: [1, 2, 3] } },\n+        { teamId: 10 },\n+      ]);\n     });\n \n     it(\"should cancel SMS messages and schedule emails for user\", async () => {\n-      prismaMock.membership.findMany.mockResolvedValue([]);\n-\n       const mockScheduledMessages = [\n         {\n           id: 1,\n@@ -109,7 +108,7 @@ describe(\"reminderScheduler\", () => {\n \n       prismaMock.workflowReminder.updateMany.mockResolvedValue({ count: 1 });\n \n-      await cancelScheduledMessagesAndScheduleEmails({ userId: 11 });\n+      await cancelScheduledMessagesAndScheduleEmails({ userIdsWithNoCredits: [11] });\n \n       const callArgs = prismaMock.workflowReminder.findMany.mock.calls[0][0];\n       expect(callArgs.where.workflowStep.workflow.OR).toEqual([{ userId: { in: [11] } }]);\ndiff --git a/packages/features/ee/workflows/lib/reminders/reminderScheduler.ts b/packages/features/ee/workflows/lib/reminders/reminderScheduler.ts\nindex 8ddd80a8343693..63c47a4971861b 100644\n--- a/packages/features/ee/workflows/lib/reminders/reminderScheduler.ts\n+++ b/packages/features/ee/workflows/lib/reminders/reminderScheduler.ts\n@@ -11,14 +11,14 @@ import * as twilio from \"@calcom/features/ee/workflows/lib/reminders/providers/t\n import type { Workflow, WorkflowStep } from \"@calcom/features/ee/workflows/lib/types\";\n import { getSubmitterEmail } from \"@calcom/features/tasker/tasks/triggerFormSubmittedNoEvent/formSubmissionValidation\";\n import { UserRepository } from \"@calcom/features/users/repositories/UserRepository\";\n-import { checkSMSRateLimit } from \"@calcom/lib/smsLockState\";\n import { SENDER_NAME } from \"@calcom/lib/constants\";\n import { formatCalEventExtended } from \"@calcom/lib/formatCalendarEvent\";\n import { withReporting } from \"@calcom/lib/sentryWrapper\";\n import { getTranslation } from \"@calcom/lib/server/i18n\";\n+import { checkSMSRateLimit } from \"@calcom/lib/smsLockState\";\n import prisma from \"@calcom/prisma\";\n import { SchedulingType } from \"@calcom/prisma/enums\";\n-import { WorkflowActions, WorkflowMethods, WorkflowTriggerEvents } from \"@calcom/prisma/enums\";\n+import { WorkflowActions, WorkflowTriggerEvents } from \"@calcom/prisma/enums\";\n import type { CalendarEvent } from \"@calcom/types/Calendar\";\n \n import { scheduleAIPhoneCall } from \"./aiPhoneCallManager\";\n@@ -288,86 +288,18 @@ const _sendCancelledReminders = async (args: SendCancelledRemindersArgs) => {\n \n const _cancelScheduledMessagesAndScheduleEmails = async ({\n   teamId,\n-  userId,\n+  userIdsWithNoCredits,\n }: {\n   teamId?: number | null;\n-  userId?: number | null;\n+  userIdsWithNoCredits: number[];\n }) => {\n-  const { CreditService } = await import(\"@calcom/features/ee/billing/credit-service\");\n-\n-  let userIdsWithNoCredits: number[] = userId ? [userId] : [];\n-\n-  if (teamId) {\n-    const teamMembers = await prisma.membership.findMany({\n-      where: {\n-        teamId,\n-        accepted: true,\n-      },\n-    });\n-\n-    const creditService = new CreditService();\n-\n-    userIdsWithNoCredits = (\n-      await Promise.all(\n-        teamMembers.map(async (member) => {\n-          const hasCredits = await creditService.hasAvailableCredits({ userId: member.userId });\n-          return { userId: member.userId, hasCredits };\n-        })\n-      )\n-    )\n-      .filter(({ hasCredits }) => !hasCredits)\n-      .map(({ userId }) => userId);\n-  }\n+  const { WorkflowReminderRepository } = await import(\n+    \"@calcom/features/ee/workflows/repositories/WorkflowReminderRepository\"\n+  );\n \n-  const scheduledMessages = await prisma.workflowReminder.findMany({\n-    where: {\n-      workflowStep: {\n-        workflow: {\n-          OR: [\n-            {\n-              userId: {\n-                in: userIdsWithNoCredits,\n-              },\n-            },\n-            ...(teamId ? [{ teamId }] : []),\n-          ],\n-        },\n-      },\n-      scheduled: true,\n-      OR: [{ cancelled: false }, { cancelled: null }],\n-      referenceId: {\n-        not: null,\n-      },\n-      method: {\n-        in: [WorkflowMethods.SMS, WorkflowMethods.WHATSAPP],\n-      },\n-    },\n-    select: {\n-      referenceId: true,\n-      workflowStep: {\n-        select: {\n-          action: true,\n-        },\n-      },\n-      scheduledDate: true,\n-      uuid: true,\n-      id: true,\n-      booking: {\n-        select: {\n-          attendees: {\n-            select: {\n-              email: true,\n-              locale: true,\n-            },\n-          },\n-          user: {\n-            select: {\n-              email: true,\n-            },\n-          },\n-        },\n-      },\n-    },\n+  const scheduledMessages = await WorkflowReminderRepository.findScheduledMessagesToCancel({\n+    teamId,\n+    userIdsWithNoCredits,\n   });\n \n   await Promise.allSettled(scheduledMessages.map((msg) => twilio.cancelSMS(msg.referenceId ?? \"\")));\n@@ -393,16 +325,8 @@ const _cancelScheduledMessagesAndScheduleEmails = async ({\n     })\n   );\n \n-  await prisma.workflowReminder.updateMany({\n-    where: {\n-      id: {\n-        in: scheduledMessages.map((msg) => msg.id),\n-      },\n-    },\n-    data: {\n-      method: WorkflowMethods.EMAIL,\n-      referenceId: null,\n-    },\n+  await WorkflowReminderRepository.updateRemindersToEmail({\n+    reminderIds: scheduledMessages.map((msg) => msg.id),\n   });\n };\n // Export functions wrapped with withReporting\ndiff --git a/packages/features/ee/workflows/repositories/WorkflowReminderRepository.ts b/packages/features/ee/workflows/repositories/WorkflowReminderRepository.ts\nnew file mode 100644\nindex 00000000000000..60d6727d2c1b2d\n--- /dev/null\n+++ b/packages/features/ee/workflows/repositories/WorkflowReminderRepository.ts\n@@ -0,0 +1,77 @@\n+import { prisma } from \"@calcom/prisma\";\n+import { WorkflowMethods } from \"@calcom/prisma/enums\";\n+\n+export class WorkflowReminderRepository {\n+  static async findScheduledMessagesToCancel({\n+    teamId,\n+    userIdsWithNoCredits,\n+  }: {\n+    teamId?: number | null;\n+    userIdsWithNoCredits: number[];\n+  }) {\n+    return await prisma.workflowReminder.findMany({\n+      where: {\n+        workflowStep: {\n+          workflow: {\n+            OR: [\n+              {\n+                userId: {\n+                  in: userIdsWithNoCredits,\n+                },\n+              },\n+              ...(teamId ? [{ teamId }] : []),\n+            ],\n+          },\n+        },\n+        scheduled: true,\n+        OR: [{ cancelled: false }, { cancelled: null }],\n+        referenceId: {\n+          not: null,\n+        },\n+        method: {\n+          in: [WorkflowMethods.SMS, WorkflowMethods.WHATSAPP],\n+        },\n+      },\n+      select: {\n+        referenceId: true,\n+        workflowStep: {\n+          select: {\n+            action: true,\n+          },\n+        },\n+        scheduledDate: true,\n+        uuid: true,\n+        id: true,\n+        booking: {\n+          select: {\n+            attendees: {\n+              select: {\n+                email: true,\n+                locale: true,\n+              },\n+            },\n+            user: {\n+              select: {\n+                email: true,\n+              },\n+            },\n+          },\n+        },\n+      },\n+    });\n+  }\n+\n+  static async updateRemindersToEmail({ reminderIds }: { reminderIds: number[] }): Promise<void> {\n+    await prisma.workflowReminder.updateMany({\n+      where: {\n+        id: {\n+          in: reminderIds,\n+        },\n+      },\n+      data: {\n+        method: WorkflowMethods.EMAIL,\n+        referenceId: null,\n+      },\n+    });\n+  }\n+}\n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/calcom__cal.com.main/pr_mirror/calcom__cal.com.main.25312/metadata__pr_25312.json"
  },
  {
    "instance_id": "calcom__cal.com.main.25315",
    "repo": "calcom/cal.com",
    "pull_number": 25315,
    "base_commit": "6499243a42c565c444b6b86f8c288413b5ac5a7c",
    "patch": "diff --git a/packages/features/credentials/services/CredentialAccessService.test.ts b/packages/features/credentials/services/CredentialAccessService.test.ts\nnew file mode 100644\nindex 00000000000000..69852b0d4e31aa\n--- /dev/null\n+++ b/packages/features/credentials/services/CredentialAccessService.test.ts\n@@ -0,0 +1,320 @@\n+import { describe, expect, test, vi, beforeEach } from \"vitest\";\n+\n+import { CredentialRepository } from \"@calcom/features/credentials/repositories/CredentialRepository\";\n+import { UserRepository } from \"@calcom/features/users/repositories/UserRepository\";\n+import { HttpError } from \"@calcom/lib/http-error\";\n+import { prisma } from \"@calcom/prisma\";\n+\n+import { CredentialAccessService } from \"./CredentialAccessService\";\n+\n+vi.mock(\"@calcom/prisma\", () => {\n+  return {\n+    prisma: {\n+      user: {\n+        findUnique: vi.fn(),\n+      },\n+    },\n+  };\n+});\n+\n+vi.mock(\"@calcom/features/credentials/repositories/CredentialRepository\", () => {\n+  return {\n+    CredentialRepository: {\n+      findFirstByIdWithKeyAndUser: vi.fn(),\n+    },\n+  };\n+});\n+\n+vi.mock(\"@calcom/features/users/repositories/UserRepository\", () => {\n+  return {\n+    UserRepository: vi.fn().mockImplementation(() => ({\n+      getUserOrganizationAndTeams: vi.fn(),\n+    })),\n+  };\n+});\n+\n+describe(\"CredentialAccessService\", () => {\n+  beforeEach(() => {\n+    vi.clearAllMocks();\n+  });\n+\n+  test(\"should allow access when credential belongs to logged-in user\", async () => {\n+    const credentialId = 1;\n+    const loggedInUserId = 100;\n+    const bookingOwnerId = 200;\n+\n+    vi.mocked(CredentialRepository.findFirstByIdWithKeyAndUser).mockResolvedValue({\n+      id: credentialId,\n+      userId: loggedInUserId,\n+      teamId: null,\n+      type: \"zoom_video\",\n+      appId: \"zoom\",\n+      key: {},\n+      invalid: false,\n+      user: { email: \"user@example.com\" },\n+      delegatedTo: null,\n+      delegatedToId: null,\n+      delegationCredentialId: null,\n+    } as any);\n+\n+    const service = new CredentialAccessService();\n+    await expect(\n+      service.ensureAccessible({\n+        credentialId,\n+        loggedInUserId,\n+        bookingOwnerId,\n+      })\n+    ).resolves.not.toThrow();\n+  });\n+\n+  test(\"should allow access when credential belongs to booking owner\", async () => {\n+    const credentialId = 1;\n+    const loggedInUserId = 100;\n+    const bookingOwnerId = 200;\n+\n+    vi.mocked(CredentialRepository.findFirstByIdWithKeyAndUser).mockResolvedValue({\n+      id: credentialId,\n+      userId: bookingOwnerId,\n+      teamId: null,\n+      type: \"zoom_video\",\n+      appId: \"zoom\",\n+      key: {},\n+      invalid: false,\n+      user: { email: \"owner@example.com\" },\n+      delegatedTo: null,\n+      delegatedToId: null,\n+      delegationCredentialId: null,\n+    } as any);\n+\n+    const service = new CredentialAccessService();\n+    await expect(\n+      service.ensureAccessible({\n+        credentialId,\n+        loggedInUserId,\n+        bookingOwnerId,\n+      })\n+    ).resolves.not.toThrow();\n+  });\n+\n+  test(\"should allow access when credential belongs to team the logged-in user belongs to\", async () => {\n+    const credentialId = 1;\n+    const loggedInUserId = 100;\n+    const bookingOwnerId = 200;\n+    const teamId = 50;\n+\n+    vi.mocked(CredentialRepository.findFirstByIdWithKeyAndUser).mockResolvedValue({\n+      id: credentialId,\n+      userId: null,\n+      teamId: teamId,\n+      type: \"zoom_video\",\n+      appId: \"zoom\",\n+      key: {},\n+      invalid: false,\n+      user: null,\n+      delegatedTo: null,\n+      delegatedToId: null,\n+      delegationCredentialId: null,\n+    } as any);\n+\n+    const mockUserRepo = {\n+      getUserOrganizationAndTeams: vi.fn().mockResolvedValue({\n+        organizationId: null,\n+        teams: [{ teamId: teamId }],\n+      }),\n+    };\n+\n+    vi.mocked(UserRepository).mockImplementation(() => mockUserRepo as any);\n+\n+    const service = new CredentialAccessService();\n+    await expect(\n+      service.ensureAccessible({\n+        credentialId,\n+        loggedInUserId,\n+        bookingOwnerId,\n+      })\n+    ).resolves.not.toThrow();\n+  });\n+\n+  test(\"should allow access when credential belongs to team the booking owner belongs to\", async () => {\n+    const credentialId = 1;\n+    const loggedInUserId = 100;\n+    const bookingOwnerId = 200;\n+    const teamId = 50;\n+\n+    vi.mocked(CredentialRepository.findFirstByIdWithKeyAndUser).mockResolvedValue({\n+      id: credentialId,\n+      userId: null,\n+      teamId: teamId,\n+      type: \"zoom_video\",\n+      appId: \"zoom\",\n+      key: {},\n+      invalid: false,\n+      user: null,\n+      delegatedTo: null,\n+      delegatedToId: null,\n+      delegationCredentialId: null,\n+    } as any);\n+\n+    const mockUserRepo = {\n+      getUserOrganizationAndTeams: vi\n+        .fn()\n+        .mockResolvedValueOnce({\n+          organizationId: null,\n+          teams: [],\n+        })\n+        .mockResolvedValueOnce({\n+          organizationId: null,\n+          teams: [{ teamId: teamId }],\n+        }),\n+    };\n+\n+    vi.mocked(UserRepository).mockImplementation(() => mockUserRepo as any);\n+\n+    const service = new CredentialAccessService();\n+    await expect(\n+      service.ensureAccessible({\n+        credentialId,\n+        loggedInUserId,\n+        bookingOwnerId,\n+      })\n+    ).resolves.not.toThrow();\n+  });\n+\n+  test(\"should allow access when credential belongs to organization the logged-in user belongs to\", async () => {\n+    const credentialId = 1;\n+    const loggedInUserId = 100;\n+    const bookingOwnerId = 200;\n+    const orgId = 50;\n+\n+    vi.mocked(CredentialRepository.findFirstByIdWithKeyAndUser).mockResolvedValue({\n+      id: credentialId,\n+      userId: null,\n+      teamId: orgId,\n+      type: \"zoom_video\",\n+      appId: \"zoom\",\n+      key: {},\n+      invalid: false,\n+      user: null,\n+      delegatedTo: null,\n+      delegatedToId: null,\n+      delegationCredentialId: null,\n+    } as any);\n+\n+    const mockUserRepo = {\n+      getUserOrganizationAndTeams: vi.fn().mockResolvedValue({\n+        organizationId: orgId,\n+        teams: [],\n+      }),\n+    };\n+\n+    vi.mocked(UserRepository).mockImplementation(() => mockUserRepo as any);\n+\n+    const service = new CredentialAccessService();\n+    await expect(\n+      service.ensureAccessible({\n+        credentialId,\n+        loggedInUserId,\n+        bookingOwnerId,\n+      })\n+    ).resolves.not.toThrow();\n+  });\n+\n+  test(\"should throw NOT_FOUND when credential does not exist\", async () => {\n+    const credentialId = 1;\n+    const loggedInUserId = 100;\n+    const bookingOwnerId = 200;\n+\n+    vi.mocked(CredentialRepository.findFirstByIdWithKeyAndUser).mockResolvedValue(null);\n+\n+    const service = new CredentialAccessService();\n+    const error = await service\n+      .ensureAccessible({\n+        credentialId,\n+        loggedInUserId,\n+        bookingOwnerId,\n+      })\n+      .catch((e) => e);\n+\n+    expect(error).toBeInstanceOf(HttpError);\n+    expect(error.statusCode).toBe(404);\n+    expect(error.message).toBe(\"Credential not found\");\n+  });\n+\n+  test(\"should throw FORBIDDEN when credential is not accessible\", async () => {\n+    const credentialId = 1;\n+    const loggedInUserId = 100;\n+    const bookingOwnerId = 200;\n+    const otherUserId = 300;\n+\n+    vi.mocked(CredentialRepository.findFirstByIdWithKeyAndUser).mockResolvedValue({\n+      id: credentialId,\n+      userId: otherUserId,\n+      teamId: null,\n+      type: \"zoom_video\",\n+      appId: \"zoom\",\n+      key: {},\n+      invalid: false,\n+      user: { email: \"other@example.com\" },\n+      delegatedTo: null,\n+      delegatedToId: null,\n+      delegationCredentialId: null,\n+    } as any);\n+\n+    const mockUserRepo = {\n+      getUserOrganizationAndTeams: vi\n+        .fn()\n+        .mockResolvedValueOnce({\n+          organizationId: null,\n+          teams: [],\n+        })\n+        .mockResolvedValueOnce({\n+          organizationId: null,\n+          teams: [],\n+        }),\n+    };\n+\n+    vi.mocked(UserRepository).mockImplementation(() => mockUserRepo as any);\n+\n+    const service = new CredentialAccessService();\n+    const error = await service\n+      .ensureAccessible({\n+        credentialId,\n+        loggedInUserId,\n+        bookingOwnerId,\n+      })\n+      .catch((e) => e);\n+\n+    expect(error).toBeInstanceOf(HttpError);\n+    expect(error.statusCode).toBe(403);\n+    expect(error.message).toBe(\"You do not have access to this credential\");\n+  });\n+\n+  test(\"should handle null bookingOwnerId\", async () => {\n+    const credentialId = 1;\n+    const loggedInUserId = 100;\n+    const bookingOwnerId = null;\n+\n+    vi.mocked(CredentialRepository.findFirstByIdWithKeyAndUser).mockResolvedValue({\n+      id: credentialId,\n+      userId: loggedInUserId,\n+      teamId: null,\n+      type: \"zoom_video\",\n+      appId: \"zoom\",\n+      key: {},\n+      invalid: false,\n+      user: { email: \"user@example.com\" },\n+      delegatedTo: null,\n+      delegatedToId: null,\n+      delegationCredentialId: null,\n+    } as any);\n+\n+    const service = new CredentialAccessService();\n+    await expect(\n+      service.ensureAccessible({\n+        credentialId,\n+        loggedInUserId,\n+        bookingOwnerId,\n+      })\n+    ).resolves.not.toThrow();\n+  });\n+});\ndiff --git a/packages/features/credentials/services/CredentialAccessService.ts b/packages/features/credentials/services/CredentialAccessService.ts\nnew file mode 100644\nindex 00000000000000..8b4c21d83f2999\n--- /dev/null\n+++ b/packages/features/credentials/services/CredentialAccessService.ts\n@@ -0,0 +1,130 @@\n+import { CredentialRepository } from \"@calcom/features/credentials/repositories/CredentialRepository\";\n+import { UserRepository } from \"@calcom/features/users/repositories/UserRepository\";\n+import { HttpError } from \"@calcom/lib/http-error\";\n+import type { PrismaClient } from \"@calcom/prisma\";\n+import { prisma } from \"@calcom/prisma\";\n+\n+type CredentialAccessInput = {\n+  credentialId: number;\n+  loggedInUserId: number;\n+  bookingOwnerId: number | null;\n+};\n+\n+type UserTeamsData = {\n+  organizationId: number | null;\n+  teams: Array<{ teamId: number }>;\n+} | null;\n+\n+export class CredentialAccessService {\n+  private readonly userRepository: UserRepository;\n+\n+  constructor(private readonly prismaClient: PrismaClient = prisma) {\n+    this.userRepository = new UserRepository(this.prismaClient);\n+  }\n+\n+  /**\n+   * Ensures that a credential is accessible by the logged-in user or booking owner.\n+   */\n+  async ensureAccessible(input: CredentialAccessInput): Promise<void> {\n+    const credential = await this.checkCredentialExists(input.credentialId);\n+\n+    if (this.checkUserOwnership(credential, input.loggedInUserId)) {\n+      return;\n+    }\n+\n+    if (this.checkBookingOwnerOwnership(credential, input.bookingOwnerId)) {\n+      return;\n+    }\n+\n+    await this.checkTeamAccess(credential, input.loggedInUserId, input.bookingOwnerId);\n+  }\n+\n+  private async checkCredentialExists(credentialId: number) {\n+    const credential = await CredentialRepository.findFirstByIdWithKeyAndUser({\n+      id: credentialId,\n+    });\n+\n+    if (!credential) {\n+      throw new HttpError({\n+        statusCode: 404,\n+        message: \"Credential not found\",\n+      });\n+    }\n+\n+    return credential;\n+  }\n+\n+  private checkUserOwnership(\n+    credential: Awaited<ReturnType<typeof CredentialRepository.findFirstByIdWithKeyAndUser>>,\n+    loggedInUserId: number\n+  ): boolean {\n+    return credential?.userId === loggedInUserId;\n+  }\n+\n+  private checkBookingOwnerOwnership(\n+    credential: Awaited<ReturnType<typeof CredentialRepository.findFirstByIdWithKeyAndUser>>,\n+    bookingOwnerId: number | null\n+  ): boolean {\n+    return bookingOwnerId !== null && credential?.userId === bookingOwnerId;\n+  }\n+\n+  private async checkTeamAccess(\n+    credential: NonNullable<Awaited<ReturnType<typeof CredentialRepository.findFirstByIdWithKeyAndUser>>>,\n+    loggedInUserId: number,\n+    bookingOwnerId: number | null\n+  ): Promise<void> {\n+    if (!credential.teamId) {\n+      this.throwForbiddenError();\n+    }\n+\n+    const [loggedInUserTeams, bookingOwnerTeams] = await this.getUserTeamsData(\n+      loggedInUserId,\n+      bookingOwnerId\n+    );\n+\n+    if (this.hasTeamAccess(credential.teamId, loggedInUserTeams)) {\n+      return;\n+    }\n+\n+    if (this.hasTeamAccess(credential.teamId, bookingOwnerTeams)) {\n+      return;\n+    }\n+\n+    this.throwForbiddenError();\n+  }\n+\n+  private async getUserTeamsData(\n+    loggedInUserId: number,\n+    bookingOwnerId: number | null\n+  ): Promise<[UserTeamsData, UserTeamsData]> {\n+    return Promise.all([\n+      this.userRepository.getUserOrganizationAndTeams({ userId: loggedInUserId }),\n+      bookingOwnerId\n+        ? this.userRepository.getUserOrganizationAndTeams({ userId: bookingOwnerId })\n+        : Promise.resolve(null),\n+    ]);\n+  }\n+\n+  private hasTeamAccess(teamId: number, userTeams: UserTeamsData): boolean {\n+    if (!userTeams) {\n+      return false;\n+    }\n+\n+    const teamIds = this.getTeamIdsForUser(userTeams);\n+    return teamIds.includes(teamId);\n+  }\n+\n+  private getTeamIdsForUser(userTeams: NonNullable<UserTeamsData>): number[] {\n+    return [\n+      ...(userTeams.organizationId ? [userTeams.organizationId] : []),\n+      ...(userTeams.teams || []).map((t) => t.teamId),\n+    ];\n+  }\n+\n+  private throwForbiddenError(): never {\n+    throw new HttpError({\n+      statusCode: 403,\n+      message: \"You do not have access to this credential\",\n+    });\n+  }\n+}\ndiff --git a/packages/trpc/server/routers/viewer/bookings/editLocation.handler.ts b/packages/trpc/server/routers/viewer/bookings/editLocation.handler.ts\nindex 52f840d0953e60..203947232ac773 100644\n--- a/packages/trpc/server/routers/viewer/bookings/editLocation.handler.ts\n+++ b/packages/trpc/server/routers/viewer/bookings/editLocation.handler.ts\n@@ -7,6 +7,7 @@ import { sendLocationChangeEmailsAndSMS } from \"@calcom/emails/email-manager\";\n import EventManager from \"@calcom/features/bookings/lib/EventManager\";\n import { BookingRepository } from \"@calcom/features/bookings/repositories/BookingRepository\";\n import { CredentialRepository } from \"@calcom/features/credentials/repositories/CredentialRepository\";\n+import { CredentialAccessService } from \"@calcom/features/credentials/services/CredentialAccessService\";\n import { UserRepository } from \"@calcom/features/users/repositories/UserRepository\";\n import { getVideoCallUrlFromCalEvent } from \"@calcom/lib/CalEventParser\";\n import { buildCalEventFromBooking } from \"@calcom/lib/buildCalEventFromBooking\";\n@@ -125,15 +126,26 @@ async function updateBookingLocationInDb({\n async function getAllCredentialsIncludeServiceAccountKey({\n   user,\n   conferenceCredentialId,\n+  bookingOwnerId,\n }: {\n   user: { id: number; email: string };\n   conferenceCredentialId: number | null;\n+  bookingOwnerId: number | null;\n }) {\n   const credentials = await getUsersCredentialsIncludeServiceAccountKey(user);\n \n   let conferenceCredential;\n \n   if (conferenceCredentialId) {\n+    // Validate that the credential is accessible before fetching it\n+    const credentialAccessService = new CredentialAccessService();\n+    await credentialAccessService.ensureAccessible({\n+      credentialId: conferenceCredentialId,\n+      loggedInUserId: user.id,\n+      bookingOwnerId,\n+    });\n+\n+    // Now fetch the credential with the key\n     conferenceCredential = await CredentialRepository.findFirstByIdWithKeyAndUser({\n       id: conferenceCredentialId,\n     });\n@@ -266,7 +278,11 @@ export async function editLocationHandler({ ctx, input }: EditLocationOptions) {\n \n   const eventManager = new EventManager({\n     ...ctx.user,\n-    credentials: await getAllCredentialsIncludeServiceAccountKey({ user: ctx.user, conferenceCredentialId }),\n+    credentials: await getAllCredentialsIncludeServiceAccountKey({\n+      user: ctx.user,\n+      conferenceCredentialId,\n+      bookingOwnerId: booking.userId,\n+    }),\n   });\n \n   const updatedResult = await updateLocationInConnectedAppForBooking({\n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/calcom__cal.com.main/pr_mirror/calcom__cal.com.main.25315/metadata__pr_25315.json"
  },
  {
    "instance_id": "calcom__cal.com.main.25499",
    "repo": "calcom/cal.com",
    "pull_number": 25499,
    "base_commit": "d00cf329e80ec9d1bb5e1a7587bfb2d31d4339b7",
    "patch": "diff --git a/apps/web/components/apps/routing-forms/TestFormDialog.test.tsx b/apps/web/components/apps/routing-forms/TestFormDialog.test.tsx\nindex 28042573367e66..be21fbd2390510 100644\n--- a/apps/web/components/apps/routing-forms/TestFormDialog.test.tsx\n+++ b/apps/web/components/apps/routing-forms/TestFormDialog.test.tsx\n@@ -452,7 +452,8 @@ describe(\"TestFormDialog\", () => {\n       fireEvent.click(screen.getByText(\"submit\"));\n \n       // Verify the URL shows the substituted value, not the variable\n-      expect(screen.getByTestId(\"test-routing-result\")).toHaveTextContent(\"/team/sales-team/meeting\");\n+      expect(screen.getByTestId(\"test-routing-result\")).toHaveTextContent(\"/team/Sales%20Team/meeting\");\n+      expect(screen.getByTestId(\"test-routing-result\")).not.toHaveTextContent(\"/team/sales-team/meeting\");\n       expect(screen.getByTestId(\"test-routing-result\")).not.toHaveTextContent(\"{name}\");\n     });\n \ndiff --git a/packages/app-store/routing-forms/__tests__/getEventTypeRedirectUrl.test.ts b/packages/app-store/routing-forms/__tests__/getEventTypeRedirectUrl.test.ts\nindex 950d546f862c98..7d627943ac7e92 100644\n--- a/packages/app-store/routing-forms/__tests__/getEventTypeRedirectUrl.test.ts\n+++ b/packages/app-store/routing-forms/__tests__/getEventTypeRedirectUrl.test.ts\n@@ -91,4 +91,49 @@ describe(\"getAbsoluteEventTypeRedirectUrl\", () => {\n       })\n     ).toThrow(\"eventTypeRedirectUrl must have username or teamSlug\");\n   });\n+\n+  it(\"should use '&' separator when redirect URL already contains query parameters\", () => {\n+    const result = getAbsoluteEventTypeRedirectUrl({\n+      ...defaultParams,\n+      eventTypeRedirectUrl: \"user/event?existing=param\",\n+      allURLSearchParams: new URLSearchParams(\"foo=bar\"),\n+    });\n+    expect(result).toBe(\"https://user.cal.com/user/event?existing=param&foo=bar\");\n+  });\n+\n+  it(\"should merge with '&' when redirect URL already contains multiple query parameters\", () => {\n+    const result = getAbsoluteEventTypeRedirectUrl({\n+      ...defaultParams,\n+      eventTypeRedirectUrl: \"user/event?existing1=param1&existing2=param2\",\n+      allURLSearchParams: new URLSearchParams(\"foo=bar\"),\n+    });\n+    expect(result).toBe(\"https://user.cal.com/user/event?existing1=param1&existing2=param2&foo=bar\");\n+  });\n+\n+  it(\"should merge with '&' when no URL search params are present\", () => {\n+    const result = getAbsoluteEventTypeRedirectUrl({\n+      ...defaultParams,\n+      eventTypeRedirectUrl: \"user/event?existing=param\",\n+      allURLSearchParams: new URLSearchParams(),\n+    });\n+    expect(result).toBe(\"https://user.cal.com/user/event?existing=param&\");\n+  });\n+\n+  it(\"should merge when redirect URL ends with '/'\", () => {\n+    const result = getAbsoluteEventTypeRedirectUrl({\n+      ...defaultParams,\n+      eventTypeRedirectUrl: \"user/event/\",\n+      allURLSearchParams: new URLSearchParams(\"foo=bar\"),\n+    });\n+    expect(result).toBe(\"https://user.cal.com/user/event/?foo=bar\");\n+  });\n+\n+  it(\"should be able to merge when redirect URL ends with '?'\", () => {\n+    const result = getAbsoluteEventTypeRedirectUrl({\n+      ...defaultParams,\n+      eventTypeRedirectUrl: \"user/event?\",\n+      allURLSearchParams: new URLSearchParams(\"foo=bar\"),\n+    });\n+    expect(result).toBe(\"https://user.cal.com/user/event?&foo=bar\");\n+  });\n });\ndiff --git a/packages/app-store/routing-forms/getEventTypeRedirectUrl.ts b/packages/app-store/routing-forms/getEventTypeRedirectUrl.ts\nindex 5719553530a2ac..69f2f171761484 100644\n--- a/packages/app-store/routing-forms/getEventTypeRedirectUrl.ts\n+++ b/packages/app-store/routing-forms/getEventTypeRedirectUrl.ts\n@@ -86,7 +86,8 @@ export function getAbsoluteEventTypeRedirectUrl({\n   if (teamSlugInRedirectUrl && form.nonOrgTeamslug) {\n     const isEventTypeRedirectToOldTeamSlug = teamSlugInRedirectUrl === form.nonOrgTeamslug;\n     if (isEventTypeRedirectToOldTeamSlug) {\n-      return `${WEBAPP_URL}/${eventTypeRedirectUrl}?${allURLSearchParams}`;\n+      const joiner = eventTypeRedirectUrl.includes(\"?\") ? \"&\" : \"?\";\n+      return `${WEBAPP_URL}/${eventTypeRedirectUrl}${joiner}${allURLSearchParams}`;\n     }\n   }\n \n@@ -95,7 +96,8 @@ export function getAbsoluteEventTypeRedirectUrl({\n     const isEventTypeRedirectToOldUser =\n       !hasSameProfileUsername && usernameInRedirectUrl === form.nonOrgUsername;\n     if (isEventTypeRedirectToOldUser) {\n-      return `${WEBAPP_URL}/${eventTypeRedirectUrl}?${allURLSearchParams}`;\n+      const joiner = eventTypeRedirectUrl.includes(\"?\") ? \"&\" : \"?\";\n+      return `${WEBAPP_URL}/${eventTypeRedirectUrl}${joiner}${allURLSearchParams}`;\n     }\n   }\n \n@@ -106,7 +108,8 @@ export function getAbsoluteEventTypeRedirectUrl({\n     ? form.teamOrigin\n     : form.userOrigin;\n \n-  return `${origin}/${eventTypeRedirectUrl}?${allURLSearchParams}`;\n+  const joiner = eventTypeRedirectUrl.includes(\"?\") ? \"&\" : \"?\";\n+  return `${origin}/${eventTypeRedirectUrl}${joiner}${allURLSearchParams}`;\n }\n \n export function getAbsoluteEventTypeRedirectUrlWithEmbedSupport(\ndiff --git a/packages/app-store/routing-forms/lib/substituteVariables.test.ts b/packages/app-store/routing-forms/lib/substituteVariables.test.ts\nindex c4caff09bea427..b944a652228bd0 100644\n--- a/packages/app-store/routing-forms/lib/substituteVariables.test.ts\n+++ b/packages/app-store/routing-forms/lib/substituteVariables.test.ts\n@@ -60,7 +60,7 @@ describe(\"substituteVariables\", () => {\n \n     const result = substituteVariables(routeValue, response, fields);\n \n-    expect(result).toBe(\"/team/sales-team/meeting\");\n+    expect(result).toBe(\"/team/Sales%20Team/meeting\");\n     expect(result).not.toBe(\"/team/sales-123/meeting\");\n     expect(result).not.toBe(\"/team/department/meeting\");\n   });\n@@ -78,10 +78,10 @@ describe(\"substituteVariables\", () => {\n \n     const result = substituteVariables(routeValue, response, fields);\n \n-    expect(result).toBe(\"/engineering/backend-team/book\");\n+    expect(result).toBe(\"/Engineering/Backend%20Team/book\");\n   });\n \n-  it(\"should handle special characters in labels by slugifying them\", () => {\n+  it(\"should handle special characters in labels by encoding them\", () => {\n     const fields = [\n       createSelectField(\"field1\", \"department\", \"Department\", [{ id: \"hr_dept\", label: \"HR & Recruitment\" }]),\n     ];\n@@ -89,7 +89,7 @@ describe(\"substituteVariables\", () => {\n     const response = createFormResponse(\"field1\", \"hr_dept\", \"Department\");\n \n     const result = substituteVariables(routeValue, response, fields);\n-    expect(result).toBe(\"/meeting/hr-recruitment\");\n+    expect(result).toBe(\"/meeting/HR%20%26%20Recruitment\");\n   });\n \n   it(\"should handle case-insensitive variable matching\", () => {\n@@ -102,7 +102,7 @@ describe(\"substituteVariables\", () => {\n     const response = createFormResponse(\"field1\", \"support-001\", \"Department\");\n \n     const result = substituteVariables(routeValue, response, fields);\n-    expect(result).toBe(\"/team/customer-support/schedule\");\n+    expect(result).toBe(\"/team/Customer%20Support/schedule\");\n   });\n \n   it(\"should not substitute variables that don't have matching fields\", () => {\n@@ -125,7 +125,7 @@ describe(\"substituteVariables\", () => {\n     const response = createFormResponse(\"field3\", [\"high\", \"urgent\"], \"Priority Level\");\n \n     const result = substituteVariables(routeValue, response, fields);\n-    expect(result).toBe(\"/priorities/high-urgent\");\n+    expect(result).toBe(\"/priorities/High%2CUrgent\");\n   });\n \n   it(\"should handle numeric labels\", () => {\n@@ -136,7 +136,7 @@ describe(\"substituteVariables\", () => {\n     const response = createFormResponse(\"field1\", \"room-id-123\", \"Department\");\n \n     const result = substituteVariables(routeValue, response, fields);\n-    expect(result).toBe(\"/room/room-404\");\n+    expect(result).toBe(\"/room/Room%20404\");\n   });\n \n   it(\"should not modify the URL if no variables are present\", () => {\n@@ -158,7 +158,7 @@ describe(\"substituteVariables\", () => {\n     const response = createFormResponse(\"field1\", \"marketing-789\", \"Department\");\n \n     const result = substituteVariables(routeValue, response, fields);\n-    expect(result).toBe(\"/event/marketing-pr?type=meeting&priority=high\");\n+    expect(result).toBe(\"/event/Marketing%20%26%20PR?type=meeting&priority=high\");\n   });\n \n   it(\"should substitute text field values directly\", () => {\n@@ -167,7 +167,7 @@ describe(\"substituteVariables\", () => {\n     const response = createFormResponse(\"field1\", \"John Doe\", \"Username\");\n \n     const result = substituteVariables(routeValue, response, fields);\n-    expect(result).toBe(\"/user/john-doe/profile\");\n+    expect(result).toBe(\"/user/John%20Doe/profile\");\n   });\n \n   it(\"should handle number field values\", () => {\n@@ -195,7 +195,7 @@ describe(\"substituteVariables\", () => {\n     };\n \n     const result = substituteVariables(routeValue, response, fields);\n-    expect(result).toBe(\"/tower-a/floor/404/engineering\");\n+    expect(result).toBe(\"/Tower%20A/floor/404/Engineering\");\n   });\n \n   it(\"should handle text fields with special characters\", () => {\n@@ -204,7 +204,7 @@ describe(\"substituteVariables\", () => {\n     const response = createFormResponse(\"field1\", \"Cal.com Platform & API\", \"Project Name\");\n \n     const result = substituteVariables(routeValue, response, fields);\n-    expect(result).toBe(\"/project/cal.com-platform-api/board\");\n+    expect(result).toBe(\"/project/Cal.com%20Platform%20%26%20API/board\");\n   });\n \n   it(\"should handle empty text field values\", () => {\n@@ -224,6 +224,6 @@ describe(\"substituteVariables\", () => {\n     const response = createFormResponse(\"field1\", \"Bug Report Summary\", \"Description\");\n \n     const result = substituteVariables(routeValue, response, fields);\n-    expect(result).toBe(\"/ticket/bug-report-summary\");\n+    expect(result).toBe(\"/ticket/Bug%20Report%20Summary\");\n   });\n });\ndiff --git a/packages/app-store/routing-forms/lib/substituteVariables.ts b/packages/app-store/routing-forms/lib/substituteVariables.ts\nindex 580755b851b60e..8f2857fddfe420 100644\n--- a/packages/app-store/routing-forms/lib/substituteVariables.ts\n+++ b/packages/app-store/routing-forms/lib/substituteVariables.ts\n@@ -1,5 +1,3 @@\n-import slugify from \"@calcom/lib/slugify\";\n-\n import type { FormResponse, NonRouterRoute, Field } from \"../types/types\";\n import getFieldIdentifier from \"./getFieldIdentifier\";\n import { getHumanReadableFieldResponseValue } from \"./responseData/getHumanReadableFieldResponseValue\";\n@@ -18,7 +16,7 @@ export const substituteVariables = (\n   response: FormResponse,\n   fields: Field[]\n ) => {\n-  const regex = /\\{([^\\}]+)\\}/g;\n+  const regex = /\\{([^}]+)\\}/g;\n   const variables: string[] = routeValue.match(regex)?.map((match: string) => match.slice(1, -1)) || [];\n \n   let eventTypeUrl = routeValue;\n@@ -35,8 +33,8 @@ export const substituteVariables = (\n           field,\n           value: response[key].value,\n         });\n-        // ['abc', 'def'] ----toString---> 'abc,def' ----slugify---> 'abc-def'\n-        const valueToSubstitute = slugify(humanReadableValues.toString());\n+        // ['abc', 'def'] ----toString---> 'abc,def' ----encode---> 'abc%2Cdef'\n+        const valueToSubstitute = encodeURIComponent(humanReadableValues.toString());\n         eventTypeUrl = eventTypeUrl.replace(`{${variable}}`, valueToSubstitute);\n       }\n     }\n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/calcom__cal.com.main/pr_mirror/calcom__cal.com.main.25499/metadata__pr_25499.json"
  },
  {
    "instance_id": "twentyhq__twenty.main.16070",
    "repo": "twentyhq/twenty",
    "pull_number": 16070,
    "base_commit": "7bf68e5f31575e6582692f9a06497ffb59699e0c",
    "patch": "diff --git a/packages/twenty-server/src/engine/core-modules/twenty-config/config-variables.ts b/packages/twenty-server/src/engine/core-modules/twenty-config/config-variables.ts\nindex 8904189de5ee1..d72b44186a19f 100644\n--- a/packages/twenty-server/src/engine/core-modules/twenty-config/config-variables.ts\n+++ b/packages/twenty-server/src/engine/core-modules/twenty-config/config-variables.ts\n@@ -975,7 +975,7 @@ export class ConfigVariables {\n     type: ConfigVariableType.NUMBER,\n   })\n   @CastToPositiveNumber()\n-  API_RATE_LIMITING_LONG_TTL_IN_MS = 60000;\n+  API_RATE_LIMITING_LONG_TTL_IN_MS = 60_000;\n \n   @ConfigVariablesMetadata({\n     group: ConfigVariablesGroup.RATE_LIMITING,\n@@ -994,6 +994,42 @@ export class ConfigVariables {\n   })\n   GRAPHQL_MAX_COMPLEXITY = 2000;\n \n+  @ConfigVariablesMetadata({\n+    group: ConfigVariablesGroup.RATE_LIMITING,\n+    description:\n+      'Time-to-live for workspace-level invitations resending rate limiting in milliseconds',\n+    type: ConfigVariableType.NUMBER,\n+  })\n+  @CastToPositiveNumber()\n+  INVITATION_SENDING_BY_WORKSPACE_THROTTLE_TTL_IN_MS = 604_800_000; // 7 days\n+\n+  @ConfigVariablesMetadata({\n+    group: ConfigVariablesGroup.RATE_LIMITING,\n+    description:\n+      'Maximum number of workspace-level invitations resending allowed in the rate limiting window',\n+    type: ConfigVariableType.NUMBER,\n+  })\n+  @CastToPositiveNumber()\n+  INVITATION_SENDING_BY_WORKSPACE_THROTTLE_LIMIT = 500;\n+\n+  @ConfigVariablesMetadata({\n+    group: ConfigVariablesGroup.RATE_LIMITING,\n+    description:\n+      'Time-to-live for email-level invitations sending rate limiting in milliseconds',\n+    type: ConfigVariableType.NUMBER,\n+  })\n+  @CastToPositiveNumber()\n+  INVITATION_SENDING_BY_EMAIL_THROTTLE_TTL_IN_MS = 604_800_000; // 7 days\n+\n+  @ConfigVariablesMetadata({\n+    group: ConfigVariablesGroup.RATE_LIMITING,\n+    description:\n+      'Maximum number of email-level invitations sending allowed in the rate limiting window',\n+    type: ConfigVariableType.NUMBER,\n+  })\n+  @CastToPositiveNumber()\n+  INVITATION_SENDING_BY_EMAIL_THROTTLE_LIMIT = 10;\n+\n   @ConfigVariablesMetadata({\n     group: ConfigVariablesGroup.SSL,\n     description: 'Path to the SSL key for enabling HTTPS in local development',\ndiff --git a/packages/twenty-server/src/engine/core-modules/workspace-invitation/services/workspace-invitation.service.spec.ts b/packages/twenty-server/src/engine/core-modules/workspace-invitation/services/workspace-invitation.service.spec.ts\nindex 4661d89b81895..c603b0b98dc84 100644\n--- a/packages/twenty-server/src/engine/core-modules/workspace-invitation/services/workspace-invitation.service.spec.ts\n+++ b/packages/twenty-server/src/engine/core-modules/workspace-invitation/services/workspace-invitation.service.spec.ts\n@@ -12,6 +12,7 @@ import { EmailService } from 'src/engine/core-modules/email/email.service';\n import { FileService } from 'src/engine/core-modules/file/services/file.service';\n import { I18nService } from 'src/engine/core-modules/i18n/i18n.service';\n import { OnboardingService } from 'src/engine/core-modules/onboarding/onboarding.service';\n+import { ThrottlerService } from 'src/engine/core-modules/throttler/throttler.service';\n import { TwentyConfigService } from 'src/engine/core-modules/twenty-config/twenty-config.service';\n import { UserWorkspaceEntity } from 'src/engine/core-modules/user-workspace/user-workspace.entity';\n import { WorkspaceInvitationException } from 'src/engine/core-modules/workspace-invitation/workspace-invitation.exception';\n@@ -112,6 +113,12 @@ describe('WorkspaceInvitationService', () => {\n               .mockReturnValue('https://signed-url.com/logo.png'),\n           },\n         },\n+        {\n+          provide: ThrottlerService,\n+          useValue: {\n+            tokenBucketThrottleOrThrow: jest.fn(),\n+          },\n+        },\n       ],\n     }).compile();\n \ndiff --git a/packages/twenty-server/src/engine/core-modules/workspace-invitation/services/workspace-invitation.service.ts b/packages/twenty-server/src/engine/core-modules/workspace-invitation/services/workspace-invitation.service.ts\nindex df6932a71d5bd..d6acc364997e1 100644\n--- a/packages/twenty-server/src/engine/core-modules/workspace-invitation/services/workspace-invitation.service.ts\n+++ b/packages/twenty-server/src/engine/core-modules/workspace-invitation/services/workspace-invitation.service.ts\n@@ -25,6 +25,7 @@ import { EmailService } from 'src/engine/core-modules/email/email.service';\n import { FileService } from 'src/engine/core-modules/file/services/file.service';\n import { I18nService } from 'src/engine/core-modules/i18n/i18n.service';\n import { OnboardingService } from 'src/engine/core-modules/onboarding/onboarding.service';\n+import { ThrottlerService } from 'src/engine/core-modules/throttler/throttler.service';\n import { TwentyConfigService } from 'src/engine/core-modules/twenty-config/twenty-config.service';\n import { UserWorkspaceEntity } from 'src/engine/core-modules/user-workspace/user-workspace.entity';\n import { type SendInvitationsOutput } from 'src/engine/core-modules/workspace-invitation/dtos/send-invitations.output';\n@@ -49,6 +50,7 @@ export class WorkspaceInvitationService {\n     private readonly workspaceDomainsService: WorkspaceDomainsService,\n     private readonly i18nService: I18nService,\n     private readonly fileService: FileService,\n+    private readonly throttlerService: ThrottlerService,\n   ) {}\n \n   async validatePersonalInvitation({\n@@ -262,6 +264,8 @@ export class WorkspaceInvitationService {\n       };\n     }\n \n+    await this.throttleInvitationSending(workspace.id, emails);\n+\n     const invitationsPr = await Promise.allSettled(\n       emails.map(async (email) => {\n         if (usePersonalInvitation) {\n@@ -421,4 +425,47 @@ export class WorkspaceInvitationService {\n \n     return this.appTokenRepository.save(invitationToken);\n   }\n+\n+  private async throttleInvitationSending(\n+    workspaceId: string,\n+    emails: string[],\n+  ) {\n+    try {\n+      //limit invitation sending for specific invite emails\n+      await Promise.all(\n+        emails.map(async (email) => {\n+          await this.throttlerService.tokenBucketThrottleOrThrow(\n+            `invitation-resending-workspace:throttler:${email}`,\n+            1,\n+            this.twentyConfigService.get(\n+              'INVITATION_SENDING_BY_EMAIL_THROTTLE_LIMIT',\n+            ),\n+            this.twentyConfigService.get(\n+              'INVITATION_SENDING_BY_EMAIL_THROTTLE_TTL_IN_MS',\n+            ),\n+          );\n+        }),\n+      );\n+\n+      //limit invitation sending for a specific workspace\n+      await this.throttlerService.tokenBucketThrottleOrThrow(\n+        `invitation-resending-workspace:throttler:${workspaceId}`,\n+        emails.length,\n+        this.twentyConfigService.get(\n+          'INVITATION_SENDING_BY_WORKSPACE_THROTTLE_LIMIT',\n+        ),\n+        this.twentyConfigService.get(\n+          'INVITATION_SENDING_BY_WORKSPACE_THROTTLE_TTL_IN_MS',\n+        ),\n+      );\n+    } catch {\n+      throw new WorkspaceInvitationException(\n+        'Workspace invitation sending rate limit exceeded.',\n+        WorkspaceInvitationExceptionCode.INVALID_INVITATION,\n+        {\n+          userFriendlyMessage: msg`Too many workspace invitations sent. Please try again later.`,\n+        },\n+      );\n+    }\n+  }\n }\ndiff --git a/packages/twenty-server/src/engine/core-modules/workspace-invitation/workspace-invitation.module.ts b/packages/twenty-server/src/engine/core-modules/workspace-invitation/workspace-invitation.module.ts\nindex becf292d1bc9a..c88b7fef67c0b 100644\n--- a/packages/twenty-server/src/engine/core-modules/workspace-invitation/workspace-invitation.module.ts\n+++ b/packages/twenty-server/src/engine/core-modules/workspace-invitation/workspace-invitation.module.ts\n@@ -7,6 +7,7 @@ import { WorkspaceDomainsModule } from 'src/engine/core-modules/domain/workspace\n import { FeatureFlagModule } from 'src/engine/core-modules/feature-flag/feature-flag.module';\n import { FileModule } from 'src/engine/core-modules/file/file.module';\n import { OnboardingModule } from 'src/engine/core-modules/onboarding/onboarding.module';\n+import { ThrottlerModule } from 'src/engine/core-modules/throttler/throttler.module';\n import { UserWorkspaceEntity } from 'src/engine/core-modules/user-workspace/user-workspace.entity';\n import { WorkspaceInvitationService } from 'src/engine/core-modules/workspace-invitation/services/workspace-invitation.service';\n import { WorkspaceInvitationResolver } from 'src/engine/core-modules/workspace-invitation/workspace-invitation.resolver';\n@@ -25,6 +26,7 @@ import { PermissionsModule } from 'src/engine/metadata-modules/permissions/permi\n     OnboardingModule,\n     PermissionsModule,\n     FeatureFlagModule,\n+    ThrottlerModule,\n   ],\n   exports: [WorkspaceInvitationService],\n   providers: [WorkspaceInvitationService, WorkspaceInvitationResolver],\ndiff --git a/packages/twenty-server/src/engine/core-modules/workspace-invitation/workspace-invitation.resolver.ts b/packages/twenty-server/src/engine/core-modules/workspace-invitation/workspace-invitation.resolver.ts\nindex bc71e5efec1f7..81fdce79036ee 100644\n--- a/packages/twenty-server/src/engine/core-modules/workspace-invitation/workspace-invitation.resolver.ts\n+++ b/packages/twenty-server/src/engine/core-modules/workspace-invitation/workspace-invitation.resolver.ts\n@@ -1,7 +1,6 @@\n import { UseFilters, UseGuards, UsePipes } from '@nestjs/common';\n import { Args, Mutation, Query, Resolver } from '@nestjs/graphql';\n \n-import { FileService } from 'src/engine/core-modules/file/services/file.service';\n import { PreventNestToAutoLogGraphqlErrorsFilter } from 'src/engine/core-modules/graphql/filters/prevent-nest-to-auto-log-graphql-errors.filter';\n import { ResolverValidationPipe } from 'src/engine/core-modules/graphql/pipes/resolver-validation.pipe';\n import { UserEntity } from 'src/engine/core-modules/user/user.entity';\n@@ -35,7 +34,6 @@ export class WorkspaceInvitationResolver {\n   constructor(\n     private readonly twentyORMGlobalManager: TwentyORMGlobalManager,\n     private readonly workspaceInvitationService: WorkspaceInvitationService,\n-    private readonly fileService: FileService,\n   ) {}\n \n   @Mutation(() => String)\n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/twentyhq__twenty.main/pr_mirror/twentyhq__twenty.main.16070/metadata__pr_16070.json"
  },
  {
    "instance_id": "twentyhq__twenty.main.16211",
    "repo": "twentyhq/twenty",
    "pull_number": 16211,
    "base_commit": "f489bbdbab893278ec8b808a71cc01f1ad29e2a1",
    "patch": "diff --git a/packages/twenty-front/src/modules/command-menu/pages/page-layout/components/chart-settings/ChartSettingItem.tsx b/packages/twenty-front/src/modules/command-menu/pages/page-layout/components/chart-settings/ChartSettingItem.tsx\nindex 8f8e795cd7dbc..45f2291deb7ef 100644\n--- a/packages/twenty-front/src/modules/command-menu/pages/page-layout/components/chart-settings/ChartSettingItem.tsx\n+++ b/packages/twenty-front/src/modules/command-menu/pages/page-layout/components/chart-settings/ChartSettingItem.tsx\n@@ -34,6 +34,9 @@ export const ChartSettingItem = ({\n   onFilterClick,\n }: ChartSettingItemProps) => {\n   if (item.id === CHART_CONFIGURATION_SETTING_IDS.FILTER) {\n+    const filterValue = getChartSettingsValues(item.id);\n+    const filterDescription = isString(filterValue) ? filterValue : undefined;\n+\n     return (\n       <SelectableListItem\n         key={item.id}\n@@ -46,6 +49,8 @@ export const ChartSettingItem = ({\n           Icon={item.Icon}\n           hasSubMenu\n           onClick={onFilterClick}\n+          description={filterDescription}\n+          contextualTextPosition=\"right\"\n         />\n       </SelectableListItem>\n     );\ndiff --git a/packages/twenty-front/src/modules/command-menu/pages/page-layout/hooks/useChartSettingsValues.ts b/packages/twenty-front/src/modules/command-menu/pages/page-layout/hooks/useChartSettingsValues.ts\nindex aa760e8de6711..7798663623ab2 100644\n--- a/packages/twenty-front/src/modules/command-menu/pages/page-layout/hooks/useChartSettingsValues.ts\n+++ b/packages/twenty-front/src/modules/command-menu/pages/page-layout/hooks/useChartSettingsValues.ts\n@@ -3,11 +3,13 @@ import { useGraphXSortOptionLabels } from '@/command-menu/pages/page-layout/hook\n import { type ChartConfiguration } from '@/command-menu/pages/page-layout/types/ChartConfiguration';\n import { CHART_CONFIGURATION_SETTING_IDS } from '@/command-menu/pages/page-layout/types/ChartConfigurationSettingIds';\n import { getChartAxisNameDisplayOptions } from '@/command-menu/pages/page-layout/utils/getChartAxisNameDisplayOptions';\n+import { getChartFilterRulesCount } from '@/command-menu/pages/page-layout/utils/getChartFilterRulesCount';\n import { getDateGranularityLabel } from '@/command-menu/pages/page-layout/utils/getDateGranularityLabel';\n import { getFieldLabelWithSubField } from '@/command-menu/pages/page-layout/utils/getFieldLabelWithSubField';\n import { objectMetadataItemsState } from '@/object-metadata/states/objectMetadataItemsState';\n import { getAggregateOperationLabel } from '@/object-record/record-board/record-board-column/utils/getAggregateOperationLabel';\n import { convertAggregateOperationToExtendedAggregateOperation } from '@/object-record/utils/convertAggregateOperationToExtendedAggregateOperation';\n+import { plural } from '@lingui/core/macro';\n import { useRecoilValue } from 'recoil';\n import { type CompositeFieldSubFieldName } from 'twenty-shared/types';\n import { capitalize, isDefined } from 'twenty-shared/utils';\n@@ -201,9 +203,18 @@ export const useChartSettingsValues = ({\n         return groupByOrderByLabel;\n       case CHART_CONFIGURATION_SETTING_IDS.DATA_LABELS:\n         return configuration.displayDataLabel ?? undefined;\n+      case CHART_CONFIGURATION_SETTING_IDS.FILTER: {\n+        const filterRulesCount = getChartFilterRulesCount(configuration.filter);\n+        return filterRulesCount > 0\n+          ? plural(filterRulesCount, {\n+              one: `${filterRulesCount} rule`,\n+              other: `${filterRulesCount} rules`,\n+            })\n+          : undefined;\n+      }\n       case CHART_CONFIGURATION_SETTING_IDS.CENTER_METRIC:\n         return isPieChart\n-          ? (configuration.showCenterMetric ?? undefined)\n+          ? (configuration.showCenterMetric ?? true)\n           : undefined;\n       case CHART_CONFIGURATION_SETTING_IDS.STACKED_BARS:\n         return configuration.__typename === 'BarChartConfiguration'\ndiff --git a/packages/twenty-front/src/modules/command-menu/pages/page-layout/utils/__tests__/getChartFilterRulesCount.test.ts b/packages/twenty-front/src/modules/command-menu/pages/page-layout/utils/__tests__/getChartFilterRulesCount.test.ts\nnew file mode 100644\nindex 0000000000000..1cec14447a7fd\n--- /dev/null\n+++ b/packages/twenty-front/src/modules/command-menu/pages/page-layout/utils/__tests__/getChartFilterRulesCount.test.ts\n@@ -0,0 +1,46 @@\n+import { type ChartFilters } from '@/command-menu/pages/page-layout/types/ChartFilters';\n+import { getChartFilterRulesCount } from '@/command-menu/pages/page-layout/utils/getChartFilterRulesCount';\n+\n+describe('getChartFilterRulesCount', () => {\n+  it('should return 0 for undefined filter', () => {\n+    expect(getChartFilterRulesCount(undefined)).toBe(0);\n+  });\n+\n+  it('should return 0 when no root group exists', () => {\n+    const filter: ChartFilters = {\n+      recordFilters: [],\n+      recordFilterGroups: [],\n+    };\n+\n+    expect(getChartFilterRulesCount(filter)).toBe(0);\n+  });\n+\n+  it('should return count of filters in root group', () => {\n+    const filter: ChartFilters = {\n+      recordFilterGroups: [\n+        { id: 'root', parentRecordFilterGroupId: undefined },\n+      ],\n+      recordFilters: [\n+        { id: 'filter-1', recordFilterGroupId: 'root' },\n+        { id: 'filter-2', recordFilterGroupId: 'root' },\n+      ],\n+    } as ChartFilters;\n+\n+    expect(getChartFilterRulesCount(filter)).toBe(2);\n+  });\n+\n+  it('should count both direct filters and nested groups as children', () => {\n+    const filter: ChartFilters = {\n+      recordFilterGroups: [\n+        { id: 'root', parentRecordFilterGroupId: undefined },\n+        { id: 'nested-group', parentRecordFilterGroupId: 'root' },\n+      ],\n+      recordFilters: [\n+        { id: 'filter-1', recordFilterGroupId: 'root' },\n+        { id: 'filter-2', recordFilterGroupId: 'nested-group' },\n+      ],\n+    } as ChartFilters;\n+\n+    expect(getChartFilterRulesCount(filter)).toBe(2);\n+  });\n+});\ndiff --git a/packages/twenty-front/src/modules/command-menu/pages/page-layout/utils/getChartFilterRulesCount.ts b/packages/twenty-front/src/modules/command-menu/pages/page-layout/utils/getChartFilterRulesCount.ts\nnew file mode 100644\nindex 0000000000000..da231a1a04574\n--- /dev/null\n+++ b/packages/twenty-front/src/modules/command-menu/pages/page-layout/utils/getChartFilterRulesCount.ts\n@@ -0,0 +1,31 @@\n+import { type ChartFilters } from '@/command-menu/pages/page-layout/types/ChartFilters';\n+import { isDefined } from 'twenty-shared/utils';\n+\n+export const getChartFilterRulesCount = (\n+  filter: ChartFilters | undefined,\n+): number => {\n+  if (!isDefined(filter)) {\n+    return 0;\n+  }\n+\n+  const recordFilters = filter.recordFilters ?? [];\n+  const recordFilterGroups = filter.recordFilterGroups ?? [];\n+\n+  const rootGroup = recordFilterGroups.find(\n+    (group) => !isDefined(group.parentRecordFilterGroupId),\n+  );\n+\n+  if (!isDefined(rootGroup)) {\n+    return 0;\n+  }\n+\n+  const childFiltersCount = recordFilters.filter(\n+    (recordFilter) => recordFilter.recordFilterGroupId === rootGroup.id,\n+  ).length;\n+\n+  const childGroupsCount = recordFilterGroups.filter(\n+    (group) => group.parentRecordFilterGroupId === rootGroup.id,\n+  ).length;\n+\n+  return childFiltersCount + childGroupsCount;\n+};\ndiff --git a/packages/twenty-front/src/modules/page-layout/widgets/graph/graphWidgetPieChart/components/GraphWidgetPieChart.tsx b/packages/twenty-front/src/modules/page-layout/widgets/graph/graphWidgetPieChart/components/GraphWidgetPieChart.tsx\nindex 190bbc878dc0f..ae063d786ef84 100644\n--- a/packages/twenty-front/src/modules/page-layout/widgets/graph/graphWidgetPieChart/components/GraphWidgetPieChart.tsx\n+++ b/packages/twenty-front/src/modules/page-layout/widgets/graph/graphWidgetPieChart/components/GraphWidgetPieChart.tsx\n@@ -71,7 +71,7 @@ export const GraphWidgetPieChart = ({\n   customFormatter,\n   onSliceClick,\n   showDataLabels = false,\n-  showCenterMetric = false,\n+  showCenterMetric = true,\n }: GraphWidgetPieChartProps) => {\n   const theme = useTheme();\n   const colorRegistry = createGraphColorRegistry(theme);\ndiff --git a/packages/twenty-front/src/modules/page-layout/widgets/graph/graphWidgetPieChart/hooks/useGraphPieChartWidgetData.ts b/packages/twenty-front/src/modules/page-layout/widgets/graph/graphWidgetPieChart/hooks/useGraphPieChartWidgetData.ts\nindex cdbc279ad5909..bceac7a8ba3f2 100644\n--- a/packages/twenty-front/src/modules/page-layout/widgets/graph/graphWidgetPieChart/hooks/useGraphPieChartWidgetData.ts\n+++ b/packages/twenty-front/src/modules/page-layout/widgets/graph/graphWidgetPieChart/hooks/useGraphPieChartWidgetData.ts\n@@ -61,7 +61,7 @@ export const useGraphPieChartWidgetData = ({\n     ...transformedData,\n     objectMetadataItem,\n     showDataLabels: configuration.displayDataLabel ?? false,\n-    showCenterMetric: configuration.showCenterMetric ?? false,\n+    showCenterMetric: configuration.showCenterMetric ?? true,\n     loading,\n     error,\n   };\ndiff --git a/packages/twenty-server/src/engine/core-modules/page-layout/dtos/pie-chart-configuration.dto.ts b/packages/twenty-server/src/engine/core-modules/page-layout/dtos/pie-chart-configuration.dto.ts\nindex 13014c268d5d1..3abdd1db3a6c8 100644\n--- a/packages/twenty-server/src/engine/core-modules/page-layout/dtos/pie-chart-configuration.dto.ts\n+++ b/packages/twenty-server/src/engine/core-modules/page-layout/dtos/pie-chart-configuration.dto.ts\n@@ -71,7 +71,7 @@ export class PieChartConfigurationDTO {\n   @IsOptional()\n   displayDataLabel?: boolean;\n \n-  @Field(() => Boolean, { nullable: true, defaultValue: false })\n+  @Field(() => Boolean, { nullable: true, defaultValue: true })\n   @IsBoolean()\n   @IsOptional()\n   showCenterMetric?: boolean;\n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/twentyhq__twenty.main/pr_mirror/twentyhq__twenty.main.16211/metadata__pr_16211.json"
  },
  {
    "instance_id": "twentyhq__twenty.main.16071",
    "repo": "twentyhq/twenty",
    "pull_number": 16071,
    "base_commit": "6c1c78ea3d94ac6dc3031c00bd67fa28aa5d16db",
    "patch": "diff --git a/packages/twenty-server/src/modules/messaging/message-import-manager/services/messaging-messages-import.service.spec.ts b/packages/twenty-server/src/modules/messaging/message-import-manager/services/messaging-messages-import.service.spec.ts\nindex f973b916cf4ef..f11d03923f6c2 100644\n--- a/packages/twenty-server/src/modules/messaging/message-import-manager/services/messaging-messages-import.service.spec.ts\n+++ b/packages/twenty-server/src/modules/messaging/message-import-manager/services/messaging-messages-import.service.spec.ts\n@@ -49,7 +49,7 @@ describe('MessagingMessagesImportService', () => {\n \n     mockMessageChannel = {\n       id: 'message-channel-id',\n-      syncStage: MessageChannelSyncStage.MESSAGES_IMPORT_PENDING,\n+      syncStage: MessageChannelSyncStage.MESSAGES_IMPORT_SCHEDULED,\n       connectedAccountId: mockConnectedAccount.id,\n       handle: 'test@gmail.com',\n     } as MessageChannelWorkspaceEntity;\n@@ -192,9 +192,9 @@ describe('MessagingMessagesImportService', () => {\n       );\n   });\n \n-  it('should fails if SyncStage is not MESSAGES_IMPORT_PENDING', async () => {\n+  it('should fails if SyncStage is not MESSAGES_IMPORT_SCHEDULED', async () => {\n     mockMessageChannel.syncStage =\n-      MessageChannelSyncStage.MESSAGE_LIST_FETCH_PENDING;\n+      MessageChannelSyncStage.MESSAGES_IMPORT_PENDING;\n \n     expect(\n       service.processMessageBatchImport(\ndiff --git a/packages/twenty-server/src/modules/messaging/message-import-manager/services/messaging-messages-import.service.ts b/packages/twenty-server/src/modules/messaging/message-import-manager/services/messaging-messages-import.service.ts\nindex 57ffaa8e4136c..73e448df7cf03 100644\n--- a/packages/twenty-server/src/modules/messaging/message-import-manager/services/messaging-messages-import.service.ts\n+++ b/packages/twenty-server/src/modules/messaging/message-import-manager/services/messaging-messages-import.service.ts\n@@ -53,7 +53,7 @@ export class MessagingMessagesImportService {\n     try {\n       if (\n         messageChannel.syncStage !==\n-        MessageChannelSyncStage.MESSAGES_IMPORT_PENDING\n+        MessageChannelSyncStage.MESSAGES_IMPORT_SCHEDULED\n       ) {\n         return;\n       }\n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/twentyhq__twenty.main/pr_mirror/twentyhq__twenty.main.16071/metadata__pr_16071.json"
  },
  {
    "instance_id": "twentyhq__twenty.main.16166",
    "repo": "twentyhq/twenty",
    "pull_number": 16166,
    "base_commit": "eb362c6d5f65eb49c726a6a2eccb2603732b8957",
    "patch": "diff --git a/packages/twenty-front/src/modules/command-menu/pages/page-layout/components/ChartTypeSelectionSection.tsx b/packages/twenty-front/src/modules/command-menu/pages/page-layout/components/ChartTypeSelectionSection.tsx\nindex 8657148271fd9..538a5020a7d91 100644\n--- a/packages/twenty-front/src/modules/command-menu/pages/page-layout/components/ChartTypeSelectionSection.tsx\n+++ b/packages/twenty-front/src/modules/command-menu/pages/page-layout/components/ChartTypeSelectionSection.tsx\n@@ -9,9 +9,9 @@ import { MenuPicker } from 'twenty-ui/navigation';\n const graphTypeOptions = [\n   GraphType.VERTICAL_BAR,\n   GraphType.HORIZONTAL_BAR,\n-  GraphType.AGGREGATE,\n-  GraphType.PIE,\n   GraphType.LINE,\n+  GraphType.PIE,\n+  GraphType.AGGREGATE,\n   GraphType.GAUGE,\n ];\n \n@@ -36,32 +36,25 @@ export const ChartTypeSelectionSection = ({\n \n   return (\n     <StyledChartTypeSelectionContainer>\n-      {graphTypeOptions.map((graphType) => {\n-        const isChartV2Type = [\n-          GraphType.PIE,\n-          GraphType.LINE,\n-          GraphType.GAUGE,\n-        ].includes(graphType);\n-\n-        const isDisabled = isChartV2Type && !isDashboardV2Enabled;\n-\n-        return (\n-          <MenuPicker\n-            id={graphType}\n-            selected={currentGraphType === graphType}\n-            key={graphType}\n-            icon={GRAPH_TYPE_INFORMATION[graphType].icon}\n-            onClick={() => {\n-              setCurrentGraphType(graphType);\n-            }}\n-            showLabel\n-            disabled={isDisabled}\n-            tooltipContent={\n-              isDisabled ? t`Soon` : t(GRAPH_TYPE_INFORMATION[graphType].label)\n-            }\n-          />\n-        );\n-      })}\n+      {graphTypeOptions\n+        .filter(\n+          (graphType) => isDashboardV2Enabled || graphType !== GraphType.GAUGE,\n+        )\n+        .map((graphType) => {\n+          return (\n+            <MenuPicker\n+              id={graphType}\n+              selected={currentGraphType === graphType}\n+              key={graphType}\n+              icon={GRAPH_TYPE_INFORMATION[graphType].icon}\n+              onClick={() => {\n+                setCurrentGraphType(graphType);\n+              }}\n+              showLabel\n+              tooltipContent={t(GRAPH_TYPE_INFORMATION[graphType].label)}\n+            />\n+          );\n+        })}\n     </StyledChartTypeSelectionContainer>\n   );\n };\ndiff --git a/packages/twenty-server/src/engine/core-modules/page-layout/utils/__tests__/validate-and-transform-widget-configuration.util.spec.ts b/packages/twenty-server/src/engine/core-modules/page-layout/utils/__tests__/validate-and-transform-widget-configuration.util.spec.ts\nindex f532f54f66db5..5000aaf463489 100644\n--- a/packages/twenty-server/src/engine/core-modules/page-layout/utils/__tests__/validate-and-transform-widget-configuration.util.spec.ts\n+++ b/packages/twenty-server/src/engine/core-modules/page-layout/utils/__tests__/validate-and-transform-widget-configuration.util.spec.ts\n@@ -247,33 +247,35 @@ describe('validateAndTransformWidgetConfiguration', () => {\n   });\n \n   describe('Feature flags', () => {\n-    it('should throw error for unsupported graph type', () => {\n+    it('should throw error for GAUGE chart type when IS_DASHBOARD_V2_ENABLED is false', () => {\n       expect(() =>\n         validateAndTransformWidgetConfiguration({\n           type: WidgetType.GRAPH,\n-          configuration: TEST_PIE_CHART_CONFIG,\n+          configuration: TEST_GAUGE_CHART_CONFIG,\n           isDashboardV2Enabled: false,\n         }),\n       ).toThrow(/IS_DASHBOARD_V2_ENABLED feature flag/);\n+    });\n \n+    it('should not throw error for GAUGE chart type when IS_DASHBOARD_V2_ENABLED is true', () => {\n       expect(() =>\n         validateAndTransformWidgetConfiguration({\n           type: WidgetType.GRAPH,\n-          configuration: TEST_LINE_CHART_CONFIG,\n-          isDashboardV2Enabled: false,\n+          configuration: TEST_GAUGE_CHART_CONFIG,\n+          isDashboardV2Enabled: true,\n         }),\n-      ).toThrow(/IS_DASHBOARD_V2_ENABLED feature flag/);\n+      ).not.toThrow();\n+    });\n \n+    it('should not throw error for PIE chart type regardless of IS_DASHBOARD_V2_ENABLED', () => {\n       expect(() =>\n         validateAndTransformWidgetConfiguration({\n           type: WidgetType.GRAPH,\n-          configuration: TEST_GAUGE_CHART_CONFIG,\n+          configuration: TEST_PIE_CHART_CONFIG,\n           isDashboardV2Enabled: false,\n         }),\n-      ).toThrow(/IS_DASHBOARD_V2_ENABLED feature flag/);\n-    });\n+      ).not.toThrow();\n \n-    it('should not throw error when IS_DASHBOARD_V2_ENABLED feature flag is enabled', () => {\n       expect(() =>\n         validateAndTransformWidgetConfiguration({\n           type: WidgetType.GRAPH,\n@@ -283,21 +285,19 @@ describe('validateAndTransformWidgetConfiguration', () => {\n       ).not.toThrow();\n     });\n \n-    it('should not throw error when IS_DASHBOARD_V2_ENABLED feature flag is enabled', () => {\n+    it('should not throw error for LINE chart type regardless of IS_DASHBOARD_V2_ENABLED', () => {\n       expect(() =>\n         validateAndTransformWidgetConfiguration({\n           type: WidgetType.GRAPH,\n           configuration: TEST_LINE_CHART_CONFIG,\n-          isDashboardV2Enabled: true,\n+          isDashboardV2Enabled: false,\n         }),\n       ).not.toThrow();\n-    });\n \n-    it('should not throw error when IS_DASHBOARD_V2_ENABLED feature flag is enabled', () => {\n       expect(() =>\n         validateAndTransformWidgetConfiguration({\n           type: WidgetType.GRAPH,\n-          configuration: TEST_GAUGE_CHART_CONFIG,\n+          configuration: TEST_LINE_CHART_CONFIG,\n           isDashboardV2Enabled: true,\n         }),\n       ).not.toThrow();\ndiff --git a/packages/twenty-server/src/engine/core-modules/page-layout/utils/validate-and-transform-widget-configuration.util.ts b/packages/twenty-server/src/engine/core-modules/page-layout/utils/validate-and-transform-widget-configuration.util.ts\nindex c511f669d75eb..68f8b17a28389 100644\n--- a/packages/twenty-server/src/engine/core-modules/page-layout/utils/validate-and-transform-widget-configuration.util.ts\n+++ b/packages/twenty-server/src/engine/core-modules/page-layout/utils/validate-and-transform-widget-configuration.util.ts\n@@ -38,9 +38,7 @@ const validateGraphConfiguration = ({\n     return null;\n   }\n \n-  const v2ChartTypes = [GraphType.PIE, GraphType.LINE, GraphType.GAUGE];\n-\n-  if (v2ChartTypes.includes(graphType) && !isDashboardV2Enabled) {\n+  if (graphType === GraphType.GAUGE && !isDashboardV2Enabled) {\n     throw new Error(\n       `Chart type ${graphType} requires IS_DASHBOARD_V2_ENABLED feature flag`,\n     );\n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/twentyhq__twenty.main/pr_mirror/twentyhq__twenty.main.16166/metadata__pr_16166.json"
  },
  {
    "instance_id": "twentyhq__twenty.main.16132",
    "repo": "twentyhq/twenty",
    "pull_number": 16132,
    "base_commit": "57ae12ff7c5d1a3f2bbfaf46ca50e7bb11e8e0af",
    "patch": "diff --git a/packages/twenty-server/src/engine/api/common/common-result-getters/common-result-getters.service.ts b/packages/twenty-server/src/engine/api/common/common-result-getters/common-result-getters.service.ts\nindex 1d5981020252f..437ede452fc31 100644\n--- a/packages/twenty-server/src/engine/api/common/common-result-getters/common-result-getters.service.ts\n+++ b/packages/twenty-server/src/engine/api/common/common-result-getters/common-result-getters.service.ts\n@@ -18,7 +18,10 @@ import { FileService } from 'src/engine/core-modules/file/services/file.service'\n import { type FlatEntityMaps } from 'src/engine/metadata-modules/flat-entity/types/flat-entity-maps.type';\n import { findFlatEntityByIdInFlatEntityMapsOrThrow } from 'src/engine/metadata-modules/flat-entity/utils/find-flat-entity-by-id-in-flat-entity-maps-or-throw.util';\n import { type FlatFieldMetadata } from 'src/engine/metadata-modules/flat-field-metadata/types/flat-field-metadata.type';\n-import { buildFieldMapsFromFlatObjectMetadata } from 'src/engine/metadata-modules/flat-field-metadata/utils/build-field-maps-from-flat-object-metadata.util';\n+import {\n+  buildFieldMapsFromFlatObjectMetadata,\n+  type FieldMapsForObject,\n+} from 'src/engine/metadata-modules/flat-field-metadata/utils/build-field-maps-from-flat-object-metadata.util';\n import { isFlatFieldMetadataOfType } from 'src/engine/metadata-modules/flat-field-metadata/utils/is-flat-field-metadata-of-type.util';\n import { type FlatObjectMetadata } from 'src/engine/metadata-modules/flat-object-metadata/types/flat-object-metadata.type';\n \n@@ -54,6 +57,11 @@ export class CommonResultGettersService {\n     flatFieldMetadataMaps: FlatEntityMaps<FlatFieldMetadata>,\n     workspaceId: string,\n   ) {\n+    const fieldMaps = buildFieldMapsFromFlatObjectMetadata(\n+      flatFieldMetadataMaps,\n+      flatObjectMetadata,\n+    );\n+\n     return await Promise.all(\n       recordArray.map(\n         async (record: ObjectRecord) =>\n@@ -63,6 +71,7 @@ export class CommonResultGettersService {\n             flatObjectMetadataMaps,\n             flatFieldMetadataMaps,\n             workspaceId,\n+            fieldMaps,\n           ),\n       ),\n     );\n@@ -74,13 +83,18 @@ export class CommonResultGettersService {\n     flatObjectMetadataMaps: FlatEntityMaps<FlatObjectMetadata>,\n     flatFieldMetadataMaps: FlatEntityMaps<FlatFieldMetadata>,\n     workspaceId: string,\n+    fieldMapsForObject?: FieldMapsForObject,\n   ): Promise<ObjectRecord> {\n     const handler = this.getHandler(flatObjectMetadata.nameSingular);\n \n-    const { fieldIdByName } = buildFieldMapsFromFlatObjectMetadata(\n-      flatFieldMetadataMaps,\n-      flatObjectMetadata,\n-    );\n+    const fieldMaps =\n+      fieldMapsForObject ??\n+      buildFieldMapsFromFlatObjectMetadata(\n+        flatFieldMetadataMaps,\n+        flatObjectMetadata,\n+      );\n+\n+    const { fieldIdByName } = fieldMaps;\n \n     const relationFields = Object.keys(record)\n       .map(\ndiff --git a/packages/twenty-server/src/engine/api/graphql/graphql-query-runner/helpers/process-nested-relations-v2.helper.ts b/packages/twenty-server/src/engine/api/graphql/graphql-query-runner/helpers/process-nested-relations-v2.helper.ts\nindex 7b22692a4c90f..f4f6017ee0172 100644\n--- a/packages/twenty-server/src/engine/api/graphql/graphql-query-runner/helpers/process-nested-relations-v2.helper.ts\n+++ b/packages/twenty-server/src/engine/api/graphql/graphql-query-runner/helpers/process-nested-relations-v2.helper.ts\n@@ -17,7 +17,10 @@ import { type AuthContext } from 'src/engine/core-modules/auth/types/auth-contex\n import { FlatEntityMaps } from 'src/engine/metadata-modules/flat-entity/types/flat-entity-maps.type';\n import { findFlatEntityByIdInFlatEntityMaps } from 'src/engine/metadata-modules/flat-entity/utils/find-flat-entity-by-id-in-flat-entity-maps.util';\n import { FlatFieldMetadata } from 'src/engine/metadata-modules/flat-field-metadata/types/flat-field-metadata.type';\n-import { buildFieldMapsFromFlatObjectMetadata } from 'src/engine/metadata-modules/flat-field-metadata/utils/build-field-maps-from-flat-object-metadata.util';\n+import {\n+  buildFieldMapsFromFlatObjectMetadata,\n+  type FieldMapsForObject,\n+} from 'src/engine/metadata-modules/flat-field-metadata/utils/build-field-maps-from-flat-object-metadata.util';\n import { FlatObjectMetadata } from 'src/engine/metadata-modules/flat-object-metadata/types/flat-object-metadata.type';\n import { type WorkspaceDataSource } from 'src/engine/twenty-orm/datasource/workspace.datasource';\n import { type WorkspaceSelectQueryBuilder } from 'src/engine/twenty-orm/repository/workspace-select-query-builder';\n@@ -112,13 +115,13 @@ export class ProcessNestedRelationsV2Helper {\n     rolePermissionConfig?: RolePermissionConfig;\n     selectedFields: Record<string, unknown>;\n   }): Promise<void> {\n-    const { fieldIdByName } = buildFieldMapsFromFlatObjectMetadata(\n+    const fieldMaps = buildFieldMapsFromFlatObjectMetadata(\n       flatFieldMetadataMaps,\n       parentObjectMetadataItem,\n     );\n \n     const sourceFieldMetadata = findFlatEntityByIdInFlatEntityMaps({\n-      flatEntityId: fieldIdByName[sourceFieldName],\n+      flatEntityId: fieldMaps.fieldIdByName[sourceFieldName],\n       flatEntityMaps: flatFieldMetadataMaps,\n     });\n \n@@ -154,6 +157,7 @@ export class ProcessNestedRelationsV2Helper {\n         flatFieldMetadataMaps,\n         parentObjectMetadataItem,\n         sourceFieldName,\n+        fieldMaps,\n       });\n \n     const targetObjectRepository = workspaceDataSource.getRepository(\n@@ -250,19 +254,16 @@ export class ProcessNestedRelationsV2Helper {\n     flatFieldMetadataMaps,\n     parentObjectMetadataItem,\n     sourceFieldName,\n+    fieldMaps,\n   }: {\n     flatObjectMetadataMaps: FlatEntityMaps<FlatObjectMetadata>;\n     flatFieldMetadataMaps: FlatEntityMaps<FlatFieldMetadata>;\n     parentObjectMetadataItem: FlatObjectMetadata;\n     sourceFieldName: string;\n+    fieldMaps: FieldMapsForObject;\n   }) {\n-    const { fieldIdByName } = buildFieldMapsFromFlatObjectMetadata(\n-      flatFieldMetadataMaps,\n-      parentObjectMetadataItem,\n-    );\n-\n     const targetFieldMetadata = findFlatEntityByIdInFlatEntityMaps({\n-      flatEntityId: fieldIdByName[sourceFieldName],\n+      flatEntityId: fieldMaps.fieldIdByName[sourceFieldName],\n       flatEntityMaps: flatFieldMetadataMaps,\n     });\n \ndiff --git a/packages/twenty-server/src/engine/twenty-orm/entity-manager/workspace-entity-manager.spec.ts b/packages/twenty-server/src/engine/twenty-orm/entity-manager/workspace-entity-manager.spec.ts\nindex c9a6f077e92dc..671b9c73728e8 100644\n--- a/packages/twenty-server/src/engine/twenty-orm/entity-manager/workspace-entity-manager.spec.ts\n+++ b/packages/twenty-server/src/engine/twenty-orm/entity-manager/workspace-entity-manager.spec.ts\n@@ -13,6 +13,7 @@ import { type FlatFieldMetadata } from 'src/engine/metadata-modules/flat-field-m\n import { type FlatObjectMetadata } from 'src/engine/metadata-modules/flat-object-metadata/types/flat-object-metadata.type';\n import { type WorkspaceDataSource } from 'src/engine/twenty-orm/datasource/workspace.datasource';\n import { validateOperationIsPermittedOrThrow } from 'src/engine/twenty-orm/repository/permissions.utils';\n+import { getObjectMetadataFromEntityTarget } from 'src/engine/twenty-orm/utils/get-object-metadata-from-entity-target.util';\n \n import { WorkspaceEntityManager } from './workspace-entity-manager';\n \n@@ -23,7 +24,7 @@ jest.mock('src/engine/twenty-orm/repository/permissions.utils', () => ({\n jest.mock(\n   'src/engine/twenty-orm/utils/get-object-metadata-from-entity-target.util',\n   () => ({\n-    getObjectMetadataFromEntityTarget: jest.fn().mockReturnValue({}),\n+    getObjectMetadataFromEntityTarget: jest.fn(),\n   }),\n );\n \n@@ -117,6 +118,10 @@ describe('WorkspaceEntityManager', () => {\n       updatedAt: new Date(),\n     };\n \n+    (getObjectMetadataFromEntityTarget as jest.Mock).mockReturnValue(\n+      mockFlatObjectMetadata,\n+    );\n+\n     const mockFlatFieldMetadata: FlatFieldMetadata = {\n       id: 'field-id',\n       type: 'TEXT' as FieldMetadataType,\ndiff --git a/packages/twenty-server/src/engine/twenty-orm/utils/compute-relation-connect-query-configs.util.ts b/packages/twenty-server/src/engine/twenty-orm/utils/compute-relation-connect-query-configs.util.ts\nindex 908e27975e1e2..b0fa4b7eec3a7 100644\n--- a/packages/twenty-server/src/engine/twenty-orm/utils/compute-relation-connect-query-configs.util.ts\n+++ b/packages/twenty-server/src/engine/twenty-orm/utils/compute-relation-connect-query-configs.util.ts\n@@ -9,7 +9,10 @@ import { getFlatFieldsFromFlatObjectMetadata } from 'src/engine/api/graphql/work\n import { isCompositeFieldMetadataType } from 'src/engine/metadata-modules/field-metadata/utils/is-composite-field-metadata-type.util';\n import { type FlatEntityMaps } from 'src/engine/metadata-modules/flat-entity/types/flat-entity-maps.type';\n import { type FlatFieldMetadata } from 'src/engine/metadata-modules/flat-field-metadata/types/flat-field-metadata.type';\n-import { buildFieldMapsFromFlatObjectMetadata } from 'src/engine/metadata-modules/flat-field-metadata/utils/build-field-maps-from-flat-object-metadata.util';\n+import {\n+  buildFieldMapsFromFlatObjectMetadata,\n+  type FieldMapsForObject,\n+} from 'src/engine/metadata-modules/flat-field-metadata/utils/build-field-maps-from-flat-object-metadata.util';\n import { type FlatIndexMetadata } from 'src/engine/metadata-modules/flat-index-metadata/types/flat-index-metadata.type';\n import { type FlatObjectMetadata } from 'src/engine/metadata-modules/flat-object-metadata/types/flat-object-metadata.type';\n import { type ConnectObject } from 'src/engine/twenty-orm/entity-manager/types/query-deep-partial-entity-with-nested-relation-fields.type';\n@@ -36,6 +39,11 @@ export const computeRelationConnectQueryConfigs = (\n ) => {\n   const allConnectQueryConfigs: Record<string, RelationConnectQueryConfig> = {};\n \n+  const fieldMaps = buildFieldMapsFromFlatObjectMetadata(\n+    flatFieldMetadataMaps,\n+    flatObjectMetadata,\n+  );\n+\n   for (const [entityIndex, entity] of entities.entries()) {\n     const nestedRelationConnectFields =\n       relationConnectQueryFieldsByEntityIndex[entityIndex];\n@@ -57,6 +65,7 @@ export const computeRelationConnectQueryConfigs = (\n         flatFieldMetadataMaps,\n         flatIndexMaps,\n         entity,\n+        fieldMaps,\n       );\n \n       const connectQueryConfig = allConnectQueryConfigs[connectFieldName];\n@@ -132,17 +141,14 @@ const computeRecordToConnectCondition = (\n   flatFieldMetadataMaps: FlatEntityMaps<FlatFieldMetadata>,\n   flatIndexMaps: FlatEntityMaps<FlatIndexMetadata>,\n   entity: Record<string, unknown>,\n+  fieldMaps: FieldMapsForObject,\n ): {\n   recordToConnectCondition: UniqueConstraintCondition;\n   uniqueConstraintFields: FlatFieldMetadata<FieldMetadataType>[];\n   targetObjectNameSingular: string;\n } => {\n-  const { fieldIdByName } = buildFieldMapsFromFlatObjectMetadata(\n-    flatFieldMetadataMaps,\n-    flatObjectMetadata,\n-  );\n-\n-  const field = flatFieldMetadataMaps.byId[fieldIdByName[connectFieldName]];\n+  const field =\n+    flatFieldMetadataMaps.byId[fieldMaps.fieldIdByName[connectFieldName]];\n \n   if (\n     !isDefined(field) ||\ndiff --git a/packages/twenty-server/src/engine/twenty-orm/utils/format-data.util.ts b/packages/twenty-server/src/engine/twenty-orm/utils/format-data.util.ts\nindex fe15bc2454682..156788a126990 100644\n--- a/packages/twenty-server/src/engine/twenty-orm/utils/format-data.util.ts\n+++ b/packages/twenty-server/src/engine/twenty-orm/utils/format-data.util.ts\n@@ -7,7 +7,10 @@ import { capitalize } from 'twenty-shared/utils';\n import { isCompositeFieldMetadataType } from 'src/engine/metadata-modules/field-metadata/utils/is-composite-field-metadata-type.util';\n import { type FlatEntityMaps } from 'src/engine/metadata-modules/flat-entity/types/flat-entity-maps.type';\n import { type FlatFieldMetadata } from 'src/engine/metadata-modules/flat-field-metadata/types/flat-field-metadata.type';\n-import { buildFieldMapsFromFlatObjectMetadata } from 'src/engine/metadata-modules/flat-field-metadata/utils/build-field-maps-from-flat-object-metadata.util';\n+import {\n+  buildFieldMapsFromFlatObjectMetadata,\n+  type FieldMapsForObject,\n+} from 'src/engine/metadata-modules/flat-field-metadata/utils/build-field-maps-from-flat-object-metadata.util';\n import { type FlatObjectMetadata } from 'src/engine/metadata-modules/flat-object-metadata/types/flat-object-metadata.type';\n import { type CompositeFieldMetadataType } from 'src/engine/metadata-modules/workspace-migration/factories/composite-column-action.factory';\n \n@@ -15,22 +18,26 @@ export function formatData<T>(\n   data: T,\n   flatObjectMetadata: FlatObjectMetadata,\n   flatFieldMetadataMaps: FlatEntityMaps<FlatFieldMetadata>,\n+  fieldMapsForObject?: FieldMapsForObject,\n ): T {\n   if (!data) {\n     return data;\n   }\n \n+  const fieldMaps =\n+    fieldMapsForObject ??\n+    buildFieldMapsFromFlatObjectMetadata(\n+      flatFieldMetadataMaps,\n+      flatObjectMetadata,\n+    );\n+\n   if (Array.isArray(data)) {\n     return data.map((item) =>\n-      formatData(item, flatObjectMetadata, flatFieldMetadataMaps),\n+      formatData(item, flatObjectMetadata, flatFieldMetadataMaps, fieldMaps),\n     ) as T;\n   }\n \n-  const { fieldIdByName, fieldIdByJoinColumnName } =\n-    buildFieldMapsFromFlatObjectMetadata(\n-      flatFieldMetadataMaps,\n-      flatObjectMetadata,\n-    );\n+  const { fieldIdByName, fieldIdByJoinColumnName } = fieldMaps;\n \n   // eslint-disable-next-line @typescript-eslint/no-explicit-any\n   const newData: Record<string, any> = {};\ndiff --git a/packages/twenty-server/src/engine/twenty-orm/utils/format-result.util.ts b/packages/twenty-server/src/engine/twenty-orm/utils/format-result.util.ts\nindex c04f9a15316dd..210050b24c87d 100644\n--- a/packages/twenty-server/src/engine/twenty-orm/utils/format-result.util.ts\n+++ b/packages/twenty-server/src/engine/twenty-orm/utils/format-result.util.ts\n@@ -16,7 +16,10 @@ import { getFlatFieldsFromFlatObjectMetadata } from 'src/engine/api/graphql/work\n import { computeCompositeColumnName } from 'src/engine/metadata-modules/field-metadata/utils/compute-column-name.util';\n import { type FlatEntityMaps } from 'src/engine/metadata-modules/flat-entity/types/flat-entity-maps.type';\n import { type FlatFieldMetadata } from 'src/engine/metadata-modules/flat-field-metadata/types/flat-field-metadata.type';\n-import { buildFieldMapsFromFlatObjectMetadata } from 'src/engine/metadata-modules/flat-field-metadata/utils/build-field-maps-from-flat-object-metadata.util';\n+import {\n+  buildFieldMapsFromFlatObjectMetadata,\n+  type FieldMapsForObject,\n+} from 'src/engine/metadata-modules/flat-field-metadata/utils/build-field-maps-from-flat-object-metadata.util';\n import { type FlatObjectMetadata } from 'src/engine/metadata-modules/flat-object-metadata/types/flat-object-metadata.type';\n import { getCompositeFieldMetadataCollection } from 'src/engine/twenty-orm/utils/get-composite-field-metadata-collection';\n import { isFieldMetadataEntityOfType } from 'src/engine/utils/is-field-metadata-of-type.util';\n@@ -27,23 +30,25 @@ export function formatResult<T>(\n   flatObjectMetadata: FlatObjectMetadata | undefined,\n   flatObjectMetadataMaps: FlatEntityMaps<FlatObjectMetadata>,\n   flatFieldMetadataMaps: FlatEntityMaps<FlatFieldMetadata>,\n+  fieldMapsForObject?: FieldMapsForObject,\n ): T {\n   if (!isDefined(data)) {\n     return data;\n   }\n \n-  if (Array.isArray(data)) {\n-    return data.map((item) =>\n-      formatResult(\n-        item,\n-        flatObjectMetadata,\n-        flatObjectMetadataMaps,\n-        flatFieldMetadataMaps,\n-      ),\n-    ) as T;\n-  }\n-\n   if (!isPlainObject(data)) {\n+    if (Array.isArray(data)) {\n+      return data.map((item) =>\n+        formatResult(\n+          item,\n+          flatObjectMetadata,\n+          flatObjectMetadataMaps,\n+          flatFieldMetadataMaps,\n+          fieldMapsForObject,\n+        ),\n+      ) as T;\n+    }\n+\n     return data;\n   }\n \n@@ -51,10 +56,14 @@ export function formatResult<T>(\n     throw new Error('Object metadata is missing');\n   }\n \n-  const { fieldIdByName } = buildFieldMapsFromFlatObjectMetadata(\n-    flatFieldMetadataMaps,\n-    flatObjectMetadata,\n-  );\n+  const fieldMaps =\n+    fieldMapsForObject ??\n+    buildFieldMapsFromFlatObjectMetadata(\n+      flatFieldMetadataMaps,\n+      flatObjectMetadata,\n+    );\n+\n+  const { fieldIdByName } = fieldMaps;\n \n   const compositeFieldMetadataMap = getCompositeFieldMetadataMap(\n     flatObjectMetadata,\n@@ -86,6 +95,7 @@ export function formatResult<T>(\n           flatObjectMetadata,\n           flatObjectMetadataMaps,\n           flatFieldMetadataMaps,\n+          fieldMaps,\n         );\n       } else if (fieldMetadata) {\n         // @ts-expect-error legacy noImplicitAny\n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/twentyhq__twenty.main/pr_mirror/twentyhq__twenty.main.16132/metadata__pr_16132.json"
  },
  {
    "instance_id": "twentyhq__twenty.main.16143",
    "repo": "twentyhq/twenty",
    "pull_number": 16143,
    "base_commit": "65480eb49250765e3b788147fb08d4a950f15496",
    "patch": "diff --git a/packages/twenty-front/src/modules/command-menu/pages/page-layout/components/dropdown-content/ChartGroupByFieldSelectionDropdownContentBase.tsx b/packages/twenty-front/src/modules/command-menu/pages/page-layout/components/dropdown-content/ChartGroupByFieldSelectionDropdownContentBase.tsx\nindex 95ecff89643c4..f6aa974cc6547 100644\n--- a/packages/twenty-front/src/modules/command-menu/pages/page-layout/components/dropdown-content/ChartGroupByFieldSelectionDropdownContentBase.tsx\n+++ b/packages/twenty-front/src/modules/command-menu/pages/page-layout/components/dropdown-content/ChartGroupByFieldSelectionDropdownContentBase.tsx\n@@ -3,6 +3,7 @@ import { usePageLayoutIdFromContextStoreTargetedRecord } from '@/command-menu/pa\n import { useUpdateCurrentWidgetConfig } from '@/command-menu/pages/page-layout/hooks/useUpdateCurrentWidgetConfig';\n import { useWidgetInEditMode } from '@/command-menu/pages/page-layout/hooks/useWidgetInEditMode';\n import { type ChartConfiguration } from '@/command-menu/pages/page-layout/types/ChartConfiguration';\n+import { buildChartGroupByFieldConfigUpdate } from '@/command-menu/pages/page-layout/utils/buildChartGroupByFieldConfigUpdate';\n import { useObjectMetadataItems } from '@/object-metadata/hooks/useObjectMetadataItems';\n import { type FieldMetadataItem } from '@/object-metadata/types/FieldMetadataItem';\n import { isCompositeFieldType } from '@/object-record/object-filter-dropdown/utils/isCompositeFieldType';\n@@ -22,7 +23,6 @@ import { useMemo, useState } from 'react';\n import { isDefined } from 'twenty-shared/utils';\n import { useIcons } from 'twenty-ui/display';\n import { MenuItemSelect } from 'twenty-ui/navigation';\n-import { BarChartGroupMode } from '~/generated/graphql';\n import { filterBySearchQuery } from '~/utils/filterBySearchQuery';\n \n type ChartGroupByFieldSelectionDropdownContentBaseProps<\n@@ -93,48 +93,18 @@ export const ChartGroupByFieldSelectionDropdownContentBase = <\n     return null;\n   }\n \n-  const buildConfigUpdate = (\n-    fieldId: string | null,\n-    subFieldName: string | null,\n-  ) => {\n-    const isSecondaryAxis =\n-      fieldMetadataIdKey === 'secondaryAxisGroupByFieldMetadataId';\n-    const baseConfig = {\n-      [fieldMetadataIdKey]: fieldId,\n-      [subFieldNameKey]: subFieldName,\n-    };\n-\n-    if (!isSecondaryAxis) {\n-      return baseConfig;\n-    }\n-\n-    if (configuration.__typename === 'BarChartConfiguration') {\n-      return {\n-        ...baseConfig,\n-        groupMode: isDefined(fieldId)\n-          ? (configuration.groupMode ?? BarChartGroupMode.STACKED)\n-          : null,\n-      };\n-    }\n-\n-    if (configuration.__typename === 'LineChartConfiguration') {\n-      return {\n-        ...baseConfig,\n-        isStacked: isDefined(fieldId)\n-          ? (configuration.isStacked ?? true)\n-          : null,\n-      };\n-    }\n-\n-    return baseConfig;\n-  };\n-\n   const handleSelectField = (fieldMetadataItem: FieldMetadataItem) => {\n     if (isCompositeFieldType(fieldMetadataItem.type)) {\n       setSelectedCompositeField(fieldMetadataItem);\n     } else {\n       updateCurrentWidgetConfig({\n-        configToUpdate: buildConfigUpdate(fieldMetadataItem.id, null),\n+        configToUpdate: buildChartGroupByFieldConfigUpdate({\n+          configuration,\n+          fieldMetadataIdKey,\n+          subFieldNameKey,\n+          fieldId: fieldMetadataItem.id,\n+          subFieldName: null,\n+        }),\n       });\n       closeDropdown();\n     }\n@@ -142,7 +112,13 @@ export const ChartGroupByFieldSelectionDropdownContentBase = <\n \n   const handleSelectNone = () => {\n     updateCurrentWidgetConfig({\n-      configToUpdate: buildConfigUpdate(null, null),\n+      configToUpdate: buildChartGroupByFieldConfigUpdate({\n+        configuration,\n+        fieldMetadataIdKey,\n+        subFieldNameKey,\n+        fieldId: null,\n+        subFieldName: null,\n+      }),\n     });\n     closeDropdown();\n   };\n@@ -157,10 +133,13 @@ export const ChartGroupByFieldSelectionDropdownContentBase = <\n     }\n \n     updateCurrentWidgetConfig({\n-      configToUpdate: buildConfigUpdate(\n-        selectedCompositeField.id,\n+      configToUpdate: buildChartGroupByFieldConfigUpdate({\n+        configuration,\n+        fieldMetadataIdKey,\n+        subFieldNameKey,\n+        fieldId: selectedCompositeField.id,\n         subFieldName,\n-      ),\n+      }),\n     });\n     closeDropdown();\n   };\ndiff --git a/packages/twenty-front/src/modules/command-menu/pages/page-layout/utils/__tests__/buildChartGroupByFieldConfigUpdate.test.ts b/packages/twenty-front/src/modules/command-menu/pages/page-layout/utils/__tests__/buildChartGroupByFieldConfigUpdate.test.ts\nnew file mode 100644\nindex 0000000000000..4ee5811ae3743\n--- /dev/null\n+++ b/packages/twenty-front/src/modules/command-menu/pages/page-layout/utils/__tests__/buildChartGroupByFieldConfigUpdate.test.ts\n@@ -0,0 +1,77 @@\n+import { ObjectRecordGroupByDateGranularity } from 'twenty-shared/types';\n+import {\n+  type BarChartConfiguration,\n+  BarChartGroupMode,\n+  GraphOrderBy,\n+  type PieChartConfiguration,\n+} from '~/generated/graphql';\n+import { buildChartGroupByFieldConfigUpdate } from '../buildChartGroupByFieldConfigUpdate';\n+\n+describe('buildChartGroupByFieldConfigUpdate', () => {\n+  it('sets default orderBy and dateGranularity for primary axis', () => {\n+    const result = buildChartGroupByFieldConfigUpdate({\n+      configuration: {\n+        __typename: 'BarChartConfiguration',\n+      } as BarChartConfiguration,\n+      fieldMetadataIdKey: 'primaryAxisGroupByFieldMetadataId',\n+      subFieldNameKey: 'primaryAxisGroupBySubFieldName',\n+      fieldId: 'field',\n+      subFieldName: null,\n+    });\n+\n+    expect(result).toMatchObject({\n+      primaryAxisOrderBy: GraphOrderBy.FIELD_ASC,\n+      primaryAxisDateGranularity: ObjectRecordGroupByDateGranularity.DAY,\n+    });\n+  });\n+\n+  it('clears orderBy and dateGranularity when primary axis fieldId is null', () => {\n+    const result = buildChartGroupByFieldConfigUpdate({\n+      configuration: {\n+        __typename: 'BarChartConfiguration',\n+      } as BarChartConfiguration,\n+      fieldMetadataIdKey: 'primaryAxisGroupByFieldMetadataId',\n+      subFieldNameKey: 'primaryAxisGroupBySubFieldName',\n+      fieldId: null,\n+      subFieldName: null,\n+    });\n+\n+    expect(result).toMatchObject({\n+      primaryAxisOrderBy: null,\n+      primaryAxisDateGranularity: null,\n+    });\n+  });\n+\n+  it('sets groupMode for bar chart secondary axis', () => {\n+    const result = buildChartGroupByFieldConfigUpdate({\n+      configuration: {\n+        __typename: 'BarChartConfiguration',\n+      } as BarChartConfiguration,\n+      fieldMetadataIdKey: 'secondaryAxisGroupByFieldMetadataId',\n+      subFieldNameKey: 'secondaryAxisGroupBySubFieldName',\n+      fieldId: 'field',\n+      subFieldName: null,\n+    });\n+\n+    expect(result).toMatchObject({\n+      groupMode: BarChartGroupMode.STACKED,\n+    });\n+  });\n+\n+  it('sets orderBy and dateGranularity for pie chart groupBy', () => {\n+    const result = buildChartGroupByFieldConfigUpdate({\n+      configuration: {\n+        __typename: 'PieChartConfiguration',\n+      } as PieChartConfiguration,\n+      fieldMetadataIdKey: 'groupByFieldMetadataId',\n+      subFieldNameKey: 'groupBySubFieldName',\n+      fieldId: 'field',\n+      subFieldName: null,\n+    });\n+\n+    expect(result).toMatchObject({\n+      orderBy: GraphOrderBy.FIELD_ASC,\n+      dateGranularity: ObjectRecordGroupByDateGranularity.DAY,\n+    });\n+  });\n+});\ndiff --git a/packages/twenty-front/src/modules/command-menu/pages/page-layout/utils/buildChartGroupByFieldConfigUpdate.ts b/packages/twenty-front/src/modules/command-menu/pages/page-layout/utils/buildChartGroupByFieldConfigUpdate.ts\nnew file mode 100644\nindex 0000000000000..2898eb9060419\n--- /dev/null\n+++ b/packages/twenty-front/src/modules/command-menu/pages/page-layout/utils/buildChartGroupByFieldConfigUpdate.ts\n@@ -0,0 +1,111 @@\n+import { type ChartConfiguration } from '@/command-menu/pages/page-layout/types/ChartConfiguration';\n+import { ObjectRecordGroupByDateGranularity } from 'twenty-shared/types';\n+import { isDefined } from 'twenty-shared/utils';\n+import { BarChartGroupMode, GraphOrderBy } from '~/generated/graphql';\n+\n+type BuildChartGroupByFieldConfigUpdateArgs<T extends ChartConfiguration> = {\n+  configuration: T;\n+  fieldMetadataIdKey: keyof T;\n+  subFieldNameKey: keyof T;\n+  fieldId: string | null;\n+  subFieldName: string | null;\n+};\n+\n+export const buildChartGroupByFieldConfigUpdate = <\n+  T extends ChartConfiguration,\n+>({\n+  configuration,\n+  fieldMetadataIdKey,\n+  subFieldNameKey,\n+  fieldId,\n+  subFieldName,\n+}: BuildChartGroupByFieldConfigUpdateArgs<T>) => {\n+  const isPrimaryAxis =\n+    fieldMetadataIdKey === 'primaryAxisGroupByFieldMetadataId';\n+  const isSecondaryAxis =\n+    fieldMetadataIdKey === 'secondaryAxisGroupByFieldMetadataId';\n+  const isPieChartGroupBy = fieldMetadataIdKey === 'groupByFieldMetadataId';\n+\n+  const baseConfig = {\n+    [fieldMetadataIdKey]: fieldId,\n+    [subFieldNameKey]: subFieldName,\n+  };\n+\n+  const isBarChart = configuration.__typename === 'BarChartConfiguration';\n+  const isLineChart = configuration.__typename === 'LineChartConfiguration';\n+  const isPieChart = configuration.__typename === 'PieChartConfiguration';\n+\n+  if (isPrimaryAxis) {\n+    const existingOrderBy =\n+      isBarChart || isLineChart ? configuration.primaryAxisOrderBy : null;\n+\n+    const existingDateGranularity =\n+      isBarChart || isLineChart\n+        ? configuration.primaryAxisDateGranularity\n+        : null;\n+\n+    return {\n+      ...baseConfig,\n+      primaryAxisOrderBy: isDefined(fieldId)\n+        ? (existingOrderBy ?? GraphOrderBy.FIELD_ASC)\n+        : null,\n+      primaryAxisDateGranularity: isDefined(fieldId)\n+        ? (existingDateGranularity ?? ObjectRecordGroupByDateGranularity.DAY)\n+        : null,\n+    };\n+  }\n+\n+  if (isPieChartGroupBy) {\n+    const existingOrderBy = isPieChart ? configuration.orderBy : null;\n+\n+    const existingDateGranularity = isPieChart\n+      ? configuration.dateGranularity\n+      : null;\n+\n+    return {\n+      ...baseConfig,\n+      orderBy: isDefined(fieldId)\n+        ? (existingOrderBy ?? GraphOrderBy.FIELD_ASC)\n+        : null,\n+      dateGranularity: isDefined(fieldId)\n+        ? (existingDateGranularity ?? ObjectRecordGroupByDateGranularity.DAY)\n+        : null,\n+    };\n+  }\n+\n+  if (!isSecondaryAxis) {\n+    return baseConfig;\n+  }\n+\n+  if (isBarChart) {\n+    return {\n+      ...baseConfig,\n+      secondaryAxisOrderBy: isDefined(fieldId)\n+        ? (configuration.secondaryAxisOrderBy ?? GraphOrderBy.FIELD_ASC)\n+        : null,\n+      secondaryAxisGroupByDateGranularity: isDefined(fieldId)\n+        ? (configuration.secondaryAxisGroupByDateGranularity ??\n+          ObjectRecordGroupByDateGranularity.DAY)\n+        : null,\n+      groupMode: isDefined(fieldId)\n+        ? (configuration.groupMode ?? BarChartGroupMode.STACKED)\n+        : null,\n+    };\n+  }\n+\n+  if (isLineChart) {\n+    return {\n+      ...baseConfig,\n+      secondaryAxisOrderBy: isDefined(fieldId)\n+        ? (configuration.secondaryAxisOrderBy ?? GraphOrderBy.FIELD_ASC)\n+        : null,\n+      secondaryAxisGroupByDateGranularity: isDefined(fieldId)\n+        ? (configuration.secondaryAxisGroupByDateGranularity ??\n+          ObjectRecordGroupByDateGranularity.DAY)\n+        : null,\n+      isStacked: isDefined(fieldId) ? (configuration.isStacked ?? true) : null,\n+    };\n+  }\n+\n+  return baseConfig;\n+};\n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/twentyhq__twenty.main/pr_mirror/twentyhq__twenty.main.16143/metadata__pr_16143.json"
  },
  {
    "instance_id": "twentyhq__twenty.main.16335",
    "repo": "twentyhq/twenty",
    "pull_number": 16335,
    "base_commit": "0ced7da8e004b3cb7c9d2c2c56a5e75c6db83dc2",
    "patch": "diff --git a/packages/create-twenty-app/src/cli.ts b/packages/create-twenty-app/src/cli.ts\nindex b1f818009efce..9294a94ade717 100644\n--- a/packages/create-twenty-app/src/cli.ts\n+++ b/packages/create-twenty-app/src/cli.ts\n@@ -1,7 +1,7 @@\n #!/usr/bin/env node\n import chalk from 'chalk';\n import { Command, CommanderError } from 'commander';\n-import { CreateAppCommand } from './create-app.command';\n+import { CreateAppCommand } from '@/create-app.command';\n import packageJson from '../package.json';\n \n const program = new Command(packageJson.name)\ndiff --git a/packages/create-twenty-app/src/create-app.command.ts b/packages/create-twenty-app/src/create-app.command.ts\nindex ecdebba46ffda..5c5ff4a7b1e98 100644\n--- a/packages/create-twenty-app/src/create-app.command.ts\n+++ b/packages/create-twenty-app/src/create-app.command.ts\n@@ -2,11 +2,11 @@ import chalk from 'chalk';\n import * as fs from 'fs-extra';\n import inquirer from 'inquirer';\n import * as path from 'path';\n-import { copyBaseApplicationProject } from './utils/app-template';\n+import { copyBaseApplicationProject } from '@/utils/app-template';\n import kebabCase from 'lodash.kebabcase';\n-import { convertToLabel } from './utils/convert-to-label';\n-import { tryGitInit } from './utils/try-git-init';\n-import { install } from './utils/install';\n+import { convertToLabel } from '@/utils/convert-to-label';\n+import { tryGitInit } from '@/utils/try-git-init';\n+import { install } from '@/utils/install';\n \n const CURRENT_EXECUTION_DIRECTORY = process.env.INIT_CWD || process.cwd();\n \ndiff --git a/packages/create-twenty-app/src/utils/__tests__/convert-to-label.spec.ts b/packages/create-twenty-app/src/utils/__tests__/convert-to-label.spec.ts\nindex d565478c2a8c7..d7eeedfe865a9 100644\n--- a/packages/create-twenty-app/src/utils/__tests__/convert-to-label.spec.ts\n+++ b/packages/create-twenty-app/src/utils/__tests__/convert-to-label.spec.ts\n@@ -1,4 +1,4 @@\n-import { convertToLabel } from '../convert-to-label';\n+import { convertToLabel } from '@/utils/convert-to-label';\n \n describe('convertToLabel', () => {\n   it('should convert to label', () => {\n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/twentyhq__twenty.main/pr_mirror/twentyhq__twenty.main.16335/metadata__pr_16335.json"
  },
  {
    "instance_id": "twentyhq__twenty.main.16112",
    "repo": "twentyhq/twenty",
    "pull_number": 16112,
    "base_commit": "5d1c2a33480540375b70ef3e1199ca8afac22e3a",
    "patch": "diff --git a/packages/twenty-server/src/modules/messaging/message-import-manager/drivers/gmail/services/gmail-messages-import-error-handler.service.ts b/packages/twenty-server/src/modules/messaging/message-import-manager/drivers/gmail/services/gmail-messages-import-error-handler.service.ts\nindex 9ab22c68174b2..569820634aa07 100644\n--- a/packages/twenty-server/src/modules/messaging/message-import-manager/drivers/gmail/services/gmail-messages-import-error-handler.service.ts\n+++ b/packages/twenty-server/src/modules/messaging/message-import-manager/drivers/gmail/services/gmail-messages-import-error-handler.service.ts\n@@ -1,5 +1,7 @@\n import { Injectable, Logger } from '@nestjs/common';\n \n+import { isDefined } from 'twenty-shared/utils';\n+\n import {\n   MessageImportDriverException,\n   MessageImportDriverExceptionCode,\n@@ -23,7 +25,13 @@ export class GmailMessagesImportErrorHandler {\n     }\n \n     if (isGmailApiBatchError(error)) {\n-      throw parseGmailApiBatchError(error, messageExternalId);\n+      const exception = parseGmailApiBatchError(error, messageExternalId);\n+\n+      if (!isDefined(exception)) {\n+        return;\n+      }\n+\n+      throw exception;\n     }\n \n     throw new MessageImportDriverException(\ndiff --git a/packages/twenty-server/src/modules/messaging/message-import-manager/drivers/gmail/utils/__tests__/parse-gmail-messages-import-error.spec.ts b/packages/twenty-server/src/modules/messaging/message-import-manager/drivers/gmail/utils/__tests__/parse-gmail-messages-import-error.spec.ts\nindex 6f2b99524bb59..bd1c44455eda8 100644\n--- a/packages/twenty-server/src/modules/messaging/message-import-manager/drivers/gmail/utils/__tests__/parse-gmail-messages-import-error.spec.ts\n+++ b/packages/twenty-server/src/modules/messaging/message-import-manager/drivers/gmail/utils/__tests__/parse-gmail-messages-import-error.spec.ts\n@@ -111,26 +111,14 @@ describe('parseGmailApiBatchError', () => {\n     const error = gmailBatchApiErrorMocks.getError(404);\n     const exception = parseGmailApiBatchError(error, messageExternalId);\n \n-    expect(exception).toBeInstanceOf(MessageImportDriverException);\n-    expect(exception?.code).toBe(\n-      MessageImportDriverExceptionCode.SYNC_CURSOR_ERROR,\n-    );\n-    expect(exception?.message).toBe(\n-      `${error.errors[0].message} for message with externalId: ${messageExternalId}`,\n-    );\n+    expect(exception).toBeUndefined();\n   });\n \n   it('should handle 410 Gone', () => {\n     const error = gmailBatchApiErrorMocks.getError(410);\n     const exception = parseGmailApiBatchError(error, messageExternalId);\n \n-    expect(exception).toBeInstanceOf(MessageImportDriverException);\n-    expect(exception?.code).toBe(\n-      MessageImportDriverExceptionCode.SYNC_CURSOR_ERROR,\n-    );\n-    expect(exception?.message).toBe(\n-      `${error.errors[0].message} for message with externalId: ${messageExternalId}`,\n-    );\n+    expect(exception).toBeUndefined();\n   });\n \n   it('should handle 429 Too Many Requests', () => {\ndiff --git a/packages/twenty-server/src/modules/messaging/message-import-manager/drivers/gmail/utils/parse-gmail-api-batch-error.util.ts b/packages/twenty-server/src/modules/messaging/message-import-manager/drivers/gmail/utils/parse-gmail-api-batch-error.util.ts\nindex 1314e8e72a0f3..f2d9755bfdc75 100644\n--- a/packages/twenty-server/src/modules/messaging/message-import-manager/drivers/gmail/utils/parse-gmail-api-batch-error.util.ts\n+++ b/packages/twenty-server/src/modules/messaging/message-import-manager/drivers/gmail/utils/parse-gmail-api-batch-error.util.ts\n@@ -43,10 +43,7 @@ export const parseGmailApiBatchError = (\n \n     case 404:\n     case 410:\n-      return new MessageImportDriverException(\n-        message,\n-        MessageImportDriverExceptionCode.SYNC_CURSOR_ERROR,\n-      );\n+      return undefined;\n \n     case 429:\n       return new MessageImportDriverException(\n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/twentyhq__twenty.main/pr_mirror/twentyhq__twenty.main.16112/metadata__pr_16112.json"
  },
  {
    "instance_id": "twentyhq__twenty.main.16326",
    "repo": "twentyhq/twenty",
    "pull_number": 16326,
    "base_commit": "8ee2efead7f10e125b45c9b0d4f1375d9231f51b",
    "patch": "diff --git a/packages/twenty-server/src/modules/calendar/calendar-event-import-manager/crons/jobs/calendar-event-list-fetch.cron.job.ts b/packages/twenty-server/src/modules/calendar/calendar-event-import-manager/crons/jobs/calendar-event-list-fetch.cron.job.ts\nindex 3700e337e5054..aef27c0b063cd 100644\n--- a/packages/twenty-server/src/modules/calendar/calendar-event-import-manager/crons/jobs/calendar-event-list-fetch.cron.job.ts\n+++ b/packages/twenty-server/src/modules/calendar/calendar-event-import-manager/crons/jobs/calendar-event-list-fetch.cron.job.ts\n@@ -50,8 +50,11 @@ export class CalendarEventListFetchCronJob {\n       try {\n         const schemaName = getWorkspaceSchemaName(activeWorkspace.id);\n \n+        const now = new Date().toISOString();\n+\n         const [calendarChannels] = await this.coreDataSource.query(\n-          `UPDATE ${schemaName}.\"calendarChannel\" SET \"syncStage\" = '${CalendarChannelSyncStage.CALENDAR_EVENT_LIST_FETCH_SCHEDULED}' WHERE \"isSyncEnabled\" = true AND \"syncStage\" = '${CalendarChannelSyncStage.CALENDAR_EVENT_LIST_FETCH_PENDING}' RETURNING *`,\n+          `UPDATE ${schemaName}.\"calendarChannel\" SET \"syncStage\" = '${CalendarChannelSyncStage.CALENDAR_EVENT_LIST_FETCH_SCHEDULED}', \"syncStageStartedAt\" = '${now}'\n+          WHERE \"isSyncEnabled\" = true AND \"syncStage\" = '${CalendarChannelSyncStage.CALENDAR_EVENT_LIST_FETCH_PENDING}' RETURNING *`,\n         );\n \n         for (const calendarChannel of calendarChannels) {\ndiff --git a/packages/twenty-server/src/modules/calendar/calendar-event-import-manager/crons/jobs/calendar-events-import.cron.job.ts b/packages/twenty-server/src/modules/calendar/calendar-event-import-manager/crons/jobs/calendar-events-import.cron.job.ts\nindex e75e462985971..c5e3318585ec6 100644\n--- a/packages/twenty-server/src/modules/calendar/calendar-event-import-manager/crons/jobs/calendar-events-import.cron.job.ts\n+++ b/packages/twenty-server/src/modules/calendar/calendar-event-import-manager/crons/jobs/calendar-events-import.cron.job.ts\n@@ -48,8 +48,11 @@ export class CalendarEventsImportCronJob {\n       try {\n         const schemaName = getWorkspaceSchemaName(activeWorkspace.id);\n \n+        const now = new Date().toISOString();\n+\n         const [calendarChannels] = await this.coreDataSource.query(\n-          `UPDATE ${schemaName}.\"calendarChannel\" SET \"syncStage\" = '${CalendarChannelSyncStage.CALENDAR_EVENTS_IMPORT_SCHEDULED}' WHERE \"isSyncEnabled\" = true AND \"syncStage\" = '${CalendarChannelSyncStage.CALENDAR_EVENTS_IMPORT_PENDING}' RETURNING *`,\n+          `UPDATE ${schemaName}.\"calendarChannel\" SET \"syncStage\" = '${CalendarChannelSyncStage.CALENDAR_EVENTS_IMPORT_SCHEDULED}', \"syncStageStartedAt\" = '${now}'\n+           WHERE \"isSyncEnabled\" = true AND \"syncStage\" = '${CalendarChannelSyncStage.CALENDAR_EVENTS_IMPORT_PENDING}' RETURNING *`,\n         );\n \n         for (const calendarChannel of calendarChannels) {\ndiff --git a/packages/twenty-server/src/modules/messaging/common/services/message-channel-sync-status.service.ts b/packages/twenty-server/src/modules/messaging/common/services/message-channel-sync-status.service.ts\nindex 9484e8ddc0138..fbfa95484de71 100644\n--- a/packages/twenty-server/src/modules/messaging/common/services/message-channel-sync-status.service.ts\n+++ b/packages/twenty-server/src/modules/messaging/common/services/message-channel-sync-status.service.ts\n@@ -133,6 +133,27 @@ export class MessageChannelSyncStatusService {\n     });\n   }\n \n+  public async markAsMessagesListFetchScheduled(\n+    messageChannelIds: string[],\n+    workspaceId: string,\n+  ) {\n+    if (!messageChannelIds.length) {\n+      return;\n+    }\n+\n+    const messageChannelRepository =\n+      await this.twentyORMGlobalManager.getRepositoryForWorkspace<MessageChannelWorkspaceEntity>(\n+        workspaceId,\n+        'messageChannel',\n+      );\n+\n+    await messageChannelRepository.update(messageChannelIds, {\n+      syncStage: MessageChannelSyncStage.MESSAGE_LIST_FETCH_SCHEDULED,\n+      syncStatus: MessageChannelSyncStatus.ONGOING,\n+      syncStageStartedAt: new Date().toISOString(),\n+    });\n+  }\n+\n   public async markAsMessagesListFetchOngoing(\n     messageChannelIds: string[],\n     workspaceId: string,\n@@ -150,7 +171,6 @@ export class MessageChannelSyncStatusService {\n     await messageChannelRepository.update(messageChannelIds, {\n       syncStage: MessageChannelSyncStage.MESSAGE_LIST_FETCH_ONGOING,\n       syncStatus: MessageChannelSyncStatus.ONGOING,\n-      syncStageStartedAt: new Date().toISOString(),\n     });\n   }\n \n@@ -182,6 +202,25 @@ export class MessageChannelSyncStatusService {\n     });\n   }\n \n+  public async markAsMessagesImportScheduled(\n+    messageChannelIds: string[],\n+    workspaceId: string,\n+  ) {\n+    if (!messageChannelIds.length) {\n+      return;\n+    }\n+\n+    const messageChannelRepository =\n+      await this.twentyORMGlobalManager.getRepositoryForWorkspace<MessageChannelWorkspaceEntity>(\n+        workspaceId,\n+        'messageChannel',\n+      );\n+\n+    await messageChannelRepository.update(messageChannelIds, {\n+      syncStage: MessageChannelSyncStage.MESSAGES_IMPORT_SCHEDULED,\n+    });\n+  }\n+\n   public async markAsMessagesImportOngoing(\n     messageChannelIds: string[],\n     workspaceId: string,\ndiff --git a/packages/twenty-server/src/modules/messaging/message-import-manager/crons/jobs/messaging-message-list-fetch.cron.job.ts b/packages/twenty-server/src/modules/messaging/message-import-manager/crons/jobs/messaging-message-list-fetch.cron.job.ts\nindex e51101b553a37..7e9508919e1a6 100644\n--- a/packages/twenty-server/src/modules/messaging/message-import-manager/crons/jobs/messaging-message-list-fetch.cron.job.ts\n+++ b/packages/twenty-server/src/modules/messaging/message-import-manager/crons/jobs/messaging-message-list-fetch.cron.job.ts\n@@ -48,8 +48,11 @@ export class MessagingMessageListFetchCronJob {\n       try {\n         const schemaName = getWorkspaceSchemaName(activeWorkspace.id);\n \n+        const now = new Date().toISOString();\n+\n         const [messageChannels] = await this.coreDataSource.query(\n-          `UPDATE ${schemaName}.\"messageChannel\" SET \"syncStage\" = '${MessageChannelSyncStage.MESSAGE_LIST_FETCH_SCHEDULED}' WHERE \"isSyncEnabled\" = true AND \"syncStage\" = '${MessageChannelSyncStage.MESSAGE_LIST_FETCH_PENDING}' RETURNING *`,\n+          `UPDATE ${schemaName}.\"messageChannel\" SET \"syncStage\" = '${MessageChannelSyncStage.MESSAGE_LIST_FETCH_SCHEDULED}', \"syncStageStartedAt\" = '${now}'\n+           WHERE \"isSyncEnabled\" = true AND \"syncStage\" = '${MessageChannelSyncStage.MESSAGE_LIST_FETCH_PENDING}' RETURNING *`,\n         );\n \n         for (const messageChannel of messageChannels) {\ndiff --git a/packages/twenty-server/src/modules/messaging/message-import-manager/crons/jobs/messaging-messages-import.cron.job.ts b/packages/twenty-server/src/modules/messaging/message-import-manager/crons/jobs/messaging-messages-import.cron.job.ts\nindex 091197e4ffd45..9397b37e473a5 100644\n--- a/packages/twenty-server/src/modules/messaging/message-import-manager/crons/jobs/messaging-messages-import.cron.job.ts\n+++ b/packages/twenty-server/src/modules/messaging/message-import-manager/crons/jobs/messaging-messages-import.cron.job.ts\n@@ -53,8 +53,11 @@ export class MessagingMessagesImportCronJob {\n       try {\n         const schemaName = getWorkspaceSchemaName(activeWorkspace.id);\n \n+        const now = new Date().toISOString();\n+\n         const [messageChannels] = await this.coreDataSource.query(\n-          `UPDATE ${schemaName}.\"messageChannel\" SET \"syncStage\" = '${MessageChannelSyncStage.MESSAGES_IMPORT_SCHEDULED}' WHERE \"isSyncEnabled\" = true AND \"syncStage\" = '${MessageChannelSyncStage.MESSAGES_IMPORT_PENDING}' RETURNING *`,\n+          `UPDATE ${schemaName}.\"messageChannel\" SET \"syncStage\" = '${MessageChannelSyncStage.MESSAGES_IMPORT_SCHEDULED}', \"syncStageStartedAt\" = '${now}'\n+          WHERE \"isSyncEnabled\" = true AND \"syncStage\" = '${MessageChannelSyncStage.MESSAGES_IMPORT_PENDING}' RETURNING *`,\n         );\n \n         for (const messageChannel of messageChannels) {\ndiff --git a/packages/twenty-server/src/modules/messaging/message-import-manager/services/__tests__/messaging-message-list-fetch.service.spec.ts b/packages/twenty-server/src/modules/messaging/message-import-manager/services/__tests__/messaging-message-list-fetch.service.spec.ts\nindex 1f24fbd578465..ec045ba16c386 100644\n--- a/packages/twenty-server/src/modules/messaging/message-import-manager/services/__tests__/messaging-message-list-fetch.service.spec.ts\n+++ b/packages/twenty-server/src/modules/messaging/message-import-manager/services/__tests__/messaging-message-list-fetch.service.spec.ts\n@@ -291,7 +291,7 @@ describe('MessagingMessageListFetchService', () => {\n     });\n     expect(\n       messageChannelSyncStatusService.markAsMessagesListFetchOngoing,\n-    ).toHaveBeenCalledWith([mockMicrosoftMessageChannel.id]);\n+    ).toHaveBeenCalledWith([mockMicrosoftMessageChannel.id], workspaceId);\n \n     expect(messagingGetMessageListService.getMessageLists).toHaveBeenCalledWith(\n       {\n@@ -332,7 +332,7 @@ describe('MessagingMessageListFetchService', () => {\n \n     expect(\n       messageChannelSyncStatusService.scheduleMessagesImport,\n-    ).toHaveBeenCalledWith([mockMicrosoftMessageChannel.id]);\n+    ).toHaveBeenCalledWith([mockMicrosoftMessageChannel.id], workspaceId);\n   });\n \n   it('should process Google message list fetch correctly', async () => {\n@@ -350,7 +350,7 @@ describe('MessagingMessageListFetchService', () => {\n     });\n     expect(\n       messageChannelSyncStatusService.markAsMessagesListFetchOngoing,\n-    ).toHaveBeenCalledWith([mockGoogleMessageChannel.id]);\n+    ).toHaveBeenCalledWith([mockGoogleMessageChannel.id], workspaceId);\n \n     expect(messagingGetMessageListService.getMessageLists).toHaveBeenCalledWith(\n       {\n@@ -391,6 +391,6 @@ describe('MessagingMessageListFetchService', () => {\n \n     expect(\n       messageChannelSyncStatusService.scheduleMessagesImport,\n-    ).toHaveBeenCalledWith([mockGoogleMessageChannel.id]);\n+    ).toHaveBeenCalledWith([mockGoogleMessageChannel.id], workspaceId);\n   });\n });\ndiff --git a/packages/twenty-server/src/modules/messaging/message-import-manager/services/__tests__/messaging-messages-import.service.spec.ts b/packages/twenty-server/src/modules/messaging/message-import-manager/services/__tests__/messaging-messages-import.service.spec.ts\nindex f11d03923f6c2..f4e7cba4f730a 100644\n--- a/packages/twenty-server/src/modules/messaging/message-import-manager/services/__tests__/messaging-messages-import.service.spec.ts\n+++ b/packages/twenty-server/src/modules/messaging/message-import-manager/services/__tests__/messaging-messages-import.service.spec.ts\n@@ -213,7 +213,7 @@ describe('MessagingMessagesImportService', () => {\n     );\n     expect(\n       messageChannelSyncStatusService.markAsMessagesImportOngoing,\n-    ).toHaveBeenCalledWith([mockMessageChannel.id]);\n+    ).toHaveBeenCalledWith([mockMessageChannel.id], workspaceId);\n \n     expect(\n       connectedAccountRefreshTokensService.refreshAndSaveTokens,\n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/twentyhq__twenty.main/pr_mirror/twentyhq__twenty.main.16326/metadata__pr_16326.json"
  },
  {
    "instance_id": "twentyhq__twenty.main.16297",
    "repo": "twentyhq/twenty",
    "pull_number": 16297,
    "base_commit": "35319ee13f308d19ee58b79081e405e41aa04956",
    "patch": "diff --git a/packages/twenty-front/src/pages/settings/accounts/SettingsAccountsConfiguration.tsx b/packages/twenty-front/src/pages/settings/accounts/SettingsAccountsConfiguration.tsx\nindex e2fc73c918cd1..e6126b8702909 100644\n--- a/packages/twenty-front/src/pages/settings/accounts/SettingsAccountsConfiguration.tsx\n+++ b/packages/twenty-front/src/pages/settings/accounts/SettingsAccountsConfiguration.tsx\n@@ -99,31 +99,32 @@ export const SettingsAccountsConfiguration = () => {\n     });\n   };\n \n-  switch (currentStep) {\n-    case SettingsAccountsConfigurationStep.Email:\n-      if (!isDefined(messageChannel)) {\n-        return null;\n-      }\n-      return (\n-        <SettingsAccountsConfigurationStepEmail\n-          messageChannel={messageChannel}\n-          hasNextStep={isDefined(calendarChannel)}\n-          isSubmitting={isSubmitting}\n-          onNext={handleNext}\n-          onAddAccount={handleAddAccount}\n-        />\n-      );\n-    case SettingsAccountsConfigurationStep.Calendar:\n-      if (!isDefined(calendarChannel)) {\n-        return null;\n-      }\n-      return (\n-        <SettingsAccountsConfigurationStepCalendar\n-          calendarChannel={calendarChannel}\n-          messageChannel={messageChannel}\n-          isSubmitting={isSubmitting}\n-          onAddAccount={handleAddAccount}\n-        />\n-      );\n+  const showEmailStep =\n+    currentStep === SettingsAccountsConfigurationStep.Email &&\n+    isDefined(messageChannel);\n+\n+  if (showEmailStep) {\n+    return (\n+      <SettingsAccountsConfigurationStepEmail\n+        messageChannel={messageChannel}\n+        hasNextStep={isDefined(calendarChannel)}\n+        isSubmitting={isSubmitting}\n+        onNext={handleNext}\n+        onAddAccount={handleAddAccount}\n+      />\n+    );\n   }\n+\n+  if (!isDefined(calendarChannel)) {\n+    return null;\n+  }\n+\n+  return (\n+    <SettingsAccountsConfigurationStepCalendar\n+      calendarChannel={calendarChannel}\n+      messageChannel={messageChannel}\n+      isSubmitting={isSubmitting}\n+      onAddAccount={handleAddAccount}\n+    />\n+  );\n };\ndiff --git a/packages/twenty-server/src/engine/core-modules/imap-smtp-caldav-connection/services/imap-smtp-caldav-connection.service.ts b/packages/twenty-server/src/engine/core-modules/imap-smtp-caldav-connection/services/imap-smtp-caldav-connection.service.ts\nindex 05f11b46d0dbd..a71b9d68a8ed7 100644\n--- a/packages/twenty-server/src/engine/core-modules/imap-smtp-caldav-connection/services/imap-smtp-caldav-connection.service.ts\n+++ b/packages/twenty-server/src/engine/core-modules/imap-smtp-caldav-connection/services/imap-smtp-caldav-connection.service.ts\n@@ -139,7 +139,7 @@ export class ImapSmtpCaldavService {\n       }\n \n       throw new UserInputError(`CALDAV connection failed: ${error.message}`, {\n-        userFriendlyMessage: msg`Invalid credentials. Please check your username and password.`,\n+        userFriendlyMessage: msg`Invalid CALDAV credentials. Please check your username and password.`,\n       });\n     }\n \ndiff --git a/packages/twenty-server/src/modules/calendar/calendar-event-import-manager/drivers/caldav/lib/caldav.client.ts b/packages/twenty-server/src/modules/calendar/calendar-event-import-manager/drivers/caldav/lib/caldav.client.ts\nindex 882bf065e6fd0..6299f85743fa2 100644\n--- a/packages/twenty-server/src/modules/calendar/calendar-event-import-manager/drivers/caldav/lib/caldav.client.ts\n+++ b/packages/twenty-server/src/modules/calendar/calendar-event-import-manager/drivers/caldav/lib/caldav.client.ts\n@@ -84,7 +84,7 @@ export class CalDAVClient {\n     if (!this.hasFileExtension(url)) return 'ics';\n     const fileName = url.substring(url.lastIndexOf('/') + 1);\n \n-    return fileName.substring(fileName.lastIndexOf('.') + 1);\n+    return fileName.substring(fileName.lastIndexOf('.') + 1).toLowerCase();\n   }\n \n   private isValidFormat(url: string): boolean {\ndiff --git a/packages/twenty-server/src/modules/calendar/calendar-event-import-manager/services/calendar-account-authentication.service.ts b/packages/twenty-server/src/modules/calendar/calendar-event-import-manager/services/calendar-account-authentication.service.ts\nindex 6b058f07d5865..b941469f779f4 100644\n--- a/packages/twenty-server/src/modules/calendar/calendar-event-import-manager/services/calendar-account-authentication.service.ts\n+++ b/packages/twenty-server/src/modules/calendar/calendar-event-import-manager/services/calendar-account-authentication.service.ts\n@@ -33,7 +33,7 @@ export class CalendarAccountAuthenticationService {\n   }: ValidateAndRefreshConnectedAccountAuthenticationParams): Promise<ConnectedAccountTokens> {\n     if (\n       connectedAccount.provider === ConnectedAccountProvider.IMAP_SMTP_CALDAV &&\n-      isDefined(connectedAccount.connectionParameters?.SMTP)\n+      isDefined(connectedAccount.connectionParameters?.CALDAV)\n     ) {\n       await this.validateCalDavCredentialsForConnectedAccount({\n         connectedAccount,\ndiff --git a/packages/twenty-server/src/modules/connected-account/services/imap-smtp-caldav-apis.service.spec.ts b/packages/twenty-server/src/modules/connected-account/services/imap-smtp-caldav-apis.service.spec.ts\nindex 15ee83933f9b9..f4cdc512412e2 100644\n--- a/packages/twenty-server/src/modules/connected-account/services/imap-smtp-caldav-apis.service.spec.ts\n+++ b/packages/twenty-server/src/modules/connected-account/services/imap-smtp-caldav-apis.service.spec.ts\n@@ -261,7 +261,7 @@ describe('ImapSmtpCalDavAPIService', () => {\n       expect(mockCalendarQueueService.add).not.toHaveBeenCalled();\n     });\n \n-    it('should create both channels when only CALDAV is configured but disable message sync', async () => {\n+    it('should only create calendar channel when only CALDAV is configured', async () => {\n       const caldavOnlyInput = {\n         ...baseInput,\n         connectionParameters: {\n@@ -282,7 +282,6 @@ describe('ImapSmtpCalDavAPIService', () => {\n       const expectedCalendarChannel = {\n         id: 'mocked-uuid',\n         connectedAccountId: 'mocked-uuid',\n-\n         handle: 'test@example.com',\n       };\n \n@@ -292,21 +291,7 @@ describe('ImapSmtpCalDavAPIService', () => {\n \n       await service.processAccount(caldavOnlyInput);\n \n-      expect(mockMessageChannelRepository.save).toHaveBeenCalledWith(\n-        {\n-          id: 'mocked-uuid',\n-          connectedAccountId: 'mocked-uuid',\n-          type: MessageChannelType.EMAIL,\n-          handle: 'test@example.com',\n-          isSyncEnabled: false,\n-          syncStatus: MessageChannelSyncStatus.NOT_SYNCED,\n-          syncStage: MessageChannelSyncStage.PENDING_CONFIGURATION,\n-          pendingGroupEmailsAction: MessageChannelPendingGroupEmailsAction.NONE,\n-          syncCursor: '',\n-          syncStageStartedAt: null,\n-        },\n-        {},\n-      );\n+      expect(mockMessageChannelRepository.save).not.toHaveBeenCalled();\n       expect(mockCalendarChannelRepository.save).toHaveBeenCalled();\n \n       expect(mockMessageQueueService.add).not.toHaveBeenCalled();\ndiff --git a/packages/twenty-server/src/modules/connected-account/services/imap-smtp-caldav-apis.service.ts b/packages/twenty-server/src/modules/connected-account/services/imap-smtp-caldav-apis.service.ts\nindex 74640cf84db03..b726bf96b6a96 100644\n--- a/packages/twenty-server/src/modules/connected-account/services/imap-smtp-caldav-apis.service.ts\n+++ b/packages/twenty-server/src/modules/connected-account/services/imap-smtp-caldav-apis.service.ts\n@@ -138,25 +138,29 @@ export class ImapSmtpCalDavAPIService {\n     accountId: string,\n     messageChannelRepository: WorkspaceRepository<MessageChannelWorkspaceEntity>,\n   ): Promise<MessageChannelWorkspaceEntity | null> {\n-    const shouldEnableSync = Boolean(input.connectionParameters.IMAP);\n-\n-    const newMessageChannel = await messageChannelRepository.save(\n-      {\n-        id: v4(),\n-        connectedAccountId: accountId,\n-        type: MessageChannelType.EMAIL,\n-        handle: input.handle,\n-        isSyncEnabled: shouldEnableSync,\n-        syncStatus: MessageChannelSyncStatus.NOT_SYNCED,\n-        syncStage: MessageChannelSyncStage.PENDING_CONFIGURATION,\n-        pendingGroupEmailsAction: MessageChannelPendingGroupEmailsAction.NONE,\n-        syncCursor: '',\n-        syncStageStartedAt: null,\n-      },\n-      {},\n-    );\n+    const shouldCreateMessageChannel = Boolean(input.connectionParameters.IMAP);\n+\n+    if (shouldCreateMessageChannel) {\n+      const newMessageChannel = await messageChannelRepository.save(\n+        {\n+          id: v4(),\n+          connectedAccountId: accountId,\n+          type: MessageChannelType.EMAIL,\n+          handle: input.handle,\n+          isSyncEnabled: true,\n+          syncStatus: MessageChannelSyncStatus.NOT_SYNCED,\n+          syncStage: MessageChannelSyncStage.PENDING_CONFIGURATION,\n+          pendingGroupEmailsAction: MessageChannelPendingGroupEmailsAction.NONE,\n+          syncCursor: '',\n+          syncStageStartedAt: null,\n+        },\n+        {},\n+      );\n \n-    return shouldEnableSync ? newMessageChannel : null;\n+      return newMessageChannel;\n+    }\n+\n+    return null;\n   }\n \n   private async setupCalendarChannels(\n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/twentyhq__twenty.main/pr_mirror/twentyhq__twenty.main.16297/metadata__pr_16297.json"
  },
  {
    "instance_id": "twentyhq__twenty.main.16299",
    "repo": "twentyhq/twenty",
    "pull_number": 16299,
    "base_commit": "3a14fe8a76b6678c5de02ec0733eae6b0903753d",
    "patch": "diff --git a/packages/twenty-front/src/modules/object-record/object-filter-dropdown/utils/__tests__/getOperandsForFilterType.test.ts b/packages/twenty-front/src/modules/object-record/object-filter-dropdown/utils/__tests__/getOperandsForFilterType.test.ts\nindex ced4abf738f0a..ecc0b47c9d777 100644\n--- a/packages/twenty-front/src/modules/object-record/object-filter-dropdown/utils/__tests__/getOperandsForFilterType.test.ts\n+++ b/packages/twenty-front/src/modules/object-record/object-filter-dropdown/utils/__tests__/getOperandsForFilterType.test.ts\n@@ -17,6 +17,7 @@ describe('getOperandsForFilterType', () => {\n \n   const numberOperands = [\n     RecordFilterOperand.IS,\n+    RecordFilterOperand.IS_NOT,\n     RecordFilterOperand.GREATER_THAN_OR_EQUAL,\n     RecordFilterOperand.LESS_THAN_OR_EQUAL,\n   ];\ndiff --git a/packages/twenty-front/src/modules/object-record/record-filter/utils/getRecordFilterOperands.ts b/packages/twenty-front/src/modules/object-record/record-filter/utils/getRecordFilterOperands.ts\nindex d11443cc97c2b..791f78357f556 100644\n--- a/packages/twenty-front/src/modules/object-record/record-filter/utils/getRecordFilterOperands.ts\n+++ b/packages/twenty-front/src/modules/object-record/record-filter/utils/getRecordFilterOperands.ts\n@@ -74,6 +74,7 @@ export const FILTER_OPERANDS_MAP = {\n   ],\n   NUMBER: [\n     RecordFilterOperand.IS,\n+    RecordFilterOperand.IS_NOT,\n     RecordFilterOperand.GREATER_THAN_OR_EQUAL,\n     RecordFilterOperand.LESS_THAN_OR_EQUAL,\n     ...emptyOperands,\ndiff --git a/packages/twenty-front/src/modules/object-record/record-table/utils/buildRecordInputFromFilter.spec.ts b/packages/twenty-front/src/modules/object-record/record-table/utils/buildRecordInputFromFilter.spec.ts\nindex 36d013ceca576..9a23800934905 100644\n--- a/packages/twenty-front/src/modules/object-record/record-table/utils/buildRecordInputFromFilter.spec.ts\n+++ b/packages/twenty-front/src/modules/object-record/record-table/utils/buildRecordInputFromFilter.spec.ts\n@@ -139,6 +139,11 @@ describe('buildValueFromFilter', () => {\n         value: '5',\n         expected: 5,\n       },\n+      {\n+        operand: ViewFilterOperand.IS_NOT,\n+        value: '5',\n+        expected: undefined,\n+      },\n       {\n         operand: ViewFilterOperand.GREATER_THAN_OR_EQUAL,\n         value: '5',\ndiff --git a/packages/twenty-front/src/modules/object-record/record-table/utils/buildRecordInputFromFilter.ts b/packages/twenty-front/src/modules/object-record/record-table/utils/buildRecordInputFromFilter.ts\nindex 898e3e6201182..c5ad711e0b403 100644\n--- a/packages/twenty-front/src/modules/object-record/record-table/utils/buildRecordInputFromFilter.ts\n+++ b/packages/twenty-front/src/modules/object-record/record-table/utils/buildRecordInputFromFilter.ts\n@@ -159,6 +159,8 @@ const computeValueFromFilterNumber = (\n       return Number(value);\n     case ViewFilterOperand.IS:\n       return Number(value);\n+    case ViewFilterOperand.IS_NOT:\n+      return undefined;\n     case ViewFilterOperand.IS_EMPTY:\n       return undefined;\n     default:\ndiff --git a/packages/twenty-front/src/modules/workflow/workflow-steps/workflow-actions/filter-action/utils/getStepFilterOperands.ts b/packages/twenty-front/src/modules/workflow/workflow-steps/workflow-actions/filter-action/utils/getStepFilterOperands.ts\nindex 74b8ceabb998f..96d95db4525b2 100644\n--- a/packages/twenty-front/src/modules/workflow/workflow-steps/workflow-actions/filter-action/utils/getStepFilterOperands.ts\n+++ b/packages/twenty-front/src/modules/workflow/workflow-steps/workflow-actions/filter-action/utils/getStepFilterOperands.ts\n@@ -28,6 +28,7 @@ export const FILTER_OPERANDS_MAP = {\n   ],\n   NUMBER: [\n     ViewFilterOperand.IS,\n+    ViewFilterOperand.IS_NOT,\n     ViewFilterOperand.GREATER_THAN_OR_EQUAL,\n     ViewFilterOperand.LESS_THAN_OR_EQUAL,\n     ...emptyOperands,\n@@ -64,6 +65,7 @@ export const FILTER_OPERANDS_MAP = {\n   UUID: [ViewFilterOperand.IS, ViewFilterOperand.IS_NOT],\n   NUMERIC: [\n     ViewFilterOperand.IS,\n+    ViewFilterOperand.IS_NOT,\n     ViewFilterOperand.GREATER_THAN_OR_EQUAL,\n     ViewFilterOperand.LESS_THAN_OR_EQUAL,\n     ...emptyOperands,\ndiff --git a/packages/twenty-server/src/modules/workflow/workflow-executor/workflow-actions/filter/utils/__tests__/evaluate-filter-conditions.util.spec.ts b/packages/twenty-server/src/modules/workflow/workflow-executor/workflow-actions/filter/utils/__tests__/evaluate-filter-conditions.util.spec.ts\nindex 01b408956e545..7fbb7efcedb63 100644\n--- a/packages/twenty-server/src/modules/workflow/workflow-executor/workflow-actions/filter/utils/__tests__/evaluate-filter-conditions.util.spec.ts\n+++ b/packages/twenty-server/src/modules/workflow/workflow-executor/workflow-actions/filter/utils/__tests__/evaluate-filter-conditions.util.spec.ts\n@@ -484,6 +484,31 @@ describe('evaluateFilterConditions', () => {\n         expect(evaluateFilterConditions({ filters: [filter2] })).toBe(false);\n         expect(evaluateFilterConditions({ filters: [filter3] })).toBe(false);\n       });\n+\n+      it('should handle IsNot operand correctly', () => {\n+        const filter1 = createFilter(\n+          ViewFilterOperand.IS_NOT,\n+          25,\n+          25,\n+          'NUMBER',\n+        );\n+        const filter2 = createFilter(\n+          ViewFilterOperand.IS_NOT,\n+          20,\n+          25,\n+          'NUMBER',\n+        );\n+        const filter3 = createFilter(\n+          ViewFilterOperand.IS_NOT,\n+          30,\n+          25,\n+          'NUMBER',\n+        );\n+\n+        expect(evaluateFilterConditions({ filters: [filter1] })).toBe(false);\n+        expect(evaluateFilterConditions({ filters: [filter2] })).toBe(true);\n+        expect(evaluateFilterConditions({ filters: [filter3] })).toBe(true);\n+      });\n     });\n \n     describe('string and array operands', () => {\ndiff --git a/packages/twenty-server/src/modules/workflow/workflow-executor/workflow-actions/filter/utils/evaluate-filter-conditions.util.ts b/packages/twenty-server/src/modules/workflow/workflow-executor/workflow-actions/filter/utils/evaluate-filter-conditions.util.ts\nindex 743a659ec0b66..efebf74c3134c 100644\n--- a/packages/twenty-server/src/modules/workflow/workflow-executor/workflow-actions/filter/utils/evaluate-filter-conditions.util.ts\n+++ b/packages/twenty-server/src/modules/workflow/workflow-executor/workflow-actions/filter/utils/evaluate-filter-conditions.util.ts\n@@ -349,6 +349,9 @@ function evaluateNumberFilter(filter: ResolvedFilter): boolean {\n     case ViewFilterOperand.IS:\n       return Number(leftValue) === Number(rightValue);\n \n+    case ViewFilterOperand.IS_NOT:\n+      return Number(leftValue) !== Number(rightValue);\n+\n     default:\n       throw new Error(\n         `Operand ${filter.operand} not supported for number filter`,\ndiff --git a/packages/twenty-shared/src/utils/filter/turnRecordFilterIntoGqlOperationFilter.ts b/packages/twenty-shared/src/utils/filter/turnRecordFilterIntoGqlOperationFilter.ts\nindex b2baffea11c40..dc517c6cd6178 100644\n--- a/packages/twenty-shared/src/utils/filter/turnRecordFilterIntoGqlOperationFilter.ts\n+++ b/packages/twenty-shared/src/utils/filter/turnRecordFilterIntoGqlOperationFilter.ts\n@@ -416,6 +416,14 @@ export const turnRecordFilterIntoRecordGqlOperationFilter = ({\n               eq: parseFloat(recordFilter.value),\n             } as FloatFilter,\n           };\n+        case RecordFilterOperand.IS_NOT:\n+          return {\n+            not: {\n+              [correspondingFieldMetadataItem.name]: {\n+                eq: parseFloat(recordFilter.value),\n+              } as FloatFilter,\n+            },\n+          };\n         default:\n           throw new Error(\n             `Unknown operand ${recordFilter.operand} for ${filterType} filter`,\n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/twentyhq__twenty.main/pr_mirror/twentyhq__twenty.main.16299/metadata__pr_16299.json"
  },
  {
    "instance_id": "appsmithorg__appsmith.main.41074",
    "repo": "appsmithorg/appsmith",
    "pull_number": 41074,
    "base_commit": "b4d5685d21fd757e87cde24c002b5aa79783b528",
    "patch": "diff --git a/app/client/src/actions/pageActions.tsx b/app/client/src/actions/pageActions.tsx\nindex 47aa7f95dda..f776940728c 100644\n--- a/app/client/src/actions/pageActions.tsx\n+++ b/app/client/src/actions/pageActions.tsx\n@@ -31,6 +31,7 @@ import type { ApiResponse } from \"api/ApiResponses\";\n import type { EvaluationReduxAction } from \"./EvaluationReduxActionTypes\";\n import { appsmithTelemetry } from \"instrumentation\";\n import type { NavigateToAnotherPagePayload } from \"sagas/ActionExecution/NavigateActionSaga/types\";\n+import type { Path } from \"history\";\n \n export interface FetchPageListPayload {\n   applicationId: string;\n@@ -699,7 +700,7 @@ export const setupPublishedPage = (\n });\n \n export const navigateToAnotherPage = (\n-  payload: NavigateToAnotherPagePayload,\n+  payload: NavigateToAnotherPagePayload | Path,\n ) => ({\n   type: ReduxActionTypes.NAVIGATE_TO_ANOTHER_PAGE,\n   payload,\ndiff --git a/app/client/src/pages/AppIDE/components/PageList/PageEntity.tsx b/app/client/src/pages/AppIDE/components/PageList/PageEntity.tsx\nindex fb71d77ffc7..2d0ac0ab02e 100644\n--- a/app/client/src/pages/AppIDE/components/PageList/PageEntity.tsx\n+++ b/app/client/src/pages/AppIDE/components/PageList/PageEntity.tsx\n@@ -15,11 +15,10 @@ import {\n import { PERMISSION_TYPE, isPermitted } from \"ee/utils/permissionHelpers\";\n import { getCurrentApplication } from \"ee/selectors/applicationSelectors\";\n import type { DefaultRootState } from \"react-redux\";\n-import { updatePageAction } from \"actions/pageActions\";\n+import { navigateToAnotherPage, updatePageAction } from \"actions/pageActions\";\n import { useGetPageFocusUrl } from \"./hooks/useGetPageFocusUrl\";\n import AnalyticsUtil from \"ee/utils/AnalyticsUtil\";\n import { toggleInOnboardingWidgetSelection } from \"actions/onboardingActions\";\n-import history, { NavigationMethod } from \"utils/history\";\n import { EntityItem } from \"@appsmith/ads\";\n import { useNameEditorState } from \"IDE/hooks/useNameEditorState\";\n import { useValidateEntityName } from \"IDE\";\n@@ -90,9 +89,7 @@ export const PageEntity = ({\n       toUrl: navigateToUrl,\n     });\n     dispatch(toggleInOnboardingWidgetSelection(true));\n-    history.push(navigateToUrl, {\n-      invokedBy: NavigationMethod.EntityExplorer,\n-    });\n+    dispatch(navigateToAnotherPage(navigateToUrl));\n \n     if (onClick) {\n       onClick();\ndiff --git a/app/client/src/sagas/ActionExecution/PluginActionSaga.ts b/app/client/src/sagas/ActionExecution/PluginActionSaga.ts\nindex b9856cf37b7..9d748bb7bc2 100644\n--- a/app/client/src/sagas/ActionExecution/PluginActionSaga.ts\n+++ b/app/client/src/sagas/ActionExecution/PluginActionSaga.ts\n@@ -1702,14 +1702,18 @@ export function* executePageUnloadActionsSaga() {\n   const span = startRootSpan(\"executePageUnloadActionsSaga\");\n \n   try {\n-    const pageActions: Action[] = yield select(getLayoutOnUnloadActions);\n-    const actionCount = pageActions.length;\n+    const pageOnUnloadActions: Action[] = yield select(\n+      getLayoutOnUnloadActions,\n+    );\n+    const actionCount = pageOnUnloadActions.length;\n \n     setAttributesToSpan(span, { numActions: actionCount });\n \n     // Execute unload actions in parallel batches\n     yield all(\n-      pageActions.map((action) => call(executeOnPageUnloadJSAction, action)),\n+      pageOnUnloadActions.map((action) =>\n+        call(executeOnPageUnloadJSAction, action),\n+      ),\n     );\n \n     // Publish success event after all actions are executed\ndiff --git a/app/client/src/selectors/__tests__/editorSelectors/pluginActionSelectors.test.ts b/app/client/src/selectors/__tests__/editorSelectors/pluginActionSelectors.test.ts\nnew file mode 100644\nindex 00000000000..31ddc869a9f\n--- /dev/null\n+++ b/app/client/src/selectors/__tests__/editorSelectors/pluginActionSelectors.test.ts\n@@ -0,0 +1,71 @@\n+import type { DefaultRootState } from \"react-redux\";\n+import { getLayoutOnUnloadActions } from \"selectors/editorSelectors\";\n+\n+describe(\"getLayoutOnUnloadActions\", () => {\n+  it(\"should filter actions by current page ID\", () => {\n+    const state = {\n+      entities: {\n+        pageList: { currentPageId: \"page1\" },\n+        jsActions: [\n+          {\n+            isLoading: false,\n+            config: {\n+              id: \"collection1\",\n+              pageId: \"page1\",\n+              actions: [\n+                {\n+                  id: \"action1\",\n+                  pageId: \"page1\",\n+                  runBehaviour: \"ON_PAGE_UNLOAD\",\n+                  name: \"myFun1\",\n+                  fullyQualifiedName: \"JSObject1.myFun1\",\n+                  collectionId: \"collection1\",\n+                },\n+                {\n+                  id: \"action3\",\n+                  pageId: \"page1\",\n+                  runBehaviour: \"ON_PAGE_LOAD\",\n+                  name: \"myFun2\",\n+                  fullyQualifiedName: \"JSObject1.myFun2\",\n+                  collectionId: \"collection1\",\n+                },\n+              ],\n+            },\n+          },\n+          {\n+            isLoading: false,\n+            config: {\n+              id: \"collection2\",\n+              pageId: \"page2\",\n+              actions: [\n+                {\n+                  id: \"action2\",\n+                  pageId: \"page2\",\n+                  runBehaviour: \"ON_PAGE_UNLOAD\",\n+                  name: \"myFun1\",\n+                  fullyQualifiedName: \"JSObject2.myFun1\",\n+                  collectionId: \"collection2\",\n+                },\n+              ],\n+            },\n+          },\n+        ],\n+      },\n+    };\n+\n+    const result = getLayoutOnUnloadActions(\n+      state as unknown as DefaultRootState,\n+    );\n+\n+    expect(result).toEqual([\n+      {\n+        id: \"action1\",\n+        pageId: \"page1\",\n+        runBehaviour: \"ON_PAGE_UNLOAD\",\n+        name: \"myFun1\",\n+        fullyQualifiedName: \"JSObject1.myFun1\",\n+        collectionId: \"collection1\",\n+      },\n+    ]);\n+  });\n+});\ndiff --git a/app/client/src/selectors/editorSelectors.tsx b/app/client/src/selectors/editorSelectors.tsx\nindex b220b6ab771..28614887208 100644\n--- a/app/client/src/selectors/editorSelectors.tsx\n+++ b/app/client/src/selectors/editorSelectors.tsx\n@@ -125,16 +125,21 @@ export const getPageSavingError = (state: DefaultRootState) => {\n   return state.ui.editor.loadingStates.savingError;\n };\n \n+export const getCurrentPageId = (state: DefaultRootState) =>\n+  state.entities.pageList.currentPageId;\n+\n export const getLayoutOnLoadActions = (state: DefaultRootState) =>\n   state.ui.editor.pageActions || [];\n \n export const getLayoutOnUnloadActions = createSelector(\n+  getCurrentPageId,\n   getAllJSCollectionActions,\n-  (jsActions) => {\n-    return jsActions.filter((action) => {\n-      return action.runBehaviour === ActionRunBehaviour.ON_PAGE_UNLOAD;\n-    });\n-  },\n+  (currentPageId, jsActions) =>\n+    jsActions.filter(\n+      (action) =>\n+        action.runBehaviour === ActionRunBehaviour.ON_PAGE_UNLOAD &&\n+        action.pageId === currentPageId,\n+    ),\n );\n \n export const getLayoutOnLoadIssues = (state: DefaultRootState) => {\n@@ -167,9 +172,6 @@ export const getPageByBaseId = (basePageId: string) =>\n     pages.find((page) => page.basePageId === basePageId),\n   );\n \n-export const getCurrentPageId = (state: DefaultRootState) =>\n-  state.entities.pageList.currentPageId;\n-\n export const getCurrentBasePageId = (state: DefaultRootState) =>\n   state.entities.pageList.currentBasePageId;\n \n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/appsmithorg__appsmith.7046aeb3/pr_mirror/appsmithorg__appsmith.main.41074/metadata__pr_41074.json"
  },
  {
    "instance_id": "appsmithorg__appsmith.main.41089",
    "repo": "appsmithorg/appsmith",
    "pull_number": 41089,
    "base_commit": "2af8ef31f46dd1d0b1d1d9c4c2fe3b0d8ef04912",
    "patch": "diff --git a/app/client/src/workers/Evaluation/__tests__/evaluation.test.ts b/app/client/src/workers/Evaluation/__tests__/evaluation.test.ts\nindex bde5259b878..c6d2e3e52e4 100644\n--- a/app/client/src/workers/Evaluation/__tests__/evaluation.test.ts\n+++ b/app/client/src/workers/Evaluation/__tests__/evaluation.test.ts\n@@ -634,7 +634,6 @@ describe(\"DataTreeEvaluator\", () => {\n       updatedConfigTree,\n       unEvalUpdates,\n       [],\n-      evaluator.evalTree,\n     );\n     const dataTree = evaluator.evalTree;\n \n@@ -674,7 +673,6 @@ describe(\"DataTreeEvaluator\", () => {\n       updatedConfigTree,\n       unEvalUpdates,\n       [],\n-      evaluator.evalTree,\n     );\n \n     const dataTree = evaluator.evalTree;\n@@ -722,7 +720,6 @@ describe(\"DataTreeEvaluator\", () => {\n       updatedConfigTree,\n       unEvalUpdates,\n       [],\n-      evaluator.evalTree,\n     );\n     const dataTree = evaluator.evalTree;\n \n@@ -787,7 +784,6 @@ describe(\"DataTreeEvaluator\", () => {\n       updatedConfigTree,\n       unEvalUpdates,\n       [],\n-      evaluator.evalTree,\n     );\n     const dataTree = evaluator.evalTree;\n     const updatedDependencies = evaluator.dependencies;\n@@ -832,7 +828,6 @@ describe(\"DataTreeEvaluator\", () => {\n       updatedConfigTree,\n       unEvalUpdates,\n       [],\n-      evaluator.evalTree,\n     );\n     const dataTree = evaluator.evalTree;\n     const updatedDependencies = evaluator.dependencies;\n@@ -898,7 +893,6 @@ describe(\"DataTreeEvaluator\", () => {\n       updatedConfigTree,\n       unEvalUpdates,\n       [],\n-      evaluator.evalTree,\n     );\n     const dataTree = evaluator.evalTree;\n     const updatedDependencies = evaluator.dependencies;\n@@ -971,7 +965,6 @@ describe(\"DataTreeEvaluator\", () => {\n       updatedConfigTree1,\n       unEvalUpdates,\n       [],\n-      evaluator.evalTree,\n     );\n     expect(evaluator.dependencies[\"Api2.config.body\"]).toStrictEqual([\n       \"Api2.config.pluginSpecifiedTemplates[0].value\",\n@@ -1007,7 +1000,6 @@ describe(\"DataTreeEvaluator\", () => {\n       updatedConfigTree2,\n       unEvalUpdates2,\n       [],\n-      evaluator.evalTree,\n     );\n     const dataTree = evaluator.evalTree;\n \n@@ -1050,7 +1042,6 @@ describe(\"DataTreeEvaluator\", () => {\n       updatedConfigTree3,\n       unEvalUpdates3,\n       [],\n-      evaluator.evalTree,\n     );\n     const dataTree3 = evaluator.evalTree;\n \n@@ -1094,7 +1085,6 @@ describe(\"DataTreeEvaluator\", () => {\n       updatedConfigTree,\n       unEvalUpdates,\n       [],\n-      evaluator.evalTree,\n     );\n     const dataTree = evaluator.evalTree;\n \n@@ -1135,7 +1125,6 @@ describe(\"DataTreeEvaluator\", () => {\n       updatedConfigTree,\n       unEvalUpdates,\n       [],\n-      evaluator.evalTree,\n     );\n     // Hard check to not regress on the number of clone operations. Try to improve this number.\n     // Not a good assertion because in one piece of code im cloning multiple times, however the value im cloning is very small.\ndiff --git a/app/client/src/workers/Evaluation/evalTreeWithChanges.test.ts b/app/client/src/workers/Evaluation/evalTreeWithChanges.test.ts\nindex 791e64071b2..ceff6ba2630 100644\n--- a/app/client/src/workers/Evaluation/evalTreeWithChanges.test.ts\n+++ b/app/client/src/workers/Evaluation/evalTreeWithChanges.test.ts\n@@ -130,7 +130,6 @@ describe(\"evaluateAndPushResponse\", () => {\n       },\n       [],\n       [],\n-      {},\n     );\n     // check if push response has been called\n     expect(pushResponseToMainThreadMock).toHaveBeenCalled();\n@@ -226,7 +225,6 @@ describe(\"evaluateAndGenerateResponse\", () => {\n       },\n       [],\n       [],\n-      {},\n     );\n     const parsedUpdates = getParsedUpdatesFromWebWorkerResp(webworkerResponse);\n \n@@ -261,7 +259,6 @@ describe(\"evaluateAndGenerateResponse\", () => {\n       },\n       [],\n       [],\n-      {},\n     );\n     const parsedUpdates = getParsedUpdatesFromWebWorkerResp(webworkerResponse);\n \n@@ -301,7 +298,6 @@ describe(\"evaluateAndGenerateResponse\", () => {\n         updateTreeResponse,\n         [],\n         [],\n-        {},\n       );\n \n       expect(webworkerResponse.workerResponse.dependencies).toEqual({\n@@ -342,7 +338,6 @@ describe(\"evaluateAndGenerateResponse\", () => {\n         updateTreeResponse,\n         [],\n         [],\n-        {},\n       );\n       const parsedUpdates =\n         getParsedUpdatesFromWebWorkerResp(webworkerResponse);\n@@ -376,7 +371,6 @@ describe(\"evaluateAndGenerateResponse\", () => {\n         updateTreeResponse,\n         [],\n         [],\n-        {},\n       );\n \n       const parsedUpdates =\n@@ -420,7 +414,6 @@ describe(\"evaluateAndGenerateResponse\", () => {\n         updateTreeResponse,\n         [],\n         [\"Text1.text\"],\n-        {},\n       );\n       const parsedUpdates =\n         getParsedUpdatesFromWebWorkerResp(webworkerResponse);\n@@ -466,7 +459,6 @@ describe(\"evaluateAndGenerateResponse\", () => {\n           response,\n           metaUpdates,\n           [],\n-          {},\n         );\n \n       expect(workerResponse.evalMetaUpdates).toEqual(metaUpdates);\n@@ -497,7 +489,6 @@ describe(\"evaluateAndGenerateResponse\", () => {\n           response,\n           metaUpdates,\n           [],\n-          {},\n         );\n \n       // the function properties should be stripped out\n@@ -529,7 +520,6 @@ describe(\"evaluateAndGenerateResponse\", () => {\n         updateTreeResponse,\n         [],\n         [],\n-        {},\n       );\n \n       const parsedUpdates =\n@@ -568,7 +558,6 @@ describe(\"evaluateAndGenerateResponse\", () => {\n         updateTreeResponse,\n         [],\n         [],\n-        {},\n       );\n       const parsedUpdates =\n         getParsedUpdatesFromWebWorkerResp(webworkerResponse);\ndiff --git a/app/client/src/workers/Evaluation/evalTreeWithChanges.ts b/app/client/src/workers/Evaluation/evalTreeWithChanges.ts\nindex f0a0a562612..e3feaebe177 100644\n--- a/app/client/src/workers/Evaluation/evalTreeWithChanges.ts\n+++ b/app/client/src/workers/Evaluation/evalTreeWithChanges.ts\n@@ -21,7 +21,6 @@ import {\n import type DataTreeEvaluator from \"workers/common/DataTreeEvaluator\";\n import type { Diff } from \"deep-diff\";\n import type { DataTree } from \"entities/DataTree/dataTreeTypes\";\n-import { klona as klonaJson } from \"klona/json\";\n \n const getDefaultEvalResponse = (): EvalTreeResponseData => ({\n   updates: \"[]\",\n@@ -71,10 +70,8 @@ export function evalTreeWithChanges(\n   );\n \n   let setupUpdateTreeResponse = {} as UpdateTreeResponse;\n-  let oldEvalTree: DataTree = {};\n \n   if (dataTreeEvaluator) {\n-    oldEvalTree = klonaJson(dataTreeEvaluator.getEvalTree());\n     setupUpdateTreeResponse = dataTreeEvaluator.setupUpdateTreeWithDifferences(\n       updatedValuePaths,\n       pathsToSkipFromEval,\n@@ -86,7 +83,6 @@ export function evalTreeWithChanges(\n     setupUpdateTreeResponse,\n     metaUpdates,\n     pathsToSkipFromEval,\n-    oldEvalTree,\n   );\n }\n \n@@ -107,14 +103,12 @@ export const evaluateAndPushResponse = (\n   setupUpdateTreeResponse: UpdateTreeResponse,\n   metaUpdates: EvalMetaUpdates,\n   additionalPathsAddedAsUpdates: string[],\n-  oldEvalTree: DataTree,\n ) => {\n   const response = evaluateAndGenerateResponse(\n     dataTreeEvaluator,\n     setupUpdateTreeResponse,\n     metaUpdates,\n     additionalPathsAddedAsUpdates,\n-    oldEvalTree,\n   );\n \n   return pushResponseToMainThread(response);\n@@ -125,7 +119,6 @@ export const evaluateAndGenerateResponse = (\n   setupUpdateTreeResponse: UpdateTreeResponse,\n   metaUpdates: EvalMetaUpdates,\n   additionalPathsAddedAsUpdates: string[],\n-  oldEvalTree: DataTree,\n ): UpdateDataTreeMessageData => {\n   // generate default response first and later add updates to it\n   const defaultResponse = getDefaultEvalResponse();\n@@ -158,7 +151,6 @@ export const evaluateAndGenerateResponse = (\n     dataTreeEvaluator.oldConfigTree,\n     unEvalUpdates,\n     [],\n-    oldEvalTree,\n   );\n \n   const dataTree = updateEvalProps(dataTreeEvaluator) || {};\ndiff --git a/app/client/src/workers/Evaluation/handlers/evalTree.ts b/app/client/src/workers/Evaluation/handlers/evalTree.ts\nindex 1d12dde5887..a26c7c50be4 100644\n--- a/app/client/src/workers/Evaluation/handlers/evalTree.ts\n+++ b/app/client/src/workers/Evaluation/handlers/evalTree.ts\n@@ -33,7 +33,6 @@ import type { CanvasWidgetsReduxState } from \"ee/reducers/entityReducers/canvasW\n import type { MetaWidgetsReduxState } from \"reducers/entityReducers/metaWidgetsReducer\";\n import type { Attributes } from \"instrumentation/types\";\n import { updateActionsToEvalTree } from \"./updateActionData\";\n-import { klona as klonaJSON } from \"klona/json\";\n \n // TODO: Fix this the next time the file is edited\n // eslint-disable-next-line @typescript-eslint/no-explicit-any\n@@ -194,7 +193,6 @@ export async function evalTree(\n       isNewTree = true;\n     } else {\n       const tree = dataTreeEvaluator.getEvalTree();\n-      const oldDataTree = klonaJSON(tree);\n \n       // during update cycles update actions to the dataTree directly\n       // this is useful in cases where we have debounced updateActionData and a regular evaluation\n@@ -243,7 +241,6 @@ export async function evalTree(\n             configTree,\n             unEvalUpdates,\n             Object.keys(metaWidgets),\n-            oldDataTree,\n           ),\n       );\n \ndiff --git a/app/client/src/workers/Evaluation/handlers/evalTrigger.ts b/app/client/src/workers/Evaluation/handlers/evalTrigger.ts\nindex 4da86703b39..992730da7b5 100644\n--- a/app/client/src/workers/Evaluation/handlers/evalTrigger.ts\n+++ b/app/client/src/workers/Evaluation/handlers/evalTrigger.ts\n@@ -2,7 +2,6 @@ import { dataTreeEvaluator } from \"./evalTree\";\n import type { EvalWorkerASyncRequest } from \"../types\";\n import ExecutionMetaData from \"../fns/utils/ExecutionMetaData\";\n import { evaluateAndPushResponse } from \"../evalTreeWithChanges\";\n-import { klona as klonaJson } from \"klona/json\";\n \n export default async function (request: EvalWorkerASyncRequest) {\n   const { data } = request;\n@@ -21,8 +20,6 @@ export default async function (request: EvalWorkerASyncRequest) {\n \n   ExecutionMetaData.setExecutionMetaData({ triggerMeta, eventType });\n \n-  const oldEvalTree = klonaJson(dataTreeEvaluator.getEvalTree());\n-\n   if (!triggerMeta.onPageLoad) {\n     const { evalOrder, unEvalUpdates } = dataTreeEvaluator.setupUpdateTree(\n       unEvalTree.unEvalTree,\n@@ -37,7 +34,6 @@ export default async function (request: EvalWorkerASyncRequest) {\n       { evalOrder, unEvalUpdates, jsUpdates: {} },\n       [],\n       [],\n-      oldEvalTree,\n     );\n   }\n \ndiff --git a/app/client/src/workers/common/DataTreeEvaluator/dataTreeEvaluator.test.ts b/app/client/src/workers/common/DataTreeEvaluator/dataTreeEvaluator.test.ts\nindex e0ad57986d3..f370792e0d1 100644\n--- a/app/client/src/workers/common/DataTreeEvaluator/dataTreeEvaluator.test.ts\n+++ b/app/client/src/workers/common/DataTreeEvaluator/dataTreeEvaluator.test.ts\n@@ -305,7 +305,6 @@ describe(\"DataTreeEvaluator\", () => {\n         configTree as unknown as ConfigTree,\n         unEvalUpdates,\n         [],\n-        dataTreeEvaluator.evalTree,\n       );\n \n       expect(dataTreeEvaluator.dependencies).toStrictEqual({\n@@ -478,7 +477,6 @@ describe(\"DataTreeEvaluator\", () => {\n             arrayAccessorCyclicDependencyConfig.apiSuccessConfigTree,\n             unEvalUpdates,\n             [],\n-            dataTreeEvaluator.evalTree,\n           );\n           expect(dataTreeEvaluator.dependencies[\"Api1\"]).toStrictEqual(\n             undefined,\n@@ -503,7 +501,6 @@ describe(\"DataTreeEvaluator\", () => {\n             arrayAccessorCyclicDependencyConfig.apiFailureConfigTree,\n             unEvalUpdates2,\n             [],\n-            dataTreeEvaluator.evalTree,\n           );\n \n           expect(dataTreeEvaluator.dependencies[\"Api1\"]).toStrictEqual(\n@@ -533,7 +530,6 @@ describe(\"DataTreeEvaluator\", () => {\n           arrayAccessorCyclicDependencyConfig.apiSuccessConfigTree,\n           unEvalUpdates,\n           [],\n-          dataTreeEvaluator.evalTree,\n         );\n \n         // success: response -> [{...}, {...}]\n@@ -548,7 +544,6 @@ describe(\"DataTreeEvaluator\", () => {\n           arrayAccessorCyclicDependencyConfig.apiSuccessConfigTree2,\n           unEvalUpdates2,\n           [],\n-          dataTreeEvaluator.evalTree,\n         );\n \n         expect(dataTreeEvaluator.dependencies[\"Api1\"]).toStrictEqual(undefined);\n@@ -577,7 +572,6 @@ describe(\"DataTreeEvaluator\", () => {\n             nestedArrayAccessorCyclicDependencyConfig.apiSuccessConfigTree,\n             unEvalUpdates,\n             [],\n-            dataTreeEvaluator.evalTree,\n           );\n           expect(dataTreeEvaluator.dependencies[\"Api1\"]).toStrictEqual(\n             undefined,\n@@ -605,7 +599,6 @@ describe(\"DataTreeEvaluator\", () => {\n             nestedArrayAccessorCyclicDependencyConfig.apiFailureConfigTree,\n             unEvalUpdates2,\n             [],\n-            dataTreeEvaluator.evalTree,\n           );\n           expect(dataTreeEvaluator.dependencies[\"Api1\"]).toStrictEqual(\n             undefined,\n@@ -637,7 +630,6 @@ describe(\"DataTreeEvaluator\", () => {\n           nestedArrayAccessorCyclicDependencyConfig.apiSuccessConfigTree,\n           unEvalUpdates,\n           [],\n-          dataTreeEvaluator.evalTree,\n         );\n \n         // success: response -> [ [{...}, {...}, {...}], [{...}, {...}, {...}] ]\n@@ -652,7 +644,6 @@ describe(\"DataTreeEvaluator\", () => {\n           nestedArrayAccessorCyclicDependencyConfig.apiSuccessConfigTree2,\n           unEvalUpdates2,\n           [],\n-          dataTreeEvaluator.evalTree,\n         );\n \n         expect(dataTreeEvaluator.dependencies[\"Api1\"]).toStrictEqual(undefined);\n@@ -680,7 +671,6 @@ describe(\"DataTreeEvaluator\", () => {\n           nestedArrayAccessorCyclicDependencyConfig.apiSuccessConfigTree,\n           unEvalUpdates,\n           [],\n-          dataTreeEvaluator.evalTree,\n         );\n \n         // success: response -> [ [{...}, {...}, {...}], [{...}, {...}, {...}], [] ]\n@@ -695,7 +685,6 @@ describe(\"DataTreeEvaluator\", () => {\n           nestedArrayAccessorCyclicDependencyConfig.apiSuccessConfigTree3,\n           unEvalUpdates2,\n           [],\n-          dataTreeEvaluator.evalTree,\n         );\n         expect(dataTreeEvaluator.dependencies[\"Api1\"]).toStrictEqual(undefined);\n         expect(dataTreeEvaluator.dependencies[\"Api1.data\"]).toStrictEqual([]);\ndiff --git a/app/client/src/workers/common/DataTreeEvaluator/index.ts b/app/client/src/workers/common/DataTreeEvaluator/index.ts\nindex 1df173ef3ad..4ea4f13b4bf 100644\n--- a/app/client/src/workers/common/DataTreeEvaluator/index.ts\n+++ b/app/client/src/workers/common/DataTreeEvaluator/index.ts\n@@ -490,7 +490,6 @@ export default class DataTreeEvaluator {\n       evaluationOrder,\n       undefined,\n       this.oldConfigTree,\n-      {},\n     );\n \n     /**\n@@ -960,7 +959,6 @@ export default class DataTreeEvaluator {\n     configTree: ConfigTree,\n     unevalUpdates: DataTreeDiff[],\n     metaWidgetIds: string[] = [],\n-    oldEvalTree: DataTree,\n   ): {\n     evalMetaUpdates: EvalMetaUpdates;\n     staleMetaIds: string[];\n@@ -984,7 +982,6 @@ export default class DataTreeEvaluator {\n         metaWidgets: metaWidgetIds,\n       },\n       configTree,\n-      oldEvalTree,\n     );\n     const evaluationEndTime = performance.now();\n \n@@ -1127,7 +1124,6 @@ export default class DataTreeEvaluator {\n       metaWidgets: [],\n     },\n     oldConfigTree: ConfigTree,\n-    oldEvalTree: DataTree,\n   ): {\n     evaluatedTree: DataTree;\n     evalMetaUpdates: EvalMetaUpdates;\n@@ -1323,7 +1319,7 @@ export default class DataTreeEvaluator {\n         if (!propertyPath) continue;\n \n         // Get old value from oldEvalTree for comparison\n-        const oldValue = get(oldEvalTree, fullPropertyPath);\n+        const oldValue = get(this.getPrevState(), fullPropertyPath);\n \n         switch (entityType) {\n           case ENTITY_TYPE.WIDGET: {\n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/appsmithorg__appsmith.7046aeb3/pr_mirror/appsmithorg__appsmith.main.41089/metadata__pr_41089.json"
  },
  {
    "instance_id": "appsmithorg__appsmith.main.41049",
    "repo": "appsmithorg/appsmith",
    "pull_number": 41049,
    "base_commit": "7bcd86d87f161926ac10547fbaec993d8ae9355a",
    "patch": "diff --git a/app/client/src/ce/workers/Evaluation/evaluationUtils.ts b/app/client/src/ce/workers/Evaluation/evaluationUtils.ts\nindex 293fe0a221a..443fbb318c0 100644\n--- a/app/client/src/ce/workers/Evaluation/evaluationUtils.ts\n+++ b/app/client/src/ce/workers/Evaluation/evaluationUtils.ts\n@@ -413,7 +413,9 @@ export function isAppsmithEntity(\n   );\n }\n \n-export function isJSAction(entity: DataTreeEntity): entity is JSActionEntity {\n+export function isJSAction(\n+  entity: Partial<DataTreeEntity>,\n+): entity is JSActionEntity {\n   return (\n     typeof entity === \"object\" &&\n     \"ENTITY_TYPE\" in entity &&\ndiff --git a/app/client/src/entities/DependencyMap/DependencyMapUtils.ts b/app/client/src/entities/DependencyMap/DependencyMapUtils.ts\nindex 9e4cb175ad7..933343f9e24 100644\n--- a/app/client/src/entities/DependencyMap/DependencyMapUtils.ts\n+++ b/app/client/src/entities/DependencyMap/DependencyMapUtils.ts\n@@ -4,9 +4,13 @@ import {\n   entityTypeCheckForPathDynamicTrigger,\n   getEntityNameAndPropertyPath,\n   IMMEDIATE_PARENT_REGEX,\n+  isAction,\n+  isJSAction,\n } from \"ee/workers/Evaluation/evaluationUtils\";\n import type { ConfigTree } from \"entities/DataTree/dataTreeTypes\";\n import { isPathDynamicTrigger } from \"utils/DynamicBindingUtils\";\n+import { WorkerEnv } from \"workers/Evaluation/handlers/workerEnv\";\n+import { ActionRunBehaviour } from \"PluginActionEditor/types/PluginActionTypes\";\n \n type SortDependencies =\n   | {\n@@ -23,6 +27,9 @@ export class DependencyMapUtils {\n   ): SortDependencies {\n     const dependencyTree: Array<[string, string | undefined]> = [];\n     const dependencies = dependencyMap.rawDependencies;\n+    const featureFlags = WorkerEnv.getFeatureFlags();\n+    const isReactiveActionsEnabled =\n+      featureFlags.release_reactive_actions_enabled;\n \n     for (const [node, deps] of dependencies.entries()) {\n       if (deps.size) {\n@@ -38,7 +45,7 @@ export class DependencyMapUtils {\n         .reverse()\n         .filter((edge) => !!edge);\n \n-      if (configTree) {\n+      if (configTree && isReactiveActionsEnabled) {\n         this.detectReactiveDependencyMisuse(dependencyMap, configTree);\n       }\n \n@@ -163,81 +170,91 @@ export class DependencyMapUtils {\n   ) {\n     const dependencies = dependencyMap.rawDependencies;\n \n-    // Helper function to get all transitive dependencies\n-    const getAllTransitiveDependencies = (node: string): Set<string> => {\n-      const allDeps = new Set<string>();\n-      const queue = [node];\n+    for (const node of dependencies.keys()) {\n+      const { entityName: nodeName } = getEntityNameAndPropertyPath(node);\n+      const nodeConfig = configTree[nodeName];\n \n-      while (queue.length > 0) {\n-        const current = queue.shift()!;\n-        const deps = dependencyMap.getDirectDependencies(current) || [];\n+      const isJSActionEntity = isJSAction(nodeConfig);\n+      const isActionEntity = isAction(nodeConfig);\n \n-        for (const dep of deps) {\n-          if (!allDeps.has(dep)) {\n-            allDeps.add(dep);\n-            queue.push(dep);\n-          }\n-        }\n+      if (isJSActionEntity) {\n+        // Only continue if at least one function is automatic\n+        const hasAutomaticFunc = Object.values(nodeConfig.meta).some(\n+          (jsFunction) =>\n+            jsFunction.runBehaviour === ActionRunBehaviour.AUTOMATIC,\n+        );\n+\n+        if (!hasAutomaticFunc) continue;\n+      } else if (isActionEntity) {\n+        // Only continue if runBehaviour is AUTOMATIC\n+        if (nodeConfig.runBehaviour !== ActionRunBehaviour.AUTOMATIC) continue;\n+      } else {\n+        // If not a JSAction, or Action, skip\n+        continue;\n       }\n \n-      return allDeps;\n-    };\n+      // For each entity, check if both .run and a .data path are present\n+      let hasRun = false;\n+      let hasData = false;\n+      let dataPath = \"\";\n+      let runPath = \"\";\n \n-    for (const [node, deps] of dependencies.entries()) {\n-      // Get all dependencies including transitive ones\n-      const allDeps = new Set<string>();\n-      const queue = Array.from(deps);\n+      const transitiveDeps = this.getAllTransitiveDependencies(\n+        dependencyMap,\n+        node,\n+      );\n \n-      while (queue.length > 0) {\n-        const dep = queue.shift()!;\n+      for (const dep of transitiveDeps) {\n+        const { entityName } = getEntityNameAndPropertyPath(dep);\n+        const entityConfig = configTree[entityName];\n \n-        if (!allDeps.has(dep)) {\n-          allDeps.add(dep);\n-          const depDeps = dependencyMap.getDirectDependencies(dep) || [];\n+        if (entityConfig && entityConfig.ENTITY_TYPE === \"ACTION\") {\n+          if (this.isTriggerPath(dep, configTree)) {\n+            hasRun = true;\n+            runPath = dep;\n+          }\n \n-          queue.push(...depDeps);\n+          if (DependencyMapUtils.isDataPath(dep)) {\n+            hasData = true;\n+            dataPath = dep;\n+          }\n+\n+          if (hasRun && hasData) {\n+            throw Object.assign(\n+              new Error(\n+                `Reactive dependency misuse: '${node}' depends on both trigger path '${runPath}' and data path '${dataPath}' from the same entity. This can cause unexpected reactivity.`,\n+              ),\n+              { node, triggerPath: runPath, dataPath },\n+            );\n+          }\n         }\n       }\n+    }\n+  }\n \n-      // Separate dependencies into trigger paths and data paths\n-      const triggerPaths = Array.from(deps).filter((dep) =>\n-        this.isTriggerPath(dep, configTree),\n-      );\n-      const dataPaths = Array.from(deps).filter((dep) => this.isDataPath(dep));\n-\n-      // For each trigger path, check if there's a data path from the same entity\n-      for (const triggerPath of triggerPaths) {\n-        const triggerEntity = triggerPath.split(\".\")[0];\n-\n-        // Find data paths from the same entity\n-        const sameEntityDataPaths = dataPaths.filter((dataPath) => {\n-          const dataEntity = dataPath.split(\".\")[0];\n-\n-          return dataEntity === triggerEntity;\n-        });\n-\n-        if (sameEntityDataPaths.length > 0) {\n-          // Check if any of these data paths depend on the trigger path (directly or indirectly)\n-          for (const dataPath of sameEntityDataPaths) {\n-            const dataPathTransitiveDeps =\n-              getAllTransitiveDependencies(dataPath);\n-\n-            if (dataPathTransitiveDeps.has(triggerPath)) {\n-              const error = new Error(\n-                `Reactive dependency misuse: '${node}' depends on both trigger path '${triggerPath}' and data path '${dataPath}' from the same entity, and '${dataPath}' depends on '${triggerPath}' (directly or indirectly). This can cause unexpected reactivity.`,\n-              );\n-\n-              // Add custom properties\n-              // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n-              // @ts-ignore\n-              // eslint-disable-next-line @typescript-eslint/no-explicit-any\n-              (error as any).node = node;\n-\n-              throw error;\n-            }\n-          }\n+  /**\n+   * Returns all transitive dependencies (direct and indirect, no duplicates) for a given node.\n+   */\n+  static getAllTransitiveDependencies(\n+    dependencyMap: DependencyMap,\n+    node: string,\n+  ): string[] {\n+    const dependencies = dependencyMap.rawDependencies;\n+    const visited = new Set<string>();\n+\n+    function traverse(current: string) {\n+      const directDeps = dependencies.get(current) || new Set<string>();\n+\n+      for (const dep of directDeps) {\n+        if (!visited.has(dep)) {\n+          visited.add(dep);\n+          traverse(dep);\n         }\n       }\n     }\n+\n+    traverse(node);\n+\n+    return Array.from(visited);\n   }\n }\ndiff --git a/app/client/src/entities/DependencyMap/__tests__/DependencyMapUtils.test.ts b/app/client/src/entities/DependencyMap/__tests__/DependencyMapUtils.test.ts\nnew file mode 100644\nindex 00000000000..74fa30cf7e7\n--- /dev/null\n+++ b/app/client/src/entities/DependencyMap/__tests__/DependencyMapUtils.test.ts\n@@ -0,0 +1,337 @@\n+import DependencyMap from \"../index\";\n+import { DependencyMapUtils } from \"../DependencyMapUtils\";\n+import { PluginType } from \"entities/Plugin\";\n+import {\n+  ENTITY_TYPE,\n+  type DataTreeEntityConfig,\n+  type MetaArgs,\n+} from \"ee/entities/DataTree/types\";\n+import type { ActionRunBehaviourType } from \"PluginActionEditor/types/PluginActionTypes\";\n+\n+describe(\"detectReactiveDependencyMisuse\", () => {\n+  function makeConfigTreeWithAction(\n+    entityName: string,\n+    runBehaviour: ActionRunBehaviourType = \"AUTOMATIC\",\n+  ): DataTreeEntityConfig {\n+    return {\n+      ENTITY_TYPE: ENTITY_TYPE.ACTION,\n+      dynamicTriggerPathList: [{ key: \"run\" }],\n+      dynamicBindingPathList: [],\n+      bindingPaths: {},\n+      reactivePaths: {},\n+      dependencyMap: {},\n+      logBlackList: {},\n+      pluginType: PluginType.API,\n+      pluginId: \"mockPluginId\",\n+      actionId: \"mockActionId\",\n+      name: entityName,\n+      runBehaviour,\n+    };\n+  }\n+\n+  function makeConfigTreeWithJSAction(\n+    entityName: string,\n+    meta: Record<string, MetaArgs> = {},\n+  ): DataTreeEntityConfig {\n+    return {\n+      ENTITY_TYPE: ENTITY_TYPE.JSACTION,\n+      meta,\n+      dynamicBindingPathList: [],\n+      actionNames: new Set([\"myFun1\", \"myFun2\"]),\n+      bindingPaths: {},\n+      reactivePaths: {},\n+      dependencyMap: {},\n+      pluginType: PluginType.JS,\n+      name: entityName,\n+      actionId: \"mockJSActionId\",\n+      dynamicTriggerPathList: [],\n+      variables: [],\n+    };\n+  }\n+\n+  function makeConfigTreeWithWidget(entityName: string): DataTreeEntityConfig {\n+    return {\n+      ENTITY_TYPE: ENTITY_TYPE.WIDGET,\n+      bindingPaths: {},\n+      reactivePaths: {},\n+      triggerPaths: {},\n+      validationPaths: {},\n+      logBlackList: {},\n+      propertyOverrideDependency: {},\n+      overridingPropertyPaths: {},\n+      privateWidgets: {},\n+      widgetId: \"mockWidgetId\",\n+      defaultMetaProps: [],\n+      type: \"MOCK_WIDGET_TYPE\",\n+      dynamicBindingPathList: [],\n+      name: entityName,\n+    };\n+  }\n+\n+  it(\"does not throw for Widget entity\", () => {\n+    const dependencyMap = new DependencyMap();\n+\n+    dependencyMap.addNodes({\n+      Widget1: true,\n+      \"Widget1.run\": true,\n+      \"Widget1.data\": true,\n+    });\n+    dependencyMap.addDependency(\"Widget1\", [\"Widget1.run\", \"Widget1.data\"]);\n+    const configTree = {\n+      Widget1: makeConfigTreeWithWidget(\"Widget1\"),\n+    };\n+\n+    expect(() => {\n+      DependencyMapUtils.detectReactiveDependencyMisuse(\n+        dependencyMap,\n+        configTree,\n+      );\n+    }).not.toThrow();\n+  });\n+\n+  it(\"does not throw for MANUAL ACTION entity\", () => {\n+    const dependencyMap = new DependencyMap();\n+\n+    dependencyMap.addNodes({\n+      \"JSObject1.myFun1\": true,\n+      \"Query3.run\": true,\n+      \"Query3.data\": true,\n+    });\n+    dependencyMap.addDependency(\"JSObject1.myFun1\", [\n+      \"Query3.run\",\n+      \"Query3.data\",\n+    ]);\n+    const configTree = {\n+      Query3: makeConfigTreeWithAction(\"Query3\", \"MANUAL\"),\n+      JSObject1: makeConfigTreeWithJSAction(\"JSObject1\", {\n+        myFun1: {\n+          runBehaviour: \"MANUAL\",\n+          arguments: [],\n+          confirmBeforeExecute: false,\n+        },\n+        myFun2: {\n+          runBehaviour: \"MANUAL\",\n+          arguments: [],\n+          confirmBeforeExecute: false,\n+        },\n+      }),\n+    };\n+\n+    expect(() => {\n+      DependencyMapUtils.detectReactiveDependencyMisuse(\n+        dependencyMap,\n+        configTree,\n+      );\n+    }).not.toThrow();\n+  });\n+\n+  it(\"does not throw for JSAction entity with no AUTOMATIC function\", () => {\n+    const dependencyMap = new DependencyMap();\n+\n+    dependencyMap.addNodes({\n+      \"JSObject1.myFun1\": true,\n+      \"JSObject1.myFun2\": true,\n+      \"Query2.run\": true,\n+      \"Query2.data\": true,\n+    });\n+    // JSObject1.myFun2 depends on Query2.run\n+    dependencyMap.addDependency(\"JSObject1.myFun2\", [\"Query2.run\"]);\n+    // JSObject1.myFun1 depends on both JSObject1.myFun2 and and Query2.data (transitive)\n+    dependencyMap.addDependency(\"JSObject1.myFun1\", [\n+      \"JSObject1.myFun2\",\n+      \"Query2.data\",\n+    ]);\n+\n+    // meta has no AUTOMATIC runBehaviour\n+    const configTree = {\n+      JSObject1: makeConfigTreeWithJSAction(\"JSObject1\", {\n+        myFun1: {\n+          runBehaviour: \"MANUAL\",\n+          arguments: [],\n+          confirmBeforeExecute: false,\n+        },\n+        myFun2: {\n+          runBehaviour: \"MANUAL\",\n+          arguments: [],\n+          confirmBeforeExecute: false,\n+        },\n+      }),\n+      Query2: makeConfigTreeWithAction(\"Query2\", \"AUTOMATIC\"),\n+    };\n+\n+    expect(() => {\n+      DependencyMapUtils.detectReactiveDependencyMisuse(\n+        dependencyMap,\n+        configTree,\n+      );\n+    }).not.toThrow();\n+  });\n+\n+  it(\"does not throw if a node depends only on .run or only on .data for AUTOMATIC ACTION\", () => {\n+    const configTree = {\n+      Api1: makeConfigTreeWithAction(\"Api1\", \"AUTOMATIC\"),\n+      JSObject1: makeConfigTreeWithJSAction(\"JSObject1\", {\n+        myFun1: {\n+          runBehaviour: \"AUTOMATIC\",\n+          arguments: [],\n+          confirmBeforeExecute: false,\n+        },\n+        myFun2: {\n+          runBehaviour: \"AUTOMATIC\",\n+          arguments: [],\n+          confirmBeforeExecute: false,\n+        },\n+      }),\n+      JSObject2: makeConfigTreeWithJSAction(\"JSObject2\", {\n+        myFun1: {\n+          runBehaviour: \"AUTOMATIC\",\n+          arguments: [],\n+          confirmBeforeExecute: false,\n+        },\n+        myFun2: {\n+          runBehaviour: \"AUTOMATIC\",\n+          arguments: [],\n+          confirmBeforeExecute: false,\n+        },\n+      }),\n+    };\n+\n+    // Only .run\n+    const depMapRun = new DependencyMap();\n+\n+    depMapRun.addNodes({ \"JSObject1.myFun1\": true, \"Api1.run\": true });\n+    depMapRun.addDependency(\"JSObject1.myFun1\", [\"Api1.run\"]);\n+\n+    expect(() => {\n+      DependencyMapUtils.detectReactiveDependencyMisuse(depMapRun, configTree);\n+    }).not.toThrow();\n+\n+    // Only .data\n+    const depMapData = new DependencyMap();\n+\n+    depMapData.addNodes({ \"JSObject2.myFun1\": true, \"Api1.data\": true });\n+    depMapData.addDependency(\"JSObject2.myFun1\", [\"Api1.data\"]);\n+    expect(() => {\n+      DependencyMapUtils.detectReactiveDependencyMisuse(depMapData, configTree);\n+    }).not.toThrow();\n+  });\n+\n+  it(\"throws if a node depends on both .run and .data of the same AUTOMATIC ACTION entity\", () => {\n+    const dependencyMap = new DependencyMap();\n+\n+    // Add nodes\n+    dependencyMap.addNodes({\n+      \"JSObject1.myFun1\": true,\n+      \"Query1.run\": true,\n+      \"Query1.data\": true,\n+    });\n+    // JSObject1.myFun1 depends on both Query1.run and Query1.data\n+    dependencyMap.addDependency(\"JSObject1.myFun1\", [\n+      \"Query1.run\",\n+      \"Query1.data\",\n+    ]);\n+    const configTree = {\n+      JSObject1: makeConfigTreeWithJSAction(\"JSObject1\", {\n+        myFun1: {\n+          runBehaviour: \"AUTOMATIC\",\n+          arguments: [],\n+          confirmBeforeExecute: false,\n+        },\n+        myFun2: {\n+          runBehaviour: \"MANUAL\",\n+          arguments: [],\n+          confirmBeforeExecute: false,\n+        },\n+      }),\n+      Query1: makeConfigTreeWithAction(\"Query1\", \"AUTOMATIC\"),\n+    };\n+\n+    expect(() => {\n+      DependencyMapUtils.detectReactiveDependencyMisuse(\n+        dependencyMap,\n+        configTree,\n+      );\n+    }).toThrow(/Reactive dependency misuse/);\n+  });\n+\n+  it(\"throws if a node depends on both .run and .data of the same AUTOMATIC ACTION entity via transitive dependency\", () => {\n+    const dependencyMap = new DependencyMap();\n+\n+    dependencyMap.addNodes({\n+      \"JSObject1.myFun1\": true,\n+      \"JSObject1.myFun2\": true,\n+      \"Query2.run\": true,\n+      \"Query2.data\": true,\n+    });\n+    // JSObject1.myFun2 depends on Query2.run\n+    dependencyMap.addDependency(\"JSObject1.myFun2\", [\"Query2.run\"]);\n+    // JSObject1.myFun1 depends on both JSObject1.myFun2 and and Query2.data (transitive)\n+    dependencyMap.addDependency(\"JSObject1.myFun1\", [\n+      \"JSObject1.myFun2\",\n+      \"Query2.data\",\n+    ]);\n+    const configTree = {\n+      Query2: makeConfigTreeWithAction(\"Query2\", \"AUTOMATIC\"),\n+      JSObject1: makeConfigTreeWithJSAction(\"JSObject1\", {\n+        myFun1: {\n+          runBehaviour: \"AUTOMATIC\",\n+          arguments: [],\n+          confirmBeforeExecute: false,\n+        },\n+        myFun2: {\n+          runBehaviour: \"MANUAL\",\n+          arguments: [],\n+          confirmBeforeExecute: false,\n+        },\n+      }),\n+    };\n+\n+    expect(() => {\n+      DependencyMapUtils.detectReactiveDependencyMisuse(\n+        dependencyMap,\n+        configTree,\n+      );\n+    }).toThrow(/Reactive dependency misuse/);\n+  });\n+\n+  it(\"throws for JSAction entity with at least one AUTOMATIC function\", () => {\n+    // meta has one AUTOMATIC runBehaviour\n+    const dependencyMap = new DependencyMap();\n+\n+    dependencyMap.addNodes({\n+      \"JSObject1.myFun1\": true,\n+      \"JSObject1.myFun2\": true,\n+      \"Query2.run\": true,\n+      \"Query2.data\": true,\n+    });\n+    // JSObject1.myFun2 depends on Query2.run\n+    dependencyMap.addDependency(\"JSObject1.myFun2\", [\"Query2.run\"]);\n+    // JSObject1.myFun1 depends on both JSObject1.myFun2 and and Query2.data (transitive)\n+    dependencyMap.addDependency(\"JSObject1.myFun1\", [\n+      \"JSObject1.myFun2\",\n+      \"Query2.data\",\n+    ]);\n+    const configTree = {\n+      JSObject1: makeConfigTreeWithJSAction(\"JSObject1\", {\n+        myFun1: {\n+          runBehaviour: \"AUTOMATIC\",\n+          arguments: [],\n+          confirmBeforeExecute: false,\n+        },\n+        myFun2: {\n+          runBehaviour: \"MANUAL\",\n+          arguments: [],\n+          confirmBeforeExecute: false,\n+        },\n+      }),\n+      Query2: makeConfigTreeWithAction(\"Query2\", \"MANUAL\"),\n+    };\n+\n+    expect(() => {\n+      DependencyMapUtils.detectReactiveDependencyMisuse(\n+        dependencyMap,\n+        configTree,\n+      );\n+    }).toThrow(/Reactive dependency misuse/);\n+  });\n+});\n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/appsmithorg__appsmith.7046aeb3/pr_mirror/appsmithorg__appsmith.main.41049/metadata__pr_41049.json"
  },
  {
    "instance_id": "appsmithorg__appsmith.main.41217",
    "repo": "appsmithorg/appsmith",
    "pull_number": 41217,
    "base_commit": "49dfbd233930187670f70430b5fdefe7351020db",
    "patch": "diff --git a/app/client/src/widgets/TableWidgetV2/component/cellComponents/HeaderCell.tsx b/app/client/src/widgets/TableWidgetV2/component/cellComponents/HeaderCell.tsx\nindex 9bc73b67ea4..b938f722a96 100644\n--- a/app/client/src/widgets/TableWidgetV2/component/cellComponents/HeaderCell.tsx\n+++ b/app/client/src/widgets/TableWidgetV2/component/cellComponents/HeaderCell.tsx\n@@ -200,7 +200,10 @@ const HeaderCellComponent = (props: HeaderProps) => {\n   const isColumnEditable =\n     props.column.columnProperties.isCellEditable &&\n     props.column.columnProperties.isEditable &&\n-    isColumnTypeEditable(props.column.columnProperties.columnType);\n+    isColumnTypeEditable(\n+      props.column.columnProperties.columnType,\n+      isInfiniteScrollEnabled,\n+    );\n \n   const toggleColumnFreeze = (value: StickyType) => {\n     handleColumnFreeze &&\ndiff --git a/app/client/src/widgets/TableWidgetV2/widget/__tests__/propertyUtils.test.ts b/app/client/src/widgets/TableWidgetV2/widget/__tests__/propertyUtils.test.ts\nindex 2d3eb8985b8..160ab69d5f8 100644\n--- a/app/client/src/widgets/TableWidgetV2/widget/__tests__/propertyUtils.test.ts\n+++ b/app/client/src/widgets/TableWidgetV2/widget/__tests__/propertyUtils.test.ts\n@@ -10,7 +10,6 @@ import {\n   updateCustomColumnAliasOnLabelChange,\n   selectColumnOptionsValidation,\n   allowedFirstDayOfWeekRange,\n-  updateCellEditabilityOnInfiniteScrollChange,\n   updateSearchSortFilterOnInfiniteScrollChange,\n } from \"../propertyUtils\";\n import _ from \"lodash\";\n@@ -1151,96 +1150,4 @@ describe(\"Infinite Scroll Update Hooks - \", () => {\n       ),\n     ).toBeUndefined();\n   });\n-\n-  it(\"updateCellEditabilityOnInfiniteScrollChange - should disable cell editability when infinite scroll is enabled\", () => {\n-    // Setup mock primary columns\n-    const props = {\n-      primaryColumns: {\n-        column1: {\n-          id: \"column1\",\n-          alias: \"column1\",\n-          isEditable: true,\n-          isCellEditable: true,\n-        },\n-        column2: {\n-          id: \"column2\",\n-          alias: \"column2\",\n-          isEditable: true,\n-          isCellEditable: true,\n-        },\n-      },\n-    } as unknown as TableWidgetProps;\n-\n-    // When infinite scroll is enabled\n-    expect(\n-      updateCellEditabilityOnInfiniteScrollChange(\n-        props,\n-        \"infiniteScrollEnabled\",\n-        true,\n-      ),\n-    ).toEqual([\n-      {\n-        propertyPath: \"primaryColumns.column1.isCellEditable\",\n-        propertyValue: false,\n-      },\n-      {\n-        propertyPath: \"primaryColumns.column1.isEditable\",\n-        propertyValue: false,\n-      },\n-      {\n-        propertyPath: \"primaryColumns.column2.isCellEditable\",\n-        propertyValue: false,\n-      },\n-      {\n-        propertyPath: \"primaryColumns.column2.isEditable\",\n-        propertyValue: false,\n-      },\n-    ]);\n-\n-    // When infinite scroll is disabled\n-    expect(\n-      updateCellEditabilityOnInfiniteScrollChange(\n-        props,\n-        \"infiniteScrollEnabled\",\n-        false,\n-      ),\n-    ).toEqual([\n-      {\n-        propertyPath: \"primaryColumns.column1.isCellEditable\",\n-        propertyValue: true,\n-      },\n-      {\n-        propertyPath: \"primaryColumns.column1.isEditable\",\n-        propertyValue: true,\n-      },\n-      {\n-        propertyPath: \"primaryColumns.column2.isCellEditable\",\n-        propertyValue: true,\n-      },\n-      {\n-        propertyPath: \"primaryColumns.column2.isEditable\",\n-        propertyValue: true,\n-      },\n-    ]);\n-\n-    // Test with no primary columns\n-    const propsWithoutColumns = {} as TableWidgetProps;\n-\n-    expect(\n-      updateCellEditabilityOnInfiniteScrollChange(\n-        propsWithoutColumns,\n-        \"infiniteScrollEnabled\",\n-        true,\n-      ),\n-    ).toBeUndefined();\n-\n-    // When some other value is passed\n-    expect(\n-      updateCellEditabilityOnInfiniteScrollChange(\n-        props,\n-        \"infiniteScrollEnabled\",\n-        \"some-other-value\",\n-      ),\n-    ).toBeUndefined();\n-  });\n });\ndiff --git a/app/client/src/widgets/TableWidgetV2/widget/index.tsx b/app/client/src/widgets/TableWidgetV2/widget/index.tsx\nindex 78a21afa3f4..2e865783bec 100644\n--- a/app/client/src/widgets/TableWidgetV2/widget/index.tsx\n+++ b/app/client/src/widgets/TableWidgetV2/widget/index.tsx\n@@ -580,6 +580,7 @@ class TableWidgetV2 extends BaseWidget<TableWidgetProps, WidgetState> {\n   getTableColumns = () => {\n     const {\n       columnWidthMap,\n+      infiniteScrollEnabled,\n       isPreviewMode,\n       orderedTableColumns,\n       renderMode,\n@@ -597,6 +598,7 @@ class TableWidgetV2 extends BaseWidget<TableWidgetProps, WidgetState> {\n       componentWidth,\n       renderMode,\n       isPreviewMode,\n+      infiniteScrollEnabled,\n     );\n   };\n \n@@ -2067,7 +2069,8 @@ class TableWidgetV2 extends BaseWidget<TableWidgetProps, WidgetState> {\n     }\n \n     const isColumnEditable =\n-      column.isEditable && isColumnTypeEditable(column.columnType);\n+      column.isEditable &&\n+      isColumnTypeEditable(column.columnType, this.props.infiniteScrollEnabled);\n     const alias = props.cell.column.columnProperties.alias;\n \n     const isCellEditable = isColumnEditable && cellProperties.isCellEditable;\ndiff --git a/app/client/src/widgets/TableWidgetV2/widget/propertyConfig/PanelConfig/General.ts b/app/client/src/widgets/TableWidgetV2/widget/propertyConfig/PanelConfig/General.ts\nindex 82ccf971bc5..96210b4dd02 100644\n--- a/app/client/src/widgets/TableWidgetV2/widget/propertyConfig/PanelConfig/General.ts\n+++ b/app/client/src/widgets/TableWidgetV2/widget/propertyConfig/PanelConfig/General.ts\n@@ -137,7 +137,10 @@ export default {\n         const columnType = get(props, `${baseProperty}.columnType`, \"\");\n         const isDerived = get(props, `${baseProperty}.isDerived`, false);\n \n-        return !isColumnTypeEditable(columnType) || isDerived;\n+        return (\n+          !isColumnTypeEditable(columnType, props.infiniteScrollEnabled) ||\n+          isDerived\n+        );\n       },\n     },\n     {\ndiff --git a/app/client/src/widgets/TableWidgetV2/widget/propertyConfig/contentConfig.ts b/app/client/src/widgets/TableWidgetV2/widget/propertyConfig/contentConfig.ts\nindex 02de96fffcc..48351f35538 100644\n--- a/app/client/src/widgets/TableWidgetV2/widget/propertyConfig/contentConfig.ts\n+++ b/app/client/src/widgets/TableWidgetV2/widget/propertyConfig/contentConfig.ts\n@@ -22,7 +22,6 @@ import {\n   totalRecordsCountValidation,\n   uniqueColumnNameValidation,\n   updateAllowAddNewRowOnInfiniteScrollChange,\n-  updateCellEditabilityOnInfiniteScrollChange,\n   updateColumnOrderHook,\n   updateCustomColumnAliasOnLabelChange,\n   updateInlineEditingOptionDropdownVisibilityHook,\n@@ -197,7 +196,6 @@ export default [\n         isTriggerProperty: false,\n         updateHook: composePropertyUpdateHook([\n           updateAllowAddNewRowOnInfiniteScrollChange,\n-          updateCellEditabilityOnInfiniteScrollChange,\n           updateSearchSortFilterOnInfiniteScrollChange,\n         ]),\n         dependencies: [\"primaryColumns\", \"serverSidePaginationEnabled\"],\ndiff --git a/app/client/src/widgets/TableWidgetV2/widget/propertyUtils.ts b/app/client/src/widgets/TableWidgetV2/widget/propertyUtils.ts\nindex c92a573664f..bf6bb16960d 100644\n--- a/app/client/src/widgets/TableWidgetV2/widget/propertyUtils.ts\n+++ b/app/client/src/widgets/TableWidgetV2/widget/propertyUtils.ts\n@@ -1513,46 +1513,3 @@ export const updateSearchSortFilterOnInfiniteScrollChange = (\n \n   return;\n };\n-\n-// Disable cell editability when infinite scroll is enabled\n-export const updateCellEditabilityOnInfiniteScrollChange = (\n-  props: TableWidgetProps,\n-  propertyPath: string,\n-  propertyValue: unknown,\n-): Array<{ propertyPath: string; propertyValue: unknown }> | undefined => {\n-  if (!props.primaryColumns) return;\n-\n-  const updates: Array<{ propertyPath: string; propertyValue: unknown }> = [];\n-\n-  if (propertyValue === true) {\n-    Object.entries(props.primaryColumns).forEach(([, column]) => {\n-      const columnName = column.alias;\n-\n-      updates.push({\n-        propertyPath: `primaryColumns.${columnName}.isCellEditable`,\n-        propertyValue: false,\n-      });\n-\n-      updates.push({\n-        propertyPath: `primaryColumns.${columnName}.isEditable`,\n-        propertyValue: false,\n-      });\n-    });\n-  } else if (propertyValue === false) {\n-    Object.entries(props.primaryColumns).forEach(([, column]) => {\n-      const columnName = column.alias;\n-\n-      updates.push({\n-        propertyPath: `primaryColumns.${columnName}.isCellEditable`,\n-        propertyValue: true,\n-      });\n-\n-      updates.push({\n-        propertyPath: `primaryColumns.${columnName}.isEditable`,\n-        propertyValue: true,\n-      });\n-    });\n-  }\n-\n-  return updates.length > 0 ? updates : undefined;\n-};\ndiff --git a/app/client/src/widgets/TableWidgetV2/widget/reactTableUtils/getColumnsPureFn.tsx b/app/client/src/widgets/TableWidgetV2/widget/reactTableUtils/getColumnsPureFn.tsx\nindex 47e97e27666..769768d68d2 100644\n--- a/app/client/src/widgets/TableWidgetV2/widget/reactTableUtils/getColumnsPureFn.tsx\n+++ b/app/client/src/widgets/TableWidgetV2/widget/reactTableUtils/getColumnsPureFn.tsx\n@@ -4,6 +4,7 @@ import { RenderModes } from \"constants/WidgetConstants\";\n import { StickyType } from \"../../component/Constants\";\n import {\n   COLUMN_MIN_WIDTH,\n+  ColumnTypes,\n   DEFAULT_COLUMN_WIDTH,\n   DEFAULT_COLUMN_NAME,\n } from \"../../constants\";\n@@ -21,6 +22,7 @@ export type getColumns = (\n   componentWidth: number,\n   renderMode: RenderMode,\n   isPreviewMode: boolean,\n+  infiniteScrollEnabled?: boolean,\n ) => ReactTableColumnProps[];\n \n //TODO: (Vamsi) need to unit test this function\n@@ -32,6 +34,7 @@ export const getColumnsPureFn: getColumns = (\n   componentWidth,\n   renderMode,\n   isPreviewMode,\n+  infiniteScrollEnabled = false,\n ) => {\n   let columns: ReactTableColumnProps[] = [];\n   const hiddenColumns: ReactTableColumnProps[] = [];\n@@ -42,6 +45,14 @@ export const getColumnsPureFn: getColumns = (\n     // TODO: Fix this the next time the file is edited\n     // eslint-disable-next-line @typescript-eslint/no-explicit-any\n     orderedTableColumns.forEach((column: any) => {\n+      // Skip EDIT_ACTIONS columns when infinite scroll is enabled\n+      if (\n+        infiniteScrollEnabled &&\n+        column.columnType === ColumnTypes.EDIT_ACTIONS\n+      ) {\n+        return;\n+      }\n+\n       const isHidden = !column.isVisible;\n \n       const columnData = {\ndiff --git a/app/client/src/widgets/TableWidgetV2/widget/utilities.ts b/app/client/src/widgets/TableWidgetV2/widget/utilities.ts\nindex c1c17d8160c..5b2cd649cc5 100644\n--- a/app/client/src/widgets/TableWidgetV2/widget/utilities.ts\n+++ b/app/client/src/widgets/TableWidgetV2/widget/utilities.ts\n@@ -540,8 +540,11 @@ const EdtiableColumnTypes: string[] = [\n   ColumnTypes.CURRENCY,\n ];\n \n-export function isColumnTypeEditable(columnType: string) {\n-  return EdtiableColumnTypes.includes(columnType);\n+export function isColumnTypeEditable(\n+  columnType: string,\n+  isInfiniteScrollEnabled = false,\n+) {\n+  return EdtiableColumnTypes.includes(columnType) && !isInfiniteScrollEnabled;\n }\n \n /*\n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/appsmithorg__appsmith.7046aeb3/pr_mirror/appsmithorg__appsmith.main.41217/metadata__pr_41217.json"
  },
  {
    "instance_id": "appsmithorg__appsmith.main.41008",
    "repo": "appsmithorg/appsmith",
    "pull_number": 41008,
    "base_commit": "1789339e27785386a79722c7550d7f560e04093f",
    "patch": "diff --git a/app/client/src/PluginActionEditor/types/PluginActionTypes.ts b/app/client/src/PluginActionEditor/types/PluginActionTypes.ts\nindex f81d82a2485..735c9652dce 100644\n--- a/app/client/src/PluginActionEditor/types/PluginActionTypes.ts\n+++ b/app/client/src/PluginActionEditor/types/PluginActionTypes.ts\n@@ -6,6 +6,7 @@ export enum ActionRunBehaviour {\n   ON_PAGE_LOAD = \"ON_PAGE_LOAD\",\n   MANUAL = \"MANUAL\",\n   AUTOMATIC = \"AUTOMATIC\",\n+  ON_PAGE_UNLOAD = \"ON_PAGE_UNLOAD\",\n }\n \n export type ActionRunBehaviourType = `${ActionRunBehaviour}`;\ndiff --git a/app/client/src/ce/entities/FeatureFlag.ts b/app/client/src/ce/entities/FeatureFlag.ts\nindex a6d84c60537..120af37c6d6 100644\n--- a/app/client/src/ce/entities/FeatureFlag.ts\n+++ b/app/client/src/ce/entities/FeatureFlag.ts\n@@ -60,6 +60,8 @@ export const FEATURE_FLAG = {\n   release_ai_chat_integrations_enabled: \"release_ai_chat_integrations_enabled\",\n   release_reactive_actions_enabled: \"release_reactive_actions_enabled\",\n   license_ai_agent_instance_enabled: \"license_ai_agent_instance_enabled\",\n+  release_jsobjects_onpageunloadactions_enabled:\n+    \"release_jsobjects_onpageunloadactions_enabled\",\n } as const;\n \n export type FeatureFlag = keyof typeof FEATURE_FLAG;\n@@ -110,6 +112,7 @@ export const DEFAULT_FEATURE_FLAG_VALUE: FeatureFlags = {\n   release_ai_chat_integrations_enabled: false,\n   release_reactive_actions_enabled: false,\n   license_ai_agent_instance_enabled: false,\n+  release_jsobjects_onpageunloadactions_enabled: false,\n };\n \n export const AB_TESTING_EVENT_KEYS = {\ndiff --git a/app/client/src/constants/AppsmithActionConstants/formConfig/PluginSettings.ts b/app/client/src/constants/AppsmithActionConstants/formConfig/PluginSettings.ts\nindex ff0dfc07892..fb530fa2a7f 100644\n--- a/app/client/src/constants/AppsmithActionConstants/formConfig/PluginSettings.ts\n+++ b/app/client/src/constants/AppsmithActionConstants/formConfig/PluginSettings.ts\n@@ -22,3 +22,13 @@ export const RUN_BEHAVIOR_VALUES = [\n     children: \"Manual\",\n   },\n ];\n+\n+export const JS_OBJECT_RUN_BEHAVIOR_VALUES = [\n+  ...RUN_BEHAVIOR_VALUES,\n+  {\n+    label: \"On page unload\",\n+    subText: \"Query runs when the page unloads or when manually triggered\",\n+    value: ActionRunBehaviour.ON_PAGE_UNLOAD,\n+    children: \"On page unload\",\n+  },\n+];\ndiff --git a/app/client/src/pages/Editor/JSEditor/JSEditorToolbar/components/JSFunctionSettings.tsx b/app/client/src/pages/Editor/JSEditor/JSEditorToolbar/components/JSFunctionSettings.tsx\nindex d537ae3cbc7..4f228569896 100644\n--- a/app/client/src/pages/Editor/JSEditor/JSEditorToolbar/components/JSFunctionSettings.tsx\n+++ b/app/client/src/pages/Editor/JSEditor/JSEditorToolbar/components/JSFunctionSettings.tsx\n@@ -1,27 +1,21 @@\n-import React, { useCallback, useState } from \"react\";\n-import {\n-  Flex,\n-  Option,\n-  Select,\n-  Text,\n-  type SelectOptionProps,\n-} from \"@appsmith/ads\";\n-import type { JSAction } from \"entities/JSCollection\";\n+import { Flex, Option, Select, Text } from \"@appsmith/ads\";\n import {\n   createMessage,\n   JS_EDITOR_SETTINGS,\n   NO_JS_FUNCTIONS,\n } from \"ee/constants/messages\";\n+import { FEATURE_FLAG } from \"ee/entities/FeatureFlag\";\n import AnalyticsUtil from \"ee/utils/AnalyticsUtil\";\n-import type { OnUpdateSettingsProps } from \"../types\";\n-import {\n-  ActionRunBehaviour,\n-  type ActionRunBehaviourType,\n-} from \"PluginActionEditor/types/PluginActionTypes\";\n+import type { JSAction } from \"entities/JSCollection\";\n+import { type ActionRunBehaviourType } from \"PluginActionEditor/types/PluginActionTypes\";\n+import React, { useCallback, useMemo, useState } from \"react\";\n import styled from \"styled-components\";\n-import { RUN_BEHAVIOR_VALUES } from \"constants/AppsmithActionConstants/formConfig/PluginSettings\";\n import { useFeatureFlag } from \"utils/hooks/useFeatureFlag\";\n-import { FEATURE_FLAG } from \"ee/entities/FeatureFlag\";\n+import type { OnUpdateSettingsProps } from \"../types\";\n+import {\n+  getDefaultRunBehaviorOptionWhenFeatureFlagIsDisabled,\n+  getRunBehaviorOptionsBasedOnFeatureFlags,\n+} from \"./utils\";\n \n const OptionLabel = styled(Text)`\n   color: var(--ads-v2-color-fg);\n@@ -61,20 +55,31 @@ const FunctionSettingRow = (props: FunctionSettingsRowProps) => {\n   const isReactiveActionsEnabled = useFeatureFlag(\n     FEATURE_FLAG.release_reactive_actions_enabled,\n   );\n-  const options = RUN_BEHAVIOR_VALUES.filter(\n-    (option) =>\n-      isReactiveActionsEnabled || option.value !== ActionRunBehaviour.AUTOMATIC,\n-  ) as SelectOptionProps[];\n+  const isOnPageUnloadEnabled = useFeatureFlag(\n+    FEATURE_FLAG.release_jsobjects_onpageunloadactions_enabled,\n+  );\n+\n+  const options = useMemo(\n+    () =>\n+      getRunBehaviorOptionsBasedOnFeatureFlags(\n+        isReactiveActionsEnabled,\n+        isOnPageUnloadEnabled,\n+      ),\n+    [isReactiveActionsEnabled, isOnPageUnloadEnabled],\n+  );\n+\n   let selectedValue = options.find((opt) => opt.value === runBehaviour);\n \n-  /* temporary check added to switch from automatic to page load as the run behaviour when feature flag is turned off */\n-  if (\n-    runBehaviour === ActionRunBehaviour.AUTOMATIC &&\n-    !isReactiveActionsEnabled\n-  ) {\n-    selectedValue = options.find(\n-      (opt) => opt.value === ActionRunBehaviour.ON_PAGE_LOAD,\n+  const defaultRunBehaviourOption =\n+    getDefaultRunBehaviorOptionWhenFeatureFlagIsDisabled(\n+      runBehaviour,\n+      isReactiveActionsEnabled,\n+      isOnPageUnloadEnabled,\n+      options,\n     );\n+\n+  if (defaultRunBehaviourOption) {\n+    selectedValue = defaultRunBehaviourOption;\n   }\n \n   const onSelectOptions = useCallback(\ndiff --git a/app/client/src/pages/Editor/JSEditor/JSEditorToolbar/components/utils.test.ts b/app/client/src/pages/Editor/JSEditor/JSEditorToolbar/components/utils.test.ts\nnew file mode 100644\nindex 00000000000..3887fa94eb1\n--- /dev/null\n+++ b/app/client/src/pages/Editor/JSEditor/JSEditorToolbar/components/utils.test.ts\n@@ -0,0 +1,151 @@\n+import {\n+  ActionRunBehaviour,\n+  type ActionRunBehaviourType,\n+} from \"PluginActionEditor/types/PluginActionTypes\";\n+import {\n+  getDefaultRunBehaviorOptionWhenFeatureFlagIsDisabled,\n+  getRunBehaviorOptionsBasedOnFeatureFlags,\n+} from \"./utils\";\n+import { JS_OBJECT_RUN_BEHAVIOR_VALUES } from \"constants/AppsmithActionConstants/formConfig/PluginSettings\";\n+import type { SelectOptionProps } from \"@appsmith/ads\";\n+\n+describe(\"getRunBehaviorOptions\", () => {\n+  it(\"should return the correct options\", () => {\n+    const flagsOutputMatrix: {\n+      isReactiveActionsEnabled: boolean;\n+      isOnPageUnloadEnabled: boolean;\n+      expectedOptions: SelectOptionProps[];\n+    }[] = [\n+      {\n+        isReactiveActionsEnabled: true,\n+        isOnPageUnloadEnabled: true,\n+        expectedOptions: JS_OBJECT_RUN_BEHAVIOR_VALUES,\n+      },\n+      {\n+        isReactiveActionsEnabled: false,\n+        isOnPageUnloadEnabled: true,\n+        expectedOptions: JS_OBJECT_RUN_BEHAVIOR_VALUES.filter(\n+          (option) => option.value !== ActionRunBehaviour.AUTOMATIC,\n+        ),\n+      },\n+      {\n+        isReactiveActionsEnabled: true,\n+        isOnPageUnloadEnabled: false,\n+        expectedOptions: JS_OBJECT_RUN_BEHAVIOR_VALUES.filter(\n+          (option) => option.value !== ActionRunBehaviour.ON_PAGE_UNLOAD,\n+        ),\n+      },\n+      {\n+        isReactiveActionsEnabled: false,\n+        isOnPageUnloadEnabled: false,\n+        expectedOptions: JS_OBJECT_RUN_BEHAVIOR_VALUES.filter(\n+          (option) =>\n+            option.value !== ActionRunBehaviour.AUTOMATIC &&\n+            option.value !== ActionRunBehaviour.ON_PAGE_UNLOAD,\n+        ),\n+      },\n+    ];\n+\n+    flagsOutputMatrix.forEach(\n+      ({\n+        expectedOptions,\n+        isOnPageUnloadEnabled,\n+        isReactiveActionsEnabled,\n+      }) => {\n+        const options = getRunBehaviorOptionsBasedOnFeatureFlags(\n+          isReactiveActionsEnabled,\n+          isOnPageUnloadEnabled,\n+        );\n+\n+        expect(options).toEqual(expectedOptions);\n+      },\n+    );\n+  });\n+});\n+\n+describe(\"getDefaultRunBehaviorOptionWhenFeatureFlagIsDisabled\", () => {\n+  const onPageLoadOption =\n+    JS_OBJECT_RUN_BEHAVIOR_VALUES.find(\n+      (option) => option.value === ActionRunBehaviour.ON_PAGE_LOAD,\n+    ) ?? null;\n+  const manualOption =\n+    JS_OBJECT_RUN_BEHAVIOR_VALUES.find(\n+      (option) => option.value === ActionRunBehaviour.MANUAL,\n+    ) ?? null;\n+\n+  const flagsOutputMatrix: {\n+    runBehaviour: ActionRunBehaviourType;\n+    isReactiveActionsEnabled: boolean;\n+    isOnPageUnloadEnabled: boolean;\n+    expectedOption: SelectOptionProps | null;\n+  }[] = [\n+    {\n+      runBehaviour: ActionRunBehaviour.AUTOMATIC,\n+      isReactiveActionsEnabled: true,\n+      isOnPageUnloadEnabled: true,\n+      expectedOption: null,\n+    },\n+    {\n+      runBehaviour: ActionRunBehaviour.AUTOMATIC,\n+      isReactiveActionsEnabled: false,\n+      isOnPageUnloadEnabled: true,\n+      expectedOption: onPageLoadOption,\n+    },\n+    {\n+      runBehaviour: ActionRunBehaviour.AUTOMATIC,\n+      isReactiveActionsEnabled: true,\n+      isOnPageUnloadEnabled: false,\n+      expectedOption: null,\n+    },\n+    {\n+      runBehaviour: ActionRunBehaviour.AUTOMATIC,\n+      isReactiveActionsEnabled: false,\n+      isOnPageUnloadEnabled: false,\n+      expectedOption: onPageLoadOption,\n+    },\n+    {\n+      runBehaviour: ActionRunBehaviour.ON_PAGE_UNLOAD,\n+      isReactiveActionsEnabled: true,\n+      isOnPageUnloadEnabled: true,\n+      expectedOption: null,\n+    },\n+    {\n+      runBehaviour: ActionRunBehaviour.ON_PAGE_UNLOAD,\n+      isReactiveActionsEnabled: false,\n+      isOnPageUnloadEnabled: true,\n+      expectedOption: null,\n+    },\n+    {\n+      runBehaviour: ActionRunBehaviour.ON_PAGE_UNLOAD,\n+      isReactiveActionsEnabled: true,\n+      isOnPageUnloadEnabled: false,\n+      expectedOption: manualOption,\n+    },\n+    {\n+      runBehaviour: ActionRunBehaviour.ON_PAGE_UNLOAD,\n+      isReactiveActionsEnabled: false,\n+      isOnPageUnloadEnabled: false,\n+      expectedOption: manualOption,\n+    },\n+  ];\n+\n+  it(\"should return the correct options\", () => {\n+    flagsOutputMatrix.forEach(\n+      ({\n+        expectedOption,\n+        isOnPageUnloadEnabled,\n+        isReactiveActionsEnabled,\n+        runBehaviour,\n+      }) => {\n+        const option = getDefaultRunBehaviorOptionWhenFeatureFlagIsDisabled(\n+          runBehaviour,\n+          isReactiveActionsEnabled,\n+          isOnPageUnloadEnabled,\n+          JS_OBJECT_RUN_BEHAVIOR_VALUES,\n+        );\n+\n+        expect(option).toEqual(expectedOption);\n+      },\n+    );\n+  });\n+});\ndiff --git a/app/client/src/pages/Editor/JSEditor/JSEditorToolbar/components/utils.ts b/app/client/src/pages/Editor/JSEditor/JSEditorToolbar/components/utils.ts\nnew file mode 100644\nindex 00000000000..08a449a86ff\n--- /dev/null\n+++ b/app/client/src/pages/Editor/JSEditor/JSEditorToolbar/components/utils.ts\n@@ -0,0 +1,56 @@\n+import {\n+  ActionRunBehaviour,\n+  type ActionRunBehaviourType,\n+} from \"PluginActionEditor/types/PluginActionTypes\";\n+import { JS_OBJECT_RUN_BEHAVIOR_VALUES } from \"constants/AppsmithActionConstants/formConfig/PluginSettings\";\n+\n+import { type SelectOptionProps } from \"@appsmith/ads\";\n+/**\n+ * Returns the list of run behavior options based on the current feature flags.\n+ * - If reactive actions are disabled, removes AUTOMATIC.\n+ * - If onPageUnload is disabled, removes ON_PAGE_UNLOAD.\n+ */\n+export const getRunBehaviorOptionsBasedOnFeatureFlags = (\n+  isReactiveActionsEnabled: boolean,\n+  isOnPageUnloadEnabled: boolean,\n+) =>\n+  JS_OBJECT_RUN_BEHAVIOR_VALUES.filter(\n+    (option) =>\n+      (isReactiveActionsEnabled ||\n+        option.value !== ActionRunBehaviour.AUTOMATIC) &&\n+      (isOnPageUnloadEnabled ||\n+        option.value !== ActionRunBehaviour.ON_PAGE_UNLOAD),\n+  ) as SelectOptionProps[];\n+\n+/**\n+ * Returns the default run behavior option if the current one is no longer available due to feature flag changes.\n+ * - AUTOMATIC falls back to ON_PAGE_LOAD if reactive actions are disabled.\n+ * - ON_PAGE_UNLOAD falls back to MANUAL if onPageUnload is disabled.\n+ */\n+export const getDefaultRunBehaviorOptionWhenFeatureFlagIsDisabled = (\n+  runBehaviour: ActionRunBehaviourType,\n+  isReactiveActionsEnabled: boolean,\n+  isOnPageUnloadEnabled: boolean,\n+  options: SelectOptionProps[],\n+): SelectOptionProps | null => {\n+  if (\n+    runBehaviour === ActionRunBehaviour.AUTOMATIC &&\n+    !isReactiveActionsEnabled\n+  ) {\n+    return (\n+      options.find((opt) => opt.value === ActionRunBehaviour.ON_PAGE_LOAD) ??\n+      null\n+    );\n+  }\n+\n+  if (\n+    runBehaviour === ActionRunBehaviour.ON_PAGE_UNLOAD &&\n+    !isOnPageUnloadEnabled\n+  ) {\n+    return (\n+      options.find((opt) => opt.value === ActionRunBehaviour.MANUAL) ?? null\n+    );\n+  }\n+\n+  return null;\n+};\n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/appsmithorg__appsmith.7046aeb3/pr_mirror/appsmithorg__appsmith.main.41008/metadata__pr_41008.json"
  },
  {
    "instance_id": "appsmithorg__appsmith.main.41370",
    "repo": "appsmithorg/appsmith",
    "pull_number": 41370,
    "base_commit": "f092c5df46c19cf24edebde095e1e6ea19c98c41",
    "patch": "diff --git a/app/client/cypress/e2e/Regression/ClientSide/Widgets/TableV2/scrollbar_spec.ts b/app/client/cypress/e2e/Regression/ClientSide/Widgets/TableV2/scrollbar_spec.ts\nindex daafb18945e..b15899b2af1 100644\n--- a/app/client/cypress/e2e/Regression/ClientSide/Widgets/TableV2/scrollbar_spec.ts\n+++ b/app/client/cypress/e2e/Regression/ClientSide/Widgets/TableV2/scrollbar_spec.ts\n@@ -24,8 +24,10 @@ describe(\n       });\n \n       cy.get(\".t--draggable-tablewidgetv2 .table .simplebar-content\").then(\n-        ($scrollBox) =>\n-          expect($scrollBox[0].clientHeight).to.be.equal(tableHeight),\n+        ($scrollBox) => {\n+          // +2 is because of the SCROLL_BAR_OFFSET, which got added to the table height in PR: https://github.com/appsmithorg/appsmith/pull/41370\n+          expect($scrollBox[0].clientHeight).to.be.equal(tableHeight + 2);\n+        },\n       );\n     });\n   },\ndiff --git a/app/client/src/widgets/TableWidgetV2/component/Constants.ts b/app/client/src/widgets/TableWidgetV2/component/Constants.ts\nindex 88ad92b6cf1..6896ccb4949 100644\n--- a/app/client/src/widgets/TableWidgetV2/component/Constants.ts\n+++ b/app/client/src/widgets/TableWidgetV2/component/Constants.ts\n@@ -599,7 +599,7 @@ export enum AddNewRowActions {\n export const EDITABLE_CELL_PADDING_OFFSET = 8;\n \n export const TABLE_SCROLLBAR_WIDTH = 10;\n-export const TABLE_SCROLLBAR_HEIGHT = 8;\n+export const TABLE_SCROLLBAR_HEIGHT = 10;\n \n export const POPOVER_ITEMS_TEXT_MAP = {\n   SORT_ASC: \"Sort column ascending\",\ndiff --git a/app/client/src/widgets/TableWidgetV2/component/TableContext.test.tsx b/app/client/src/widgets/TableWidgetV2/component/TableContext.test.tsx\nindex cd657ad4264..6eb798b4b50 100644\n--- a/app/client/src/widgets/TableWidgetV2/component/TableContext.test.tsx\n+++ b/app/client/src/widgets/TableWidgetV2/component/TableContext.test.tsx\n@@ -249,7 +249,7 @@ describe(\"TableContext\", () => {\n         .tableContext;\n \n       expect(context.scrollContainerStyles).toEqual({\n-        height: 352, // 400 - 40 - 8 (height - TABLE_HEADER_HEIGHT - TABLE_SCROLLBAR_HEIGHT)\n+        height: 350, // 400 - 40 - 10 (height - TABLE_HEADER_HEIGHT - TABLE_SCROLLBAR_HEIGHT)\n         width: 800,\n       });\n     });\n@@ -267,7 +267,7 @@ describe(\"TableContext\", () => {\n         .tableContext;\n \n       expect(context.scrollContainerStyles).toEqual({\n-        height: 390, // 400 - 8 - 2 (height - TABLE_SCROLLBAR_HEIGHT - SCROLL_BAR_OFFSET)\n+        height: 388, // 400 - 10 - 2 (height - TABLE_SCROLLBAR_HEIGHT - SCROLL_BAR_OFFSET)\n         width: 800,\n       });\n     });\ndiff --git a/app/client/src/widgets/TableWidgetV2/component/TableStyledWrappers.tsx b/app/client/src/widgets/TableWidgetV2/component/TableStyledWrappers.tsx\nindex d212ac79153..f22db0b4d79 100644\n--- a/app/client/src/widgets/TableWidgetV2/component/TableStyledWrappers.tsx\n+++ b/app/client/src/widgets/TableWidgetV2/component/TableStyledWrappers.tsx\n@@ -64,13 +64,15 @@ export const TableWrapper = styled.div<{\n   .simplebar-track {\n     opacity: 0.7;\n     &.simplebar-horizontal {\n+      /* this height moves the scrollbar up and down */\n       height: ${TABLE_SCROLLBAR_HEIGHT}px;\n       .simplebar-scrollbar {\n-        height: 5px;\n+        /*this actual height of the scrollbar */\n+        height: 8px;\n       }\n       &.simplebar-hover {\n-        height: 10px;\n         & .simplebar-scrollbar {\n+          transition: height 0.15s ease-in-out;\n           height: 8px;\n         }\n       }\n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/appsmithorg__appsmith.7046aeb3/pr_mirror/appsmithorg__appsmith.main.41370/metadata__pr_41370.json"
  },
  {
    "instance_id": "PostHog__posthog.main.42552",
    "repo": "PostHog/posthog",
    "pull_number": 42552,
    "base_commit": "51af4a65b07d90944ac7ef8c285953710b954337",
    "patch": "diff --git a/plugin-server/src/ingestion/ingestion-e2e.test.ts b/plugin-server/src/ingestion/ingestion-e2e.test.ts\nindex 0fd07003fc8d3..453bd3534c20e 100644\n--- a/plugin-server/src/ingestion/ingestion-e2e.test.ts\n+++ b/plugin-server/src/ingestion/ingestion-e2e.test.ts\n@@ -784,6 +784,84 @@ describe('Event Pipeline E2E tests', () => {\n         }\n     )\n \n+    testWithTeamIngester(\n+        'allowed geoip properties ($geoip_country_name, $geoip_city_name) trigger person updates alongside blocked geoip properties',\n+        {},\n+        async (ingester, hub, team) => {\n+            const distinctId = new UUIDT().toString()\n+            const timestamp = DateTime.now().toMillis()\n+\n+            // When $geoip_country_name or $geoip_city_name changes, all geoip properties in the batch\n+            // should be updated, even the normally-blocked ones like $geoip_latitude\n+            await ingester.handleKafkaBatch(\n+                createKafkaMessages([\n+                    // Event 1: Create person with initial geoip properties\n+                    new EventBuilder(team, distinctId)\n+                        .withEvent('$pageview')\n+                        .withProperties({\n+                            $set: {\n+                                $geoip_country_name: 'Canada',\n+                                $geoip_city_name: 'Toronto',\n+                                $geoip_latitude: 43.6532,\n+                                $geoip_longitude: -79.3832,\n+                            },\n+                        })\n+                        .withTimestamp(timestamp)\n+                        .build(),\n+                    // Event 2: Update geoip properties including allowed ones (country/city)\n+                    // Since $geoip_country_name changes, all geoip properties should be updated\n+                    new EventBuilder(team, distinctId)\n+                        .withEvent('$pageview')\n+                        .withProperties({\n+                            $set: {\n+                                $geoip_country_name: 'United States',\n+                                $geoip_city_name: 'San Francisco',\n+                                $geoip_latitude: 37.7749,\n+                                $geoip_longitude: -122.4194,\n+                            },\n+                        })\n+                        .withTimestamp(timestamp + 1)\n+                        .build(),\n+                ])\n+            )\n+\n+            await waitForExpect(async () => {\n+                const events = await fetchEvents(hub, team.id)\n+                expect(events.length).toEqual(2)\n+\n+                // Event 0 (first pageview): Should have initial geoip properties\n+                expect(events[0].person_properties).toEqual({\n+                    $creator_event_uuid: events[0].uuid,\n+                    $geoip_country_name: 'Canada',\n+                    $geoip_city_name: 'Toronto',\n+                    $geoip_latitude: 43.6532,\n+                    $geoip_longitude: -79.3832,\n+                })\n+\n+                // Event 1 (second pageview): Should have UPDATED geoip properties\n+                // Because $geoip_country_name is an allowed property, all geoip properties get updated\n+                expect(events[1].person_properties).toEqual({\n+                    $creator_event_uuid: events[0].uuid,\n+                    $geoip_country_name: 'United States',\n+                    $geoip_city_name: 'San Francisco',\n+                    $geoip_latitude: 37.7749,\n+                    $geoip_longitude: -122.4194,\n+                })\n+\n+                // Verify the final state of the person in the database reflects the updates\n+                const person = await hub.personRepository.fetchPerson(team.id, distinctId)\n+                expect(person).toBeDefined()\n+                expect(person!.properties).toEqual({\n+                    $creator_event_uuid: events[0].uuid,\n+                    $geoip_country_name: 'United States',\n+                    $geoip_city_name: 'San Francisco',\n+                    $geoip_latitude: 37.7749,\n+                    $geoip_longitude: -122.4194,\n+                })\n+            })\n+        }\n+    )\n+\n     testWithTeamIngester('can handle events with $process_person_profile=false', {}, async (ingester, hub, team) => {\n         const distinctId = new UUIDT().toString()\n         const timestamp = DateTime.now().toMillis()\ndiff --git a/plugin-server/src/worker/ingestion/persons/batch-writing-person-store.test.ts b/plugin-server/src/worker/ingestion/persons/batch-writing-person-store.test.ts\nindex 4c50a7768ae42..c4e46a8913bff 100644\n--- a/plugin-server/src/worker/ingestion/persons/batch-writing-person-store.test.ts\n+++ b/plugin-server/src/worker/ingestion/persons/batch-writing-person-store.test.ts\n@@ -1594,15 +1594,16 @@ describe('BatchWritingPersonStore', () => {\n             expect(mockPersonPropertyKeyUpdateCounter.labels).not.toHaveBeenCalled()\n         })\n \n-        it('should skip database write when only $geoip_* properties are updated', async () => {\n+        it('should skip database write when only blocked $geoip_* properties are updated', async () => {\n             const mockRepo = createMockRepository()\n             const testPersonStore = new BatchWritingPersonsStore(mockRepo, db.kafkaProducer)\n             const personStoreForBatch = testPersonStore.forBatch() as BatchWritingPersonsStoreForBatch\n \n-            // Update person with only geoip properties (existing properties being updated)\n+            // Update person with only blocked geoip properties (existing properties being updated)\n+            // Note: $geoip_country_name and $geoip_city_name are allowed, but $geoip_latitude is blocked\n             await personStoreForBatch.updatePersonWithPropertiesDiffForUpdate(\n-                { ...person, properties: { $geoip_city_name: 'New York', $geoip_country_code: 'US' } },\n-                { $geoip_city_name: 'San Francisco', $geoip_country_code: 'US' },\n+                { ...person, properties: { $geoip_latitude: 40.7128, $geoip_longitude: -74.006 } },\n+                { $geoip_latitude: 37.7749, $geoip_longitude: -74.006 },\n                 [],\n                 {},\n                 'test'\n@@ -1622,7 +1623,7 @@ describe('BatchWritingPersonStore', () => {\n             )\n             expect(mockPersonProfileBatchIgnoredPropertiesCounter.labels).toHaveBeenCalledTimes(1)\n             expect(mockPersonProfileBatchIgnoredPropertiesCounter.labels).toHaveBeenCalledWith({\n-                property: '$geoip_city_name',\n+                property: '$geoip_latitude',\n             })\n             // personPropertyKeyUpdateCounter should NOT be called for 'ignored' outcomes\n             expect(mockPersonPropertyKeyUpdateCounter.labels).not.toHaveBeenCalled()\n@@ -1781,7 +1782,7 @@ describe('BatchWritingPersonStore', () => {\n                 properties: {\n                     $browser: 'Firefox',\n                     $app_build: '100',\n-                    $geoip_city_name: 'New York',\n+                    $geoip_latitude: 40.7128,\n                 },\n             }\n \n@@ -1803,10 +1804,10 @@ describe('BatchWritingPersonStore', () => {\n                 'test'\n             )\n \n-            // Event 3: Update geoip\n+            // Event 3: Update blocked geoip property (latitude is blocked, city_name is allowed)\n             await personStoreForBatch.updatePersonWithPropertiesDiffForUpdate(\n                 personWithFiltered,\n-                { $geoip_city_name: 'Los Angeles' },\n+                { $geoip_latitude: 37.7749 },\n                 [],\n                 {},\n                 'test'\n@@ -1832,12 +1833,68 @@ describe('BatchWritingPersonStore', () => {\n                 property: '$app_build',\n             })\n             expect(mockPersonProfileBatchIgnoredPropertiesCounter.labels).toHaveBeenCalledWith({\n-                property: '$geoip_city_name',\n+                property: '$geoip_latitude',\n             })\n             // personPropertyKeyUpdateCounter should NOT be called for 'ignored' outcomes\n             expect(mockPersonPropertyKeyUpdateCounter.labels).not.toHaveBeenCalled()\n         })\n \n+        it('should write to database when allowed geoip property ($geoip_country_name) is updated alongside blocked ones', async () => {\n+            const mockRepo = createMockRepository()\n+            const testPersonStore = new BatchWritingPersonsStore(mockRepo, db.kafkaProducer)\n+            const personStoreForBatch = testPersonStore.forBatch() as BatchWritingPersonsStoreForBatch\n+\n+            // Person with existing geoip properties\n+            const personWithGeoip = {\n+                ...person,\n+                properties: {\n+                    $geoip_country_name: 'Canada',\n+                    $geoip_city_name: 'Toronto',\n+                    $geoip_latitude: 43.6532,\n+                    $geoip_longitude: -79.3832,\n+                },\n+            }\n+\n+            // Update all geoip properties including allowed ones (country_name, city_name)\n+            // Since $geoip_country_name is allowed, all properties should be updated\n+            await personStoreForBatch.updatePersonWithPropertiesDiffForUpdate(\n+                personWithGeoip,\n+                {\n+                    $geoip_country_name: 'United States',\n+                    $geoip_city_name: 'San Francisco',\n+                    $geoip_latitude: 37.7749,\n+                    $geoip_longitude: -122.4194,\n+                },\n+                [],\n+                {},\n+                'test'\n+            )\n+\n+            // Flush SHOULD write to database because $geoip_country_name is allowed\n+            await personStoreForBatch.flush()\n+\n+            expect(mockRepo.updatePerson).toHaveBeenCalledTimes(1)\n+            expect(mockRepo.updatePerson).toHaveBeenCalledWith(\n+                expect.objectContaining({\n+                    properties: {\n+                        $geoip_country_name: 'United States',\n+                        $geoip_city_name: 'San Francisco',\n+                        $geoip_latitude: 37.7749,\n+                        $geoip_longitude: -122.4194,\n+                    },\n+                }),\n+                expect.anything(),\n+                'updatePersonNoAssert'\n+            )\n+\n+            // Verify metrics - should be 'changed' since allowed geoip property triggers write\n+            expect(mockPersonProfileBatchUpdateOutcomeCounter.labels).toHaveBeenCalledTimes(1)\n+            expect(mockPersonProfileBatchUpdateOutcomeCounter.labels).toHaveBeenCalledWith({ outcome: 'changed' })\n+            expect(mockPersonProfileBatchIgnoredPropertiesCounter.labels).not.toHaveBeenCalled()\n+            // personPropertyKeyUpdateCounter uses getMetricKey which returns 'geoIP' for all $geoip_* properties\n+            expect(mockPersonPropertyKeyUpdateCounter.labels).toHaveBeenCalledWith({ key: 'geoIP' })\n+        })\n+\n         it('integration: filtered properties then non-filtered property should trigger database write', async () => {\n             const mockRepo = createMockRepository()\n             const testPersonStore = new BatchWritingPersonsStore(mockRepo, db.kafkaProducer)\ndiff --git a/plugin-server/src/worker/ingestion/persons/batch-writing-person-store.ts b/plugin-server/src/worker/ingestion/persons/batch-writing-person-store.ts\nindex b7573fbf12c31..950dcc22aee0a 100644\n--- a/plugin-server/src/worker/ingestion/persons/batch-writing-person-store.ts\n+++ b/plugin-server/src/worker/ingestion/persons/batch-writing-person-store.ts\n@@ -36,8 +36,7 @@ import {\n     personWriteMethodAttemptCounter,\n     totalPersonUpdateLatencyPerBatchHistogram,\n } from './metrics'\n-import { eventToPersonProperties } from './person-property-utils'\n-import { getMetricKey } from './person-update'\n+import { getMetricKey, isFilteredPersonPropertyKey } from './person-update'\n import { PersonUpdate, fromInternalPerson, toInternalPerson } from './person-update-batch'\n import { PersonsStore } from './persons-store'\n import { FlushResult, PersonsStoreForBatch } from './persons-store-for-batch'\n@@ -207,7 +206,7 @@ export class BatchWritingPersonsStoreForBatch implements PersonsStoreForBatch, B\n                 return true\n             }\n \n-            const isFiltered = eventToPersonProperties.has(key) || key.startsWith('$geoip_')\n+            const isFiltered = isFilteredPersonPropertyKey(key)\n             if (isFiltered) {\n                 ignoredProperties.push(key)\n                 return false\ndiff --git a/plugin-server/src/worker/ingestion/persons/person-update.test.ts b/plugin-server/src/worker/ingestion/persons/person-update.test.ts\nindex 3e71704a024fa..c55c6e1cd95e3 100644\n--- a/plugin-server/src/worker/ingestion/persons/person-update.test.ts\n+++ b/plugin-server/src/worker/ingestion/persons/person-update.test.ts\n@@ -154,7 +154,49 @@ describe('person-update', () => {\n                 }\n             )\n \n-            it('should accept $geoip_* property updates at event level (filtering happens at batch level)', () => {\n+            it('should accept blocked $geoip_* property updates at event level (filtering happens at batch level)', () => {\n+                const event: PluginEvent = {\n+                    event: 'pageview',\n+                    properties: {\n+                        $set: { $geoip_latitude: 37.7749 },\n+                    },\n+                } as any\n+\n+                const personProperties = { $geoip_latitude: 40.7128 }\n+\n+                const result = computeEventPropertyUpdates(event, personProperties)\n+\n+                expect(result.hasChanges).toBe(true)\n+                expect(result.toSet).toEqual({ $geoip_latitude: 37.7749 })\n+                expect(result.shouldForceUpdate).toBe(false)\n+                // At event level, blocked geoip properties would be marked as ignored\n+                expect(mockPersonProfileUpdateOutcomeCounter.labels).toHaveBeenCalledWith({ outcome: 'ignored' })\n+                expect(mockPersonProfileIgnoredPropertiesCounter.labels).toHaveBeenCalledWith({\n+                    property: '$geoip_latitude',\n+                })\n+            })\n+\n+            it('should trigger update when $geoip_country_name changes (allowed geoip property)', () => {\n+                const event: PluginEvent = {\n+                    event: 'pageview',\n+                    properties: {\n+                        $set: { $geoip_country_name: 'United States' },\n+                    },\n+                } as any\n+\n+                const personProperties = { $geoip_country_name: 'Canada' }\n+\n+                const result = computeEventPropertyUpdates(event, personProperties)\n+\n+                expect(result.hasChanges).toBe(true)\n+                expect(result.toSet).toEqual({ $geoip_country_name: 'United States' })\n+                expect(result.shouldForceUpdate).toBe(false)\n+                // $geoip_country_name is allowed so should be marked as changed\n+                expect(mockPersonProfileUpdateOutcomeCounter.labels).toHaveBeenCalledWith({ outcome: 'changed' })\n+                expect(mockPersonProfileIgnoredPropertiesCounter.labels).not.toHaveBeenCalled()\n+            })\n+\n+            it('should trigger update when $geoip_city_name changes (allowed geoip property)', () => {\n                 const event: PluginEvent = {\n                     event: 'pageview',\n                     properties: {\n@@ -169,11 +211,43 @@ describe('person-update', () => {\n                 expect(result.hasChanges).toBe(true)\n                 expect(result.toSet).toEqual({ $geoip_city_name: 'San Francisco' })\n                 expect(result.shouldForceUpdate).toBe(false)\n-                // At event level, geoip properties would be marked as ignored\n-                expect(mockPersonProfileUpdateOutcomeCounter.labels).toHaveBeenCalledWith({ outcome: 'ignored' })\n-                expect(mockPersonProfileIgnoredPropertiesCounter.labels).toHaveBeenCalledWith({\n-                    property: '$geoip_city_name',\n+                // $geoip_city_name is allowed so should be marked as changed\n+                expect(mockPersonProfileUpdateOutcomeCounter.labels).toHaveBeenCalledWith({ outcome: 'changed' })\n+                expect(mockPersonProfileIgnoredPropertiesCounter.labels).not.toHaveBeenCalled()\n+            })\n+\n+            it('should update all geoip properties when allowed property ($geoip_country_name) changes alongside blocked ones', () => {\n+                const event: PluginEvent = {\n+                    event: 'pageview',\n+                    properties: {\n+                        $set: {\n+                            $geoip_country_name: 'United States',\n+                            $geoip_latitude: 37.7749,\n+                            $geoip_longitude: -122.4194,\n+                            $geoip_postal_code: '94102',\n+                        },\n+                    },\n+                } as any\n+\n+                const personProperties = {\n+                    $geoip_country_name: 'Canada',\n+                    $geoip_latitude: 43.6532,\n+                    $geoip_longitude: -79.3832,\n+                    $geoip_postal_code: 'M5V',\n+                }\n+\n+                const result = computeEventPropertyUpdates(event, personProperties)\n+\n+                expect(result.hasChanges).toBe(true)\n+                expect(result.toSet).toEqual({\n+                    $geoip_country_name: 'United States',\n+                    $geoip_latitude: 37.7749,\n+                    $geoip_longitude: -122.4194,\n+                    $geoip_postal_code: '94102',\n                 })\n+                expect(result.shouldForceUpdate).toBe(false)\n+                // Since $geoip_country_name is allowed, the update is marked as changed (not ignored)\n+                expect(mockPersonProfileUpdateOutcomeCounter.labels).toHaveBeenCalledWith({ outcome: 'changed' })\n             })\n \n             it('should accept eventToPersonProperties even when mixed with unchanged custom properties', () => {\ndiff --git a/plugin-server/src/worker/ingestion/persons/person-update.ts b/plugin-server/src/worker/ingestion/persons/person-update.ts\nindex 8894149a95d0b..9b40787ff1928 100644\n--- a/plugin-server/src/worker/ingestion/persons/person-update.ts\n+++ b/plugin-server/src/worker/ingestion/persons/person-update.ts\n@@ -19,6 +19,10 @@ export interface PropertyUpdates {\n const NO_PERSON_UPDATE_EVENTS = new Set(['$exception', '$$heatmap'])\n const PERSON_EVENTS = new Set(['$identify', '$create_alias', '$merge_dangerously', '$set'])\n \n+// GeoIP properties that should still trigger person updates even when other geoip properties are blocked\n+// These are commonly used for segmentation and are worth keeping up-to-date\n+const ALLOWED_GEOIP_PROPERTIES = new Set(['$geoip_country_name', '$geoip_city_name'])\n+\n // For tracking what property keys cause us to update persons\n // tracking all properties we add from the event, 'geoip' for '$geoip_*' or '$initial_geoip_*' and 'other' for anything outside of those\n export function getMetricKey(key: string): string {\n@@ -76,22 +80,32 @@ export function computeEventPropertyUpdates(\n         }\n     })\n \n+    // First pass: detect if any property would trigger an update\n+    // If so, all changed properties in this $set should be updated together\n+    let anyPropertyTriggersUpdate = false\n+    const changedProperties: Array<[string, unknown]> = []\n+\n     Object.entries(properties).forEach(([key, value]) => {\n         if (personProperties[key] !== value) {\n+            changedProperties.push([key, value])\n             const isNewProperty = typeof personProperties[key] === 'undefined'\n-            const shouldUpdate = isNewProperty || shouldUpdatePersonIfOnlyChange(event, key, updateAllProperties)\n-\n-            if (shouldUpdate) {\n-                hasChanges = true\n-                hasNonFilteredChanges = true\n-            } else {\n-                hasChanges = true\n-                ignoredProperties.push(key)\n+            if (isNewProperty || shouldUpdatePersonIfOnlyChange(event, key, updateAllProperties)) {\n+                anyPropertyTriggersUpdate = true\n             }\n-            toSet[key] = value\n         }\n     })\n \n+    // Second pass: apply changes - if any property triggers update, all do\n+    changedProperties.forEach(([key, value]) => {\n+        hasChanges = true\n+        if (anyPropertyTriggersUpdate) {\n+            hasNonFilteredChanges = true\n+        } else {\n+            ignoredProperties.push(key)\n+        }\n+        toSet[key] = value\n+    })\n+\n     unsetProperties.forEach((propertyKey) => {\n         if (propertyKey in personProperties) {\n             if (typeof propertyKey === 'string') {\n@@ -159,6 +173,27 @@ export function applyEventPropertyUpdates(\n     return [updatedPerson, updated]\n }\n \n+/**\n+ * Determines if a property key should be filtered out from triggering person updates.\n+ * These are properties that change frequently but aren't valuable enough to update the person record for.\n+ *\n+ * This is the single source of truth for property filtering logic, used by both:\n+ * - Event-level processing (computeEventPropertyUpdates)\n+ * - Batch-level processing (getPersonUpdateOutcome in batch-writing-person-store)\n+ */\n+export function isFilteredPersonPropertyKey(key: string): boolean {\n+    // These are properties we add from the event and some change often, it's useless to update person always\n+    if (eventToPersonProperties.has(key)) {\n+        return true\n+    }\n+    // same as above, coming from GeoIP plugin\n+    // but allow country and city updates as they're commonly used for segmentation\n+    if (key.startsWith('$geoip_')) {\n+        return !ALLOWED_GEOIP_PROPERTIES.has(key)\n+    }\n+    return false\n+}\n+\n // Minimize useless person updates by not overriding properties if it's not a person event and we added from the event\n // They will still show up for PoE as it's not removed from the event, we just don't update the person in PG anymore\n function shouldUpdatePersonIfOnlyChange(event: PluginEvent, key: string, updateAllProperties: boolean): boolean {\n@@ -170,13 +205,5 @@ function shouldUpdatePersonIfOnlyChange(event: PluginEvent, key: string, updateA\n         // for person events always update everything\n         return true\n     }\n-    // These are properties we add from the event and some change often, it's useless to update person always\n-    if (eventToPersonProperties.has(key)) {\n-        return false\n-    }\n-    // same as above, coming from GeoIP plugin\n-    if (key.startsWith('$geoip_')) {\n-        return false\n-    }\n-    return true\n+    return !isFilteredPersonPropertyKey(key)\n }\n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/PostHog__posthog.main/pr_mirror/PostHog__posthog.main.42552/metadata__pr_42552.json"
  },
  {
    "instance_id": "PostHog__posthog.main.42599",
    "repo": "PostHog/posthog",
    "pull_number": 42599,
    "base_commit": "9d66861e8cf6e1d81d7b371a79e565a1a6273357",
    "patch": "diff --git a/plugin-server/src/cdp/consumers/cdp-events-consumer.test.ts b/plugin-server/src/cdp/consumers/cdp-events-consumer.test.ts\nindex 47125eae22135..fe056d73e532e 100644\n--- a/plugin-server/src/cdp/consumers/cdp-events-consumer.test.ts\n+++ b/plugin-server/src/cdp/consumers/cdp-events-consumer.test.ts\n@@ -534,5 +534,33 @@ describe('hog flow processing', () => {\n                 teamId: 2,\n             })\n         })\n+\n+        it('should not produce billable_invocation metrics for hog flow invocations', async () => {\n+            await insertHogFlow(\n+                new FixtureHogFlowBuilder()\n+                    .withTeamId(team.id)\n+                    .withSimpleWorkflow({\n+                        trigger: {\n+                            type: 'event',\n+                            filters: HOG_FILTERS_EXAMPLES.pageview_or_autocapture_filter.filters ?? {},\n+                        },\n+                    })\n+                    .build()\n+            )\n+\n+            await processor['createHogFlowInvocations']([globals])\n+\n+            const producedMetrics =\n+                mockProducerObserver.getProducedKafkaMessagesForTopic('clickhouse_app_metrics2_test')\n+            expect(producedMetrics).not.toEqual(\n+                expect.arrayContaining([\n+                    expect.objectContaining({\n+                        value: expect.objectContaining({\n+                            metric_name: 'billable_invocation',\n+                        }),\n+                    }),\n+                ])\n+            )\n+        })\n     })\n })\ndiff --git a/plugin-server/src/cdp/consumers/cdp-events.consumer.ts b/plugin-server/src/cdp/consumers/cdp-events.consumer.ts\nindex 6f44c0c5f3d5c..5236d5060b960 100644\n--- a/plugin-server/src/cdp/consumers/cdp-events.consumer.ts\n+++ b/plugin-server/src/cdp/consumers/cdp-events.consumer.ts\n@@ -375,14 +375,6 @@ export class CdpEventsConsumer extends CdpConsumerBase {\n                 metric_name: 'triggered',\n                 count: 1,\n             })\n-\n-            triggeredInvocationsMetrics.push({\n-                team_id: item.teamId,\n-                app_source_id: item.functionId,\n-                metric_kind: 'billing',\n-                metric_name: 'billable_invocation',\n-                count: 1,\n-            })\n         })\n \n         this.hogFunctionMonitoringService.queueAppMetrics(triggeredInvocationsMetrics, 'hog_flow')\n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/PostHog__posthog.main/pr_mirror/PostHog__posthog.main.42599/metadata__pr_42599.json"
  },
  {
    "instance_id": "PostHog__posthog.main.42640",
    "repo": "PostHog/posthog",
    "pull_number": 42640,
    "base_commit": "e1ac9f97469f120f9b0c2b28a86a1c286189486e",
    "patch": "diff --git a/frontend/src/scenes/session-recordings/player/rrweb/index.test.ts b/frontend/src/scenes/session-recordings/player/rrweb/index.test.ts\nindex c71605038780d..d24ed895f3be4 100644\n--- a/frontend/src/scenes/session-recordings/player/rrweb/index.test.ts\n+++ b/frontend/src/scenes/session-recordings/player/rrweb/index.test.ts\n@@ -33,6 +33,30 @@ describe('CorsPlugin', () => {\n         CorsPlugin.onBuild?.(el, { id: 1, replayer: null as unknown as any })\n         expect(el.href).toEqual(`https://replay.ph-proxy.com/proxy?url=https://app.posthog.com/my-image.js`)\n     })\n+\n+    it('can replace a stylesheet css link', () => {\n+        const el = document.createElement('link')\n+        el.setAttribute('rel', 'stylesheet')\n+        el.href = 'https://app.posthog.com/assets/styles.css'\n+        CorsPlugin.onBuild?.(el, { id: 1, replayer: null as unknown as any })\n+        expect(el.href).toEqual(`https://replay.ph-proxy.com/proxy?url=https://app.posthog.com/assets/styles.css`)\n+    })\n+\n+    it('can replace a stylesheet css link with query parameters', () => {\n+        const el = document.createElement('link')\n+        el.setAttribute('rel', 'stylesheet')\n+        el.href = 'https://app.posthog.com/assets/styles.css?v=123'\n+        CorsPlugin.onBuild?.(el, { id: 1, replayer: null as unknown as any })\n+        expect(el.href).toEqual(`https://replay.ph-proxy.com/proxy?url=https://app.posthog.com/assets/styles.css?v=123`)\n+    })\n+\n+    it.each([\n+        'https://app.posthog.com/styles.css',\n+        'https://app.posthog.com/styles.css?v=123',\n+        'https://app.posthog.com/assets/main.css?t=1234567890',\n+    ])('should replace CSS urls', (cssUrl) => {\n+        expect(CorsPlugin._replaceCSSUrl(cssUrl)).toEqual(`https://replay.ph-proxy.com/proxy?url=${cssUrl}`)\n+    })\n })\n \n describe('WindowTitlePlugin', () => {\ndiff --git a/frontend/src/scenes/session-recordings/player/rrweb/index.ts b/frontend/src/scenes/session-recordings/player/rrweb/index.ts\nindex ee36a8be2ea11..8dd021ca88428 100644\n--- a/frontend/src/scenes/session-recordings/player/rrweb/index.ts\n+++ b/frontend/src/scenes/session-recordings/player/rrweb/index.ts\n@@ -12,6 +12,7 @@ export const CorsPlugin: ReplayPlugin & {\n     _replaceFontCssUrls: (value: string | null) => string | null\n     _replaceFontUrl: (value: string) => string\n     _replaceJSUrl: (value: string) => string\n+    _replaceCSSUrl: (value: string) => string\n } = {\n     _replaceFontCssUrls: (value: string | null): string | null => {\n         return (\n@@ -30,6 +31,10 @@ export const CorsPlugin: ReplayPlugin & {\n         return value.replace(/^(https:\\/\\/\\S*(?:\\.js)\\S*)$/i, `${PROXY_URL}/proxy?url=$1`)\n     },\n \n+    _replaceCSSUrl: (value: string): string => {\n+        return value.replace(/^(https:\\/\\/\\S*(?:\\.css)\\S*)$/i, `${PROXY_URL}/proxy?url=$1`)\n+    },\n+\n     onBuild: (node) => {\n         if (node.nodeName === 'STYLE') {\n             const styleElement = node as HTMLStyleElement\n@@ -55,8 +60,11 @@ export const CorsPlugin: ReplayPlugin & {\n             if (!href) {\n                 return\n             }\n-            if (linkElement.getAttribute('rel') == 'modulepreload') {\n+            const rel = linkElement.getAttribute('rel')\n+            if (rel === 'modulepreload') {\n                 linkElement.href = CorsPlugin._replaceJSUrl(href)\n+            } else if (rel === 'stylesheet') {\n+                linkElement.href = CorsPlugin._replaceCSSUrl(href)\n             } else {\n                 linkElement.href = CorsPlugin._replaceFontUrl(href)\n             }\n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": true,
    "has_rewrites": false,
    "_file": "logs/bug_gen/PostHog__posthog.main/pr_mirror/PostHog__posthog.main.42640/metadata__pr_42640.json"
  },
  {
    "instance_id": "PostHog__posthog.main.42716",
    "repo": "PostHog/posthog",
    "pull_number": 42716,
    "base_commit": "7ade7ab65f97207781f2fce296da071725e3e955",
    "patch": "diff --git a/products/logs/frontend/LogsScene.tsx b/products/logs/frontend/LogsScene.tsx\nindex 62d6a84b3fcb2..d48921c51a1f0 100644\n--- a/products/logs/frontend/LogsScene.tsx\n+++ b/products/logs/frontend/LogsScene.tsx\n@@ -9,13 +9,11 @@ import {\n     LemonSegmentedButton,\n     LemonSelect,\n     LemonTable,\n-    SpinnerOverlay,\n     Tooltip,\n } from '@posthog/lemon-ui'\n \n import { CopyToClipboardInline } from 'lib/components/CopyToClipboard'\n import { ProductIntroduction } from 'lib/components/ProductIntroduction/ProductIntroduction'\n-import { Sparkline } from 'lib/components/Sparkline'\n import { TZLabel, TZLabelProps } from 'lib/components/TZLabel'\n import { ListHog } from 'lib/components/hedgehogs'\n import { FEATURE_FLAGS } from 'lib/constants'\n@@ -36,6 +34,7 @@ import { LogMessage, ProductKey } from '~/queries/schema/schema-general'\n import { PropertyOperator } from '~/types'\n \n import { LogTag } from 'products/logs/frontend/components/LogTag'\n+import { LogsSparkline } from 'products/logs/frontend/components/LogsSparkline'\n import { LogsTableRowActions } from 'products/logs/frontend/components/LogsTable/LogsTableRowActions'\n import { VirtualizedLogsList } from 'products/logs/frontend/components/VirtualizedLogsList'\n import { LogsFilterGroup } from 'products/logs/frontend/components/filters/LogsFilters/FilterGroup'\n@@ -54,9 +53,8 @@ export const scene: SceneExport = {\n }\n \n export function LogsScene(): JSX.Element {\n-    const { sparklineData, sparklineLoading, logsLoading } = useValues(logsLogic)\n-    const { runQuery, setDateRangeFromSparkline, highlightNextLog, highlightPreviousLog, toggleExpandLog } =\n-        useActions(logsLogic)\n+    const { logsLoading } = useValues(logsLogic)\n+    const { runQuery, highlightNextLog, highlightPreviousLog, toggleExpandLog } = useActions(logsLogic)\n     const { highlightedLogId: sceneHighlightedLogId } = useValues(logsLogic)\n \n     useEffect(() => {\n@@ -81,10 +79,6 @@ export function LogsScene(): JSX.Element {\n         [sceneHighlightedLogId, logsLoading, runQuery]\n     )\n \n-    const onSelectionChange = (selection: { startIndex: number; endIndex: number }): void => {\n-        setDateRangeFromSparkline(selection.startIndex, selection.endIndex)\n-    }\n-\n     return (\n         <SceneContent>\n             <SceneTitleSection\n@@ -115,21 +109,7 @@ export function LogsScene(): JSX.Element {\n                 isEmpty={false}\n             />\n             <Filters />\n-            <div className=\"relative h-40 flex flex-col\">\n-                {sparklineData.data.length > 0 ? (\n-                    <Sparkline\n-                        labels={sparklineData.labels}\n-                        data={sparklineData.data}\n-                        className=\"w-full flex-1\"\n-                        onSelectionChange={onSelectionChange}\n-                    />\n-                ) : !sparklineLoading ? (\n-                    <div className=\"flex-1 text-muted flex items-center justify-center\">\n-                        No results matching filters\n-                    </div>\n-                ) : null}\n-                {sparklineLoading && <SpinnerOverlay />}\n-            </div>\n+            <LogsSparkline />\n             <SceneDivider />\n             <LogsListContainer />\n         </SceneContent>\ndiff --git a/products/logs/frontend/components/LogsSparkline.tsx b/products/logs/frontend/components/LogsSparkline.tsx\nnew file mode 100644\nindex 0000000000000..0a75f25457f92\n--- /dev/null\n+++ b/products/logs/frontend/components/LogsSparkline.tsx\n@@ -0,0 +1,142 @@\n+import { useActions, useValues } from 'kea'\n+import { useCallback, useMemo } from 'react'\n+\n+import { LemonSelect, SpinnerOverlay } from '@posthog/lemon-ui'\n+\n+import { AnyScaleOptions, Sparkline } from 'lib/components/Sparkline'\n+import { dayjs } from 'lib/dayjs'\n+import { shortTimeZone } from 'lib/utils'\n+import { teamLogic } from 'scenes/teamLogic'\n+\n+import { SparklineTimezone, logsLogic } from '../logsLogic'\n+\n+export function LogsSparkline(): JSX.Element {\n+    const { sparklineData, sparklineLoading, sparklineTimezone } = useValues(logsLogic)\n+    const { setDateRangeFromSparkline, setSparklineTimezone } = useActions(logsLogic)\n+    const { timezone: projectTimezone } = useValues(teamLogic)\n+\n+    const deviceTimezone = shortTimeZone()\n+\n+    // Determine which timezone string to use for formatting\n+    const activeTimezone = useMemo(() => {\n+        switch (sparklineTimezone) {\n+            case SparklineTimezone.UTC:\n+                return 'UTC'\n+            case SparklineTimezone.Project:\n+                return projectTimezone\n+            case SparklineTimezone.Device:\n+            default:\n+                return undefined // undefined means local\n+        }\n+    }, [sparklineTimezone, projectTimezone])\n+\n+    // Build timezone options, deduplicating if any match\n+    const timezoneOptions = useMemo(() => {\n+        const options: { value: SparklineTimezone; label: string }[] = [{ value: SparklineTimezone.UTC, label: 'UTC' }]\n+\n+        const projectTzLabel = shortTimeZone(projectTimezone) ?? projectTimezone\n+        if (projectTimezone !== 'UTC') {\n+            options.push({ value: SparklineTimezone.Project, label: `Project (${projectTzLabel})` })\n+        }\n+\n+        if (deviceTimezone && deviceTimezone !== 'UTC' && deviceTimezone !== projectTzLabel) {\n+            options.push({ value: SparklineTimezone.Device, label: `Device (${deviceTimezone})` })\n+        }\n+\n+        return options\n+    }, [projectTimezone, deviceTimezone])\n+\n+    const showTimezoneSelector = timezoneOptions.length > 1\n+\n+    const { timeUnit, tickFormat } = useMemo(() => {\n+        if (!sparklineData.dates.length) {\n+            return { timeUnit: 'hour' as const, tickFormat: 'HH:mm:ss' }\n+        }\n+        const firstDate = dayjs(sparklineData.dates[0])\n+        const lastDate = dayjs(sparklineData.dates[sparklineData.dates.length - 1])\n+        const hoursDiff = lastDate.diff(firstDate, 'hours')\n+\n+        if (hoursDiff <= 1) {\n+            return { timeUnit: 'second' as const, tickFormat: 'HH:mm:ss' }\n+        } else if (hoursDiff <= 6) {\n+            return { timeUnit: 'minute' as const, tickFormat: 'HH:mm:ss' }\n+        } else if (hoursDiff <= 48) {\n+            return { timeUnit: 'hour' as const, tickFormat: 'HH:mm' }\n+        }\n+        return { timeUnit: 'day' as const, tickFormat: 'D MMM HH:mm' }\n+    }, [sparklineData.dates])\n+\n+    const withXScale = useCallback(\n+        (scale: AnyScaleOptions): AnyScaleOptions => {\n+            return {\n+                ...scale,\n+                type: 'timeseries',\n+                ticks: {\n+                    display: true,\n+                    maxRotation: 0,\n+                    maxTicksLimit: 6,\n+                    font: {\n+                        size: 10,\n+                        lineHeight: 1,\n+                    },\n+                    callback: function (value: string | number) {\n+                        const d = activeTimezone ? dayjs(value).tz(activeTimezone) : dayjs(value)\n+                        return d.format(tickFormat)\n+                    },\n+                },\n+                time: {\n+                    unit: timeUnit,\n+                },\n+            } as AnyScaleOptions\n+        },\n+        [timeUnit, tickFormat, activeTimezone]\n+    )\n+\n+    const renderLabel = useCallback(\n+        (label: string): string => {\n+            const d = activeTimezone ? dayjs(label).tz(activeTimezone) : dayjs(label)\n+            const tz = activeTimezone === 'UTC' ? 'UTC' : (shortTimeZone(activeTimezone, d.toDate()) ?? 'Local')\n+            return `${d.format('D MMM YYYY HH:mm:ss')} ${tz}`\n+        },\n+        [activeTimezone]\n+    )\n+\n+    const sparklineLabels = useMemo(() => {\n+        return sparklineData.dates.map((date) => dayjs(date).toISOString())\n+    }, [sparklineData.dates])\n+\n+    const onSelectionChange = useCallback(\n+        (selection: { startIndex: number; endIndex: number }): void => {\n+            setDateRangeFromSparkline(selection.startIndex, selection.endIndex)\n+        },\n+        [setDateRangeFromSparkline]\n+    )\n+\n+    return (\n+        <div className=\"relative h-40 flex flex-col\">\n+            {showTimezoneSelector && (\n+                <div className=\"absolute top-1 right-1 z-10\">\n+                    <LemonSelect\n+                        size=\"xsmall\"\n+                        value={sparklineTimezone}\n+                        onChange={(value) => value && setSparklineTimezone(value)}\n+                        options={timezoneOptions}\n+                    />\n+                </div>\n+            )}\n+            {sparklineData.data.length > 0 ? (\n+                <Sparkline\n+                    labels={sparklineLabels}\n+                    data={sparklineData.data}\n+                    className=\"w-full flex-1\"\n+                    onSelectionChange={onSelectionChange}\n+                    withXScale={withXScale}\n+                    renderLabel={renderLabel}\n+                />\n+            ) : !sparklineLoading ? (\n+                <div className=\"flex-1 text-muted flex items-center justify-center\">No results matching filters</div>\n+            ) : null}\n+            {sparklineLoading && <SpinnerOverlay />}\n+        </div>\n+    )\n+}\ndiff --git a/products/logs/frontend/logsLogic.test.ts b/products/logs/frontend/logsLogic.test.ts\nindex ff3d7aa8c9747..d8a6a00251a4a 100644\n--- a/products/logs/frontend/logsLogic.test.ts\n+++ b/products/logs/frontend/logsLogic.test.ts\n@@ -3,7 +3,7 @@ import { expectLogic } from 'kea-test-utils'\n import { LogMessage } from '~/queries/schema/schema-general'\n import { initKeaTests } from '~/test/init'\n \n-import { logsLogic } from './logsLogic'\n+import { SparklineTimezone, logsLogic } from './logsLogic'\n \n const createMockLog = (uuid: string): LogMessage => ({\n     uuid,\n@@ -194,4 +194,24 @@ describe('logsLogic', () => {\n             })\n         })\n     })\n+\n+    describe('sparklineTimezone', () => {\n+        it('updates when setSparklineTimezone is called', async () => {\n+            await expectLogic(logic, () => {\n+                logic.actions.setSparklineTimezone(SparklineTimezone.Device)\n+            })\n+                .toDispatchActions(['setSparklineTimezone'])\n+                .toMatchValues({\n+                    sparklineTimezone: SparklineTimezone.Device,\n+                })\n+\n+            await expectLogic(logic, () => {\n+                logic.actions.setSparklineTimezone(SparklineTimezone.UTC)\n+            })\n+                .toDispatchActions(['setSparklineTimezone'])\n+                .toMatchValues({\n+                    sparklineTimezone: SparklineTimezone.UTC,\n+                })\n+        })\n+    })\n })\ndiff --git a/products/logs/frontend/logsLogic.tsx b/products/logs/frontend/logsLogic.tsx\nindex 3260c948007fe..a0b377414b930 100644\n--- a/products/logs/frontend/logsLogic.tsx\n+++ b/products/logs/frontend/logsLogic.tsx\n@@ -38,6 +38,12 @@ const NEW_QUERY_STARTED_ERROR_MESSAGE = 'new query started' as const\n const DEFAULT_LIVE_TAIL_POLL_INTERVAL_MS = 1000\n const DEFAULT_LIVE_TAIL_POLL_INTERVAL_MAX_MS = 5000\n \n+export enum SparklineTimezone {\n+    UTC = 'utc',\n+    Project = 'project',\n+    Device = 'device',\n+}\n+\n const parseLogAttributes = (logs: LogMessage[]): void => {\n     logs.forEach((row) => {\n         Object.keys(row.attributes).forEach((key) => {\n@@ -257,6 +263,7 @@ export const logsLogic = kea<logsLogicType>([\n         expireLiveTail: () => true,\n         setLiveTailExpired: (liveTailExpired: boolean) => ({ liveTailExpired }),\n         addLogsToSparkline: (logs: LogMessage[]) => logs,\n+        setSparklineTimezone: (sparklineTimezone: SparklineTimezone) => ({ sparklineTimezone }),\n     }),\n \n     reducers({\n@@ -408,6 +415,13 @@ export const logsLogic = kea<logsLogicType>([\n                 runQuery: () => false,\n             },\n         ],\n+        sparklineTimezone: [\n+            SparklineTimezone.UTC as SparklineTimezone,\n+            { persist: true },\n+            {\n+                setSparklineTimezone: (_, { sparklineTimezone }) => sparklineTimezone,\n+            },\n+        ],\n         liveTailPollInterval: [\n             DEFAULT_LIVE_TAIL_POLL_INTERVAL_MS as number,\n             {\n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/PostHog__posthog.main/pr_mirror/PostHog__posthog.main.42716/metadata__pr_42716.json"
  },
  {
    "instance_id": "PostHog__posthog.main.42729",
    "repo": "PostHog/posthog",
    "pull_number": 42729,
    "base_commit": "7e9060facaf104f63f506ff0ef5480d5704ea615",
    "patch": "diff --git a/frontend/src/scenes/session-recordings/player/rrweb/index.test.ts b/frontend/src/scenes/session-recordings/player/rrweb/index.test.ts\nindex d24ed895f3be4..c71605038780d 100644\n--- a/frontend/src/scenes/session-recordings/player/rrweb/index.test.ts\n+++ b/frontend/src/scenes/session-recordings/player/rrweb/index.test.ts\n@@ -33,30 +33,6 @@ describe('CorsPlugin', () => {\n         CorsPlugin.onBuild?.(el, { id: 1, replayer: null as unknown as any })\n         expect(el.href).toEqual(`https://replay.ph-proxy.com/proxy?url=https://app.posthog.com/my-image.js`)\n     })\n-\n-    it('can replace a stylesheet css link', () => {\n-        const el = document.createElement('link')\n-        el.setAttribute('rel', 'stylesheet')\n-        el.href = 'https://app.posthog.com/assets/styles.css'\n-        CorsPlugin.onBuild?.(el, { id: 1, replayer: null as unknown as any })\n-        expect(el.href).toEqual(`https://replay.ph-proxy.com/proxy?url=https://app.posthog.com/assets/styles.css`)\n-    })\n-\n-    it('can replace a stylesheet css link with query parameters', () => {\n-        const el = document.createElement('link')\n-        el.setAttribute('rel', 'stylesheet')\n-        el.href = 'https://app.posthog.com/assets/styles.css?v=123'\n-        CorsPlugin.onBuild?.(el, { id: 1, replayer: null as unknown as any })\n-        expect(el.href).toEqual(`https://replay.ph-proxy.com/proxy?url=https://app.posthog.com/assets/styles.css?v=123`)\n-    })\n-\n-    it.each([\n-        'https://app.posthog.com/styles.css',\n-        'https://app.posthog.com/styles.css?v=123',\n-        'https://app.posthog.com/assets/main.css?t=1234567890',\n-    ])('should replace CSS urls', (cssUrl) => {\n-        expect(CorsPlugin._replaceCSSUrl(cssUrl)).toEqual(`https://replay.ph-proxy.com/proxy?url=${cssUrl}`)\n-    })\n })\n \n describe('WindowTitlePlugin', () => {\ndiff --git a/frontend/src/scenes/session-recordings/player/rrweb/index.ts b/frontend/src/scenes/session-recordings/player/rrweb/index.ts\nindex 8dd021ca88428..ee36a8be2ea11 100644\n--- a/frontend/src/scenes/session-recordings/player/rrweb/index.ts\n+++ b/frontend/src/scenes/session-recordings/player/rrweb/index.ts\n@@ -12,7 +12,6 @@ export const CorsPlugin: ReplayPlugin & {\n     _replaceFontCssUrls: (value: string | null) => string | null\n     _replaceFontUrl: (value: string) => string\n     _replaceJSUrl: (value: string) => string\n-    _replaceCSSUrl: (value: string) => string\n } = {\n     _replaceFontCssUrls: (value: string | null): string | null => {\n         return (\n@@ -31,10 +30,6 @@ export const CorsPlugin: ReplayPlugin & {\n         return value.replace(/^(https:\\/\\/\\S*(?:\\.js)\\S*)$/i, `${PROXY_URL}/proxy?url=$1`)\n     },\n \n-    _replaceCSSUrl: (value: string): string => {\n-        return value.replace(/^(https:\\/\\/\\S*(?:\\.css)\\S*)$/i, `${PROXY_URL}/proxy?url=$1`)\n-    },\n-\n     onBuild: (node) => {\n         if (node.nodeName === 'STYLE') {\n             const styleElement = node as HTMLStyleElement\n@@ -60,11 +55,8 @@ export const CorsPlugin: ReplayPlugin & {\n             if (!href) {\n                 return\n             }\n-            const rel = linkElement.getAttribute('rel')\n-            if (rel === 'modulepreload') {\n+            if (linkElement.getAttribute('rel') == 'modulepreload') {\n                 linkElement.href = CorsPlugin._replaceJSUrl(href)\n-            } else if (rel === 'stylesheet') {\n-                linkElement.href = CorsPlugin._replaceCSSUrl(href)\n             } else {\n                 linkElement.href = CorsPlugin._replaceFontUrl(href)\n             }\n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/PostHog__posthog.main/pr_mirror/PostHog__posthog.main.42729/metadata__pr_42729.json"
  },
  {
    "instance_id": "PostHog__posthog.main.42570",
    "repo": "PostHog/posthog",
    "pull_number": 42570,
    "base_commit": "1eef58d5b1a249b5cb594431065fa5590cbff5b0",
    "patch": "diff --git a/plugin-server/src/worker/ingestion/persons/batch-writing-person-store.test.ts b/plugin-server/src/worker/ingestion/persons/batch-writing-person-store.test.ts\nindex c4e46a8913bff..8d7f96b85fdd0 100644\n--- a/plugin-server/src/worker/ingestion/persons/batch-writing-person-store.test.ts\n+++ b/plugin-server/src/worker/ingestion/persons/batch-writing-person-store.test.ts\n@@ -1557,15 +1557,16 @@ describe('BatchWritingPersonStore', () => {\n             typeof personPropertyKeyUpdateCounter\n         >\n \n-        it('should skip database write when only eventToPersonProperties are updated', async () => {\n+        it('should skip database write when only filtered properties are updated', async () => {\n             const mockRepo = createMockRepository()\n             const testPersonStore = new BatchWritingPersonsStore(mockRepo, db.kafkaProducer)\n             const personStoreForBatch = testPersonStore.forBatch() as BatchWritingPersonsStoreForBatch\n \n             // Update person with only filtered properties (existing properties being updated)\n+            // Using $current_url and $pathname which are in FILTERED_PERSON_UPDATE_PROPERTIES\n             await personStoreForBatch.updatePersonWithPropertiesDiffForUpdate(\n-                { ...person, properties: { $browser: 'Firefox', $app_build: '100' } },\n-                { $browser: 'Chrome', $app_build: '200' },\n+                { ...person, properties: { $current_url: 'https://old.com', $pathname: '/old' } },\n+                { $current_url: 'https://new.com', $pathname: '/new' },\n                 [],\n                 {},\n                 'test'\n@@ -1585,10 +1586,10 @@ describe('BatchWritingPersonStore', () => {\n             )\n             expect(mockPersonProfileBatchIgnoredPropertiesCounter.labels).toHaveBeenCalledTimes(2)\n             expect(mockPersonProfileBatchIgnoredPropertiesCounter.labels).toHaveBeenCalledWith({\n-                property: '$browser',\n+                property: '$current_url',\n             })\n             expect(mockPersonProfileBatchIgnoredPropertiesCounter.labels).toHaveBeenCalledWith({\n-                property: '$app_build',\n+                property: '$pathname',\n             })\n             // personPropertyKeyUpdateCounter should NOT be called for 'ignored' outcomes\n             expect(mockPersonPropertyKeyUpdateCounter.labels).not.toHaveBeenCalled()\n@@ -1744,9 +1745,10 @@ describe('BatchWritingPersonStore', () => {\n             const personStoreForBatch = testPersonStore.forBatch() as BatchWritingPersonsStoreForBatch\n \n             // Update person with only filtered properties but with force_update=true (simulating $identify/$set events)\n+            // Using $current_url and $pathname which are in FILTERED_PERSON_UPDATE_PROPERTIES\n             await personStoreForBatch.updatePersonWithPropertiesDiffForUpdate(\n-                { ...person, properties: { $browser: 'Firefox', $app_build: '100' } },\n-                { $browser: 'Chrome', $app_build: '200' },\n+                { ...person, properties: { $current_url: 'https://old.com', $pathname: '/old' } },\n+                { $current_url: 'https://new.com', $pathname: '/new' },\n                 [],\n                 {},\n                 'test',\n@@ -1768,8 +1770,8 @@ describe('BatchWritingPersonStore', () => {\n             expect(mockPersonProfileBatchIgnoredPropertiesCounter.labels).not.toHaveBeenCalled()\n             // personPropertyKeyUpdateCounter should be called for the updated properties\n             expect(mockPersonPropertyKeyUpdateCounter.labels).toHaveBeenCalledTimes(2)\n-            expect(mockPersonPropertyKeyUpdateCounter.labels).toHaveBeenCalledWith({ key: '$browser' })\n-            expect(mockPersonPropertyKeyUpdateCounter.labels).toHaveBeenCalledWith({ key: '$app_build' })\n+            expect(mockPersonPropertyKeyUpdateCounter.labels).toHaveBeenCalledWith({ key: '$current_url' })\n+            expect(mockPersonPropertyKeyUpdateCounter.labels).toHaveBeenCalledWith({ key: '$pathname' })\n         })\n \n         it('integration: multiple events with only filtered properties should not trigger database write', async () => {\n@@ -1777,28 +1779,29 @@ describe('BatchWritingPersonStore', () => {\n             const testPersonStore = new BatchWritingPersonsStore(mockRepo, db.kafkaProducer)\n             const personStoreForBatch = testPersonStore.forBatch() as BatchWritingPersonsStoreForBatch\n \n+            // Using properties that are in FILTERED_PERSON_UPDATE_PROPERTIES\n             const personWithFiltered = {\n                 ...person,\n                 properties: {\n-                    $browser: 'Firefox',\n-                    $app_build: '100',\n+                    $current_url: 'https://old.com',\n+                    $pathname: '/old',\n                     $geoip_latitude: 40.7128,\n                 },\n             }\n \n-            // Event 1: Update browser\n+            // Event 1: Update current_url (filtered)\n             await personStoreForBatch.updatePersonWithPropertiesDiffForUpdate(\n                 personWithFiltered,\n-                { $browser: 'Chrome' },\n+                { $current_url: 'https://new.com' },\n                 [],\n                 {},\n                 'test'\n             )\n \n-            // Event 2: Update app build\n+            // Event 2: Update pathname (filtered)\n             await personStoreForBatch.updatePersonWithPropertiesDiffForUpdate(\n                 personWithFiltered,\n-                { $app_build: '200' },\n+                { $pathname: '/new' },\n                 [],\n                 {},\n                 'test'\n@@ -1827,10 +1830,10 @@ describe('BatchWritingPersonStore', () => {\n             )\n             expect(mockPersonProfileBatchIgnoredPropertiesCounter.labels).toHaveBeenCalledTimes(3)\n             expect(mockPersonProfileBatchIgnoredPropertiesCounter.labels).toHaveBeenCalledWith({\n-                property: '$browser',\n+                property: '$current_url',\n             })\n             expect(mockPersonProfileBatchIgnoredPropertiesCounter.labels).toHaveBeenCalledWith({\n-                property: '$app_build',\n+                property: '$pathname',\n             })\n             expect(mockPersonProfileBatchIgnoredPropertiesCounter.labels).toHaveBeenCalledWith({\n                 property: '$geoip_latitude',\n@@ -2098,18 +2101,19 @@ describe('BatchWritingPersonStore', () => {\n             const testPersonStore = new BatchWritingPersonsStore(mockRepo, db.kafkaProducer)\n             const personStoreForBatch = testPersonStore.forBatch() as BatchWritingPersonsStoreForBatch\n \n+            // Using properties that are in FILTERED_PERSON_UPDATE_PROPERTIES\n             const personWithFiltered = {\n                 ...person,\n                 properties: {\n-                    $browser: 'Firefox',\n-                    $app_build: '100',\n+                    $current_url: 'https://old.com',\n+                    $pathname: '/old',\n                 },\n             }\n \n             // Event 1: Normal event with filtered properties\n             await personStoreForBatch.updatePersonWithPropertiesDiffForUpdate(\n                 personWithFiltered,\n-                { $browser: 'Chrome' },\n+                { $current_url: 'https://new.com' },\n                 [],\n                 {},\n                 'test'\n@@ -2119,7 +2123,7 @@ describe('BatchWritingPersonStore', () => {\n             // Event 2: Another normal event with filtered properties\n             await personStoreForBatch.updatePersonWithPropertiesDiffForUpdate(\n                 personWithFiltered,\n-                { $app_build: '200' },\n+                { $pathname: '/new' },\n                 [],\n                 {},\n                 'test'\n@@ -2129,7 +2133,7 @@ describe('BatchWritingPersonStore', () => {\n             // Event 3: Yet another normal event with filtered properties\n             await personStoreForBatch.updatePersonWithPropertiesDiffForUpdate(\n                 personWithFiltered,\n-                { $browser: 'Safari' },\n+                { $current_url: 'https://another.com' },\n                 [],\n                 {},\n                 'test'\n@@ -2151,10 +2155,10 @@ describe('BatchWritingPersonStore', () => {\n             // Properties should be marked as ignored\n             expect(mockPersonProfileBatchIgnoredPropertiesCounter.labels).toHaveBeenCalledTimes(2)\n             expect(mockPersonProfileBatchIgnoredPropertiesCounter.labels).toHaveBeenCalledWith({\n-                property: '$browser',\n+                property: '$current_url',\n             })\n             expect(mockPersonProfileBatchIgnoredPropertiesCounter.labels).toHaveBeenCalledWith({\n-                property: '$app_build',\n+                property: '$pathname',\n             })\n             // personPropertyKeyUpdateCounter should NOT be called for 'ignored' outcomes\n             expect(mockPersonPropertyKeyUpdateCounter.labels).not.toHaveBeenCalled()\ndiff --git a/plugin-server/src/worker/ingestion/persons/batch-writing-person-store.ts b/plugin-server/src/worker/ingestion/persons/batch-writing-person-store.ts\nindex 950dcc22aee0a..958f258fff405 100644\n--- a/plugin-server/src/worker/ingestion/persons/batch-writing-person-store.ts\n+++ b/plugin-server/src/worker/ingestion/persons/batch-writing-person-store.ts\n@@ -36,7 +36,8 @@ import {\n     personWriteMethodAttemptCounter,\n     totalPersonUpdateLatencyPerBatchHistogram,\n } from './metrics'\n-import { getMetricKey, isFilteredPersonPropertyKey } from './person-update'\n+import { isFilteredPersonUpdateProperty } from './person-property-utils'\n+import { getMetricKey } from './person-update'\n import { PersonUpdate, fromInternalPerson, toInternalPerson } from './person-update-batch'\n import { PersonsStore } from './persons-store'\n import { FlushResult, PersonsStoreForBatch } from './persons-store-for-batch'\n@@ -206,7 +207,7 @@ export class BatchWritingPersonsStoreForBatch implements PersonsStoreForBatch, B\n                 return true\n             }\n \n-            const isFiltered = isFilteredPersonPropertyKey(key)\n+            const isFiltered = isFilteredPersonUpdateProperty(key)\n             if (isFiltered) {\n                 ignoredProperties.push(key)\n                 return false\ndiff --git a/plugin-server/src/worker/ingestion/persons/person-property-utils.ts b/plugin-server/src/worker/ingestion/persons/person-property-utils.ts\nindex dfbdf3f1cf54c..b576133eeeed5 100644\n--- a/plugin-server/src/worker/ingestion/persons/person-property-utils.ts\n+++ b/plugin-server/src/worker/ingestion/persons/person-property-utils.ts\n@@ -143,3 +143,68 @@ export const initialCampaignParams = new Set(\n export const initialEventToPersonProperties = new Set(\n     Array.from(eventToPersonProperties, (key) => `$initial_${key.replace('$', '')}`)\n )\n+\n+/**\n+ * Properties that should NOT trigger a person update on their own.\n+ * These change frequently but aren't valuable enough to update the person record for.\n+ * They will still be included in the person properties when an update happens for other reasons.\n+ *\n+ * This is the single source of truth for person update filtering logic.\n+ *\n+ * Note: Properties NOT in this list will trigger updates by default.\n+ *\n+ * GeoIP properties source: posthog/geoip.py and posthog/taxonomy/taxonomy.py\n+ * GeoIP properties that DO trigger updates (not listed here): $geoip_country_name, $geoip_city_name\n+ */\n+export const FILTERED_PERSON_UPDATE_PROPERTIES = new Set([\n+    // URL/navigation properties - change on every page view\n+    '$current_url',\n+    '$pathname',\n+    '$referring_domain',\n+    '$referrer',\n+\n+    // Screen/viewport dimensions - can change on window resize\n+    '$screen_height',\n+    '$screen_width',\n+    '$viewport_height',\n+    '$viewport_width',\n+\n+    // Browser/device properties - change less frequently but still filtered\n+    '$browser',\n+    '$browser_version',\n+    '$device_type',\n+    '$raw_user_agent',\n+    '$os',\n+    '$os_name',\n+    '$os_version',\n+\n+    // GeoIP properties - filtered because they change frequently\n+    '$geoip_postal_code',\n+    '$geoip_time_zone',\n+    '$geoip_latitude',\n+    '$geoip_longitude',\n+    '$geoip_accuracy_radius',\n+    '$geoip_subdivision_1_code',\n+    '$geoip_subdivision_1_name',\n+    '$geoip_subdivision_2_code',\n+    '$geoip_subdivision_2_name',\n+    '$geoip_subdivision_3_code',\n+    '$geoip_subdivision_3_name',\n+    '$geoip_city_confidence',\n+    '$geoip_country_confidence',\n+    '$geoip_postal_code_confidence',\n+    '$geoip_subdivision_1_confidence',\n+    '$geoip_subdivision_2_confidence',\n+])\n+\n+/**\n+ * Determines if a property key should be filtered out from triggering person updates.\n+ * These are properties that change frequently but aren't valuable enough to update the person record for.\n+ *\n+ * This is the single source of truth for property filtering logic, used by both:\n+ * - Event-level processing (computeEventPropertyUpdates in person-update.ts)\n+ * - Batch-level processing (getPersonUpdateOutcome in batch-writing-person-store.ts)\n+ */\n+export function isFilteredPersonUpdateProperty(key: string): boolean {\n+    return FILTERED_PERSON_UPDATE_PROPERTIES.has(key)\n+}\ndiff --git a/plugin-server/src/worker/ingestion/persons/person-update.test.ts b/plugin-server/src/worker/ingestion/persons/person-update.test.ts\nindex c55c6e1cd95e3..9790636a47bf7 100644\n--- a/plugin-server/src/worker/ingestion/persons/person-update.test.ts\n+++ b/plugin-server/src/worker/ingestion/persons/person-update.test.ts\n@@ -1,7 +1,7 @@\n import { PluginEvent } from '@posthog/plugin-scaffold'\n \n import { personProfileIgnoredPropertiesCounter, personProfileUpdateOutcomeCounter } from './metrics'\n-import { eventToPersonProperties } from './person-property-utils'\n+import { FILTERED_PERSON_UPDATE_PROPERTIES } from './person-property-utils'\n import { applyEventPropertyUpdates, computeEventPropertyUpdates } from './person-update'\n \n jest.mock('./metrics', () => ({\n@@ -123,9 +123,9 @@ describe('person-update', () => {\n             })\n         })\n \n-        describe('eventToPersonProperties accepted at event level', () => {\n-            it.each(Array.from(eventToPersonProperties))(\n-                'should accept \"%s\" updates at event level (filtering happens at batch level)',\n+        describe('filtered properties behavior', () => {\n+            it.each(Array.from(FILTERED_PERSON_UPDATE_PROPERTIES))(\n+                'should mark \"%s\" as ignored when updated',\n                 (propertyName) => {\n                     const event: PluginEvent = {\n                         event: 'pageview',\n@@ -141,8 +141,7 @@ describe('person-update', () => {\n                     expect(result.hasChanges).toBe(true)\n                     expect(result.toSet).toEqual({ [propertyName]: 'new_value' })\n                     expect(result.shouldForceUpdate).toBe(false)\n-                    // At event level, this property would be marked as ignored (outcome: 'ignored')\n-                    // but it's still included in toSet for batch-level filtering\n+                    // Filtered properties are marked as ignored\n                     expect(mockPersonProfileUpdateOutcomeCounter.labels).toHaveBeenCalledWith({ outcome: 'ignored' })\n                     expect(mockPersonProfileUpdateOutcomeCounter.labels({ outcome: 'ignored' }).inc).toHaveBeenCalled()\n                     expect(mockPersonProfileIgnoredPropertiesCounter.labels).toHaveBeenCalledWith({\n@@ -250,54 +249,54 @@ describe('person-update', () => {\n                 expect(mockPersonProfileUpdateOutcomeCounter.labels).toHaveBeenCalledWith({ outcome: 'changed' })\n             })\n \n-            it('should accept eventToPersonProperties even when mixed with unchanged custom properties', () => {\n+            it('should accept filtered properties even when mixed with unchanged custom properties', () => {\n                 const event: PluginEvent = {\n                     event: 'pageview',\n                     properties: {\n-                        $set: { $browser: 'Chrome', custom_prop: 'same_value' },\n+                        $set: { $current_url: 'https://example.com/new', custom_prop: 'same_value' },\n                     },\n                 } as any\n \n-                const personProperties = { $browser: 'Firefox', custom_prop: 'same_value' }\n+                const personProperties = { $current_url: 'https://example.com/old', custom_prop: 'same_value' }\n \n                 const result = computeEventPropertyUpdates(event, personProperties)\n \n                 expect(result.hasChanges).toBe(true)\n-                expect(result.toSet).toEqual({ $browser: 'Chrome' })\n+                expect(result.toSet).toEqual({ $current_url: 'https://example.com/new' })\n                 expect(result.shouldForceUpdate).toBe(false)\n-                // At event level, $browser would be marked as ignored\n+                // $current_url is filtered, so it should be marked as ignored\n                 expect(mockPersonProfileUpdateOutcomeCounter.labels).toHaveBeenCalledWith({ outcome: 'ignored' })\n                 expect(mockPersonProfileIgnoredPropertiesCounter.labels).toHaveBeenCalledWith({\n-                    property: '$browser',\n+                    property: '$current_url',\n                 })\n             })\n \n-            it('should accept multiple eventToPersonProperties at event level', () => {\n-                // Note: Campaign properties (utm_source, utm_campaign) are no longer in eventToPersonProperties\n-                // and will trigger updates like custom properties\n+            it('should accept multiple filtered properties at event level', () => {\n                 const event: PluginEvent = {\n                     event: 'pageview',\n                     properties: {\n                         $set: {\n-                            $browser: 'Chrome',\n-                            $os: 'macOS',\n+                            $current_url: 'https://example.com/new',\n+                            $pathname: '/new-path',\n                         },\n                     },\n                 } as any\n \n                 const personProperties = {\n-                    $browser: 'Firefox',\n-                    $os: 'Windows',\n+                    $current_url: 'https://example.com/old',\n+                    $pathname: '/old-path',\n                 }\n \n                 const result = computeEventPropertyUpdates(event, personProperties)\n \n                 expect(result.hasChanges).toBe(true)\n                 expect(result.shouldForceUpdate).toBe(false)\n-                // At event level, eventToPersonProperties would be marked as ignored\n+                // Filtered properties should be marked as ignored\n                 expect(mockPersonProfileUpdateOutcomeCounter.labels).toHaveBeenCalledWith({ outcome: 'ignored' })\n-                expect(mockPersonProfileIgnoredPropertiesCounter.labels).toHaveBeenCalledWith({ property: '$browser' })\n-                expect(mockPersonProfileIgnoredPropertiesCounter.labels).toHaveBeenCalledWith({ property: '$os' })\n+                expect(mockPersonProfileIgnoredPropertiesCounter.labels).toHaveBeenCalledWith({\n+                    property: '$current_url',\n+                })\n+                expect(mockPersonProfileIgnoredPropertiesCounter.labels).toHaveBeenCalledWith({ property: '$pathname' })\n             })\n         })\n \n@@ -376,7 +375,7 @@ describe('person-update', () => {\n         })\n \n         describe('person events behavior', () => {\n-            it('should compute updates for eventToPersonProperties on $identify events', () => {\n+            it('should compute updates for any property on $identify events', () => {\n                 const event: PluginEvent = {\n                     event: '$identify',\n                     properties: {\n@@ -394,7 +393,7 @@ describe('person-update', () => {\n                 expect(mockPersonProfileUpdateOutcomeCounter.labels).toHaveBeenCalledWith({ outcome: 'changed' })\n             })\n \n-            it('should compute updates for eventToPersonProperties on $set events', () => {\n+            it('should compute updates for any property on $set events', () => {\n                 const event: PluginEvent = {\n                     event: '$set',\n                     properties: {\n@@ -466,7 +465,7 @@ describe('person-update', () => {\n         })\n \n         describe('mixed scenarios', () => {\n-            it('should compute updates when both custom and eventToPersonProperties change', () => {\n+            it('should compute updates when both custom and allowed properties change', () => {\n                 const event: PluginEvent = {\n                     event: 'pageview',\n                     properties: {\n@@ -486,8 +485,8 @@ describe('person-update', () => {\n         })\n \n         describe('updateAllProperties flag enabled', () => {\n-            it.each(Array.from(eventToPersonProperties))(\n-                'should trigger update for \"%s\" when updateAllProperties is true',\n+            it.each(Array.from(FILTERED_PERSON_UPDATE_PROPERTIES))(\n+                'should trigger update for filtered property \"%s\" when updateAllProperties is true',\n                 (propertyName) => {\n                     const event: PluginEvent = {\n                         event: 'pageview',\n@@ -529,7 +528,7 @@ describe('person-update', () => {\n                 expect(mockPersonProfileIgnoredPropertiesCounter.labels).not.toHaveBeenCalled()\n             })\n \n-            it('should trigger update for multiple eventToPersonProperties when updateAllProperties is true', () => {\n+            it('should trigger update for multiple allowed properties when updateAllProperties is true', () => {\n                 const event: PluginEvent = {\n                     event: 'pageview',\n                     properties: {\n@@ -555,7 +554,7 @@ describe('person-update', () => {\n                 expect(mockPersonProfileIgnoredPropertiesCounter.labels).not.toHaveBeenCalled()\n             })\n \n-            it('should trigger update for mixed eventToPersonProperties and custom properties when updateAllProperties is true', () => {\n+            it('should trigger update for mixed allowed and custom properties when updateAllProperties is true', () => {\n                 const event: PluginEvent = {\n                     event: 'pageview',\n                     properties: {\n@@ -575,7 +574,7 @@ describe('person-update', () => {\n                 expect(mockPersonProfileIgnoredPropertiesCounter.labels).not.toHaveBeenCalled()\n             })\n \n-            it('should trigger update for mixed $geoip_* and eventToPersonProperties when updateAllProperties is true', () => {\n+            it('should trigger update for mixed $geoip_* and allowed properties when updateAllProperties is true', () => {\n                 const event: PluginEvent = {\n                     event: 'pageview',\n                     properties: {\ndiff --git a/plugin-server/src/worker/ingestion/persons/person-update.ts b/plugin-server/src/worker/ingestion/persons/person-update.ts\nindex 9b40787ff1928..1b2ebca4071e2 100644\n--- a/plugin-server/src/worker/ingestion/persons/person-update.ts\n+++ b/plugin-server/src/worker/ingestion/persons/person-update.ts\n@@ -5,7 +5,11 @@ import { cloneObject } from '~/utils/utils'\n import { InternalPerson } from '../../../types'\n import { logger } from '../../../utils/logger'\n import { personProfileIgnoredPropertiesCounter, personProfileUpdateOutcomeCounter } from './metrics'\n-import { eventToPersonProperties, initialEventToPersonProperties } from './person-property-utils'\n+import {\n+    eventToPersonProperties,\n+    initialEventToPersonProperties,\n+    isFilteredPersonUpdateProperty,\n+} from './person-property-utils'\n \n export interface PropertyUpdates {\n     toSet: Properties\n@@ -19,10 +23,6 @@ export interface PropertyUpdates {\n const NO_PERSON_UPDATE_EVENTS = new Set(['$exception', '$$heatmap'])\n const PERSON_EVENTS = new Set(['$identify', '$create_alias', '$merge_dangerously', '$set'])\n \n-// GeoIP properties that should still trigger person updates even when other geoip properties are blocked\n-// These are commonly used for segmentation and are worth keeping up-to-date\n-const ALLOWED_GEOIP_PROPERTIES = new Set(['$geoip_country_name', '$geoip_city_name'])\n-\n // For tracking what property keys cause us to update persons\n // tracking all properties we add from the event, 'geoip' for '$geoip_*' or '$initial_geoip_*' and 'other' for anything outside of those\n export function getMetricKey(key: string): string {\n@@ -173,27 +173,6 @@ export function applyEventPropertyUpdates(\n     return [updatedPerson, updated]\n }\n \n-/**\n- * Determines if a property key should be filtered out from triggering person updates.\n- * These are properties that change frequently but aren't valuable enough to update the person record for.\n- *\n- * This is the single source of truth for property filtering logic, used by both:\n- * - Event-level processing (computeEventPropertyUpdates)\n- * - Batch-level processing (getPersonUpdateOutcome in batch-writing-person-store)\n- */\n-export function isFilteredPersonPropertyKey(key: string): boolean {\n-    // These are properties we add from the event and some change often, it's useless to update person always\n-    if (eventToPersonProperties.has(key)) {\n-        return true\n-    }\n-    // same as above, coming from GeoIP plugin\n-    // but allow country and city updates as they're commonly used for segmentation\n-    if (key.startsWith('$geoip_')) {\n-        return !ALLOWED_GEOIP_PROPERTIES.has(key)\n-    }\n-    return false\n-}\n-\n // Minimize useless person updates by not overriding properties if it's not a person event and we added from the event\n // They will still show up for PoE as it's not removed from the event, we just don't update the person in PG anymore\n function shouldUpdatePersonIfOnlyChange(event: PluginEvent, key: string, updateAllProperties: boolean): boolean {\n@@ -205,5 +184,5 @@ function shouldUpdatePersonIfOnlyChange(event: PluginEvent, key: string, updateA\n         // for person events always update everything\n         return true\n     }\n-    return !isFilteredPersonPropertyKey(key)\n+    return !isFilteredPersonUpdateProperty(key)\n }\n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/PostHog__posthog.main/pr_mirror/PostHog__posthog.main.42570/metadata__pr_42570.json"
  },
  {
    "instance_id": "PostHog__posthog.main.42569",
    "repo": "PostHog/posthog",
    "pull_number": 42569,
    "base_commit": "ecae84a58c3a843ff35a4c105beec5b78f8ff5d9",
    "patch": "diff --git a/frontend/src/lib/components/DateFilter/DateFilter.test.tsx b/frontend/src/lib/components/DateFilter/DateFilter.test.tsx\nindex 0884e1c9243f5..b05a8b62a3e5d 100644\n--- a/frontend/src/lib/components/DateFilter/DateFilter.test.tsx\n+++ b/frontend/src/lib/components/DateFilter/DateFilter.test.tsx\n@@ -54,3 +54,40 @@ describe('DateFilter', () => {\n         await waitFor(() => expect(onChange).toHaveBeenCalledWith('-5d', '', false))\n     })\n })\n+\n+describe('DateFilter with allowFixedRangeWithTime', () => {\n+    let onChange = jest.fn()\n+    beforeEach(() => {\n+        initKeaTests()\n+        onChange = jest.fn()\n+        render(\n+            <Provider>\n+                <DateFilter onChange={onChange} dateOptions={dateMapping} allowFixedRangeWithTime />\n+            </Provider>\n+        )\n+    })\n+\n+    afterEach(() => {\n+        cleanup()\n+    })\n+\n+    it('shows custom fixed date range with time option', async () => {\n+        const dateFilter = screen.getByTestId('date-filter')\n+        userEvent.click(dateFilter)\n+\n+        expect(screen.getByText(/custom fixed date range with time/i)).toBeInTheDocument()\n+        expect(screen.getByText(/custom fixed date range\u2026$/i)).toBeInTheDocument()\n+    })\n+\n+    it('opens the time range picker when clicking custom fixed date range with time', async () => {\n+        const dateFilter = screen.getByTestId('date-filter')\n+        userEvent.click(dateFilter)\n+\n+        const timeRangeOption = screen.getByText(/custom fixed date range with time/i)\n+        userEvent.click(timeRangeOption)\n+\n+        await waitFor(() => {\n+            expect(screen.getByText(/select a date and time range/i)).toBeInTheDocument()\n+        })\n+    })\n+})\ndiff --git a/frontend/src/lib/components/DateFilter/DateFilter.tsx b/frontend/src/lib/components/DateFilter/DateFilter.tsx\nindex a9501746a48b4..5ec8dfaa2f725 100644\n--- a/frontend/src/lib/components/DateFilter/DateFilter.tsx\n+++ b/frontend/src/lib/components/DateFilter/DateFilter.tsx\n@@ -24,6 +24,7 @@ import { ResolvedDateRangeResponse } from '~/queries/schema/schema-general'\n import { DateMappingOption, PropertyOperator } from '~/types'\n \n import { PropertyFilterDatePicker } from '../PropertyFilters/components/PropertyFilterDatePicker'\n+import { FixedRangeWithTimePicker } from './FixedRangeWithTimePicker'\n import { RollingDateRangeFilter } from './RollingDateRangeFilter'\n import { dateFilterLogic } from './dateFilterLogic'\n import { DateOption } from './rollingDateRangeFilterLogic'\n@@ -54,6 +55,7 @@ interface RawDateFilterProps extends DateFilterProps {\n     max?: number | null\n     allowedRollingDateOptions?: DateOption[]\n     allowTimePrecision?: boolean\n+    allowFixedRangeWithTime?: boolean\n     /**\n      * Granularity is picked based on the dateFrom value\n      * but can be overridden to force a specific granularity.\n@@ -82,6 +84,7 @@ export function DateFilter({\n     isFixedDateMode = false,\n     allowedRollingDateOptions,\n     allowTimePrecision = false,\n+    allowFixedRangeWithTime = false,\n     placeholder,\n     fullWidth = false,\n     forceGranularity,\n@@ -105,6 +108,7 @@ export function DateFilter({\n     const {\n         open,\n         openFixedRange,\n+        openFixedRangeWithTime,\n         openDateToNow,\n         openFixedDate,\n         close,\n@@ -121,6 +125,7 @@ export function DateFilter({\n         rangeDateTo,\n         label,\n         isFixedRange,\n+        isFixedRangeWithTime,\n         isDateToNow,\n         isFixedDate,\n         isRollingDateRange,\n@@ -146,6 +151,13 @@ export function DateFilter({\n                 onClose={open}\n                 months={2}\n             />\n+        ) : view === DateFilterView.FixedRangeWithTime ? (\n+            <FixedRangeWithTimePicker\n+                rangeDateFrom={rangeDateFrom}\n+                rangeDateTo={rangeDateTo}\n+                setDate={setDate}\n+                onClose={open}\n+            />\n         ) : view === DateFilterView.DateToNow ? (\n             <LemonCalendarSelect\n                 value={rangeDateFrom ?? dayjs()}\n@@ -246,9 +258,14 @@ export function DateFilter({\n                         <LemonButton onClick={openDateToNow} active={isDateToNow} fullWidth>\n                             From custom date until now\u2026\n                         </LemonButton>\n-                        <LemonButton onClick={openFixedRange} active={isFixedRange} fullWidth>\n+                        <LemonButton onClick={openFixedRange} active={isFixedRange && !isFixedRangeWithTime} fullWidth>\n                             Custom fixed date range\u2026\n                         </LemonButton>\n+                        {allowFixedRangeWithTime && (\n+                            <LemonButton onClick={openFixedRangeWithTime} active={isFixedRangeWithTime} fullWidth>\n+                                Custom fixed date range with time\u2026\n+                            </LemonButton>\n+                        )}\n                     </>\n                 )}\n                 {showExplicitDateToggle && (\ndiff --git a/frontend/src/lib/components/DateFilter/FixedRangeWithTimePicker.test.tsx b/frontend/src/lib/components/DateFilter/FixedRangeWithTimePicker.test.tsx\nnew file mode 100644\nindex 0000000000000..891363886c69e\n--- /dev/null\n+++ b/frontend/src/lib/components/DateFilter/FixedRangeWithTimePicker.test.tsx\n@@ -0,0 +1,127 @@\n+import '@testing-library/jest-dom'\n+import { render, screen, within } from '@testing-library/react'\n+import userEvent from '@testing-library/user-event'\n+\n+import { dayjs } from 'lib/dayjs'\n+\n+import { FixedRangeWithTimePicker } from './FixedRangeWithTimePicker'\n+\n+describe('FixedRangeWithTimePicker', () => {\n+    const setDate = jest.fn()\n+    const onClose = jest.fn()\n+\n+    beforeEach(() => {\n+        jest.clearAllMocks()\n+    })\n+\n+    it('renders header', () => {\n+        render(<FixedRangeWithTimePicker rangeDateFrom={null} rangeDateTo={null} setDate={setDate} onClose={onClose} />)\n+\n+        expect(screen.getByText(/select a date and time range/i)).toBeInTheDocument()\n+    })\n+\n+    it('renders Start and End buttons', () => {\n+        render(\n+            <FixedRangeWithTimePicker\n+                rangeDateFrom={dayjs('2024-01-15T10:00:00')}\n+                rangeDateTo={dayjs('2024-01-15T11:00:00')}\n+                setDate={setDate}\n+                onClose={onClose}\n+            />\n+        )\n+\n+        expect(screen.getAllByText(/start:/i).length).toBeGreaterThan(0)\n+        expect(screen.getAllByText(/end:/i).length).toBeGreaterThan(0)\n+    })\n+\n+    it('calls onClose when close button is clicked', () => {\n+        const { container } = render(\n+            <FixedRangeWithTimePicker\n+                rangeDateFrom={dayjs('2024-01-15T10:00:00')}\n+                rangeDateTo={dayjs('2024-01-15T11:00:00')}\n+                setDate={setDate}\n+                onClose={onClose}\n+            />\n+        )\n+\n+        const closeButton = container.querySelector('[aria-label=\"close\"]') as HTMLElement\n+        expect(closeButton).toBeTruthy()\n+        userEvent.click(closeButton)\n+        expect(onClose).toHaveBeenCalled()\n+    })\n+\n+    it('calls setDate with ISO format when Apply is clicked', () => {\n+        const { container } = render(\n+            <FixedRangeWithTimePicker\n+                rangeDateFrom={dayjs('2024-01-15T10:00:00')}\n+                rangeDateTo={dayjs('2024-01-15T11:00:00')}\n+                setDate={setDate}\n+                onClose={onClose}\n+            />\n+        )\n+\n+        const footer = container.querySelector('[data-attr=\"lemon-calendar-range-with-time-footer\"]') as HTMLElement\n+        userEvent.click(within(footer).getByText(/apply/i))\n+        expect(setDate).toHaveBeenCalledWith('2024-01-15T10:00:00', '2024-01-15T11:00:00', false, true)\n+    })\n+\n+    it('swaps dates on Apply if start is after end', () => {\n+        const { container } = render(\n+            <FixedRangeWithTimePicker\n+                rangeDateFrom={dayjs('2024-01-15T14:00:00')}\n+                rangeDateTo={dayjs('2024-01-15T10:00:00')}\n+                setDate={setDate}\n+                onClose={onClose}\n+            />\n+        )\n+\n+        const footer = container.querySelector('[data-attr=\"lemon-calendar-range-with-time-footer\"]') as HTMLElement\n+        userEvent.click(within(footer).getByText(/apply/i))\n+        expect(setDate).toHaveBeenCalledWith('2024-01-15T10:00:00', '2024-01-15T14:00:00', false, true)\n+    })\n+\n+    it('preserves PM time when initialized with PM', () => {\n+        const { container } = render(\n+            <FixedRangeWithTimePicker\n+                rangeDateFrom={dayjs('2024-01-15T14:30:00')}\n+                rangeDateTo={dayjs('2024-01-15T16:00:00')}\n+                setDate={setDate}\n+                onClose={onClose}\n+            />\n+        )\n+\n+        const footer = container.querySelector('[data-attr=\"lemon-calendar-range-with-time-footer\"]') as HTMLElement\n+        userEvent.click(within(footer).getByText(/apply/i))\n+        expect(setDate).toHaveBeenCalledWith('2024-01-15T14:30:00', '2024-01-15T16:00:00', false, true)\n+    })\n+\n+    it('adjusts end time when start hour is changed to be after end', () => {\n+        const { container } = render(\n+            <FixedRangeWithTimePicker\n+                rangeDateFrom={dayjs('2024-01-15T10:00:00')}\n+                rangeDateTo={dayjs('2024-01-15T11:00:00')}\n+                setDate={setDate}\n+                onClose={onClose}\n+            />\n+        )\n+\n+        // Click on hour 12 (PM) - this should be after the end time of 11:00 AM\n+        const hourButton = container.querySelector('[data-attr=\"12-h\"]') as HTMLElement\n+        expect(hourButton).toBeTruthy()\n+        userEvent.click(hourButton)\n+\n+        // Click PM to make it 12 PM (noon)\n+        const pmButton = container.querySelector('[data-attr=\"pm-a\"]') as HTMLElement\n+        expect(pmButton).toBeTruthy()\n+        userEvent.click(pmButton)\n+\n+        // Apply and verify end was adjusted (start 12:00 PM, end should be 1:00 PM)\n+        const footer = container.querySelector('[data-attr=\"lemon-calendar-range-with-time-footer\"]') as HTMLElement\n+        userEvent.click(within(footer).getByText(/apply/i))\n+\n+        // The handleApply swaps if needed, so result should be valid\n+        expect(setDate).toHaveBeenCalled()\n+        const [from, to] = setDate.mock.calls[0]\n+        expect(dayjs(from).isBefore(dayjs(to))).toBe(true)\n+    })\n+})\ndiff --git a/frontend/src/lib/components/DateFilter/FixedRangeWithTimePicker.tsx b/frontend/src/lib/components/DateFilter/FixedRangeWithTimePicker.tsx\nnew file mode 100644\nindex 0000000000000..bb8af28af6517\n--- /dev/null\n+++ b/frontend/src/lib/components/DateFilter/FixedRangeWithTimePicker.tsx\n@@ -0,0 +1,147 @@\n+import { useState } from 'react'\n+\n+import { IconX } from '@posthog/icons'\n+import { LemonButton } from '@posthog/lemon-ui'\n+\n+import { dayjs } from 'lib/dayjs'\n+import { LemonCalendar } from 'lib/lemon-ui/LemonCalendar/LemonCalendar'\n+\n+export interface FixedRangeWithTimePickerProps {\n+    rangeDateFrom: dayjs.Dayjs | null\n+    rangeDateTo: dayjs.Dayjs | null\n+    setDate: (dateFrom: string | null, dateTo: string | null, keepPopoverOpen: boolean, explicitDate: boolean) => void\n+    onClose: () => void\n+}\n+\n+export function FixedRangeWithTimePicker({\n+    rangeDateFrom,\n+    rangeDateTo,\n+    setDate,\n+    onClose,\n+}: FixedRangeWithTimePickerProps): JSX.Element {\n+    const [selectingStart, setSelectingStart] = useState(true)\n+    const [localFrom, setLocalFrom] = useState<dayjs.Dayjs | null>(rangeDateFrom)\n+    const [localTo, setLocalTo] = useState<dayjs.Dayjs | null>(rangeDateTo)\n+\n+    const handleApply = (): void => {\n+        if (localFrom && localTo) {\n+            const [from, to] = localFrom.isBefore(localTo) ? [localFrom, localTo] : [localTo, localFrom]\n+            setDate(from.format('YYYY-MM-DDTHH:mm:ss'), to.format('YYYY-MM-DDTHH:mm:ss'), false, true)\n+        }\n+    }\n+\n+    return (\n+        <div className=\"LemonCalendarRangeWithTime\" data-attr=\"lemon-calendar-range-with-time\">\n+            <div className=\"flex justify-between border-b p-2 pb-4\">\n+                <h3 className=\"text-base mb-0\">Select a date and time range</h3>\n+                <LemonButton icon={<IconX />} size=\"small\" noPadding onClick={onClose} aria-label=\"close\" />\n+            </div>\n+            <div className=\"flex gap-2 p-2 border-b\">\n+                <LemonButton\n+                    type={selectingStart ? 'primary' : 'secondary'}\n+                    size=\"small\"\n+                    onClick={() => setSelectingStart(true)}\n+                >\n+                    Start: {localFrom ? localFrom.format('MMM D, YYYY h:mm A') : 'Not set'}\n+                </LemonButton>\n+                <LemonButton\n+                    type={!selectingStart ? 'primary' : 'secondary'}\n+                    size=\"small\"\n+                    onClick={() => setSelectingStart(false)}\n+                >\n+                    End: {localTo ? localTo.format('MMM D, YYYY h:mm A') : 'Not set'}\n+                </LemonButton>\n+            </div>\n+            <div className=\"p-2\">\n+                <LemonCalendar\n+                    onDateClick={(date) => {\n+                        if (date) {\n+                            const currentValue = selectingStart ? localFrom : localTo\n+                            const newDate = date\n+                                .hour(currentValue?.hour() ?? dayjs().hour())\n+                                .minute(currentValue?.minute() ?? dayjs().minute())\n+\n+                            if (selectingStart) {\n+                                setLocalFrom(newDate)\n+                                // Auto-set end to 1 hour later if not set or if new start is after current end\n+                                if (!localTo || newDate.isAfter(localTo)) {\n+                                    setLocalTo(newDate.add(1, 'hour'))\n+                                }\n+                            } else {\n+                                // If end date is before start, swap them\n+                                if (localFrom && newDate.isBefore(localFrom)) {\n+                                    setLocalTo(localFrom)\n+                                    setLocalFrom(newDate)\n+                                } else {\n+                                    setLocalTo(newDate)\n+                                }\n+                            }\n+                        }\n+                    }}\n+                    leftmostMonth={(selectingStart ? localFrom : localTo)?.startOf('month')}\n+                    getLemonButtonProps={({ date, props }) => {\n+                        const currentValue = selectingStart ? localFrom : localTo\n+                        if (date.isSame(currentValue, 'd')) {\n+                            return { ...props, status: 'default', type: 'primary' }\n+                        }\n+                        return props\n+                    }}\n+                    getLemonButtonTimeProps={(timeProps) => {\n+                        const currentValue = selectingStart ? localFrom : localTo\n+                        const selected = currentValue ? currentValue.format(timeProps.unit) : null\n+\n+                        return {\n+                            active: selected === String(timeProps.value),\n+                            className: 'rounded-none',\n+                            'data-attr': `${timeProps.value}-${timeProps.unit}`,\n+                            onClick: () => {\n+                                if (currentValue) {\n+                                    let newDate = currentValue\n+                                    if (timeProps.unit === 'h') {\n+                                        const isPM = currentValue.format('a') === 'pm'\n+                                        newDate = currentValue.hour(\n+                                            isPM && timeProps.value !== 12\n+                                                ? Number(timeProps.value) + 12\n+                                                : !isPM && timeProps.value === 12\n+                                                  ? 0\n+                                                  : Number(timeProps.value)\n+                                        )\n+                                    } else if (timeProps.unit === 'm') {\n+                                        newDate = currentValue.minute(Number(timeProps.value))\n+                                    } else if (timeProps.unit === 'a') {\n+                                        const currentHour = currentValue.hour()\n+                                        if (timeProps.value === 'am' && currentHour >= 12) {\n+                                            newDate = currentValue.subtract(12, 'hour')\n+                                        } else if (timeProps.value === 'pm' && currentHour < 12) {\n+                                            newDate = currentValue.add(12, 'hour')\n+                                        }\n+                                    }\n+                                    if (selectingStart) {\n+                                        setLocalFrom(newDate)\n+                                        if (localTo && newDate.isAfter(localTo)) {\n+                                            setLocalTo(newDate.add(1, 'hour'))\n+                                        }\n+                                    } else {\n+                                        setLocalTo(newDate)\n+                                        if (localFrom && newDate.isBefore(localFrom)) {\n+                                            setLocalFrom(newDate.subtract(1, 'hour'))\n+                                        }\n+                                    }\n+                                }\n+                            },\n+                        }\n+                    }}\n+                    granularity=\"minute\"\n+                />\n+            </div>\n+            <div className=\"flex justify-end gap-2 border-t p-2 pt-4\" data-attr=\"lemon-calendar-range-with-time-footer\">\n+                <LemonButton type=\"secondary\" onClick={onClose}>\n+                    Cancel\n+                </LemonButton>\n+                <LemonButton type=\"primary\" disabled={!localFrom || !localTo} onClick={handleApply}>\n+                    Apply\n+                </LemonButton>\n+            </div>\n+        </div>\n+    )\n+}\ndiff --git a/frontend/src/lib/components/DateFilter/dateFilterLogic.test.ts b/frontend/src/lib/components/DateFilter/dateFilterLogic.test.ts\nindex 97341a08aaeaa..dd811b8985856 100644\n--- a/frontend/src/lib/components/DateFilter/dateFilterLogic.test.ts\n+++ b/frontend/src/lib/components/DateFilter/dateFilterLogic.test.ts\n@@ -41,6 +41,11 @@ describe('dateFilterLogic', () => {\n             isVisible: true,\n             view: DateFilterView.FixedRange,\n         })\n+        logic.actions.openFixedRangeWithTime()\n+        await expectLogic(logic).toMatchValues({\n+            isVisible: true,\n+            view: DateFilterView.FixedRangeWithTime,\n+        })\n         logic.actions.openDateToNow()\n         await expectLogic(logic).toMatchValues({\n             isVisible: true,\n@@ -53,6 +58,86 @@ describe('dateFilterLogic', () => {\n         })\n     })\n \n+    it('isFixedRangeWithTime is true when both dates have time precision', async () => {\n+        props = {\n+            key: 'test-time-precision',\n+            onChange,\n+            dateFrom: '2024-01-15T10:30:00',\n+            dateTo: '2024-01-16T14:45:00',\n+            dateOptions: dateMapping,\n+            isDateFormatted: false,\n+        }\n+        const withTimePrecision = dateFilterLogic(props)\n+        withTimePrecision.mount()\n+\n+        await expectLogic(withTimePrecision).toMatchValues({\n+            isFixedRange: true,\n+            isFixedRangeWithTime: true,\n+            dateFromHasTimePrecision: true,\n+            dateToHasTimePrecision: true,\n+        })\n+    })\n+\n+    it('isFixedRangeWithTime is false when dates have no time precision', async () => {\n+        props = {\n+            key: 'test-no-time-precision',\n+            onChange,\n+            dateFrom: '2024-01-15',\n+            dateTo: '2024-01-16',\n+            dateOptions: dateMapping,\n+            isDateFormatted: false,\n+        }\n+        const withoutTimePrecision = dateFilterLogic(props)\n+        withoutTimePrecision.mount()\n+\n+        await expectLogic(withoutTimePrecision).toMatchValues({\n+            isFixedRange: true,\n+            isFixedRangeWithTime: false,\n+            dateFromHasTimePrecision: false,\n+            dateToHasTimePrecision: false,\n+        })\n+    })\n+\n+    it('isFixedRangeWithTime is true when only dateFrom has time precision', async () => {\n+        props = {\n+            key: 'test-from-time-precision',\n+            onChange,\n+            dateFrom: '2024-01-15T10:30:00',\n+            dateTo: '2024-01-16',\n+            dateOptions: dateMapping,\n+            isDateFormatted: false,\n+        }\n+        const withFromTimePrecision = dateFilterLogic(props)\n+        withFromTimePrecision.mount()\n+\n+        await expectLogic(withFromTimePrecision).toMatchValues({\n+            isFixedRange: true,\n+            isFixedRangeWithTime: true,\n+            dateFromHasTimePrecision: true,\n+            dateToHasTimePrecision: false,\n+        })\n+    })\n+\n+    it('isFixedRangeWithTime is true when only dateTo has time precision', async () => {\n+        props = {\n+            key: 'test-to-time-precision',\n+            onChange,\n+            dateFrom: '2024-01-15',\n+            dateTo: '2024-01-16T14:45:00',\n+            dateOptions: dateMapping,\n+            isDateFormatted: false,\n+        }\n+        const withToTimePrecision = dateFilterLogic(props)\n+        withToTimePrecision.mount()\n+\n+        await expectLogic(withToTimePrecision).toMatchValues({\n+            isFixedRange: true,\n+            isFixedRangeWithTime: true,\n+            dateFromHasTimePrecision: false,\n+            dateToHasTimePrecision: true,\n+        })\n+    })\n+\n     it('can set the date range', async () => {\n         props = {\n             key: 'test',\ndiff --git a/frontend/src/lib/components/DateFilter/dateFilterLogic.ts b/frontend/src/lib/components/DateFilter/dateFilterLogic.ts\nindex f42779f2cfaeb..a669ec454bf13 100644\n--- a/frontend/src/lib/components/DateFilter/dateFilterLogic.ts\n+++ b/frontend/src/lib/components/DateFilter/dateFilterLogic.ts\n@@ -28,6 +28,7 @@ export const dateFilterLogic = kea<dateFilterLogicType>([\n     actions({\n         open: true,\n         openFixedRange: true,\n+        openFixedRangeWithTime: true,\n         openDateToNow: true,\n         openFixedDate: true,\n         close: true,\n@@ -53,6 +54,7 @@ export const dateFilterLogic = kea<dateFilterLogicType>([\n             {\n                 open: () => DateFilterView.QuickList,\n                 openFixedRange: () => DateFilterView.FixedRange,\n+                openFixedRangeWithTime: () => DateFilterView.FixedRangeWithTime,\n                 openDateToNow: () => DateFilterView.DateToNow,\n                 openFixedDate: () => DateFilterView.FixedDate,\n             },\n@@ -62,6 +64,7 @@ export const dateFilterLogic = kea<dateFilterLogicType>([\n             {\n                 open: () => true,\n                 openFixedRange: () => true,\n+                openFixedRangeWithTime: () => true,\n                 openDateToNow: () => true,\n                 openFixedDate: () => true,\n                 setDate: (_, { keepPopoverOpen }) => keepPopoverOpen,\n@@ -109,6 +112,11 @@ export const dateFilterLogic = kea<dateFilterLogicType>([\n             (s) => [s.dateFrom, s.dateTo],\n             (dateFrom, dateTo) => !!(dateFrom && dateTo && dayjs(dateFrom).isValid() && dayjs(dateTo).isValid()),\n         ],\n+        isFixedRangeWithTime: [\n+            (s) => [s.isFixedRange, s.dateFromHasTimePrecision, s.dateToHasTimePrecision],\n+            (isFixedRange, dateFromHasTimePrecision, dateToHasTimePrecision) =>\n+                isFixedRange && (dateFromHasTimePrecision || dateToHasTimePrecision),\n+        ],\n         isDateToNow: [\n             (s) => [s.dateFrom, s.dateTo, (_, p) => p.isFixedDateMode],\n             (dateFrom, dateTo, isFixedDateMode) =>\ndiff --git a/frontend/src/lib/components/DateFilter/types.ts b/frontend/src/lib/components/DateFilter/types.ts\nindex 665c34713bef3..8ae0f75a8e28f 100644\n--- a/frontend/src/lib/components/DateFilter/types.ts\n+++ b/frontend/src/lib/components/DateFilter/types.ts\n@@ -6,6 +6,7 @@ export enum DateFilterView {\n     QuickList = 'QuickList',\n     DateToNow = 'DateToNow',\n     FixedRange = 'FixedRange',\n+    FixedRangeWithTime = 'FixedRangeWithTime',\n     FixedDate = 'FixedDate',\n }\n \n@@ -19,6 +20,7 @@ export type DateFilterLogicProps = {\n     isFixedDateMode?: boolean\n     placeholder?: string\n     allowTimePrecision?: boolean\n+    allowFixedRangeWithTime?: boolean\n     explicitDate?: boolean\n }\n \ndiff --git a/products/logs/frontend/filters/DateRangeFilter.tsx b/products/logs/frontend/filters/DateRangeFilter.tsx\nindex 3967f03a6a010..fe263d35f376b 100644\n--- a/products/logs/frontend/filters/DateRangeFilter.tsx\n+++ b/products/logs/frontend/filters/DateRangeFilter.tsx\n@@ -67,6 +67,7 @@ export const DateRangeFilter = (): JSX.Element => {\n                 setDateRange({ date_from: changedDateFrom, date_to: changedDateTo })\n             }}\n             allowTimePrecision\n+            allowFixedRangeWithTime\n             allowedRollingDateOptions={['minutes', 'hours', 'days', 'weeks', 'months']}\n         />\n     )\n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/PostHog__posthog.main/pr_mirror/PostHog__posthog.main.42569/metadata__pr_42569.json"
  },
  {
    "instance_id": "PostHog__posthog.main.42628",
    "repo": "PostHog/posthog",
    "pull_number": 42628,
    "base_commit": "e0fc7f7a8bd41e0e75e494b9ac2356c6e4543a14",
    "patch": "diff --git a/frontend/src/lib/components/TopBarSettingsButton/topBarSettingsButtonLogic.test.ts b/frontend/src/lib/components/TopBarSettingsButton/topBarSettingsButtonLogic.test.ts\nindex 9004f8dfa1763..757be6c1b91f1 100644\n--- a/frontend/src/lib/components/TopBarSettingsButton/topBarSettingsButtonLogic.test.ts\n+++ b/frontend/src/lib/components/TopBarSettingsButton/topBarSettingsButtonLogic.test.ts\n@@ -86,7 +86,7 @@ describe('topBarSettingsButtonLogic', () => {\n         it('returns other setting section IDs regardless of CRM feature flag state', async () => {\n             router.actions.push(urls.persons())\n             featureFlagLogic.actions.setFeatureFlags([], {\n-                [FEATURE_FLAGS.CRM_ITERATION_ONE]: false,\n+                [FEATURE_FLAGS.CUSTOMER_ANALYTICS]: false,\n             })\n \n             await expectLogic(logic).toMatchValues({\n@@ -94,7 +94,7 @@ describe('topBarSettingsButtonLogic', () => {\n             })\n \n             featureFlagLogic.actions.setFeatureFlags([], {\n-                [FEATURE_FLAGS.CRM_ITERATION_ONE]: true,\n+                [FEATURE_FLAGS.CUSTOMER_ANALYTICS]: true,\n             })\n \n             await expectLogic(logic).toMatchValues({\ndiff --git a/frontend/src/lib/constants.tsx b/frontend/src/lib/constants.tsx\nindex b459816585d09..c4433c567dc8c 100644\n--- a/frontend/src/lib/constants.tsx\n+++ b/frontend/src/lib/constants.tsx\n@@ -237,10 +237,9 @@ export const FEATURE_FLAGS = {\n     ENDPOINTS: 'embedded-analytics', // owner: @sakce #team-clickhouse\n     SUPPORT_FORM_IN_ONBOARDING: 'support-form-in-onboarding', // owner: @joshsny\n     CRM_ITERATION_ONE: 'crm-iteration-one', // owner: @arthurdedeus #team-customer-analytics\n-    CRM_USAGE_METRICS: 'crm-usage-metrics', // owner: @arthurdedeus #team-customer-analytics\n     TOGGLE_PROPERTY_ARRAYS: 'toggle-property-arrays', // owner: @arthurdedeus #team-customer-analytics\n     DWH_JOIN_TABLE_PREVIEW: 'dwh-join-table-preview', // owner: @arthurdedeus #team-customer-analytics\n-    CUSTOMER_ANALYTICS: 'customer-analytics', // owner: @arthurdedeus #team-customer-analytics\n+    CUSTOMER_ANALYTICS: 'customer-analytics-roadmap', // owner: @arthurdedeus #team-customer-analytics\n     SETTINGS_SESSIONS_V2_JOIN: 'settings-sessions-v2-join', // owner: @robbie-c #team-web-analytics\n     SESSIONS_EXPLORER: 'sessions-explorer', // owner: @jabahamondes #team-web-analytics\n     SAVE_INSIGHT_TASK: 'save-insight-task', // owner: @joshsny\ndiff --git a/frontend/src/queries/nodes/DataTable/DataTable.tsx b/frontend/src/queries/nodes/DataTable/DataTable.tsx\nindex 013cc86d5bf95..2f99a9ad1faf5 100644\n--- a/frontend/src/queries/nodes/DataTable/DataTable.tsx\n+++ b/frontend/src/queries/nodes/DataTable/DataTable.tsx\n@@ -174,6 +174,7 @@ export function DataTable({\n \n     const canUseWebAnalyticsPreAggregatedTables = useFeatureFlag('SETTINGS_WEB_ANALYTICS_PRE_AGGREGATED_TABLES')\n     const hasCrmIterationOneEnabled = useFeatureFlag('CRM_ITERATION_ONE')\n+    const hasCustomerAnalyticsEnabled = useFeatureFlag('CRM_ITERATION_ONE')\n     const usedWebAnalyticsPreAggregatedTables =\n         canUseWebAnalyticsPreAggregatedTables &&\n         response &&\n@@ -734,7 +735,8 @@ export function DataTable({\n     ].filter((x) => !!x)\n \n     const secondRowRight = [\n-        sourceFeatures.has(QueryFeature.linkDataButton) && hasCrmIterationOneEnabled ? (\n+        sourceFeatures.has(QueryFeature.linkDataButton) &&\n+        (hasCrmIterationOneEnabled || hasCustomerAnalyticsEnabled) ? (\n             <ViewLinkButton tableName=\"groups\" />\n         ) : null,\n         (showColumnConfigurator || showPersistentColumnConfigurator) &&\ndiff --git a/frontend/src/scenes/groups/Group.tsx b/frontend/src/scenes/groups/Group.tsx\nindex 92be4f42acd96..148c29e54ceab 100644\n--- a/frontend/src/scenes/groups/Group.tsx\n+++ b/frontend/src/scenes/groups/Group.tsx\n@@ -121,7 +121,7 @@ export function Group({ tabId }: { tabId?: string }): JSX.Element {\n                         label: <span data-attr=\"groups-overview-tab\">Overview</span>,\n                         content: <GroupOverview groupData={groupData} />,\n                     },\n-                    ...(featureFlags[FEATURE_FLAGS.CRM_ITERATION_ONE] && groupData.notebook\n+                    ...(featureFlags[FEATURE_FLAGS.CUSTOMER_ANALYTICS] && groupData.notebook\n                         ? [\n                               {\n                                   key: GroupsTabType.NOTES,\ndiff --git a/frontend/src/scenes/groups/Groups.tsx b/frontend/src/scenes/groups/Groups.tsx\nindex c4a4b5370c8a9..a83a6343156c6 100644\n--- a/frontend/src/scenes/groups/Groups.tsx\n+++ b/frontend/src/scenes/groups/Groups.tsx\n@@ -46,7 +46,7 @@ export function GroupsScene({ tabId }: { tabId?: string } = {}): JSX.Element {\n \n     const { groupsAccessStatus } = useValues(groupsAccessLogic)\n     const { aggregationLabel } = useValues(groupsModel)\n-    const hasCrmIterationOneEnabled = useFeatureFlag('CRM_ITERATION_ONE')\n+    const hasCustomerAnalyticsEnabled = useFeatureFlag('CUSTOMER_ANALYTICS')\n \n     if (groupTypeIndex === undefined) {\n         throw new Error('groupTypeIndex is undefined')\n@@ -79,7 +79,7 @@ export function GroupsScene({ tabId }: { tabId?: string } = {}): JSX.Element {\n         },\n     } as QueryContext['columns']\n     let hiddenColumns = [] as string[]\n-    if (hasCrmIterationOneEnabled) {\n+    if (hasCustomerAnalyticsEnabled) {\n         columns = getCRMColumns(groupTypeName, groupTypeIndex)\n         hiddenColumns.push('key')\n     }\n@@ -95,7 +95,7 @@ export function GroupsScene({ tabId }: { tabId?: string } = {}): JSX.Element {\n                     type: 'cohort',\n                 }}\n                 actions={\n-                    hasCrmIterationOneEnabled ? (\n+                    hasCustomerAnalyticsEnabled ? (\n                         <LemonButton\n                             type=\"primary\"\n                             size=\"small\"\n@@ -135,7 +135,7 @@ export function GroupsScene({ tabId }: { tabId?: string } = {}): JSX.Element {\n                 dataAttr=\"groups-table\"\n             />\n \n-            {hasCrmIterationOneEnabled && (\n+            {hasCustomerAnalyticsEnabled && (\n                 <LemonModal\n                     isOpen={saveGroupViewModalOpen}\n                     onClose={() => setSaveGroupViewModalOpen(false)}\ndiff --git a/frontend/src/scenes/groups/groupsNewLogic.ts b/frontend/src/scenes/groups/groupsNewLogic.ts\nindex 035f7a3134995..15cf699b4d92a 100644\n--- a/frontend/src/scenes/groups/groupsNewLogic.ts\n+++ b/frontend/src/scenes/groups/groupsNewLogic.ts\n@@ -213,8 +213,8 @@ export const groupsNewLogic = kea<groupsNewLogicType>([\n     })),\n \n     afterMount(({ props, values }) => {\n-        // Redirect if the CRM feature flag is not enabled\n-        if (!values.featureFlags[FEATURE_FLAGS.CRM_ITERATION_ONE]) {\n+        // Redirect if customer analytics is not enabled\n+        if (!values.featureFlags[FEATURE_FLAGS.CUSTOMER_ANALYTICS]) {\n             router.actions.push(urls.groups(props.groupTypeIndex))\n         }\n     }),\n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/PostHog__posthog.main/pr_mirror/PostHog__posthog.main.42628/metadata__pr_42628.json"
  },
  {
    "instance_id": "PostHog__posthog.main.42672",
    "repo": "PostHog/posthog",
    "pull_number": 42672,
    "base_commit": "3f92060317c7f47ed200f8300af0752c657769cb",
    "patch": "diff --git a/products/workflows/frontend/Workflows/hogflows/steps/stepWaitUntilTimeWindowLogic.test.ts b/products/workflows/frontend/Workflows/hogflows/steps/stepWaitUntilTimeWindowLogic.test.ts\nindex d978403e2e384..5ef12bf3fa00d 100644\n--- a/products/workflows/frontend/Workflows/hogflows/steps/stepWaitUntilTimeWindowLogic.test.ts\n+++ b/products/workflows/frontend/Workflows/hogflows/steps/stepWaitUntilTimeWindowLogic.test.ts\n@@ -64,7 +64,7 @@ describe('stepWaitUntilTimeWindowLogic', () => {\n             workflow: partial({\n                 actions: expect.arrayContaining([\n                     expect.objectContaining({\n-                        description: 'Wait until weekends at between 09:00 and 17:00 (UTC).',\n+                        description: 'Wait until weekends between 09:00 and 17:00 (UTC).',\n                     }),\n                 ]),\n             }),\n@@ -85,7 +85,7 @@ describe('stepWaitUntilTimeWindowLogic', () => {\n             workflow: partial({\n                 actions: expect.arrayContaining([\n                     expect.objectContaining({\n-                        description: 'Wait until weekdays at between 10:00 and 18:00 (UTC).',\n+                        description: 'Wait until weekdays between 10:00 and 18:00 (UTC).',\n                     }),\n                 ]),\n             }),\n@@ -106,7 +106,7 @@ describe('stepWaitUntilTimeWindowLogic', () => {\n             workflow: partial({\n                 actions: expect.arrayContaining([\n                     expect.objectContaining({\n-                        description: 'Wait until weekdays at between 09:00 and 17:00 (America/New_York).',\n+                        description: 'Wait until weekdays between 09:00 and 17:00 (America/New_York).',\n                     }),\n                 ]),\n             }),\ndiff --git a/products/workflows/frontend/Workflows/hogflows/steps/stepWaitUntilTimeWindowLogic.ts b/products/workflows/frontend/Workflows/hogflows/steps/stepWaitUntilTimeWindowLogic.ts\nindex 4ac804559ca2e..db4b641f45681 100644\n--- a/products/workflows/frontend/Workflows/hogflows/steps/stepWaitUntilTimeWindowLogic.ts\n+++ b/products/workflows/frontend/Workflows/hogflows/steps/stepWaitUntilTimeWindowLogic.ts\n@@ -14,7 +14,7 @@ export type WaitUntilTimeWindowConfig = {\n     time?: TimeConfig\n }\n \n-const AUTO_DESCRIPTION_REGEX = /^Wait until .+ at .+ \\(.+\\)\\.$/\n+const AUTO_DESCRIPTION_REGEX = /^Wait until .+ (at any time|between .+ and .+) \\(.+\\)\\.$/\n const LEGACY_DEFAULT_DESCRIPTION = 'Wait until a specified time window.'\n \n function capitalize(str: string): string {\n@@ -54,7 +54,9 @@ export function getWaitUntilTimeWindowDescription(day: DayConfig, time: TimeConf\n     const dayDesc = getDayDescription(day)\n     const timeDesc = getTimeDescription(time)\n     const tz = timezone || 'UTC'\n-    return `Wait until ${dayDesc} at ${timeDesc} (${tz}).`\n+    // Use \"at\" only for \"any time\", otherwise use the time description directly (e.g., \"between X and Y\")\n+    const timeClause = time === 'any' ? `at ${timeDesc}` : timeDesc\n+    return `Wait until ${dayDesc} ${timeClause} (${tz}).`\n }\n \n export function shouldAutoUpdateDescription(description: string): boolean {\n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/PostHog__posthog.main/pr_mirror/PostHog__posthog.main.42672/metadata__pr_42672.json"
  },
  {
    "instance_id": "strapi__strapi-24965",
    "repo": "strapi/strapi",
    "pull_number": 24965,
    "base_commit": "b03ed9b0d57d44676c8eb8eaf6dc3e9c88df224e",
    "patch": "diff --git a/packages/plugins/i18n/server/src/services/ai-localizations.ts b/packages/plugins/i18n/server/src/services/ai-localizations.ts\nindex 3d21a605656b..8694a1811039 100644\n--- a/packages/plugins/i18n/server/src/services/ai-localizations.ts\n+++ b/packages/plugins/i18n/server/src/services/ai-localizations.ts\n@@ -11,7 +11,12 @@ const createAILocalizationsService = ({ strapi }: { strapi: Core.Strapi }) => {\n   const aiServerUrl = process.env.STRAPI_AI_URL || 'https://strapi-ai.apps.strapi.io';\n   const aiLocalizationJobsService = getService('ai-localization-jobs');\n \n-  const UNSUPPORTED_ATTRIBUTE_TYPES: Schema.Attribute.Kind[] = ['media', 'relation', 'boolean'];\n+  const UNSUPPORTED_ATTRIBUTE_TYPES: Schema.Attribute.Kind[] = [\n+    'media',\n+    'relation',\n+    'boolean',\n+    'enumeration',\n+  ];\n   const IGNORED_FIELDS = [\n     'id',\n     'documentId',\n",
    "test_patch": "",
    "problem_statement": "AI i18n throws an error when a Enum field  is present\n### Node Version\n\n20.19.5\n\n### NPM/Yarn/PNPM Version\n\n4.10.3\n\n### Strapi Version\n\n5.31.3\n\n### Operating System\n\nMacOS\n\n### Database\n\nSQLite\n\n### Javascript or Typescript\n\nTypescript\n\n### Reproduction URL\n\n_No response_\n\n### Bug Description\n\nAn error is thrown when there is a translatable enum and AI i18n is enabled.\n\n<img width=\"1988\" height=\"1138\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/cf9a0967-665d-4854-a448-efdd132258ea\" />\n\n### Steps to Reproduce\n\n1. Add a Growth licence\n3. Enable i18n AI + add locales\n4. Create a schema with an enum field that is localised\n6. Create an entry, select an enum value and save\n\n### Expected Behavior\n\nThe enum should be translated and saved.\n\n### Logs\n\n```shell\n[2025-12-03 10:16:48.197] info: AI token generated successfully\n[2025-12-03 10:16:48.198] http: Contacting AI Server for localizations generation\n[2025-12-03 10:16:49.092] http: GET /i18n/ai-localization-jobs/collection-types/api::product.product/wx1ajxq0i239g69y9vp1onxo (17 ms) 200\n[2025-12-03 10:16:50.121] http: GET /i18n/ai-localization-jobs/collection-types/api::product.product/wx1ajxq0i239g69y9vp1onxo (17 ms) 200\n[2025-12-03 10:16:51.147] http: GET /i18n/ai-localization-jobs/collection-types/api::product.product/wx1ajxq0i239g69y9vp1onxo (15 ms) 200\n[2025-12-03 10:16:52.174] http: GET /i18n/ai-localization-jobs/collection-types/api::product.product/wx1ajxq0i239g69y9vp1onxo (14 ms) 200\n[2025-12-03 10:16:53.205] http: GET /i18n/ai-localization-jobs/collection-types/api::product.product/wx1ajxq0i239g69y9vp1onxo (18 ms) 200\n[2025-12-03 10:16:54.226] http: GET /i18n/ai-localization-jobs/collection-types/api::product.product/wx1ajxq0i239g69y9vp1onxo (12 ms) 200\n[2025-12-03 10:16:55.258] http: GET /i18n/ai-localization-jobs/collection-types/api::product.product/wx1ajxq0i239g69y9vp1onxo (16 ms) 200\n[2025-12-03 10:16:56.286] http: GET /i18n/ai-localization-jobs/collection-types/api::product.product/wx1ajxq0i239g69y9vp1onxo (17 ms) 200\n[2025-12-03 10:16:57.317] http: GET /i18n/ai-localization-jobs/collection-types/api::product.product/wx1ajxq0i239g69y9vp1onxo (20 ms) 200\n[2025-12-03 10:16:58.344] http: GET /i18n/ai-localization-jobs/collection-types/api::product.product/wx1ajxq0i239g69y9vp1onxo (17 ms) 200\n[2025-12-03 10:16:59.361] http: GET /i18n/ai-localization-jobs/collection-types/api::product.product/wx1ajxq0i239g69y9vp1onxo (11 ms) 200\n[2025-12-03 10:17:00.394] http: GET /i18n/ai-localization-jobs/collection-types/api::product.product/wx1ajxq0i239g69y9vp1onxo (21 ms) 200\n[2025-12-03 10:17:01.420] http: GET /i18n/ai-localization-jobs/collection-types/api::product.product/wx1ajxq0i239g69y9vp1onxo (16 ms) 200\n[2025-12-03 10:17:02.444] http: GET /i18n/ai-localization-jobs/collection-types/api::product.product/wx1ajxq0i239g69y9vp1onxo (14 ms) 200\n[2025-12-03 10:17:03.465] http: GET /i18n/ai-localization-jobs/collection-types/api::product.product/wx1ajxq0i239g69y9vp1onxo (13 ms) 200\n[2025-12-03 10:17:04.493] http: GET /i18n/ai-localization-jobs/collection-types/api::product.product/wx1ajxq0i239g69y9vp1onxo (15 ms) 200\n[2025-12-03 10:17:05.521] http: GET /i18n/ai-localization-jobs/collection-types/api::product.product/wx1ajxq0i239g69y9vp1onxo (16 ms) 200\n[2025-12-03 10:17:06.546] http: GET /i18n/ai-localization-jobs/collection-types/api::product.product/wx1ajxq0i239g69y9vp1onxo (15 ms) 200\n[2025-12-03 10:17:07.577] http: GET /i18n/ai-localization-jobs/collection-types/api::product.product/wx1ajxq0i239g69y9vp1onxo (17 ms) 200\n[2025-12-03 10:17:08.608] http: GET /i18n/ai-localization-jobs/collection-types/api::product.product/wx1ajxq0i239g69y9vp1onxo (15 ms) 200\n[2025-12-03 10:17:08.760] info: [AI Localizations Job] Updated existing job for document wx1ajxq0i239g69y9vp1onxo with status: failed\n[2025-12-03 10:17:08.763] error: AI Localizations generation failed timing must be one of the following values: morning, noon, night, \n[2025-12-03 10:17:09.634] http: GET /i18n/ai-localization-jobs/collection-types/api::product.product/wx1ajxq0i239g69y9vp1onxo (16 ms) 200\n[2025-12-03 10:17:09.667] http: GET /content-manager/collection-types/api::product.product/wx1ajxq0i239g69y9vp1onxo?locale=en (22 ms) 200\n```\n\n### Code Snippets\n\n_No response_\n\n### Media\n\n_No response_\n\n### Additional information\n\n_No response_\n\n### Confirmation Checklist\n\n- [x] I have checked the existing [issues](https://github.com/strapi/strapi/issues) for duplicates.\n- [x] I agree to follow this project's [Code of Conduct](https://github.com/strapi/strapi/blob/develop/CODE_OF_CONDUCT.md).\n",
    "direct_patch": true,
    "has_rewrites": false,
    "_file": "logs/bug_gen/strapi__strapi.main/pr_mirror/strapi__strapi-24965/metadata__pr_24965.json"
  },
  {
    "instance_id": "strapi__strapi-24907",
    "repo": "strapi/strapi",
    "pull_number": 24907,
    "base_commit": "e7ae51b01f78ddeaa09c4aa3e3882f466a5b3188",
    "patch": "diff --git a/packages/core/admin/admin/src/components/GuidedTour/Overview.tsx b/packages/core/admin/admin/src/components/GuidedTour/Overview.tsx\nindex 8be32866b832..57f48a35753d 100644\n--- a/packages/core/admin/admin/src/components/GuidedTour/Overview.tsx\n+++ b/packages/core/admin/admin/src/components/GuidedTour/Overview.tsx\n@@ -171,7 +171,12 @@ export const GuidedTourHomepageOverview = () => {\n     }\n   };\n \n-  if (!guidedTourMeta?.data.isFirstSuperAdminUser || !enabled || hidden) {\n+  if (\n+    !guidedTourMeta?.data.isFirstSuperAdminUser ||\n+    !enabled ||\n+    hidden ||\n+    process.env.NODE_ENV !== 'development'\n+  ) {\n     return null;\n   }\n \ndiff --git a/packages/core/admin/admin/src/components/GuidedTour/Tours.tsx b/packages/core/admin/admin/src/components/GuidedTour/Tours.tsx\nindex b32990e0393e..448b803d3f59 100644\n--- a/packages/core/admin/admin/src/components/GuidedTour/Tours.tsx\n+++ b/packages/core/admin/admin/src/components/GuidedTour/Tours.tsx\n@@ -47,7 +47,7 @@ type GuidedTourTooltipProps = {\n const GuidedTourTooltip = ({ children, ...props }: GuidedTourTooltipProps) => {\n   const state = useGuidedTour('TooltipWrapper', (s) => s.state);\n \n-  if (!state.enabled || state.hidden) {\n+  if (!state.enabled || state.hidden || process.env.NODE_ENV !== 'development') {\n     return children;\n   }\n \ndiff --git a/packages/core/admin/admin/src/pages/ProfilePage.tsx b/packages/core/admin/admin/src/pages/ProfilePage.tsx\nindex 873c461fce31..f699120e56a8 100644\n--- a/packages/core/admin/admin/src/pages/ProfilePage.tsx\n+++ b/packages/core/admin/admin/src/pages/ProfilePage.tsx\n@@ -230,7 +230,7 @@ const ProfilePage = () => {\n             </>\n           )}\n         </Form>\n-        {isDesktop && (\n+        {isDesktop && process.env.NODE_ENV === 'development' && (\n           <Box>\n             <Layouts.Content>\n               <GuidedTourSection />\n",
    "test_patch": "",
    "problem_statement": "",
    "direct_patch": true,
    "has_rewrites": false,
    "_file": "logs/bug_gen/strapi__strapi.main/pr_mirror/strapi__strapi-24907/metadata__pr_24907.json"
  },
  {
    "instance_id": "strapi__strapi-24904",
    "repo": "strapi/strapi",
    "pull_number": 24904,
    "base_commit": "e2e3ca14971ee768e1a227a209362264fd0132d4",
    "patch": "diff --git a/packages/core/data-transfer/src/utils/encryption/decrypt.ts b/packages/core/data-transfer/src/utils/encryption/decrypt.ts\nindex 38a2d9f6c64c..711e97f2823c 100644\n--- a/packages/core/data-transfer/src/utils/encryption/decrypt.ts\n+++ b/packages/core/data-transfer/src/utils/encryption/decrypt.ts\n@@ -12,20 +12,20 @@ const getDecryptionStrategy = (algorithm: Algorithm): EncryptionStrategy => {\n     },\n     aes128(key: string): Decipheriv {\n       const hashedKey = scryptSync(key, '', 32);\n-      const initVector: BinaryLike | null = hashedKey.slice(16);\n-      const securityKey: CipherKey = hashedKey.slice(0, 16);\n+      const initVector: BinaryLike | null = hashedKey.subarray(16);\n+      const securityKey: CipherKey = hashedKey.subarray(0, 16);\n       return createDecipheriv(algorithm, securityKey, initVector);\n     },\n     aes192(key: string): Decipheriv {\n       const hashedKey = scryptSync(key, '', 40);\n-      const initVector: BinaryLike | null = hashedKey.slice(24);\n-      const securityKey: CipherKey = hashedKey.slice(0, 24);\n+      const initVector: BinaryLike | null = hashedKey.subarray(24);\n+      const securityKey: CipherKey = hashedKey.subarray(0, 24);\n       return createDecipheriv(algorithm, securityKey, initVector);\n     },\n     aes256(key: string): Decipheriv {\n       const hashedKey = scryptSync(key, '', 48);\n-      const initVector: BinaryLike | null = hashedKey.slice(32);\n-      const securityKey: CipherKey = hashedKey.slice(0, 32);\n+      const initVector: BinaryLike | null = hashedKey.subarray(32);\n+      const securityKey: CipherKey = hashedKey.subarray(0, 32);\n       return createDecipheriv(algorithm, securityKey, initVector);\n     },\n   };\ndiff --git a/packages/core/data-transfer/src/utils/encryption/encrypt.ts b/packages/core/data-transfer/src/utils/encryption/encrypt.ts\nindex 0aa3ea1c53cd..966a01f62253 100644\n--- a/packages/core/data-transfer/src/utils/encryption/encrypt.ts\n+++ b/packages/core/data-transfer/src/utils/encryption/encrypt.ts\n@@ -12,20 +12,20 @@ const getEncryptionStrategy = (algorithm: Algorithm): EncryptionStrategy => {\n     },\n     aes128(key: string): Cipheriv {\n       const hashedKey = scryptSync(key, '', 32);\n-      const initVector: BinaryLike | null = hashedKey.slice(16);\n-      const securityKey: CipherKey = hashedKey.slice(0, 16);\n+      const initVector: BinaryLike | null = hashedKey.subarray(16);\n+      const securityKey: CipherKey = hashedKey.subarray(0, 16);\n       return createCipheriv(algorithm, securityKey, initVector);\n     },\n     aes192(key: string): Cipheriv {\n       const hashedKey = scryptSync(key, '', 40);\n-      const initVector: BinaryLike | null = hashedKey.slice(24);\n-      const securityKey: CipherKey = hashedKey.slice(0, 24);\n+      const initVector: BinaryLike | null = hashedKey.subarray(24);\n+      const securityKey: CipherKey = hashedKey.subarray(0, 24);\n       return createCipheriv(algorithm, securityKey, initVector);\n     },\n     aes256(key: string): Cipheriv {\n       const hashedKey = scryptSync(key, '', 48);\n-      const initVector: BinaryLike | null = hashedKey.slice(32);\n-      const securityKey: CipherKey = hashedKey.slice(0, 32);\n+      const initVector: BinaryLike | null = hashedKey.subarray(32);\n+      const securityKey: CipherKey = hashedKey.subarray(0, 32);\n       return createCipheriv(algorithm, securityKey, initVector);\n     },\n   };\n",
    "test_patch": "",
    "problem_statement": "",
    "direct_patch": true,
    "has_rewrites": false,
    "_file": "logs/bug_gen/strapi__strapi.main/pr_mirror/strapi__strapi-24904/metadata__pr_24904.json"
  },
  {
    "instance_id": "strapi__strapi-24879",
    "repo": "strapi/strapi",
    "pull_number": 24879,
    "base_commit": "4310e958c583cd2f7e924cde428875ca6b033faa",
    "patch": "diff --git a/packages/core/strapi/src/cli/commands/transfer/command.ts b/packages/core/strapi/src/cli/commands/transfer/command.ts\nindex ab9d7a9d69f3..01cc16d2fd30 100644\n--- a/packages/core/strapi/src/cli/commands/transfer/command.ts\n+++ b/packages/core/strapi/src/cli/commands/transfer/command.ts\n@@ -45,147 +45,154 @@ const command = () => {\n       .hook(\n         'preAction',\n         ifOptions(\n-          (opts) =>\n+          async (opts) =>\n             (opts.from && opts.to) || (opts.from && opts.toToken) || (opts.to && opts.fromToken),\n           async () =>\n             exitWith(1, 'Only one remote source (from) or destination (to) option may be provided')\n         )\n       )\n-      .hook('preAction', async (thisCommand) => {\n-        const opts = thisCommand.opts();\n-        const hasEnvUrl = process.env.STRAPI_TRANSFER_URL;\n-        const hasEnvToken = process.env.STRAPI_TRANSFER_TOKEN;\n-\n-        const logDocumentation = () => {\n-          console.info(\n-            '\u2139\ufe0f  Data transfer documentation: https://docs.strapi.io/dev-docs/data-management/transfer'\n-          );\n-        };\n-\n-        const logEnvironmentVariables = () => {\n-          if (!hasEnvUrl && !hasEnvToken) {\n-            console.info('\u2139\ufe0f  No transfer configuration found in environment variables');\n-            console.info(\n-              '   \u2192 Add STRAPI_TRANSFER_URL and STRAPI_TRANSFER_TOKEN environment variables to make the transfer process faster for future runs'\n-            );\n-            return;\n-          }\n+      .hook(\n+        'preAction',\n+        ifOptions(\n+          // Only run interactive prompts if neither --from nor --to is provided\n+          async (opts) => !opts.from && !opts.to,\n+          async (thisCommand) => {\n+            const opts = thisCommand.opts();\n+            const hasEnvUrl = process.env.STRAPI_TRANSFER_URL;\n+            const hasEnvToken = process.env.STRAPI_TRANSFER_TOKEN;\n+\n+            const logDocumentation = () => {\n+              console.info(\n+                '\u2139\ufe0f  Data transfer documentation: https://docs.strapi.io/dev-docs/data-management/transfer'\n+              );\n+            };\n+\n+            const logEnvironmentVariables = () => {\n+              if (!hasEnvUrl && !hasEnvToken) {\n+                console.info('\u2139\ufe0f  No transfer configuration found in environment variables');\n+                console.info(\n+                  '   \u2192 Add STRAPI_TRANSFER_URL and STRAPI_TRANSFER_TOKEN environment variables to make the transfer process faster for future runs'\n+                );\n+                return;\n+              }\n \n-          console.info('\u2139\ufe0f  Found transfer configuration in your environment:');\n+              console.info('\u2139\ufe0f  Found transfer configuration in your environment:');\n \n-          if (hasEnvUrl) {\n-            console.info(\n-              `   \u2192 Environment STRAPI_TRANSFER_URL (${hasEnvUrl}) will be used as the transfer URL`\n-            );\n-          }\n+              if (hasEnvUrl) {\n+                console.info(\n+                  `   \u2192 Environment STRAPI_TRANSFER_URL (${hasEnvUrl}) will be used as the transfer URL`\n+                );\n+              }\n \n-          if (hasEnvToken) {\n-            console.info(\n-              '   \u2192 Environment STRAPI_TRANSFER_TOKEN value will be used as the transfer token'\n-            );\n-          }\n+              if (hasEnvToken) {\n+                console.info(\n+                  '   \u2192 Environment STRAPI_TRANSFER_TOKEN value will be used as the transfer token'\n+                );\n+              }\n \n-          console.info(); // Empty line for better readability\n-        };\n+              console.info(); // Empty line for better readability\n+            };\n \n-        const determineDirection = async () => {\n-          // If user has not provided a direction from CLI, log the documentation\n-          if (!opts.from && !opts.to) {\n-            logDocumentation();\n-          }\n+            const determineDirection = async () => {\n+              // If user has not provided a direction from CLI, log the documentation\n+              if (!opts.from && !opts.to) {\n+                logDocumentation();\n+              }\n \n-          logEnvironmentVariables();\n+              logEnvironmentVariables();\n \n-          if (opts.from) {\n-            return opts.from;\n-          }\n-          if (opts.to) {\n-            return opts.to;\n-          }\n+              if (opts.from) {\n+                return 'from';\n+              }\n+              if (opts.to) {\n+                return 'to';\n+              }\n \n-          const { dir } = await inquirer.prompt([\n-            {\n-              type: 'list',\n-              name: 'dir',\n-              message: 'Choose transfer direction:',\n-              choices: [\n-                { name: 'Pull data from remote Strapi to local', value: 'from' },\n-                { name: 'Push local data to remote Strapi', value: 'to' },\n-              ],\n-            },\n-          ]);\n-\n-          return dir;\n-        };\n-\n-        const determineUrl = async (direction: 'from' | 'to') => {\n-          if (opts[direction]) {\n-            return new URL(opts[direction]);\n-          }\n+              const { dir } = await inquirer.prompt([\n+                {\n+                  type: 'list',\n+                  name: 'dir',\n+                  message: 'Choose transfer direction:',\n+                  choices: [\n+                    { name: 'Pull data from remote Strapi to local', value: 'from' },\n+                    { name: 'Push local data to remote Strapi', value: 'to' },\n+                  ],\n+                },\n+              ]);\n \n-          if (process.env.STRAPI_TRANSFER_URL) {\n-            return new URL(process.env.STRAPI_TRANSFER_URL);\n-          }\n+              return dir;\n+            };\n \n-          const answer = await inquirer.prompt([\n-            {\n-              type: 'input',\n-              name: 'remoteUrl',\n-              message: `Enter the URL of the remote Strapi instance to ${direction === 'from' ? 'get data from' : 'send data to'}:`,\n-              default: process.env.STRAPI_TRANSFER_URL,\n-              validate(input: string) {\n-                try {\n-                  const url = new URL(input);\n-                  if (!['http:', 'https:'].includes(url.protocol)) {\n-                    return 'URL must use http: or https: protocol';\n-                  }\n-                  return true;\n-                } catch (error) {\n-                  return 'Please enter a valid URL (e.g., http://localhost:1337/admin or https://example.com/admin)';\n-                }\n-              },\n-            },\n-          ]);\n-\n-          return new URL(answer.remoteUrl);\n-        };\n-\n-        const determineToken = async (direction: 'from' | 'to') => {\n-          if (opts[`${direction}Token`]) {\n-            return opts[`${direction}Token`];\n-          }\n+            const determineUrl = async (direction: 'from' | 'to') => {\n+              if (opts[direction]) {\n+                return new URL(opts[direction]);\n+              }\n \n-          if (process.env.STRAPI_TRANSFER_TOKEN) {\n-            return process.env.STRAPI_TRANSFER_TOKEN;\n-          }\n+              if (process.env.STRAPI_TRANSFER_URL) {\n+                return new URL(process.env.STRAPI_TRANSFER_URL);\n+              }\n \n-          const answer = await inquirer.prompt([\n-            {\n-              type: 'password',\n-              name: 'token',\n-              message: `Enter the transfer token for the remote Strapi ${direction === 'from' ? 'source' : 'destination'}:`,\n-              default: process.env.STRAPI_TRANSFER_TOKEN,\n-              validate(input: string) {\n-                if (!input?.length) {\n-                  return 'Transfer token is required';\n-                }\n-                return true;\n-              },\n-            },\n-          ]);\n-\n-          return answer.token;\n-        };\n-\n-        const direction = await determineDirection();\n-        opts[direction] = await determineUrl(direction);\n-        opts[`${direction}Token`] = await determineToken(direction);\n-      })\n+              const answer = await inquirer.prompt([\n+                {\n+                  type: 'input',\n+                  name: 'remoteUrl',\n+                  message: `Enter the URL of the remote Strapi instance to ${direction === 'from' ? 'get data from' : 'send data to'}:`,\n+                  default: process.env.STRAPI_TRANSFER_URL,\n+                  validate(input: string) {\n+                    try {\n+                      const url = new URL(input);\n+                      if (!['http:', 'https:'].includes(url.protocol)) {\n+                        return 'URL must use http: or https: protocol';\n+                      }\n+                      return true;\n+                    } catch (error) {\n+                      return 'Please enter a valid URL (e.g., http://localhost:1337/admin or https://example.com/admin)';\n+                    }\n+                  },\n+                },\n+              ]);\n+\n+              return new URL(answer.remoteUrl);\n+            };\n+\n+            const determineToken = async (direction: 'from' | 'to') => {\n+              if (opts[`${direction}Token`]) {\n+                return opts[`${direction}Token`];\n+              }\n+\n+              if (process.env.STRAPI_TRANSFER_TOKEN) {\n+                return process.env.STRAPI_TRANSFER_TOKEN;\n+              }\n+\n+              const answer = await inquirer.prompt([\n+                {\n+                  type: 'password',\n+                  name: 'token',\n+                  message: `Enter the transfer token for the remote Strapi ${direction === 'from' ? 'source' : 'destination'}:`,\n+                  default: process.env.STRAPI_TRANSFER_TOKEN,\n+                  validate(input: string) {\n+                    if (!input?.length) {\n+                      return 'Transfer token is required';\n+                    }\n+                    return true;\n+                  },\n+                },\n+              ]);\n+\n+              return answer.token;\n+            };\n+\n+            const direction = await determineDirection();\n+            opts[direction] = await determineUrl(direction);\n+            opts[`${direction}Token`] = await determineToken(direction);\n+          }\n+        )\n+      )\n       // If --from is used, validate the URL and token\n       .hook(\n         'preAction',\n         ifOptions(\n-          (opts) => opts.from,\n+          async (opts) => opts.from,\n           async (thisCommand) => {\n             assertUrlHasProtocol(thisCommand.opts().from, ['https:', 'http:']);\n             if (!thisCommand.opts().fromToken) {\n@@ -213,7 +220,7 @@ const command = () => {\n       .hook(\n         'preAction',\n         ifOptions(\n-          (opts) => opts.to,\n+          async (opts) => opts.to,\n           async (thisCommand) => {\n             assertUrlHasProtocol(thisCommand.opts().to, ['https:', 'http:']);\n             if (!thisCommand.opts().toToken) {\n",
    "test_patch": "diff --git a/packages/core/strapi/src/cli/commands/transfer/__tests__/transfer.test.ts b/packages/core/strapi/src/cli/commands/transfer/__tests__/transfer.test.ts\nindex 7e423107248e..ec056808d24c 100644\n--- a/packages/core/strapi/src/cli/commands/transfer/__tests__/transfer.test.ts\n+++ b/packages/core/strapi/src/cli/commands/transfer/__tests__/transfer.test.ts\n@@ -42,6 +42,7 @@ jest.mock('@strapi/data-transfer', () => {\n         ...acutal.strapi.providers,\n         createLocalStrapiSourceProvider: jest.fn().mockReturnValue({ name: 'testLocalSource' }),\n         createLocalStrapiDestinationProvider: jest.fn().mockReturnValue({ name: 'testLocalDest' }),\n+        createRemoteStrapiSourceProvider: jest.fn().mockReturnValue({ name: 'testRemoteSource' }),\n         createRemoteStrapiDestinationProvider: jest\n           .fn()\n           .mockReturnValue({ name: 'testRemoteDest' }),\n@@ -89,6 +90,7 @@ describe('Transfer', () => {\n   const destinationToken = 'test-token';\n \n   const sourceUrl = new URL('http://two.localhost/admin');\n+  const sourceToken = 'test-source-token';\n \n   beforeEach(() => {\n     jest.clearAllMocks();\n@@ -171,7 +173,58 @@ describe('Transfer', () => {\n     });\n   });\n \n-  it.todo('uses local Strapi destination when to is not specified');\n+  describe('--from', () => {\n+    it('exits with error when auth is not provided', async () => {\n+      await expectExit(1, async () => {\n+        await transferAction({ to: undefined, from: sourceUrl } as any);\n+      });\n+\n+      expect(console.error).toHaveBeenCalledWith(expect.stringMatching(/missing token/i));\n+\n+      expect(\n+        mockDataTransfer.strapi.providers.createRemoteStrapiSourceProvider\n+      ).not.toHaveBeenCalled();\n+    });\n+\n+    it('uses source url and token provided by user', async () => {\n+      await expectExit(0, async () => {\n+        await transferAction({\n+          to: undefined,\n+          from: sourceUrl,\n+          fromToken: sourceToken,\n+        } as any);\n+      });\n+\n+      expect(console.error).not.toHaveBeenCalled();\n+      expect(\n+        mockDataTransfer.strapi.providers.createRemoteStrapiSourceProvider\n+      ).toHaveBeenCalledWith(\n+        expect.objectContaining({\n+          url: sourceUrl,\n+          auth: {\n+            type: 'token',\n+            token: sourceToken,\n+          },\n+        })\n+      );\n+    });\n+\n+    it('uses local Strapi destination when to is not specified', async () => {\n+      await expectExit(0, async () => {\n+        await transferAction({\n+          to: undefined,\n+          from: sourceUrl,\n+          fromToken: sourceToken,\n+        } as any);\n+      });\n+\n+      expect(console.error).not.toHaveBeenCalled();\n+      expect(\n+        mockDataTransfer.strapi.providers.createLocalStrapiDestinationProvider\n+      ).toHaveBeenCalled();\n+      expect(mockDataTransfer.strapi.providers.createRemoteStrapiSourceProvider).toHaveBeenCalled();\n+    });\n+  });\n \n   it('uses restore as the default strategy', async () => {\n     await expectExit(0, async () => {\n",
    "problem_statement": "Strapi Transfer CLI --force issue\n### Node Version\n\n20.15.0\n\n### NPM/Yarn/PNPM Version\n\nyarn 4.4.1\n\n### Strapi Version\n\n5.14.0\n\n### Operating System\n\nLinux (Debian/Ubuntu)\n\n### Database\n\nPostgreSQL\n\n### Javascript or Typescript\n\nTypescript\n\n### Reproduction URL\n\n_No response_\n\n### Bug Description\n\nHey guys. It seems that in version v5.14.0 the `--force` parameter of strapi transfer CLI is broken. Below is my CLI call with said parameter and correct `--from` and `--from-token` parameters. And it still prompts for the URL (and then token) even though they're passed through the call and the `--force` parameter is present.\n\n\n```\nrunner@fv-az720-478:~/work/redacted$ yarn strapi transfer \\\n--from https://valid-origin-url.com/admin \\\n--from-token 123-valid-token-123 \\\n--force \\\n--exclude files\u2028\n\u2139\ufe0f  No transfer configuration found in environment variables\n   \u2192 Add STRAPI_TRANSFER_URL and STRAPI_TRANSFER_TOKEN environment variables to make the transfer process faster for future runs\n? Enter the URL of the remote Strapi instance to send data to: \n```\n\nIt works the same way locally (MacOS m3 14.6) and on Github runner instance (Ubuntu 22.04).\nI think it might be related to the new transfer CLI feature from [this pr](https://github.com/strapi/strapi/pull/23421)\nAm I doing something wrong or is it a bug? It worked properly in v5.13. \n\n### Steps to Reproduce\n\n1. Run transfer command with `--from`, `--from-token` and `--force` parameters.\n2. Observe CLI prompts still appearing.\n\n### Expected Behavior\n\nTransfer going through. CLI not prompting for additional information.\n\n### Logs\n\n```shell\n\n```\n\n### Code Snippets\n\n_No response_\n\n### Media\n\n_No response_\n\n### Additional information\n\n_No response_\n\n### Confirmation Checklist\n\n- [x] I have checked the existing [issues](https://github.com/strapi/strapi/issues) for duplicates.\n- [x] I agree to follow this project's [Code of Conduct](https://github.com/strapi/strapi/blob/develop/CODE_OF_CONDUCT.md).\n",
    "direct_patch": true,
    "has_rewrites": false,
    "_file": "logs/bug_gen/strapi__strapi.main/pr_mirror/strapi__strapi-24879/metadata__pr_24879.json"
  },
  {
    "instance_id": "strapi__strapi-24918",
    "repo": "strapi/strapi",
    "pull_number": 24918,
    "base_commit": "29273b8e8a9a5aa635e5680190eda01f861431aa",
    "patch": "diff --git a/packages/core/content-type-builder/admin/src/components/AIChat/Chat.tsx b/packages/core/content-type-builder/admin/src/components/AIChat/Chat.tsx\nindex 0b344ad118ec..4d934adc0ffd 100644\n--- a/packages/core/content-type-builder/admin/src/components/AIChat/Chat.tsx\n+++ b/packages/core/content-type-builder/admin/src/components/AIChat/Chat.tsx\n@@ -340,6 +340,7 @@ const ChatInput = (props: React.FormHTMLAttributes<HTMLFormElement>) => {\n                 <IconButton\n                   label={t('chat.tooltips.send-message', 'Send')}\n                   variant=\"default\"\n+                  type=\"submit\"\n                   // allow sending an empty message if there are attachments\n                   disabled={input.trim().length === 0 && attachments.length === 0}\n                 >\ndiff --git a/packages/core/content-type-builder/admin/src/components/AIChat/components/Messages/Message.tsx b/packages/core/content-type-builder/admin/src/components/AIChat/components/Messages/Message.tsx\nindex 635122fb56c8..4d9b03d8f870 100644\n--- a/packages/core/content-type-builder/admin/src/components/AIChat/components/Messages/Message.tsx\n+++ b/packages/core/content-type-builder/admin/src/components/AIChat/components/Messages/Message.tsx\n@@ -19,6 +19,8 @@ import { Marker } from './Marker';\n const MarkdownStyles = styled(Typography)`\n   max-width: 65ch;\n   margin: 0 auto;\n+  overflow-wrap: anywhere;\n+  word-break: break-word;\n \n   h1,\n   h2,\n@@ -77,6 +79,11 @@ const MarkdownStyles = styled(Typography)`\n   }\n `;\n \n+const UserMessageTypography = styled(Typography)`\n+  overflow-wrap: anywhere;\n+  word-break: break-word;\n+`;\n+\n // ---------------------------\n // Tool: schemaGenerationTool helpers\n // ---------------------------\n@@ -195,7 +202,7 @@ const UserMessage = ({ message }: { message: UserMessageType }) => {\n         <Box background=\"neutral150\" borderStyle=\"none\" padding={['10px', '16px']} hasRadius>\n           {message.parts.map((content, index) => {\n             if (content.type !== 'text') return null;\n-            return <Typography key={index}>{content.text}</Typography>;\n+            return <UserMessageTypography key={index}>{content.text}</UserMessageTypography>;\n           })}\n         </Box>\n       ) : null}\n",
    "test_patch": "",
    "problem_statement": "",
    "direct_patch": true,
    "has_rewrites": false,
    "_file": "logs/bug_gen/strapi__strapi.main/pr_mirror/strapi__strapi-24918/metadata__pr_24918.json"
  },
  {
    "instance_id": "axios__axios.ef36347f.7206",
    "repo": "axios/axios",
    "pull_number": 7206,
    "base_commit": "ef36347f",
    "patch": "diff --git a/lib/adapters/http.js b/lib/adapters/http.js\nindex 524c278505..ccc89be66d 100755\n--- a/lib/adapters/http.js\n+++ b/lib/adapters/http.js\n@@ -858,6 +858,9 @@ export default isHttpAdapterSupported && function httpAdapter(config) {\n           req\n         ));\n       });\n+    } else {\n+      // explicitly reset the socket timeout value for a possible `keep-alive` request\n+      req.setTimeout(0);\n     }\n \n \n",
    "test_patch": "diff --git a/test/unit/adapters/http.js b/test/unit/adapters/http.js\nindex 6c4375a50b..864d29a3c5 100644\n--- a/test/unit/adapters/http.js\n+++ b/test/unit/adapters/http.js\n@@ -2682,6 +2682,21 @@ describe('supports http with nodejs', function () {\n       assert.strictEqual(await getStream(err.response.data), 'OK');\n     }\n   });\n+\n+  describe('keep-alive', () => {\n+    it('should not fail with \"socket hang up\" when using timeouts', async () => {\n+      server = await startHTTPServer(async (req, res) => {\n+        if (req.url === '/wait') {\n+          await new Promise(resolve => setTimeout(resolve, 5000));\n+        }\n+        res.end('ok');\n+      })\n+\n+      const baseURL = LOCAL_SERVER_URL;\n+      await axios.get('/1', {baseURL, timeout: 1000});\n+      await axios.get(`/wait`, {baseURL, timeout: 0});\n+    }, 15000);\n+  });\n });\n \n \n",
    "problem_statement": "HTTP Keep-alive, \"socket hang up\"  ECONNERR on a long-running second request\n### Describe the bug\r\n\r\nOn keep-alive connections, if a timeout value is given to the first request but not on subsequent requests, the subsequent requests will eventually throw a \"socket hang up\" error.\r\n\r\n### To Reproduce\r\n\r\n```js\r\nconst http = require('http');\r\nconst axios = require('axios');\r\n\r\ndescribe('socket hang up', () => {\r\n    let server;\r\n    beforeAll(done => {\r\n        server = http.createServer(async (req, res) => {\r\n            if (req.url === '/wait') {\r\n                await new Promise(resolve => setTimeout(resolve, 5000));\r\n            }\r\n            res.end('ok');\r\n        });\r\n        server.listen(3000, done);\r\n    });\r\n\r\n    afterAll(done => {\r\n        server.close(done);\r\n    });\r\n\r\n    it('will fail with \"socket hang up\"', async () => {\r\n        const baseURL = `http://localhost:3000`;\r\n        await axios.get('/1', {baseURL, timeout: 1000});\r\n        await axios.get(`/wait`, {baseURL, timeout: 0});\r\n    }, 15000);\r\n});\r\n```\r\n\r\n### Code snippet\r\n\r\n_No response_\r\n\r\n### Expected behavior\r\n\r\n1. \"socket hang up\" is misleading because it indicates the server closed the connection (in this bug the opposite is true)\r\n2. One would not expect that a timeout would keep running after a request has completed. This is a (quite major IMO) footgun.\r\n\r\n### Axios Version\r\n\r\n0.22.0 - 1.6.2\r\n\r\n### Adapter Version\r\n\r\nHTTP\r\n\r\n### Browser\r\n\r\n_No response_\r\n\r\n### Browser Version\r\n\r\n_No response_\r\n\r\n### Node.js Version\r\n\r\n20.9.0\r\n\r\n### OS\r\n\r\nOSX 14\r\n\r\n### Additional Library Versions\r\n\r\n_No response_\r\n\r\n### Additional context/Screenshots\r\n\r\n<img width=\"1456\" alt=\"tcpdump\" src=\"https://github.com/axios/axios/assets/100387231/a64c6544-4551-46ad-bb3e-1d9a6e9102b6\">\r\n\n",
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/axios__axios.ef36347f/pr_mirror/axios__axios.ef36347f.7206/metadata__pr_7206.json"
  },
  {
    "instance_id": "axios__axios.ef36347f.7202",
    "repo": "axios/axios",
    "pull_number": 7202,
    "base_commit": "ef36347f",
    "patch": "diff --git a/lib/adapters/http.js b/lib/adapters/http.js\nindex 4d2670cb7a..524c278505 100755\n--- a/lib/adapters/http.js\n+++ b/lib/adapters/http.js\n@@ -65,9 +65,9 @@ class Http2Sessions {\n       sessionTimeout: 1000\n     }, options);\n \n-    let authoritySessions;\n+    let authoritySessions = this.sessions[authority];\n \n-    if ((authoritySessions = this.sessions[authority])) {\n+    if (authoritySessions) {\n       let len = authoritySessions.length;\n \n       for (let i = 0; i < len; i++) {\n@@ -93,11 +93,12 @@ class Http2Sessions {\n \n       while (i--) {\n         if (entries[i][0] === session) {\n-          entries.splice(i, 1);\n           if (len === 1) {\n             delete this.sessions[authority];\n-            return;\n+          } else {\n+            entries.splice(i, 1);\n           }\n+          return;\n         }\n       }\n     };\n@@ -136,12 +137,12 @@ class Http2Sessions {\n \n     session.once('close', removeSession);\n \n-    let entries = this.sessions[authority], entry = [\n-      session,\n-      options\n-    ];\n+    let entry = [\n+        session,\n+        options\n+      ];\n \n-    entries ? this.sessions[authority].push(entry) : authoritySessions =  this.sessions[authority] = [entry];\n+    authoritySessions ? authoritySessions.push(entry) : authoritySessions =  this.sessions[authority] = [entry];\n \n     return session;\n   }\n",
    "test_patch": "",
    "problem_statement": "",
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/axios__axios.ef36347f/pr_mirror/axios__axios.ef36347f.7202/metadata__pr_7202.json"
  },
  {
    "instance_id": "axios__axios.ef36347f.7229",
    "repo": "axios/axios",
    "pull_number": 7229,
    "base_commit": "ef36347f",
    "patch": "diff --git a/lib/adapters/http.js b/lib/adapters/http.js\nindex 28d3d2bb64..dfa6386d32 100755\n--- a/lib/adapters/http.js\n+++ b/lib/adapters/http.js\n@@ -816,8 +816,6 @@ export default isHttpAdapterSupported && function httpAdapter(config) {\n \n     // Handle errors\n     req.on('error', function handleRequestError(err) {\n-      // @todo remove\n-      // if (req.aborted && err.code !== AxiosError.ERR_FR_TOO_MANY_REDIRECTS) return;\n       reject(AxiosError.from(err, null, config, req));\n     });\n \n",
    "test_patch": "",
    "problem_statement": "",
    "direct_patch": true,
    "has_rewrites": false,
    "_file": "logs/bug_gen/axios__axios.ef36347f/pr_mirror/axios__axios.ef36347f.7229/metadata__pr_7229.json"
  },
  {
    "instance_id": "hoppscotch__hoppscotch.main.5533",
    "repo": "hoppscotch/hoppscotch",
    "pull_number": 5533,
    "base_commit": "98f07f8a4c002926e24676af45067d911b589b58",
    "patch": "diff --git a/packages/hoppscotch-common/src/services/__tests__/workspace.service.spec.ts b/packages/hoppscotch-common/src/services/__tests__/workspace.service.spec.ts\nindex 6720df179e..7d049a39f2 100644\n--- a/packages/hoppscotch-common/src/services/__tests__/workspace.service.spec.ts\n+++ b/packages/hoppscotch-common/src/services/__tests__/workspace.service.spec.ts\n@@ -25,6 +25,18 @@ vi.mock(\"~/helpers/teams/TeamListAdapter\", () => ({\n   },\n }))\n \n+// Mock TeamCollectionsService to prevent i18n dependency issues\n+vi.mock(\"../team-collection.service\", () => ({\n+  TeamCollectionsService: class MockTeamCollectionsService {\n+    static readonly ID = \"TEAM_COLLECTIONS_SERVICE\"\n+\n+    changeTeamID = vi.fn()\n+    clearCollections = vi.fn()\n+\n+    onServiceInit = vi.fn()\n+  },\n+}))\n+\n describe(\"WorkspaceService\", () => {\n   const platformMock = {\n     auth: {\n@@ -239,4 +251,226 @@ describe(\"WorkspaceService\", () => {\n       expect(listAdapterMock.fetchList).not.toHaveBeenCalled()\n     })\n   })\n+\n+  describe(\"Team Collection Service Synchronization\", () => {\n+    it(\"should call changeTeamID when workspace changes to a team workspace\", async () => {\n+      const container = new TestContainer()\n+      const service = container.bind(WorkspaceService)\n+\n+      // Access the team collection service mock\n+      const teamCollectionServiceMock = (service as any).teamCollectionService\n+\n+      // Change to team workspace\n+      service.changeWorkspace({\n+        type: \"team\",\n+        teamID: \"team-123\",\n+        teamName: \"Test Team\",\n+        role: null,\n+      })\n+\n+      await nextTick()\n+\n+      expect(teamCollectionServiceMock.changeTeamID).toHaveBeenCalledWith(\n+        \"team-123\"\n+      )\n+    })\n+\n+    it(\"should call clearCollections when workspace changes to personal workspace\", async () => {\n+      const container = new TestContainer()\n+      const service = container.bind(WorkspaceService)\n+\n+      // Start with a team workspace\n+      service.changeWorkspace({\n+        type: \"team\",\n+        teamID: \"team-123\",\n+        teamName: \"Test Team\",\n+        role: null,\n+      })\n+\n+      await nextTick()\n+\n+      const teamCollectionServiceMock = (service as any).teamCollectionService\n+      teamCollectionServiceMock.clearCollections.mockClear()\n+\n+      // Change to personal workspace\n+      service.changeWorkspace({\n+        type: \"personal\",\n+      })\n+\n+      await nextTick()\n+\n+      expect(teamCollectionServiceMock.clearCollections).toHaveBeenCalled()\n+    })\n+\n+    it(\"should call clearCollections when workspace changes to team workspace without teamID\", async () => {\n+      const container = new TestContainer()\n+      const service = container.bind(WorkspaceService)\n+\n+      const teamCollectionServiceMock = (service as any).teamCollectionService\n+\n+      // Change to team workspace without teamID\n+      service.changeWorkspace({\n+        type: \"team\",\n+        teamID: \"\",\n+        teamName: \"Test Team\",\n+        role: null,\n+      })\n+\n+      await nextTick()\n+\n+      expect(teamCollectionServiceMock.clearCollections).toHaveBeenCalled()\n+    })\n+\n+    it(\"should not sync when workspaces are effectively the same\", async () => {\n+      const container = new TestContainer()\n+      const service = container.bind(WorkspaceService)\n+\n+      // Start with a team workspace\n+      service.changeWorkspace({\n+        type: \"team\",\n+        teamID: \"team-123\",\n+        teamName: \"Test Team\",\n+        role: null,\n+      })\n+\n+      await nextTick()\n+\n+      const teamCollectionServiceMock = (service as any).teamCollectionService\n+      teamCollectionServiceMock.changeTeamID.mockClear()\n+\n+      // Change to same team workspace (different name, same ID)\n+      service.changeWorkspace({\n+        type: \"team\",\n+        teamID: \"team-123\",\n+        teamName: \"Updated Team Name\",\n+        role: null,\n+      })\n+\n+      await nextTick()\n+\n+      // Should not call changeTeamID again since it's the same team\n+      expect(teamCollectionServiceMock.changeTeamID).not.toHaveBeenCalled()\n+    })\n+\n+    it(\"should handle errors during team collection service sync gracefully\", async () => {\n+      const container = new TestContainer()\n+      const service = container.bind(WorkspaceService)\n+\n+      const teamCollectionServiceMock = (service as any).teamCollectionService\n+      teamCollectionServiceMock.changeTeamID.mockImplementation(() => {\n+        throw new Error(\"Sync failed\")\n+      })\n+\n+      const consoleSpy = vi.spyOn(console, \"error\").mockImplementation(() => {})\n+\n+      // Change to team workspace (should not throw)\n+      expect(() => {\n+        service.changeWorkspace({\n+          type: \"team\",\n+          teamID: \"team-123\",\n+          teamName: \"Test Team\",\n+          role: null,\n+        })\n+      }).not.toThrow()\n+\n+      await nextTick()\n+\n+      expect(consoleSpy).toHaveBeenCalledWith(\n+        \"Failed to sync team collections:\",\n+        expect.any(Error)\n+      )\n+\n+      consoleSpy.mockRestore()\n+    })\n+  })\n+\n+  describe(\"areWorkspacesEqual\", () => {\n+    let service: WorkspaceService\n+\n+    beforeEach(() => {\n+      const container = new TestContainer()\n+      service = container.bind(WorkspaceService)\n+    })\n+\n+    it(\"should return false when newWorkspace is undefined\", () => {\n+      const result = (service as any).areWorkspacesEqual(undefined, {\n+        type: \"personal\",\n+      })\n+      expect(result).toBe(false)\n+    })\n+\n+    it(\"should return false when oldWorkspace is undefined\", () => {\n+      const result = (service as any).areWorkspacesEqual(\n+        { type: \"personal\" },\n+        undefined\n+      )\n+      expect(result).toBe(false)\n+    })\n+\n+    it(\"should return true when both workspaces are personal\", () => {\n+      const result = (service as any).areWorkspacesEqual(\n+        { type: \"personal\" },\n+        { type: \"personal\" }\n+      )\n+      expect(result).toBe(true)\n+    })\n+\n+    it(\"should return true when both workspaces are team workspaces with same teamID\", () => {\n+      const workspace1 = {\n+        type: \"team\",\n+        teamID: \"team-123\",\n+        teamName: \"Team A\",\n+        role: null,\n+      }\n+      const workspace2 = {\n+        type: \"team\",\n+        teamID: \"team-123\",\n+        teamName: \"Team A Updated\",\n+        role: null,\n+      }\n+\n+      const result = (service as any).areWorkspacesEqual(workspace1, workspace2)\n+      expect(result).toBe(true)\n+    })\n+\n+    it(\"should return false when team workspaces have different teamIDs\", () => {\n+      const workspace1 = {\n+        type: \"team\",\n+        teamID: \"team-123\",\n+        teamName: \"Team A\",\n+        role: null,\n+      }\n+      const workspace2 = {\n+        type: \"team\",\n+        teamID: \"team-456\",\n+        teamName: \"Team B\",\n+        role: null,\n+      }\n+\n+      const result = (service as any).areWorkspacesEqual(workspace1, workspace2)\n+      expect(result).toBe(false)\n+    })\n+\n+    it(\"should return false when one is personal and other is team workspace\", () => {\n+      const personalWorkspace = { type: \"personal\" }\n+      const teamWorkspace = {\n+        type: \"team\",\n+        teamID: \"team-123\",\n+        teamName: \"Team A\",\n+        role: null,\n+      }\n+\n+      const result1 = (service as any).areWorkspacesEqual(\n+        personalWorkspace,\n+        teamWorkspace\n+      )\n+      const result2 = (service as any).areWorkspacesEqual(\n+        teamWorkspace,\n+        personalWorkspace\n+      )\n+\n+      expect(result1).toBe(false)\n+      expect(result2).toBe(false)\n+    })\n+  })\n })\ndiff --git a/packages/hoppscotch-common/src/services/team-collection.service.ts b/packages/hoppscotch-common/src/services/team-collection.service.ts\nindex 0fcca76f5e..3ead4e43ec 100644\n--- a/packages/hoppscotch-common/src/services/team-collection.service.ts\n+++ b/packages/hoppscotch-common/src/services/team-collection.service.ts\n@@ -31,7 +31,6 @@ import { TeamCollection } from \"~/helpers/teams/TeamCollection\"\n import { TeamRequest } from \"~/helpers/teams/TeamRequest\"\n import { runGQLQuery, runGQLSubscription } from \"~/helpers/backend/GQLClient\"\n import { HoppInheritedProperty } from \"~/helpers/types/HoppInheritedProperties\"\n-import { WorkspaceService } from \"./workspace.service\"\n import { ref, watch } from \"vue\"\n import { Service } from \"dioc\"\n import { updateInheritedPropertiesForAffectedRequests } from \"~/helpers/collection/collection\"\n@@ -139,8 +138,6 @@ export class TeamCollectionsService extends Service<void> {\n   private secretEnvironmentService = this.bind(SecretEnvironmentService)\n   private currentEnvironmentValueService = this.bind(CurrentValueService)\n \n-  private workspaceService = this.bind(WorkspaceService)\n-\n   private teamID: string | null = null\n \n   public collections = ref<TeamCollection[]>([])\n@@ -176,20 +173,13 @@ export class TeamCollectionsService extends Service<void> {\n   private teamChildCollectionSortedSub: WSubscription | null = null\n \n   override onServiceInit() {\n-    // Watch for team change and update the collections accordingly\n-    watch(\n-      () => this.workspaceService.currentWorkspace,\n-      (workspace) => {\n-        if (workspace.value.type === \"team\" && workspace.value.teamID) {\n-          this.changeTeamID(workspace.value.teamID)\n-        } else {\n-          this.clearCollections()\n-        }\n-      },\n-      { immediate: true, deep: true }\n-    )\n+    this.collectionLoadingWatcher()\n+  }\n \n-    // Watch for completion of loading (when all loading flags are cleared) to update inherited properties once\n+  /**\n+   * Watches for loading collections and updates inherited properties once loading is done\n+   */\n+  private collectionLoadingWatcher() {\n     watch(\n       () => this.loadingCollections.value.length,\n       (loadingCount) => {\n@@ -208,7 +198,11 @@ export class TeamCollectionsService extends Service<void> {\n     )\n   }\n \n-  changeTeamID(newTeamID: string | null) {\n+  /**\n+   * Change the current team ID and resets the collections\n+   * @param newTeamID The new team ID to switch to\n+   */\n+  public changeTeamID(newTeamID: string | null) {\n     this.teamID = newTeamID\n     this.collections.value = []\n     this.entityIDs.clear()\n@@ -220,6 +214,17 @@ export class TeamCollectionsService extends Service<void> {\n     if (this.teamID) this.initialize()\n   }\n \n+  /**\n+   * Clears all collections and resets the service state\n+   */\n+  public clearCollections() {\n+    this.collections.value = []\n+    this.entityIDs.clear()\n+    this.loadingCollections.value = []\n+    this.unsubscribeSubscriptions()\n+    this.teamID = null\n+  }\n+\n   /**\n    * Unsubscribes from the subscriptions\n    * NOTE: Once this is called, no new updates to the tree will be detected\n@@ -292,14 +297,6 @@ export class TeamCollectionsService extends Service<void> {\n     this.collections.value = tree\n   }\n \n-  private clearCollections() {\n-    this.collections.value = []\n-    this.entityIDs.clear()\n-    this.loadingCollections.value = []\n-    this.unsubscribeSubscriptions()\n-    this.teamID = null\n-  }\n-\n   /**\n    * Loads the root collections of the current team\n    * @param replace Whether to replace the existing collections or append to them\ndiff --git a/packages/hoppscotch-common/src/services/workspace.service.ts b/packages/hoppscotch-common/src/services/workspace.service.ts\nindex bcf67c14a8..7bd3dbcb85 100644\n--- a/packages/hoppscotch-common/src/services/workspace.service.ts\n+++ b/packages/hoppscotch-common/src/services/workspace.service.ts\n@@ -6,6 +6,7 @@ import TeamListAdapter from \"~/helpers/teams/TeamListAdapter\"\n import { platform } from \"~/platform\"\n import { min } from \"lodash-es\"\n import { TeamAccessRole } from \"~/helpers/backend/graphql\"\n+import { TeamCollectionsService } from \"./team-collection.service\"\n \n /**\n  * Defines a workspace and its information\n@@ -45,6 +46,8 @@ export class WorkspaceService extends Service<WorkspaceServiceEvent> {\n   private teamListAdapterLockTicker = 0 // Used to generate unique lock IDs\n   private managedTeamListAdapter = new TeamListAdapter(true, false)\n \n+  private teamCollectionService = this.bind(TeamCollectionsService)\n+\n   private currentUser = useStreamStatic(\n     platform.auth.getCurrentUserStream(),\n     platform.auth.getCurrentUser(),\n@@ -101,6 +104,59 @@ export class WorkspaceService extends Service<WorkspaceServiceEvent> {\n       },\n       { immediate: true }\n     )\n+\n+    // Watch for workspace changes and update team collection service accordingly\n+    this.setupTeamCollectionServiceSync()\n+  }\n+\n+  /**\n+   * Sets up synchronization with team collection service\n+   * This ensures team collections are updated when workspace changes\n+   */\n+  private setupTeamCollectionServiceSync() {\n+    watch(\n+      this._currentWorkspace,\n+      (newWorkspace, oldWorkspace) => {\n+        // Skip update if workspaces are effectively the same\n+        if (this.areWorkspacesEqual(newWorkspace, oldWorkspace)) return\n+\n+        try {\n+          if (newWorkspace.type === \"team\" && newWorkspace.teamID) {\n+            this.teamCollectionService.changeTeamID(newWorkspace.teamID)\n+          } else {\n+            this.teamCollectionService.clearCollections()\n+          }\n+        } catch (error) {\n+          console.error(\"Failed to sync team collections:\", error)\n+        }\n+      },\n+      { immediate: true }\n+    )\n+  }\n+\n+  /**\n+   * Checks if two workspaces are effectively equal to avoid unnecessary updates\n+   *\n+   * Note: Vue's watch API provides `undefined` as `oldValue` on the first callback\n+   * invocation when using `{ immediate: true }`, since there is no previous value yet.\n+   * This is why `oldWorkspace` has an optional type, while `newWorkspace` is always defined.\n+   */\n+  private areWorkspacesEqual(\n+    newWorkspace: Workspace,\n+    oldWorkspace?: Workspace\n+  ): boolean {\n+    if (!newWorkspace || !oldWorkspace) return false\n+\n+    // Both are personal workspaces\n+    if (newWorkspace.type === \"personal\" && oldWorkspace.type === \"personal\")\n+      return true\n+\n+    // Team workspaces are equal only if they share the same team ID\n+    return (\n+      newWorkspace.type === \"team\" &&\n+      oldWorkspace.type === \"team\" &&\n+      newWorkspace.teamID === oldWorkspace.teamID\n+    )\n   }\n \n   // TODO: Update this function, its existence is pretty weird\n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/hoppscotch__hoppscotch.main/pr_mirror/hoppscotch__hoppscotch.main.5533/metadata__pr_5533.json"
  },
  {
    "instance_id": "hoppscotch__hoppscotch.main.5363",
    "repo": "hoppscotch/hoppscotch",
    "pull_number": 5363,
    "base_commit": "aac4c5b34b833b3bf463d20091c903c645de533c",
    "patch": "diff --git a/packages/hoppscotch-backend/src/team/team.service.spec.ts b/packages/hoppscotch-backend/src/team/team.service.spec.ts\nindex 44954535001..5fa2e2ffd4f 100644\n--- a/packages/hoppscotch-backend/src/team/team.service.spec.ts\n+++ b/packages/hoppscotch-backend/src/team/team.service.spec.ts\n@@ -361,8 +361,8 @@ describe('renameTeam', () => {\n     ).resolves.toEqualLeft(TEAM_INVALID_ID);\n   });\n \n-  test('rejects for new team name length < 6 with TEAM_NAME_INVALID', () => {\n-    const newTeamName = 'smol';\n+  test('rejects for new team name empty with TEAM_NAME_INVALID', () => {\n+    const newTeamName = '';\n \n     // Prisma doesn't care about the team name length, so it will resolve\n     mockPrisma.team.update.mockResolvedValue({\n@@ -668,8 +668,8 @@ describe('createTeam', () => {\n     ).resolves.toEqualRight(expect.objectContaining(team));\n   });\n \n-  test('rejects for team name length < 6 with TEAM_NAME_INVALID', () => {\n-    const newName = 'smol';\n+  test('rejects for team name empty with TEAM_NAME_INVALID', () => {\n+    const newName = '';\n \n     // Prisma doesn't care\n     mockPrisma.team.create.mockResolvedValue({\ndiff --git a/packages/hoppscotch-backend/src/team/team.service.ts b/packages/hoppscotch-backend/src/team/team.service.ts\nindex 96d3112e7a0..11ea9613fdf 100644\n--- a/packages/hoppscotch-backend/src/team/team.service.ts\n+++ b/packages/hoppscotch-backend/src/team/team.service.ts\n@@ -124,7 +124,7 @@ export class TeamService implements UserDataHandler, OnModuleInit {\n   }\n \n   validateTeamName(title: string): E.Left<string> | E.Right<boolean> {\n-    if (!title || title.length < 6) return E.left(TEAM_NAME_INVALID);\n+    if (!title || title.trim() === '') return E.left(TEAM_NAME_INVALID);\n     return E.right(true);\n   }\n \ndiff --git a/packages/hoppscotch-common/locales/en.json b/packages/hoppscotch-common/locales/en.json\nindex e5527b1caa4..7c4c60cfc53 100644\n--- a/packages/hoppscotch-common/locales/en.json\n+++ b/packages/hoppscotch-common/locales/en.json\n@@ -1521,7 +1521,7 @@\n     \"member_role_updated\": \"User roles updated\",\n     \"members\": \"Members\",\n     \"more_members\": \"+{count} more\",\n-    \"name_length_insufficient\": \"Workspace name should be at least 6 characters long\",\n+    \"name_length_insufficient\": \"Workspace name should not be empty\",\n     \"name_updated\": \"Workspace name updated\",\n     \"new\": \"New Workspace\",\n     \"new_created\": \"New workspace created\",\ndiff --git a/packages/hoppscotch-common/src/helpers/backend/types/TeamName.ts b/packages/hoppscotch-common/src/helpers/backend/types/TeamName.ts\nindex bbcdb6c0af8..26182eca31b 100644\n--- a/packages/hoppscotch-common/src/helpers/backend/types/TeamName.ts\n+++ b/packages/hoppscotch-common/src/helpers/backend/types/TeamName.ts\n@@ -6,7 +6,7 @@ interface TeamNameBrand {\n \n export const TeamNameCodec = t.brand(\n   t.string,\n-  (x): x is t.Branded<string, TeamNameBrand> => x.trim().length >= 6,\n+  (x): x is t.Branded<string, TeamNameBrand> => x.trim() !== \"\",\n   \"TeamName\"\n )\n \n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/hoppscotch__hoppscotch.main/pr_mirror/hoppscotch__hoppscotch.main.5363/metadata__pr_5363.json"
  },
  {
    "instance_id": "hoppscotch__hoppscotch.main.5624",
    "repo": "hoppscotch/hoppscotch",
    "pull_number": 5624,
    "base_commit": "217563e7ddf63ef83eea2b27762ea0d2113b8d2e",
    "patch": "diff --git a/packages/hoppscotch-backend/src/published-docs/published-docs.resolver.ts b/packages/hoppscotch-backend/src/published-docs/published-docs.resolver.ts\nindex 0f038bd6ba..11e72ec2c8 100644\n--- a/packages/hoppscotch-backend/src/published-docs/published-docs.resolver.ts\n+++ b/packages/hoppscotch-backend/src/published-docs/published-docs.resolver.ts\n@@ -34,6 +34,7 @@ export class PublishedDocsResolver {\n \n   @ResolveField(() => User, {\n     description: 'Returns the creator of the published document',\n+    nullable: true,\n   })\n   async creator(@Parent() publishedDocs: PublishedDocs): Promise<User> {\n     const creator = await this.publishedDocsService.getPublishedDocsCreator(\n@@ -41,11 +42,7 @@ export class PublishedDocsResolver {\n     );\n \n     if (E.isLeft(creator)) throwErr(creator.left);\n-    return {\n-      ...creator.right,\n-      currentGQLSession: JSON.stringify(creator.right.currentGQLSession),\n-      currentRESTSession: JSON.stringify(creator.right.currentRESTSession),\n-    };\n+    return creator.right;\n   }\n \n   @ResolveField(() => PublishedDocsCollection, {\ndiff --git a/packages/hoppscotch-backend/src/published-docs/published-docs.service.spec.ts b/packages/hoppscotch-backend/src/published-docs/published-docs.service.spec.ts\nindex 624517fb83..e532eb6194 100644\n--- a/packages/hoppscotch-backend/src/published-docs/published-docs.service.spec.ts\n+++ b/packages/hoppscotch-backend/src/published-docs/published-docs.service.spec.ts\n@@ -47,8 +47,8 @@ const user: User = {\n   lastLoggedOn: currentTime,\n   lastActiveOn: currentTime,\n   createdOn: currentTime,\n-  currentGQLSession: JSON.stringify({}),\n-  currentRESTSession: JSON.stringify({}),\n+  currentGQLSession: {} as any,\n+  currentRESTSession: {} as any,\n };\n \n const userPublishedDoc: DBPublishedDocs = {\n@@ -179,6 +179,9 @@ describe('getPublishedDocByID', () => {\n describe('getAllUserPublishedDocs', () => {\n   test('should return a list of user published documents with pagination', async () => {\n     mockPrisma.publishedDocs.findMany.mockResolvedValueOnce([userPublishedDoc]);\n+    mockPrisma.userCollection.findMany.mockResolvedValueOnce([\n+      { id: 'collection_1' },\n+    ] as any);\n \n     const result = await publishedDocsService.getAllUserPublishedDocs(\n       user.uid,\n@@ -190,6 +193,7 @@ describe('getAllUserPublishedDocs', () => {\n \n   test('should return an empty array when no documents found', async () => {\n     mockPrisma.publishedDocs.findMany.mockResolvedValueOnce([]);\n+    mockPrisma.userCollection.findMany.mockResolvedValueOnce([]);\n \n     const result = await publishedDocsService.getAllUserPublishedDocs(\n       user.uid,\n@@ -201,6 +205,9 @@ describe('getAllUserPublishedDocs', () => {\n   test('should return paginated results correctly', async () => {\n     const docs = [userPublishedDoc, { ...userPublishedDoc, id: 'pub_doc_3' }];\n     mockPrisma.publishedDocs.findMany.mockResolvedValueOnce([docs[0]]);\n+    mockPrisma.userCollection.findMany.mockResolvedValueOnce([\n+      { id: 'collection_1' },\n+    ] as any);\n \n     const result = await publishedDocsService.getAllUserPublishedDocs(\n       user.uid,\n@@ -208,11 +215,94 @@ describe('getAllUserPublishedDocs', () => {\n     );\n     expect(result).toHaveLength(1);\n   });\n+\n+  test('should filter out published docs with non-existent collections', async () => {\n+    const doc1 = {\n+      ...userPublishedDoc,\n+      id: 'pub_doc_1',\n+      collectionID: 'collection_1',\n+    };\n+    const doc2 = {\n+      ...userPublishedDoc,\n+      id: 'pub_doc_2',\n+      collectionID: 'collection_2',\n+    };\n+    const doc3 = {\n+      ...userPublishedDoc,\n+      id: 'pub_doc_3',\n+      collectionID: 'collection_3',\n+    };\n+\n+    mockPrisma.publishedDocs.findMany.mockResolvedValueOnce([doc1, doc2, doc3]);\n+    // Only collection_1 and collection_3 exist\n+    mockPrisma.userCollection.findMany.mockResolvedValueOnce([\n+      { id: 'collection_1' },\n+      { id: 'collection_3' },\n+    ] as any);\n+\n+    const result = await publishedDocsService.getAllUserPublishedDocs(\n+      user.uid,\n+      { skip: 0, take: 10 },\n+    );\n+\n+    // Should only return docs with existing collections\n+    expect(result).toHaveLength(2);\n+    expect(result.map((d) => d.id)).toEqual(['pub_doc_1', 'pub_doc_3']);\n+  });\n+\n+  test('should delete published docs with non-existent collections', async () => {\n+    const doc1 = {\n+      ...userPublishedDoc,\n+      id: 'pub_doc_1',\n+      collectionID: 'collection_1',\n+    };\n+    const doc2 = {\n+      ...userPublishedDoc,\n+      id: 'pub_doc_2',\n+      collectionID: 'collection_deleted',\n+    };\n+\n+    mockPrisma.publishedDocs.findMany.mockResolvedValueOnce([doc1, doc2]);\n+    mockPrisma.userCollection.findMany.mockResolvedValueOnce([\n+      { id: 'collection_1' },\n+    ] as any);\n+    mockPrisma.publishedDocs.deleteMany.mockResolvedValueOnce({\n+      count: 1,\n+    } as any);\n+\n+    await publishedDocsService.getAllUserPublishedDocs(user.uid, {\n+      skip: 0,\n+      take: 10,\n+    });\n+\n+    expect(mockPrisma.publishedDocs.deleteMany).toHaveBeenCalledWith({\n+      where: {\n+        id: { in: ['pub_doc_2'] },\n+      },\n+    });\n+  });\n+\n+  test('should not call deleteMany when all collections exist', async () => {\n+    mockPrisma.publishedDocs.findMany.mockResolvedValueOnce([userPublishedDoc]);\n+    mockPrisma.userCollection.findMany.mockResolvedValueOnce([\n+      { id: 'collection_1' },\n+    ] as any);\n+\n+    await publishedDocsService.getAllUserPublishedDocs(user.uid, {\n+      skip: 0,\n+      take: 10,\n+    });\n+\n+    expect(mockPrisma.publishedDocs.deleteMany).not.toHaveBeenCalled();\n+  });\n });\n \n describe('getAllTeamPublishedDocs', () => {\n   test('should return a list of team published documents with pagination', async () => {\n     mockPrisma.publishedDocs.findMany.mockResolvedValueOnce([teamPublishedDoc]);\n+    mockPrisma.teamCollection.findMany.mockResolvedValueOnce([\n+      { id: 'team_collection_1' },\n+    ] as any);\n \n     const result = await publishedDocsService.getAllTeamPublishedDocs(\n       'team_1',\n@@ -225,6 +315,7 @@ describe('getAllTeamPublishedDocs', () => {\n \n   test('should return an empty array when no team documents found', async () => {\n     mockPrisma.publishedDocs.findMany.mockResolvedValueOnce([]);\n+    mockPrisma.teamCollection.findMany.mockResolvedValueOnce([]);\n \n     const result = await publishedDocsService.getAllTeamPublishedDocs(\n       'team_1',\n@@ -236,6 +327,9 @@ describe('getAllTeamPublishedDocs', () => {\n \n   test('should filter by teamID and collectionID correctly', async () => {\n     mockPrisma.publishedDocs.findMany.mockResolvedValueOnce([teamPublishedDoc]);\n+    mockPrisma.teamCollection.findMany.mockResolvedValueOnce([\n+      { id: 'team_collection_1' },\n+    ] as any);\n \n     await publishedDocsService.getAllTeamPublishedDocs(\n       'team_1',\n@@ -256,6 +350,88 @@ describe('getAllTeamPublishedDocs', () => {\n       },\n     });\n   });\n+\n+  test('should filter out published docs with non-existent team collections', async () => {\n+    const doc1 = {\n+      ...teamPublishedDoc,\n+      id: 'pub_doc_1',\n+      collectionID: 'team_collection_1',\n+    };\n+    const doc2 = {\n+      ...teamPublishedDoc,\n+      id: 'pub_doc_2',\n+      collectionID: 'team_collection_2',\n+    };\n+    const doc3 = {\n+      ...teamPublishedDoc,\n+      id: 'pub_doc_3',\n+      collectionID: 'team_collection_3',\n+    };\n+\n+    mockPrisma.publishedDocs.findMany.mockResolvedValueOnce([doc1, doc2, doc3]);\n+    // Only team_collection_1 and team_collection_3 exist\n+    mockPrisma.teamCollection.findMany.mockResolvedValueOnce([\n+      { id: 'team_collection_1' },\n+      { id: 'team_collection_3' },\n+    ] as any);\n+\n+    const result = await publishedDocsService.getAllTeamPublishedDocs(\n+      'team_1',\n+      undefined,\n+      { skip: 0, take: 10 },\n+    );\n+\n+    // Should only return docs with existing collections\n+    expect(result).toHaveLength(2);\n+    expect(result.map((d) => d.id)).toEqual(['pub_doc_1', 'pub_doc_3']);\n+  });\n+\n+  test('should delete published docs with non-existent team collections', async () => {\n+    const doc1 = {\n+      ...teamPublishedDoc,\n+      id: 'pub_doc_1',\n+      collectionID: 'team_collection_1',\n+    };\n+    const doc2 = {\n+      ...teamPublishedDoc,\n+      id: 'pub_doc_2',\n+      collectionID: 'team_collection_deleted',\n+    };\n+\n+    mockPrisma.publishedDocs.findMany.mockResolvedValueOnce([doc1, doc2]);\n+    mockPrisma.teamCollection.findMany.mockResolvedValueOnce([\n+      { id: 'team_collection_1' },\n+    ] as any);\n+    mockPrisma.publishedDocs.deleteMany.mockResolvedValueOnce({\n+      count: 1,\n+    } as any);\n+\n+    await publishedDocsService.getAllTeamPublishedDocs('team_1', undefined, {\n+      skip: 0,\n+      take: 10,\n+    });\n+\n+    expect(mockPrisma.publishedDocs.deleteMany).toHaveBeenCalledWith({\n+      where: {\n+        id: { in: ['pub_doc_2'] },\n+      },\n+    });\n+  });\n+\n+  test('should not call deleteMany when all team collections exist', async () => {\n+    mockPrisma.publishedDocs.findMany.mockResolvedValueOnce([teamPublishedDoc]);\n+    mockPrisma.teamCollection.findMany.mockResolvedValueOnce([\n+      { id: 'team_collection_1' },\n+    ] as any);\n+\n+    await publishedDocsService.getAllTeamPublishedDocs(\n+      'team_1',\n+      'team_collection_1',\n+      { skip: 0, take: 10 },\n+    );\n+\n+    expect(mockPrisma.publishedDocs.deleteMany).not.toHaveBeenCalled();\n+  });\n });\n \n describe('createPublishedDoc', () => {\n@@ -650,7 +826,14 @@ describe('getPublishedDocsCreator', () => {\n     const result = await publishedDocsService.getPublishedDocsCreator(\n       userPublishedDoc.id,\n     );\n-    expect(result).toEqualRight(user);\n+\n+    const expectedUser = {\n+      ...user,\n+      currentGQLSession: JSON.stringify(user.currentGQLSession),\n+      currentRESTSession: JSON.stringify(user.currentRESTSession),\n+    };\n+\n+    expect(result).toEqualRight(expectedUser);\n   });\n \n   test('should throw PUBLISHED_DOCS_NOT_FOUND when document ID is invalid', async () => {\ndiff --git a/packages/hoppscotch-backend/src/published-docs/published-docs.service.ts b/packages/hoppscotch-backend/src/published-docs/published-docs.service.ts\nindex 215e2fcc7c..43e5001f64 100644\n--- a/packages/hoppscotch-backend/src/published-docs/published-docs.service.ts\n+++ b/packages/hoppscotch-backend/src/published-docs/published-docs.service.ts\n@@ -14,8 +14,9 @@ import {\n   PUBLISHED_DOCS_INVALID_COLLECTION,\n   PUBLISHED_DOCS_NOT_FOUND,\n   PUBLISHED_DOCS_UPDATE_FAILED,\n+  TEAM_INVALID_COLL_ID,\n   TEAM_INVALID_ID,\n-  USERS_NOT_FOUND,\n+  USER_COLL_NOT_FOUND,\n } from 'src/errors';\n import * as E from 'fp-ts/Either';\n import { PublishedDocs } from './published-docs.model';\n@@ -155,9 +156,16 @@ export class PublishedDocsService {\n     const user = await this.prisma.user.findUnique({\n       where: { uid: publishedDocs.creatorUid },\n     });\n-    if (!user) return E.left(USERS_NOT_FOUND);\n \n-    return E.right(user);\n+    const creator = user\n+      ? {\n+          ...user,\n+          currentGQLSession: JSON.stringify(user.currentGQLSession),\n+          currentRESTSession: JSON.stringify(user.currentRESTSession),\n+        }\n+      : null;\n+\n+    return E.right(creator);\n   }\n \n   /**\n@@ -235,7 +243,20 @@ export class PublishedDocsService {\n               query.tree === TreeLevel.FULL,\n             );\n \n-      if (E.isLeft(collectionResult)) return E.left(collectionResult.left);\n+      if (E.isLeft(collectionResult)) {\n+        // Delete the published doc if its collection is missing\n+        const isCollectionNotFound =\n+          collectionResult.left === USER_COLL_NOT_FOUND ||\n+          collectionResult.left === TEAM_INVALID_COLL_ID;\n+\n+        if (isCollectionNotFound) {\n+          await this.prisma.publishedDocs.delete({\n+            where: { id: publishedDocs.id },\n+          });\n+        }\n+\n+        return E.left(collectionResult.left);\n+      }\n \n       return E.right(\n         this.cast({\n@@ -248,6 +269,26 @@ export class PublishedDocsService {\n     return E.right(this.cast(publishedDocs));\n   }\n \n+  /**\n+   * Cleanup orphaned published documents whose collections no longer exist\n+   */\n+  private async cleanupOrphanedPublishedDocs<\n+    T extends { id: string; collectionID: string },\n+  >(docs: T[], existingCollectionIDs: Set<string>): Promise<T[]> {\n+    const docsToDelete = docs.filter(\n+      (doc) => !existingCollectionIDs.has(doc.collectionID),\n+    );\n+\n+    if (docsToDelete.length > 0) {\n+      const idsToDelete = docsToDelete.map((doc) => doc.id);\n+      this.prisma.publishedDocs.deleteMany({\n+        where: { id: { in: idsToDelete } },\n+      });\n+    }\n+\n+    return docs.filter((doc) => existingCollectionIDs.has(doc.collectionID));\n+  }\n+\n   /**\n    * Get all published documents for a user with pagination\n    * @param userUid - The UID of the user\n@@ -266,7 +307,29 @@ export class PublishedDocsService {\n       },\n     });\n \n-    return docs.map((doc) => this.cast(doc));\n+    if (docs.length === 0) return [];\n+\n+    // Cross-check if all collections exist\n+    const collectionIDs = docs.map((doc) => doc.collectionID);\n+    const existingCollections = await this.prisma.userCollection.findMany({\n+      where: {\n+        id: { in: collectionIDs },\n+        userUid,\n+      },\n+      select: { id: true },\n+    });\n+\n+    const existingCollectionIDs = new Set(\n+      existingCollections.map((col) => col.id),\n+    );\n+\n+    const validDocs = await this.cleanupOrphanedPublishedDocs<DbPublishedDocs>(\n+      docs,\n+      existingCollectionIDs,\n+    );\n+\n+    // Return only docs with existing collections\n+    return validDocs.map((doc) => this.cast(doc));\n   }\n \n   /**\n@@ -290,7 +353,29 @@ export class PublishedDocsService {\n       },\n     });\n \n-    return docs.map((doc) => this.cast(doc));\n+    if (docs.length === 0) return [];\n+\n+    // Cross-check if all collections exist\n+    const collectionIDs = docs.map((doc) => doc.collectionID);\n+    const existingCollections = await this.prisma.teamCollection.findMany({\n+      where: {\n+        id: { in: collectionIDs },\n+        teamID,\n+      },\n+      select: { id: true },\n+    });\n+\n+    const existingCollectionIDs = new Set(\n+      existingCollections.map((col) => col.id),\n+    );\n+\n+    const validDocs = await this.cleanupOrphanedPublishedDocs<DbPublishedDocs>(\n+      docs,\n+      existingCollectionIDs,\n+    );\n+\n+    // Return only docs with existing collections\n+    return validDocs.map((doc) => this.cast(doc));\n   }\n \n   /**\ndiff --git a/packages/hoppscotch-backend/src/user-collection/user-collection.service.ts b/packages/hoppscotch-backend/src/user-collection/user-collection.service.ts\nindex 5d89c04b88..270c441b0f 100644\n--- a/packages/hoppscotch-backend/src/user-collection/user-collection.service.ts\n+++ b/packages/hoppscotch-backend/src/user-collection/user-collection.service.ts\n@@ -40,7 +40,6 @@ import {\n import { CollectionFolder } from 'src/types/CollectionFolder';\n import { PrismaError } from 'src/prisma/prisma-error-codes';\n import { SortOptions } from 'src/types/SortOptions';\n-import { UserRequest } from 'src/user-request/user-request.model';\n \n @Injectable()\n export class UserCollectionService {\n",
    "test_patch": null,
    "problem_statement": null,
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/hoppscotch__hoppscotch.main/pr_mirror/hoppscotch__hoppscotch.main.5624/metadata__pr_5624.json"
  },
  {
    "instance_id": "payloadcms__payload.053256d5.14819",
    "repo": "payloadcms/payload",
    "pull_number": 14819,
    "base_commit": "053256d5cef6411bc29b9a69be0b2b62d5397c40",
    "patch": "diff --git a/packages/ui/src/elements/SelectMany/index.tsx b/packages/ui/src/elements/SelectMany/index.tsx\nindex 4ac67b0614e..0124705a130 100644\n--- a/packages/ui/src/elements/SelectMany/index.tsx\n+++ b/packages/ui/src/elements/SelectMany/index.tsx\n@@ -1,7 +1,7 @@\n import React from 'react'\n \n import { useSelection } from '../../providers/Selection/index.js'\n-// import { useTranslation } from '../../providers/Translation/index.js'\n+import { useTranslation } from '../../providers/Translation/index.js'\n import { Pill } from '../Pill/index.js'\n \n export const SelectMany: React.FC<{\n@@ -10,7 +10,7 @@ export const SelectMany: React.FC<{\n   const { onClick } = props\n \n   const { count, selected } = useSelection()\n-  // const { t } = useTranslation()\n+  const { t } = useTranslation()\n \n   if (!selected || !count) {\n     return null\n@@ -18,7 +18,6 @@ export const SelectMany: React.FC<{\n \n   return (\n     <Pill\n-      // className={`${baseClass}__toggle`}\n       onClick={() => {\n         if (typeof onClick === 'function') {\n           onClick(selected)\n@@ -27,7 +26,7 @@ export const SelectMany: React.FC<{\n       pillStyle=\"white\"\n       size=\"small\"\n     >\n-      {`Select ${count}`}\n+      {t('general:select')} {count}\n     </Pill>\n   )\n }\n",
    "test_patch": "",
    "problem_statement": "UI Elements - SelectMany useTranslation\n### Describe the Bug.\n\nThe SelectMany field in Payload CMS currently does not support translations.\n\n<img width=\"829\" height=\"326\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/045db6c1-a8c2-45a7-a707-fc359175875f\" />\n\n### Reproduction Steps\n\nCurrently, the SelectMany element does not support translations.\nAfter checking the file node_modules/@payloadcms/ui/dist/elements/SelectMany/index.js, I noticed that useTranslation was previously included but is now commented out. It would be great if translation support could be properly implemented in a future release.\n\nIs it possible to fix this in the next update?\n\n<img width=\"752\" height=\"625\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/11ffbd2d-e21e-4fd3-8f99-1a474d81da6f\" />\n\n### Environment Info\n\n```text\nBinaries:\n  Node: 23.5.0\n  npm: 11.3.0\n  Yarn: 1.22.22\n  pnpm: 10.22.0\nRelevant Packages:\n  payload: 3.66.0\n  next: 15.4.8\n  @payloadcms/db-postgres: 3.66.0\n  @payloadcms/drizzle: 3.64.0\n  @payloadcms/graphql: 3.64.0\n  @payloadcms/live-preview: 3.65.0\n  @payloadcms/live-preview-react: 3.66.0\n  @payloadcms/next/utilities: 3.66.0\n  @payloadcms/plugin-form-builder: 3.66.0\n  @payloadcms/plugin-nested-docs: 3.66.0\n  @payloadcms/plugin-redirects: 3.66.0\n  @payloadcms/plugin-search: 3.66.0\n  @payloadcms/plugin-seo: 3.66.0\n  @payloadcms/richtext-lexical: 3.66.0\n  @payloadcms/translations: 3.66.0\n  @payloadcms/ui/shared: 3.66.0\n  react: 19.2.1\n  react-dom: 19.1.0\nOperating System:\n  Platform: linux\n  Arch: x64\n  Version: #173-Ubuntu SMP Tue Oct 14 17:51:00 UTC 2025\n  Available memory (MB): 31930\n  Available CPU cores: 28\n```\n",
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/payloadcms__payload.053256d5/pr_mirror/payloadcms__payload.053256d5.14819/metadata__pr_14819.json"
  },
  {
    "instance_id": "payloadcms__payload.053256d5.14808",
    "repo": "payloadcms/payload",
    "pull_number": 14808,
    "base_commit": "053256d5cef6411bc29b9a69be0b2b62d5397c40",
    "patch": "diff --git a/packages/payload/src/query-presets/config.ts b/packages/payload/src/query-presets/config.ts\nindex f3f94e0bbd4..38763d08c8f 100644\n--- a/packages/payload/src/query-presets/config.ts\n+++ b/packages/payload/src/query-presets/config.ts\n@@ -14,7 +14,7 @@ export const getQueryPresetsConfig = (config: Config): CollectionConfig => ({\n   slug: queryPresetsCollectionSlug,\n   access: getAccess(config),\n   admin: {\n-    defaultColumns: ['title', 'isShared', 'access', 'where', 'columns'],\n+    defaultColumns: ['title', 'isShared', 'access', 'where', 'columns', 'groupBy'],\n     hidden: true,\n     useAsTitle: 'title',\n   },\n@@ -94,6 +94,17 @@ export const getQueryPresetsConfig = (config: Config): CollectionConfig => ({\n         return true\n       },\n     },\n+    {\n+      name: 'groupBy',\n+      type: 'text',\n+      admin: {\n+        components: {\n+          Cell: '@payloadcms/ui#QueryPresetsGroupByCell',\n+          Field: '@payloadcms/ui#QueryPresetsGroupByField',\n+        },\n+      },\n+      label: 'Group By',\n+    },\n     {\n       name: 'relatedCollection',\n       type: 'select',\ndiff --git a/packages/payload/src/query-presets/types.ts b/packages/payload/src/query-presets/types.ts\nindex d4030c0374e..5adf0c40d64 100644\n--- a/packages/payload/src/query-presets/types.ts\n+++ b/packages/payload/src/query-presets/types.ts\n@@ -20,6 +20,7 @@ export type QueryPreset = {\n     }\n   }\n   columns: CollectionPreferences['columns']\n+  groupBy?: string\n   id: number | string\n   isShared: boolean\n   relatedCollection: CollectionSlug\ndiff --git a/packages/ui/src/elements/QueryPresets/QueryPresetBar/index.tsx b/packages/ui/src/elements/QueryPresets/QueryPresetBar/index.tsx\nindex 15ce25060ff..ff29a0fbe65 100644\n--- a/packages/ui/src/elements/QueryPresets/QueryPresetBar/index.tsx\n+++ b/packages/ui/src/elements/QueryPresets/QueryPresetBar/index.tsx\n@@ -83,6 +83,7 @@ export const QueryPresetBar: React.FC<{\n       await refineListData(\n         {\n           columns: preset.columns ? transformColumnsToSearchParams(preset.columns) : undefined,\n+          groupBy: preset.groupBy || '',\n           preset: preset.id,\n           where: preset.where,\n         },\n@@ -96,6 +97,7 @@ export const QueryPresetBar: React.FC<{\n     await refineListData(\n       {\n         columns: [],\n+        groupBy: '',\n         preset: '',\n         where: {},\n       },\n@@ -141,6 +143,7 @@ export const QueryPresetBar: React.FC<{\n       await fetch(`${apiRoute}/payload-query-presets/${activePreset.id}`, {\n         body: JSON.stringify({\n           columns: transformColumnsToPreferences(query.columns),\n+          groupBy: query.groupBy,\n           where: query.where,\n         }),\n         credentials: 'include',\n@@ -178,6 +181,7 @@ export const QueryPresetBar: React.FC<{\n     apiRoute,\n     activePreset?.id,\n     query.columns,\n+    query.groupBy,\n     query.where,\n     t,\n     presetConfig?.labels?.singular,\n@@ -216,6 +220,7 @@ export const QueryPresetBar: React.FC<{\n                 await refineListData(\n                   {\n                     columns: transformColumnsToSearchParams(activePreset.columns),\n+                    groupBy: activePreset.groupBy || '',\n                     where: activePreset.where,\n                   },\n                   false,\n@@ -263,6 +268,7 @@ export const QueryPresetBar: React.FC<{\n       <CreateNewPresetDrawer\n         initialData={{\n           columns: transformColumnsToPreferences(query.columns),\n+          groupBy: query.groupBy,\n           relatedCollection: collectionSlug,\n           where: query.where,\n         }}\ndiff --git a/packages/ui/src/elements/QueryPresets/cells/GroupByCell/index.tsx b/packages/ui/src/elements/QueryPresets/cells/GroupByCell/index.tsx\nnew file mode 100644\nindex 00000000000..187ea0b9fc7\n--- /dev/null\n+++ b/packages/ui/src/elements/QueryPresets/cells/GroupByCell/index.tsx\n@@ -0,0 +1,63 @@\n+import type { DefaultCellComponentProps } from 'payload'\n+\n+import { toWords } from 'payload/shared'\n+import React, { useMemo } from 'react'\n+\n+import { useAuth } from '../../../../providers/Auth/index.js'\n+import { useConfig } from '../../../../providers/Config/index.js'\n+import { useTranslation } from '../../../../providers/Translation/index.js'\n+import { reduceFieldsToOptions } from '../../../../utilities/reduceFieldsToOptions.js'\n+\n+export const QueryPresetsGroupByCell: React.FC<DefaultCellComponentProps> = ({\n+  cellData,\n+  rowData,\n+}) => {\n+  const { i18n } = useTranslation()\n+  const { permissions } = useAuth()\n+  const { config } = useConfig()\n+\n+  // Get the related collection from the row data\n+  const relatedCollection = rowData?.relatedCollection as string\n+\n+  // Get the collection config for the related collection\n+  const collectionConfig = useMemo(() => {\n+    if (!relatedCollection) {\n+      return null\n+    }\n+\n+    return config.collections?.find((col) => col.slug === relatedCollection)\n+  }, [relatedCollection, config.collections])\n+\n+  // Reduce fields to options to get proper labels\n+  const reducedFields = useMemo(() => {\n+    if (!collectionConfig) {\n+      return []\n+    }\n+\n+    const fieldPermissions = permissions?.collections?.[relatedCollection]?.fields\n+\n+    return reduceFieldsToOptions({\n+      fieldPermissions,\n+      fields: collectionConfig.fields,\n+      i18n,\n+    })\n+  }, [collectionConfig, permissions, relatedCollection, i18n])\n+\n+  if (!cellData || typeof cellData !== 'string') {\n+    return <div>No group by selected</div>\n+  }\n+\n+  const isDescending = cellData.startsWith('-')\n+  const fieldName = isDescending ? cellData.slice(1) : cellData\n+  const direction = isDescending ? 'descending' : 'ascending'\n+\n+  // Find the field option to get the proper label\n+  const fieldOption = reducedFields.find((field) => field.value === fieldName)\n+  const displayLabel = fieldOption?.label || toWords(fieldName)\n+\n+  return (\n+    <div>\n+      {displayLabel} ({direction})\n+    </div>\n+  )\n+}\ndiff --git a/packages/ui/src/elements/QueryPresets/fields/GroupByField/index.scss b/packages/ui/src/elements/QueryPresets/fields/GroupByField/index.scss\nnew file mode 100644\nindex 00000000000..cd75b2ac412\n--- /dev/null\n+++ b/packages/ui/src/elements/QueryPresets/fields/GroupByField/index.scss\n@@ -0,0 +1,17 @@\n+@import '../../../../scss/styles';\n+\n+@layer payload-default {\n+  .query-preset-group-by-field {\n+    .field-label {\n+      margin-bottom: calc(var(--base) / 2);\n+    }\n+\n+    .value-wrapper {\n+      background-color: var(--theme-elevation-50);\n+      padding: var(--base);\n+      display: flex;\n+      flex-wrap: wrap;\n+      gap: calc(var(--base) / 2);\n+    }\n+  }\n+}\ndiff --git a/packages/ui/src/elements/QueryPresets/fields/GroupByField/index.tsx b/packages/ui/src/elements/QueryPresets/fields/GroupByField/index.tsx\nnew file mode 100644\nindex 00000000000..3b1baabbbc1\n--- /dev/null\n+++ b/packages/ui/src/elements/QueryPresets/fields/GroupByField/index.tsx\n@@ -0,0 +1,78 @@\n+'use client'\n+import type { TextFieldClientComponent } from 'payload'\n+\n+import { toWords } from 'payload/shared'\n+import React, { useMemo } from 'react'\n+\n+import { FieldLabel } from '../../../../fields/FieldLabel/index.js'\n+import { useField } from '../../../../forms/useField/index.js'\n+import { useAuth } from '../../../../providers/Auth/index.js'\n+import { useConfig } from '../../../../providers/Config/index.js'\n+import { useTranslation } from '../../../../providers/Translation/index.js'\n+import { reduceFieldsToOptions } from '../../../../utilities/reduceFieldsToOptions.js'\n+import { Pill } from '../../../Pill/index.js'\n+import './index.scss'\n+\n+export const QueryPresetsGroupByField: TextFieldClientComponent = ({\n+  field: { label, required },\n+}) => {\n+  const { path, value } = useField()\n+  const { i18n } = useTranslation()\n+  const { permissions } = useAuth()\n+  const { config } = useConfig()\n+\n+  // Get the relatedCollection from the document data\n+  const relatedCollectionField = useField({ path: 'relatedCollection' })\n+  const relatedCollection = relatedCollectionField.value as string\n+\n+  // Get the collection config for the related collection\n+  const collectionConfig = useMemo(() => {\n+    if (!relatedCollection) {\n+      return null\n+    }\n+\n+    return config.collections?.find((col) => col.slug === relatedCollection)\n+  }, [relatedCollection, config.collections])\n+\n+  // Reduce fields to options to get proper labels\n+  const reducedFields = useMemo(() => {\n+    if (!collectionConfig) {\n+      return []\n+    }\n+\n+    const fieldPermissions = permissions?.collections?.[relatedCollection]?.fields\n+\n+    return reduceFieldsToOptions({\n+      fieldPermissions,\n+      fields: collectionConfig.fields,\n+      i18n,\n+    })\n+  }, [collectionConfig, permissions, relatedCollection, i18n])\n+\n+  const renderGroupBy = (groupByValue: string) => {\n+    if (!groupByValue) {\n+      return 'No group by selected'\n+    }\n+\n+    const isDescending = groupByValue.startsWith('-')\n+    const fieldName = isDescending ? groupByValue.slice(1) : groupByValue\n+    const direction = isDescending ? 'descending' : 'ascending'\n+\n+    // Find the field option to get the proper label\n+    const fieldOption = reducedFields.find((field) => field.value === fieldName)\n+    const displayLabel = fieldOption?.label || toWords(fieldName)\n+\n+    return (\n+      <Pill pillStyle=\"always-white\" size=\"small\">\n+        <b>{displayLabel}</b> ({direction})\n+      </Pill>\n+    )\n+  }\n+\n+  return (\n+    <div className=\"field-type query-preset-group-by-field\">\n+      <FieldLabel as=\"h3\" label={label} path={path} required={required} />\n+      <div className=\"value-wrapper\">{renderGroupBy(value as string)}</div>\n+    </div>\n+  )\n+}\ndiff --git a/packages/ui/src/exports/client/index.ts b/packages/ui/src/exports/client/index.ts\nindex be38350fa1d..ac3bfaffbfe 100644\n--- a/packages/ui/src/exports/client/index.ts\n+++ b/packages/ui/src/exports/client/index.ts\n@@ -32,8 +32,10 @@ export { OrderableTable } from '../../elements/Table/OrderableTable.js'\n export { QueryPresetsColumnsCell } from '../../elements/QueryPresets/cells/ColumnsCell/index.js'\n export { QueryPresetsWhereCell } from '../../elements/QueryPresets/cells/WhereCell/index.js'\n export { QueryPresetsAccessCell } from '../../elements/QueryPresets/cells/AccessCell/index.js'\n+export { QueryPresetsGroupByCell } from '../../elements/QueryPresets/cells/GroupByCell/index.js'\n export { QueryPresetsColumnField } from '../../elements/QueryPresets/fields/ColumnsField/index.js'\n export { QueryPresetsWhereField } from '../../elements/QueryPresets/fields/WhereField/index.js'\n+export { QueryPresetsGroupByField } from '../../elements/QueryPresets/fields/GroupByField/index.js'\n \n // elements\n export { ConfirmationModal } from '../../elements/ConfirmationModal/index.js'\n",
    "test_patch": "diff --git a/test/group-by/collections/Posts/index.ts b/test/group-by/collections/Posts/index.ts\nindex e49d8abb87b..1f209df664a 100644\n--- a/test/group-by/collections/Posts/index.ts\n+++ b/test/group-by/collections/Posts/index.ts\n@@ -11,6 +11,7 @@ export const PostsCollection: CollectionConfig = {\n     groupBy: true,\n     defaultColumns: ['title', 'category', 'createdAt', 'updatedAt'],\n   },\n+  enableQueryPresets: true,\n   trash: true,\n   fields: [\n     {\ndiff --git a/test/group-by/e2e.spec.ts b/test/group-by/e2e.spec.ts\nindex 42ca78ec778..23335644eca 100644\n--- a/test/group-by/e2e.spec.ts\n+++ b/test/group-by/e2e.spec.ts\n@@ -19,6 +19,7 @@ import {\n   ensureCompilationIsDone,\n   exactText,\n   initPageConsoleErrorCatch,\n+  saveDocAndAssert,\n   selectTableRow,\n } from '../helpers.js'\n import { AdminUrlUtil } from '../helpers/adminUrlUtil.js'\n@@ -923,4 +924,129 @@ test.describe('Group By', () => {\n       },\n     }) as unknown as Promise<Post>\n   }\n+\n+  test.describe('Query Presets with Virtual Fields', () => {\n+    test('should display virtual field label in preset drawer when groupBy is saved', async () => {\n+      await page.goto(url.list)\n+\n+      // Add group by virtual field\n+      const { groupByContainer } = await openGroupBy(page)\n+      const field = groupByContainer.locator('#group-by--field-select')\n+      await field.click()\n+      await field\n+        .locator('.rs__option', {\n+          hasText: exactText('Virtual Title From Page'),\n+        })\n+        .click()\n+\n+      await expect(field.locator('.react-select--single-value')).toHaveText(\n+        'Virtual Title From Page',\n+      )\n+      await expect(page).toHaveURL(/&groupBy=page\\.title/)\n+\n+      // Create a new preset with this groupBy\n+      await page.locator('#create-new-preset').click()\n+      const modal = page.locator('[id^=doc-drawer_payload-query-presets_0_]')\n+      await expect(modal).toBeVisible()\n+\n+      const presetTitle = 'Virtual Field Preset'\n+      await modal.locator('input[name=\"title\"]').fill(presetTitle)\n+\n+      // Check that the groupBy field shows the proper label (not \"page.title\")\n+      const groupByField = modal.locator('.query-preset-group-by-field .value-wrapper')\n+      await expect(groupByField).toBeVisible()\n+      await expect(groupByField).toContainText('Virtual Title From Page')\n+      await expect(groupByField).toContainText('ascending')\n+\n+      await saveDocAndAssert(page)\n+      await expect(modal).toBeHidden()\n+\n+      await expect(page).toHaveURL(/groupBy=page\\.title/)\n+    })\n+\n+    test('should display virtual field label in preset list cell', async () => {\n+      await page.goto(url.list)\n+\n+      await payload.create({\n+        collection: 'payload-query-presets',\n+        data: {\n+          access: {\n+            delete: { constraint: 'onlyMe' },\n+            read: { constraint: 'onlyMe' },\n+            update: { constraint: 'onlyMe' },\n+          },\n+          groupBy: 'page.title',\n+          isShared: false,\n+          relatedCollection: postsSlug,\n+          title: 'Virtual Field Cell Test',\n+          where: {},\n+        },\n+        user,\n+      })\n+\n+      // Open the preset drawer\n+      await page.click('button#select-preset')\n+      const drawer = page.locator('dialog[id^=\"list-drawer_0_\"]')\n+      await expect(drawer).toBeVisible()\n+\n+      // Find the row with our preset in the drawer\n+      const presetRow = drawer.locator('tbody tr', {\n+        has: page.locator('button:has-text(\"Virtual Field Cell Test\")'),\n+      })\n+      await expect(presetRow).toBeVisible()\n+\n+      // Check the groupBy cell displays the proper label (not \"page.title\")\n+      const groupByCell = presetRow.locator('td.cell-groupBy')\n+      await expect(groupByCell).toBeVisible()\n+      await expect(groupByCell).toContainText('Virtual Title From Page')\n+      await expect(groupByCell).toContainText('ascending')\n+    })\n+\n+    test('should display virtual field label when editing a preset', async () => {\n+      await page.goto(url.list)\n+\n+      const presetTitle = 'Virtual Field Edit Test'\n+      await payload.create({\n+        collection: 'payload-query-presets',\n+        data: {\n+          access: {\n+            delete: { constraint: 'onlyMe' },\n+            read: { constraint: 'onlyMe' },\n+            update: { constraint: 'onlyMe' },\n+          },\n+          groupBy: '-page.title',\n+          isShared: false,\n+          relatedCollection: postsSlug,\n+          title: presetTitle,\n+          where: {},\n+        },\n+        user,\n+      })\n+\n+      // Select the preset to make it active\n+      await page.locator('button#select-preset').click()\n+      const drawer = page.locator('[id^=list-drawer_0_]')\n+      await expect(drawer).toBeVisible()\n+\n+      await drawer\n+        .locator('tbody tr td button', {\n+          hasText: exactText(presetTitle),\n+        })\n+        .first()\n+        .click()\n+\n+      await expect(drawer).toBeHidden()\n+\n+      // Now open the edit preset drawer\n+      await page.locator('#edit-preset').click()\n+      const editModal = page.locator('[id^=doc-drawer_payload-query-presets_0_]')\n+      await expect(editModal).toBeVisible()\n+\n+      // Check that the groupBy field shows the proper label with descending direction\n+      const groupByField = editModal.locator('.query-preset-group-by-field .value-wrapper')\n+      await expect(groupByField).toBeVisible()\n+      await expect(groupByField).toContainText('Virtual Title From Page')\n+      await expect(groupByField).toContainText('descending')\n+    })\n+  })\n })\ndiff --git a/test/group-by/payload-types.ts b/test/group-by/payload-types.ts\nindex fb2a45af19d..515889f4202 100644\n--- a/test/group-by/payload-types.ts\n+++ b/test/group-by/payload-types.ts\n@@ -77,6 +77,7 @@ export interface Config {\n     'payload-locked-documents': PayloadLockedDocument;\n     'payload-preferences': PayloadPreference;\n     'payload-migrations': PayloadMigration;\n+    'payload-query-presets': PayloadQueryPreset;\n   };\n   collectionsJoins: {};\n   collectionsSelect: {\n@@ -90,10 +91,12 @@ export interface Config {\n     'payload-locked-documents': PayloadLockedDocumentsSelect<false> | PayloadLockedDocumentsSelect<true>;\n     'payload-preferences': PayloadPreferencesSelect<false> | PayloadPreferencesSelect<true>;\n     'payload-migrations': PayloadMigrationsSelect<false> | PayloadMigrationsSelect<true>;\n+    'payload-query-presets': PayloadQueryPresetsSelect<false> | PayloadQueryPresetsSelect<true>;\n   };\n   db: {\n     defaultIDType: string;\n   };\n+  fallbackLocale: null;\n   globals: {};\n   globalsSelect: {};\n   locale: null;\n@@ -353,6 +356,55 @@ export interface PayloadMigration {\n   updatedAt: string;\n   createdAt: string;\n }\n+/**\n+ * This interface was referenced by `Config`'s JSON-Schema\n+ * via the `definition` \"payload-query-presets\".\n+ */\n+export interface PayloadQueryPreset {\n+  id: string;\n+  title: string;\n+  isShared?: boolean | null;\n+  access?: {\n+    read?: {\n+      constraint?: ('everyone' | 'onlyMe' | 'specificUsers') | null;\n+      users?: (string | User)[] | null;\n+    };\n+    update?: {\n+      constraint?: ('everyone' | 'onlyMe' | 'specificUsers') | null;\n+      users?: (string | User)[] | null;\n+    };\n+    delete?: {\n+      constraint?: ('everyone' | 'onlyMe' | 'specificUsers') | null;\n+      users?: (string | User)[] | null;\n+    };\n+  };\n+  where?:\n+    | {\n+        [k: string]: unknown;\n+      }\n+    | unknown[]\n+    | string\n+    | number\n+    | boolean\n+    | null;\n+  columns?:\n+    | {\n+        [k: string]: unknown;\n+      }\n+    | unknown[]\n+    | string\n+    | number\n+    | boolean\n+    | null;\n+  groupBy?: string | null;\n+  relatedCollection: 'posts';\n+  /**\n+   * This is a temporary field used to determine if updating the preset would remove the user's access to it. When `true`, this record will be deleted after running the preset's `validate` function.\n+   */\n+  isTemp?: boolean | null;\n+  updatedAt: string;\n+  createdAt: string;\n+}\n /**\n  * This interface was referenced by `Config`'s JSON-Schema\n  * via the `definition` \"pages_select\".\n@@ -515,6 +567,43 @@ export interface PayloadMigrationsSelect<T extends boolean = true> {\n   updatedAt?: T;\n   createdAt?: T;\n }\n+/**\n+ * This interface was referenced by `Config`'s JSON-Schema\n+ * via the `definition` \"payload-query-presets_select\".\n+ */\n+export interface PayloadQueryPresetsSelect<T extends boolean = true> {\n+  title?: T;\n+  isShared?: T;\n+  access?:\n+    | T\n+    | {\n+        read?:\n+          | T\n+          | {\n+              constraint?: T;\n+              users?: T;\n+            };\n+        update?:\n+          | T\n+          | {\n+              constraint?: T;\n+              users?: T;\n+            };\n+        delete?:\n+          | T\n+          | {\n+              constraint?: T;\n+              users?: T;\n+            };\n+      };\n+  where?: T;\n+  columns?: T;\n+  groupBy?: T;\n+  relatedCollection?: T;\n+  isTemp?: T;\n+  updatedAt?: T;\n+  createdAt?: T;\n+}\n /**\n  * This interface was referenced by `Config`'s JSON-Schema\n  * via the `definition` \"auth\".\ndiff --git a/test/query-presets/collections/Posts/index.ts b/test/query-presets/collections/Posts/index.ts\nindex 2cfd03122d5..e265b61409c 100644\n--- a/test/query-presets/collections/Posts/index.ts\n+++ b/test/query-presets/collections/Posts/index.ts\n@@ -6,6 +6,7 @@ export const Posts: CollectionConfig = {\n   slug: postsSlug,\n   admin: {\n     useAsTitle: 'text',\n+    groupBy: true,\n   },\n   enableQueryPresets: true,\n   lockDocuments: false,\ndiff --git a/test/query-presets/e2e.spec.ts b/test/query-presets/e2e.spec.ts\nindex f4f44b923bc..e64d1a877b4 100644\n--- a/test/query-presets/e2e.spec.ts\n+++ b/test/query-presets/e2e.spec.ts\n@@ -4,6 +4,7 @@ import { expect, test } from '@playwright/test'\n import { devUser } from 'credentials.js'\n import { openListColumns, toggleColumn } from 'helpers/e2e/columns/index.js'\n import { addListFilter, openListFilters } from 'helpers/e2e/filters/index.js'\n+import { addGroupBy, clearGroupBy } from 'helpers/e2e/groupBy/index.js'\n import { openNav } from 'helpers/e2e/toggleNav.js'\n import * as path from 'path'\n import { fileURLToPath } from 'url'\n@@ -590,4 +591,160 @@ describe('Query Presets', () => {\n     await expect(whereFieldContent).toContainText(testPost2?.id ?? '')\n     await expect(whereFieldContent).toContainText(',')\n   })\n+\n+  test('should save groupBy when creating a new preset', async () => {\n+    const postsUrl = new AdminUrlUtil(serverURL, 'posts')\n+    await page.goto(postsUrl.list)\n+\n+    await addGroupBy(page, { fieldLabel: 'Text', fieldPath: 'text' })\n+\n+    // Create a new preset\n+    await page.locator('#create-new-preset').click()\n+    const modal = page.locator('[id^=doc-drawer_payload-query-presets_0_]')\n+    await expect(modal).toBeVisible()\n+\n+    const presetTitle = 'GroupBy Test Preset'\n+    await modal.locator('input[name=\"title\"]').fill(presetTitle)\n+\n+    // Verify groupBy field displays the current groupBy value (read-only)\n+    const groupByField = modal.locator('.query-preset-group-by-field .value-wrapper')\n+    await expect(groupByField).toBeVisible()\n+    await expect(groupByField).toContainText('Text')\n+    await expect(groupByField).toContainText('ascending')\n+\n+    await saveDocAndAssert(page)\n+    await expect(modal).toBeHidden()\n+\n+    await expect(page).toHaveURL(/groupBy=text/)\n+  })\n+\n+  test('should apply groupBy when selecting a preset', async () => {\n+    const postsUrl = new AdminUrlUtil(serverURL, 'posts')\n+\n+    // First, create a preset with groupBy\n+    await page.goto(postsUrl.list)\n+    await addGroupBy(page, { fieldLabel: 'Text', fieldPath: 'text' })\n+\n+    await page.locator('#create-new-preset').click()\n+    const modal = page.locator('[id^=doc-drawer_payload-query-presets_0_]')\n+    await expect(modal).toBeVisible()\n+\n+    const presetTitle = 'GroupBy Apply Test'\n+    await modal.locator('input[name=\"title\"]').fill(presetTitle)\n+    await saveDocAndAssert(page)\n+    await expect(modal).toBeHidden()\n+\n+    // Clear the preset\n+    await clearSelectedPreset({ page })\n+\n+    await page.goto(postsUrl.list)\n+    await expect(page).not.toHaveURL(/groupBy=/)\n+\n+    await selectPreset({ page, presetTitle })\n+\n+    await expect(page).toHaveURL(/groupBy=text/)\n+\n+    await expect(page.locator('.group-by-header').first()).toBeVisible()\n+  })\n+\n+  test('should clear groupBy when deselecting a preset', async () => {\n+    const postsUrl = new AdminUrlUtil(serverURL, 'posts')\n+\n+    // Create a preset with groupBy\n+    await page.goto(postsUrl.list)\n+    await addGroupBy(page, { fieldLabel: 'Text', fieldPath: 'text' })\n+\n+    await page.locator('#create-new-preset').click()\n+    const modal = page.locator('[id^=doc-drawer_payload-query-presets_0_]')\n+    await expect(modal).toBeVisible()\n+\n+    const presetTitle = 'GroupBy Clear Test'\n+    await modal.locator('input[name=\"title\"]').fill(presetTitle)\n+    await saveDocAndAssert(page)\n+    await expect(modal).toBeHidden()\n+\n+    // Verify groupBy is in URL and grouped view is active\n+    await expect(page).toHaveURL(/groupBy=text/)\n+    await expect(page.locator('.group-by-header').first()).toBeVisible()\n+\n+    await clearSelectedPreset({ page })\n+\n+    // Verify groupBy is removed from URL and grouped view is gone\n+    await expect(page).not.toHaveURL(/groupBy=/)\n+    await expect(page.locator('.group-by-header')).toHaveCount(0)\n+  })\n+\n+  test('should update groupBy when saving changes to an active preset', async () => {\n+    const postsUrl = new AdminUrlUtil(serverURL, 'posts')\n+\n+    // Create a preset without groupBy\n+    await page.goto(postsUrl.list)\n+\n+    await page.locator('#create-new-preset').click()\n+    const modal = page.locator('[id^=doc-drawer_payload-query-presets_0_]')\n+    await expect(modal).toBeVisible()\n+\n+    const presetTitle = 'GroupBy Update Test'\n+    await modal.locator('input[name=\"title\"]').fill(presetTitle)\n+\n+    await saveDocAndAssert(page)\n+    await expect(modal).toBeHidden()\n+\n+    await addGroupBy(page, { fieldLabel: 'Text', fieldPath: 'text' })\n+\n+    await page.locator('#save-preset').click()\n+\n+    // Wait for the modified indicator to disappear (indicates save completed)\n+    await expect(page.locator('.list-controls__modified')).toBeHidden()\n+\n+    // Clear and reselect the preset to verify groupBy was saved\n+    await clearSelectedPreset({ page })\n+    await page.goto(postsUrl.list)\n+    await selectPreset({ page, presetTitle })\n+\n+    // Verify groupBy is applied from the preset\n+    await expect(page).toHaveURL(/groupBy=text/)\n+    await expect(page.locator('.group-by-header').first()).toBeVisible()\n+  })\n+\n+  test('should reset groupBy when clicking reset button on modified preset', async () => {\n+    const postsUrl = new AdminUrlUtil(serverURL, 'posts')\n+\n+    // Create a preset with groupBy\n+    await page.goto(postsUrl.list)\n+    await addGroupBy(page, { fieldLabel: 'Text', fieldPath: 'text' })\n+\n+    await page.locator('#create-new-preset').click()\n+    const modal = page.locator('[id^=doc-drawer_payload-query-presets_0_]')\n+    await expect(modal).toBeVisible()\n+\n+    const presetTitle = 'GroupBy Reset Test'\n+    await modal.locator('input[name=\"title\"]').fill(presetTitle)\n+    await saveDocAndAssert(page)\n+    await expect(modal).toBeHidden()\n+\n+    // Verify groupBy is in URL and grouped view is visible\n+    await expect(page).toHaveURL(/groupBy=text/)\n+    await expect(page.locator('.group-by-header').first()).toBeVisible()\n+\n+    // Verify reset button is not visible initially\n+    await expect(page.locator('#reset-preset')).toBeHidden()\n+\n+    // Clear the groupBy (modify the preset)\n+    await clearGroupBy(page)\n+    await expect(page).not.toHaveURL(/groupBy=/)\n+    await expect(page.locator('.group-by-header')).toHaveCount(0)\n+\n+    // Verify reset button becomes visible after modification\n+    await expect(page.locator('#reset-preset')).toBeVisible()\n+\n+    await page.locator('#reset-preset').click()\n+\n+    // Verify groupBy is restored from preset\n+    await expect(page).toHaveURL(/groupBy=text/)\n+    await expect(page.locator('.group-by-header').first()).toBeVisible()\n+\n+    // Verify reset button is hidden again after reset\n+    await expect(page.locator('#reset-preset')).toBeHidden()\n+  })\n })\ndiff --git a/test/query-presets/helpers/togglePreset.ts b/test/query-presets/helpers/togglePreset.ts\nindex f6bf1df5267..aac22f60933 100644\n--- a/test/query-presets/helpers/togglePreset.ts\n+++ b/test/query-presets/helpers/togglePreset.ts\n@@ -33,13 +33,13 @@ export async function clearSelectedPreset({ page }: { page: Page }) {\n   const queryPresetsControl = page.locator('button#select-preset')\n   const clearButton = queryPresetsControl.locator('#clear-preset')\n \n-  if (await clearButton.isVisible()) {\n-    await clearButton.click()\n-  }\n-\n-  // columns can either be omitted or an empty string after being cleared\n-  const regex = /columns=(?:\\[\\]|$)/\n+  // Wait for the clear button to be visible and click it\n+  await expect(clearButton).toBeVisible()\n+  await clearButton.click()\n \n+  // Wait for preset parameter to be cleared from URL\n+  // Other params like columns, groupBy may be temporarily empty strings before being removed\n+  const regex = /preset=/\n   await page.waitForURL((url) => !regex.test(url.search), {\n     timeout: TEST_TIMEOUT_LONG,\n   })\ndiff --git a/test/query-presets/payload-types.ts b/test/query-presets/payload-types.ts\nindex bf4fc79de79..f71d24cac9e 100644\n--- a/test/query-presets/payload-types.ts\n+++ b/test/query-presets/payload-types.ts\n@@ -278,6 +278,7 @@ export interface PayloadQueryPreset {\n     | number\n     | boolean\n     | null;\n+  groupBy?: string | null;\n   relatedCollection: 'pages' | 'posts';\n   /**\n    * This is a temporary field used to determine if updating the preset would remove the user's access to it. When `true`, this record will be deleted after running the preset's `validate` function.\n@@ -402,6 +403,7 @@ export interface PayloadQueryPresetsSelect<T extends boolean = true> {\n       };\n   where?: T;\n   columns?: T;\n+  groupBy?: T;\n   relatedCollection?: T;\n   isTemp?: T;\n   updatedAt?: T;\n",
    "problem_statement": "",
    "direct_patch": false,
    "has_rewrites": true,
    "_file": "logs/bug_gen/payloadcms__payload.053256d5/pr_mirror/payloadcms__payload.053256d5.14808/metadata__pr_14808.json"
  }
]