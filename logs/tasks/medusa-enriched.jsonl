{"instance_id": "medusajs__medusa.56ed9cf9.14220", "repo": "medusajs/medusa", "base_commit": "b7adfb225b4e81bd388c01afe254e2de140266b9", "head_commit": "6a91d18f4cdcb46e4a0225378eccb5ae50bebf57", "title": "fix S3 URL escaping", "merged_at": "2025-12-04T21:03:17Z", "html_url": "https://github.com/medusajs/medusa/pull/14220", "test_files": ["packages/modules/providers/file-s3/integration-tests/__tests__/services.spec.ts"], "code_files": ["packages/modules/providers/file-s3/src/services/s3-file.ts"], "total_changes": 19, "num_files": 2, "pull_number": 14220, "patch": "diff --git a/packages/modules/providers/file-s3/integration-tests/__tests__/services.spec.ts b/packages/modules/providers/file-s3/integration-tests/__tests__/services.spec.ts\nindex 50fa4ca54bded..d20590060114f 100644\n--- a/packages/modules/providers/file-s3/integration-tests/__tests__/services.spec.ts\n+++ b/packages/modules/providers/file-s3/integration-tests/__tests__/services.spec.ts\n@@ -99,6 +99,23 @@ describe.skip(\"S3 File Plugin\", () => {\n     })\n   })\n \n+  it(\"uploads a file with special URL characters in the name\", async () => {\n+    const fileContent = await fs.readFile(fixtureImagePath)\n+    const fixtureAsBinary = fileContent.toString(\"base64\")\n+\n+    const resp = await s3Service.upload({\n+      filename: \"cat?photo.jpg\",\n+      mimeType: \"image/jpeg\",\n+      content: fixtureAsBinary,\n+      access: \"private\",\n+    })\n+\n+    expect(resp).toEqual({\n+      key: expect.stringMatching(/tests\\/catphoto.*\\.jpg/),\n+      url: expect.stringMatching(/https:\\/\\/.*\\/cat%3Fphoto.*\\.jpg/),\n+    })\n+  })\n+\n   it(\"gets a presigned upload URL and uploads a file successfully\", async () => {\n     const fileContent = await fs.readFile(fixtureImagePath)\n     const fixtureAsBinary = fileContent.toString(\"binary\")\ndiff --git a/packages/modules/providers/file-s3/src/services/s3-file.ts b/packages/modules/providers/file-s3/src/services/s3-file.ts\nindex ef3b8be1352f2..f617a722f8058 100644\n--- a/packages/modules/providers/file-s3/src/services/s3-file.ts\n+++ b/packages/modules/providers/file-s3/src/services/s3-file.ts\n@@ -160,7 +160,7 @@ export class S3FileService extends AbstractFileProviderService {\n     }\n \n     return {\n-      url: `${this.config_.fileUrl}/${encodeURI(fileKey)}`,\n+      url: `${this.config_.fileUrl}/${encodeURIComponent(fileKey)}`,\n       key: fileKey,\n     }\n   }\n"}
{"instance_id": "medusajs__medusa.56ed9cf9.14209", "repo": "medusajs/medusa", "base_commit": "765232948900b7be98fb2cef1a9c8caf108a2d1e", "head_commit": "6e2b4fb880d497cda9ede2201870989363a67e46", "title": "escape non-ascii characters in filenames in s3 file provider", "merged_at": "2025-12-04T17:37:56Z", "html_url": "https://github.com/medusajs/medusa/pull/14209", "test_files": ["packages/modules/providers/file-s3/integration-tests/__tests__/services.spec.ts"], "code_files": ["packages/modules/providers/file-s3/src/services/s3-file.ts"], "total_changes": 28, "num_files": 3, "pull_number": 14209, "patch": "diff --git a/.changeset/shiny-hounds-learn.md b/.changeset/shiny-hounds-learn.md\nnew file mode 100644\nindex 0000000000000..df370ca61eba5\n--- /dev/null\n+++ b/.changeset/shiny-hounds-learn.md\n@@ -0,0 +1,5 @@\n+---\n+\"@medusajs/file-s3\": patch\n+---\n+\n+URL-encode S3 object metadata and returned URL\ndiff --git a/packages/modules/providers/file-s3/integration-tests/__tests__/services.spec.ts b/packages/modules/providers/file-s3/integration-tests/__tests__/services.spec.ts\nindex d874e88c3a21f..50fa4ca54bded 100644\n--- a/packages/modules/providers/file-s3/integration-tests/__tests__/services.spec.ts\n+++ b/packages/modules/providers/file-s3/integration-tests/__tests__/services.spec.ts\n@@ -1,5 +1,5 @@\n-import fs from \"fs/promises\"\n import axios from \"axios\"\n+import fs from \"fs/promises\"\n import { S3FileService } from \"../../src/services/s3-file\"\n jest.setTimeout(100000)\n \n@@ -82,6 +82,23 @@ describe.skip(\"S3 File Plugin\", () => {\n     })\n   })\n \n+  it(\"uploads a file with non-ascii characters in the name\", async () => {\n+    const fileContent = await fs.readFile(fixtureImagePath)\n+    const fixtureAsBinary = fileContent.toString(\"base64\")\n+\n+    const resp = await s3Service.upload({\n+      filename: \"catphoto-\u304b.jpg\",\n+      mimeType: \"image/jpeg\",\n+      content: fixtureAsBinary,\n+      access: \"private\",\n+    })\n+\n+    expect(resp).toEqual({\n+      key: expect.stringMatching(/tests\\/catphoto-\u304b.*\\.jpg/),\n+      url: expect.stringMatching(/https:\\/\\/.*\\/catphoto-%E3%81%8B.*\\.jpg/),\n+    })\n+  })\n+\n   it(\"gets a presigned upload URL and uploads a file successfully\", async () => {\n     const fileContent = await fs.readFile(fixtureImagePath)\n     const fixtureAsBinary = fileContent.toString(\"binary\")\ndiff --git a/packages/modules/providers/file-s3/src/services/s3-file.ts b/packages/modules/providers/file-s3/src/services/s3-file.ts\nindex 4caedd5587468..ef3b8be1352f2 100644\n--- a/packages/modules/providers/file-s3/src/services/s3-file.ts\n+++ b/packages/modules/providers/file-s3/src/services/s3-file.ts\n@@ -148,7 +148,7 @@ export class S3FileService extends AbstractFileProviderService {\n       // Note: We could potentially set the content disposition when uploading,\n       // but storing the original filename as metadata should suffice.\n       Metadata: {\n-        \"x-amz-meta-original-filename\": file.filename,\n+        \"original-filename\": encodeURIComponent(file.filename),\n       },\n     })\n \n@@ -160,7 +160,7 @@ export class S3FileService extends AbstractFileProviderService {\n     }\n \n     return {\n-      url: `${this.config_.fileUrl}/${fileKey}`,\n+      url: `${this.config_.fileUrl}/${encodeURI(fileKey)}`,\n       key: fileKey,\n     }\n   }\n"}
