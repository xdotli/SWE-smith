{"instance_id": "twentyhq__twenty.main.16335", "repo": "twentyhq/twenty", "base_commit": "0ced7da8e004b3cb7c9d2c2c56a5e75c6db83dc2", "head_commit": "7417a6702f321f8d6fe3e108acc08d53d5e0e5da", "title": "Use alias in create-twenty-app", "merged_at": "2025-12-04T16:12:56Z", "html_url": "https://github.com/twentyhq/twenty/pull/16335", "test_files": ["packages/create-twenty-app/src/utils/__tests__/convert-to-label.spec.ts"], "code_files": ["packages/create-twenty-app/src/cli.ts", "packages/create-twenty-app/src/create-app.command.ts"], "total_changes": 12, "num_files": 3, "pull_number": 16335, "patch": "diff --git a/packages/create-twenty-app/src/cli.ts b/packages/create-twenty-app/src/cli.ts\nindex b1f818009efce..9294a94ade717 100644\n--- a/packages/create-twenty-app/src/cli.ts\n+++ b/packages/create-twenty-app/src/cli.ts\n@@ -1,7 +1,7 @@\n #!/usr/bin/env node\n import chalk from 'chalk';\n import { Command, CommanderError } from 'commander';\n-import { CreateAppCommand } from './create-app.command';\n+import { CreateAppCommand } from '@/create-app.command';\n import packageJson from '../package.json';\n \n const program = new Command(packageJson.name)\ndiff --git a/packages/create-twenty-app/src/create-app.command.ts b/packages/create-twenty-app/src/create-app.command.ts\nindex ecdebba46ffda..5c5ff4a7b1e98 100644\n--- a/packages/create-twenty-app/src/create-app.command.ts\n+++ b/packages/create-twenty-app/src/create-app.command.ts\n@@ -2,11 +2,11 @@ import chalk from 'chalk';\n import * as fs from 'fs-extra';\n import inquirer from 'inquirer';\n import * as path from 'path';\n-import { copyBaseApplicationProject } from './utils/app-template';\n+import { copyBaseApplicationProject } from '@/utils/app-template';\n import kebabCase from 'lodash.kebabcase';\n-import { convertToLabel } from './utils/convert-to-label';\n-import { tryGitInit } from './utils/try-git-init';\n-import { install } from './utils/install';\n+import { convertToLabel } from '@/utils/convert-to-label';\n+import { tryGitInit } from '@/utils/try-git-init';\n+import { install } from '@/utils/install';\n \n const CURRENT_EXECUTION_DIRECTORY = process.env.INIT_CWD || process.cwd();\n \ndiff --git a/packages/create-twenty-app/src/utils/__tests__/convert-to-label.spec.ts b/packages/create-twenty-app/src/utils/__tests__/convert-to-label.spec.ts\nindex d565478c2a8c7..d7eeedfe865a9 100644\n--- a/packages/create-twenty-app/src/utils/__tests__/convert-to-label.spec.ts\n+++ b/packages/create-twenty-app/src/utils/__tests__/convert-to-label.spec.ts\n@@ -1,4 +1,4 @@\n-import { convertToLabel } from '../convert-to-label';\n+import { convertToLabel } from '@/utils/convert-to-label';\n \n describe('convertToLabel', () => {\n   it('should convert to label', () => {\n"}
{"instance_id": "twentyhq__twenty.main.16326", "repo": "twentyhq/twenty", "base_commit": "8ee2efead7f10e125b45c9b0d4f1375d9231f51b", "head_commit": "4630733b5545aec0fe039440d4fe1c59a679a50f", "title": "Fix Message/Calendar channel stuck in SCHEDULED syncStage", "merged_at": "2025-12-04T15:01:12Z", "html_url": "https://github.com/twentyhq/twenty/pull/16326", "test_files": ["packages/twenty-server/src/modules/messaging/message-import-manager/services/__tests__/messaging-message-list-fetch.service.spec.ts", "packages/twenty-server/src/modules/messaging/message-import-manager/services/__tests__/messaging-messages-import.service.spec.ts"], "code_files": ["packages/twenty-server/src/modules/calendar/calendar-event-import-manager/crons/jobs/calendar-event-list-fetch.cron.job.ts", "packages/twenty-server/src/modules/calendar/calendar-event-import-manager/crons/jobs/calendar-events-import.cron.job.ts", "packages/twenty-server/src/modules/messaging/common/services/message-channel-sync-status.service.ts", "packages/twenty-server/src/modules/messaging/message-import-manager/crons/jobs/messaging-message-list-fetch.cron.job.ts", "packages/twenty-server/src/modules/messaging/message-import-manager/crons/jobs/messaging-messages-import.cron.job.ts"], "total_changes": 71, "num_files": 7, "pull_number": 16326, "patch": "diff --git a/packages/twenty-server/src/modules/calendar/calendar-event-import-manager/crons/jobs/calendar-event-list-fetch.cron.job.ts b/packages/twenty-server/src/modules/calendar/calendar-event-import-manager/crons/jobs/calendar-event-list-fetch.cron.job.ts\nindex 3700e337e5054..aef27c0b063cd 100644\n--- a/packages/twenty-server/src/modules/calendar/calendar-event-import-manager/crons/jobs/calendar-event-list-fetch.cron.job.ts\n+++ b/packages/twenty-server/src/modules/calendar/calendar-event-import-manager/crons/jobs/calendar-event-list-fetch.cron.job.ts\n@@ -50,8 +50,11 @@ export class CalendarEventListFetchCronJob {\n       try {\n         const schemaName = getWorkspaceSchemaName(activeWorkspace.id);\n \n+        const now = new Date().toISOString();\n+\n         const [calendarChannels] = await this.coreDataSource.query(\n-          `UPDATE ${schemaName}.\"calendarChannel\" SET \"syncStage\" = '${CalendarChannelSyncStage.CALENDAR_EVENT_LIST_FETCH_SCHEDULED}' WHERE \"isSyncEnabled\" = true AND \"syncStage\" = '${CalendarChannelSyncStage.CALENDAR_EVENT_LIST_FETCH_PENDING}' RETURNING *`,\n+          `UPDATE ${schemaName}.\"calendarChannel\" SET \"syncStage\" = '${CalendarChannelSyncStage.CALENDAR_EVENT_LIST_FETCH_SCHEDULED}', \"syncStageStartedAt\" = '${now}'\n+          WHERE \"isSyncEnabled\" = true AND \"syncStage\" = '${CalendarChannelSyncStage.CALENDAR_EVENT_LIST_FETCH_PENDING}' RETURNING *`,\n         );\n \n         for (const calendarChannel of calendarChannels) {\ndiff --git a/packages/twenty-server/src/modules/calendar/calendar-event-import-manager/crons/jobs/calendar-events-import.cron.job.ts b/packages/twenty-server/src/modules/calendar/calendar-event-import-manager/crons/jobs/calendar-events-import.cron.job.ts\nindex e75e462985971..c5e3318585ec6 100644\n--- a/packages/twenty-server/src/modules/calendar/calendar-event-import-manager/crons/jobs/calendar-events-import.cron.job.ts\n+++ b/packages/twenty-server/src/modules/calendar/calendar-event-import-manager/crons/jobs/calendar-events-import.cron.job.ts\n@@ -48,8 +48,11 @@ export class CalendarEventsImportCronJob {\n       try {\n         const schemaName = getWorkspaceSchemaName(activeWorkspace.id);\n \n+        const now = new Date().toISOString();\n+\n         const [calendarChannels] = await this.coreDataSource.query(\n-          `UPDATE ${schemaName}.\"calendarChannel\" SET \"syncStage\" = '${CalendarChannelSyncStage.CALENDAR_EVENTS_IMPORT_SCHEDULED}' WHERE \"isSyncEnabled\" = true AND \"syncStage\" = '${CalendarChannelSyncStage.CALENDAR_EVENTS_IMPORT_PENDING}' RETURNING *`,\n+          `UPDATE ${schemaName}.\"calendarChannel\" SET \"syncStage\" = '${CalendarChannelSyncStage.CALENDAR_EVENTS_IMPORT_SCHEDULED}', \"syncStageStartedAt\" = '${now}'\n+           WHERE \"isSyncEnabled\" = true AND \"syncStage\" = '${CalendarChannelSyncStage.CALENDAR_EVENTS_IMPORT_PENDING}' RETURNING *`,\n         );\n \n         for (const calendarChannel of calendarChannels) {\ndiff --git a/packages/twenty-server/src/modules/messaging/common/services/message-channel-sync-status.service.ts b/packages/twenty-server/src/modules/messaging/common/services/message-channel-sync-status.service.ts\nindex 9484e8ddc0138..fbfa95484de71 100644\n--- a/packages/twenty-server/src/modules/messaging/common/services/message-channel-sync-status.service.ts\n+++ b/packages/twenty-server/src/modules/messaging/common/services/message-channel-sync-status.service.ts\n@@ -133,6 +133,27 @@ export class MessageChannelSyncStatusService {\n     });\n   }\n \n+  public async markAsMessagesListFetchScheduled(\n+    messageChannelIds: string[],\n+    workspaceId: string,\n+  ) {\n+    if (!messageChannelIds.length) {\n+      return;\n+    }\n+\n+    const messageChannelRepository =\n+      await this.twentyORMGlobalManager.getRepositoryForWorkspace<MessageChannelWorkspaceEntity>(\n+        workspaceId,\n+        'messageChannel',\n+      );\n+\n+    await messageChannelRepository.update(messageChannelIds, {\n+      syncStage: MessageChannelSyncStage.MESSAGE_LIST_FETCH_SCHEDULED,\n+      syncStatus: MessageChannelSyncStatus.ONGOING,\n+      syncStageStartedAt: new Date().toISOString(),\n+    });\n+  }\n+\n   public async markAsMessagesListFetchOngoing(\n     messageChannelIds: string[],\n     workspaceId: string,\n@@ -150,7 +171,6 @@ export class MessageChannelSyncStatusService {\n     await messageChannelRepository.update(messageChannelIds, {\n       syncStage: MessageChannelSyncStage.MESSAGE_LIST_FETCH_ONGOING,\n       syncStatus: MessageChannelSyncStatus.ONGOING,\n-      syncStageStartedAt: new Date().toISOString(),\n     });\n   }\n \n@@ -182,6 +202,25 @@ export class MessageChannelSyncStatusService {\n     });\n   }\n \n+  public async markAsMessagesImportScheduled(\n+    messageChannelIds: string[],\n+    workspaceId: string,\n+  ) {\n+    if (!messageChannelIds.length) {\n+      return;\n+    }\n+\n+    const messageChannelRepository =\n+      await this.twentyORMGlobalManager.getRepositoryForWorkspace<MessageChannelWorkspaceEntity>(\n+        workspaceId,\n+        'messageChannel',\n+      );\n+\n+    await messageChannelRepository.update(messageChannelIds, {\n+      syncStage: MessageChannelSyncStage.MESSAGES_IMPORT_SCHEDULED,\n+    });\n+  }\n+\n   public async markAsMessagesImportOngoing(\n     messageChannelIds: string[],\n     workspaceId: string,\ndiff --git a/packages/twenty-server/src/modules/messaging/message-import-manager/crons/jobs/messaging-message-list-fetch.cron.job.ts b/packages/twenty-server/src/modules/messaging/message-import-manager/crons/jobs/messaging-message-list-fetch.cron.job.ts\nindex e51101b553a37..7e9508919e1a6 100644\n--- a/packages/twenty-server/src/modules/messaging/message-import-manager/crons/jobs/messaging-message-list-fetch.cron.job.ts\n+++ b/packages/twenty-server/src/modules/messaging/message-import-manager/crons/jobs/messaging-message-list-fetch.cron.job.ts\n@@ -48,8 +48,11 @@ export class MessagingMessageListFetchCronJob {\n       try {\n         const schemaName = getWorkspaceSchemaName(activeWorkspace.id);\n \n+        const now = new Date().toISOString();\n+\n         const [messageChannels] = await this.coreDataSource.query(\n-          `UPDATE ${schemaName}.\"messageChannel\" SET \"syncStage\" = '${MessageChannelSyncStage.MESSAGE_LIST_FETCH_SCHEDULED}' WHERE \"isSyncEnabled\" = true AND \"syncStage\" = '${MessageChannelSyncStage.MESSAGE_LIST_FETCH_PENDING}' RETURNING *`,\n+          `UPDATE ${schemaName}.\"messageChannel\" SET \"syncStage\" = '${MessageChannelSyncStage.MESSAGE_LIST_FETCH_SCHEDULED}', \"syncStageStartedAt\" = '${now}'\n+           WHERE \"isSyncEnabled\" = true AND \"syncStage\" = '${MessageChannelSyncStage.MESSAGE_LIST_FETCH_PENDING}' RETURNING *`,\n         );\n \n         for (const messageChannel of messageChannels) {\ndiff --git a/packages/twenty-server/src/modules/messaging/message-import-manager/crons/jobs/messaging-messages-import.cron.job.ts b/packages/twenty-server/src/modules/messaging/message-import-manager/crons/jobs/messaging-messages-import.cron.job.ts\nindex 091197e4ffd45..9397b37e473a5 100644\n--- a/packages/twenty-server/src/modules/messaging/message-import-manager/crons/jobs/messaging-messages-import.cron.job.ts\n+++ b/packages/twenty-server/src/modules/messaging/message-import-manager/crons/jobs/messaging-messages-import.cron.job.ts\n@@ -53,8 +53,11 @@ export class MessagingMessagesImportCronJob {\n       try {\n         const schemaName = getWorkspaceSchemaName(activeWorkspace.id);\n \n+        const now = new Date().toISOString();\n+\n         const [messageChannels] = await this.coreDataSource.query(\n-          `UPDATE ${schemaName}.\"messageChannel\" SET \"syncStage\" = '${MessageChannelSyncStage.MESSAGES_IMPORT_SCHEDULED}' WHERE \"isSyncEnabled\" = true AND \"syncStage\" = '${MessageChannelSyncStage.MESSAGES_IMPORT_PENDING}' RETURNING *`,\n+          `UPDATE ${schemaName}.\"messageChannel\" SET \"syncStage\" = '${MessageChannelSyncStage.MESSAGES_IMPORT_SCHEDULED}', \"syncStageStartedAt\" = '${now}'\n+          WHERE \"isSyncEnabled\" = true AND \"syncStage\" = '${MessageChannelSyncStage.MESSAGES_IMPORT_PENDING}' RETURNING *`,\n         );\n \n         for (const messageChannel of messageChannels) {\ndiff --git a/packages/twenty-server/src/modules/messaging/message-import-manager/services/__tests__/messaging-message-list-fetch.service.spec.ts b/packages/twenty-server/src/modules/messaging/message-import-manager/services/__tests__/messaging-message-list-fetch.service.spec.ts\nindex 1f24fbd578465..ec045ba16c386 100644\n--- a/packages/twenty-server/src/modules/messaging/message-import-manager/services/__tests__/messaging-message-list-fetch.service.spec.ts\n+++ b/packages/twenty-server/src/modules/messaging/message-import-manager/services/__tests__/messaging-message-list-fetch.service.spec.ts\n@@ -291,7 +291,7 @@ describe('MessagingMessageListFetchService', () => {\n     });\n     expect(\n       messageChannelSyncStatusService.markAsMessagesListFetchOngoing,\n-    ).toHaveBeenCalledWith([mockMicrosoftMessageChannel.id]);\n+    ).toHaveBeenCalledWith([mockMicrosoftMessageChannel.id], workspaceId);\n \n     expect(messagingGetMessageListService.getMessageLists).toHaveBeenCalledWith(\n       {\n@@ -332,7 +332,7 @@ describe('MessagingMessageListFetchService', () => {\n \n     expect(\n       messageChannelSyncStatusService.scheduleMessagesImport,\n-    ).toHaveBeenCalledWith([mockMicrosoftMessageChannel.id]);\n+    ).toHaveBeenCalledWith([mockMicrosoftMessageChannel.id], workspaceId);\n   });\n \n   it('should process Google message list fetch correctly', async () => {\n@@ -350,7 +350,7 @@ describe('MessagingMessageListFetchService', () => {\n     });\n     expect(\n       messageChannelSyncStatusService.markAsMessagesListFetchOngoing,\n-    ).toHaveBeenCalledWith([mockGoogleMessageChannel.id]);\n+    ).toHaveBeenCalledWith([mockGoogleMessageChannel.id], workspaceId);\n \n     expect(messagingGetMessageListService.getMessageLists).toHaveBeenCalledWith(\n       {\n@@ -391,6 +391,6 @@ describe('MessagingMessageListFetchService', () => {\n \n     expect(\n       messageChannelSyncStatusService.scheduleMessagesImport,\n-    ).toHaveBeenCalledWith([mockGoogleMessageChannel.id]);\n+    ).toHaveBeenCalledWith([mockGoogleMessageChannel.id], workspaceId);\n   });\n });\ndiff --git a/packages/twenty-server/src/modules/messaging/message-import-manager/services/__tests__/messaging-messages-import.service.spec.ts b/packages/twenty-server/src/modules/messaging/message-import-manager/services/__tests__/messaging-messages-import.service.spec.ts\nindex f11d03923f6c2..f4e7cba4f730a 100644\n--- a/packages/twenty-server/src/modules/messaging/message-import-manager/services/__tests__/messaging-messages-import.service.spec.ts\n+++ b/packages/twenty-server/src/modules/messaging/message-import-manager/services/__tests__/messaging-messages-import.service.spec.ts\n@@ -213,7 +213,7 @@ describe('MessagingMessagesImportService', () => {\n     );\n     expect(\n       messageChannelSyncStatusService.markAsMessagesImportOngoing,\n-    ).toHaveBeenCalledWith([mockMessageChannel.id]);\n+    ).toHaveBeenCalledWith([mockMessageChannel.id], workspaceId);\n \n     expect(\n       connectedAccountRefreshTokensService.refreshAndSaveTokens,\n"}
{"instance_id": "twentyhq__twenty.main.16299", "repo": "twentyhq/twenty", "base_commit": "3a14fe8a76b6678c5de02ec0733eae6b0903753d", "head_commit": "caddb3b01ac30e69015a92fb098d96dee01b648f", "title": "add `is not` operand on numeric fields", "merged_at": "2025-12-04T13:25:24Z", "html_url": "https://github.com/twentyhq/twenty/pull/16299", "test_files": ["packages/twenty-front/src/modules/object-record/object-filter-dropdown/utils/__tests__/getOperandsForFilterType.test.ts", "packages/twenty-front/src/modules/object-record/record-table/utils/buildRecordInputFromFilter.spec.ts", "packages/twenty-server/src/modules/workflow/workflow-executor/workflow-actions/filter/utils/__tests__/evaluate-filter-conditions.util.spec.ts"], "code_files": ["packages/twenty-front/src/modules/object-record/record-filter/utils/getRecordFilterOperands.ts", "packages/twenty-front/src/modules/object-record/record-table/utils/buildRecordInputFromFilter.ts", "packages/twenty-front/src/modules/workflow/workflow-steps/workflow-actions/filter-action/utils/getStepFilterOperands.ts", "packages/twenty-server/src/modules/workflow/workflow-executor/workflow-actions/filter/utils/evaluate-filter-conditions.util.ts", "packages/twenty-shared/src/utils/filter/turnRecordFilterIntoGqlOperationFilter.ts"], "total_changes": 47, "num_files": 8, "pull_number": 16299, "patch": "diff --git a/packages/twenty-front/src/modules/object-record/object-filter-dropdown/utils/__tests__/getOperandsForFilterType.test.ts b/packages/twenty-front/src/modules/object-record/object-filter-dropdown/utils/__tests__/getOperandsForFilterType.test.ts\nindex ced4abf738f0a..ecc0b47c9d777 100644\n--- a/packages/twenty-front/src/modules/object-record/object-filter-dropdown/utils/__tests__/getOperandsForFilterType.test.ts\n+++ b/packages/twenty-front/src/modules/object-record/object-filter-dropdown/utils/__tests__/getOperandsForFilterType.test.ts\n@@ -17,6 +17,7 @@ describe('getOperandsForFilterType', () => {\n \n   const numberOperands = [\n     RecordFilterOperand.IS,\n+    RecordFilterOperand.IS_NOT,\n     RecordFilterOperand.GREATER_THAN_OR_EQUAL,\n     RecordFilterOperand.LESS_THAN_OR_EQUAL,\n   ];\ndiff --git a/packages/twenty-front/src/modules/object-record/record-filter/utils/getRecordFilterOperands.ts b/packages/twenty-front/src/modules/object-record/record-filter/utils/getRecordFilterOperands.ts\nindex d11443cc97c2b..791f78357f556 100644\n--- a/packages/twenty-front/src/modules/object-record/record-filter/utils/getRecordFilterOperands.ts\n+++ b/packages/twenty-front/src/modules/object-record/record-filter/utils/getRecordFilterOperands.ts\n@@ -74,6 +74,7 @@ export const FILTER_OPERANDS_MAP = {\n   ],\n   NUMBER: [\n     RecordFilterOperand.IS,\n+    RecordFilterOperand.IS_NOT,\n     RecordFilterOperand.GREATER_THAN_OR_EQUAL,\n     RecordFilterOperand.LESS_THAN_OR_EQUAL,\n     ...emptyOperands,\ndiff --git a/packages/twenty-front/src/modules/object-record/record-table/utils/buildRecordInputFromFilter.spec.ts b/packages/twenty-front/src/modules/object-record/record-table/utils/buildRecordInputFromFilter.spec.ts\nindex 36d013ceca576..9a23800934905 100644\n--- a/packages/twenty-front/src/modules/object-record/record-table/utils/buildRecordInputFromFilter.spec.ts\n+++ b/packages/twenty-front/src/modules/object-record/record-table/utils/buildRecordInputFromFilter.spec.ts\n@@ -139,6 +139,11 @@ describe('buildValueFromFilter', () => {\n         value: '5',\n         expected: 5,\n       },\n+      {\n+        operand: ViewFilterOperand.IS_NOT,\n+        value: '5',\n+        expected: undefined,\n+      },\n       {\n         operand: ViewFilterOperand.GREATER_THAN_OR_EQUAL,\n         value: '5',\ndiff --git a/packages/twenty-front/src/modules/object-record/record-table/utils/buildRecordInputFromFilter.ts b/packages/twenty-front/src/modules/object-record/record-table/utils/buildRecordInputFromFilter.ts\nindex 898e3e6201182..c5ad711e0b403 100644\n--- a/packages/twenty-front/src/modules/object-record/record-table/utils/buildRecordInputFromFilter.ts\n+++ b/packages/twenty-front/src/modules/object-record/record-table/utils/buildRecordInputFromFilter.ts\n@@ -159,6 +159,8 @@ const computeValueFromFilterNumber = (\n       return Number(value);\n     case ViewFilterOperand.IS:\n       return Number(value);\n+    case ViewFilterOperand.IS_NOT:\n+      return undefined;\n     case ViewFilterOperand.IS_EMPTY:\n       return undefined;\n     default:\ndiff --git a/packages/twenty-front/src/modules/workflow/workflow-steps/workflow-actions/filter-action/utils/getStepFilterOperands.ts b/packages/twenty-front/src/modules/workflow/workflow-steps/workflow-actions/filter-action/utils/getStepFilterOperands.ts\nindex 74b8ceabb998f..96d95db4525b2 100644\n--- a/packages/twenty-front/src/modules/workflow/workflow-steps/workflow-actions/filter-action/utils/getStepFilterOperands.ts\n+++ b/packages/twenty-front/src/modules/workflow/workflow-steps/workflow-actions/filter-action/utils/getStepFilterOperands.ts\n@@ -28,6 +28,7 @@ export const FILTER_OPERANDS_MAP = {\n   ],\n   NUMBER: [\n     ViewFilterOperand.IS,\n+    ViewFilterOperand.IS_NOT,\n     ViewFilterOperand.GREATER_THAN_OR_EQUAL,\n     ViewFilterOperand.LESS_THAN_OR_EQUAL,\n     ...emptyOperands,\n@@ -64,6 +65,7 @@ export const FILTER_OPERANDS_MAP = {\n   UUID: [ViewFilterOperand.IS, ViewFilterOperand.IS_NOT],\n   NUMERIC: [\n     ViewFilterOperand.IS,\n+    ViewFilterOperand.IS_NOT,\n     ViewFilterOperand.GREATER_THAN_OR_EQUAL,\n     ViewFilterOperand.LESS_THAN_OR_EQUAL,\n     ...emptyOperands,\ndiff --git a/packages/twenty-server/src/modules/workflow/workflow-executor/workflow-actions/filter/utils/__tests__/evaluate-filter-conditions.util.spec.ts b/packages/twenty-server/src/modules/workflow/workflow-executor/workflow-actions/filter/utils/__tests__/evaluate-filter-conditions.util.spec.ts\nindex 01b408956e545..7fbb7efcedb63 100644\n--- a/packages/twenty-server/src/modules/workflow/workflow-executor/workflow-actions/filter/utils/__tests__/evaluate-filter-conditions.util.spec.ts\n+++ b/packages/twenty-server/src/modules/workflow/workflow-executor/workflow-actions/filter/utils/__tests__/evaluate-filter-conditions.util.spec.ts\n@@ -484,6 +484,31 @@ describe('evaluateFilterConditions', () => {\n         expect(evaluateFilterConditions({ filters: [filter2] })).toBe(false);\n         expect(evaluateFilterConditions({ filters: [filter3] })).toBe(false);\n       });\n+\n+      it('should handle IsNot operand correctly', () => {\n+        const filter1 = createFilter(\n+          ViewFilterOperand.IS_NOT,\n+          25,\n+          25,\n+          'NUMBER',\n+        );\n+        const filter2 = createFilter(\n+          ViewFilterOperand.IS_NOT,\n+          20,\n+          25,\n+          'NUMBER',\n+        );\n+        const filter3 = createFilter(\n+          ViewFilterOperand.IS_NOT,\n+          30,\n+          25,\n+          'NUMBER',\n+        );\n+\n+        expect(evaluateFilterConditions({ filters: [filter1] })).toBe(false);\n+        expect(evaluateFilterConditions({ filters: [filter2] })).toBe(true);\n+        expect(evaluateFilterConditions({ filters: [filter3] })).toBe(true);\n+      });\n     });\n \n     describe('string and array operands', () => {\ndiff --git a/packages/twenty-server/src/modules/workflow/workflow-executor/workflow-actions/filter/utils/evaluate-filter-conditions.util.ts b/packages/twenty-server/src/modules/workflow/workflow-executor/workflow-actions/filter/utils/evaluate-filter-conditions.util.ts\nindex 743a659ec0b66..efebf74c3134c 100644\n--- a/packages/twenty-server/src/modules/workflow/workflow-executor/workflow-actions/filter/utils/evaluate-filter-conditions.util.ts\n+++ b/packages/twenty-server/src/modules/workflow/workflow-executor/workflow-actions/filter/utils/evaluate-filter-conditions.util.ts\n@@ -349,6 +349,9 @@ function evaluateNumberFilter(filter: ResolvedFilter): boolean {\n     case ViewFilterOperand.IS:\n       return Number(leftValue) === Number(rightValue);\n \n+    case ViewFilterOperand.IS_NOT:\n+      return Number(leftValue) !== Number(rightValue);\n+\n     default:\n       throw new Error(\n         `Operand ${filter.operand} not supported for number filter`,\ndiff --git a/packages/twenty-shared/src/utils/filter/turnRecordFilterIntoGqlOperationFilter.ts b/packages/twenty-shared/src/utils/filter/turnRecordFilterIntoGqlOperationFilter.ts\nindex b2baffea11c40..dc517c6cd6178 100644\n--- a/packages/twenty-shared/src/utils/filter/turnRecordFilterIntoGqlOperationFilter.ts\n+++ b/packages/twenty-shared/src/utils/filter/turnRecordFilterIntoGqlOperationFilter.ts\n@@ -416,6 +416,14 @@ export const turnRecordFilterIntoRecordGqlOperationFilter = ({\n               eq: parseFloat(recordFilter.value),\n             } as FloatFilter,\n           };\n+        case RecordFilterOperand.IS_NOT:\n+          return {\n+            not: {\n+              [correspondingFieldMetadataItem.name]: {\n+                eq: parseFloat(recordFilter.value),\n+              } as FloatFilter,\n+            },\n+          };\n         default:\n           throw new Error(\n             `Unknown operand ${recordFilter.operand} for ${filterType} filter`,\n"}
{"instance_id": "twentyhq__twenty.main.16297", "repo": "twentyhq/twenty", "base_commit": "35319ee13f308d19ee58b79081e405e41aa04956", "head_commit": "4970c745e07b05e77e58b0dcffef66d6871107b2", "title": "Fix caldav issues", "merged_at": "2025-12-04T13:34:21Z", "html_url": "https://github.com/twentyhq/twenty/pull/16297", "test_files": ["packages/twenty-server/src/modules/connected-account/services/imap-smtp-caldav-apis.service.spec.ts"], "code_files": ["packages/twenty-front/src/pages/settings/accounts/SettingsAccountsConfiguration.tsx", "packages/twenty-server/src/engine/core-modules/imap-smtp-caldav-connection/services/imap-smtp-caldav-connection.service.ts", "packages/twenty-server/src/modules/calendar/calendar-event-import-manager/drivers/caldav/lib/caldav.client.ts", "packages/twenty-server/src/modules/calendar/calendar-event-import-manager/services/calendar-account-authentication.service.ts", "packages/twenty-server/src/modules/connected-account/services/imap-smtp-caldav-apis.service.ts"], "total_changes": 118, "num_files": 6, "pull_number": 16297, "patch": "diff --git a/packages/twenty-front/src/pages/settings/accounts/SettingsAccountsConfiguration.tsx b/packages/twenty-front/src/pages/settings/accounts/SettingsAccountsConfiguration.tsx\nindex e2fc73c918cd1..e6126b8702909 100644\n--- a/packages/twenty-front/src/pages/settings/accounts/SettingsAccountsConfiguration.tsx\n+++ b/packages/twenty-front/src/pages/settings/accounts/SettingsAccountsConfiguration.tsx\n@@ -99,31 +99,32 @@ export const SettingsAccountsConfiguration = () => {\n     });\n   };\n \n-  switch (currentStep) {\n-    case SettingsAccountsConfigurationStep.Email:\n-      if (!isDefined(messageChannel)) {\n-        return null;\n-      }\n-      return (\n-        <SettingsAccountsConfigurationStepEmail\n-          messageChannel={messageChannel}\n-          hasNextStep={isDefined(calendarChannel)}\n-          isSubmitting={isSubmitting}\n-          onNext={handleNext}\n-          onAddAccount={handleAddAccount}\n-        />\n-      );\n-    case SettingsAccountsConfigurationStep.Calendar:\n-      if (!isDefined(calendarChannel)) {\n-        return null;\n-      }\n-      return (\n-        <SettingsAccountsConfigurationStepCalendar\n-          calendarChannel={calendarChannel}\n-          messageChannel={messageChannel}\n-          isSubmitting={isSubmitting}\n-          onAddAccount={handleAddAccount}\n-        />\n-      );\n+  const showEmailStep =\n+    currentStep === SettingsAccountsConfigurationStep.Email &&\n+    isDefined(messageChannel);\n+\n+  if (showEmailStep) {\n+    return (\n+      <SettingsAccountsConfigurationStepEmail\n+        messageChannel={messageChannel}\n+        hasNextStep={isDefined(calendarChannel)}\n+        isSubmitting={isSubmitting}\n+        onNext={handleNext}\n+        onAddAccount={handleAddAccount}\n+      />\n+    );\n   }\n+\n+  if (!isDefined(calendarChannel)) {\n+    return null;\n+  }\n+\n+  return (\n+    <SettingsAccountsConfigurationStepCalendar\n+      calendarChannel={calendarChannel}\n+      messageChannel={messageChannel}\n+      isSubmitting={isSubmitting}\n+      onAddAccount={handleAddAccount}\n+    />\n+  );\n };\ndiff --git a/packages/twenty-server/src/engine/core-modules/imap-smtp-caldav-connection/services/imap-smtp-caldav-connection.service.ts b/packages/twenty-server/src/engine/core-modules/imap-smtp-caldav-connection/services/imap-smtp-caldav-connection.service.ts\nindex 05f11b46d0dbd..a71b9d68a8ed7 100644\n--- a/packages/twenty-server/src/engine/core-modules/imap-smtp-caldav-connection/services/imap-smtp-caldav-connection.service.ts\n+++ b/packages/twenty-server/src/engine/core-modules/imap-smtp-caldav-connection/services/imap-smtp-caldav-connection.service.ts\n@@ -139,7 +139,7 @@ export class ImapSmtpCaldavService {\n       }\n \n       throw new UserInputError(`CALDAV connection failed: ${error.message}`, {\n-        userFriendlyMessage: msg`Invalid credentials. Please check your username and password.`,\n+        userFriendlyMessage: msg`Invalid CALDAV credentials. Please check your username and password.`,\n       });\n     }\n \ndiff --git a/packages/twenty-server/src/modules/calendar/calendar-event-import-manager/drivers/caldav/lib/caldav.client.ts b/packages/twenty-server/src/modules/calendar/calendar-event-import-manager/drivers/caldav/lib/caldav.client.ts\nindex 882bf065e6fd0..6299f85743fa2 100644\n--- a/packages/twenty-server/src/modules/calendar/calendar-event-import-manager/drivers/caldav/lib/caldav.client.ts\n+++ b/packages/twenty-server/src/modules/calendar/calendar-event-import-manager/drivers/caldav/lib/caldav.client.ts\n@@ -84,7 +84,7 @@ export class CalDAVClient {\n     if (!this.hasFileExtension(url)) return 'ics';\n     const fileName = url.substring(url.lastIndexOf('/') + 1);\n \n-    return fileName.substring(fileName.lastIndexOf('.') + 1);\n+    return fileName.substring(fileName.lastIndexOf('.') + 1).toLowerCase();\n   }\n \n   private isValidFormat(url: string): boolean {\ndiff --git a/packages/twenty-server/src/modules/calendar/calendar-event-import-manager/services/calendar-account-authentication.service.ts b/packages/twenty-server/src/modules/calendar/calendar-event-import-manager/services/calendar-account-authentication.service.ts\nindex 6b058f07d5865..b941469f779f4 100644\n--- a/packages/twenty-server/src/modules/calendar/calendar-event-import-manager/services/calendar-account-authentication.service.ts\n+++ b/packages/twenty-server/src/modules/calendar/calendar-event-import-manager/services/calendar-account-authentication.service.ts\n@@ -33,7 +33,7 @@ export class CalendarAccountAuthenticationService {\n   }: ValidateAndRefreshConnectedAccountAuthenticationParams): Promise<ConnectedAccountTokens> {\n     if (\n       connectedAccount.provider === ConnectedAccountProvider.IMAP_SMTP_CALDAV &&\n-      isDefined(connectedAccount.connectionParameters?.SMTP)\n+      isDefined(connectedAccount.connectionParameters?.CALDAV)\n     ) {\n       await this.validateCalDavCredentialsForConnectedAccount({\n         connectedAccount,\ndiff --git a/packages/twenty-server/src/modules/connected-account/services/imap-smtp-caldav-apis.service.spec.ts b/packages/twenty-server/src/modules/connected-account/services/imap-smtp-caldav-apis.service.spec.ts\nindex 15ee83933f9b9..f4cdc512412e2 100644\n--- a/packages/twenty-server/src/modules/connected-account/services/imap-smtp-caldav-apis.service.spec.ts\n+++ b/packages/twenty-server/src/modules/connected-account/services/imap-smtp-caldav-apis.service.spec.ts\n@@ -261,7 +261,7 @@ describe('ImapSmtpCalDavAPIService', () => {\n       expect(mockCalendarQueueService.add).not.toHaveBeenCalled();\n     });\n \n-    it('should create both channels when only CALDAV is configured but disable message sync', async () => {\n+    it('should only create calendar channel when only CALDAV is configured', async () => {\n       const caldavOnlyInput = {\n         ...baseInput,\n         connectionParameters: {\n@@ -282,7 +282,6 @@ describe('ImapSmtpCalDavAPIService', () => {\n       const expectedCalendarChannel = {\n         id: 'mocked-uuid',\n         connectedAccountId: 'mocked-uuid',\n-\n         handle: 'test@example.com',\n       };\n \n@@ -292,21 +291,7 @@ describe('ImapSmtpCalDavAPIService', () => {\n \n       await service.processAccount(caldavOnlyInput);\n \n-      expect(mockMessageChannelRepository.save).toHaveBeenCalledWith(\n-        {\n-          id: 'mocked-uuid',\n-          connectedAccountId: 'mocked-uuid',\n-          type: MessageChannelType.EMAIL,\n-          handle: 'test@example.com',\n-          isSyncEnabled: false,\n-          syncStatus: MessageChannelSyncStatus.NOT_SYNCED,\n-          syncStage: MessageChannelSyncStage.PENDING_CONFIGURATION,\n-          pendingGroupEmailsAction: MessageChannelPendingGroupEmailsAction.NONE,\n-          syncCursor: '',\n-          syncStageStartedAt: null,\n-        },\n-        {},\n-      );\n+      expect(mockMessageChannelRepository.save).not.toHaveBeenCalled();\n       expect(mockCalendarChannelRepository.save).toHaveBeenCalled();\n \n       expect(mockMessageQueueService.add).not.toHaveBeenCalled();\ndiff --git a/packages/twenty-server/src/modules/connected-account/services/imap-smtp-caldav-apis.service.ts b/packages/twenty-server/src/modules/connected-account/services/imap-smtp-caldav-apis.service.ts\nindex 74640cf84db03..b726bf96b6a96 100644\n--- a/packages/twenty-server/src/modules/connected-account/services/imap-smtp-caldav-apis.service.ts\n+++ b/packages/twenty-server/src/modules/connected-account/services/imap-smtp-caldav-apis.service.ts\n@@ -138,25 +138,29 @@ export class ImapSmtpCalDavAPIService {\n     accountId: string,\n     messageChannelRepository: WorkspaceRepository<MessageChannelWorkspaceEntity>,\n   ): Promise<MessageChannelWorkspaceEntity | null> {\n-    const shouldEnableSync = Boolean(input.connectionParameters.IMAP);\n-\n-    const newMessageChannel = await messageChannelRepository.save(\n-      {\n-        id: v4(),\n-        connectedAccountId: accountId,\n-        type: MessageChannelType.EMAIL,\n-        handle: input.handle,\n-        isSyncEnabled: shouldEnableSync,\n-        syncStatus: MessageChannelSyncStatus.NOT_SYNCED,\n-        syncStage: MessageChannelSyncStage.PENDING_CONFIGURATION,\n-        pendingGroupEmailsAction: MessageChannelPendingGroupEmailsAction.NONE,\n-        syncCursor: '',\n-        syncStageStartedAt: null,\n-      },\n-      {},\n-    );\n+    const shouldCreateMessageChannel = Boolean(input.connectionParameters.IMAP);\n+\n+    if (shouldCreateMessageChannel) {\n+      const newMessageChannel = await messageChannelRepository.save(\n+        {\n+          id: v4(),\n+          connectedAccountId: accountId,\n+          type: MessageChannelType.EMAIL,\n+          handle: input.handle,\n+          isSyncEnabled: true,\n+          syncStatus: MessageChannelSyncStatus.NOT_SYNCED,\n+          syncStage: MessageChannelSyncStage.PENDING_CONFIGURATION,\n+          pendingGroupEmailsAction: MessageChannelPendingGroupEmailsAction.NONE,\n+          syncCursor: '',\n+          syncStageStartedAt: null,\n+        },\n+        {},\n+      );\n \n-    return shouldEnableSync ? newMessageChannel : null;\n+      return newMessageChannel;\n+    }\n+\n+    return null;\n   }\n \n   private async setupCalendarChannels(\n"}
{"instance_id": "twentyhq__twenty.main.16211", "repo": "twentyhq/twenty", "base_commit": "f489bbdbab893278ec8b808a71cc01f1ad29e2a1", "head_commit": "23b4adc033174bb3f4326176c2aeee7cefb460b8", "title": "[Dashboards] - fast follows - inverse default value for centre metric and filter count on chart settings", "merged_at": "2025-12-01T16:19:57Z", "html_url": "https://github.com/twentyhq/twenty/pull/16211", "test_files": ["packages/twenty-front/src/modules/command-menu/pages/page-layout/utils/__tests__/getChartFilterRulesCount.test.ts"], "code_files": ["packages/twenty-front/src/modules/command-menu/pages/page-layout/components/chart-settings/ChartSettingItem.tsx", "packages/twenty-front/src/modules/command-menu/pages/page-layout/hooks/useChartSettingsValues.ts", "packages/twenty-front/src/modules/command-menu/pages/page-layout/utils/getChartFilterRulesCount.ts", "packages/twenty-front/src/modules/page-layout/widgets/graph/graphWidgetPieChart/components/GraphWidgetPieChart.tsx", "packages/twenty-front/src/modules/page-layout/widgets/graph/graphWidgetPieChart/hooks/useGraphPieChartWidgetData.ts", "packages/twenty-server/src/engine/core-modules/page-layout/dtos/pie-chart-configuration.dto.ts"], "total_changes": 101, "num_files": 7, "pull_number": 16211, "patch": "diff --git a/packages/twenty-front/src/modules/command-menu/pages/page-layout/components/chart-settings/ChartSettingItem.tsx b/packages/twenty-front/src/modules/command-menu/pages/page-layout/components/chart-settings/ChartSettingItem.tsx\nindex 8f8e795cd7dbc..45f2291deb7ef 100644\n--- a/packages/twenty-front/src/modules/command-menu/pages/page-layout/components/chart-settings/ChartSettingItem.tsx\n+++ b/packages/twenty-front/src/modules/command-menu/pages/page-layout/components/chart-settings/ChartSettingItem.tsx\n@@ -34,6 +34,9 @@ export const ChartSettingItem = ({\n   onFilterClick,\n }: ChartSettingItemProps) => {\n   if (item.id === CHART_CONFIGURATION_SETTING_IDS.FILTER) {\n+    const filterValue = getChartSettingsValues(item.id);\n+    const filterDescription = isString(filterValue) ? filterValue : undefined;\n+\n     return (\n       <SelectableListItem\n         key={item.id}\n@@ -46,6 +49,8 @@ export const ChartSettingItem = ({\n           Icon={item.Icon}\n           hasSubMenu\n           onClick={onFilterClick}\n+          description={filterDescription}\n+          contextualTextPosition=\"right\"\n         />\n       </SelectableListItem>\n     );\ndiff --git a/packages/twenty-front/src/modules/command-menu/pages/page-layout/hooks/useChartSettingsValues.ts b/packages/twenty-front/src/modules/command-menu/pages/page-layout/hooks/useChartSettingsValues.ts\nindex aa760e8de6711..7798663623ab2 100644\n--- a/packages/twenty-front/src/modules/command-menu/pages/page-layout/hooks/useChartSettingsValues.ts\n+++ b/packages/twenty-front/src/modules/command-menu/pages/page-layout/hooks/useChartSettingsValues.ts\n@@ -3,11 +3,13 @@ import { useGraphXSortOptionLabels } from '@/command-menu/pages/page-layout/hook\n import { type ChartConfiguration } from '@/command-menu/pages/page-layout/types/ChartConfiguration';\n import { CHART_CONFIGURATION_SETTING_IDS } from '@/command-menu/pages/page-layout/types/ChartConfigurationSettingIds';\n import { getChartAxisNameDisplayOptions } from '@/command-menu/pages/page-layout/utils/getChartAxisNameDisplayOptions';\n+import { getChartFilterRulesCount } from '@/command-menu/pages/page-layout/utils/getChartFilterRulesCount';\n import { getDateGranularityLabel } from '@/command-menu/pages/page-layout/utils/getDateGranularityLabel';\n import { getFieldLabelWithSubField } from '@/command-menu/pages/page-layout/utils/getFieldLabelWithSubField';\n import { objectMetadataItemsState } from '@/object-metadata/states/objectMetadataItemsState';\n import { getAggregateOperationLabel } from '@/object-record/record-board/record-board-column/utils/getAggregateOperationLabel';\n import { convertAggregateOperationToExtendedAggregateOperation } from '@/object-record/utils/convertAggregateOperationToExtendedAggregateOperation';\n+import { plural } from '@lingui/core/macro';\n import { useRecoilValue } from 'recoil';\n import { type CompositeFieldSubFieldName } from 'twenty-shared/types';\n import { capitalize, isDefined } from 'twenty-shared/utils';\n@@ -201,9 +203,18 @@ export const useChartSettingsValues = ({\n         return groupByOrderByLabel;\n       case CHART_CONFIGURATION_SETTING_IDS.DATA_LABELS:\n         return configuration.displayDataLabel ?? undefined;\n+      case CHART_CONFIGURATION_SETTING_IDS.FILTER: {\n+        const filterRulesCount = getChartFilterRulesCount(configuration.filter);\n+        return filterRulesCount > 0\n+          ? plural(filterRulesCount, {\n+              one: `${filterRulesCount} rule`,\n+              other: `${filterRulesCount} rules`,\n+            })\n+          : undefined;\n+      }\n       case CHART_CONFIGURATION_SETTING_IDS.CENTER_METRIC:\n         return isPieChart\n-          ? (configuration.showCenterMetric ?? undefined)\n+          ? (configuration.showCenterMetric ?? true)\n           : undefined;\n       case CHART_CONFIGURATION_SETTING_IDS.STACKED_BARS:\n         return configuration.__typename === 'BarChartConfiguration'\ndiff --git a/packages/twenty-front/src/modules/command-menu/pages/page-layout/utils/__tests__/getChartFilterRulesCount.test.ts b/packages/twenty-front/src/modules/command-menu/pages/page-layout/utils/__tests__/getChartFilterRulesCount.test.ts\nnew file mode 100644\nindex 0000000000000..1cec14447a7fd\n--- /dev/null\n+++ b/packages/twenty-front/src/modules/command-menu/pages/page-layout/utils/__tests__/getChartFilterRulesCount.test.ts\n@@ -0,0 +1,46 @@\n+import { type ChartFilters } from '@/command-menu/pages/page-layout/types/ChartFilters';\n+import { getChartFilterRulesCount } from '@/command-menu/pages/page-layout/utils/getChartFilterRulesCount';\n+\n+describe('getChartFilterRulesCount', () => {\n+  it('should return 0 for undefined filter', () => {\n+    expect(getChartFilterRulesCount(undefined)).toBe(0);\n+  });\n+\n+  it('should return 0 when no root group exists', () => {\n+    const filter: ChartFilters = {\n+      recordFilters: [],\n+      recordFilterGroups: [],\n+    };\n+\n+    expect(getChartFilterRulesCount(filter)).toBe(0);\n+  });\n+\n+  it('should return count of filters in root group', () => {\n+    const filter: ChartFilters = {\n+      recordFilterGroups: [\n+        { id: 'root', parentRecordFilterGroupId: undefined },\n+      ],\n+      recordFilters: [\n+        { id: 'filter-1', recordFilterGroupId: 'root' },\n+        { id: 'filter-2', recordFilterGroupId: 'root' },\n+      ],\n+    } as ChartFilters;\n+\n+    expect(getChartFilterRulesCount(filter)).toBe(2);\n+  });\n+\n+  it('should count both direct filters and nested groups as children', () => {\n+    const filter: ChartFilters = {\n+      recordFilterGroups: [\n+        { id: 'root', parentRecordFilterGroupId: undefined },\n+        { id: 'nested-group', parentRecordFilterGroupId: 'root' },\n+      ],\n+      recordFilters: [\n+        { id: 'filter-1', recordFilterGroupId: 'root' },\n+        { id: 'filter-2', recordFilterGroupId: 'nested-group' },\n+      ],\n+    } as ChartFilters;\n+\n+    expect(getChartFilterRulesCount(filter)).toBe(2);\n+  });\n+});\ndiff --git a/packages/twenty-front/src/modules/command-menu/pages/page-layout/utils/getChartFilterRulesCount.ts b/packages/twenty-front/src/modules/command-menu/pages/page-layout/utils/getChartFilterRulesCount.ts\nnew file mode 100644\nindex 0000000000000..da231a1a04574\n--- /dev/null\n+++ b/packages/twenty-front/src/modules/command-menu/pages/page-layout/utils/getChartFilterRulesCount.ts\n@@ -0,0 +1,31 @@\n+import { type ChartFilters } from '@/command-menu/pages/page-layout/types/ChartFilters';\n+import { isDefined } from 'twenty-shared/utils';\n+\n+export const getChartFilterRulesCount = (\n+  filter: ChartFilters | undefined,\n+): number => {\n+  if (!isDefined(filter)) {\n+    return 0;\n+  }\n+\n+  const recordFilters = filter.recordFilters ?? [];\n+  const recordFilterGroups = filter.recordFilterGroups ?? [];\n+\n+  const rootGroup = recordFilterGroups.find(\n+    (group) => !isDefined(group.parentRecordFilterGroupId),\n+  );\n+\n+  if (!isDefined(rootGroup)) {\n+    return 0;\n+  }\n+\n+  const childFiltersCount = recordFilters.filter(\n+    (recordFilter) => recordFilter.recordFilterGroupId === rootGroup.id,\n+  ).length;\n+\n+  const childGroupsCount = recordFilterGroups.filter(\n+    (group) => group.parentRecordFilterGroupId === rootGroup.id,\n+  ).length;\n+\n+  return childFiltersCount + childGroupsCount;\n+};\ndiff --git a/packages/twenty-front/src/modules/page-layout/widgets/graph/graphWidgetPieChart/components/GraphWidgetPieChart.tsx b/packages/twenty-front/src/modules/page-layout/widgets/graph/graphWidgetPieChart/components/GraphWidgetPieChart.tsx\nindex 190bbc878dc0f..ae063d786ef84 100644\n--- a/packages/twenty-front/src/modules/page-layout/widgets/graph/graphWidgetPieChart/components/GraphWidgetPieChart.tsx\n+++ b/packages/twenty-front/src/modules/page-layout/widgets/graph/graphWidgetPieChart/components/GraphWidgetPieChart.tsx\n@@ -71,7 +71,7 @@ export const GraphWidgetPieChart = ({\n   customFormatter,\n   onSliceClick,\n   showDataLabels = false,\n-  showCenterMetric = false,\n+  showCenterMetric = true,\n }: GraphWidgetPieChartProps) => {\n   const theme = useTheme();\n   const colorRegistry = createGraphColorRegistry(theme);\ndiff --git a/packages/twenty-front/src/modules/page-layout/widgets/graph/graphWidgetPieChart/hooks/useGraphPieChartWidgetData.ts b/packages/twenty-front/src/modules/page-layout/widgets/graph/graphWidgetPieChart/hooks/useGraphPieChartWidgetData.ts\nindex cdbc279ad5909..bceac7a8ba3f2 100644\n--- a/packages/twenty-front/src/modules/page-layout/widgets/graph/graphWidgetPieChart/hooks/useGraphPieChartWidgetData.ts\n+++ b/packages/twenty-front/src/modules/page-layout/widgets/graph/graphWidgetPieChart/hooks/useGraphPieChartWidgetData.ts\n@@ -61,7 +61,7 @@ export const useGraphPieChartWidgetData = ({\n     ...transformedData,\n     objectMetadataItem,\n     showDataLabels: configuration.displayDataLabel ?? false,\n-    showCenterMetric: configuration.showCenterMetric ?? false,\n+    showCenterMetric: configuration.showCenterMetric ?? true,\n     loading,\n     error,\n   };\ndiff --git a/packages/twenty-server/src/engine/core-modules/page-layout/dtos/pie-chart-configuration.dto.ts b/packages/twenty-server/src/engine/core-modules/page-layout/dtos/pie-chart-configuration.dto.ts\nindex 13014c268d5d1..3abdd1db3a6c8 100644\n--- a/packages/twenty-server/src/engine/core-modules/page-layout/dtos/pie-chart-configuration.dto.ts\n+++ b/packages/twenty-server/src/engine/core-modules/page-layout/dtos/pie-chart-configuration.dto.ts\n@@ -71,7 +71,7 @@ export class PieChartConfigurationDTO {\n   @IsOptional()\n   displayDataLabel?: boolean;\n \n-  @Field(() => Boolean, { nullable: true, defaultValue: false })\n+  @Field(() => Boolean, { nullable: true, defaultValue: true })\n   @IsBoolean()\n   @IsOptional()\n   showCenterMetric?: boolean;\n"}
{"instance_id": "twentyhq__twenty.main.16166", "repo": "twentyhq/twenty", "base_commit": "eb362c6d5f65eb49c726a6a2eccb2603732b8957", "head_commit": "a91ba6dd0aa7cb1e592bad5a9e181fe1fc62638b", "title": "Release line chart and pie chart", "merged_at": "2025-11-28T10:17:04Z", "html_url": "https://github.com/twentyhq/twenty/pull/16166", "test_files": ["packages/twenty-server/src/engine/core-modules/page-layout/utils/__tests__/validate-and-transform-widget-configuration.util.spec.ts"], "code_files": ["packages/twenty-front/src/modules/command-menu/pages/page-layout/components/ChartTypeSelectionSection.tsx", "packages/twenty-server/src/engine/core-modules/page-layout/utils/validate-and-transform-widget-configuration.util.ts"], "total_changes": 81, "num_files": 3, "pull_number": 16166, "patch": "diff --git a/packages/twenty-front/src/modules/command-menu/pages/page-layout/components/ChartTypeSelectionSection.tsx b/packages/twenty-front/src/modules/command-menu/pages/page-layout/components/ChartTypeSelectionSection.tsx\nindex 8657148271fd9..538a5020a7d91 100644\n--- a/packages/twenty-front/src/modules/command-menu/pages/page-layout/components/ChartTypeSelectionSection.tsx\n+++ b/packages/twenty-front/src/modules/command-menu/pages/page-layout/components/ChartTypeSelectionSection.tsx\n@@ -9,9 +9,9 @@ import { MenuPicker } from 'twenty-ui/navigation';\n const graphTypeOptions = [\n   GraphType.VERTICAL_BAR,\n   GraphType.HORIZONTAL_BAR,\n-  GraphType.AGGREGATE,\n-  GraphType.PIE,\n   GraphType.LINE,\n+  GraphType.PIE,\n+  GraphType.AGGREGATE,\n   GraphType.GAUGE,\n ];\n \n@@ -36,32 +36,25 @@ export const ChartTypeSelectionSection = ({\n \n   return (\n     <StyledChartTypeSelectionContainer>\n-      {graphTypeOptions.map((graphType) => {\n-        const isChartV2Type = [\n-          GraphType.PIE,\n-          GraphType.LINE,\n-          GraphType.GAUGE,\n-        ].includes(graphType);\n-\n-        const isDisabled = isChartV2Type && !isDashboardV2Enabled;\n-\n-        return (\n-          <MenuPicker\n-            id={graphType}\n-            selected={currentGraphType === graphType}\n-            key={graphType}\n-            icon={GRAPH_TYPE_INFORMATION[graphType].icon}\n-            onClick={() => {\n-              setCurrentGraphType(graphType);\n-            }}\n-            showLabel\n-            disabled={isDisabled}\n-            tooltipContent={\n-              isDisabled ? t`Soon` : t(GRAPH_TYPE_INFORMATION[graphType].label)\n-            }\n-          />\n-        );\n-      })}\n+      {graphTypeOptions\n+        .filter(\n+          (graphType) => isDashboardV2Enabled || graphType !== GraphType.GAUGE,\n+        )\n+        .map((graphType) => {\n+          return (\n+            <MenuPicker\n+              id={graphType}\n+              selected={currentGraphType === graphType}\n+              key={graphType}\n+              icon={GRAPH_TYPE_INFORMATION[graphType].icon}\n+              onClick={() => {\n+                setCurrentGraphType(graphType);\n+              }}\n+              showLabel\n+              tooltipContent={t(GRAPH_TYPE_INFORMATION[graphType].label)}\n+            />\n+          );\n+        })}\n     </StyledChartTypeSelectionContainer>\n   );\n };\ndiff --git a/packages/twenty-server/src/engine/core-modules/page-layout/utils/__tests__/validate-and-transform-widget-configuration.util.spec.ts b/packages/twenty-server/src/engine/core-modules/page-layout/utils/__tests__/validate-and-transform-widget-configuration.util.spec.ts\nindex f532f54f66db5..5000aaf463489 100644\n--- a/packages/twenty-server/src/engine/core-modules/page-layout/utils/__tests__/validate-and-transform-widget-configuration.util.spec.ts\n+++ b/packages/twenty-server/src/engine/core-modules/page-layout/utils/__tests__/validate-and-transform-widget-configuration.util.spec.ts\n@@ -247,33 +247,35 @@ describe('validateAndTransformWidgetConfiguration', () => {\n   });\n \n   describe('Feature flags', () => {\n-    it('should throw error for unsupported graph type', () => {\n+    it('should throw error for GAUGE chart type when IS_DASHBOARD_V2_ENABLED is false', () => {\n       expect(() =>\n         validateAndTransformWidgetConfiguration({\n           type: WidgetType.GRAPH,\n-          configuration: TEST_PIE_CHART_CONFIG,\n+          configuration: TEST_GAUGE_CHART_CONFIG,\n           isDashboardV2Enabled: false,\n         }),\n       ).toThrow(/IS_DASHBOARD_V2_ENABLED feature flag/);\n+    });\n \n+    it('should not throw error for GAUGE chart type when IS_DASHBOARD_V2_ENABLED is true', () => {\n       expect(() =>\n         validateAndTransformWidgetConfiguration({\n           type: WidgetType.GRAPH,\n-          configuration: TEST_LINE_CHART_CONFIG,\n-          isDashboardV2Enabled: false,\n+          configuration: TEST_GAUGE_CHART_CONFIG,\n+          isDashboardV2Enabled: true,\n         }),\n-      ).toThrow(/IS_DASHBOARD_V2_ENABLED feature flag/);\n+      ).not.toThrow();\n+    });\n \n+    it('should not throw error for PIE chart type regardless of IS_DASHBOARD_V2_ENABLED', () => {\n       expect(() =>\n         validateAndTransformWidgetConfiguration({\n           type: WidgetType.GRAPH,\n-          configuration: TEST_GAUGE_CHART_CONFIG,\n+          configuration: TEST_PIE_CHART_CONFIG,\n           isDashboardV2Enabled: false,\n         }),\n-      ).toThrow(/IS_DASHBOARD_V2_ENABLED feature flag/);\n-    });\n+      ).not.toThrow();\n \n-    it('should not throw error when IS_DASHBOARD_V2_ENABLED feature flag is enabled', () => {\n       expect(() =>\n         validateAndTransformWidgetConfiguration({\n           type: WidgetType.GRAPH,\n@@ -283,21 +285,19 @@ describe('validateAndTransformWidgetConfiguration', () => {\n       ).not.toThrow();\n     });\n \n-    it('should not throw error when IS_DASHBOARD_V2_ENABLED feature flag is enabled', () => {\n+    it('should not throw error for LINE chart type regardless of IS_DASHBOARD_V2_ENABLED', () => {\n       expect(() =>\n         validateAndTransformWidgetConfiguration({\n           type: WidgetType.GRAPH,\n           configuration: TEST_LINE_CHART_CONFIG,\n-          isDashboardV2Enabled: true,\n+          isDashboardV2Enabled: false,\n         }),\n       ).not.toThrow();\n-    });\n \n-    it('should not throw error when IS_DASHBOARD_V2_ENABLED feature flag is enabled', () => {\n       expect(() =>\n         validateAndTransformWidgetConfiguration({\n           type: WidgetType.GRAPH,\n-          configuration: TEST_GAUGE_CHART_CONFIG,\n+          configuration: TEST_LINE_CHART_CONFIG,\n           isDashboardV2Enabled: true,\n         }),\n       ).not.toThrow();\ndiff --git a/packages/twenty-server/src/engine/core-modules/page-layout/utils/validate-and-transform-widget-configuration.util.ts b/packages/twenty-server/src/engine/core-modules/page-layout/utils/validate-and-transform-widget-configuration.util.ts\nindex c511f669d75eb..68f8b17a28389 100644\n--- a/packages/twenty-server/src/engine/core-modules/page-layout/utils/validate-and-transform-widget-configuration.util.ts\n+++ b/packages/twenty-server/src/engine/core-modules/page-layout/utils/validate-and-transform-widget-configuration.util.ts\n@@ -38,9 +38,7 @@ const validateGraphConfiguration = ({\n     return null;\n   }\n \n-  const v2ChartTypes = [GraphType.PIE, GraphType.LINE, GraphType.GAUGE];\n-\n-  if (v2ChartTypes.includes(graphType) && !isDashboardV2Enabled) {\n+  if (graphType === GraphType.GAUGE && !isDashboardV2Enabled) {\n     throw new Error(\n       `Chart type ${graphType} requires IS_DASHBOARD_V2_ENABLED feature flag`,\n     );\n"}
{"instance_id": "twentyhq__twenty.main.16143", "repo": "twentyhq/twenty", "base_commit": "65480eb49250765e3b788147fb08d4a950f15496", "head_commit": "7cc2cdc1fe95840d596927ed2a177108b87fb4f8", "title": "[DASHBOARDS] Add default order by and date granularity when choosing field", "merged_at": "2025-11-27T15:13:06Z", "html_url": "https://github.com/twentyhq/twenty/pull/16143", "test_files": ["packages/twenty-front/src/modules/command-menu/pages/page-layout/utils/__tests__/buildChartGroupByFieldConfigUpdate.test.ts"], "code_files": ["packages/twenty-front/src/modules/command-menu/pages/page-layout/components/dropdown-content/ChartGroupByFieldSelectionDropdownContentBase.tsx", "packages/twenty-front/src/modules/command-menu/pages/page-layout/utils/buildChartGroupByFieldConfigUpdate.ts"], "total_changes": 251, "num_files": 3, "pull_number": 16143, "patch": "diff --git a/packages/twenty-front/src/modules/command-menu/pages/page-layout/components/dropdown-content/ChartGroupByFieldSelectionDropdownContentBase.tsx b/packages/twenty-front/src/modules/command-menu/pages/page-layout/components/dropdown-content/ChartGroupByFieldSelectionDropdownContentBase.tsx\nindex 95ecff89643c4..f6aa974cc6547 100644\n--- a/packages/twenty-front/src/modules/command-menu/pages/page-layout/components/dropdown-content/ChartGroupByFieldSelectionDropdownContentBase.tsx\n+++ b/packages/twenty-front/src/modules/command-menu/pages/page-layout/components/dropdown-content/ChartGroupByFieldSelectionDropdownContentBase.tsx\n@@ -3,6 +3,7 @@ import { usePageLayoutIdFromContextStoreTargetedRecord } from '@/command-menu/pa\n import { useUpdateCurrentWidgetConfig } from '@/command-menu/pages/page-layout/hooks/useUpdateCurrentWidgetConfig';\n import { useWidgetInEditMode } from '@/command-menu/pages/page-layout/hooks/useWidgetInEditMode';\n import { type ChartConfiguration } from '@/command-menu/pages/page-layout/types/ChartConfiguration';\n+import { buildChartGroupByFieldConfigUpdate } from '@/command-menu/pages/page-layout/utils/buildChartGroupByFieldConfigUpdate';\n import { useObjectMetadataItems } from '@/object-metadata/hooks/useObjectMetadataItems';\n import { type FieldMetadataItem } from '@/object-metadata/types/FieldMetadataItem';\n import { isCompositeFieldType } from '@/object-record/object-filter-dropdown/utils/isCompositeFieldType';\n@@ -22,7 +23,6 @@ import { useMemo, useState } from 'react';\n import { isDefined } from 'twenty-shared/utils';\n import { useIcons } from 'twenty-ui/display';\n import { MenuItemSelect } from 'twenty-ui/navigation';\n-import { BarChartGroupMode } from '~/generated/graphql';\n import { filterBySearchQuery } from '~/utils/filterBySearchQuery';\n \n type ChartGroupByFieldSelectionDropdownContentBaseProps<\n@@ -93,48 +93,18 @@ export const ChartGroupByFieldSelectionDropdownContentBase = <\n     return null;\n   }\n \n-  const buildConfigUpdate = (\n-    fieldId: string | null,\n-    subFieldName: string | null,\n-  ) => {\n-    const isSecondaryAxis =\n-      fieldMetadataIdKey === 'secondaryAxisGroupByFieldMetadataId';\n-    const baseConfig = {\n-      [fieldMetadataIdKey]: fieldId,\n-      [subFieldNameKey]: subFieldName,\n-    };\n-\n-    if (!isSecondaryAxis) {\n-      return baseConfig;\n-    }\n-\n-    if (configuration.__typename === 'BarChartConfiguration') {\n-      return {\n-        ...baseConfig,\n-        groupMode: isDefined(fieldId)\n-          ? (configuration.groupMode ?? BarChartGroupMode.STACKED)\n-          : null,\n-      };\n-    }\n-\n-    if (configuration.__typename === 'LineChartConfiguration') {\n-      return {\n-        ...baseConfig,\n-        isStacked: isDefined(fieldId)\n-          ? (configuration.isStacked ?? true)\n-          : null,\n-      };\n-    }\n-\n-    return baseConfig;\n-  };\n-\n   const handleSelectField = (fieldMetadataItem: FieldMetadataItem) => {\n     if (isCompositeFieldType(fieldMetadataItem.type)) {\n       setSelectedCompositeField(fieldMetadataItem);\n     } else {\n       updateCurrentWidgetConfig({\n-        configToUpdate: buildConfigUpdate(fieldMetadataItem.id, null),\n+        configToUpdate: buildChartGroupByFieldConfigUpdate({\n+          configuration,\n+          fieldMetadataIdKey,\n+          subFieldNameKey,\n+          fieldId: fieldMetadataItem.id,\n+          subFieldName: null,\n+        }),\n       });\n       closeDropdown();\n     }\n@@ -142,7 +112,13 @@ export const ChartGroupByFieldSelectionDropdownContentBase = <\n \n   const handleSelectNone = () => {\n     updateCurrentWidgetConfig({\n-      configToUpdate: buildConfigUpdate(null, null),\n+      configToUpdate: buildChartGroupByFieldConfigUpdate({\n+        configuration,\n+        fieldMetadataIdKey,\n+        subFieldNameKey,\n+        fieldId: null,\n+        subFieldName: null,\n+      }),\n     });\n     closeDropdown();\n   };\n@@ -157,10 +133,13 @@ export const ChartGroupByFieldSelectionDropdownContentBase = <\n     }\n \n     updateCurrentWidgetConfig({\n-      configToUpdate: buildConfigUpdate(\n-        selectedCompositeField.id,\n+      configToUpdate: buildChartGroupByFieldConfigUpdate({\n+        configuration,\n+        fieldMetadataIdKey,\n+        subFieldNameKey,\n+        fieldId: selectedCompositeField.id,\n         subFieldName,\n-      ),\n+      }),\n     });\n     closeDropdown();\n   };\ndiff --git a/packages/twenty-front/src/modules/command-menu/pages/page-layout/utils/__tests__/buildChartGroupByFieldConfigUpdate.test.ts b/packages/twenty-front/src/modules/command-menu/pages/page-layout/utils/__tests__/buildChartGroupByFieldConfigUpdate.test.ts\nnew file mode 100644\nindex 0000000000000..4ee5811ae3743\n--- /dev/null\n+++ b/packages/twenty-front/src/modules/command-menu/pages/page-layout/utils/__tests__/buildChartGroupByFieldConfigUpdate.test.ts\n@@ -0,0 +1,77 @@\n+import { ObjectRecordGroupByDateGranularity } from 'twenty-shared/types';\n+import {\n+  type BarChartConfiguration,\n+  BarChartGroupMode,\n+  GraphOrderBy,\n+  type PieChartConfiguration,\n+} from '~/generated/graphql';\n+import { buildChartGroupByFieldConfigUpdate } from '../buildChartGroupByFieldConfigUpdate';\n+\n+describe('buildChartGroupByFieldConfigUpdate', () => {\n+  it('sets default orderBy and dateGranularity for primary axis', () => {\n+    const result = buildChartGroupByFieldConfigUpdate({\n+      configuration: {\n+        __typename: 'BarChartConfiguration',\n+      } as BarChartConfiguration,\n+      fieldMetadataIdKey: 'primaryAxisGroupByFieldMetadataId',\n+      subFieldNameKey: 'primaryAxisGroupBySubFieldName',\n+      fieldId: 'field',\n+      subFieldName: null,\n+    });\n+\n+    expect(result).toMatchObject({\n+      primaryAxisOrderBy: GraphOrderBy.FIELD_ASC,\n+      primaryAxisDateGranularity: ObjectRecordGroupByDateGranularity.DAY,\n+    });\n+  });\n+\n+  it('clears orderBy and dateGranularity when primary axis fieldId is null', () => {\n+    const result = buildChartGroupByFieldConfigUpdate({\n+      configuration: {\n+        __typename: 'BarChartConfiguration',\n+      } as BarChartConfiguration,\n+      fieldMetadataIdKey: 'primaryAxisGroupByFieldMetadataId',\n+      subFieldNameKey: 'primaryAxisGroupBySubFieldName',\n+      fieldId: null,\n+      subFieldName: null,\n+    });\n+\n+    expect(result).toMatchObject({\n+      primaryAxisOrderBy: null,\n+      primaryAxisDateGranularity: null,\n+    });\n+  });\n+\n+  it('sets groupMode for bar chart secondary axis', () => {\n+    const result = buildChartGroupByFieldConfigUpdate({\n+      configuration: {\n+        __typename: 'BarChartConfiguration',\n+      } as BarChartConfiguration,\n+      fieldMetadataIdKey: 'secondaryAxisGroupByFieldMetadataId',\n+      subFieldNameKey: 'secondaryAxisGroupBySubFieldName',\n+      fieldId: 'field',\n+      subFieldName: null,\n+    });\n+\n+    expect(result).toMatchObject({\n+      groupMode: BarChartGroupMode.STACKED,\n+    });\n+  });\n+\n+  it('sets orderBy and dateGranularity for pie chart groupBy', () => {\n+    const result = buildChartGroupByFieldConfigUpdate({\n+      configuration: {\n+        __typename: 'PieChartConfiguration',\n+      } as PieChartConfiguration,\n+      fieldMetadataIdKey: 'groupByFieldMetadataId',\n+      subFieldNameKey: 'groupBySubFieldName',\n+      fieldId: 'field',\n+      subFieldName: null,\n+    });\n+\n+    expect(result).toMatchObject({\n+      orderBy: GraphOrderBy.FIELD_ASC,\n+      dateGranularity: ObjectRecordGroupByDateGranularity.DAY,\n+    });\n+  });\n+});\ndiff --git a/packages/twenty-front/src/modules/command-menu/pages/page-layout/utils/buildChartGroupByFieldConfigUpdate.ts b/packages/twenty-front/src/modules/command-menu/pages/page-layout/utils/buildChartGroupByFieldConfigUpdate.ts\nnew file mode 100644\nindex 0000000000000..2898eb9060419\n--- /dev/null\n+++ b/packages/twenty-front/src/modules/command-menu/pages/page-layout/utils/buildChartGroupByFieldConfigUpdate.ts\n@@ -0,0 +1,111 @@\n+import { type ChartConfiguration } from '@/command-menu/pages/page-layout/types/ChartConfiguration';\n+import { ObjectRecordGroupByDateGranularity } from 'twenty-shared/types';\n+import { isDefined } from 'twenty-shared/utils';\n+import { BarChartGroupMode, GraphOrderBy } from '~/generated/graphql';\n+\n+type BuildChartGroupByFieldConfigUpdateArgs<T extends ChartConfiguration> = {\n+  configuration: T;\n+  fieldMetadataIdKey: keyof T;\n+  subFieldNameKey: keyof T;\n+  fieldId: string | null;\n+  subFieldName: string | null;\n+};\n+\n+export const buildChartGroupByFieldConfigUpdate = <\n+  T extends ChartConfiguration,\n+>({\n+  configuration,\n+  fieldMetadataIdKey,\n+  subFieldNameKey,\n+  fieldId,\n+  subFieldName,\n+}: BuildChartGroupByFieldConfigUpdateArgs<T>) => {\n+  const isPrimaryAxis =\n+    fieldMetadataIdKey === 'primaryAxisGroupByFieldMetadataId';\n+  const isSecondaryAxis =\n+    fieldMetadataIdKey === 'secondaryAxisGroupByFieldMetadataId';\n+  const isPieChartGroupBy = fieldMetadataIdKey === 'groupByFieldMetadataId';\n+\n+  const baseConfig = {\n+    [fieldMetadataIdKey]: fieldId,\n+    [subFieldNameKey]: subFieldName,\n+  };\n+\n+  const isBarChart = configuration.__typename === 'BarChartConfiguration';\n+  const isLineChart = configuration.__typename === 'LineChartConfiguration';\n+  const isPieChart = configuration.__typename === 'PieChartConfiguration';\n+\n+  if (isPrimaryAxis) {\n+    const existingOrderBy =\n+      isBarChart || isLineChart ? configuration.primaryAxisOrderBy : null;\n+\n+    const existingDateGranularity =\n+      isBarChart || isLineChart\n+        ? configuration.primaryAxisDateGranularity\n+        : null;\n+\n+    return {\n+      ...baseConfig,\n+      primaryAxisOrderBy: isDefined(fieldId)\n+        ? (existingOrderBy ?? GraphOrderBy.FIELD_ASC)\n+        : null,\n+      primaryAxisDateGranularity: isDefined(fieldId)\n+        ? (existingDateGranularity ?? ObjectRecordGroupByDateGranularity.DAY)\n+        : null,\n+    };\n+  }\n+\n+  if (isPieChartGroupBy) {\n+    const existingOrderBy = isPieChart ? configuration.orderBy : null;\n+\n+    const existingDateGranularity = isPieChart\n+      ? configuration.dateGranularity\n+      : null;\n+\n+    return {\n+      ...baseConfig,\n+      orderBy: isDefined(fieldId)\n+        ? (existingOrderBy ?? GraphOrderBy.FIELD_ASC)\n+        : null,\n+      dateGranularity: isDefined(fieldId)\n+        ? (existingDateGranularity ?? ObjectRecordGroupByDateGranularity.DAY)\n+        : null,\n+    };\n+  }\n+\n+  if (!isSecondaryAxis) {\n+    return baseConfig;\n+  }\n+\n+  if (isBarChart) {\n+    return {\n+      ...baseConfig,\n+      secondaryAxisOrderBy: isDefined(fieldId)\n+        ? (configuration.secondaryAxisOrderBy ?? GraphOrderBy.FIELD_ASC)\n+        : null,\n+      secondaryAxisGroupByDateGranularity: isDefined(fieldId)\n+        ? (configuration.secondaryAxisGroupByDateGranularity ??\n+          ObjectRecordGroupByDateGranularity.DAY)\n+        : null,\n+      groupMode: isDefined(fieldId)\n+        ? (configuration.groupMode ?? BarChartGroupMode.STACKED)\n+        : null,\n+    };\n+  }\n+\n+  if (isLineChart) {\n+    return {\n+      ...baseConfig,\n+      secondaryAxisOrderBy: isDefined(fieldId)\n+        ? (configuration.secondaryAxisOrderBy ?? GraphOrderBy.FIELD_ASC)\n+        : null,\n+      secondaryAxisGroupByDateGranularity: isDefined(fieldId)\n+        ? (configuration.secondaryAxisGroupByDateGranularity ??\n+          ObjectRecordGroupByDateGranularity.DAY)\n+        : null,\n+      isStacked: isDefined(fieldId) ? (configuration.isStacked ?? true) : null,\n+    };\n+  }\n+\n+  return baseConfig;\n+};\n"}
{"instance_id": "twentyhq__twenty.main.16132", "repo": "twentyhq/twenty", "base_commit": "57ae12ff7c5d1a3f2bbfaf46ca50e7bb11e8e0af", "head_commit": "51918abcb4401342c167fd06f25d33a02da0e147", "title": "optimize buildFieldMapsFromFlatObjectMetadata usages", "merged_at": "2025-11-27T14:01:52Z", "html_url": "https://github.com/twentyhq/twenty/pull/16132", "test_files": ["packages/twenty-server/src/engine/twenty-orm/entity-manager/workspace-entity-manager.spec.ts"], "code_files": ["packages/twenty-server/src/engine/api/common/common-result-getters/common-result-getters.service.ts", "packages/twenty-server/src/engine/api/graphql/graphql-query-runner/helpers/process-nested-relations-v2.helper.ts", "packages/twenty-server/src/engine/twenty-orm/utils/compute-relation-connect-query-configs.util.ts", "packages/twenty-server/src/engine/twenty-orm/utils/format-data.util.ts", "packages/twenty-server/src/engine/twenty-orm/utils/format-result.util.ts"], "total_changes": 133, "num_files": 6, "pull_number": 16132, "patch": "diff --git a/packages/twenty-server/src/engine/api/common/common-result-getters/common-result-getters.service.ts b/packages/twenty-server/src/engine/api/common/common-result-getters/common-result-getters.service.ts\nindex 1d5981020252f..437ede452fc31 100644\n--- a/packages/twenty-server/src/engine/api/common/common-result-getters/common-result-getters.service.ts\n+++ b/packages/twenty-server/src/engine/api/common/common-result-getters/common-result-getters.service.ts\n@@ -18,7 +18,10 @@ import { FileService } from 'src/engine/core-modules/file/services/file.service'\n import { type FlatEntityMaps } from 'src/engine/metadata-modules/flat-entity/types/flat-entity-maps.type';\n import { findFlatEntityByIdInFlatEntityMapsOrThrow } from 'src/engine/metadata-modules/flat-entity/utils/find-flat-entity-by-id-in-flat-entity-maps-or-throw.util';\n import { type FlatFieldMetadata } from 'src/engine/metadata-modules/flat-field-metadata/types/flat-field-metadata.type';\n-import { buildFieldMapsFromFlatObjectMetadata } from 'src/engine/metadata-modules/flat-field-metadata/utils/build-field-maps-from-flat-object-metadata.util';\n+import {\n+  buildFieldMapsFromFlatObjectMetadata,\n+  type FieldMapsForObject,\n+} from 'src/engine/metadata-modules/flat-field-metadata/utils/build-field-maps-from-flat-object-metadata.util';\n import { isFlatFieldMetadataOfType } from 'src/engine/metadata-modules/flat-field-metadata/utils/is-flat-field-metadata-of-type.util';\n import { type FlatObjectMetadata } from 'src/engine/metadata-modules/flat-object-metadata/types/flat-object-metadata.type';\n \n@@ -54,6 +57,11 @@ export class CommonResultGettersService {\n     flatFieldMetadataMaps: FlatEntityMaps<FlatFieldMetadata>,\n     workspaceId: string,\n   ) {\n+    const fieldMaps = buildFieldMapsFromFlatObjectMetadata(\n+      flatFieldMetadataMaps,\n+      flatObjectMetadata,\n+    );\n+\n     return await Promise.all(\n       recordArray.map(\n         async (record: ObjectRecord) =>\n@@ -63,6 +71,7 @@ export class CommonResultGettersService {\n             flatObjectMetadataMaps,\n             flatFieldMetadataMaps,\n             workspaceId,\n+            fieldMaps,\n           ),\n       ),\n     );\n@@ -74,13 +83,18 @@ export class CommonResultGettersService {\n     flatObjectMetadataMaps: FlatEntityMaps<FlatObjectMetadata>,\n     flatFieldMetadataMaps: FlatEntityMaps<FlatFieldMetadata>,\n     workspaceId: string,\n+    fieldMapsForObject?: FieldMapsForObject,\n   ): Promise<ObjectRecord> {\n     const handler = this.getHandler(flatObjectMetadata.nameSingular);\n \n-    const { fieldIdByName } = buildFieldMapsFromFlatObjectMetadata(\n-      flatFieldMetadataMaps,\n-      flatObjectMetadata,\n-    );\n+    const fieldMaps =\n+      fieldMapsForObject ??\n+      buildFieldMapsFromFlatObjectMetadata(\n+        flatFieldMetadataMaps,\n+        flatObjectMetadata,\n+      );\n+\n+    const { fieldIdByName } = fieldMaps;\n \n     const relationFields = Object.keys(record)\n       .map(\ndiff --git a/packages/twenty-server/src/engine/api/graphql/graphql-query-runner/helpers/process-nested-relations-v2.helper.ts b/packages/twenty-server/src/engine/api/graphql/graphql-query-runner/helpers/process-nested-relations-v2.helper.ts\nindex 7b22692a4c90f..f4f6017ee0172 100644\n--- a/packages/twenty-server/src/engine/api/graphql/graphql-query-runner/helpers/process-nested-relations-v2.helper.ts\n+++ b/packages/twenty-server/src/engine/api/graphql/graphql-query-runner/helpers/process-nested-relations-v2.helper.ts\n@@ -17,7 +17,10 @@ import { type AuthContext } from 'src/engine/core-modules/auth/types/auth-contex\n import { FlatEntityMaps } from 'src/engine/metadata-modules/flat-entity/types/flat-entity-maps.type';\n import { findFlatEntityByIdInFlatEntityMaps } from 'src/engine/metadata-modules/flat-entity/utils/find-flat-entity-by-id-in-flat-entity-maps.util';\n import { FlatFieldMetadata } from 'src/engine/metadata-modules/flat-field-metadata/types/flat-field-metadata.type';\n-import { buildFieldMapsFromFlatObjectMetadata } from 'src/engine/metadata-modules/flat-field-metadata/utils/build-field-maps-from-flat-object-metadata.util';\n+import {\n+  buildFieldMapsFromFlatObjectMetadata,\n+  type FieldMapsForObject,\n+} from 'src/engine/metadata-modules/flat-field-metadata/utils/build-field-maps-from-flat-object-metadata.util';\n import { FlatObjectMetadata } from 'src/engine/metadata-modules/flat-object-metadata/types/flat-object-metadata.type';\n import { type WorkspaceDataSource } from 'src/engine/twenty-orm/datasource/workspace.datasource';\n import { type WorkspaceSelectQueryBuilder } from 'src/engine/twenty-orm/repository/workspace-select-query-builder';\n@@ -112,13 +115,13 @@ export class ProcessNestedRelationsV2Helper {\n     rolePermissionConfig?: RolePermissionConfig;\n     selectedFields: Record<string, unknown>;\n   }): Promise<void> {\n-    const { fieldIdByName } = buildFieldMapsFromFlatObjectMetadata(\n+    const fieldMaps = buildFieldMapsFromFlatObjectMetadata(\n       flatFieldMetadataMaps,\n       parentObjectMetadataItem,\n     );\n \n     const sourceFieldMetadata = findFlatEntityByIdInFlatEntityMaps({\n-      flatEntityId: fieldIdByName[sourceFieldName],\n+      flatEntityId: fieldMaps.fieldIdByName[sourceFieldName],\n       flatEntityMaps: flatFieldMetadataMaps,\n     });\n \n@@ -154,6 +157,7 @@ export class ProcessNestedRelationsV2Helper {\n         flatFieldMetadataMaps,\n         parentObjectMetadataItem,\n         sourceFieldName,\n+        fieldMaps,\n       });\n \n     const targetObjectRepository = workspaceDataSource.getRepository(\n@@ -250,19 +254,16 @@ export class ProcessNestedRelationsV2Helper {\n     flatFieldMetadataMaps,\n     parentObjectMetadataItem,\n     sourceFieldName,\n+    fieldMaps,\n   }: {\n     flatObjectMetadataMaps: FlatEntityMaps<FlatObjectMetadata>;\n     flatFieldMetadataMaps: FlatEntityMaps<FlatFieldMetadata>;\n     parentObjectMetadataItem: FlatObjectMetadata;\n     sourceFieldName: string;\n+    fieldMaps: FieldMapsForObject;\n   }) {\n-    const { fieldIdByName } = buildFieldMapsFromFlatObjectMetadata(\n-      flatFieldMetadataMaps,\n-      parentObjectMetadataItem,\n-    );\n-\n     const targetFieldMetadata = findFlatEntityByIdInFlatEntityMaps({\n-      flatEntityId: fieldIdByName[sourceFieldName],\n+      flatEntityId: fieldMaps.fieldIdByName[sourceFieldName],\n       flatEntityMaps: flatFieldMetadataMaps,\n     });\n \ndiff --git a/packages/twenty-server/src/engine/twenty-orm/entity-manager/workspace-entity-manager.spec.ts b/packages/twenty-server/src/engine/twenty-orm/entity-manager/workspace-entity-manager.spec.ts\nindex c9a6f077e92dc..671b9c73728e8 100644\n--- a/packages/twenty-server/src/engine/twenty-orm/entity-manager/workspace-entity-manager.spec.ts\n+++ b/packages/twenty-server/src/engine/twenty-orm/entity-manager/workspace-entity-manager.spec.ts\n@@ -13,6 +13,7 @@ import { type FlatFieldMetadata } from 'src/engine/metadata-modules/flat-field-m\n import { type FlatObjectMetadata } from 'src/engine/metadata-modules/flat-object-metadata/types/flat-object-metadata.type';\n import { type WorkspaceDataSource } from 'src/engine/twenty-orm/datasource/workspace.datasource';\n import { validateOperationIsPermittedOrThrow } from 'src/engine/twenty-orm/repository/permissions.utils';\n+import { getObjectMetadataFromEntityTarget } from 'src/engine/twenty-orm/utils/get-object-metadata-from-entity-target.util';\n \n import { WorkspaceEntityManager } from './workspace-entity-manager';\n \n@@ -23,7 +24,7 @@ jest.mock('src/engine/twenty-orm/repository/permissions.utils', () => ({\n jest.mock(\n   'src/engine/twenty-orm/utils/get-object-metadata-from-entity-target.util',\n   () => ({\n-    getObjectMetadataFromEntityTarget: jest.fn().mockReturnValue({}),\n+    getObjectMetadataFromEntityTarget: jest.fn(),\n   }),\n );\n \n@@ -117,6 +118,10 @@ describe('WorkspaceEntityManager', () => {\n       updatedAt: new Date(),\n     };\n \n+    (getObjectMetadataFromEntityTarget as jest.Mock).mockReturnValue(\n+      mockFlatObjectMetadata,\n+    );\n+\n     const mockFlatFieldMetadata: FlatFieldMetadata = {\n       id: 'field-id',\n       type: 'TEXT' as FieldMetadataType,\ndiff --git a/packages/twenty-server/src/engine/twenty-orm/utils/compute-relation-connect-query-configs.util.ts b/packages/twenty-server/src/engine/twenty-orm/utils/compute-relation-connect-query-configs.util.ts\nindex 908e27975e1e2..b0fa4b7eec3a7 100644\n--- a/packages/twenty-server/src/engine/twenty-orm/utils/compute-relation-connect-query-configs.util.ts\n+++ b/packages/twenty-server/src/engine/twenty-orm/utils/compute-relation-connect-query-configs.util.ts\n@@ -9,7 +9,10 @@ import { getFlatFieldsFromFlatObjectMetadata } from 'src/engine/api/graphql/work\n import { isCompositeFieldMetadataType } from 'src/engine/metadata-modules/field-metadata/utils/is-composite-field-metadata-type.util';\n import { type FlatEntityMaps } from 'src/engine/metadata-modules/flat-entity/types/flat-entity-maps.type';\n import { type FlatFieldMetadata } from 'src/engine/metadata-modules/flat-field-metadata/types/flat-field-metadata.type';\n-import { buildFieldMapsFromFlatObjectMetadata } from 'src/engine/metadata-modules/flat-field-metadata/utils/build-field-maps-from-flat-object-metadata.util';\n+import {\n+  buildFieldMapsFromFlatObjectMetadata,\n+  type FieldMapsForObject,\n+} from 'src/engine/metadata-modules/flat-field-metadata/utils/build-field-maps-from-flat-object-metadata.util';\n import { type FlatIndexMetadata } from 'src/engine/metadata-modules/flat-index-metadata/types/flat-index-metadata.type';\n import { type FlatObjectMetadata } from 'src/engine/metadata-modules/flat-object-metadata/types/flat-object-metadata.type';\n import { type ConnectObject } from 'src/engine/twenty-orm/entity-manager/types/query-deep-partial-entity-with-nested-relation-fields.type';\n@@ -36,6 +39,11 @@ export const computeRelationConnectQueryConfigs = (\n ) => {\n   const allConnectQueryConfigs: Record<string, RelationConnectQueryConfig> = {};\n \n+  const fieldMaps = buildFieldMapsFromFlatObjectMetadata(\n+    flatFieldMetadataMaps,\n+    flatObjectMetadata,\n+  );\n+\n   for (const [entityIndex, entity] of entities.entries()) {\n     const nestedRelationConnectFields =\n       relationConnectQueryFieldsByEntityIndex[entityIndex];\n@@ -57,6 +65,7 @@ export const computeRelationConnectQueryConfigs = (\n         flatFieldMetadataMaps,\n         flatIndexMaps,\n         entity,\n+        fieldMaps,\n       );\n \n       const connectQueryConfig = allConnectQueryConfigs[connectFieldName];\n@@ -132,17 +141,14 @@ const computeRecordToConnectCondition = (\n   flatFieldMetadataMaps: FlatEntityMaps<FlatFieldMetadata>,\n   flatIndexMaps: FlatEntityMaps<FlatIndexMetadata>,\n   entity: Record<string, unknown>,\n+  fieldMaps: FieldMapsForObject,\n ): {\n   recordToConnectCondition: UniqueConstraintCondition;\n   uniqueConstraintFields: FlatFieldMetadata<FieldMetadataType>[];\n   targetObjectNameSingular: string;\n } => {\n-  const { fieldIdByName } = buildFieldMapsFromFlatObjectMetadata(\n-    flatFieldMetadataMaps,\n-    flatObjectMetadata,\n-  );\n-\n-  const field = flatFieldMetadataMaps.byId[fieldIdByName[connectFieldName]];\n+  const field =\n+    flatFieldMetadataMaps.byId[fieldMaps.fieldIdByName[connectFieldName]];\n \n   if (\n     !isDefined(field) ||\ndiff --git a/packages/twenty-server/src/engine/twenty-orm/utils/format-data.util.ts b/packages/twenty-server/src/engine/twenty-orm/utils/format-data.util.ts\nindex fe15bc2454682..156788a126990 100644\n--- a/packages/twenty-server/src/engine/twenty-orm/utils/format-data.util.ts\n+++ b/packages/twenty-server/src/engine/twenty-orm/utils/format-data.util.ts\n@@ -7,7 +7,10 @@ import { capitalize } from 'twenty-shared/utils';\n import { isCompositeFieldMetadataType } from 'src/engine/metadata-modules/field-metadata/utils/is-composite-field-metadata-type.util';\n import { type FlatEntityMaps } from 'src/engine/metadata-modules/flat-entity/types/flat-entity-maps.type';\n import { type FlatFieldMetadata } from 'src/engine/metadata-modules/flat-field-metadata/types/flat-field-metadata.type';\n-import { buildFieldMapsFromFlatObjectMetadata } from 'src/engine/metadata-modules/flat-field-metadata/utils/build-field-maps-from-flat-object-metadata.util';\n+import {\n+  buildFieldMapsFromFlatObjectMetadata,\n+  type FieldMapsForObject,\n+} from 'src/engine/metadata-modules/flat-field-metadata/utils/build-field-maps-from-flat-object-metadata.util';\n import { type FlatObjectMetadata } from 'src/engine/metadata-modules/flat-object-metadata/types/flat-object-metadata.type';\n import { type CompositeFieldMetadataType } from 'src/engine/metadata-modules/workspace-migration/factories/composite-column-action.factory';\n \n@@ -15,22 +18,26 @@ export function formatData<T>(\n   data: T,\n   flatObjectMetadata: FlatObjectMetadata,\n   flatFieldMetadataMaps: FlatEntityMaps<FlatFieldMetadata>,\n+  fieldMapsForObject?: FieldMapsForObject,\n ): T {\n   if (!data) {\n     return data;\n   }\n \n+  const fieldMaps =\n+    fieldMapsForObject ??\n+    buildFieldMapsFromFlatObjectMetadata(\n+      flatFieldMetadataMaps,\n+      flatObjectMetadata,\n+    );\n+\n   if (Array.isArray(data)) {\n     return data.map((item) =>\n-      formatData(item, flatObjectMetadata, flatFieldMetadataMaps),\n+      formatData(item, flatObjectMetadata, flatFieldMetadataMaps, fieldMaps),\n     ) as T;\n   }\n \n-  const { fieldIdByName, fieldIdByJoinColumnName } =\n-    buildFieldMapsFromFlatObjectMetadata(\n-      flatFieldMetadataMaps,\n-      flatObjectMetadata,\n-    );\n+  const { fieldIdByName, fieldIdByJoinColumnName } = fieldMaps;\n \n   // eslint-disable-next-line @typescript-eslint/no-explicit-any\n   const newData: Record<string, any> = {};\ndiff --git a/packages/twenty-server/src/engine/twenty-orm/utils/format-result.util.ts b/packages/twenty-server/src/engine/twenty-orm/utils/format-result.util.ts\nindex c04f9a15316dd..210050b24c87d 100644\n--- a/packages/twenty-server/src/engine/twenty-orm/utils/format-result.util.ts\n+++ b/packages/twenty-server/src/engine/twenty-orm/utils/format-result.util.ts\n@@ -16,7 +16,10 @@ import { getFlatFieldsFromFlatObjectMetadata } from 'src/engine/api/graphql/work\n import { computeCompositeColumnName } from 'src/engine/metadata-modules/field-metadata/utils/compute-column-name.util';\n import { type FlatEntityMaps } from 'src/engine/metadata-modules/flat-entity/types/flat-entity-maps.type';\n import { type FlatFieldMetadata } from 'src/engine/metadata-modules/flat-field-metadata/types/flat-field-metadata.type';\n-import { buildFieldMapsFromFlatObjectMetadata } from 'src/engine/metadata-modules/flat-field-metadata/utils/build-field-maps-from-flat-object-metadata.util';\n+import {\n+  buildFieldMapsFromFlatObjectMetadata,\n+  type FieldMapsForObject,\n+} from 'src/engine/metadata-modules/flat-field-metadata/utils/build-field-maps-from-flat-object-metadata.util';\n import { type FlatObjectMetadata } from 'src/engine/metadata-modules/flat-object-metadata/types/flat-object-metadata.type';\n import { getCompositeFieldMetadataCollection } from 'src/engine/twenty-orm/utils/get-composite-field-metadata-collection';\n import { isFieldMetadataEntityOfType } from 'src/engine/utils/is-field-metadata-of-type.util';\n@@ -27,23 +30,25 @@ export function formatResult<T>(\n   flatObjectMetadata: FlatObjectMetadata | undefined,\n   flatObjectMetadataMaps: FlatEntityMaps<FlatObjectMetadata>,\n   flatFieldMetadataMaps: FlatEntityMaps<FlatFieldMetadata>,\n+  fieldMapsForObject?: FieldMapsForObject,\n ): T {\n   if (!isDefined(data)) {\n     return data;\n   }\n \n-  if (Array.isArray(data)) {\n-    return data.map((item) =>\n-      formatResult(\n-        item,\n-        flatObjectMetadata,\n-        flatObjectMetadataMaps,\n-        flatFieldMetadataMaps,\n-      ),\n-    ) as T;\n-  }\n-\n   if (!isPlainObject(data)) {\n+    if (Array.isArray(data)) {\n+      return data.map((item) =>\n+        formatResult(\n+          item,\n+          flatObjectMetadata,\n+          flatObjectMetadataMaps,\n+          flatFieldMetadataMaps,\n+          fieldMapsForObject,\n+        ),\n+      ) as T;\n+    }\n+\n     return data;\n   }\n \n@@ -51,10 +56,14 @@ export function formatResult<T>(\n     throw new Error('Object metadata is missing');\n   }\n \n-  const { fieldIdByName } = buildFieldMapsFromFlatObjectMetadata(\n-    flatFieldMetadataMaps,\n-    flatObjectMetadata,\n-  );\n+  const fieldMaps =\n+    fieldMapsForObject ??\n+    buildFieldMapsFromFlatObjectMetadata(\n+      flatFieldMetadataMaps,\n+      flatObjectMetadata,\n+    );\n+\n+  const { fieldIdByName } = fieldMaps;\n \n   const compositeFieldMetadataMap = getCompositeFieldMetadataMap(\n     flatObjectMetadata,\n@@ -86,6 +95,7 @@ export function formatResult<T>(\n           flatObjectMetadata,\n           flatObjectMetadataMaps,\n           flatFieldMetadataMaps,\n+          fieldMaps,\n         );\n       } else if (fieldMetadata) {\n         // @ts-expect-error legacy noImplicitAny\n"}
{"instance_id": "twentyhq__twenty.main.16123", "repo": "twentyhq/twenty", "base_commit": "20e6f130d15c17a511d208a529e73d98448140dc", "head_commit": "b9043746c6c56aa5a774cd7410ce4be119df4f29", "title": "Null equivalence - update filter", "merged_at": "2025-11-27T13:31:40Z", "html_url": "https://github.com/twentyhq/twenty/pull/16123", "test_files": ["packages/twenty-server/src/engine/api/common/common-args-processors/data-arg-processor/utils/__tests__/find-postgres-default-null-equivalent-value.util.spec.ts", "packages/twenty-server/src/modules/workflow/workflow-executor/workflow-actions/filter/utils/__tests__/evaluate-filter-conditions.util.spec.ts", "packages/twenty-server/src/modules/workflow/workflow-executor/workflow-actions/filter/utils/__tests__/find-default-null-equivalent-value.util.spec.ts"], "code_files": ["packages/twenty-server/src/engine/api/common/common-args-processors/data-arg-processor/constants/null-equivalent-values.constant.ts", "packages/twenty-server/src/engine/api/common/common-args-processors/data-arg-processor/utils/find-postgres-default-null-equivalent-value.util.ts", "packages/twenty-server/src/modules/workflow/workflow-executor/workflow-actions/filter/utils/evaluate-filter-conditions.util.ts", "packages/twenty-server/src/modules/workflow/workflow-executor/workflow-actions/filter/utils/find-default-null-equivalent-value.util.ts"], "total_changes": 531, "num_files": 7, "pull_number": 16123, "patch": "diff --git a/packages/twenty-server/src/engine/api/common/common-args-processors/data-arg-processor/constants/null-equivalent-values.constant.ts b/packages/twenty-server/src/engine/api/common/common-args-processors/data-arg-processor/constants/null-equivalent-values.constant.ts\nindex 7955744559b85..d28f17058da10 100644\n--- a/packages/twenty-server/src/engine/api/common/common-args-processors/data-arg-processor/constants/null-equivalent-values.constant.ts\n+++ b/packages/twenty-server/src/engine/api/common/common-args-processors/data-arg-processor/constants/null-equivalent-values.constant.ts\n@@ -4,10 +4,6 @@ export const POSTGRES_DEFAULT_TEXT_FIELD_NULL_EQUIVALENT_VALUE = '';\n \n export const DEFAULT_TEXT_FIELD_NULL_EQUIVALENT_VALUE = '';\n \n-export const DEFAULT_RAW_JSON_FIELD_NULL_EQUIVALENT_VALUE = {};\n-\n-export const POSTGRES_DEFAULT_RAW_JSON_FIELD_NULL_EQUIVALENT_VALUE = '{}';\n-\n export const DEFAULT_ARRAY_FIELD_NULL_EQUIVALENT_VALUE = [];\n \n export const POSTGRES_DEFAULT_ARRAY_FIELD_NULL_EQUIVALENT_VALUE = '{}';\n@@ -46,7 +42,6 @@ const DEFAULT_FULL_NAME_FIELD_NULL_EQUIVALENT_VALUE = {\n \n const DEFAULT_ACTOR_FIELD_NULL_EQUIVALENT_VALUE = {\n   name: DEFAULT_TEXT_FIELD_NULL_EQUIVALENT_VALUE,\n-  context: DEFAULT_RAW_JSON_FIELD_NULL_EQUIVALENT_VALUE,\n };\n \n const DEFAULT_RICH_TEXT_V2_FIELD_NULL_EQUIVALENT_VALUE = {\ndiff --git a/packages/twenty-server/src/engine/api/common/common-args-processors/data-arg-processor/utils/__tests__/find-postgres-default-null-equivalent-value.util.spec.ts b/packages/twenty-server/src/engine/api/common/common-args-processors/data-arg-processor/utils/__tests__/find-postgres-default-null-equivalent-value.util.spec.ts\nindex 03e4fbd5ea047..8ab8c5e196558 100644\n--- a/packages/twenty-server/src/engine/api/common/common-args-processors/data-arg-processor/utils/__tests__/find-postgres-default-null-equivalent-value.util.spec.ts\n+++ b/packages/twenty-server/src/engine/api/common/common-args-processors/data-arg-processor/utils/__tests__/find-postgres-default-null-equivalent-value.util.spec.ts\n@@ -2,7 +2,6 @@ import { FieldMetadataType } from 'twenty-shared/types';\n \n import {\n   POSTGRES_DEFAULT_ARRAY_FIELD_NULL_EQUIVALENT_VALUE,\n-  POSTGRES_DEFAULT_RAW_JSON_FIELD_NULL_EQUIVALENT_VALUE,\n   POSTGRES_DEFAULT_TEXT_FIELD_NULL_EQUIVALENT_VALUE,\n } from 'src/engine/api/common/common-args-processors/data-arg-processor/constants/null-equivalent-values.constant';\n import { findPostgresDefaultNullEquivalentValue } from 'src/engine/api/common/common-args-processors/data-arg-processor/utils/find-postgres-default-null-equivalent-value.util';\n@@ -41,35 +40,6 @@ describe('findPostgresDefaultNullEquivalentValue', () => {\n       });\n     });\n \n-    describe('RAW_JSON', () => {\n-      it('should return POSTGRES_DEFAULT_RAW_JSON_FIELD_NULL_EQUIVALENT_VALUE for null', () => {\n-        expect(\n-          findPostgresDefaultNullEquivalentValue(\n-            null,\n-            FieldMetadataType.RAW_JSON,\n-          ),\n-        ).toBe(POSTGRES_DEFAULT_RAW_JSON_FIELD_NULL_EQUIVALENT_VALUE);\n-      });\n-\n-      it('should return POSTGRES_DEFAULT_RAW_JSON_FIELD_NULL_EQUIVALENT_VALUE for empty object', () => {\n-        expect(\n-          findPostgresDefaultNullEquivalentValue(\n-            {},\n-            FieldMetadataType.RAW_JSON,\n-          ),\n-        ).toBe(POSTGRES_DEFAULT_RAW_JSON_FIELD_NULL_EQUIVALENT_VALUE);\n-      });\n-\n-      it(\"should return POSTGRES_DEFAULT_RAW_JSON_FIELD_NULL_EQUIVALENT_VALUE for 'NULL'\", () => {\n-        expect(\n-          findPostgresDefaultNullEquivalentValue(\n-            'NULL',\n-            FieldMetadataType.RAW_JSON,\n-          ),\n-        ).toBe(POSTGRES_DEFAULT_RAW_JSON_FIELD_NULL_EQUIVALENT_VALUE);\n-      });\n-    });\n-\n     describe('ARRAY', () => {\n       it('should return POSTGRES_DEFAULT_ARRAY_FIELD_NULL_EQUIVALENT_VALUE for null', () => {\n         expect(\n@@ -112,7 +82,7 @@ describe('findPostgresDefaultNullEquivalentValue', () => {\n           FieldMetadataType.ACTOR,\n           'context',\n         ),\n-      ).toBe(POSTGRES_DEFAULT_RAW_JSON_FIELD_NULL_EQUIVALENT_VALUE);\n+      ).toBe(undefined);\n     });\n   });\n \n@@ -209,7 +179,7 @@ describe('findPostgresDefaultNullEquivalentValue', () => {\n           FieldMetadataType.RICH_TEXT_V2,\n           'blocknote',\n         ),\n-      ).toBe(POSTGRES_DEFAULT_RAW_JSON_FIELD_NULL_EQUIVALENT_VALUE);\n+      ).toBe(undefined);\n     });\n \n     it('should return text default for markdown', () => {\ndiff --git a/packages/twenty-server/src/engine/api/common/common-args-processors/data-arg-processor/utils/find-postgres-default-null-equivalent-value.util.ts b/packages/twenty-server/src/engine/api/common/common-args-processors/data-arg-processor/utils/find-postgres-default-null-equivalent-value.util.ts\nindex e18a5de4c55d1..19deed20536cb 100644\n--- a/packages/twenty-server/src/engine/api/common/common-args-processors/data-arg-processor/utils/find-postgres-default-null-equivalent-value.util.ts\n+++ b/packages/twenty-server/src/engine/api/common/common-args-processors/data-arg-processor/utils/find-postgres-default-null-equivalent-value.util.ts\n@@ -2,11 +2,9 @@ import { FieldMetadataType } from 'twenty-shared/types';\n \n import {\n   POSTGRES_DEFAULT_ARRAY_FIELD_NULL_EQUIVALENT_VALUE,\n-  POSTGRES_DEFAULT_RAW_JSON_FIELD_NULL_EQUIVALENT_VALUE,\n   POSTGRES_DEFAULT_TEXT_FIELD_NULL_EQUIVALENT_VALUE,\n } from 'src/engine/api/common/common-args-processors/data-arg-processor/constants/null-equivalent-values.constant';\n import { isNullEquivalentArrayFieldValue } from 'src/engine/api/common/common-args-processors/data-arg-processor/utils/is-null-equivalent-array-field-value.util';\n-import { isNullEquivalentRawJsonFieldValue } from 'src/engine/api/common/common-args-processors/data-arg-processor/utils/is-null-equivalent-raw-json-field-value.util';\n import { isNullEquivalentTextFieldValue } from 'src/engine/api/common/common-args-processors/data-arg-processor/utils/is-null-equivalent-text-field-value.util';\n \n export const findPostgresDefaultNullEquivalentValue = (\n@@ -19,10 +17,7 @@ export const findPostgresDefaultNullEquivalentValue = (\n       return isNullEquivalentTextFieldValue(value) || value === 'NULL'\n         ? POSTGRES_DEFAULT_TEXT_FIELD_NULL_EQUIVALENT_VALUE\n         : undefined;\n-    case FieldMetadataType.RAW_JSON:\n-      return isNullEquivalentRawJsonFieldValue(value) || value === 'NULL'\n-        ? POSTGRES_DEFAULT_RAW_JSON_FIELD_NULL_EQUIVALENT_VALUE\n-        : undefined;\n+    case FieldMetadataType.MULTI_SELECT:\n     case FieldMetadataType.ARRAY:\n       return isNullEquivalentArrayFieldValue(value) || value === 'NULL'\n         ? POSTGRES_DEFAULT_ARRAY_FIELD_NULL_EQUIVALENT_VALUE\n@@ -33,10 +28,6 @@ export const findPostgresDefaultNullEquivalentValue = (\n           return isNullEquivalentTextFieldValue(value) || value === 'NULL'\n             ? POSTGRES_DEFAULT_TEXT_FIELD_NULL_EQUIVALENT_VALUE\n             : undefined;\n-        case 'context':\n-          return isNullEquivalentRawJsonFieldValue(value) || value === 'NULL'\n-            ? POSTGRES_DEFAULT_RAW_JSON_FIELD_NULL_EQUIVALENT_VALUE\n-            : undefined;\n         default:\n           return undefined;\n       }\n@@ -128,10 +119,6 @@ export const findPostgresDefaultNullEquivalentValue = (\n     }\n     case FieldMetadataType.RICH_TEXT_V2: {\n       switch (key) {\n-        case 'blocknote':\n-          return isNullEquivalentRawJsonFieldValue(value) || value === 'NULL'\n-            ? POSTGRES_DEFAULT_RAW_JSON_FIELD_NULL_EQUIVALENT_VALUE\n-            : undefined;\n         case 'markdown':\n           return isNullEquivalentTextFieldValue(value) || value === 'NULL'\n             ? POSTGRES_DEFAULT_TEXT_FIELD_NULL_EQUIVALENT_VALUE\ndiff --git a/packages/twenty-server/src/modules/workflow/workflow-executor/workflow-actions/filter/utils/__tests__/evaluate-filter-conditions.util.spec.ts b/packages/twenty-server/src/modules/workflow/workflow-executor/workflow-actions/filter/utils/__tests__/evaluate-filter-conditions.util.spec.ts\nindex 7bb8633c0c00c..01b408956e545 100644\n--- a/packages/twenty-server/src/modules/workflow/workflow-executor/workflow-actions/filter/utils/__tests__/evaluate-filter-conditions.util.spec.ts\n+++ b/packages/twenty-server/src/modules/workflow/workflow-executor/workflow-actions/filter/utils/__tests__/evaluate-filter-conditions.util.spec.ts\n@@ -501,8 +501,24 @@ describe('evaluateFilterConditions', () => {\n           'TEXT',\n         );\n \n+        const filter3 = createFilter(\n+          ViewFilterOperand.CONTAINS,\n+          null,\n+          '',\n+          'TEXT',\n+        );\n+\n+        const filter4 = createFilter(\n+          ViewFilterOperand.CONTAINS,\n+          '',\n+          null,\n+          'TEXT',\n+        );\n+\n         expect(evaluateFilterConditions({ filters: [filter1] })).toBe(true);\n         expect(evaluateFilterConditions({ filters: [filter2] })).toBe(false);\n+        expect(evaluateFilterConditions({ filters: [filter3] })).toBe(true);\n+        expect(evaluateFilterConditions({ filters: [filter4] })).toBe(true);\n       });\n \n       it('should handle DoesNotContain operand with strings', () => {\n@@ -519,8 +535,16 @@ describe('evaluateFilterConditions', () => {\n           'TEXT',\n         );\n \n+        const filter3 = createFilter(\n+          ViewFilterOperand.DOES_NOT_CONTAIN,\n+          null,\n+          '',\n+          'TEXT',\n+        );\n+\n         expect(evaluateFilterConditions({ filters: [filter1] })).toBe(false);\n         expect(evaluateFilterConditions({ filters: [filter2] })).toBe(true);\n+        expect(evaluateFilterConditions({ filters: [filter3] })).toBe(false);\n       });\n \n       it('should handle Contains operand with arrays', () => {\n@@ -537,8 +561,32 @@ describe('evaluateFilterConditions', () => {\n           'ARRAY',\n         );\n \n+        const filter3 = createFilter(\n+          ViewFilterOperand.CONTAINS,\n+          null,\n+          [],\n+          'ARRAY',\n+        );\n+\n+        const filter4 = createFilter(\n+          ViewFilterOperand.CONTAINS,\n+          [],\n+          null,\n+          'ARRAY',\n+        );\n+\n+        const filter5 = createFilter(\n+          ViewFilterOperand.CONTAINS,\n+          null,\n+          ['apple'],\n+          'ARRAY',\n+        );\n+\n         expect(evaluateFilterConditions({ filters: [filter1] })).toBe(true);\n         expect(evaluateFilterConditions({ filters: [filter2] })).toBe(false);\n+        expect(evaluateFilterConditions({ filters: [filter3] })).toBe(true);\n+        expect(evaluateFilterConditions({ filters: [filter4] })).toBe(true);\n+        expect(evaluateFilterConditions({ filters: [filter5] })).toBe(false);\n       });\n \n       it('should handle DoesNotContain operand with arrays', () => {\n@@ -555,8 +603,16 @@ describe('evaluateFilterConditions', () => {\n           'ARRAY',\n         );\n \n+        const filter3 = createFilter(\n+          ViewFilterOperand.DOES_NOT_CONTAIN,\n+          null,\n+          ['apple'],\n+          'ARRAY',\n+        );\n+\n         expect(evaluateFilterConditions({ filters: [filter1] })).toBe(false);\n         expect(evaluateFilterConditions({ filters: [filter2] })).toBe(true);\n+        expect(evaluateFilterConditions({ filters: [filter3] })).toBe(true);\n       });\n     });\n \ndiff --git a/packages/twenty-server/src/modules/workflow/workflow-executor/workflow-actions/filter/utils/__tests__/find-default-null-equivalent-value.util.spec.ts b/packages/twenty-server/src/modules/workflow/workflow-executor/workflow-actions/filter/utils/__tests__/find-default-null-equivalent-value.util.spec.ts\nnew file mode 100644\nindex 0000000000000..d1307a7a37da2\n--- /dev/null\n+++ b/packages/twenty-server/src/modules/workflow/workflow-executor/workflow-actions/filter/utils/__tests__/find-default-null-equivalent-value.util.spec.ts\n@@ -0,0 +1,233 @@\n+import { FieldMetadataType } from 'twenty-shared/types';\n+\n+import {\n+  DEFAULT_ARRAY_FIELD_NULL_EQUIVALENT_VALUE,\n+  DEFAULT_TEXT_FIELD_NULL_EQUIVALENT_VALUE,\n+} from 'src/engine/api/common/common-args-processors/data-arg-processor/constants/null-equivalent-values.constant';\n+import { findDefaultNullEquivalentValue } from 'src/modules/workflow/workflow-executor/workflow-actions/filter/utils/find-default-null-equivalent-value.util';\n+\n+describe('findDefaultNullEquivalentValue', () => {\n+  describe('Simple Types', () => {\n+    describe('TEXT', () => {\n+      it('should return DEFAULT_TEXT_FIELD_NULL_EQUIVALENT_VALUE for null', () => {\n+        expect(\n+          findDefaultNullEquivalentValue({\n+            value: null,\n+            fieldMetadataType: FieldMetadataType.TEXT,\n+          }),\n+        ).toBe(DEFAULT_TEXT_FIELD_NULL_EQUIVALENT_VALUE);\n+      });\n+\n+      it('should return DEFAULT_TEXT_FIELD_NULL_EQUIVALENT_VALUE for empty string', () => {\n+        expect(\n+          findDefaultNullEquivalentValue({\n+            value: '',\n+            fieldMetadataType: FieldMetadataType.TEXT,\n+          }),\n+        ).toBe(DEFAULT_TEXT_FIELD_NULL_EQUIVALENT_VALUE);\n+      });\n+\n+      it('should return undefined for non-null equivalent value', () => {\n+        expect(\n+          findDefaultNullEquivalentValue({\n+            value: 'value',\n+            fieldMetadataType: FieldMetadataType.TEXT,\n+          }),\n+        ).toBeUndefined();\n+      });\n+    });\n+\n+    describe('ARRAY', () => {\n+      it('should return DEFAULT_ARRAY_FIELD_NULL_EQUIVALENT_VALUE for null', () => {\n+        expect(\n+          findDefaultNullEquivalentValue({\n+            value: null,\n+            fieldMetadataType: FieldMetadataType.ARRAY,\n+          }),\n+        ).toBe(DEFAULT_ARRAY_FIELD_NULL_EQUIVALENT_VALUE);\n+      });\n+\n+      it('should return DEFAULT_ARRAY_FIELD_NULL_EQUIVALENT_VALUE for empty array', () => {\n+        expect(\n+          findDefaultNullEquivalentValue({\n+            value: [],\n+            fieldMetadataType: FieldMetadataType.ARRAY,\n+          }),\n+        ).toBe(DEFAULT_ARRAY_FIELD_NULL_EQUIVALENT_VALUE);\n+      });\n+    });\n+  });\n+\n+  describe('ACTOR', () => {\n+    it('should return text default for name', () => {\n+      expect(\n+        findDefaultNullEquivalentValue({\n+          value: '',\n+          fieldMetadataType: FieldMetadataType.ACTOR,\n+          key: 'name',\n+        }),\n+      ).toBe(DEFAULT_TEXT_FIELD_NULL_EQUIVALENT_VALUE);\n+    });\n+\n+    it('should return undefined for context', () => {\n+      expect(\n+        findDefaultNullEquivalentValue({\n+          value: {},\n+          fieldMetadataType: FieldMetadataType.ACTOR,\n+          key: 'context',\n+        }),\n+      ).toBe(undefined);\n+    });\n+  });\n+\n+  describe('ADDRESS', () => {\n+    it.each([\n+      'addressStreet1',\n+      'addressStreet2',\n+      'addressCity',\n+      'addressState',\n+      'addressPostcode',\n+      'addressCountry',\n+    ])('should return text default for %s', (key) => {\n+      expect(\n+        findDefaultNullEquivalentValue({\n+          value: '',\n+          fieldMetadataType: FieldMetadataType.ADDRESS,\n+          key,\n+        }),\n+      ).toBe(DEFAULT_TEXT_FIELD_NULL_EQUIVALENT_VALUE);\n+    });\n+  });\n+\n+  describe('EMAILS', () => {\n+    it('should return text default for primaryEmail', () => {\n+      expect(\n+        findDefaultNullEquivalentValue({\n+          value: '',\n+          fieldMetadataType: FieldMetadataType.EMAILS,\n+          key: 'primaryEmail',\n+        }),\n+      ).toBe(DEFAULT_TEXT_FIELD_NULL_EQUIVALENT_VALUE);\n+    });\n+\n+    it('should return array default for additionalEmails', () => {\n+      expect(\n+        findDefaultNullEquivalentValue({\n+          value: [],\n+          fieldMetadataType: FieldMetadataType.EMAILS,\n+          key: 'additionalEmails',\n+        }),\n+      ).toBe(DEFAULT_ARRAY_FIELD_NULL_EQUIVALENT_VALUE);\n+    });\n+  });\n+\n+  describe('LINKS', () => {\n+    it('should return text default for primaryLinkUrl', () => {\n+      expect(\n+        findDefaultNullEquivalentValue({\n+          value: '',\n+          fieldMetadataType: FieldMetadataType.LINKS,\n+          key: 'primaryLinkUrl',\n+        }),\n+      ).toBe(DEFAULT_TEXT_FIELD_NULL_EQUIVALENT_VALUE);\n+    });\n+\n+    it('should return text default for primaryLinkLabel', () => {\n+      expect(\n+        findDefaultNullEquivalentValue({\n+          value: '',\n+          fieldMetadataType: FieldMetadataType.LINKS,\n+          key: 'primaryLinkLabel',\n+        }),\n+      ).toBe(DEFAULT_TEXT_FIELD_NULL_EQUIVALENT_VALUE);\n+    });\n+  });\n+\n+  describe('PHONES', () => {\n+    it('should return text default for primaryPhoneNumber', () => {\n+      expect(\n+        findDefaultNullEquivalentValue({\n+          value: '',\n+          fieldMetadataType: FieldMetadataType.PHONES,\n+          key: 'primaryPhoneNumber',\n+        }),\n+      ).toBe(DEFAULT_TEXT_FIELD_NULL_EQUIVALENT_VALUE);\n+    });\n+\n+    it('should return text default for primaryPhoneCountryCode', () => {\n+      expect(\n+        findDefaultNullEquivalentValue({\n+          value: '',\n+          fieldMetadataType: FieldMetadataType.PHONES,\n+          key: 'primaryPhoneCountryCode',\n+        }),\n+      ).toBe(DEFAULT_TEXT_FIELD_NULL_EQUIVALENT_VALUE);\n+    });\n+\n+    it('should return text default for primaryPhoneCallingCode', () => {\n+      expect(\n+        findDefaultNullEquivalentValue({\n+          value: '',\n+          fieldMetadataType: FieldMetadataType.PHONES,\n+          key: 'primaryPhoneCallingCode',\n+        }),\n+      ).toBe(DEFAULT_TEXT_FIELD_NULL_EQUIVALENT_VALUE);\n+    });\n+  });\n+\n+  describe('RICH_TEXT_V2', () => {\n+    it('should return undefined for blocknote', () => {\n+      expect(\n+        findDefaultNullEquivalentValue({\n+          value: {},\n+          fieldMetadataType: FieldMetadataType.RICH_TEXT_V2,\n+          key: 'blocknote',\n+        }),\n+      ).toBe(undefined);\n+    });\n+\n+    it('should return text default for markdown', () => {\n+      expect(\n+        findDefaultNullEquivalentValue({\n+          value: '',\n+          fieldMetadataType: FieldMetadataType.RICH_TEXT_V2,\n+          key: 'markdown',\n+        }),\n+      ).toBe(DEFAULT_TEXT_FIELD_NULL_EQUIVALENT_VALUE);\n+    });\n+  });\n+\n+  describe('FULL_NAME', () => {\n+    it.each(['firstName', 'lastName'])(\n+      'should return text default for %s',\n+      (key) => {\n+        expect(\n+          findDefaultNullEquivalentValue({\n+            value: '',\n+            fieldMetadataType: FieldMetadataType.FULL_NAME,\n+            key,\n+          }),\n+        ).toBe(DEFAULT_TEXT_FIELD_NULL_EQUIVALENT_VALUE);\n+      },\n+    );\n+  });\n+});\n+\n+it('should return undefined for unknown type', () => {\n+  expect(\n+    findDefaultNullEquivalentValue({\n+      value: null,\n+      fieldMetadataType: 'UNKNOWN' as any,\n+    }),\n+  ).toBeUndefined();\n+});\n+\n+it('should return undefined for unknown composite key', () => {\n+  expect(\n+    findDefaultNullEquivalentValue({\n+      value: '',\n+      fieldMetadataType: FieldMetadataType.ACTOR,\n+      key: 'unknown',\n+    }),\n+  ).toBeUndefined();\n+});\ndiff --git a/packages/twenty-server/src/modules/workflow/workflow-executor/workflow-actions/filter/utils/evaluate-filter-conditions.util.ts b/packages/twenty-server/src/modules/workflow/workflow-executor/workflow-actions/filter/utils/evaluate-filter-conditions.util.ts\nindex 98ebd49cec692..743a659ec0b66 100644\n--- a/packages/twenty-server/src/modules/workflow/workflow-executor/workflow-actions/filter/utils/evaluate-filter-conditions.util.ts\n+++ b/packages/twenty-server/src/modules/workflow/workflow-executor/workflow-actions/filter/utils/evaluate-filter-conditions.util.ts\n@@ -10,9 +10,13 @@ import {\n   ViewFilterOperand,\n   type ViewFilterOperandDeprecated,\n } from 'twenty-shared/types';\n-import { convertViewFilterOperandToCoreOperand as convertViewFilterOperandDeprecated } from 'twenty-shared/utils';\n+import {\n+  convertViewFilterOperandToCoreOperand as convertViewFilterOperandDeprecated,\n+  isDefined,\n+} from 'twenty-shared/utils';\n import { parseBooleanFromStringValue } from 'twenty-shared/workflow';\n \n+import { findDefaultNullEquivalentValue } from 'src/modules/workflow/workflow-executor/workflow-actions/filter/utils/find-default-null-equivalent-value.util';\n import { parseAndEvaluateRelativeDateFilter } from 'src/modules/workflow/workflow-executor/workflow-actions/filter/utils/parse-and-evaluate-relative-date-filter.util';\n \n type ResolvedFilterWithPotentiallyDeprecatedOperand = Omit<\n@@ -59,7 +63,11 @@ function evaluateFilter(\n     case 'ARRAY':\n     case 'array':\n     case 'RAW_JSON':\n-      return evaluateTextAndArrayFilter(filterWithConvertedOperand);\n+      return evaluateTextAndArrayFilter(\n+        filterWithConvertedOperand,\n+        filter.type,\n+        filter.compositeFieldSubFieldName,\n+      );\n     case 'SELECT':\n       return evaluateSelectFilter(filterWithConvertedOperand);\n     case 'BOOLEAN':\n@@ -146,12 +154,31 @@ function contains(leftValue: unknown, rightValue: unknown): boolean {\n   return String(leftValue).includes(String(rightValue));\n }\n \n-function evaluateTextAndArrayFilter(filter: ResolvedFilter): boolean {\n+function evaluateTextAndArrayFilter(\n+  filter: ResolvedFilter,\n+  filterType: string,\n+  compositeFieldSubFieldName: string | undefined,\n+): boolean {\n+  //TODO : nullEquivalentRightValue to remove once feature flag removed + workflow action based on common api\n+  const nullEquivalentRightValue = findDefaultNullEquivalentValue({\n+    value: filter.rightOperand,\n+    fieldMetadataType: filterType,\n+    key: compositeFieldSubFieldName,\n+  });\n+\n   switch (filter.operand) {\n     case ViewFilterOperand.CONTAINS:\n-      return contains(filter.leftOperand, filter.rightOperand);\n+      return (\n+        contains(filter.leftOperand, filter.rightOperand) ||\n+        (isDefined(nullEquivalentRightValue) &&\n+          !isNotEmptyTextOrArray(filter.leftOperand))\n+      );\n     case ViewFilterOperand.DOES_NOT_CONTAIN:\n-      return !contains(filter.leftOperand, filter.rightOperand);\n+      return (\n+        !contains(filter.leftOperand, filter.rightOperand) ||\n+        (isDefined(nullEquivalentRightValue) &&\n+          isNotEmptyTextOrArray(filter.leftOperand))\n+      );\n     case ViewFilterOperand.IS_EMPTY:\n       return !isNotEmptyTextOrArray(filter.leftOperand);\n \ndiff --git a/packages/twenty-server/src/modules/workflow/workflow-executor/workflow-actions/filter/utils/find-default-null-equivalent-value.util.ts b/packages/twenty-server/src/modules/workflow/workflow-executor/workflow-actions/filter/utils/find-default-null-equivalent-value.util.ts\nnew file mode 100644\nindex 0000000000000..6e51dc7fd86bc\n--- /dev/null\n+++ b/packages/twenty-server/src/modules/workflow/workflow-executor/workflow-actions/filter/utils/find-default-null-equivalent-value.util.ts\n@@ -0,0 +1,151 @@\n+import { FieldMetadataType } from 'twenty-shared/types';\n+\n+import {\n+  DEFAULT_ARRAY_FIELD_NULL_EQUIVALENT_VALUE,\n+  DEFAULT_TEXT_FIELD_NULL_EQUIVALENT_VALUE,\n+} from 'src/engine/api/common/common-args-processors/data-arg-processor/constants/null-equivalent-values.constant';\n+import { isNullEquivalentArrayFieldValue } from 'src/engine/api/common/common-args-processors/data-arg-processor/utils/is-null-equivalent-array-field-value.util';\n+import { isNullEquivalentTextFieldValue } from 'src/engine/api/common/common-args-processors/data-arg-processor/utils/is-null-equivalent-text-field-value.util';\n+\n+export const findDefaultNullEquivalentValue = ({\n+  value,\n+  fieldMetadataType,\n+  key,\n+}: {\n+  value: unknown;\n+  fieldMetadataType: string;\n+  key?: string;\n+}) => {\n+  switch (fieldMetadataType) {\n+    case FieldMetadataType.TEXT:\n+      return isNullEquivalentTextFieldValue(value)\n+        ? DEFAULT_TEXT_FIELD_NULL_EQUIVALENT_VALUE\n+        : undefined;\n+    case FieldMetadataType.MULTI_SELECT:\n+    case FieldMetadataType.ARRAY:\n+      return isNullEquivalentArrayFieldValue(value)\n+        ? DEFAULT_ARRAY_FIELD_NULL_EQUIVALENT_VALUE\n+        : undefined;\n+    case FieldMetadataType.ACTOR: {\n+      switch (key) {\n+        case 'name':\n+          return isNullEquivalentTextFieldValue(value)\n+            ? DEFAULT_TEXT_FIELD_NULL_EQUIVALENT_VALUE\n+            : undefined;\n+        default:\n+          return undefined;\n+      }\n+    }\n+    case FieldMetadataType.ADDRESS: {\n+      switch (key) {\n+        case 'addressStreet1':\n+          return isNullEquivalentTextFieldValue(value)\n+            ? DEFAULT_TEXT_FIELD_NULL_EQUIVALENT_VALUE\n+            : undefined;\n+        case 'addressStreet2':\n+          return isNullEquivalentTextFieldValue(value)\n+            ? DEFAULT_TEXT_FIELD_NULL_EQUIVALENT_VALUE\n+            : undefined;\n+        case 'addressCity':\n+          return isNullEquivalentTextFieldValue(value)\n+            ? DEFAULT_TEXT_FIELD_NULL_EQUIVALENT_VALUE\n+            : undefined;\n+        case 'addressState':\n+          return isNullEquivalentTextFieldValue(value)\n+            ? DEFAULT_TEXT_FIELD_NULL_EQUIVALENT_VALUE\n+            : undefined;\n+        case 'addressPostcode':\n+          return isNullEquivalentTextFieldValue(value)\n+            ? DEFAULT_TEXT_FIELD_NULL_EQUIVALENT_VALUE\n+            : undefined;\n+        case 'addressCountry':\n+          return isNullEquivalentTextFieldValue(value)\n+            ? DEFAULT_TEXT_FIELD_NULL_EQUIVALENT_VALUE\n+            : undefined;\n+        default:\n+          return undefined;\n+      }\n+    }\n+    case FieldMetadataType.EMAILS: {\n+      switch (key) {\n+        case 'primaryEmail':\n+          return isNullEquivalentTextFieldValue(value)\n+            ? DEFAULT_TEXT_FIELD_NULL_EQUIVALENT_VALUE\n+            : undefined;\n+        case 'additionalEmails':\n+          return isNullEquivalentArrayFieldValue(value)\n+            ? DEFAULT_ARRAY_FIELD_NULL_EQUIVALENT_VALUE\n+            : undefined;\n+        default:\n+          return undefined;\n+      }\n+    }\n+    case FieldMetadataType.LINKS: {\n+      switch (key) {\n+        case 'primaryLinkUrl':\n+          return isNullEquivalentTextFieldValue(value)\n+            ? DEFAULT_TEXT_FIELD_NULL_EQUIVALENT_VALUE\n+            : undefined;\n+        case 'primaryLinkLabel':\n+          return isNullEquivalentTextFieldValue(value)\n+            ? DEFAULT_TEXT_FIELD_NULL_EQUIVALENT_VALUE\n+            : undefined;\n+        case 'secondaryLinks':\n+          return isNullEquivalentArrayFieldValue(value)\n+            ? DEFAULT_ARRAY_FIELD_NULL_EQUIVALENT_VALUE\n+            : undefined;\n+\n+        default:\n+          return undefined;\n+      }\n+    }\n+    case FieldMetadataType.PHONES: {\n+      switch (key) {\n+        case 'primaryPhoneNumber':\n+          return isNullEquivalentTextFieldValue(value)\n+            ? DEFAULT_TEXT_FIELD_NULL_EQUIVALENT_VALUE\n+            : undefined;\n+        case 'primaryPhoneCountryCode':\n+          return isNullEquivalentTextFieldValue(value)\n+            ? DEFAULT_TEXT_FIELD_NULL_EQUIVALENT_VALUE\n+            : undefined;\n+        case 'primaryPhoneCallingCode':\n+          return isNullEquivalentTextFieldValue(value)\n+            ? DEFAULT_TEXT_FIELD_NULL_EQUIVALENT_VALUE\n+            : undefined;\n+        case 'additionalPhones':\n+          return isNullEquivalentArrayFieldValue(value)\n+            ? DEFAULT_ARRAY_FIELD_NULL_EQUIVALENT_VALUE\n+            : undefined;\n+        default:\n+          return undefined;\n+      }\n+    }\n+    case FieldMetadataType.RICH_TEXT_V2: {\n+      switch (key) {\n+        case 'markdown':\n+          return isNullEquivalentTextFieldValue(value)\n+            ? DEFAULT_TEXT_FIELD_NULL_EQUIVALENT_VALUE\n+            : undefined;\n+        default:\n+          return undefined;\n+      }\n+    }\n+    case FieldMetadataType.FULL_NAME: {\n+      switch (key) {\n+        case 'firstName':\n+          return isNullEquivalentTextFieldValue(value)\n+            ? DEFAULT_TEXT_FIELD_NULL_EQUIVALENT_VALUE\n+            : undefined;\n+        case 'lastName':\n+          return isNullEquivalentTextFieldValue(value)\n+            ? DEFAULT_TEXT_FIELD_NULL_EQUIVALENT_VALUE\n+            : undefined;\n+        default:\n+          return undefined;\n+      }\n+    }\n+  }\n+\n+  return undefined;\n+};\n"}
{"instance_id": "twentyhq__twenty.main.16112", "repo": "twentyhq/twenty", "base_commit": "5d1c2a33480540375b70ef3e1199ca8afac22e3a", "head_commit": "fcdcddda7e24bc6e9d32af19164374a9951bdcf6", "title": "Fix messaging import", "merged_at": "2025-11-26T22:13:12Z", "html_url": "https://github.com/twentyhq/twenty/pull/16112", "test_files": ["packages/twenty-server/src/modules/messaging/message-import-manager/drivers/gmail/utils/__tests__/parse-gmail-messages-import-error.spec.ts"], "code_files": ["packages/twenty-server/src/modules/messaging/message-import-manager/drivers/gmail/services/gmail-messages-import-error-handler.service.ts", "packages/twenty-server/src/modules/messaging/message-import-manager/drivers/gmail/utils/parse-gmail-api-batch-error.util.ts"], "total_changes": 31, "num_files": 3, "pull_number": 16112, "patch": "diff --git a/packages/twenty-server/src/modules/messaging/message-import-manager/drivers/gmail/services/gmail-messages-import-error-handler.service.ts b/packages/twenty-server/src/modules/messaging/message-import-manager/drivers/gmail/services/gmail-messages-import-error-handler.service.ts\nindex 9ab22c68174b2..569820634aa07 100644\n--- a/packages/twenty-server/src/modules/messaging/message-import-manager/drivers/gmail/services/gmail-messages-import-error-handler.service.ts\n+++ b/packages/twenty-server/src/modules/messaging/message-import-manager/drivers/gmail/services/gmail-messages-import-error-handler.service.ts\n@@ -1,5 +1,7 @@\n import { Injectable, Logger } from '@nestjs/common';\n \n+import { isDefined } from 'twenty-shared/utils';\n+\n import {\n   MessageImportDriverException,\n   MessageImportDriverExceptionCode,\n@@ -23,7 +25,13 @@ export class GmailMessagesImportErrorHandler {\n     }\n \n     if (isGmailApiBatchError(error)) {\n-      throw parseGmailApiBatchError(error, messageExternalId);\n+      const exception = parseGmailApiBatchError(error, messageExternalId);\n+\n+      if (!isDefined(exception)) {\n+        return;\n+      }\n+\n+      throw exception;\n     }\n \n     throw new MessageImportDriverException(\ndiff --git a/packages/twenty-server/src/modules/messaging/message-import-manager/drivers/gmail/utils/__tests__/parse-gmail-messages-import-error.spec.ts b/packages/twenty-server/src/modules/messaging/message-import-manager/drivers/gmail/utils/__tests__/parse-gmail-messages-import-error.spec.ts\nindex 6f2b99524bb59..bd1c44455eda8 100644\n--- a/packages/twenty-server/src/modules/messaging/message-import-manager/drivers/gmail/utils/__tests__/parse-gmail-messages-import-error.spec.ts\n+++ b/packages/twenty-server/src/modules/messaging/message-import-manager/drivers/gmail/utils/__tests__/parse-gmail-messages-import-error.spec.ts\n@@ -111,26 +111,14 @@ describe('parseGmailApiBatchError', () => {\n     const error = gmailBatchApiErrorMocks.getError(404);\n     const exception = parseGmailApiBatchError(error, messageExternalId);\n \n-    expect(exception).toBeInstanceOf(MessageImportDriverException);\n-    expect(exception?.code).toBe(\n-      MessageImportDriverExceptionCode.SYNC_CURSOR_ERROR,\n-    );\n-    expect(exception?.message).toBe(\n-      `${error.errors[0].message} for message with externalId: ${messageExternalId}`,\n-    );\n+    expect(exception).toBeUndefined();\n   });\n \n   it('should handle 410 Gone', () => {\n     const error = gmailBatchApiErrorMocks.getError(410);\n     const exception = parseGmailApiBatchError(error, messageExternalId);\n \n-    expect(exception).toBeInstanceOf(MessageImportDriverException);\n-    expect(exception?.code).toBe(\n-      MessageImportDriverExceptionCode.SYNC_CURSOR_ERROR,\n-    );\n-    expect(exception?.message).toBe(\n-      `${error.errors[0].message} for message with externalId: ${messageExternalId}`,\n-    );\n+    expect(exception).toBeUndefined();\n   });\n \n   it('should handle 429 Too Many Requests', () => {\ndiff --git a/packages/twenty-server/src/modules/messaging/message-import-manager/drivers/gmail/utils/parse-gmail-api-batch-error.util.ts b/packages/twenty-server/src/modules/messaging/message-import-manager/drivers/gmail/utils/parse-gmail-api-batch-error.util.ts\nindex 1314e8e72a0f3..f2d9755bfdc75 100644\n--- a/packages/twenty-server/src/modules/messaging/message-import-manager/drivers/gmail/utils/parse-gmail-api-batch-error.util.ts\n+++ b/packages/twenty-server/src/modules/messaging/message-import-manager/drivers/gmail/utils/parse-gmail-api-batch-error.util.ts\n@@ -43,10 +43,7 @@ export const parseGmailApiBatchError = (\n \n     case 404:\n     case 410:\n-      return new MessageImportDriverException(\n-        message,\n-        MessageImportDriverExceptionCode.SYNC_CURSOR_ERROR,\n-      );\n+      return undefined;\n \n     case 429:\n       return new MessageImportDriverException(\n"}
{"instance_id": "twentyhq__twenty.main.16071", "repo": "twentyhq/twenty", "base_commit": "6c1c78ea3d94ac6dc3031c00bd67fa28aa5d16db", "head_commit": "afeb0ad57ff4e7d34356a1bb18af9ae1f8af9304", "title": "Fix message import scheduled", "merged_at": "2025-11-26T07:54:53Z", "html_url": "https://github.com/twentyhq/twenty/pull/16071", "test_files": ["packages/twenty-server/src/modules/messaging/message-import-manager/services/messaging-messages-import.service.spec.ts"], "code_files": ["packages/twenty-server/src/modules/messaging/message-import-manager/services/messaging-messages-import.service.ts"], "total_changes": 8, "num_files": 2, "pull_number": 16071, "patch": "diff --git a/packages/twenty-server/src/modules/messaging/message-import-manager/services/messaging-messages-import.service.spec.ts b/packages/twenty-server/src/modules/messaging/message-import-manager/services/messaging-messages-import.service.spec.ts\nindex f973b916cf4ef..f11d03923f6c2 100644\n--- a/packages/twenty-server/src/modules/messaging/message-import-manager/services/messaging-messages-import.service.spec.ts\n+++ b/packages/twenty-server/src/modules/messaging/message-import-manager/services/messaging-messages-import.service.spec.ts\n@@ -49,7 +49,7 @@ describe('MessagingMessagesImportService', () => {\n \n     mockMessageChannel = {\n       id: 'message-channel-id',\n-      syncStage: MessageChannelSyncStage.MESSAGES_IMPORT_PENDING,\n+      syncStage: MessageChannelSyncStage.MESSAGES_IMPORT_SCHEDULED,\n       connectedAccountId: mockConnectedAccount.id,\n       handle: 'test@gmail.com',\n     } as MessageChannelWorkspaceEntity;\n@@ -192,9 +192,9 @@ describe('MessagingMessagesImportService', () => {\n       );\n   });\n \n-  it('should fails if SyncStage is not MESSAGES_IMPORT_PENDING', async () => {\n+  it('should fails if SyncStage is not MESSAGES_IMPORT_SCHEDULED', async () => {\n     mockMessageChannel.syncStage =\n-      MessageChannelSyncStage.MESSAGE_LIST_FETCH_PENDING;\n+      MessageChannelSyncStage.MESSAGES_IMPORT_PENDING;\n \n     expect(\n       service.processMessageBatchImport(\ndiff --git a/packages/twenty-server/src/modules/messaging/message-import-manager/services/messaging-messages-import.service.ts b/packages/twenty-server/src/modules/messaging/message-import-manager/services/messaging-messages-import.service.ts\nindex 57ffaa8e4136c..73e448df7cf03 100644\n--- a/packages/twenty-server/src/modules/messaging/message-import-manager/services/messaging-messages-import.service.ts\n+++ b/packages/twenty-server/src/modules/messaging/message-import-manager/services/messaging-messages-import.service.ts\n@@ -53,7 +53,7 @@ export class MessagingMessagesImportService {\n     try {\n       if (\n         messageChannel.syncStage !==\n-        MessageChannelSyncStage.MESSAGES_IMPORT_PENDING\n+        MessageChannelSyncStage.MESSAGES_IMPORT_SCHEDULED\n       ) {\n         return;\n       }\n"}
{"instance_id": "twentyhq__twenty.main.16070", "repo": "twentyhq/twenty", "base_commit": "7bf68e5f31575e6582692f9a06497ffb59699e0c", "head_commit": "dfd3380b6dd8a906952a68ddb1d1696a76d2deb3", "title": "Security - add throttle in message resend", "merged_at": "2025-11-28T17:33:06Z", "html_url": "https://github.com/twentyhq/twenty/pull/16070", "test_files": ["packages/twenty-server/src/engine/core-modules/workspace-invitation/services/workspace-invitation.service.spec.ts"], "code_files": ["packages/twenty-server/src/engine/core-modules/twenty-config/config-variables.ts", "packages/twenty-server/src/engine/core-modules/workspace-invitation/services/workspace-invitation.service.ts", "packages/twenty-server/src/engine/core-modules/workspace-invitation/workspace-invitation.module.ts", "packages/twenty-server/src/engine/core-modules/workspace-invitation/workspace-invitation.resolver.ts"], "total_changes": 96, "num_files": 5, "pull_number": 16070, "patch": "diff --git a/packages/twenty-server/src/engine/core-modules/twenty-config/config-variables.ts b/packages/twenty-server/src/engine/core-modules/twenty-config/config-variables.ts\nindex 8904189de5ee1..d72b44186a19f 100644\n--- a/packages/twenty-server/src/engine/core-modules/twenty-config/config-variables.ts\n+++ b/packages/twenty-server/src/engine/core-modules/twenty-config/config-variables.ts\n@@ -975,7 +975,7 @@ export class ConfigVariables {\n     type: ConfigVariableType.NUMBER,\n   })\n   @CastToPositiveNumber()\n-  API_RATE_LIMITING_LONG_TTL_IN_MS = 60000;\n+  API_RATE_LIMITING_LONG_TTL_IN_MS = 60_000;\n \n   @ConfigVariablesMetadata({\n     group: ConfigVariablesGroup.RATE_LIMITING,\n@@ -994,6 +994,42 @@ export class ConfigVariables {\n   })\n   GRAPHQL_MAX_COMPLEXITY = 2000;\n \n+  @ConfigVariablesMetadata({\n+    group: ConfigVariablesGroup.RATE_LIMITING,\n+    description:\n+      'Time-to-live for workspace-level invitations resending rate limiting in milliseconds',\n+    type: ConfigVariableType.NUMBER,\n+  })\n+  @CastToPositiveNumber()\n+  INVITATION_SENDING_BY_WORKSPACE_THROTTLE_TTL_IN_MS = 604_800_000; // 7 days\n+\n+  @ConfigVariablesMetadata({\n+    group: ConfigVariablesGroup.RATE_LIMITING,\n+    description:\n+      'Maximum number of workspace-level invitations resending allowed in the rate limiting window',\n+    type: ConfigVariableType.NUMBER,\n+  })\n+  @CastToPositiveNumber()\n+  INVITATION_SENDING_BY_WORKSPACE_THROTTLE_LIMIT = 500;\n+\n+  @ConfigVariablesMetadata({\n+    group: ConfigVariablesGroup.RATE_LIMITING,\n+    description:\n+      'Time-to-live for email-level invitations sending rate limiting in milliseconds',\n+    type: ConfigVariableType.NUMBER,\n+  })\n+  @CastToPositiveNumber()\n+  INVITATION_SENDING_BY_EMAIL_THROTTLE_TTL_IN_MS = 604_800_000; // 7 days\n+\n+  @ConfigVariablesMetadata({\n+    group: ConfigVariablesGroup.RATE_LIMITING,\n+    description:\n+      'Maximum number of email-level invitations sending allowed in the rate limiting window',\n+    type: ConfigVariableType.NUMBER,\n+  })\n+  @CastToPositiveNumber()\n+  INVITATION_SENDING_BY_EMAIL_THROTTLE_LIMIT = 10;\n+\n   @ConfigVariablesMetadata({\n     group: ConfigVariablesGroup.SSL,\n     description: 'Path to the SSL key for enabling HTTPS in local development',\ndiff --git a/packages/twenty-server/src/engine/core-modules/workspace-invitation/services/workspace-invitation.service.spec.ts b/packages/twenty-server/src/engine/core-modules/workspace-invitation/services/workspace-invitation.service.spec.ts\nindex 4661d89b81895..c603b0b98dc84 100644\n--- a/packages/twenty-server/src/engine/core-modules/workspace-invitation/services/workspace-invitation.service.spec.ts\n+++ b/packages/twenty-server/src/engine/core-modules/workspace-invitation/services/workspace-invitation.service.spec.ts\n@@ -12,6 +12,7 @@ import { EmailService } from 'src/engine/core-modules/email/email.service';\n import { FileService } from 'src/engine/core-modules/file/services/file.service';\n import { I18nService } from 'src/engine/core-modules/i18n/i18n.service';\n import { OnboardingService } from 'src/engine/core-modules/onboarding/onboarding.service';\n+import { ThrottlerService } from 'src/engine/core-modules/throttler/throttler.service';\n import { TwentyConfigService } from 'src/engine/core-modules/twenty-config/twenty-config.service';\n import { UserWorkspaceEntity } from 'src/engine/core-modules/user-workspace/user-workspace.entity';\n import { WorkspaceInvitationException } from 'src/engine/core-modules/workspace-invitation/workspace-invitation.exception';\n@@ -112,6 +113,12 @@ describe('WorkspaceInvitationService', () => {\n               .mockReturnValue('https://signed-url.com/logo.png'),\n           },\n         },\n+        {\n+          provide: ThrottlerService,\n+          useValue: {\n+            tokenBucketThrottleOrThrow: jest.fn(),\n+          },\n+        },\n       ],\n     }).compile();\n \ndiff --git a/packages/twenty-server/src/engine/core-modules/workspace-invitation/services/workspace-invitation.service.ts b/packages/twenty-server/src/engine/core-modules/workspace-invitation/services/workspace-invitation.service.ts\nindex df6932a71d5bd..d6acc364997e1 100644\n--- a/packages/twenty-server/src/engine/core-modules/workspace-invitation/services/workspace-invitation.service.ts\n+++ b/packages/twenty-server/src/engine/core-modules/workspace-invitation/services/workspace-invitation.service.ts\n@@ -25,6 +25,7 @@ import { EmailService } from 'src/engine/core-modules/email/email.service';\n import { FileService } from 'src/engine/core-modules/file/services/file.service';\n import { I18nService } from 'src/engine/core-modules/i18n/i18n.service';\n import { OnboardingService } from 'src/engine/core-modules/onboarding/onboarding.service';\n+import { ThrottlerService } from 'src/engine/core-modules/throttler/throttler.service';\n import { TwentyConfigService } from 'src/engine/core-modules/twenty-config/twenty-config.service';\n import { UserWorkspaceEntity } from 'src/engine/core-modules/user-workspace/user-workspace.entity';\n import { type SendInvitationsOutput } from 'src/engine/core-modules/workspace-invitation/dtos/send-invitations.output';\n@@ -49,6 +50,7 @@ export class WorkspaceInvitationService {\n     private readonly workspaceDomainsService: WorkspaceDomainsService,\n     private readonly i18nService: I18nService,\n     private readonly fileService: FileService,\n+    private readonly throttlerService: ThrottlerService,\n   ) {}\n \n   async validatePersonalInvitation({\n@@ -262,6 +264,8 @@ export class WorkspaceInvitationService {\n       };\n     }\n \n+    await this.throttleInvitationSending(workspace.id, emails);\n+\n     const invitationsPr = await Promise.allSettled(\n       emails.map(async (email) => {\n         if (usePersonalInvitation) {\n@@ -421,4 +425,47 @@ export class WorkspaceInvitationService {\n \n     return this.appTokenRepository.save(invitationToken);\n   }\n+\n+  private async throttleInvitationSending(\n+    workspaceId: string,\n+    emails: string[],\n+  ) {\n+    try {\n+      //limit invitation sending for specific invite emails\n+      await Promise.all(\n+        emails.map(async (email) => {\n+          await this.throttlerService.tokenBucketThrottleOrThrow(\n+            `invitation-resending-workspace:throttler:${email}`,\n+            1,\n+            this.twentyConfigService.get(\n+              'INVITATION_SENDING_BY_EMAIL_THROTTLE_LIMIT',\n+            ),\n+            this.twentyConfigService.get(\n+              'INVITATION_SENDING_BY_EMAIL_THROTTLE_TTL_IN_MS',\n+            ),\n+          );\n+        }),\n+      );\n+\n+      //limit invitation sending for a specific workspace\n+      await this.throttlerService.tokenBucketThrottleOrThrow(\n+        `invitation-resending-workspace:throttler:${workspaceId}`,\n+        emails.length,\n+        this.twentyConfigService.get(\n+          'INVITATION_SENDING_BY_WORKSPACE_THROTTLE_LIMIT',\n+        ),\n+        this.twentyConfigService.get(\n+          'INVITATION_SENDING_BY_WORKSPACE_THROTTLE_TTL_IN_MS',\n+        ),\n+      );\n+    } catch {\n+      throw new WorkspaceInvitationException(\n+        'Workspace invitation sending rate limit exceeded.',\n+        WorkspaceInvitationExceptionCode.INVALID_INVITATION,\n+        {\n+          userFriendlyMessage: msg`Too many workspace invitations sent. Please try again later.`,\n+        },\n+      );\n+    }\n+  }\n }\ndiff --git a/packages/twenty-server/src/engine/core-modules/workspace-invitation/workspace-invitation.module.ts b/packages/twenty-server/src/engine/core-modules/workspace-invitation/workspace-invitation.module.ts\nindex becf292d1bc9a..c88b7fef67c0b 100644\n--- a/packages/twenty-server/src/engine/core-modules/workspace-invitation/workspace-invitation.module.ts\n+++ b/packages/twenty-server/src/engine/core-modules/workspace-invitation/workspace-invitation.module.ts\n@@ -7,6 +7,7 @@ import { WorkspaceDomainsModule } from 'src/engine/core-modules/domain/workspace\n import { FeatureFlagModule } from 'src/engine/core-modules/feature-flag/feature-flag.module';\n import { FileModule } from 'src/engine/core-modules/file/file.module';\n import { OnboardingModule } from 'src/engine/core-modules/onboarding/onboarding.module';\n+import { ThrottlerModule } from 'src/engine/core-modules/throttler/throttler.module';\n import { UserWorkspaceEntity } from 'src/engine/core-modules/user-workspace/user-workspace.entity';\n import { WorkspaceInvitationService } from 'src/engine/core-modules/workspace-invitation/services/workspace-invitation.service';\n import { WorkspaceInvitationResolver } from 'src/engine/core-modules/workspace-invitation/workspace-invitation.resolver';\n@@ -25,6 +26,7 @@ import { PermissionsModule } from 'src/engine/metadata-modules/permissions/permi\n     OnboardingModule,\n     PermissionsModule,\n     FeatureFlagModule,\n+    ThrottlerModule,\n   ],\n   exports: [WorkspaceInvitationService],\n   providers: [WorkspaceInvitationService, WorkspaceInvitationResolver],\ndiff --git a/packages/twenty-server/src/engine/core-modules/workspace-invitation/workspace-invitation.resolver.ts b/packages/twenty-server/src/engine/core-modules/workspace-invitation/workspace-invitation.resolver.ts\nindex bc71e5efec1f7..81fdce79036ee 100644\n--- a/packages/twenty-server/src/engine/core-modules/workspace-invitation/workspace-invitation.resolver.ts\n+++ b/packages/twenty-server/src/engine/core-modules/workspace-invitation/workspace-invitation.resolver.ts\n@@ -1,7 +1,6 @@\n import { UseFilters, UseGuards, UsePipes } from '@nestjs/common';\n import { Args, Mutation, Query, Resolver } from '@nestjs/graphql';\n \n-import { FileService } from 'src/engine/core-modules/file/services/file.service';\n import { PreventNestToAutoLogGraphqlErrorsFilter } from 'src/engine/core-modules/graphql/filters/prevent-nest-to-auto-log-graphql-errors.filter';\n import { ResolverValidationPipe } from 'src/engine/core-modules/graphql/pipes/resolver-validation.pipe';\n import { UserEntity } from 'src/engine/core-modules/user/user.entity';\n@@ -35,7 +34,6 @@ export class WorkspaceInvitationResolver {\n   constructor(\n     private readonly twentyORMGlobalManager: TwentyORMGlobalManager,\n     private readonly workspaceInvitationService: WorkspaceInvitationService,\n-    private readonly fileService: FileService,\n   ) {}\n \n   @Mutation(() => String)\n"}
{"instance_id": "twentyhq__twenty.main.16062", "repo": "twentyhq/twenty", "base_commit": "71724de7dd08c7153bc1a45158296feb75a11fdd", "head_commit": "9ba583bec3d2ba4f9ed8ff0a341046533ae4fe17", "title": "move folder cron to `message-list-fetch`", "merged_at": "2025-11-25T17:06:39Z", "html_url": "https://github.com/twentyhq/twenty/pull/16062", "test_files": ["packages/twenty-server/src/modules/messaging/message-import-manager/services/messaging-message-list-fetch.service.spec.ts"], "code_files": ["packages/twenty-server/src/modules/messaging/message-import-manager/crons/commands/messaging-process-folder-actions.cron.command.ts", "packages/twenty-server/src/modules/messaging/message-import-manager/crons/jobs/messaging-process-folder-actions.cron.job.ts", "packages/twenty-server/src/modules/messaging/message-import-manager/jobs/messaging-process-folder-actions.job.ts", "packages/twenty-server/src/modules/messaging/message-import-manager/messaging-import-manager.module.ts", "packages/twenty-server/src/modules/messaging/message-import-manager/services/messaging-message-list-fetch.service.ts"], "total_changes": 323, "num_files": 6, "pull_number": 16062, "patch": "diff --git a/packages/twenty-server/src/modules/messaging/message-import-manager/crons/commands/messaging-process-folder-actions.cron.command.ts b/packages/twenty-server/src/modules/messaging/message-import-manager/crons/commands/messaging-process-folder-actions.cron.command.ts\ndeleted file mode 100644\nindex 84f97a2433970..0000000000000\n--- a/packages/twenty-server/src/modules/messaging/message-import-manager/crons/commands/messaging-process-folder-actions.cron.command.ts\n+++ /dev/null\n@@ -1,35 +0,0 @@\n-import { Command, CommandRunner } from 'nest-commander';\n-\n-import { InjectMessageQueue } from 'src/engine/core-modules/message-queue/decorators/message-queue.decorator';\n-import { MessageQueue } from 'src/engine/core-modules/message-queue/message-queue.constants';\n-import { MessageQueueService } from 'src/engine/core-modules/message-queue/services/message-queue.service';\n-import {\n-  MESSAGING_PROCESS_FOLDER_ACTIONS_CRON_PATTERN,\n-  MessagingProcessFolderActionsCronJob,\n-} from 'src/modules/messaging/message-import-manager/crons/jobs/messaging-process-folder-actions.cron.job';\n-\n-@Command({\n-  name: 'cron:messaging:process-folder-actions',\n-  description:\n-    'Starts a cron job to process pending folder actions (deletion) for message channels',\n-})\n-export class MessagingProcessFolderActionsCronCommand extends CommandRunner {\n-  constructor(\n-    @InjectMessageQueue(MessageQueue.cronQueue)\n-    private readonly messageQueueService: MessageQueueService,\n-  ) {\n-    super();\n-  }\n-\n-  async run(): Promise<void> {\n-    await this.messageQueueService.addCron<undefined>({\n-      jobName: MessagingProcessFolderActionsCronJob.name,\n-      data: undefined,\n-      options: {\n-        repeat: {\n-          pattern: MESSAGING_PROCESS_FOLDER_ACTIONS_CRON_PATTERN,\n-        },\n-      },\n-    });\n-  }\n-}\ndiff --git a/packages/twenty-server/src/modules/messaging/message-import-manager/crons/jobs/messaging-process-folder-actions.cron.job.ts b/packages/twenty-server/src/modules/messaging/message-import-manager/crons/jobs/messaging-process-folder-actions.cron.job.ts\ndeleted file mode 100644\nindex 95298dc3bd224..0000000000000\n--- a/packages/twenty-server/src/modules/messaging/message-import-manager/crons/jobs/messaging-process-folder-actions.cron.job.ts\n+++ /dev/null\n@@ -1,76 +0,0 @@\n-import { InjectDataSource, InjectRepository } from '@nestjs/typeorm';\n-\n-import { WorkspaceActivationStatus } from 'twenty-shared/workspace';\n-import { DataSource, Repository } from 'typeorm';\n-\n-import { SentryCronMonitor } from 'src/engine/core-modules/cron/sentry-cron-monitor.decorator';\n-import { ExceptionHandlerService } from 'src/engine/core-modules/exception-handler/exception-handler.service';\n-import { InjectMessageQueue } from 'src/engine/core-modules/message-queue/decorators/message-queue.decorator';\n-import { Process } from 'src/engine/core-modules/message-queue/decorators/process.decorator';\n-import { Processor } from 'src/engine/core-modules/message-queue/decorators/processor.decorator';\n-import { MessageQueue } from 'src/engine/core-modules/message-queue/message-queue.constants';\n-import { MessageQueueService } from 'src/engine/core-modules/message-queue/services/message-queue.service';\n-import { WorkspaceEntity } from 'src/engine/core-modules/workspace/workspace.entity';\n-import { getWorkspaceSchemaName } from 'src/engine/workspace-datasource/utils/get-workspace-schema-name.util';\n-import { MessageFolderPendingSyncAction } from 'src/modules/messaging/common/standard-objects/message-folder.workspace-entity';\n-import {\n-  MessagingProcessFolderActionsJob,\n-  type MessagingProcessFolderActionsJobData,\n-} from 'src/modules/messaging/message-import-manager/jobs/messaging-process-folder-actions.job';\n-\n-export const MESSAGING_PROCESS_FOLDER_ACTIONS_CRON_PATTERN = '*/15 * * * *';\n-\n-@Processor(MessageQueue.cronQueue)\n-export class MessagingProcessFolderActionsCronJob {\n-  constructor(\n-    @InjectRepository(WorkspaceEntity)\n-    private readonly workspaceRepository: Repository<WorkspaceEntity>,\n-    @InjectMessageQueue(MessageQueue.messagingQueue)\n-    private readonly messageQueueService: MessageQueueService,\n-    @InjectDataSource()\n-    private readonly coreDataSource: DataSource,\n-    private readonly exceptionHandlerService: ExceptionHandlerService,\n-  ) {}\n-\n-  @Process(MessagingProcessFolderActionsCronJob.name)\n-  @SentryCronMonitor(\n-    MessagingProcessFolderActionsCronJob.name,\n-    MESSAGING_PROCESS_FOLDER_ACTIONS_CRON_PATTERN,\n-  )\n-  async handle(): Promise<void> {\n-    const activeWorkspaces = await this.workspaceRepository.find({\n-      where: {\n-        activationStatus: WorkspaceActivationStatus.ACTIVE,\n-      },\n-    });\n-\n-    for (const activeWorkspace of activeWorkspaces) {\n-      try {\n-        const schemaName = getWorkspaceSchemaName(activeWorkspace.id);\n-\n-        const messageChannels = await this.coreDataSource.query(\n-          `SELECT DISTINCT mc.id\n-           FROM ${schemaName}.\"messageChannel\" mc\n-           INNER JOIN ${schemaName}.\"messageFolder\" mf ON mf.\"messageChannelId\" = mc.id\n-           WHERE mf.\"pendingSyncAction\" = '${MessageFolderPendingSyncAction.FOLDER_DELETION}'`,\n-        );\n-\n-        for (const messageChannel of messageChannels) {\n-          await this.messageQueueService.add<MessagingProcessFolderActionsJobData>(\n-            MessagingProcessFolderActionsJob.name,\n-            {\n-              workspaceId: activeWorkspace.id,\n-              messageChannelId: messageChannel.id,\n-            },\n-          );\n-        }\n-      } catch (error) {\n-        this.exceptionHandlerService.captureExceptions([error], {\n-          workspace: {\n-            id: activeWorkspace.id,\n-          },\n-        });\n-      }\n-    }\n-  }\n-}\ndiff --git a/packages/twenty-server/src/modules/messaging/message-import-manager/jobs/messaging-process-folder-actions.job.ts b/packages/twenty-server/src/modules/messaging/message-import-manager/jobs/messaging-process-folder-actions.job.ts\ndeleted file mode 100644\nindex 1fe47a92e2d88..0000000000000\n--- a/packages/twenty-server/src/modules/messaging/message-import-manager/jobs/messaging-process-folder-actions.job.ts\n+++ /dev/null\n@@ -1,92 +0,0 @@\n-import { Logger, Scope } from '@nestjs/common';\n-\n-import { Process } from 'src/engine/core-modules/message-queue/decorators/process.decorator';\n-import { Processor } from 'src/engine/core-modules/message-queue/decorators/processor.decorator';\n-import { MessageQueue } from 'src/engine/core-modules/message-queue/message-queue.constants';\n-import { TwentyORMManager } from 'src/engine/twenty-orm/twenty-orm.manager';\n-import { type MessageChannelWorkspaceEntity } from 'src/modules/messaging/common/standard-objects/message-channel.workspace-entity';\n-import {\n-  MessageFolderPendingSyncAction,\n-  type MessageFolderWorkspaceEntity,\n-} from 'src/modules/messaging/common/standard-objects/message-folder.workspace-entity';\n-import { MessagingProcessFolderActionsService } from 'src/modules/messaging/message-import-manager/services/messaging-process-folder-actions.service';\n-\n-export type MessagingProcessFolderActionsJobData = {\n-  workspaceId: string;\n-  messageChannelId: string;\n-};\n-\n-@Processor({\n-  queueName: MessageQueue.messagingQueue,\n-  scope: Scope.REQUEST,\n-})\n-export class MessagingProcessFolderActionsJob {\n-  private readonly logger = new Logger(MessagingProcessFolderActionsJob.name);\n-\n-  constructor(\n-    private readonly twentyORMManager: TwentyORMManager,\n-    private readonly messagingProcessFolderActionsService: MessagingProcessFolderActionsService,\n-  ) {}\n-\n-  @Process(MessagingProcessFolderActionsJob.name)\n-  async handle(data: MessagingProcessFolderActionsJobData): Promise<void> {\n-    const { workspaceId, messageChannelId } = data;\n-\n-    this.logger.log(\n-      `Processing pending folder actions for message channel ${messageChannelId} in workspace ${workspaceId}`,\n-    );\n-\n-    const messageChannelRepository =\n-      await this.twentyORMManager.getRepository<MessageChannelWorkspaceEntity>(\n-        'messageChannel',\n-      );\n-\n-    const messageChannel = await messageChannelRepository.findOne({\n-      where: {\n-        id: messageChannelId,\n-      },\n-    });\n-\n-    if (!messageChannel) {\n-      this.logger.warn(\n-        `Message channel ${messageChannelId} not found in workspace ${workspaceId}`,\n-      );\n-\n-      return;\n-    }\n-\n-    const messageFolderRepository =\n-      await this.twentyORMManager.getRepository<MessageFolderWorkspaceEntity>(\n-        'messageFolder',\n-      );\n-\n-    const messageFolders = await messageFolderRepository.find({\n-      where: {\n-        messageChannelId: messageChannel.id,\n-        pendingSyncAction: MessageFolderPendingSyncAction.FOLDER_DELETION,\n-      },\n-    });\n-\n-    if (messageFolders.length === 0) {\n-      this.logger.log(\n-        `Message channel ${messageChannelId} has no folders with pending deletion actions, skipping`,\n-      );\n-\n-      return;\n-    }\n-\n-    try {\n-      await this.messagingProcessFolderActionsService.processFolderActions(\n-        messageChannel,\n-        messageFolders,\n-        workspaceId,\n-      );\n-    } catch (error) {\n-      this.logger.error(\n-        `Error processing folder actions for message channel ${messageChannelId} in workspace ${workspaceId}: ${error.message}`,\n-        error.stack,\n-      );\n-      throw error;\n-    }\n-  }\n-}\ndiff --git a/packages/twenty-server/src/modules/messaging/message-import-manager/messaging-import-manager.module.ts b/packages/twenty-server/src/modules/messaging/message-import-manager/messaging-import-manager.module.ts\nindex aec2e14b86005..623ebaceb2951 100644\n--- a/packages/twenty-server/src/modules/messaging/message-import-manager/messaging-import-manager.module.ts\n+++ b/packages/twenty-server/src/modules/messaging/message-import-manager/messaging-import-manager.module.ts\n@@ -18,12 +18,10 @@ import { MessagingSingleMessageImportCommand } from 'src/modules/messaging/messa\n import { MessagingMessageListFetchCronCommand } from 'src/modules/messaging/message-import-manager/crons/commands/messaging-message-list-fetch.cron.command';\n import { MessagingMessagesImportCronCommand } from 'src/modules/messaging/message-import-manager/crons/commands/messaging-messages-import.cron.command';\n import { MessagingOngoingStaleCronCommand } from 'src/modules/messaging/message-import-manager/crons/commands/messaging-ongoing-stale.cron.command';\n-import { MessagingProcessFolderActionsCronCommand } from 'src/modules/messaging/message-import-manager/crons/commands/messaging-process-folder-actions.cron.command';\n import { MessagingRelaunchFailedMessageChannelsCronCommand } from 'src/modules/messaging/message-import-manager/crons/commands/messaging-relaunch-failed-message-channels.cron.command';\n import { MessagingMessageListFetchCronJob } from 'src/modules/messaging/message-import-manager/crons/jobs/messaging-message-list-fetch.cron.job';\n import { MessagingMessagesImportCronJob } from 'src/modules/messaging/message-import-manager/crons/jobs/messaging-messages-import.cron.job';\n import { MessagingOngoingStaleCronJob } from 'src/modules/messaging/message-import-manager/crons/jobs/messaging-ongoing-stale.cron.job';\n-import { MessagingProcessFolderActionsCronJob } from 'src/modules/messaging/message-import-manager/crons/jobs/messaging-process-folder-actions.cron.job';\n import { MessagingRelaunchFailedMessageChannelsCronJob } from 'src/modules/messaging/message-import-manager/crons/jobs/messaging-relaunch-failed-message-channels.cron.job';\n import { MessagingGmailDriverModule } from 'src/modules/messaging/message-import-manager/drivers/gmail/messaging-gmail-driver.module';\n import { MessagingIMAPDriverModule } from 'src/modules/messaging/message-import-manager/drivers/imap/messaging-imap-driver.module';\n@@ -34,7 +32,6 @@ import { MessagingCleanCacheJob } from 'src/modules/messaging/message-import-man\n import { MessagingMessageListFetchJob } from 'src/modules/messaging/message-import-manager/jobs/messaging-message-list-fetch.job';\n import { MessagingMessagesImportJob } from 'src/modules/messaging/message-import-manager/jobs/messaging-messages-import.job';\n import { MessagingOngoingStaleJob } from 'src/modules/messaging/message-import-manager/jobs/messaging-ongoing-stale.job';\n-import { MessagingProcessFolderActionsJob } from 'src/modules/messaging/message-import-manager/jobs/messaging-process-folder-actions.job';\n import { MessagingRelaunchFailedMessageChannelJob } from 'src/modules/messaging/message-import-manager/jobs/messaging-relaunch-failed-message-channel.job';\n import { MessagingMessageImportManagerMessageChannelListener } from 'src/modules/messaging/message-import-manager/listeners/messaging-import-manager-message-channel.listener';\n import { MessagingAccountAuthenticationService } from 'src/modules/messaging/message-import-manager/services/messaging-account-authentication.service';\n@@ -83,18 +80,15 @@ import { MessagingMonitoringModule } from 'src/modules/messaging/monitoring/mess\n     MessagingMessageListFetchCronCommand,\n     MessagingMessagesImportCronCommand,\n     MessagingOngoingStaleCronCommand,\n-    MessagingProcessFolderActionsCronCommand,\n     MessagingRelaunchFailedMessageChannelsCronCommand,\n     MessagingSingleMessageImportCommand,\n     MessagingMessageListFetchJob,\n     MessagingMessagesImportJob,\n     MessagingOngoingStaleJob,\n-    MessagingProcessFolderActionsJob,\n     MessagingRelaunchFailedMessageChannelJob,\n     MessagingMessageListFetchCronJob,\n     MessagingMessagesImportCronJob,\n     MessagingOngoingStaleCronJob,\n-    MessagingProcessFolderActionsCronJob,\n     MessagingRelaunchFailedMessageChannelsCronJob,\n     MessagingAddSingleMessageToCacheForImportJob,\n     MessagingMessageImportManagerMessageChannelListener,\ndiff --git a/packages/twenty-server/src/modules/messaging/message-import-manager/services/messaging-message-list-fetch.service.spec.ts b/packages/twenty-server/src/modules/messaging/message-import-manager/services/messaging-message-list-fetch.service.spec.ts\nindex 6c6c14a77f4c3..1f24fbd578465 100644\n--- a/packages/twenty-server/src/modules/messaging/message-import-manager/services/messaging-message-list-fetch.service.spec.ts\n+++ b/packages/twenty-server/src/modules/messaging/message-import-manager/services/messaging-message-list-fetch.service.spec.ts\n@@ -16,6 +16,7 @@ import { MessagingGetMessageListService } from 'src/modules/messaging/message-im\n import { MessageImportExceptionHandlerService } from 'src/modules/messaging/message-import-manager/services/messaging-import-exception-handler.service';\n import { MessagingMessageListFetchService } from 'src/modules/messaging/message-import-manager/services/messaging-message-list-fetch.service';\n import { MessagingMessagesImportService } from 'src/modules/messaging/message-import-manager/services/messaging-messages-import.service';\n+import { MessagingProcessFolderActionsService } from 'src/modules/messaging/message-import-manager/services/messaging-process-folder-actions.service';\n import { MessagingProcessGroupEmailActionsService } from 'src/modules/messaging/message-import-manager/services/messaging-process-group-email-actions.service';\n \n describe('MessagingMessageListFetchService', () => {\n@@ -78,15 +79,21 @@ describe('MessagingMessageListFetchService', () => {\n     };\n \n     const mockMessageFolderRepository = {\n-      find: jest.fn().mockResolvedValue([\n-        {\n-          id: 'inbox-folder-id',\n-          name: 'inbox',\n-          syncCursor: 'inbox-sync-cursor',\n-          messageChannelId: 'microsoft-message-channel-id',\n-          isSynced: true,\n-        },\n-      ]),\n+      find: jest.fn().mockImplementation(({ where }) => {\n+        if (where?.pendingSyncAction === 'FOLDER_DELETION') {\n+          return [];\n+        }\n+\n+        return [\n+          {\n+            id: 'inbox-folder-id',\n+            name: 'inbox',\n+            syncCursor: 'inbox-sync-cursor',\n+            messageChannelId: 'microsoft-message-channel-id',\n+            isSynced: true,\n+          },\n+        ];\n+      }),\n     };\n \n     const module: TestingModule = await Test.createTestingModule({\n@@ -238,6 +245,12 @@ describe('MessagingMessageListFetchService', () => {\n             processGroupEmailActions: jest.fn().mockResolvedValue(undefined),\n           },\n         },\n+        {\n+          provide: MessagingProcessFolderActionsService,\n+          useValue: {\n+            processFolderActions: jest.fn().mockResolvedValue(undefined),\n+          },\n+        },\n       ],\n     }).compile();\n \ndiff --git a/packages/twenty-server/src/modules/messaging/message-import-manager/services/messaging-message-list-fetch.service.ts b/packages/twenty-server/src/modules/messaging/message-import-manager/services/messaging-message-list-fetch.service.ts\nindex 067742bfe16b3..bdff77fb58bd0 100644\n--- a/packages/twenty-server/src/modules/messaging/message-import-manager/services/messaging-message-list-fetch.service.ts\n+++ b/packages/twenty-server/src/modules/messaging/message-import-manager/services/messaging-message-list-fetch.service.ts\n@@ -30,6 +30,7 @@ import {\n   MessageImportSyncStep,\n } from 'src/modules/messaging/message-import-manager/services/messaging-import-exception-handler.service';\n import { MessagingMessagesImportService } from 'src/modules/messaging/message-import-manager/services/messaging-messages-import.service';\n+import { MessagingProcessFolderActionsService } from 'src/modules/messaging/message-import-manager/services/messaging-process-folder-actions.service';\n import { MessagingProcessGroupEmailActionsService } from 'src/modules/messaging/message-import-manager/services/messaging-process-group-email-actions.service';\n \n const ONE_WEEK_IN_MILLISECONDS = 7 * 24 * 60 * 60 * 1000;\n@@ -50,6 +51,7 @@ export class MessagingMessageListFetchService {\n     private readonly messagingAccountAuthenticationService: MessagingAccountAuthenticationService,\n     private readonly syncMessageFoldersService: SyncMessageFoldersService,\n     private readonly messagingProcessGroupEmailActionsService: MessagingProcessGroupEmailActionsService,\n+    private readonly messagingProcessFolderActionsService: MessagingProcessFolderActionsService,\n   ) {}\n \n   public async processMessageListFetch(\n@@ -57,21 +59,17 @@ export class MessagingMessageListFetchService {\n     workspaceId: string,\n   ) {\n     try {\n-      if (\n-        messageChannel.pendingGroupEmailsAction ===\n-          MessageChannelPendingGroupEmailsAction.GROUP_EMAILS_DELETION ||\n-        messageChannel.pendingGroupEmailsAction ===\n-          MessageChannelPendingGroupEmailsAction.GROUP_EMAILS_IMPORT\n-      ) {\n-        this.logger.log(\n-          `messageChannelId: ${messageChannel.id} Processing pending group emails action before message list fetch: ${messageChannel.pendingGroupEmailsAction}`,\n-        );\n+      const pendingGroupEmailActionsProcessed =\n+        await this.processPendingGroupEmailActions(messageChannel, workspaceId);\n \n-        await this.messagingProcessGroupEmailActionsService.processGroupEmailActions(\n-          messageChannel,\n-          workspaceId,\n-        );\n+      if (pendingGroupEmailActionsProcessed) {\n+        return;\n+      }\n+\n+      const pendingFolderActionsProcessed =\n+        await this.processPendingFolderActions(messageChannel, workspaceId);\n \n+      if (pendingFolderActionsProcessed) {\n         return;\n       }\n \n@@ -288,6 +286,65 @@ export class MessagingMessageListFetchService {\n     }\n   }\n \n+  private async processPendingGroupEmailActions(\n+    messageChannel: MessageChannelWorkspaceEntity,\n+    workspaceId: string,\n+  ): Promise<boolean> {\n+    const hasPendingGroupEmailAction =\n+      messageChannel.pendingGroupEmailsAction ===\n+        MessageChannelPendingGroupEmailsAction.GROUP_EMAILS_DELETION ||\n+      messageChannel.pendingGroupEmailsAction ===\n+        MessageChannelPendingGroupEmailsAction.GROUP_EMAILS_IMPORT;\n+\n+    if (!hasPendingGroupEmailAction) {\n+      return false;\n+    }\n+\n+    this.logger.log(\n+      `messageChannelId: ${messageChannel.id} Processing pending group emails action before message list fetch: ${messageChannel.pendingGroupEmailsAction}`,\n+    );\n+\n+    await this.messagingProcessGroupEmailActionsService.processGroupEmailActions(\n+      messageChannel,\n+      workspaceId,\n+    );\n+\n+    return true;\n+  }\n+\n+  private async processPendingFolderActions(\n+    messageChannel: MessageChannelWorkspaceEntity,\n+    workspaceId: string,\n+  ): Promise<boolean> {\n+    const messageFolderRepository =\n+      await this.twentyORMManager.getRepository<MessageFolderWorkspaceEntity>(\n+        'messageFolder',\n+      );\n+\n+    const foldersWithPendingActions = await messageFolderRepository.find({\n+      where: {\n+        messageChannelId: messageChannel.id,\n+        pendingSyncAction: MessageFolderPendingSyncAction.FOLDER_DELETION,\n+      },\n+    });\n+\n+    if (foldersWithPendingActions.length === 0) {\n+      return false;\n+    }\n+\n+    this.logger.log(\n+      `messageChannelId: ${messageChannel.id} Processing pending folder actions before message list fetch`,\n+    );\n+\n+    await this.messagingProcessFolderActionsService.processFolderActions(\n+      messageChannel,\n+      foldersWithPendingActions,\n+      workspaceId,\n+    );\n+\n+    return true;\n+  }\n+\n   private async computeFullSyncMessageChannelMessageAssociationsToDelete(\n     messageChannel: Pick<MessageChannelWorkspaceEntity, 'id'>,\n     messageExternalIds: string[],\n"}
{"instance_id": "twentyhq__twenty.main.16057", "repo": "twentyhq/twenty", "base_commit": "6d141c2439cda36f09142506cac207b2b10aa72c", "head_commit": "770301118903345e3af6af078e655589a21140ca", "title": "[fix] User have no firstName nor lastName", "merged_at": "2025-11-25T17:23:44Z", "html_url": "https://github.com/twentyhq/twenty/pull/16057", "test_files": ["packages/twenty-server/src/engine/core-modules/actor/services/__tests__/created-by-from-auth-context.service.spec.ts", "packages/twenty-server/src/engine/core-modules/user-workspace/user-workspace.service.spec.ts"], "code_files": ["packages/twenty-front/src/modules/auth/sign-in-up/hooks/useSignInUpForm.ts", "packages/twenty-server/src/engine/core-modules/actor/services/created-by-from-auth-context.service.ts", "packages/twenty-server/src/engine/core-modules/user-workspace/user-workspace.module.ts", "packages/twenty-server/src/engine/core-modules/user-workspace/user-workspace.service.ts", "packages/twenty-server/src/modules/workspace-member/query-hooks/workspace-member-query-hook.module.ts"], "total_changes": 70, "num_files": 7, "pull_number": 16057, "patch": "diff --git a/packages/twenty-front/src/modules/auth/sign-in-up/hooks/useSignInUpForm.ts b/packages/twenty-front/src/modules/auth/sign-in-up/hooks/useSignInUpForm.ts\nindex cf71ceee0c2e8..b0c2b5d20f36f 100644\n--- a/packages/twenty-front/src/modules/auth/sign-in-up/hooks/useSignInUpForm.ts\n+++ b/packages/twenty-front/src/modules/auth/sign-in-up/hooks/useSignInUpForm.ts\n@@ -64,5 +64,5 @@ export const useSignInUpForm = () => {\n       form.setValue('password', 'tim@apple.dev');\n     }\n   }, [form, isDeveloperDefaultSignInPrefilled, prefilledEmail]);\n-  return { form: form };\n+  return { form };\n };\ndiff --git a/packages/twenty-server/src/engine/core-modules/actor/services/__tests__/created-by-from-auth-context.service.spec.ts b/packages/twenty-server/src/engine/core-modules/actor/services/__tests__/created-by-from-auth-context.service.spec.ts\nindex 16dfa9a136df9..b532f78729a73 100644\n--- a/packages/twenty-server/src/engine/core-modules/actor/services/__tests__/created-by-from-auth-context.service.spec.ts\n+++ b/packages/twenty-server/src/engine/core-modules/actor/services/__tests__/created-by-from-auth-context.service.spec.ts\n@@ -106,13 +106,25 @@ describe('CreatedByFromAuthContextService', () => {\n       const authContext = {\n         workspaceMemberId: '20202020-0b5c-4178-bed7-d371f6411eaa',\n         user: {\n-          firstName: 'John',\n-          lastName: 'Doe',\n+          firstName: '',\n+          lastName: '',\n           id: '20202020-9aae-49a8-bafc-ac44bae62d6d',\n         },\n         workspace: { id: '20202020-bdec-497f-847a-1bb334fefe58' },\n       } as const satisfies TestingAuthContext;\n \n+      const mockedWorkspaceMember = {\n+        id: '20202020-0b5c-4178-bed7-d371f6411eaa',\n+        name: {\n+          firstName: 'John',\n+          lastName: 'Doe',\n+        },\n+      } as const satisfies Partial<WorkspaceMemberWorkspaceEntity>;\n+\n+      mockWorkspaceMemberRepository.findOneOrFail.mockResolvedValueOnce(\n+        mockedWorkspaceMember,\n+      );\n+\n       const result = await service.injectCreatedBy(\n         [{}],\n         'person',\n@@ -123,7 +135,7 @@ describe('CreatedByFromAuthContextService', () => {\n         {\n           createdBy: {\n             context: {},\n-            name: fromFullNameMetadataToName(authContext.user),\n+            name: fromFullNameMetadataToName(mockedWorkspaceMember.name),\n             workspaceMemberId: authContext.workspaceMemberId,\n             source: FieldActorSource.MANUAL,\n           },\ndiff --git a/packages/twenty-server/src/engine/core-modules/actor/services/created-by-from-auth-context.service.ts b/packages/twenty-server/src/engine/core-modules/actor/services/created-by-from-auth-context.service.ts\nindex e7e23715fced5..5da432f910bd6 100644\n--- a/packages/twenty-server/src/engine/core-modules/actor/services/created-by-from-auth-context.service.ts\n+++ b/packages/twenty-server/src/engine/core-modules/actor/services/created-by-from-auth-context.service.ts\n@@ -102,24 +102,11 @@ export class CreatedByFromAuthContextService {\n   private async buildCreatedBy(\n     authContext: AuthContext,\n   ): Promise<ActorMetadata> {\n-    const { workspace, workspaceMemberId, user, apiKey } = authContext;\n+    const { workspace, user, apiKey } = authContext;\n \n     assertIsDefinedOrThrow(workspace, WorkspaceNotFoundDefaultError);\n \n-    // TODO: remove that code once we have the workspace member id in all tokens\n-    if (isDefined(workspaceMemberId) && isDefined(user)) {\n-      return buildCreatedByFromFullNameMetadata({\n-        fullNameMetadata: {\n-          firstName: user.firstName,\n-          lastName: user.lastName,\n-        },\n-        workspaceMemberId,\n-      });\n-    }\n-\n     if (isDefined(user)) {\n-      this.logger.warn(\"User doesn't have a workspace member id in the token\");\n-\n       const workspaceMemberRepository =\n         await this.twentyORMGlobalManager.getRepositoryForWorkspace<WorkspaceMemberWorkspaceEntity>(\n           workspace.id,\ndiff --git a/packages/twenty-server/src/engine/core-modules/user-workspace/user-workspace.module.ts b/packages/twenty-server/src/engine/core-modules/user-workspace/user-workspace.module.ts\nindex dc137c3dc6f88..47aecbc2266d3 100644\n--- a/packages/twenty-server/src/engine/core-modules/user-workspace/user-workspace.module.ts\n+++ b/packages/twenty-server/src/engine/core-modules/user-workspace/user-workspace.module.ts\n@@ -9,6 +9,7 @@ import { TokenModule } from 'src/engine/core-modules/auth/token/token.module';\n import { WorkspaceDomainsModule } from 'src/engine/core-modules/domain/workspace-domains/workspace-domains.module';\n import { FileUploadModule } from 'src/engine/core-modules/file/file-upload/file-upload.module';\n import { FileModule } from 'src/engine/core-modules/file/file.module';\n+import { OnboardingModule } from 'src/engine/core-modules/onboarding/onboarding.module';\n import { UserWorkspaceEntity } from 'src/engine/core-modules/user-workspace/user-workspace.entity';\n import { UserWorkspaceService } from 'src/engine/core-modules/user-workspace/user-workspace.service';\n import { UserEntity } from 'src/engine/core-modules/user/user.entity';\n@@ -43,6 +44,7 @@ import { WorkspaceDataSourceModule } from 'src/engine/workspace-datasource/works\n         FileUploadModule,\n         FileModule,\n         TokenModule,\n+        OnboardingModule,\n       ],\n       services: [UserWorkspaceService],\n     }),\ndiff --git a/packages/twenty-server/src/engine/core-modules/user-workspace/user-workspace.service.spec.ts b/packages/twenty-server/src/engine/core-modules/user-workspace/user-workspace.service.spec.ts\nindex 8f58d09b8a5ef..b42450254b796 100644\n--- a/packages/twenty-server/src/engine/core-modules/user-workspace/user-workspace.service.spec.ts\n+++ b/packages/twenty-server/src/engine/core-modules/user-workspace/user-workspace.service.spec.ts\n@@ -16,6 +16,7 @@ import {\n   type SignedFilesResult,\n } from 'src/engine/core-modules/file/file-upload/services/file-upload.service';\n import { FileService } from 'src/engine/core-modules/file/services/file.service';\n+import { OnboardingService } from 'src/engine/core-modules/onboarding/onboarding.service';\n import { UserWorkspaceEntity } from 'src/engine/core-modules/user-workspace/user-workspace.entity';\n import { UserWorkspaceService } from 'src/engine/core-modules/user-workspace/user-workspace.service';\n import { UserEntity } from 'src/engine/core-modules/user/user.entity';\n@@ -38,6 +39,7 @@ describe('UserWorkspaceService', () => {\n   let userRoleService: UserRoleService;\n   let fileService: FileService;\n   let fileUploadService: FileUploadService;\n+  let onboardingService: OnboardingService;\n \n   beforeEach(async () => {\n     const module: TestingModule = await Test.createTestingModule({\n@@ -133,6 +135,12 @@ describe('UserWorkspaceService', () => {\n             copyFileFromWorkspaceToWorkspace: jest.fn(),\n           },\n         },\n+        {\n+          provide: OnboardingService,\n+          useValue: {\n+            setOnboardingCreateProfilePending: jest.fn(),\n+          },\n+        },\n       ],\n     }).compile();\n \n@@ -153,6 +161,7 @@ describe('UserWorkspaceService', () => {\n     );\n     userRoleService = module.get<UserRoleService>(UserRoleService);\n     fileUploadService = module.get<FileUploadService>(FileUploadService);\n+    onboardingService = module.get<OnboardingService>(OnboardingService);\n   });\n \n   it('should be defined', () => {\n@@ -444,6 +453,17 @@ describe('UserWorkspaceService', () => {\n       expect(\n         workspaceInvitationService.invalidateWorkspaceInvitation,\n       ).toHaveBeenCalledWith(workspace.id, user.email, undefined);\n+\n+      expect(\n+        onboardingService.setOnboardingCreateProfilePending,\n+      ).toHaveBeenCalledWith(\n+        {\n+          userId: user.id,\n+          workspaceId: workspace.id,\n+          value: true,\n+        },\n+        undefined,\n+      );\n     });\n \n     it('should not add user to workspace if already in workspace', async () => {\ndiff --git a/packages/twenty-server/src/engine/core-modules/user-workspace/user-workspace.service.ts b/packages/twenty-server/src/engine/core-modules/user-workspace/user-workspace.service.ts\nindex 6e1dabc845e15..f23b8320cfeae 100644\n--- a/packages/twenty-server/src/engine/core-modules/user-workspace/user-workspace.service.ts\n+++ b/packages/twenty-server/src/engine/core-modules/user-workspace/user-workspace.service.ts\n@@ -19,6 +19,7 @@ import { LoginTokenService } from 'src/engine/core-modules/auth/token/services/l\n import { WorkspaceDomainsService } from 'src/engine/core-modules/domain/workspace-domains/services/workspace-domains.service';\n import { FileUploadService } from 'src/engine/core-modules/file/file-upload/services/file-upload.service';\n import { FileService } from 'src/engine/core-modules/file/services/file.service';\n+import { OnboardingService } from 'src/engine/core-modules/onboarding/onboarding.service';\n import { UserWorkspaceEntity } from 'src/engine/core-modules/user-workspace/user-workspace.entity';\n import { UserEntity } from 'src/engine/core-modules/user/user.entity';\n import { WorkspaceInvitationService } from 'src/engine/core-modules/workspace-invitation/services/workspace-invitation.service';\n@@ -53,6 +54,7 @@ export class UserWorkspaceService extends TypeOrmQueryService<UserWorkspaceEntit\n     private readonly userRoleService: UserRoleService,\n     private readonly fileUploadService: FileUploadService,\n     private readonly fileService: FileService,\n+    private readonly onboardingService: OnboardingService,\n   ) {\n     super(userWorkspaceRepository);\n   }\n@@ -173,6 +175,15 @@ export class UserWorkspaceService extends TypeOrmQueryService<UserWorkspaceEntit\n         user.email,\n         queryRunner,\n       );\n+\n+      await this.onboardingService.setOnboardingCreateProfilePending(\n+        {\n+          userId: user.id,\n+          workspaceId: workspace.id,\n+          value: true,\n+        },\n+        queryRunner,\n+      );\n     }\n   }\n \ndiff --git a/packages/twenty-server/src/modules/workspace-member/query-hooks/workspace-member-query-hook.module.ts b/packages/twenty-server/src/modules/workspace-member/query-hooks/workspace-member-query-hook.module.ts\nindex 0063b2000773d..97260aedca557 100644\n--- a/packages/twenty-server/src/modules/workspace-member/query-hooks/workspace-member-query-hook.module.ts\n+++ b/packages/twenty-server/src/modules/workspace-member/query-hooks/workspace-member-query-hook.module.ts\n@@ -4,6 +4,7 @@ import { TypeOrmModule } from '@nestjs/typeorm';\n import { FeatureFlagModule } from 'src/engine/core-modules/feature-flag/feature-flag.module';\n import { UserWorkspaceEntity } from 'src/engine/core-modules/user-workspace/user-workspace.entity';\n import { UserWorkspaceModule } from 'src/engine/core-modules/user-workspace/user-workspace.module';\n+import { UserModule } from 'src/engine/core-modules/user/user.module';\n import { PermissionsModule } from 'src/engine/metadata-modules/permissions/permissions.module';\n import { WorkspaceMemberCreateManyPreQueryHook } from 'src/modules/workspace-member/query-hooks/workspace-member-create-many.pre-query.hook';\n import { WorkspaceMemberCreateOnePreQueryHook } from 'src/modules/workspace-member/query-hooks/workspace-member-create-one.pre-query.hook';\n@@ -38,6 +39,7 @@ import { WorkspaceMemberUpdateOnePreQueryHook } from 'src/modules/workspace-memb\n     PermissionsModule,\n     UserWorkspaceModule,\n     TypeOrmModule.forFeature([UserWorkspaceEntity]),\n+    UserModule,\n   ],\n })\n export class WorkspaceMemberQueryHookModule {}\n"}
