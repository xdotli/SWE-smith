{"instance_id": "keystonejs__keystone-9737", "repo": "keystonejs/keystone", "pull_number": 9737, "base_commit": "052f5b1bfdc76868125722ea385c59ffae7eb000", "patch": "diff --git a/packages/core/src/fields/types/relationship/views/useApolloQuery.ts b/packages/core/src/fields/types/relationship/views/useApolloQuery.ts\nindex 703278638b7..5cf30b1c193 100644\n--- a/packages/core/src/fields/types/relationship/views/useApolloQuery.ts\n+++ b/packages/core/src/fields/types/relationship/views/useApolloQuery.ts\n@@ -1,4 +1,5 @@\n import { useEffect, useMemo, useState } from 'react'\n+import isDeepEqual from 'fast-deep-equal'\n \n import type { ListMeta, ListSortDescriptor } from '../../../../types'\n import {\n@@ -63,14 +64,11 @@ export function useApolloQuery(args: {\n   const manipulatedSearch =\n     state.kind === 'one' && state.value?.label === debouncedSearch ? '' : debouncedSearch\n \n-  // TODO: rewrite\n+  const searchFilter = useSearchFilter(manipulatedSearch, list, searchFields)\n   const _where = {\n-    OR: useSearchFilter(manipulatedSearch, list, searchFields),\n+    OR: searchFilter,\n   }\n-  // memo is used for referential stability, not for performance\n-  const where = useMemo(() => {\n-    return args.filter ? { AND: [_where, args.filter] } : _where\n-  }, [args.filter, _where])\n+  const where = args.filter ? { AND: [_where, args.filter] } : _where\n \n   const orderBy = useMemo(() => {\n     return args.sort ? { [args.sort.field]: args.sort.direction.toLowerCase() } : undefined\n@@ -129,7 +127,7 @@ export function useApolloQuery(args: {\n       !loading &&\n       skip &&\n       data.items.length < count &&\n-      (lastFetchMore?.where !== where ||\n+      (!isDeepEqual(lastFetchMore?.where, where) ||\n         lastFetchMore?.list !== list ||\n         lastFetchMore?.skip !== skip)\n     ) {\ndiff --git a/tests/admin-ui-tests/relations.test.ts b/tests/admin-ui-tests/relations.test.ts\nindex 39a28039176..3a3690868ff 100644\n--- a/tests/admin-ui-tests/relations.test.ts\n+++ b/tests/admin-ui-tests/relations.test.ts\n@@ -1,6 +1,6 @@\n import type { Browser, Page } from 'playwright'\n import { expect } from 'playwright/test'\n-import { adminUITests } from './utils'\n+import { adminUITests, callGraphQL } from './utils'\n \n const gql = ([str]: TemplateStringsArray) => str\n \n@@ -79,6 +79,32 @@ adminUITests('./tests/test-projects/basic', browserType => {\n     await expect(page.getByText('A task')).toBeHidden()\n   })\n \n+  test(\"the combobox having to paginate doesn't break the page\", async () => {\n+    await callGraphQL(\n+      gql`\n+        mutation ($data: [PersonCreateInput!]!) {\n+          createPeople(data: $data) {\n+            id\n+          }\n+        }\n+      `,\n+      {\n+        data: [\n+          { name: 'User to pick' },\n+          ...Array.from({ length: 100 }, (_, i) => ({ name: `User ${i}` })),\n+        ],\n+      }\n+    )\n+\n+    await page.goto(`http://localhost:3000/tasks/create`)\n+    await page.getByRole('textbox', { name: 'Label' }).fill('some task')\n+    await page.getByRole('combobox', { name: 'Assigned To' }).click()\n+    await page.getByRole('button', { name: 'Show suggestions Assigned To' }).click()\n+    await page.getByText('User to pick').click()\n+    await page.getByRole('button', { name: 'Create' }).click()\n+    await expect(page.getByText('Task created')).toBeVisible()\n+  })\n+\n   afterAll(async () => {\n     await browser.close()\n   })\ndiff --git a/tests/admin-ui-tests/utils.ts b/tests/admin-ui-tests/utils.ts\nindex 2695dc6733b..d74d8c7dd37 100644\n--- a/tests/admin-ui-tests/utils.ts\n+++ b/tests/admin-ui-tests/utils.ts\n@@ -161,3 +161,17 @@ export async function spawnCommand3(cwd: string, commands: string[], waitOn: str\n     exited: exitPromise,\n   }\n }\n+\n+// TODO: use elsewhere in tests\n+export async function callGraphQL(query: string, variables?: Record<string, any>) {\n+  const result = await fetch('http://localhost:3000/api/graphql', {\n+    method: 'POST',\n+    headers: { 'Content-Type': 'application/json' },\n+    body: JSON.stringify({\n+      query,\n+      variables,\n+    }),\n+  }).then(res => res.json())\n+  expect(result.errors).toBeUndefined()\n+  return result.data\n+}\n", "test_patch": "", "problem_statement": "", "hints_text": "", "created_at": "2025-11-24T01:07:49Z", "issue_numbers": []}
{"instance_id": "keystonejs__keystone-9730", "repo": "keystonejs/keystone", "pull_number": 9730, "base_commit": "052f5b1bfdc76868125722ea385c59ffae7eb000", "patch": "diff --git a/examples/actions/schema.ts b/examples/actions/schema.ts\nindex 33263c0cac0..e0b9b2274f9 100644\n--- a/examples/actions/schema.ts\n+++ b/examples/actions/schema.ts\n@@ -14,7 +14,18 @@ export const lists = {\n     fields: {\n       title: text(),\n       content: text(),\n-      hidden: checkbox(),\n+      hidden: checkbox({\n+        ui: {\n+          itemView: {\n+            fieldMode: ({ item, itemField }) => {\n+              // WARNING: none of this is access control\n+              if (!item || item.votes === null) return 'edit'\n+              if (itemField) return 'edit'\n+              return item.votes > 0 ? 'read' : 'edit'\n+            },\n+          },\n+        },\n+      }),\n       votes: integer({ defaultValue: 0 }),\n       reportedAt: timestamp({\n         ui: {\ndiff --git a/packages/core/src/fields/types/checkbox/views/index.tsx b/packages/core/src/fields/types/checkbox/views/index.tsx\nindex ded256df246..7ccf76fba7a 100644\n--- a/packages/core/src/fields/types/checkbox/views/index.tsx\n+++ b/packages/core/src/fields/types/checkbox/views/index.tsx\n@@ -3,6 +3,7 @@ import { Icon } from '@keystar/ui/icon'\n import { checkIcon } from '@keystar/ui/icon/icons/checkIcon'\n import { Text, VisuallyHidden } from '@keystar/ui/typography'\n \n+import { entriesTyped } from '../../../../lib/core/utils'\n import type {\n   CellComponent,\n   FieldController,\n@@ -10,7 +11,6 @@ import type {\n   FieldProps,\n   SimpleFieldTypeInfo,\n } from '../../../../types'\n-import { entriesTyped } from '../../../../lib/core/utils'\n \n export function Field({ field, value, onChange, autoFocus }: FieldProps<typeof controller>) {\n   return (\ndiff --git a/packages/core/src/lib/admin-meta-graphql.ts b/packages/core/src/lib/admin-meta-graphql.ts\nindex b33c7a13bc3..db48a73ad11 100644\n--- a/packages/core/src/lib/admin-meta-graphql.ts\n+++ b/packages/core/src/lib/admin-meta-graphql.ts\n@@ -86,7 +86,7 @@ const KeystoneAdminUIFieldMeta = g.object<FieldMetaSource>()({\n           }),\n           isRequired: g.field({\n             type: g.nonNull(g.JSON),\n-            resolve({ item, fieldKey, itemView, itemField, listKey }, _, context) {\n+            resolve({ listKey, fieldKey, itemView, item, itemField }, _, context) {\n               const { isRequired } = itemView\n               if (typeof isRequired !== 'function') return isRequired\n               return isRequired({\n@@ -316,7 +316,12 @@ const KeystoneAdminUIListMeta = g.object<ListMetaSource>()({\n     path: g.field({ type: g.nonNull(g.String) }),\n \n     labelField: g.field({ type: g.nonNull(g.String) }),\n-    fields: g.field({ type: g.nonNull(g.list(g.nonNull(KeystoneAdminUIFieldMeta))) }),\n+    fields: g.field({\n+      resolve: ({ fields, item }) => {\n+        return fields.map(f => ({ ...f, item, itemField: item?.[f.key] ?? null }))\n+      },\n+      type: g.nonNull(g.list(g.nonNull(KeystoneAdminUIFieldMeta))),\n+    }),\n     groups: g.field({ type: g.nonNull(g.list(g.nonNull(KeystoneAdminUIFieldGroupMeta))) }),\n     actions: g.field({ type: g.nonNull(g.list(g.nonNull(KeystoneAdminUIActionMeta))) }),\n     graphql: g.field({ type: g.nonNull(KeystoneAdminUIGraphQL) }),\n@@ -352,8 +357,14 @@ const adminMeta = g.object<AdminMetaSource>()({\n             item: null,\n           }\n         }\n+        // WARNING: do not use sudo\n         const item = await context.db[key].findOne({ where: { id: itemId } })\n-        if (!item) return null\n+        if (!item) {\n+          return {\n+            ...source.listsByKey[key],\n+            item: null,\n+          }\n+        }\n         return {\n           ...source.listsByKey[key],\n           item,\ndiff --git a/tests2/omit.test.ts b/tests2/omit.test.ts\nindex 26b624b9dcc..99e9ed362b0 100644\n--- a/tests2/omit.test.ts\n+++ b/tests2/omit.test.ts\n@@ -73,13 +73,13 @@ const fieldsMatrix = [\n \n function makeList({\n   fields,\n-  isFilterable,\n-  isOrderable,\n+  defaultIsFilterable,\n+  defaultIsOrderable,\n   omit,\n }: {\n   fields: typeof fieldsMatrix\n-  isFilterable: boolean\n-  isOrderable: boolean\n+  defaultIsFilterable: boolean\n+  defaultIsOrderable: boolean\n   omit:\n     | boolean\n     | {\n@@ -89,21 +89,22 @@ function makeList({\n         delete: boolean\n       }\n }) {\n-  const prefix = `List${fields.length}_Filt${yn(isFilterable)}_Ord${yn(isOrderable)}` as const\n-  const __name = `${prefix}_Omit${\n+  const prefix =\n+    `List${fields.length}_Filt${yn(defaultIsFilterable)}_Ord${yn(defaultIsOrderable)}` as const\n+  const name__ = `${prefix}_Omit${\n     typeof omit !== 'object'\n       ? yn(omit)\n       : [omit.query, omit.create, omit.update, omit.delete].map(yn).join('')\n   }`\n \n   return {\n-    __name,\n+    name__,\n     access: allowAll,\n     fields: Object.fromEntries(fields),\n-    defaultIsFilterable: isFilterable,\n-    defaultIsOrderable: isOrderable,\n+    defaultIsFilterable,\n+    defaultIsOrderable,\n     graphql: {\n-      plural: __name + 's',\n+      plural: name__ + 's',\n       omit,\n     },\n   } as const\n@@ -111,10 +112,15 @@ function makeList({\n \n const listsMatrix = [\n   ...(function* () {\n-    for (const isFilterable of [false, true]) {\n-      for (const isOrderable of [false, true]) {\n+    for (const defaultIsFilterable of [false, true]) {\n+      for (const defaultIsOrderable of [false, true]) {\n         for (const omit of [false, true]) {\n-          yield makeList({ fields: fieldsMatrix, isFilterable, isOrderable, omit })\n+          yield makeList({\n+            fields: fieldsMatrix,\n+            defaultIsFilterable,\n+            defaultIsOrderable,\n+            omit,\n+          })\n         }\n \n         for (const query of [false, true]) {\n@@ -123,8 +129,8 @@ const listsMatrix = [\n               for (const delete_ of [false, true]) {\n                 yield makeList({\n                   fields: fieldsMatrix,\n-                  isFilterable,\n-                  isOrderable,\n+                  defaultIsFilterable,\n+                  defaultIsOrderable,\n                   omit: {\n                     query,\n                     create,\n@@ -135,8 +141,8 @@ const listsMatrix = [\n \n                 yield makeList({\n                   fields: [],\n-                  isFilterable,\n-                  isOrderable,\n+                  defaultIsFilterable,\n+                  defaultIsOrderable,\n                   omit: {\n                     query,\n                     create,\n@@ -156,24 +162,24 @@ const listsMatrix = [\n // TODO: FIXME: skip for now, MySQL has a limit on the number of indexes\n if (dbProvider !== 'mysql') {\n   listsMatrix.push({\n-    __name: 'RelatedToAll',\n+    name__: 'RelatedToAll',\n     access: allowAll,\n     fields: Object.fromEntries(\n       (function* () {\n         for (const l of listsMatrix) {\n           // WARNING: if names exceed some length, expect duplicate _AB_unique index errors\n           yield [\n-            `R${l.__name}_one`,\n+            `R${l.name__}_one`,\n             relationship({\n-              ref: l.__name,\n+              ref: l.name__,\n               many: false,\n             }),\n           ] as const\n \n           yield [\n-            `R${l.__name}_many`,\n+            `R${l.name__}_many`,\n             relationship({\n-              ref: l.__name,\n+              ref: l.name__,\n               many: true,\n             }),\n           ] as const\n@@ -334,7 +340,7 @@ describe(`Omit (${dbProvider})`, () => {\n \n   const suite = setupTestSuite({\n     config: {\n-      lists: Object.fromEntries(listsMatrix.map(({ __name, ...l }) => [__name, list(l)])),\n+      lists: Object.fromEntries(listsMatrix.map(({ name__: __name, ...l }) => [__name, list(l)])),\n     },\n   })\n \n@@ -342,7 +348,7 @@ describe(`Omit (${dbProvider})`, () => {\n   const sudoData = suite().then(async ({ context }) => await introspectSchema(context.sudo()))\n \n   for (const l of listsMatrix) {\n-    const listName = l.__name\n+    const listName = l.name__\n     const omit = l.graphql.omit\n \n     // common context is configurable\n", "test_patch": "", "problem_statement": "", "hints_text": "", "created_at": "2025-11-12T06:52:26Z", "issue_numbers": []}
{"instance_id": "keystonejs__keystone-9700", "repo": "keystonejs/keystone", "pull_number": 9700, "base_commit": "052f5b1bfdc76868125722ea385c59ffae7eb000", "patch": "diff --git a/examples/logging-opentelemetry/keystone.ts b/examples/logging-opentelemetry/keystone.ts\nindex 85d39a644a0..44155838a5b 100644\n--- a/examples/logging-opentelemetry/keystone.ts\n+++ b/examples/logging-opentelemetry/keystone.ts\n@@ -28,10 +28,13 @@ export default config<TypeInfo>({\n \n             return {\n               async willSendResponse({ operation, request }) {\n-                span.setAttribute('type', operation?.operation || 'unknown')\n-                span.setAttribute('name', request.operationName || 'unknown')\n-                span.setAttribute('hash', request.query ? sha256(request.query) : 'empty')\n-                // span.setAttribute('query', request.query?.replaceAll(/\\s+/g, ' ') || '') // WARNING: verbose\n+                span.setAttribute('graphql.operation.name', operation?.operation || 'unknown')\n+                span.setAttribute('graphql.operation.type', request.operationName || 'unknown')\n+                span.setAttribute(\n+                  'graphql.document.sha256',\n+                  request.query ? sha256(request.query) : 'empty'\n+                )\n+                // span.setAttribute('graphql.document', request.query?.replaceAll(/\\s+/g, ' ') || '') // WARNING: verbose\n                 span.end()\n               },\n             }\n@@ -47,9 +50,9 @@ export default config<TypeInfo>({\n           'http request',\n           {\n             attributes: {\n-              method: req.method,\n-              path: req.path,\n-              userAgent: req.headers['user-agent'] || '',\n+              'http.request.method': req.method,\n+              'http.request.path': req.path,\n+              'user_agent.original': req.headers['user-agent'] || '',\n             },\n           },\n           span => {\ndiff --git a/packages/core/src/lib/core/mutations/index.ts b/packages/core/src/lib/core/mutations/index.ts\nindex 8dcd01f71b3..1488c5a2e18 100644\n--- a/packages/core/src/lib/core/mutations/index.ts\n+++ b/packages/core/src/lib/core/mutations/index.ts\n@@ -79,7 +79,7 @@ async function createSingle__(\n ) {\n   return await withSpan(\n     `create ${list.graphql.names.outputTypeNameLower}`,\n-    async () => {\n+    async span => {\n       // throw an accessDeniedError if not allowed\n       await enforceListLevelAccessControl(context, 'create', list, inputData, undefined)\n       await enforceFieldLevelAccessControl(context, 'create', list, inputData, undefined)\n@@ -94,13 +94,17 @@ async function createSingle__(\n       await beforeOperation()\n \n       // operation\n-      const item = await context.prisma[list.listKey].create({\n+      const result = await context.prisma[list.listKey].create({\n         data: list.isSingleton ? { ...data, id: 1 } : data,\n       })\n \n-      return { item, afterOperation }\n+      span.setAttribute('keystone.result.id', result?.id ?? '')\n+      return { item: result, afterOperation }\n     },\n-    { 'keystone.list': list.listKey, 'keystone.operation': 'create' }\n+    {\n+      'keystone.list': list.listKey,\n+      'keystone.operation': 'create',\n+    }\n   )\n }\n \n@@ -143,7 +147,7 @@ async function updateSingle__(\n ) {\n   return await withSpan(\n     `update ${list.graphql.names.outputTypeNameLower}`,\n-    async () => {\n+    async span => {\n       // validate and resolve the input filter\n       const uniqueWhere = await resolveUniqueWhereInput(where, list, context)\n \n@@ -164,15 +168,16 @@ async function updateSingle__(\n       await beforeOperation()\n \n       // operation\n-      const updatedItem = await context.prisma[list.listKey].update({\n+      const result = await context.prisma[list.listKey].update({\n         where: { id: item.id },\n         data,\n       })\n+      span.setAttribute('keystone.result.id', result?.id ?? '')\n \n       // after operation\n-      await afterOperation(updatedItem)\n+      await afterOperation(result)\n \n-      return updatedItem\n+      return result\n     },\n     { 'keystone.list': list.listKey, 'keystone.operation': 'update' }\n   )\n@@ -186,7 +191,7 @@ async function deleteSingle__(\n ) {\n   return await withSpan(\n     `delete ${list.graphql.names.outputTypeNameLower}`,\n-    async () => {\n+    async span => {\n       // validate and resolve the input filter\n       const uniqueWhere = await resolveUniqueWhereInput(where, list, context)\n \n@@ -214,6 +219,7 @@ async function deleteSingle__(\n \n       // operation\n       const result = await context.prisma[list.listKey].delete({ where: { id: item.id } })\n+      span.setAttribute('keystone.result.id', result?.id ?? '')\n \n       // after operation\n       await runSideEffectOnlyHook(list, 'afterOperation', {\n@@ -236,7 +242,7 @@ async function actionSingle__(\n ) {\n   return await withSpan(\n     action.otel,\n-    async () => {\n+    async span => {\n       // no before operation hook for actions\n \n       // operation\n@@ -248,6 +254,7 @@ async function actionSingle__(\n         },\n         context\n       )\n+      span.setAttribute('keystone.result.id', (result?.id as string) ?? '')\n \n       // no after operation hook for actions\n       return result\ndiff --git a/packages/core/src/lib/utils.ts b/packages/core/src/lib/utils.ts\nindex 28e0d9eb4fb..c28c531e072 100644\n--- a/packages/core/src/lib/utils.ts\n+++ b/packages/core/src/lib/utils.ts\n@@ -1,13 +1,20 @@\n-/**\n- * Turns a passed in string into a human readable label\n- * @param {String} str The string to convert.\n- * @returns The new string\n- */\n-export function humanize(str: string, capitalize: boolean = true) {\n-  str = str.replace(/[^a-zA-Z0-9]+/g, ' ').replace(/([a-z0-9])([A-Z]+)/g, '$1 $2')\n+// WARNING: this is an opinionated subject, with too many ways to do this\n+//   we went with a subset that we are happy with\n+//   see tests2/utils.test.ts for examples\n+export function humanize(s: string, capitalize: boolean = true) {\n+  // drop non-alphanumeric\n+  s = s.replace(/[^a-zA-Z0-9]+/g, ' ')\n \n-  if (!capitalize) return str\n-  return str\n+  // insert spaces before camels of length > 1\n+  for (let i = 0; i < 24; i++) {\n+    // not unbounded, shouldnt happen\n+    const next = s.replace(/([a-z0-9])([A-Z][A-Za-z0-9])/, '$1 $2')\n+    if (next === s) break\n+    s = next\n+  }\n+\n+  if (!capitalize) return s\n+  return s\n     .split(' ')\n     .map(x => x.charAt(0).toUpperCase() + x.slice(1))\n     .join(' ')\ndiff --git a/tests2/utils.test.ts b/tests2/utils.test.ts\nindex 33bb2a19612..00ab8adc71e 100644\n--- a/tests2/utils.test.ts\n+++ b/tests2/utils.test.ts\n@@ -11,12 +11,19 @@ describe('utils', () => {\n     assert.equal(humanize('kebab-case'), 'Kebab Case')\n     assert.equal(humanize('multiple words here'), 'Multiple Words Here')\n     assert.equal(humanize('Multiple Words Here'), 'Multiple Words Here')\n-    assert.equal(humanize('Thing42WithOther43'), 'Thing42 With Other43')\n-    assert.equal(humanize('Thing42_withOther43', false), 'Thing42 with Other43')\n     assert.equal(humanize('foo'), 'Foo')\n     assert.equal(humanize('Foo'), 'Foo')\n     assert.equal(humanize('fooBar'), 'Foo Bar')\n     assert.equal(humanize('FooBar'), 'Foo Bar')\n     assert.equal(humanize('Foo Bar'), 'Foo Bar')\n+    assert.equal(humanize('Foo11WithBar11'), 'Foo11 With Bar11')\n+    assert.equal(humanize('Foo1A_WithBar11'), 'Foo1A With Bar11')\n+    assert.equal(humanize('Foo1AA_WithBar11'), 'Foo1 AA With Bar11')\n+    assert.equal(humanize('Foo11_WithBar11'), 'Foo11 With Bar11')\n+    assert.equal(humanize('Foo11_WithBar11A'), 'Foo11 With Bar11A')\n+    assert.equal(humanize('Foo11_WithBar11AA'), 'Foo11 With Bar11 AA')\n+    assert.equal(humanize('Foo11_withBar11', false), 'Foo11 with Bar11')\n+    assert.equal(humanize('FOO1A_BAR11'), 'FOO1A BAR11')\n+    assert.equal(humanize('FOO1A1_BAR11'), 'FOO1 A1 BAR11')\n   })\n })\n", "test_patch": "", "problem_statement": "", "hints_text": "", "created_at": "2025-09-03T05:43:27Z", "issue_numbers": []}
{"instance_id": "keystonejs__keystone-9691", "repo": "keystonejs/keystone", "pull_number": 9691, "base_commit": "052f5b1bfdc76868125722ea385c59ffae7eb000", "patch": "diff --git a/examples/actions/schema.ts b/examples/actions/schema.ts\nindex afa3d2f94c9..33263c0cac0 100644\n--- a/examples/actions/schema.ts\n+++ b/examples/actions/schema.ts\n@@ -67,6 +67,7 @@ export const lists = {\n         access: allowAll,\n         async resolve({ actionKey, where }, context) {\n           console.log(`${actionKey}`, JSON.stringify({ where }))\n+          // throw new Error('Random failure, try again')\n           return await context.db.Post.updateOne({\n             where,\n             data: {\n@@ -88,7 +89,7 @@ export const lists = {\n             promptMany: 'Are you sure you want to report {count} {singular|plural}?',\n             promptConfirmLabel: 'Yes, report',\n             promptConfirmLabelMany: 'Yes, report {count} {singular|plural}',\n-            fail: 'Could not report {singular}',\n+            fail: 'Could not report {singular} \u201c{itemLabel}\u201d',\n             failMany: 'Could not report {countFail} {singular|plural}',\n             success: '{Singular} reported',\n             successMany: 'Successfully reported {countSuccess} {singular|plural}',\ndiff --git a/packages/core/src/___internal-do-not-use-will-break-in-patch/admin-ui/pages/CreateItemPage/index.tsx b/packages/core/src/___internal-do-not-use-will-break-in-patch/admin-ui/pages/CreateItemPage/index.tsx\nindex ac994c696e2..9cc74187358 100644\n--- a/packages/core/src/___internal-do-not-use-will-break-in-patch/admin-ui/pages/CreateItemPage/index.tsx\n+++ b/packages/core/src/___internal-do-not-use-will-break-in-patch/admin-ui/pages/CreateItemPage/index.tsx\n@@ -25,6 +25,7 @@ function CreateItemPage({ listKey }: { listKey: string }) {\n       header={\n         <ItemPageHeader\n           list={list}\n+          actions={[]}\n           label=\"Create\"\n           title={`Create ${list.singular}`}\n           item={null}\ndiff --git a/packages/core/src/___internal-do-not-use-will-break-in-patch/admin-ui/pages/ItemPage/common.tsx b/packages/core/src/___internal-do-not-use-will-break-in-patch/admin-ui/pages/ItemPage/common.tsx\nindex e84f38c26f7..2212bb40f87 100644\n--- a/packages/core/src/___internal-do-not-use-will-break-in-patch/admin-ui/pages/ItemPage/common.tsx\n+++ b/packages/core/src/___internal-do-not-use-will-break-in-patch/admin-ui/pages/ItemPage/common.tsx\n@@ -18,19 +18,20 @@ import type { ActionMeta, ListMeta } from '../../../../types'\n \n export function ItemPageHeader({\n   list,\n+  actions,\n   item,\n   label,\n   title = label,\n   onAction,\n }: {\n   list: ListMeta\n+  actions: ActionMeta[]\n   item: Record<string, unknown> | null\n   label: string\n   title: string\n   onAction: ((action: ActionMeta, resultId: string) => void) | null\n }) {\n   const router = useRouter()\n-  const actions = list.actions.filter(action => action.itemView.actionMode !== 'hidden')\n \n   return (\n     <Grid\n@@ -87,6 +88,11 @@ function replace(\n   return s\n }\n \n+type ActionError = {\n+  action: ActionMeta\n+  error: Error\n+}\n+\n function ItemActions({\n   list,\n   item,\n@@ -108,7 +114,7 @@ function ItemActions({\n       })),\n     [actions]\n   )\n-  const [errorDialogValue, setErrorDialogValue] = useState<Error | null>(null)\n+  const [actionError, setActionError] = useState<ActionError | null>(null)\n   const [activeAction, setActiveAction] = useState<ActionMeta | null>(null)\n   const itemLabel_ = item[list.labelField] ?? item.id\n   const itemLabel = typeof itemLabel_ === 'string' ? itemLabel_ : (item.id as string)\n@@ -143,10 +149,10 @@ function ItemActions({\n       }\n \n       onAction(action, data.data?.result?.id)\n-    } catch (err: any) {\n+    } catch (error: any) {\n       toastQueue.critical(replace(m.fail, list, { itemLabel }), {\n         actionLabel: 'Details',\n-        onAction: () => setErrorDialogValue(err),\n+        onAction: () => setActionError({ action, error }),\n         shouldCloseOnAction: true,\n       })\n     }\n@@ -189,8 +195,13 @@ function ItemActions({\n         )}\n       </DialogContainer>\n \n-      <DialogContainer onDismiss={() => setErrorDialogValue(null)} isDismissable>\n-        {errorDialogValue && <ErrorDetailsDialog error={errorDialogValue} />}\n+      <DialogContainer onDismiss={() => setActionError(null)} isDismissable>\n+        {actionError && (\n+          <ErrorDetailsDialog\n+            title={replace(actionError.action.messages.fail, list, { itemLabel })}\n+            error={actionError.error}\n+          />\n+        )}\n       </DialogContainer>\n     </Fragment>\n   )\ndiff --git a/packages/core/src/___internal-do-not-use-will-break-in-patch/admin-ui/pages/ItemPage/index.tsx b/packages/core/src/___internal-do-not-use-will-break-in-patch/admin-ui/pages/ItemPage/index.tsx\nindex 6b6d6fa327c..f0a6b823b6e 100644\n--- a/packages/core/src/___internal-do-not-use-will-break-in-patch/admin-ui/pages/ItemPage/index.tsx\n+++ b/packages/core/src/___internal-do-not-use-will-break-in-patch/admin-ui/pages/ItemPage/index.tsx\n@@ -90,7 +90,7 @@ function DeleteButton({\n             try {\n               await deleteItem()\n             } catch (err: any) {\n-              toastQueue.critical('Unable to delete item.', {\n+              toastQueue.critical('Unable to delete item', {\n                 actionLabel: 'Details',\n                 onAction: () => setErrorDialogValue(err),\n                 shouldCloseOnAction: true,\n@@ -112,7 +112,9 @@ function DeleteButton({\n       </DialogTrigger>\n \n       <DialogContainer onDismiss={() => setErrorDialogValue(null)} isDismissable>\n-        {errorDialogValue && <ErrorDetailsDialog error={errorDialogValue} />}\n+        {errorDialogValue && (\n+          <ErrorDetailsDialog title=\"Unable to delete item\" error={errorDialogValue} />\n+        )}\n       </DialogContainer>\n     </Fragment>\n   )\n@@ -176,7 +178,7 @@ function ItemForm({\n }) {\n   const list = useList(listKey)\n   const itemId = initialValue.id as string\n-  const [errorDialogValue, setErrorDialogValue] = useState<Error | null>(null)\n+  const [updateError, setUpdateError] = useState<Error | null>(null)\n   const [update, { loading, error }] = useMutation(\n     gql`mutation ($id: ID!, $data: ${list.graphql.names.updateInputName}!) {\n       item: ${list.graphql.names.updateMutationName}(where: { id: $id }, data: $data) {\n@@ -212,13 +214,13 @@ function ItemForm({\n     if (error) {\n       toastQueue.critical('Unable to save item', {\n         actionLabel: 'Details',\n-        onAction: () => setErrorDialogValue(new Error(error.message)),\n+        onAction: () => setUpdateError(new Error(error.message)),\n         shouldCloseOnAction: true,\n       })\n       return\n     }\n \n-    toastQueue.positive(`Saved changes to ${list.singular.toLocaleLowerCase()}`, {\n+    toastQueue.positive(`Saved changes to ${list.singular.toLocaleLowerCase()}.`, {\n       timeout: 5000,\n     })\n \n@@ -293,8 +295,8 @@ function ItemForm({\n         </BaseToolbar>\n       </form>\n \n-      <DialogContainer onDismiss={() => setErrorDialogValue(null)} isDismissable>\n-        {errorDialogValue && <ErrorDetailsDialog error={errorDialogValue} />}\n+      <DialogContainer onDismiss={() => setUpdateError(null)} isDismissable>\n+        {updateError && <ErrorDetailsDialog title=\"Unable to save item\" error={updateError} />}\n       </DialogContainer>\n     </Fragment>\n   )\n@@ -319,24 +321,47 @@ function ItemPage({ listKey }: ItemPageProps) {\n     return deserializeItemToValue(list.fields, item)\n   }, [list.fields, data?.item])\n \n-  const { fieldModes, fieldPositions, isRequireds } = useMemo(() => {\n+  const { actionsInContext, fieldModes, fieldPositions, isRequireds } = useMemo(() => {\n+    const actionModes = Object.fromEntries(\n+      Object.entries(list.actions).map(([k, v]) => [k, v.itemView.actionMode])\n+    )\n     const fieldModes = Object.fromEntries(\n-      Object.entries(list.fields).map(([key, val]) => [key, val.itemView.fieldMode])\n+      Object.entries(list.fields).map(([k, v]) => [k, v.itemView.fieldMode])\n     )\n     const fieldPositions = Object.fromEntries(\n-      Object.entries(list.fields).map(([key, val]) => [key, val.itemView.fieldPosition])\n+      Object.entries(list.fields).map(([k, v]) => [k, v.itemView.fieldPosition])\n     )\n     const isRequireds = Object.fromEntries(\n-      Object.entries(list.fields).map(([key, val]) => [key, val.itemView.isRequired])\n+      Object.entries(list.fields).map(([k, v]) => [k, v.itemView.isRequired])\n     )\n     for (const field of data?.keystone.adminMeta.list?.fields ?? []) {\n-      if (field.itemView) {\n-        fieldModes[field.key] = field.itemView.fieldMode\n-        fieldPositions[field.key] = field.itemView.fieldPosition\n-        isRequireds[field.key] = field.itemView.isRequired\n-      }\n+      if (!field.itemView) continue\n+      fieldModes[field.key] = field.itemView.fieldMode\n+      fieldPositions[field.key] = field.itemView.fieldPosition\n+      isRequireds[field.key] = field.itemView.isRequired\n+    }\n+    for (const action of data?.keystone.adminMeta.list?.actions ?? []) {\n+      if (!action.itemView) continue\n+      actionModes[action.key] = action.itemView.actionMode\n+    }\n+\n+    // actions within context of an item\n+    const actionsInContext = list.actions\n+      .map(action => ({\n+        ...action,\n+        itemView: {\n+          ...action.itemView,\n+          actionMode: actionModes[action.key],\n+        },\n+      }))\n+      .filter(action => action.itemView.actionMode !== 'hidden')\n+\n+    return {\n+      actionsInContext,\n+      fieldModes,\n+      fieldPositions,\n+      isRequireds,\n     }\n-    return { fieldModes, fieldPositions, isRequireds }\n   }, [data?.keystone.adminMeta, list.fields])\n \n   function onAction(action: ActionMeta, resultId: string | null) {\n@@ -357,6 +382,7 @@ function ItemPage({ listKey }: ItemPageProps) {\n       header={\n         <ItemPageHeader\n           list={list}\n+          actions={actionsInContext}\n           label={typeof pageLabel !== 'string' ? 'Loading...' : pageLabel}\n           title={pageTitle}\n           item={item ?? null}\ndiff --git a/packages/core/src/___internal-do-not-use-will-break-in-patch/admin-ui/pages/ListPage/index.tsx b/packages/core/src/___internal-do-not-use-will-break-in-patch/admin-ui/pages/ListPage/index.tsx\nindex 40de6267865..f42d56bc3b5 100644\n--- a/packages/core/src/___internal-do-not-use-will-break-in-patch/admin-ui/pages/ListPage/index.tsx\n+++ b/packages/core/src/___internal-do-not-use-will-break-in-patch/admin-ui/pages/ListPage/index.tsx\n@@ -1,4 +1,5 @@\n import isDeepEqual from 'fast-deep-equal'\n+import type { GraphQLFormattedError } from 'graphql'\n import { useRouter } from 'next/router'\n import type { ParsedUrlQuery, ParsedUrlQueryInput } from 'querystring'\n import { type FormEvent, type Key, Fragment, useEffect, useId, useMemo, useState } from 'react'\n@@ -12,7 +13,7 @@ import { chevronDownIcon } from '@keystar/ui/icon/icons/chevronDownIcon'\n import { searchXIcon } from '@keystar/ui/icon/icons/searchXIcon'\n import { textSelectIcon } from '@keystar/ui/icon/icons/textSelectIcon'\n import { undo2Icon } from '@keystar/ui/icon/icons/undo2Icon'\n-import { Flex, HStack, VStack } from '@keystar/ui/layout'\n+import { Box, Flex, HStack, VStack } from '@keystar/ui/layout'\n import { Menu, MenuTrigger } from '@keystar/ui/menu'\n import { ProgressCircle } from '@keystar/ui/progress'\n import { SearchField } from '@keystar/ui/search-field'\n@@ -31,6 +32,8 @@ import { toastQueue } from '@keystar/ui/toast'\n import { Tooltip, TooltipTrigger } from '@keystar/ui/tooltip'\n import { Heading, Text } from '@keystar/ui/typography'\n \n+import { TextLink } from '@keystar/ui/link'\n+import { Notice } from '@keystar/ui/notice'\n import type { TypedDocumentNode } from '../../../../admin-ui/apollo'\n import { gql, useMutation, useQuery } from '../../../../admin-ui/apollo'\n import { CreateButtonLink } from '../../../../admin-ui/components/CreateButtonLink'\n@@ -251,7 +254,7 @@ function ListPage({ listKey }: ListPageProps) {\n   const localStorageListKey = `keystone.list.${listKey}.list.page.info`\n \n   const list = useList(listKey)\n-  const { query, replace, isReady } = useRouter()\n+  const { query, replace: routerReplace, isReady } = useRouter()\n   const [sort, setSort] = useState<SortDescriptor | null>(() => getSort(list, {}))\n   const [columns, setColumns] = useState<string[]>(list.initialColumns)\n   const [filters, setFilters] = useState<Filter[]>(() => getFilters(list, {}))\n@@ -260,6 +263,7 @@ function ListPage({ listKey }: ListPageProps) {\n   const [searchString, setSearchString] = useState('')\n   const [selectedItems, setSelectedItems] = useState<Selection>(() => new Set([]))\n   const [activeAction, setActiveAction] = useState<Key | null>(null)\n+  const [actionResult, setActionResult] = useState<ActionErrorResult | null>(null)\n   const dirty = useMemo(() => {\n     const defaultFilters = getFilters(list, {})\n     const defaultSort = getSort(list, {})\n@@ -313,7 +317,7 @@ function ListPage({ listKey }: ListPageProps) {\n     }\n \n     localStorage.setItem(localStorageListKey, JSON.stringify(updatedQuery))\n-    replace({ query: updatedQuery })\n+    routerReplace({ query: updatedQuery })\n   }, [columns, sort, filters, currentPage, pageSize, searchString, list])\n \n   const allowCreate = !(list.hideCreate ?? true)\n@@ -655,15 +659,75 @@ function ListPage({ listKey }: ListPageProps) {\n                   itemIds={selectedItemIds}\n                   {...action}\n                   list={list}\n-                  onSuccess={() => {\n+                  onSuccess={remaining => {\n                     refetch()\n-                    setSelectedItems(new Set())\n+                    setSelectedItems(remaining)\n                   }}\n+                  onErrors={setActionResult}\n                 />\n               )\n             })\n             .pop()}\n         </DialogContainer>\n+        <DialogContainer onDismiss={() => setActionResult(null)} isDismissable>\n+          {actionResult ? (\n+            <Dialog>\n+              <Heading>Error details for {actionResult.action.label} action</Heading>\n+              <Content>\n+                <VStack gap=\"large\">\n+                  {[\n+                    ...(function* () {\n+                      const { action, errors: actionErrors } = actionResult\n+                      for (const [itemId, itemActionErrors] of Object.entries(actionErrors)) {\n+                        const item = data?.items?.find(i => i.id === itemId) ?? null\n+                        const itemLabel = (item?.[list.labelField] as string | null) ?? itemId\n+                        const href = `/${list.path}/${itemId}`\n+\n+                        for (const error of itemActionErrors) {\n+                          yield (\n+                            <VStack key={itemId} gap=\"regular\">\n+                              <Notice tone=\"critical\">\n+                                <Content>\n+                                  <Text>\n+                                    You might try running the action again from{' '}\n+                                    <TextLink href={href}>\n+                                      the {list.singular.toLowerCase()}.\n+                                    </TextLink>\n+                                  </Text>\n+                                  <Box\n+                                    elementType=\"pre\"\n+                                    backgroundColor=\"critical\"\n+                                    borderRadius=\"regular\"\n+                                    maxHeight=\"100%\"\n+                                    overflow=\"auto\"\n+                                  >\n+                                    <Text\n+                                      color=\"critical\"\n+                                      UNSAFE_className={css({\n+                                        fontFamily: tokenSchema.typography.fontFamily.code,\n+                                      })}\n+                                    >\n+                                      {error.message}\n+                                    </Text>\n+                                  </Box>\n+                                </Content>\n+                                <div>\n+                                  <Heading>\n+                                    {replace(action.messages.fail, list, { itemLabel }, false)}\n+                                  </Heading>\n+                                </div>\n+                              </Notice>\n+                            </VStack>\n+                          )\n+                        }\n+                      }\n+                    })(),\n+                  ]}\n+                </VStack>\n+              </Content>\n+            </Dialog>\n+          ) : null}\n+        </DialogContainer>\n       </VStack>\n     </PageContainer>\n   )\n@@ -711,15 +775,23 @@ function replace(\n   return s\n }\n \n+type ActionErrors = Record<string, GraphQLFormattedError[]>\n+type ActionErrorResult = {\n+  action: ActionMeta\n+  errors: ActionErrors\n+}\n+\n function ActionItemsDialog({\n   list,\n   itemIds,\n   onSuccess,\n+  onErrors,\n   ...action\n }: {\n   list: ListMeta\n   itemIds: string[]\n-  onSuccess: (remaining: string[]) => void\n+  onSuccess: (remaining: Set<string>) => void\n+  onErrors: (result: ActionErrorResult) => void\n } & ActionMeta) {\n   const [actionOnItems] = useMutation<{ results?: ({ id: string } | null)[] }>(\n     gql`mutation($where: [${list.graphql.names.whereUniqueInputName}!]!) {\n@@ -736,13 +808,22 @@ function ActionItemsDialog({\n \n   async function onTryAction() {\n     try {\n-      const { data, errors } = await actionOnItems()\n-      const failed = itemIds.filter(id => !data?.results?.some(x => x?.id === id))\n-      const countSuccess = itemIds.length - failed.length\n-      const countFail = failed.length\n+      const { errors } = await actionOnItems()\n+      const countFail = errors?.length ?? 0\n+      const countSuccess = itemIds.length - countFail\n+      const failed = new Set<string>()\n+      const actionErrors: ActionErrors = {}\n+      for (const error of errors ?? []) {\n+        const i = error.path?.[1]\n+        if (typeof i !== 'number') continue\n+        const itemId = itemIds[i]\n+\n+        failed.add(itemId)\n+        actionErrors[itemId] ??= []\n+        actionErrors[itemId].push(error)\n+      }\n \n-      // if there are errors\n-      if (failed.length || errors?.length) {\n+      if (countFail) {\n         toastQueue.critical(\n           replace(\n             m.failMany,\n@@ -754,7 +835,11 @@ function ActionItemsDialog({\n             },\n             countFail > 1\n           ),\n-          { timeout: 5000 }\n+          {\n+            actionLabel: 'Details',\n+            onAction: () => onErrors({ action, errors: actionErrors }),\n+            shouldCloseOnAction: true,\n+          }\n         )\n       }\n \ndiff --git a/packages/core/src/admin-ui/components/Errors.tsx b/packages/core/src/admin-ui/components/Errors.tsx\nindex f77ee7f0273..493a480e7d2 100644\n--- a/packages/core/src/admin-ui/components/Errors.tsx\n+++ b/packages/core/src/admin-ui/components/Errors.tsx\n@@ -5,6 +5,7 @@ import { Dialog } from '@keystar/ui/dialog'\n import { Icon } from '@keystar/ui/icon'\n import { alertTriangleIcon } from '@keystar/ui/icon/icons/alertTriangleIcon'\n import { Box, Grid, VStack } from '@keystar/ui/layout'\n+import { Notice } from '@keystar/ui/notice'\n import { Content, SlotProvider } from '@keystar/ui/slots'\n import { css, tokenSchema } from '@keystar/ui/style'\n import { Heading, Text } from '@keystar/ui/typography'\n@@ -83,26 +84,34 @@ export function ErrorContainer({ children }: ErrorContainerProps) {\n   )\n }\n \n-export function ErrorDetailsDialog({ error }: { error: Error }) {\n+export function ErrorDetailsDialog({ title, error }: { title: string; error: Error }) {\n   const { message, stack } = error\n   return (\n     <Dialog>\n       <Heading>Error details</Heading>\n       <Content>\n-        <VStack gap=\"large\">\n-          <Text weight=\"medium\">{message}</Text>\n-          {stack && (\n+        <Notice tone=\"critical\">\n+          <Content>\n+            <Text weight=\"medium\">{message}</Text>\n             <Box\n               elementType=\"pre\"\n               backgroundColor=\"critical\"\n               borderRadius=\"regular\"\n               maxHeight=\"100%\"\n-              padding=\"medium\"\n               overflow=\"auto\"\n             >\n               <Text\n                 color=\"critical\"\n-                trim={false}\n+                UNSAFE_className={css({\n+                  fontFamily: tokenSchema.typography.fontFamily.code,\n+                })}\n+              >\n+                {message}\n+              </Text>\n+              <Text\n+                color=\"critical\"\n+                marginTop=\"small\"\n+                size=\"small\"\n                 UNSAFE_className={css({\n                   fontFamily: tokenSchema.typography.fontFamily.code,\n                 })}\n@@ -110,8 +119,11 @@ export function ErrorDetailsDialog({ error }: { error: Error }) {\n                 {stack}\n               </Text>\n             </Box>\n-          )}\n-        </VStack>\n+          </Content>\n+          <div>\n+            <Heading>{title}</Heading>\n+          </div>\n+        </Notice>\n       </Content>\n     </Dialog>\n   )\ndiff --git a/packages/core/src/admin-ui/context.tsx b/packages/core/src/admin-ui/context.tsx\nindex 43668c17c3f..a481db6ef01 100644\n--- a/packages/core/src/admin-ui/context.tsx\n+++ b/packages/core/src/admin-ui/context.tsx\n@@ -237,6 +237,12 @@ export function useListItem(\n               isRequired: ConditionalFilterCase<BaseListTypeInfo>\n             } | null\n           }[]\n+          actions: {\n+            key: string\n+            itemView: {\n+              actionMode: ConditionalFilter<'enabled' | 'disabled' | 'hidden', BaseListTypeInfo>\n+            } | null\n+          }[]\n         } | null\n       }\n     }\ndiff --git a/tests/admin-ui-tests/list-view-crud.test.ts b/tests/admin-ui-tests/list-view-crud.test.ts\nindex 54448dd9121..cd694596edd 100644\n--- a/tests/admin-ui-tests/list-view-crud.test.ts\n+++ b/tests/admin-ui-tests/list-view-crud.test.ts\n@@ -88,7 +88,7 @@ adminUITests('./tests/test-projects/crud-notifications', browserType => {\n     await page.getByRole('button', { name: 'Yes, delete' }).click()\n     const alertDialog = page.locator('[role=alertdialog][aria-modal=false]')\n     await alertDialog.waitFor()\n-    expect(await alertDialog.innerText()).toBe('Unable to delete 25 tasks.')\n+    expect(await alertDialog.innerText()).toBe('Unable to delete 25 tasks.\\nDetails')\n     await alertDialog.getByRole('button', { name: 'Close' }).click()\n     await page\n       .locator('[role=alertdialog][aria-modal=false]:has-text(\"Deleted 25 tasks.\")')\n", "test_patch": "", "problem_statement": "", "hints_text": "", "created_at": "2025-08-28T05:20:50Z", "issue_numbers": []}
{"instance_id": "keystonejs__keystone-9656", "repo": "keystonejs/keystone", "pull_number": 9656, "base_commit": "052f5b1bfdc76868125722ea385c59ffae7eb000", "patch": "diff --git a/packages/fields-document/package.json b/packages/fields-document/package.json\nindex 669f74798fd..2c01f54bb0c 100644\n--- a/packages/fields-document/package.json\n+++ b/packages/fields-document/package.json\n@@ -102,7 +102,7 @@\n     \"slate\": \"^0.112.0\",\n     \"slate-history\": \"^0.113.0\",\n     \"slate-react\": \"^0.112.0\",\n-    \"zod\": \"^3.23.8\"\n+    \"zod\": \"^4.0.0\"\n   },\n   \"devDependencies\": {\n     \"@keystone-6/core\": \"workspace:^\",\ndiff --git a/packages/fields-document/src/DocumentEditor/link.tsx b/packages/fields-document/src/DocumentEditor/link.tsx\nindex a5feb5a7695..2c2d6bbb7ee 100644\n--- a/packages/fields-document/src/DocumentEditor/link.tsx\n+++ b/packages/fields-document/src/DocumentEditor/link.tsx\n@@ -154,7 +154,7 @@ function LinkDialog({\n               label=\"Link\"\n               onChange={setHref}\n               value={href}\n-              errorMessage={isInvalid && 'This type of URL is not accepted by Keystone'}\n+              errorMessage={isInvalid && 'This type of URL is not accepted'}\n             />\n           </Flex>\n         </Content>\ndiff --git a/packages/fields-document/src/structure-validation.ts b/packages/fields-document/src/structure-validation.ts\nindex 73f9aa9855e..06f6d23bcf2 100644\n--- a/packages/fields-document/src/structure-validation.ts\n+++ b/packages/fields-document/src/structure-validation.ts\n@@ -7,7 +7,7 @@ const zMarkValue = z.union([z.literal(true), z.undefined()])\n \n const zText = z\n   .object({\n-    type: z.never().optional(),\n+    type: z.literal('text').optional(),\n     text: z.string(),\n     bold: zMarkValue,\n     italic: zMarkValue,\n@@ -27,10 +27,9 @@ const zTextAlign = z.union([z.undefined(), z.literal('center'), z.literal('end')\n const zLink = z\n   .object({\n     type: z.literal('link'),\n-    href: z.string().refinement(isValidURL as (url: string) => url is any, val => ({\n-      code: 'custom',\n-      message: `Invalid URL: ${val}`,\n-    })),\n+    href: z.string().refine(val => isValidURL(val), {\n+      error: `This type of URL is not accepted`,\n+    }),\n   })\n   .strict()\n \ndiff --git a/packages/fields-document/src/validation.test.tsx b/packages/fields-document/src/validation.test.tsx\nindex c2108210387..a57c2c32bdf 100644\n--- a/packages/fields-document/src/validation.test.tsx\n+++ b/packages/fields-document/src/validation.test.tsx\n@@ -84,11 +84,10 @@ test('invalid structure', () => {\n   expect(validate({})).toMatchInlineSnapshot(`\n   [Error: Invalid document structure: [\n     {\n-      \"code\": \"invalid_type\",\n       \"expected\": \"array\",\n-      \"received\": \"object\",\n+      \"code\": \"invalid_type\",\n       \"path\": [],\n-      \"message\": \"Expected array, received object\"\n+      \"message\": \"Invalid input: expected array, received object\"\n     }\n   ]]\n `)\n@@ -99,22 +98,20 @@ test('bad link', () => {\n     validate([\n       {\n         type: 'paragraph',\n-        children: [\n-          { type: 'link', href: 'javascript:doBadThings()', children: [{ text: 'some text' }] },\n-        ],\n+        children: [{ type: 'link', href: 'javascript:bad', children: [{ text: 'some text' }] }],\n       },\n     ])\n   ).toMatchInlineSnapshot(`\n     [Error: Invalid document structure: [\n       {\n         \"code\": \"custom\",\n-        \"message\": \"Invalid URL: javascript:doBadThings()\",\n         \"path\": [\n           0,\n           \"children\",\n           0,\n           \"href\"\n-        ]\n+        ],\n+        \"message\": \"This type of URL is not accepted\"\n       }\n     ]]\n   `)\n@@ -136,20 +133,41 @@ test('excess properties', () => {\n       },\n     ])\n   ).toMatchInlineSnapshot(`\n-    [Error: Invalid document structure: [\n-      {\n-        \"code\": \"unrecognized_keys\",\n-        \"keys\": [\n-          \"somethingElse\"\n-        ],\n-        \"path\": [\n-          0,\n-          \"children\",\n-          0\n-        ],\n-        \"message\": \"Unrecognized key(s) in object: 'somethingElse'\"\n-      }\n-    ]]\n+[Error: Invalid document structure: [\n+  {\n+    \"code\": \"invalid_union\",\n+    \"errors\": [\n+      [\n+        {\n+          \"code\": \"invalid_union\",\n+          \"errors\": [],\n+          \"note\": \"No matching discriminator\",\n+          \"discriminator\": \"type\",\n+          \"path\": [\n+            \"type\"\n+          ],\n+          \"message\": \"Invalid input\"\n+        }\n+      ],\n+      [\n+        {\n+          \"code\": \"unrecognized_keys\",\n+          \"keys\": [\n+            \"somethingElse\"\n+          ],\n+          \"path\": [],\n+          \"message\": \"Unrecognized key: \\\\\"somethingElse\\\\\"\"\n+        }\n+      ]\n+    ],\n+    \"path\": [\n+      0,\n+      \"children\",\n+      0\n+    ],\n+    \"message\": \"Invalid input\"\n+  }\n+]]\n   `)\n })\n \ndiff --git a/pnpm-lock.yaml b/pnpm-lock.yaml\nindex 961105f986d..8ecb9314295 100644\n--- a/pnpm-lock.yaml\n+++ b/pnpm-lock.yaml\n@@ -2101,8 +2101,8 @@ importers:\n         specifier: ^0.112.0\n         version: 0.112.1(react-dom@19.0.0(react@19.0.0))(react@19.0.0)(slate-dom@0.112.2(slate@0.112.0))(slate@0.112.0)\n       zod:\n-        specifier: ^3.23.8\n-        version: 3.24.2\n+        specifier: ^4.0.0\n+        version: 4.0.10\n     devDependencies:\n       '@keystone-6/core':\n         specifier: workspace:^\n@@ -12524,6 +12524,9 @@ packages:\n   zod@3.24.2:\n     resolution: {integrity: sha512-lY7CDW43ECgW9u1TcT3IoXHflywfVqDYze4waEz812jR/bZ8FHDsl7pFQoSZTz5N+2NqRXs8GBwnAwo3ZNxqhQ==}\n \n+  zod@4.0.10:\n+    resolution: {integrity: sha512-3vB+UU3/VmLL2lvwcY/4RV2i9z/YU0DTV/tDuYjrwmx5WeJ7hwy+rGEEx8glHp6Yxw7ibRbKSaIFBgReRPe5KA==}\n+\n   zwitch@1.0.5:\n     resolution: {integrity: sha512-V50KMwwzqJV0NpZIZFwfOD5/lyny3WlSzRiXgA0G7VUnRlqttta1L6UQIHzd6EuBY/cHGfwTIck7w1yH6Q5zUw==}\n \n@@ -25754,6 +25757,8 @@ snapshots:\n \n   zod@3.24.2: {}\n \n+  zod@4.0.10: {}\n+\n   zwitch@1.0.5: {}\n \n   zwitch@2.0.4: {}\ndiff --git a/tests/api-tests/fields/document.test.ts b/tests/api-tests/fields/document.test.ts\nindex 8eb3294d1e4..1715a53376b 100644\n--- a/tests/api-tests/fields/document.test.ts\n+++ b/tests/api-tests/fields/document.test.ts\n@@ -58,10 +58,8 @@ test(\n       {\n         type: 'paragraph',\n         children: [\n-          {\n-            text: 'blah',\n-          },\n-          { type: 'link', href: 'javascript:evil', children: [{ text: `blah` }] },\n+          { text: 'blah' },\n+          { type: 'link', href: 'javascript:bad', children: [{ text: `blah` }] },\n           { text: 'blah' },\n         ],\n       },\n@@ -78,13 +76,13 @@ test(\n   - Post.document: Invalid document structure: [\n   {\n     \"code\": \"custom\",\n-    \"message\": \"Invalid URL: javascript:evil\",\n     \"path\": [\n       0,\n       \"children\",\n       1,\n       \"href\"\n-    ]\n+    ],\n+    \"message\": \"This type of URL is not accepted\"\n   }\n ]`\n     )\n@@ -99,7 +97,7 @@ test(\n         type: 'component-block',\n         component: 'a',\n         props: {\n-          url: 'javascript:evil',\n+          url: 'javascript:bad',\n         },\n         children: [\n           {\n@@ -122,7 +120,7 @@ test(\n     ).rejects.toHaveProperty(\n       'message',\n       `An error occurred while resolving input fields.\n-  - Post.document: Invalid form prop value: \"javascript:evil\" at url`\n+  - Post.document: Invalid form prop value: \"javascript:bad\" at url`\n     )\n   })\n )\n", "test_patch": "", "problem_statement": "", "hints_text": "", "created_at": "2025-07-14T19:00:59Z", "issue_numbers": []}
{"instance_id": "keystonejs__keystone-9673", "repo": "keystonejs/keystone", "pull_number": 9673, "base_commit": "052f5b1bfdc76868125722ea385c59ffae7eb000", "patch": "diff --git a/packages/core/src/___internal-do-not-use-will-break-in-patch/admin-ui/pages/HomePage/index.tsx b/packages/core/src/___internal-do-not-use-will-break-in-patch/admin-ui/pages/HomePage/index.tsx\nindex cd3582fdbb0..5d93a2c5e67 100644\n--- a/packages/core/src/___internal-do-not-use-will-break-in-patch/admin-ui/pages/HomePage/index.tsx\n+++ b/packages/core/src/___internal-do-not-use-will-break-in-patch/admin-ui/pages/HomePage/index.tsx\n@@ -8,7 +8,7 @@ import { plusIcon } from '@keystar/ui/icon/icons/plusIcon'\n import { Grid, VStack } from '@keystar/ui/layout'\n import { useLink } from '@keystar/ui/link'\n import { css, FocusRing, tokenSchema, transition } from '@keystar/ui/style'\n-import { TooltipTrigger, Tooltip } from '@keystar/ui/tooltip'\n+import { Tooltip, TooltipTrigger } from '@keystar/ui/tooltip'\n import { Heading, Text } from '@keystar/ui/typography'\n \n import { GraphQLErrorNotice } from '../../../../admin-ui/components/GraphQLErrorNotice'\n@@ -16,10 +16,8 @@ import { PageContainer } from '../../../../admin-ui/components/PageContainer'\n import { useKeystone, useList } from '../../../../admin-ui/context'\n \n export function HomePage() {\n-  const { adminMeta } = useKeystone()\n-  const visibleLists = useMemo(() => {\n-    return Object.values(adminMeta?.lists ?? {}).filter(list => !list.hideNavigation)\n-  }, [adminMeta?.lists])\n+  const { lists: allLists } = useKeystone()\n+  const visibleLists = Object.values(allLists).filter(list => !list.hideNavigation)\n \n   const LIST_COUNTS_QUERY = useMemo(\n     () =>\ndiff --git a/packages/core/src/___internal-do-not-use-will-break-in-patch/admin-ui/pages/ListPage/Pagination.tsx b/packages/core/src/___internal-do-not-use-will-break-in-patch/admin-ui/pages/ListPage/Pagination.tsx\ndeleted file mode 100644\nindex cb7b97633ba..00000000000\n--- a/packages/core/src/___internal-do-not-use-will-break-in-patch/admin-ui/pages/ListPage/Pagination.tsx\n+++ /dev/null\n@@ -1,39 +0,0 @@\n-import { useRouter } from 'next/router'\n-import { PaginationControls, snapValueToClosest } from './PaginationControls'\n-\n-type PaginationProps = {\n-  pageSize: number\n-  total: number\n-  currentPage: number\n-  singular: string\n-  plural: string\n-  onChange: (page: number, pageSize: number) => void\n-}\n-\n-export function Pagination(props: PaginationProps) {\n-  const { currentPage, pageSize, onChange } = props\n-  const onChangePage = (page: number) => onChange(page, pageSize)\n-  const onChangePageSize = (pageSize: number) => onChange(currentPage, pageSize)\n-  return (\n-    <PaginationControls\n-      onChangePageSize={onChangePageSize}\n-      onChangePage={onChangePage}\n-      {...props}\n-    />\n-  )\n-}\n-\n-export function usePaginationParams({ defaultPageSize }: { defaultPageSize: number }) {\n-  const { query } = useRouter()\n-  const currentPage = Math.max(\n-    typeof query.page === 'string' && !Number.isNaN(parseInt(query.page)) ? Number(query.page) : 1,\n-    1\n-  )\n-  const pageSize = snapValueToClosest(\n-    typeof query.pageSize === 'string' && !Number.isNaN(parseInt(query.pageSize))\n-      ? parseInt(query.pageSize)\n-      : defaultPageSize\n-  )\n-\n-  return { currentPage, pageSize }\n-}\ndiff --git a/packages/core/src/___internal-do-not-use-will-break-in-patch/admin-ui/pages/ListPage/PaginationControls.tsx b/packages/core/src/___internal-do-not-use-will-break-in-patch/admin-ui/pages/ListPage/PaginationControls.tsx\nindex 5d05d11cccd..88f769d54c2 100644\n--- a/packages/core/src/___internal-do-not-use-will-break-in-patch/admin-ui/pages/ListPage/PaginationControls.tsx\n+++ b/packages/core/src/___internal-do-not-use-will-break-in-patch/admin-ui/pages/ListPage/PaginationControls.tsx\n@@ -2,9 +2,11 @@ import { ActionButton } from '@keystar/ui/button'\n import { Icon } from '@keystar/ui/icon'\n import { chevronLeftIcon } from '@keystar/ui/icon/icons/chevronLeftIcon'\n import { chevronRightIcon } from '@keystar/ui/icon/icons/chevronRightIcon'\n+import { undo2Icon } from '@keystar/ui/icon/icons/undo2Icon'\n import { HStack } from '@keystar/ui/layout'\n import { Picker } from '@keystar/ui/picker'\n import { Item } from '@keystar/ui/tag'\n+import { Tooltip, TooltipTrigger } from '@keystar/ui/tooltip'\n import { Text } from '@keystar/ui/typography'\n import type { ReactNode } from 'react'\n import { useMemo } from 'react'\n@@ -20,11 +22,12 @@ export function PaginationControls(props: {\n   currentPage: number\n   pageSize: number\n   total: number\n+  defaultPageSize?: number\n   onChangePage: (page: number) => void\n   onChangePageSize: (pageSize: number) => void\n   extraActions?: ReactNode\n }) {\n-  const { currentPage, total, pageSize } = props\n+  const { currentPage, total, pageSize, defaultPageSize } = props\n   const { stats } = getPaginationStats(props)\n \n   const nextPage = currentPage + 1\n@@ -69,6 +72,18 @@ export function PaginationControls(props: {\n           >\n             {item => <Item>{item.label}</Item>}\n           </Picker>\n+          {defaultPageSize !== undefined && pageSize !== defaultPageSize ? (\n+            <TooltipTrigger>\n+              <ActionButton\n+                aria-label=\"reset\"\n+                onPress={() => props.onChangePageSize(defaultPageSize)}\n+                prominence=\"low\"\n+              >\n+                <Icon src={undo2Icon} />\n+              </ActionButton>\n+              <Tooltip>Reset to defaults</Tooltip>\n+            </TooltipTrigger>\n+          ) : null}\n         </HStack>\n         <Text color=\"neutralSecondary\">{stats}</Text>\n       </HStack>\ndiff --git a/packages/core/src/___internal-do-not-use-will-break-in-patch/admin-ui/pages/ListPage/index.tsx b/packages/core/src/___internal-do-not-use-will-break-in-patch/admin-ui/pages/ListPage/index.tsx\nindex 0dc21eeec46..49a416d8906 100644\n--- a/packages/core/src/___internal-do-not-use-will-break-in-patch/admin-ui/pages/ListPage/index.tsx\n+++ b/packages/core/src/___internal-do-not-use-will-break-in-patch/admin-ui/pages/ListPage/index.tsx\n@@ -41,8 +41,7 @@ import { useList } from '../../../../admin-ui/context'\n import { useSearchFilter } from '../../../../fields/types/relationship/views/useFilter'\n import type { FieldMeta, JSONValue, ListMeta } from '../../../../types'\n import { FilterAdd } from './FilterAdd'\n-import { Pagination } from './Pagination'\n-import { snapValueToClosest } from './PaginationControls'\n+import { PaginationControls, snapValueToClosest } from './PaginationControls'\n import { Tag } from './Tag'\n \n type ListPageProps = { listKey: string }\n@@ -144,7 +143,9 @@ function FilterDialog({\n }\n \n function getFilters(list: ListMeta, query: ParsedUrlQueryInput) {\n-  if (!Array.isArray(query.filter)) return []\n+  const param_ = query.filter\n+  const params = Array.isArray(param_) ? param_ : typeof param_ === 'string' ? [param_] : []\n+  if (!params.length) return []\n   const filters: Filter[] = []\n \n   for (const [fieldPath, field] of Object.entries(list.fields)) {\n@@ -153,7 +154,7 @@ function getFilters(list: ListMeta, query: ParsedUrlQueryInput) {\n \n     for (const filterType in field.controller.filter.types) {\n       const prefix = `${fieldPath}_${filterType}`\n-      for (const queryFilter of query.filter) {\n+      for (const queryFilter of params) {\n         if (queryFilter === prefix) {\n           filters.push({\n             type: filterType,\n@@ -228,26 +229,25 @@ function ListPage({ listKey }: ListPageProps) {\n   const localStorageListKey = `keystone.list.${listKey}.list.page.info`\n \n   const list = useList(listKey)\n-  const defaultFilters = useMemo(() => getFilters(list, {}), [list])\n-  const defaultSort = useMemo(() => getSort(list, {}), [list])\n-\n   const { query, replace, isReady } = useRouter()\n   const [sort, setSort] = useState<SortDescriptor | null>(() => getSort(list, {}))\n-  const [columns, setColumns] = useState<string[]>(() => getColumns(list, {}))\n+  const [columns, setColumns] = useState<string[]>(list.initialColumns)\n   const [filters, setFilters] = useState<Filter[]>(() => getFilters(list, {}))\n-  const [currentPage, setCurrentPage] = useState<number>(() => getCurrentPage(list, {}))\n-  const [pageSize, setPageSize] = useState<number>(() => getPageSize(list, {}))\n+  const [currentPage, setCurrentPage] = useState<number>(1)\n+  const [pageSize, setPageSize] = useState<number>(list.pageSize)\n   const [searchString, setSearchString] = useState('')\n   const [selectedItems, setSelectedItems] = useState<SelectedKeys>(() => new Set([]))\n   const [idsForDeletion, setIdsForDeletion] = useState<Set<Key> | null>(null)\n   const dirty = useMemo(() => {\n+    const defaultFilters = getFilters(list, {})\n+    const defaultSort = getSort(list, {})\n     return (\n       !!searchString ||\n       !isDeepEqual(filters, defaultFilters) ||\n       !isDeepEqual(sort, defaultSort) ||\n       !isDeepEqual(columns, list.initialColumns)\n     )\n-  }, [searchString, filters, defaultFilters, sort, defaultSort, columns, list.initialColumns])\n+  }, [searchString, filters, sort, columns, list.initialColumns])\n \n   useEffect(() => {\n     if (!isReady) return\n@@ -305,7 +305,7 @@ function ListPage({ listKey }: ListPageProps) {\n     label: f.label,\n     isDisabled: f.listView.fieldMode === 'read',\n   }))\n-  const shownFields = columns.map(fieldKey => list.fields[fieldKey])\n+  const shownFields = columns.map(fieldKey => list.fields[fieldKey]).filter(Boolean)\n   const where = useMemo(\n     () =>\n       filters.map(filter => {\n@@ -390,6 +390,8 @@ function ListPage({ listKey }: ListPageProps) {\n   }\n \n   function resetToDefaults() {\n+    const defaultFilters = getFilters(list, {})\n+    const defaultSort = getSort(list, {})\n     setSearchString('')\n     setColumns(list.initialColumns)\n     setFilters(defaultFilters)\n@@ -406,9 +408,8 @@ function ListPage({ listKey }: ListPageProps) {\n           <SearchField\n             aria-label=\"Search\"\n             isDisabled={isEmpty}\n-            // label={`Search by ${searchLabels.length ? searchLabels.join(', ') : 'ID'}`}\n             onClear={() => setSearchString('')}\n-            onChange={v => setSearchString(v.trim())}\n+            onChange={v => setSearchString(v)}\n             placeholder=\"Search\u2026\"\n             value={searchString}\n             width=\"alias.singleLineWidth\"\n@@ -567,16 +568,15 @@ function ListPage({ listKey }: ListPageProps) {\n         </ActionBarContainer>\n \n         {!!data?.count && (\n-          <Pagination\n+          <PaginationControls\n             singular={list.singular}\n             plural={list.plural}\n             currentPage={currentPage}\n             pageSize={pageSize}\n             total={data.count}\n-            onChange={(page, pageSize) => {\n-              setCurrentPage(page)\n-              setPageSize(pageSize)\n-            }}\n+            onChangePage={(page: number) => setCurrentPage(page)}\n+            onChangePageSize={(pageSize: number) => setPageSize(pageSize)}\n+            defaultPageSize={list.pageSize}\n           />\n         )}\n \ndiff --git a/packages/core/src/admin-ui/components/Navigation.tsx b/packages/core/src/admin-ui/components/Navigation.tsx\nindex 681a415e51a..ddafe886e65 100644\n--- a/packages/core/src/admin-ui/components/Navigation.tsx\n+++ b/packages/core/src/admin-ui/components/Navigation.tsx\n@@ -81,9 +81,8 @@ export function NavContainer({ children }: PropsWithChildren) {\n \n /** @private Exported for internal consumption only. */\n export function Navigation() {\n-  const { adminMeta, adminConfig } = useKeystone()\n-  const lists = Object.values(adminMeta?.lists ?? [])\n-  const visibleLists = lists.filter(x => !x.hideNavigation)\n+  const { adminConfig, lists: allLists } = useKeystone()\n+  const visibleLists = Object.values(allLists).filter(x => !x.hideNavigation)\n \n   if (adminConfig?.components?.Navigation)\n     return <adminConfig.components.Navigation lists={visibleLists} />\ndiff --git a/packages/core/src/admin-ui/context.tsx b/packages/core/src/admin-ui/context.tsx\nindex 7cc3a603c30..c39b848ff59 100644\n--- a/packages/core/src/admin-ui/context.tsx\n+++ b/packages/core/src/admin-ui/context.tsx\n@@ -1,36 +1,36 @@\n-import { type ReactNode, createContext, useContext, useEffect, useMemo } from 'react'\n-import NextHead from 'next/head'\n import { createUploadLink } from 'apollo-upload-client'\n+import NextHead from 'next/head'\n+import { type ReactNode, createContext, useContext, useEffect, useMemo } from 'react'\n \n import { ClientSideOnlyDocumentElement, KeystarProvider } from '@keystar/ui/core'\n-import { Toaster } from '@keystar/ui/toast'\n import { injectGlobal, tokenSchema } from '@keystar/ui/style'\n-\n+import { Toaster } from '@keystar/ui/toast'\n import { useRouter } from '@keystone-6/core/admin-ui/router'\n \n+import { snapValueToClosest } from '../___internal-do-not-use-will-break-in-patch/admin-ui/pages/ListPage/PaginationControls'\n import type {\n   AdminConfig,\n-  AdminMeta,\n   BaseListTypeInfo,\n   ConditionalFieldFilter,\n   ConditionalFieldFilterCase,\n   FieldViews,\n+  ListMeta,\n } from '../types'\n import { type AdminMetaQuery, adminMetaQuery } from './admin-meta-graphql'\n import type { QueryResult } from './apollo'\n-import { gql, ApolloProvider, ApolloClient, InMemoryCache, useQuery } from './apollo'\n+import { ApolloClient, ApolloProvider, InMemoryCache, gql, useQuery } from './apollo'\n \n type KeystoneContextType = {\n   adminConfig: AdminConfig | null\n-  adminMeta: AdminMeta | null\n+  lists: { [list: string]: ListMeta }\n   apiPath: string | null\n   fieldViews: FieldViews\n }\n \n const KeystoneContext = createContext<KeystoneContextType>({\n   adminConfig: null,\n-  adminMeta: null,\n   apiPath: null,\n+  lists: {},\n   fieldViews: {},\n })\n \n@@ -52,18 +52,17 @@ function InternalKeystoneProvider({\n   const { push: navigate } = useRouter()\n   const keystarRouter = useMemo(() => ({ navigate }), [navigate])\n   const { data, loading, error } = useQuery<AdminMetaQuery>(adminMetaQuery)\n-  const lists = data?.keystone?.adminMeta?.lists\n-  const meta = useMemo(() => {\n-    if (!lists) return\n+  const listsData = data?.keystone?.adminMeta?.lists\n+  const lists = useMemo(() => {\n+    if (!listsData) return\n     if (error) return\n \n-    const result: AdminMeta = {\n-      lists: {},\n-    }\n+    const lists: KeystoneContextType['lists'] = {}\n \n-    for (const list of lists) {\n-      result.lists[list.key] = {\n+    for (const list of listsData) {\n+      lists[list.key] = {\n         ...list,\n+        pageSize: snapValueToClosest(list.pageSize ?? 50),\n         groups: [],\n         fields: {},\n       }\n@@ -92,7 +91,7 @@ function InternalKeystoneProvider({\n           }\n         }\n \n-        result.lists[list.key].fields[field.key] = {\n+        lists[list.key].fields[field.key] = {\n           ...field,\n           createView: {\n             fieldMode: field.createView?.fieldMode ?? null,\n@@ -122,16 +121,16 @@ function InternalKeystoneProvider({\n       }\n \n       for (const group of list.groups) {\n-        result.lists[list.key].groups.push({\n+        lists[list.key].groups.push({\n           label: group.label,\n           description: group.description,\n-          fields: group.fields.map(field => result.lists[list.key].fields[field.key]),\n+          fields: group.fields.map(field => lists[list.key].fields[field.key]),\n         })\n       }\n     }\n \n-    return result\n-  }, [lists, error, fieldViews])\n+    return lists\n+  }, [listsData, error, fieldViews])\n \n   // TODO: remove this once studio is fully migrated to keystar-ui\n   useEffect(() => {\n@@ -168,9 +167,9 @@ function InternalKeystoneProvider({\n       <KeystoneContext.Provider\n         value={{\n           adminConfig,\n-          adminMeta: meta ?? null,\n-          fieldViews,\n           apiPath,\n+          lists: lists ?? {},\n+          fieldViews,\n         }}\n       >\n         {children}\n@@ -212,8 +211,7 @@ export function useKeystone() {\n }\n \n export function useList(listKey: string) {\n-  const { adminMeta } = useKeystone()\n-  const { lists } = adminMeta ?? {}\n+  const { lists } = useKeystone()\n   const list = lists?.[listKey]\n   if (!list) throw new Error(`Unknown list ${listKey}`)\n   return list\ndiff --git a/packages/core/src/fields/types/relationship/views/ContextualActions.tsx b/packages/core/src/fields/types/relationship/views/ContextualActions.tsx\nindex fc30a811b10..74c3da320d5 100644\n--- a/packages/core/src/fields/types/relationship/views/ContextualActions.tsx\n+++ b/packages/core/src/fields/types/relationship/views/ContextualActions.tsx\n@@ -135,5 +135,5 @@ export function buildQueryForRelationshipFieldWithForeignField(\n ) {\n   const foreignField = foreignList.fields[refFieldKey]\n   const foreignMany: boolean = (foreignField.fieldMeta as any).many\n-  return `!${refFieldKey}_${foreignMany ? 'some' : 'is'}=${JSON.stringify(foreignMany ? [localId] : localId)}`\n+  return `filter=${refFieldKey}_${foreignMany ? 'some' : 'is'}_${JSON.stringify(foreignMany ? [localId] : localId)}`\n }\ndiff --git a/packages/core/src/fields/types/relationship/views/useFilter.tsx b/packages/core/src/fields/types/relationship/views/useFilter.tsx\nindex ea4a5bba42a..00bd908436a 100644\n--- a/packages/core/src/fields/types/relationship/views/useFilter.tsx\n+++ b/packages/core/src/fields/types/relationship/views/useFilter.tsx\n@@ -24,8 +24,7 @@ function isUuid(x: unknown) {\n }\n \n export function useSearchFilter(value: string, list: ListMeta, searchFields: string[]) {\n-  const { adminMeta } = useKeystone()\n-  const { lists = {} } = adminMeta ?? {}\n+  const { lists } = useKeystone()\n   return useMemo(() => {\n     const trimmedSearch = value.trim()\n     if (!trimmedSearch.length) return { OR: [] }\ndiff --git a/packages/core/src/types/admin-meta.ts b/packages/core/src/types/admin-meta.ts\nindex 007c69c1c06..df85fd663a9 100644\n--- a/packages/core/src/types/admin-meta.ts\n+++ b/packages/core/src/types/admin-meta.ts\n@@ -133,10 +133,6 @@ export type ListMeta = {\n   hideDelete: boolean\n }\n \n-export type AdminMeta = {\n-  lists: { [list: string]: ListMeta }\n-}\n-\n export type Item = {\n   [key: string]: unknown\n }\ndiff --git a/tests/admin-ui-tests/relations.test.ts b/tests/admin-ui-tests/relations.test.ts\nindex 0043de91408..db8a3fb1c0f 100644\n--- a/tests/admin-ui-tests/relations.test.ts\n+++ b/tests/admin-ui-tests/relations.test.ts\n@@ -30,16 +30,13 @@ adminUITests('./tests/test-projects/basic', browserType => {\n       headers: { 'Content-Type': 'application/json' },\n       body: JSON.stringify({\n         query: gql`\n-          mutation ($people: [PersonCreateInput!]!) {\n-            createPeople(data: $people) {\n-              id\n-            }\n-            createTask(data: { label: \"some task\", assignedTo: { create: { name: \"the user\" } } }) {\n+          mutation {\n+            createTask(data: { label: \"A task\", assignedTo: { create: { name: \"A user\" } } }) {\n               id\n             }\n           }\n         `,\n-        variables: { people: Array.from({ length: 500 }, (_, i) => ({ name: `Person ${i}` })) },\n+        variables: {},\n       }),\n     }).then(res => res.json())\n     expect(result.errors).toBeUndefined()\n@@ -47,10 +44,40 @@ adminUITests('./tests/test-projects/basic', browserType => {\n     await page.goto(`http://localhost:3000/tasks/${result.data.createTask.id}`)\n     await page.getByRole('combobox', { name: 'Assigned To' }).click()\n     await page.getByRole('textbox', { name: 'Label' }).click()\n-    await expect(page.getByRole('combobox', { name: 'Assigned To' })).toHaveValue('the user')\n+    await expect(page.getByRole('combobox', { name: 'Assigned To' })).toHaveValue('A user')\n     await expect(page.getByRole('button', { name: 'Save' })).toBeDisabled()\n   })\n \n+  test('view related relationships on the item page filters the list view', async () => {\n+    const result = await fetch('http://localhost:3000/api/graphql', {\n+      method: 'POST',\n+      headers: { 'Content-Type': 'application/json' },\n+      body: JSON.stringify({\n+        query: gql`\n+          mutation {\n+            createTask(data: { label: \"My task\", assignedTo: { create: { name: \"My user\" } } }) {\n+              id\n+              assignedTo {\n+                id\n+              }\n+            }\n+          }\n+        `,\n+        variables: {},\n+      }),\n+    }).then(res => res.json())\n+    expect(result.errors).toBeUndefined()\n+\n+    await page.goto(`http://localhost:3000/people/${result.data.createTask.assignedTo.id}`)\n+    await page.getByRole('button', { name: 'Actions for Tasks' }).click()\n+    await page.getByText('View related').click()\n+    await page.waitForURL(\n+      `http://localhost:3000/tasks?filter=assignedTo_is_\"${result.data.createTask.assignedTo.id}\"`\n+    )\n+    await page.getByText('My task').waitFor()\n+    await expect(page.getByText('A task')).toBeHidden()\n+  })\n+\n   afterAll(async () => {\n     await browser.close()\n   })\n", "test_patch": "", "problem_statement": "", "hints_text": "", "created_at": "2025-07-29T03:51:56Z", "issue_numbers": []}
