{"instance_id": "dubinc__dub.main.3171", "repo": "dubinc/dub", "base_commit": "d126bfc73138f802e31d8f4a262cc32d683a3211", "head_commit": "241b62c6cd801c416e22783ed2b505cb9376f683", "title": "Fix the Fraud tests", "merged_at": "2025-11-28T20:19:27Z", "html_url": "https://github.com/dubinc/dub/pull/3171", "test_files": ["apps/web/tests/fraud/index.test.ts"], "code_files": ["apps/web/lib/middleware/utils/get-identity-hash.ts", "apps/web/tests/utils/resource.ts"], "total_changes": 58, "num_files": 3, "pull_number": 3171, "patch": "diff --git a/apps/web/lib/middleware/utils/get-identity-hash.ts b/apps/web/lib/middleware/utils/get-identity-hash.ts\nindex 4ef076bd688..4609fff0fdf 100644\n--- a/apps/web/lib/middleware/utils/get-identity-hash.ts\n+++ b/apps/web/lib/middleware/utils/get-identity-hash.ts\n@@ -1,24 +1,11 @@\n import { LOCALHOST_IP, hashStringSHA256 } from \"@dub/utils\";\n import { ipAddress } from \"@vercel/functions\";\n import { userAgent } from \"next/server\";\n-import { DUB_TEST_IDENTITY_HEADER } from \"tests/utils/resource\";\n \n /**\n  * Combine IP + UA to create a unique identifier for the user (for deduplication)\n  */\n export async function getIdentityHash(req: Request) {\n-  // If provided, use this identity directly (for E2E)\n-  if (\n-    process.env.NODE_ENV === \"development\" ||\n-    process.env.VERCEL_ENV === \"preview\"\n-  ) {\n-    const testOverride = req.headers.get(DUB_TEST_IDENTITY_HEADER);\n-\n-    if (testOverride) {\n-      return await hashStringSHA256(testOverride);\n-    }\n-  }\n-\n   const ip = ipAddress(req) || LOCALHOST_IP;\n   const ua = userAgent(req);\n   return await hashStringSHA256(`${ip}-${ua.ua}`);\ndiff --git a/apps/web/tests/fraud/index.test.ts b/apps/web/tests/fraud/index.test.ts\nindex e788eec903e..53b5aa38d47 100644\n--- a/apps/web/tests/fraud/index.test.ts\n+++ b/apps/web/tests/fraud/index.test.ts\n@@ -1,9 +1,8 @@\n import { Customer, fraudEventGroupProps, TrackLeadResponse } from \"@/lib/types\";\n import { FraudRuleType } from \"@prisma/client\";\n-import { randomCustomer, randomId, retry } from \"tests/utils/helpers\";\n+import { randomCustomer, retry } from \"tests/utils/helpers\";\n import { HttpClient } from \"tests/utils/http\";\n import {\n-  DUB_TEST_IDENTITY_HEADER,\n   E2E_FRAUD_PARTNER,\n   E2E_FRAUD_REFERRAL_SOURCE_BANNED_DOMAIN,\n   E2E_TRACK_CLICK_HEADERS,\n@@ -16,14 +15,13 @@ describe.concurrent(\"/fraud/**\", async () => {\n   const { http } = await h.init();\n \n   test(\"FraudRuleType = customerEmailMatch\", async () => {\n-    const clickLink = E2E_FRAUD_PARTNER.link;\n+    const clickLink = E2E_FRAUD_PARTNER.links.customerEmailMatch;\n \n     // Track a click\n     const clickResponse = await http.post<{ clickId: string }>({\n       path: \"/track/click\",\n       headers: {\n         ...E2E_TRACK_CLICK_HEADERS,\n-        [DUB_TEST_IDENTITY_HEADER]: randomId(10),\n       },\n       body: {\n         domain: clickLink.domain,\n@@ -59,14 +57,13 @@ describe.concurrent(\"/fraud/**\", async () => {\n   });\n \n   test(\"FraudRuleType = customerEmailSuspiciousDomain\", async () => {\n-    const clickLink = E2E_FRAUD_PARTNER.link;\n+    const clickLink = E2E_FRAUD_PARTNER.links.customerEmailSuspiciousDomain;\n \n     // Track a click\n     const clickResponse = await http.post<{ clickId: string }>({\n       path: \"/track/click\",\n       headers: {\n         ...E2E_TRACK_CLICK_HEADERS,\n-        [DUB_TEST_IDENTITY_HEADER]: randomId(10),\n       },\n       body: {\n         domain: clickLink.domain,\n@@ -99,7 +96,7 @@ describe.concurrent(\"/fraud/**\", async () => {\n   });\n \n   test(\"FraudRuleType = referralSourceBanned\", async () => {\n-    const clickLink = E2E_FRAUD_PARTNER.link;\n+    const clickLink = E2E_FRAUD_PARTNER.links.referralSourceBanned;\n \n     // Track a click\n     const clickResponse = await http.post<{ clickId: string }>({\n@@ -107,7 +104,6 @@ describe.concurrent(\"/fraud/**\", async () => {\n       headers: {\n         ...E2E_TRACK_CLICK_HEADERS,\n         referer: `https://${E2E_FRAUD_REFERRAL_SOURCE_BANNED_DOMAIN}`,\n-        [DUB_TEST_IDENTITY_HEADER]: randomId(10),\n       },\n       body: {\n         domain: clickLink.domain,\n@@ -140,14 +136,13 @@ describe.concurrent(\"/fraud/**\", async () => {\n   });\n \n   test(\"FraudRuleType = paidTrafficDetected\", async () => {\n-    const clickLink = E2E_FRAUD_PARTNER.link;\n+    const clickLink = E2E_FRAUD_PARTNER.links.paidTrafficDetected;\n \n     // Track a click\n     const clickResponse = await http.post<{ clickId: string }>({\n       path: \"/track/click\",\n       headers: {\n         ...E2E_TRACK_CLICK_HEADERS,\n-        [DUB_TEST_IDENTITY_HEADER]: randomId(10),\n       },\n       body: {\n         domain: clickLink.domain,\ndiff --git a/apps/web/tests/utils/resource.ts b/apps/web/tests/utils/resource.ts\nindex d942699cb5e..94685c462e2 100644\n--- a/apps/web/tests/utils/resource.ts\n+++ b/apps/web/tests/utils/resource.ts\n@@ -8,16 +8,6 @@ export const E2E_LINK = {\n   url: \"https://github.com/dubinc\",\n };\n \n-/**\n- * Used exclusively in E2E tests to override the computed identity hash.\n- * When this header is present, `getIdentityHash()` will use its value\n- * as the hash input instead of relying on the real IP/User-Agent.\n- *\n- * This prevents deduplication during automated tests where multiple\n- * requests originate from the same IP and UA.\n- */\n-export const DUB_TEST_IDENTITY_HEADER = \"x-dub-test-identity\";\n-\n export const E2E_TRACK_CLICK_HEADERS = {\n   referer: \"https://dub.co\",\n   \"User-Agent\":\n@@ -220,9 +210,23 @@ export const E2E_CUSTOMERS = [\n export const E2E_FRAUD_PARTNER = {\n   id: \"pn_1K8ND11BZ4XPEX39QX3YMBGY0\",\n   email: \"kiran+e2e+1@dub.co\",\n-  link: {\n-    domain: \"getacme.link\",\n-    key: \"kiran-e2e-1\",\n+  links: {\n+    customerEmailMatch: {\n+      domain: \"getacme.link\",\n+      key: \"fraud-customer-match\",\n+    },\n+    customerEmailSuspiciousDomain: {\n+      domain: \"getacme.link\",\n+      key: \"fraud-customer-suspicious\",\n+    },\n+    referralSourceBanned: {\n+      domain: \"getacme.link\",\n+      key: \"fraud-referral-source-banned\",\n+    },\n+    paidTrafficDetected: {\n+      domain: \"getacme.link\",\n+      key: \"fraud-paid-traffic\",\n+    },\n   },\n } as const;\n \n"}
{"instance_id": "dubinc__dub.main.3166", "repo": "dubinc/dub", "base_commit": "beac3b75f8feb4b1a78fd33801c5544adbfaaad9", "head_commit": "80cd6686263776db53a8e3c339f82f199bd2f76b", "title": "Retry stripe payouts after account verification", "merged_at": "2025-11-27T07:50:16Z", "html_url": "https://github.com/dubinc/dub/pull/3166", "test_files": ["apps/web/tests/fraud/index.test.ts"], "code_files": ["apps/web/app/(ee)/api/stripe/connect/webhook/account-updated.ts"], "total_changes": 30, "num_files": 2, "pull_number": 3166, "patch": "diff --git a/apps/web/app/(ee)/api/stripe/connect/webhook/account-updated.ts b/apps/web/app/(ee)/api/stripe/connect/webhook/account-updated.ts\nindex dc63bac2cde..dc9e139f5ba 100644\n--- a/apps/web/app/(ee)/api/stripe/connect/webhook/account-updated.ts\n+++ b/apps/web/app/(ee)/api/stripe/connect/webhook/account-updated.ts\n@@ -1,9 +1,14 @@\n import { createFraudEvents } from \"@/lib/api/fraud/create-fraud-events\";\n+import { qstash } from \"@/lib/cron\";\n import { stripe } from \"@/lib/stripe\";\n import { prisma } from \"@dub/prisma\";\n-import { log } from \"@dub/utils\";\n+import { APP_DOMAIN_WITH_NGROK, log } from \"@dub/utils\";\n import Stripe from \"stripe\";\n \n+const queue = qstash.queue({\n+  queueName: \"withdraw-stripe-balance\",\n+});\n+\n export async function accountUpdated(event: Stripe.Event) {\n   const account = event.data.object as Stripe.Account;\n \n@@ -110,5 +115,26 @@ export async function accountUpdated(event: Stripe.Event) {\n     }\n   }\n \n+  // Retry payouts that got stuck when the account was restricted (e.g: payout sent but paused\n+  // due to verification requirements). Once payouts are re-enabled, queue them for processing.\n+  const pendingPayouts = await prisma.payout.count({\n+    where: {\n+      partnerId: partner.id,\n+      status: \"sent\",\n+      mode: \"internal\",\n+    },\n+  });\n+\n+  if (pendingPayouts > 0) {\n+    await queue.enqueueJSON({\n+      url: `${APP_DOMAIN_WITH_NGROK}/api/cron/payouts/balance-available`,\n+      deduplicationId: event.id,\n+      method: \"POST\",\n+      body: {\n+        stripeAccount: partner.stripeConnectId,\n+      },\n+    });\n+  }\n+\n   return `Updated partner ${partner.email} (${partner.stripeConnectId}) with country ${country}, payoutsEnabledAt set, payoutMethodHash ${defaultExternalAccount.fingerprint}`;\n }\ndiff --git a/apps/web/tests/fraud/index.test.ts b/apps/web/tests/fraud/index.test.ts\nindex 27354a54165..e788eec903e 100644\n--- a/apps/web/tests/fraud/index.test.ts\n+++ b/apps/web/tests/fraud/index.test.ts\n@@ -254,6 +254,6 @@ async function waitForFraudEvent({\n \n       return data[0];\n     },\n-    { retries: 10, interval: 300 },\n+    { retries: 10, interval: 600 },\n   );\n }\n"}
{"instance_id": "dubinc__dub.main.3157", "repo": "dubinc/dub", "base_commit": "63b1aa50622b3ebb8d0e25f8e808a3617ac8ecef", "head_commit": "9b96829db9afc48b068b9f86f66e6ea890db785c", "title": "Catch R2 upload error to avoid breaking conversion tracking", "merged_at": "2025-11-26T03:57:36Z", "html_url": "https://github.com/dubinc/dub/pull/3157", "test_files": ["apps/web/tests/fraud/index.test.ts"], "code_files": ["apps/web/app/(ee)/api/customers/[id]/route.ts", "apps/web/app/(ee)/api/customers/route.ts", "apps/web/lib/api/conversions/track-lead.ts", "apps/web/lib/api/conversions/track-sale.ts", "apps/web/lib/openapi/customers/create-customer.ts", "apps/web/lib/openapi/customers/index.ts"], "total_changes": 147, "num_files": 7, "pull_number": 3157, "patch": "diff --git a/apps/web/app/(ee)/api/customers/[id]/route.ts b/apps/web/app/(ee)/api/customers/[id]/route.ts\nindex c071e34e861..6e15be6f9c6 100644\n--- a/apps/web/app/(ee)/api/customers/[id]/route.ts\n+++ b/apps/web/app/(ee)/api/customers/[id]/route.ts\n@@ -96,21 +96,30 @@ export const PATCH = withWorkspace(\n \n       if (avatar && !isStored(avatar) && finalCustomerAvatar) {\n         waitUntil(\n-          Promise.allSettled([\n-            storage.upload({\n+          storage\n+            .upload({\n               key: finalCustomerAvatar.replace(`${R2_URL}/`, \"\"),\n               body: avatar,\n               opts: {\n                 width: 128,\n                 height: 128,\n               },\n+            })\n+            .then(() => {\n+              if (oldCustomerAvatar && isStored(oldCustomerAvatar)) {\n+                storage.delete({\n+                  key: oldCustomerAvatar.replace(`${R2_URL}/`, \"\"),\n+                });\n+              }\n+            })\n+            .catch(async (error) => {\n+              console.error(\"Error persisting customer avatar to R2\", error);\n+              // if the avatar fails to upload to R2, set the avatar to null in the database\n+              await prisma.customer.update({\n+                where: { id: customer.id },\n+                data: { avatar: null },\n+              });\n             }),\n-            oldCustomerAvatar &&\n-              isStored(oldCustomerAvatar) &&\n-              storage.delete({\n-                key: oldCustomerAvatar.replace(`${R2_URL}/`, \"\"),\n-              }),\n-          ]),\n         );\n       }\n \ndiff --git a/apps/web/app/(ee)/api/customers/route.ts b/apps/web/app/(ee)/api/customers/route.ts\nindex e8583bd759a..ecdeb52892c 100644\n--- a/apps/web/app/(ee)/api/customers/route.ts\n+++ b/apps/web/app/(ee)/api/customers/route.ts\n@@ -165,14 +165,27 @@ export const POST = withWorkspace(\n \n       if (avatar && !isStored(avatar) && finalCustomerAvatar) {\n         waitUntil(\n-          storage.upload({\n-            key: finalCustomerAvatar.replace(`${R2_URL}/`, \"\"),\n-            body: avatar,\n-            opts: {\n-              width: 128,\n-              height: 128,\n-            },\n-          }),\n+          storage\n+            .upload({\n+              key: finalCustomerAvatar.replace(`${R2_URL}/`, \"\"),\n+              body: avatar,\n+              opts: {\n+                width: 128,\n+                height: 128,\n+              },\n+            })\n+            .catch(async (error) => {\n+              console.error(\"Error persisting customer avatar to R2\", error);\n+              // if the avatar fails to upload to R2, set the avatar to null in the database\n+              await prisma.customer.update({\n+                where: {\n+                  id: customer.id,\n+                },\n+                data: {\n+                  avatar: null,\n+                },\n+              });\n+            }),\n         );\n       }\n \ndiff --git a/apps/web/lib/api/conversions/track-lead.ts b/apps/web/lib/api/conversions/track-lead.ts\nindex efe241234de..f940dafe4e4 100644\n--- a/apps/web/lib/api/conversions/track-lead.ts\n+++ b/apps/web/lib/api/conversions/track-lead.ts\n@@ -238,14 +238,25 @@ export const trackLead = async ({\n           finalCustomerAvatar\n         ) {\n           // persist customer avatar to R2\n-          await storage.upload({\n-            key: finalCustomerAvatar.replace(`${R2_URL}/`, \"\"),\n-            body: customerAvatar,\n-            opts: {\n-              width: 128,\n-              height: 128,\n-            },\n-          });\n+          await storage\n+            .upload({\n+              key: finalCustomerAvatar.replace(`${R2_URL}/`, \"\"),\n+              body: customerAvatar,\n+              opts: {\n+                width: 128,\n+                height: 128,\n+              },\n+            })\n+            .catch(async (error) => {\n+              console.error(\"Error persisting customer avatar to R2\", error);\n+              // if the avatar fails to upload to R2, set the avatar to null in the database\n+              if (customer) {\n+                await prisma.customer.update({\n+                  where: { id: customer.id },\n+                  data: { avatar: null },\n+                });\n+              }\n+            });\n         }\n \n         // if not deferred mode, process the following right away:\ndiff --git a/apps/web/lib/api/conversions/track-sale.ts b/apps/web/lib/api/conversions/track-sale.ts\nindex 87bc7613326..a6edaa83b05 100644\n--- a/apps/web/lib/api/conversions/track-sale.ts\n+++ b/apps/web/lib/api/conversions/track-sale.ts\n@@ -214,14 +214,25 @@ export const trackSale = async ({\n     if (customerAvatar && !isStored(customerAvatar) && finalCustomerAvatar) {\n       // persist customer avatar to R2 if it's not already stored\n       waitUntil(\n-        storage.upload({\n-          key: finalCustomerAvatar.replace(`${R2_URL}/`, \"\"),\n-          body: customerAvatar,\n-          opts: {\n-            width: 128,\n-            height: 128,\n-          },\n-        }),\n+        storage\n+          .upload({\n+            key: finalCustomerAvatar.replace(`${R2_URL}/`, \"\"),\n+            body: customerAvatar,\n+            opts: {\n+              width: 128,\n+              height: 128,\n+            },\n+          })\n+          .catch(async (error) => {\n+            console.error(\"Error persisting customer avatar to R2\", error);\n+            // if the avatar fails to upload to R2, set the avatar to null in the database\n+            if (newCustomer) {\n+              await prisma.customer.update({\n+                where: { id: newCustomer.id },\n+                data: { avatar: null },\n+              });\n+            }\n+          }),\n       );\n     }\n \ndiff --git a/apps/web/lib/openapi/customers/create-customer.ts b/apps/web/lib/openapi/customers/create-customer.ts\ndeleted file mode 100644\nindex d80e6f70abf..00000000000\n--- a/apps/web/lib/openapi/customers/create-customer.ts\n+++ /dev/null\n@@ -1,35 +0,0 @@\n-import { openApiErrorResponses } from \"@/lib/openapi/responses\";\n-import { ZodOpenApiOperationObject } from \"zod-openapi\";\n-import {\n-  createCustomerBodySchema,\n-  CustomerEnrichedSchema,\n-} from \"../../zod/schemas/customers\";\n-\n-export const createCustomer: ZodOpenApiOperationObject = {\n-  operationId: \"createCustomer\",\n-  \"x-speakeasy-name-override\": \"create\",\n-  summary: \"Create a customer\",\n-  description:\n-    \"[Deprecated]: Customer creation can only be done via tracking a lead event. Use the /track/lead endpoint instead.\",\n-  deprecated: true,\n-  requestBody: {\n-    content: {\n-      \"application/json\": {\n-        schema: createCustomerBodySchema,\n-      },\n-    },\n-  },\n-  responses: {\n-    \"201\": {\n-      description: \"The customer was created.\",\n-      content: {\n-        \"application/json\": {\n-          schema: CustomerEnrichedSchema,\n-        },\n-      },\n-    },\n-    ...openApiErrorResponses,\n-  },\n-  tags: [\"Customers\"],\n-  security: [{ token: [] }],\n-};\ndiff --git a/apps/web/lib/openapi/customers/index.ts b/apps/web/lib/openapi/customers/index.ts\nindex 0cc5eb085f0..dd5015a8c3f 100644\n--- a/apps/web/lib/openapi/customers/index.ts\n+++ b/apps/web/lib/openapi/customers/index.ts\n@@ -1,5 +1,4 @@\n import { ZodOpenApiPathsObject } from \"zod-openapi\";\n-import { createCustomer } from \"./create-customer\";\n import { deleteCustomer } from \"./delete-customer\";\n import { getCustomer } from \"./get-customer\";\n import { getCustomers } from \"./get-customers\";\n@@ -8,7 +7,6 @@ import { updateCustomer } from \"./update-customer\";\n export const customersPaths: ZodOpenApiPathsObject = {\n   \"/customers\": {\n     get: getCustomers,\n-    post: createCustomer,\n   },\n   \"/customers/{id}\": {\n     get: getCustomer,\ndiff --git a/apps/web/tests/fraud/index.test.ts b/apps/web/tests/fraud/index.test.ts\nindex 5ec68ae360c..cc2c5c50afc 100644\n--- a/apps/web/tests/fraud/index.test.ts\n+++ b/apps/web/tests/fraud/index.test.ts\n@@ -11,7 +11,7 @@ import {\n import { describe, expect, test } from \"vitest\";\n import { IntegrationHarness } from \"../utils/integration\";\n \n-describe.concurrent(\"/fraud/**\", async () => {\n+describe.skip.concurrent(\"/fraud/**\", async () => {\n   const h = new IntegrationHarness();\n   const { http } = await h.init();\n \n"}
{"instance_id": "dubinc__dub.main.3036", "repo": "dubinc/dub", "base_commit": "6784533571d3339f600df223f9c3981d71a6b9a2", "head_commit": "46bb84dcc801607b8b285be7453b6023a633067f", "title": "Groups tests", "merged_at": "2025-10-31T17:46:03Z", "html_url": "https://github.com/dubinc/dub/pull/3036", "test_files": ["apps/web/tests/partner-groups/index.test.ts"], "code_files": ["apps/web/lib/types.ts", "apps/web/ui/modals/delete-group-modal.tsx"], "total_changes": 168, "num_files": 3, "pull_number": 3036, "patch": "diff --git a/apps/web/lib/types.ts b/apps/web/lib/types.ts\nindex e49bf22c85a..93e1b0674fe 100644\n--- a/apps/web/lib/types.ts\n+++ b/apps/web/lib/types.ts\n@@ -442,7 +442,6 @@ export type PartnerProps = z.infer<typeof PartnerSchema> & {\n };\n \n export type PartnerUserProps = z.infer<typeof partnerUserSchema>;\n-\n export type PartnerProfileCustomerProps = z.infer<\n   typeof PartnerProfileCustomerSchema\n >;\n@@ -480,7 +479,6 @@ export type ProgramApplicationFormDataWithValues = z.infer<\n export type ProgramApplicationFormFieldWithValues = z.infer<\n   typeof programApplicationFormFieldWithValuesSchema\n >;\n-\n export type ProgramEnrollmentProps = z.infer<typeof ProgramEnrollmentSchema>;\n \n export type PayoutsCount = {\ndiff --git a/apps/web/tests/partner-groups/index.test.ts b/apps/web/tests/partner-groups/index.test.ts\nnew file mode 100644\nindex 00000000000..42c4770621c\n--- /dev/null\n+++ b/apps/web/tests/partner-groups/index.test.ts\n@@ -0,0 +1,162 @@\n+import { generateRandomName } from \"@/lib/names\";\n+import {\n+  GroupExtendedProps,\n+  GroupProps,\n+  GroupWithProgramProps,\n+} from \"@/lib/types\";\n+import { GroupSchema } from \"@/lib/zod/schemas/groups\";\n+import { RESOURCE_COLORS } from \"@/ui/colors\";\n+import { randomValue } from \"@dub/utils\";\n+import slugify from \"@sindresorhus/slugify\";\n+import { describe, expect, test } from \"vitest\";\n+import { IntegrationHarness } from \"../utils/integration\";\n+\n+const expectedGroup: Partial<GroupProps> = {\n+  id: expect.any(String),\n+  name: expect.any(String),\n+  slug: expect.any(String),\n+  color: expect.any(String),\n+  clickReward: null,\n+  leadReward: null,\n+  saleReward: null,\n+  discount: null,\n+  maxPartnerLinks: 10,\n+  linkStructure: \"short\",\n+  additionalLinks: expect.any(Array),\n+};\n+\n+describe.sequential(\"/groups/**\", async () => {\n+  const h = new IntegrationHarness();\n+  const { http } = await h.init();\n+\n+  let group: GroupProps;\n+\n+  test(\"POST /groups - create group\", async () => {\n+    const groupName = generateRandomName();\n+\n+    const newGroup = {\n+      name: `E2E-${groupName}`,\n+      slug: slugify(groupName),\n+      color: randomValue(RESOURCE_COLORS),\n+    };\n+\n+    const { status, data } = await http.post<GroupProps>({\n+      path: \"/groups\",\n+      body: newGroup,\n+    });\n+\n+    expect(status).toEqual(201);\n+    expect(() => GroupSchema.parse(data)).not.toThrow();\n+    expect(data).toStrictEqual({\n+      ...expectedGroup,\n+      ...newGroup,\n+    });\n+\n+    group = data;\n+  });\n+\n+  test(\"GET /groups/[groupId] - fetch single group\", async () => {\n+    const { status, data } = await http.get<GroupWithProgramProps>({\n+      path: `/groups/${group.id}`,\n+    });\n+\n+    const {\n+      applicationFormData,\n+      applicationFormPublishedAt,\n+      landerData,\n+      landerPublishedAt,\n+      program,\n+      ...fetchedGroup\n+    } = data;\n+\n+    expect(status).toEqual(200);\n+    expect(fetchedGroup).toStrictEqual({\n+      ...group,\n+      utmTemplate: null,\n+    });\n+  });\n+\n+  test(\"PATCH /groups/[groupId] - update group\", async () => {\n+    const toUpdate = {\n+      name: `E2E-${generateRandomName()}`,\n+      color: randomValue(RESOURCE_COLORS),\n+      maxPartnerLinks: 5,\n+      linkStructure: \"query\",\n+      additionalLinks: [\n+        {\n+          domain: \"example.com\",\n+          path: \"\",\n+          validationMode: \"domain\",\n+        },\n+        {\n+          domain: \"acme.com\",\n+          path: \"/products\",\n+          validationMode: \"exact\",\n+        },\n+      ],\n+    };\n+\n+    const { status, data: updatedGroup } = await http.patch<GroupProps>({\n+      path: `/groups/${group.id}`,\n+      body: toUpdate,\n+    });\n+\n+    expect(status).toEqual(200);\n+    expect(updatedGroup).toStrictEqual({\n+      ...group,\n+      ...toUpdate,\n+    });\n+\n+    group = updatedGroup;\n+  });\n+\n+  test(\"GET /groups - fetch all groups\", async () => {\n+    const { status, data: groups } = await http.get<GroupExtendedProps[]>({\n+      path: \"/groups\",\n+    });\n+\n+    expect(status).toEqual(200);\n+    expect(Array.isArray(groups)).toBe(true);\n+    expect(groups.length).toBeGreaterThan(0);\n+\n+    const fetchedGroup = groups.find((g) => g.id === group.id);\n+\n+    expect(fetchedGroup).toStrictEqual({\n+      id: group.id,\n+      name: group.name,\n+      slug: group.slug,\n+      color: group.color,\n+      additionalLinks: group.additionalLinks,\n+      maxPartnerLinks: group.maxPartnerLinks,\n+      linkStructure: group.linkStructure,\n+      totalPartners: 0,\n+      totalClicks: 0,\n+      totalLeads: 0,\n+      totalSales: 0,\n+      totalSaleAmount: 0,\n+      totalConversions: 0,\n+      totalCommissions: 0,\n+      netRevenue: 0,\n+    });\n+  });\n+\n+  test(\"DELETE /groups/[groupId] - delete group\", async () => {\n+    const { status, data } = await http.delete<{ id: string }>({\n+      path: `/groups/${group.id}`,\n+    });\n+\n+    expect(status).toEqual(200);\n+    expect(data).toStrictEqual({\n+      id: group.id,\n+    });\n+\n+    const { status: getStatus } = await http.get({\n+      path: `/groups/${group.id}`,\n+    });\n+\n+    expect(getStatus).toEqual(404);\n+  });\n+});\n+\n+// TODO(kiran):\n+// Add more test cases to test the default link creation and group move\ndiff --git a/apps/web/ui/modals/delete-group-modal.tsx b/apps/web/ui/modals/delete-group-modal.tsx\nindex f86ce304765..253b7c36e4d 100644\n--- a/apps/web/ui/modals/delete-group-modal.tsx\n+++ b/apps/web/ui/modals/delete-group-modal.tsx\n@@ -98,7 +98,7 @@ const DeleteGroupModal = ({\n                 <p className=\"block text-sm text-neutral-500\">\n                   To verify, type{\" \"}\n                   <span className=\"font-medium text-neutral-700\">\n-                    Delete group\n+                    confirm delete group\n                   </span>{\" \"}\n                   below\n                 </p>\n@@ -113,7 +113,7 @@ const DeleteGroupModal = ({\n                     className=\"block w-full rounded-md border-neutral-300 text-neutral-900 placeholder-neutral-400 focus:border-neutral-500 focus:outline-none focus:ring-neutral-500 sm:text-sm\"\n                     aria-invalid=\"true\"\n                     autoFocus={!isMobile}\n-                    pattern=\"Delete group\"\n+                    pattern=\"confirm delete group\"\n                   />\n                 </div>\n               </div>\n"}
{"instance_id": "dubinc__dub.main.3027", "repo": "dubinc/dub", "base_commit": "5d86b60093e63dc01ab8ba41a7d06bd46c92cfba", "head_commit": "64e5bb30efd3d8cec74e2f9fd53e1b3ff8b6a291", "title": "Update rewards tests", "merged_at": "2025-10-29T17:23:30Z", "html_url": "https://github.com/dubinc/dub/pull/3027", "test_files": ["apps/web/tests/rewards/lead-reward.test.ts"], "code_files": ["apps/web/tests/utils/resource.ts"], "total_changes": 16, "num_files": 2, "pull_number": 3027, "patch": "diff --git a/apps/web/tests/rewards/lead-reward.test.ts b/apps/web/tests/rewards/lead-reward.test.ts\nindex 990167233e9..95456359ec5 100644\n--- a/apps/web/tests/rewards/lead-reward.test.ts\n+++ b/apps/web/tests/rewards/lead-reward.test.ts\n@@ -13,7 +13,7 @@ describe.concurrent(\"Lead rewards\", async () => {\n   const h = new IntegrationHarness();\n   const { http } = await h.init();\n \n-  test(\"when {Partner} {Country} is {US}\", async () => {\n+  test(\"when customer country is US and partner country is US\", async () => {\n     // Track the click\n     const clickResponse = await http.post<{ clickId: string }>({\n       path: \"/track/click\",\n@@ -47,11 +47,11 @@ describe.concurrent(\"Lead rewards\", async () => {\n     await verifyCommission({\n       http,\n       customerExternalId: customer.externalId,\n-      expectedEarnings: E2E_LEAD_REWARD.modifiers[0].amountInCents,\n+      expectedEarnings: E2E_LEAD_REWARD.modifiers[1].amountInCents,\n     });\n   });\n \n-  test(\"when {Partner} {Country} is not {US}\", async () => {\n+  test(\"when customer country is US and partner country is not US\", async () => {\n     // Track the click\n     const clickResponse = await http.post<{ clickId: string }>({\n       path: \"/track/click\",\n@@ -85,7 +85,7 @@ describe.concurrent(\"Lead rewards\", async () => {\n     await verifyCommission({\n       http,\n       customerExternalId: customer.externalId,\n-      expectedEarnings: E2E_LEAD_REWARD.amountInCents,\n+      expectedEarnings: E2E_LEAD_REWARD.modifiers[0].amountInCents,\n     });\n   });\n });\ndiff --git a/apps/web/tests/utils/resource.ts b/apps/web/tests/utils/resource.ts\nindex 6aefc236eb2..2114f8b2454 100644\n--- a/apps/web/tests/utils/resource.ts\n+++ b/apps/web/tests/utils/resource.ts\n@@ -115,7 +115,7 @@ export const E2E_LEAD_REWARD = {\n       conditions: [\n         {\n           value: \"US\",\n-          entity: \"partner\",\n+          entity: \"customer\",\n           operator: \"equals_to\",\n           attribute: \"country\",\n         },\n@@ -129,13 +129,13 @@ export const E2E_LEAD_REWARD = {\n       conditions: [\n         {\n           value: \"US\",\n-          entity: \"customer\",\n+          entity: \"partner\",\n           operator: \"equals_to\",\n           attribute: \"country\",\n         },\n       ],\n-      maxDuration: null,\n-      amountInCents: 400,\n+      maxDuration: 0,\n+      amountInCents: 300,\n     },\n   ],\n };\n"}
{"instance_id": "dubinc__dub.main.3020", "repo": "dubinc/dub", "base_commit": "31d5d189c7760029408dbd5115b44fdcefd6bb0b", "head_commit": "774a5c2c7e5a48840a206f0ecf5488fbd6b22750", "title": "Reward modifiers tests", "merged_at": "2025-10-28T18:10:14Z", "html_url": "https://github.com/dubinc/dub/pull/3020", "test_files": ["apps/web/tests/rewards/lead-reward.test.ts", "apps/web/tests/rewards/sale-reward.test.ts", "apps/web/tests/tracks/track-lead.test.ts", "apps/web/tests/tracks/track-sale.test.ts"], "code_files": ["apps/web/tests/utils/resource.ts", "apps/web/tests/utils/verify-commission.ts"], "total_changes": 467, "num_files": 6, "pull_number": 3020, "patch": "diff --git a/apps/web/tests/rewards/lead-reward.test.ts b/apps/web/tests/rewards/lead-reward.test.ts\nnew file mode 100644\nindex 00000000000..990167233e9\n--- /dev/null\n+++ b/apps/web/tests/rewards/lead-reward.test.ts\n@@ -0,0 +1,91 @@\n+import { TrackLeadResponse } from \"@/lib/types\";\n+import { randomCustomer } from \"tests/utils/helpers\";\n+import {\n+  E2E_LEAD_REWARD,\n+  E2E_PARTNERS,\n+  E2E_TRACK_CLICK_HEADERS,\n+} from \"tests/utils/resource\";\n+import { verifyCommission } from \"tests/utils/verify-commission\";\n+import { describe, expect, test } from \"vitest\";\n+import { IntegrationHarness } from \"../utils/integration\";\n+\n+describe.concurrent(\"Lead rewards\", async () => {\n+  const h = new IntegrationHarness();\n+  const { http } = await h.init();\n+\n+  test(\"when {Partner} {Country} is {US}\", async () => {\n+    // Track the click\n+    const clickResponse = await http.post<{ clickId: string }>({\n+      path: \"/track/click\",\n+      headers: E2E_TRACK_CLICK_HEADERS,\n+      body: {\n+        ...E2E_PARTNERS[0].shortLink,\n+      },\n+    });\n+\n+    expect(clickResponse.status).toEqual(200);\n+\n+    const clickId = clickResponse.data.clickId;\n+    const customer = randomCustomer();\n+\n+    // Track the lead\n+    const trackLeadResponse = await http.post<TrackLeadResponse>({\n+      path: \"/track/lead\",\n+      body: {\n+        clickId,\n+        eventName: \"Signup\",\n+        customerExternalId: customer.externalId,\n+        customerName: customer.name,\n+        customerEmail: customer.email,\n+        customerAvatar: customer.avatar,\n+      },\n+    });\n+\n+    expect(trackLeadResponse.status).toEqual(200);\n+\n+    // Verify the commission\n+    await verifyCommission({\n+      http,\n+      customerExternalId: customer.externalId,\n+      expectedEarnings: E2E_LEAD_REWARD.modifiers[0].amountInCents,\n+    });\n+  });\n+\n+  test(\"when {Partner} {Country} is not {US}\", async () => {\n+    // Track the click\n+    const clickResponse = await http.post<{ clickId: string }>({\n+      path: \"/track/click\",\n+      headers: E2E_TRACK_CLICK_HEADERS,\n+      body: {\n+        ...E2E_PARTNERS[1].shortLink,\n+      },\n+    });\n+\n+    expect(clickResponse.status).toEqual(200);\n+\n+    const clickId = clickResponse.data.clickId;\n+    const customer = randomCustomer();\n+\n+    // Track the lead\n+    const trackLeadResponse = await http.post<TrackLeadResponse>({\n+      path: \"/track/lead\",\n+      body: {\n+        clickId,\n+        eventName: \"Signup\",\n+        customerExternalId: customer.externalId,\n+        customerName: customer.name,\n+        customerEmail: customer.email,\n+        customerAvatar: customer.avatar,\n+      },\n+    });\n+\n+    expect(trackLeadResponse.status).toEqual(200);\n+\n+    // Verify the commission\n+    await verifyCommission({\n+      http,\n+      customerExternalId: customer.externalId,\n+      expectedEarnings: E2E_LEAD_REWARD.amountInCents,\n+    });\n+  });\n+});\ndiff --git a/apps/web/tests/rewards/sale-reward.test.ts b/apps/web/tests/rewards/sale-reward.test.ts\nnew file mode 100644\nindex 00000000000..27bdf0ced11\n--- /dev/null\n+++ b/apps/web/tests/rewards/sale-reward.test.ts\n@@ -0,0 +1,65 @@\n+import { TrackSaleResponse } from \"@/lib/types\";\n+import { randomId } from \"tests/utils/helpers\";\n+import { E2E_CUSTOMERS, E2E_SALE_REWARD } from \"tests/utils/resource\";\n+import { verifyCommission } from \"tests/utils/verify-commission\";\n+import { describe, expect, test } from \"vitest\";\n+import { IntegrationHarness } from \"../utils/integration\";\n+\n+describe.concurrent(\"Sale rewards\", async () => {\n+  const h = new IntegrationHarness();\n+  const { http } = await h.init();\n+\n+  test(\"when {Customer} {Country} is {SG}\", async () => {\n+    const saleAmount = 10000; // $100 in cents\n+    const invoiceId = `INV_${randomId()}`;\n+\n+    // Track the sale\n+    const trackSaleResponse = await http.post<TrackSaleResponse>({\n+      path: \"/track/sale\",\n+      body: {\n+        customerExternalId: E2E_CUSTOMERS[0].externalId,\n+        eventName: \"Subscription\",\n+        amount: saleAmount,\n+        currency: \"usd\",\n+        invoiceId,\n+        paymentProcessor: \"stripe\",\n+      },\n+    });\n+\n+    expect(trackSaleResponse.status).toEqual(200);\n+\n+    // Verify the commission (10% of sale amount)\n+    await verifyCommission({\n+      http,\n+      invoiceId,\n+      expectedEarnings: saleAmount * 0.1,\n+    });\n+  });\n+\n+  test.skip(\"when {Customer} {Country} is {CA}\", async () => {\n+    const saleAmount = 10000; // $100 in cents\n+    const invoiceId = `INV_${randomId()}`;\n+\n+    // Track the sale\n+    const trackSaleResponse = await http.post<TrackSaleResponse>({\n+      path: \"/track/sale\",\n+      body: {\n+        customerExternalId: E2E_CUSTOMERS[1].externalId,\n+        eventName: \"Subscription\",\n+        amount: saleAmount,\n+        currency: \"usd\",\n+        invoiceId,\n+        paymentProcessor: \"stripe\",\n+      },\n+    });\n+\n+    expect(trackSaleResponse.status).toEqual(200);\n+\n+    // Verify the commission (base reward)\n+    await verifyCommission({\n+      http,\n+      invoiceId,\n+      expectedEarnings: E2E_SALE_REWARD.amountInCents,\n+    });\n+  });\n+});\ndiff --git a/apps/web/tests/tracks/track-lead.test.ts b/apps/web/tests/tracks/track-lead.test.ts\nindex 53921ac8512..a1e7a83c21d 100644\n--- a/apps/web/tests/tracks/track-lead.test.ts\n+++ b/apps/web/tests/tracks/track-lead.test.ts\n@@ -1,12 +1,6 @@\n-import {\n-  CommissionResponse,\n-  Customer,\n-  TrackLeadResponse,\n-  TrackSaleResponse,\n-} from \"@/lib/types\";\n+import { TrackLeadResponse, TrackSaleResponse } from \"@/lib/types\";\n import { randomCustomer } from \"tests/utils/helpers\";\n-import { HttpClient } from \"tests/utils/http\";\n-import { E2E_LEAD_REWARD, E2E_TRACK_CLICK_HEADERS } from \"tests/utils/resource\";\n+import { E2E_TRACK_CLICK_HEADERS } from \"tests/utils/resource\";\n import { describe, expect, test } from \"vitest\";\n import { IntegrationHarness } from \"../utils/integration\";\n \n@@ -30,39 +24,6 @@ const expectValidLeadResponse = ({\n   });\n };\n \n-const verifyCommission = async ({\n-  http,\n-  customerExternalId,\n-  expectedEarnings,\n-}: {\n-  http: HttpClient;\n-  customerExternalId: string;\n-  expectedEarnings: number;\n-}) => {\n-  // Find the customer first\n-  const { data: customers } = await http.get<Customer[]>({\n-    path: \"/customers\",\n-    query: {\n-      externalId: customerExternalId,\n-    },\n-  });\n-\n-  const customer = customers[0];\n-\n-  // Find the commission for the customer\n-  const { status, data: commissions } = await http.get<CommissionResponse[]>({\n-    path: \"/commissions\",\n-    query: {\n-      customerId: customer.id,\n-    },\n-  });\n-\n-  expect(status).toEqual(200);\n-  expect(commissions).toHaveLength(1);\n-  expect(commissions[0].customer?.id).toEqual(customer.id);\n-  expect(commissions[0].earnings).toEqual(expectedEarnings);\n-};\n-\n describe(\"POST /track/lead\", async () => {\n   const h = new IntegrationHarness();\n   const { http } = await h.init();\n@@ -254,44 +215,4 @@ describe(\"POST /track/lead\", async () => {\n       clickId: trackedClickId,\n     });\n   });\n-\n-  test(\"track a lead and verify the reward based on the partner.country (US)\", async () => {\n-    const clickResponse = await http.post<{ clickId: string }>({\n-      path: \"/track/click\",\n-      headers: E2E_TRACK_CLICK_HEADERS,\n-      body: {\n-        domain: \"getacme.link\",\n-        key: \"marvin\",\n-      },\n-    });\n-\n-    const trackedClickId = clickResponse.data.clickId;\n-    const customer = randomCustomer();\n-\n-    const response = await http.post<TrackLeadResponse>({\n-      path: \"/track/lead\",\n-      body: {\n-        clickId: trackedClickId,\n-        customerId: customer.externalId,\n-        eventName: \"Signup\",\n-        customerName: customer.name,\n-        customerEmail: customer.email,\n-        customerAvatar: customer.avatar,\n-      },\n-    });\n-\n-    expectValidLeadResponse({\n-      response,\n-      customer: customer,\n-      clickId: trackedClickId,\n-    });\n-\n-    await new Promise((resolve) => setTimeout(resolve, 2000));\n-\n-    await verifyCommission({\n-      http,\n-      customerExternalId: customer.externalId,\n-      expectedEarnings: E2E_LEAD_REWARD.modifiers[0].amountInCents,\n-    });\n-  });\n });\ndiff --git a/apps/web/tests/tracks/track-sale.test.ts b/apps/web/tests/tracks/track-sale.test.ts\nindex 562036082ff..2acbb45e1e5 100644\n--- a/apps/web/tests/tracks/track-sale.test.ts\n+++ b/apps/web/tests/tracks/track-sale.test.ts\n@@ -11,6 +11,7 @@ import {\n   E2E_SALE_REWARD,\n   E2E_TRACK_CLICK_HEADERS,\n } from \"tests/utils/resource\";\n+import { verifyCommission } from \"tests/utils/verify-commission\";\n import { describe, expect, test } from \"vitest\";\n import { IntegrationHarness } from \"../utils/integration\";\n \n@@ -38,25 +39,6 @@ const expectValidSaleResponse = (\n   });\n };\n \n-// Helper function to verify commission details\n-const verifyCommission = async (\n-  http: any,\n-  invoiceId: string,\n-  expectedAmount: number,\n-  expectedEarnings: number,\n-) => {\n-  const { status, data: commissions } = await http.get({\n-    path: \"/commissions\",\n-    query: { invoiceId },\n-  });\n-\n-  expect(status).toEqual(200);\n-  expect(commissions).toHaveLength(1);\n-  expect(commissions[0].invoiceId).toEqual(invoiceId);\n-  expect(commissions[0].amount).toEqual(expectedAmount);\n-  expect(commissions[0].earnings).toEqual(expectedEarnings);\n-};\n-\n describe(\"POST /track/sale\", async () => {\n   const h = new IntegrationHarness();\n   const { http } = await h.init();\n@@ -129,19 +111,19 @@ describe(\"POST /track/sale\", async () => {\n     // pause for 2 seconds for data to be fully processed\n     await new Promise((resolve) => setTimeout(resolve, 2000));\n \n-    // Verify commissions\n-    await verifyCommission(\n+    await verifyCommission({\n       http,\n-      regularInvoiceId,\n-      response1.data.sale?.amount!,\n-      E2E_SALE_REWARD.amountInCents,\n-    );\n-    await verifyCommission(\n+      invoiceId: regularInvoiceId,\n+      expectedAmount: response1.data.sale?.amount!,\n+      expectedEarnings: E2E_SALE_REWARD.amountInCents,\n+    });\n+\n+    await verifyCommission({\n       http,\n-      premiumInvoiceId,\n-      response2.data.sale?.amount!,\n-      E2E_SALE_REWARD.modifiers[0].amountInCents,\n-    );\n+      invoiceId: premiumInvoiceId,\n+      expectedAmount: response2.data.sale?.amount!,\n+      expectedEarnings: E2E_SALE_REWARD.modifiers[0].amountInCents!,\n+    });\n   });\n \n   test(\"track a sale with an externalId that does not exist (should return null customer and sale)\", async () => {\n@@ -311,18 +293,18 @@ describe(\"POST /track/sale\", async () => {\n     // Pause for 2 seconds for data to be fully processed\n     await new Promise((resolve) => setTimeout(resolve, 2000));\n \n-    await verifyCommission(\n+    await verifyCommission({\n       http,\n-      smallSaleInvoiceId,\n-      response1.data.sale?.amount!,\n-      E2E_SALE_REWARD.amountInCents,\n-    );\n+      invoiceId: smallSaleInvoiceId,\n+      expectedAmount: response1.data.sale?.amount!,\n+      expectedEarnings: E2E_SALE_REWARD.amountInCents,\n+    });\n \n-    await verifyCommission(\n+    await verifyCommission({\n       http,\n-      largeSaleInvoiceId,\n-      response2.data.sale?.amount!,\n-      E2E_SALE_REWARD.modifiers[1].amountInCents,\n-    );\n+      invoiceId: largeSaleInvoiceId,\n+      expectedAmount: response2.data.sale?.amount!,\n+      expectedEarnings: E2E_SALE_REWARD.modifiers[1].amountInCents!,\n+    });\n   });\n });\ndiff --git a/apps/web/tests/utils/resource.ts b/apps/web/tests/utils/resource.ts\nindex 67221a21284..6aefc236eb2 100644\n--- a/apps/web/tests/utils/resource.ts\n+++ b/apps/web/tests/utils/resource.ts\n@@ -45,42 +45,72 @@ export const E2E_SALE_REWARD = {\n   amountInCents: 1000,\n   modifiers: [\n     {\n-      operator: \"AND\",\n       type: \"flat\",\n-      amountInCents: 3000,\n+      operator: \"AND\",\n       conditions: [\n         {\n+          value: \"premiumProductId\",\n           entity: \"sale\",\n-          attribute: \"productId\",\n           operator: \"equals_to\",\n-          value: \"premiumProductId\",\n+          attribute: \"productId\",\n         },\n       ],\n+      maxDuration: null,\n+      amountInCents: 3000,\n     },\n     {\n-      operator: \"AND\",\n       type: \"flat\",\n-      amountInCents: 5000,\n+      operator: \"AND\",\n       conditions: [\n         {\n+          value: 15000,\n           entity: \"sale\",\n-          attribute: \"amount\",\n           operator: \"greater_than\",\n-          value: 15000,\n+          attribute: \"amount\",\n+        },\n+      ],\n+      maxDuration: null,\n+      amountInCents: 5000,\n+    },\n+    {\n+      type: \"percentage\",\n+      operator: \"AND\",\n+      conditions: [\n+        {\n+          value: \"US\",\n+          entity: \"customer\",\n+          operator: \"equals_to\",\n+          attribute: \"country\",\n+        },\n+      ],\n+      maxDuration: null,\n+      amountInPercentage: 10,\n+    },\n+    {\n+      type: \"flat\",\n+      operator: \"AND\",\n+      conditions: [\n+        {\n+          value: \"CA\",\n+          entity: \"customer\",\n+          operator: \"equals_to\",\n+          attribute: \"country\",\n         },\n       ],\n+      maxDuration: null,\n+      amountInCents: 50,\n     },\n   ],\n };\n+\n export const E2E_LEAD_REWARD = {\n   id: \"rw_1K82ESAT4YPY0STR20GKXZ7DR\",\n   event: \"lead\",\n   type: \"flat\",\n-  amountInCents: 1000,\n+  amountInCents: 100,\n   modifiers: [\n     {\n       type: \"flat\",\n-      amountInCents: 200,\n       operator: \"AND\",\n       conditions: [\n         {\n@@ -91,6 +121,21 @@ export const E2E_LEAD_REWARD = {\n         },\n       ],\n       maxDuration: null,\n+      amountInCents: 200,\n+    },\n+    {\n+      type: \"flat\",\n+      operator: \"AND\",\n+      conditions: [\n+        {\n+          value: \"US\",\n+          entity: \"customer\",\n+          operator: \"equals_to\",\n+          attribute: \"country\",\n+        },\n+      ],\n+      maxDuration: null,\n+      amountInCents: 400,\n     },\n   ],\n };\n@@ -128,3 +173,35 @@ export const E2E_PARTNER_GROUP = {\n   id: \"grp_1K2E25381GVMG7HHM057TB92F\",\n   url: \"https://acme.dub.sh/\",\n };\n+\n+export const E2E_PARTNERS = [\n+  {\n+    id: \"pn_NNG3YjwhLhA7nCZSaXeLIsWu\",\n+    country: \"US\",\n+    shortLink: {\n+      domain: \"getacme.link\",\n+      key: \"marvin\",\n+    },\n+  },\n+  {\n+    id: \"pn_1K8ND11BZ4XPEX39QX3YMBGY0\",\n+    country: \"SG\",\n+    shortLink: {\n+      domain: \"getacme.link\",\n+      key: \"kiran-e2e-1\",\n+    },\n+  },\n+] as const;\n+\n+export const E2E_CUSTOMERS = [\n+  {\n+    id: \"cus_1K82FYFF7RANMCGRHRGMWDNEC\",\n+    externalId: \"cus_LnZbkb8boLsOn1YGLPxZGZMU\",\n+    country: \"SG\",\n+  },\n+  {\n+    id: \"cus_1K86CG1DZFW8EMSSWXX4AVZFA\",\n+    externalId: \"cus_vq3UgXINHS99MIon8vNvAO1n\",\n+    country: \"CA\",\n+  },\n+] as const;\ndiff --git a/apps/web/tests/utils/verify-commission.ts b/apps/web/tests/utils/verify-commission.ts\nnew file mode 100644\nindex 00000000000..94e9b5304ff\n--- /dev/null\n+++ b/apps/web/tests/utils/verify-commission.ts\n@@ -0,0 +1,69 @@\n+import { CommissionResponse, Customer } from \"@/lib/types\";\n+import { expect } from \"vitest\";\n+import { HttpClient } from \"./http\";\n+\n+interface VerifyCommissionProps {\n+  http: HttpClient;\n+  customerExternalId?: string;\n+  invoiceId?: string;\n+  expectedAmount?: number;\n+  expectedEarnings: number;\n+}\n+\n+export const verifyCommission = async ({\n+  http,\n+  customerExternalId,\n+  invoiceId,\n+  expectedAmount,\n+  expectedEarnings,\n+}: VerifyCommissionProps) => {\n+  let customerId: string | undefined;\n+\n+  // Optional: resolve customer ID if customerExternalId is given\n+  if (customerExternalId) {\n+    const { data: customers } = await http.get<Customer[]>({\n+      path: \"/customers\",\n+      query: { externalId: customerExternalId },\n+    });\n+\n+    expect(customers.length).toBeGreaterThan(0);\n+    customerId = customers[0].id;\n+\n+    // Small delay if necessary for async commission processing\n+    await new Promise((resolve) => setTimeout(resolve, 2000));\n+  }\n+\n+  const query: Record<string, string> = {};\n+\n+  if (invoiceId) {\n+    query.invoiceId = invoiceId;\n+  }\n+\n+  if (customerId) {\n+    query.customerId = customerId;\n+  }\n+\n+  const { status, data: commissions } = await http.get<CommissionResponse[]>({\n+    path: \"/commissions\",\n+    query,\n+  });\n+\n+  expect(status).toEqual(200);\n+  expect(commissions).toHaveLength(1);\n+\n+  const commission = commissions[0];\n+\n+  if (invoiceId) {\n+    expect(commission.invoiceId).toEqual(invoiceId);\n+  }\n+\n+  if (customerId) {\n+    expect(commission.customer?.id).toEqual(customerId);\n+  }\n+\n+  if (expectedAmount !== undefined) {\n+    expect(commission.amount).toEqual(expectedAmount);\n+  }\n+\n+  expect(commission.earnings).toEqual(expectedEarnings);\n+};\n"}
{"instance_id": "dubinc__dub.main.2975", "repo": "dubinc/dub", "base_commit": "46a8b5aa9328c75c02054b66ba5879c4e2e82345", "head_commit": "9414a9320086f54b3a81a226258cabe301f8a227", "title": "Add integration tests for `/campaigns/**` endpoints", "merged_at": "2025-10-17T17:13:02Z", "html_url": "https://github.com/dubinc/dub/pull/2975", "test_files": ["apps/web/tests/campaigns/index.test.ts"], "code_files": ["apps/web/tests/utils/integration.ts"], "total_changes": 222, "num_files": 2, "pull_number": 2975, "patch": "diff --git a/apps/web/tests/campaigns/index.test.ts b/apps/web/tests/campaigns/index.test.ts\nnew file mode 100644\nindex 00000000000..90cf7a77baf\n--- /dev/null\n+++ b/apps/web/tests/campaigns/index.test.ts\n@@ -0,0 +1,213 @@\n+import { Campaign, CampaignList } from \"@/lib/types\";\n+import { updateCampaignSchema } from \"@/lib/zod/schemas/campaigns\";\n+import { E2E_PARTNER_GROUP } from \"tests/utils/resource\";\n+import { describe, expect, onTestFinished, test } from \"vitest\";\n+import { z } from \"zod\";\n+import { IntegrationHarness } from \"../utils/integration\";\n+\n+const campaign: z.infer<typeof updateCampaignSchema> = {\n+  name: \"Updated Test Campaign\",\n+  subject: \"Updated Test Subject\",\n+  triggerCondition: {\n+    attribute: \"totalConversions\",\n+    operator: \"gte\",\n+    value: 50,\n+  },\n+  bodyJson: {\n+    type: \"doc\",\n+    content: [\n+      {\n+        type: \"paragraph\",\n+        content: [\n+          {\n+            type: \"text\",\n+            text: \"Test campaign body\",\n+          },\n+        ],\n+      },\n+    ],\n+  },\n+};\n+\n+const expectedCampaign: Partial<Campaign> = {\n+  ...campaign,\n+  type: \"transactional\",\n+  groups: [{ id: E2E_PARTNER_GROUP.id }],\n+  createdAt: expect.any(String),\n+  updatedAt: expect.any(String),\n+};\n+\n+describe.sequential(\"/campaigns/**\", async () => {\n+  const h = new IntegrationHarness();\n+  const { http } = await h.init();\n+\n+  let campaignId = \"\";\n+\n+  test(\"POST /campaigns - create draft campaign\", async () => {\n+    const { status, data } = await http.post<{ id: string }>({\n+      path: \"/campaigns\",\n+      body: {\n+        type: \"transactional\",\n+      },\n+    });\n+\n+    expect(status).toEqual(200);\n+    expect(data).toMatchObject({\n+      id: expect.any(String),\n+    });\n+\n+    campaignId = data.id;\n+  });\n+\n+  test(\"PATCH /campaigns/[campaignId] - update campaign content\", async () => {\n+    const { status, data: updatedCampaign } = await http.patch<Campaign>({\n+      path: `/campaigns/${campaignId}`,\n+      body: {\n+        ...campaign,\n+        groupIds: [E2E_PARTNER_GROUP.id],\n+      },\n+    });\n+\n+    expect(status).toEqual(200);\n+    expect(updatedCampaign).toStrictEqual({\n+      ...expectedCampaign,\n+      id: campaignId,\n+      status: \"draft\",\n+    });\n+  });\n+\n+  test(\"GET /campaigns/[campaignId] - make sure the draft campaign is created\", async () => {\n+    const { status, data: fetchedCampaign } = await http.get<Campaign>({\n+      path: `/campaigns/${campaignId}`,\n+    });\n+\n+    expect(status).toEqual(200);\n+    expect(fetchedCampaign).toStrictEqual({\n+      ...expectedCampaign,\n+      id: campaignId,\n+      status: \"draft\",\n+    });\n+  });\n+\n+  test(\"PATCH /campaigns/[campaignId] - publish campaign\", async () => {\n+    const { status, data: publishedCampaign } = await http.patch<Campaign>({\n+      path: `/campaigns/${campaignId}`,\n+      body: {\n+        status: \"active\",\n+      },\n+    });\n+\n+    expect(status).toEqual(200);\n+    expect(publishedCampaign).toStrictEqual({\n+      ...expectedCampaign,\n+      id: campaignId,\n+      status: \"active\",\n+    });\n+  });\n+\n+  test(\"PATCH /campaigns/[campaignId] - pause campaign\", async () => {\n+    const { status, data: pausedCampaign } = await http.patch<Campaign>({\n+      path: `/campaigns/${campaignId}`,\n+      body: {\n+        status: \"paused\",\n+      },\n+    });\n+\n+    expect(status).toEqual(200);\n+    expect(pausedCampaign).toStrictEqual({\n+      ...expectedCampaign,\n+      id: campaignId,\n+      status: \"paused\",\n+    });\n+  });\n+\n+  test(\"PATCH /campaigns/[campaignId] - resume campaign\", async () => {\n+    const { status, data: resumedCampaign } = await http.patch<Campaign>({\n+      path: `/campaigns/${campaignId}`,\n+      body: {\n+        status: \"active\",\n+      },\n+    });\n+\n+    expect(status).toEqual(200);\n+    expect(resumedCampaign).toStrictEqual({\n+      ...expectedCampaign,\n+      id: campaignId,\n+      status: \"active\",\n+    });\n+  });\n+\n+  test(\"POST /campaigns/[campaignId]/duplicate - duplicate campaign\", async () => {\n+    const { status, data } = await http.post<{ id: string }>({\n+      path: `/campaigns/${campaignId}/duplicate`,\n+    });\n+\n+    expect(status).toEqual(200);\n+    expect(data.id).toBeDefined();\n+\n+    onTestFinished(async () => {\n+      await h.deleteCampaign(data.id);\n+    });\n+\n+    const { data: duplicatedCampaign } = await http.get<Campaign>({\n+      path: `/campaigns/${data.id}`,\n+    });\n+\n+    expect(duplicatedCampaign).toStrictEqual({\n+      ...expectedCampaign,\n+      id: data.id,\n+      name: `${expectedCampaign.name} (copy)`,\n+      status: \"draft\",\n+    });\n+  });\n+\n+  test(\"GET /campaigns - list campaigns\", async () => {\n+    const { status, data: campaigns } = await http.get<CampaignList[]>({\n+      path: \"/campaigns\",\n+    });\n+\n+    expect(status).toEqual(200);\n+    expect(Array.isArray(campaigns)).toBe(true);\n+    expect(campaigns.length).toBeGreaterThan(0);\n+\n+    const campaign = campaigns.find((c) => c.id === campaignId);\n+\n+    expect(campaign).toStrictEqual({\n+      id: campaignId,\n+      name: expectedCampaign.name,\n+      type: expectedCampaign.type,\n+      status: \"active\",\n+      groups: [{ id: E2E_PARTNER_GROUP.id }],\n+      delivered: 0,\n+      sent: 0,\n+      bounced: 0,\n+      opened: 0,\n+      createdAt: expect.any(String),\n+      updatedAt: expect.any(String),\n+    });\n+  });\n+\n+  test(\"GET /campaigns/[campaignId] - get single campaign\", async () => {\n+    const { status, data: fetchedCampaign } = await http.get<Campaign>({\n+      path: `/campaigns/${campaignId}`,\n+    });\n+\n+    expect(status).toEqual(200);\n+    expect(fetchedCampaign).toStrictEqual({\n+      ...expectedCampaign,\n+      id: campaignId,\n+      status: \"active\",\n+    });\n+  });\n+\n+  test(\"DELETE /campaigns/[campaignId] - delete campaign\", async () => {\n+    const { status, data } = await http.delete<{ id: string }>({\n+      path: `/campaigns/${campaignId}`,\n+    });\n+\n+    expect(status).toEqual(200);\n+    expect(data).toStrictEqual({\n+      id: campaignId,\n+    });\n+  });\n+});\ndiff --git a/apps/web/tests/utils/integration.ts b/apps/web/tests/utils/integration.ts\nindex 934e2a7065d..d2a02cb8ff6 100644\n--- a/apps/web/tests/utils/integration.ts\n+++ b/apps/web/tests/utils/integration.ts\n@@ -106,4 +106,13 @@ export class IntegrationHarness {\n       path: `/bounties/${id}`,\n     });\n   }\n+\n+  // Delete campaign\n+  public async deleteCampaign(id: string) {\n+    if (!id) return;\n+\n+    await this.http.delete({\n+      path: `/campaigns/${id}`,\n+    });\n+  }\n }\n"}
