#!/usr/bin/env python3
"""
Create task instances from sanity-insts.jsonl by fetching PR patches.
"""

import json
import sys
from pathlib import Path
import requests

def create_instances():
    """Convert PR data to instances with patches."""
    input_file = Path("logs/tasks/sanity-insts.jsonl")
    output_file = Path("logs/tasks/sanity-enriched.jsonl")

    if not input_file.exists():
        print(f"Error: {input_file} not found")
        return 1

    instances = []

    with open(input_file) as f:
        for line in f:
            pr_data = json.loads(line)
            pr_number = pr_data["pr_number"]

            # Fetch PR patch
            patch_url = f"https://patch-diff.githubusercontent.com/raw/sanity-io/sanity/pull/{pr_number}.patch"
            print(f"Fetching patch for PR #{pr_number}...")

            response = requests.get(patch_url)
            if response.status_code != 200:
                print(f"  Warning: Could not fetch patch (status {response.status_code})")
                continue

            patch = response.text

            # Create instance
            instance = {
                "instance_id": f"sanity-io__sanity.615e6c01.{pr_number}",
                "repo": "sanity-io/sanity",
                "base_commit": "615e6c01",
                "head_commit": pr_data["head_sha"],
                "pull_number": pr_number,
                "title": pr_data["title"],
                "merged_at": pr_data["merged_at"],
                "html_url": pr_data["pr_url"],
                "patch": patch,
                "test_patch": "",  # Will be generated by PR mirroring
                "problem_statement": "",  # Will be generated by PR mirroring
                "hints_text": "",
                "created_at": pr_data["merged_at"],
            }

            instances.append(instance)
            print(f"  ✓ Created instance for PR #{pr_number}")

    if not instances:
        print("\n❌ No instances created")
        return 1

    # Save enriched instances
    output_file.parent.mkdir(parents=True, exist_ok=True)
    with open(output_file, "w") as f:
        for instance in instances:
            f.write(json.dumps(instance) + "\n")

    print(f"\n✓ Created {len(instances)} enriched instances in {output_file}")
    return 0

if __name__ == "__main__":
    sys.exit(create_instances())
