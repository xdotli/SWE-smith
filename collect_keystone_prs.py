#!/usr/bin/env python3
"""
Collect PRs from keystonejs/keystone that:
1. Modify actual test files (.test.ts, .test.tsx, .spec.ts - NOT .snap)
2. Have small, focused diffs (< 10KB)
3. Have both code and test file changes
"""

import json
import os
import subprocess
from pathlib import Path
from typing import List, Dict
import requests
from dotenv import load_dotenv

# Load environment variables
load_dotenv()

GITHUB_TOKEN = os.getenv("GITHUB_TOKEN")
if not GITHUB_TOKEN:
    print("Warning: GITHUB_TOKEN not set. API rate limits will be lower.")

HEADERS = {
    "Authorization": f"token {GITHUB_TOKEN}" if GITHUB_TOKEN else "",
    "Accept": "application/vnd.github.v3+json"
}

def get_merged_prs(owner: str, repo: str, limit: int = 100) -> List[Dict]:
    """Fetch merged PRs from GitHub."""
    url = f"https://api.github.com/repos/{owner}/{repo}/pulls"
    params = {
        "state": "closed",
        "sort": "updated",
        "direction": "desc",
        "per_page": limit
    }

    response = requests.get(url, headers=HEADERS, params=params)
    response.raise_for_status()

    prs = response.json()
    # Filter only merged PRs
    return [pr for pr in prs if pr.get("merged_at")]

def get_pr_files(owner: str, repo: str, pr_number: int) -> List[Dict]:
    """Get files changed in a PR."""
    url = f"https://api.github.com/repos/{owner}/{repo}/pulls/{pr_number}/files"
    response = requests.get(url, headers=HEADERS)
    response.raise_for_status()
    return response.json()

def is_valid_test_file(filename: str) -> bool:
    """Check if file is an actual test file (not snapshot)."""
    if ".snap" in filename:
        return False
    return any(filename.endswith(ext) for ext in [".test.ts", ".test.tsx", ".spec.ts", ".spec.tsx"])

def is_good_pr_candidate(pr_data: Dict, files: List[Dict]) -> bool:
    """Check if PR is a good candidate for mirroring."""
    # Must have actual test files (not snapshots)
    test_files = [f for f in files if is_valid_test_file(f["filename"])]
    code_files = [f for f in files if f["filename"].endswith((".ts", ".tsx")) and not is_valid_test_file(f["filename"])]

    if not test_files:
        return False

    if not code_files:
        return False

    # Code changes should be focused (not too many files)
    if len(files) > 10:
        return False

    # Check total additions/deletions is reasonable
    total_changes = pr_data.get("additions", 0) + pr_data.get("deletions", 0)
    if total_changes > 1000:  # Rough proxy for diff size
        return False

    return True

def main():
    owner = "keystonejs"
    repo = "keystone"

    print(f"Fetching PRs from {owner}/{repo}...")
    prs = get_merged_prs(owner, repo, limit=100)
    print(f"Found {len(prs)} merged PRs")

    instances = []
    good_prs = 0

    for pr in prs:
        pr_number = pr["number"]
        print(f"Checking PR #{pr_number}...", end=" ")

        try:
            files = get_pr_files(owner, repo, pr_number)

            if is_good_pr_candidate(pr, files):
                good_prs += 1
                print(f"✓ (good candidate, {len(files)} files)")

                # Create instance in SWE-smith format
                instance = {
                    "instance_id": f"{owner}__{repo}.pr_mirror.{pr_number}",
                    "repo": f"{owner}/{repo}",
                    "base_commit": pr["base"]["sha"],
                    "pull_number": pr_number,
                    "problem_statement": pr["title"],
                    "created_at": pr["created_at"],
                    "merged_at": pr["merged_at"],
                    "test_patch": "",  # Will be generated by PR mirroring
                    "hints_text": pr["body"] or ""
                }
                instances.append(instance)

                # Limit to 20 good candidates
                if good_prs >= 20:
                    break
            else:
                print("✗ (skipped)")

        except Exception as e:
            print(f"Error: {e}")

    # Save instances
    output_dir = Path("logs/tasks")
    output_dir.mkdir(parents=True, exist_ok=True)
    output_file = output_dir / "keystone-insts.jsonl"

    with open(output_file, "w") as f:
        for inst in instances:
            f.write(json.dumps(inst) + "\n")

    print(f"\n✓ Saved {len(instances)} instances to {output_file}")
    print(f"Next step: python -m swesmith.bug_gen.mirror.generate_ts {output_file} --model anthropic/claude-opus-4-5-20251101")

if __name__ == "__main__":
    main()
